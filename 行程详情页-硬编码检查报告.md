# 行程详情页硬编码检查报告

## 文件位置
`src/pages/trips/[id].tsx`

## 硬编码部分清单

### 1. 健康度指标（Health Metrics） ⚠️ **高优先级**

**位置**: 第559-565行

**当前代码**:
```typescript
const healthMetrics = {
  executable: 85, // 可执行度
  buffer: 70, // 缓冲
  risk: 25, // 风险（越低越好）
  cost: 80, // 成本控制
};
```

**问题**: 所有健康度指标都是硬编码的固定值

**需要的接口**:
- **接口路径**: `GET /trips/:id/health-metrics` 或从 `GET /trips/:id/metrics` 中获取
- **响应格式**:
```typescript
{
  executable: number,  // 可执行度 (0-100)
  buffer: number,      // 缓冲 (0-100)
  risk: number,        // 风险 (0-100, 越低越好)
  cost: number,       // 成本控制 (0-100)
}
```

**状态**: ❌ 未对接，需要后端提供接口

---

### 2. 路线骨架图 - 每日统计数据 ⚠️ **高优先级**

**位置**: 第801-808行

**当前代码**:
```typescript
<Badge variant="outline">步行: 8.5 km</Badge>
<Badge variant="outline">车程: 30 min</Badge>
<Badge variant="outline">缓冲: 45 min</Badge>
<Badge variant="outline" className="bg-green-50 text-green-700">
  风险: 低
</Badge>
```

**问题**: 每日的步行距离、车程、缓冲时间、风险等级都是硬编码

**需要的接口**:
- **接口路径**: `GET /trips/:id/days/:dayId/metrics` (已存在，但未在详情页使用)
- **或者**: 在 `GET /trips/:id` 的响应中，每个 `TripDay` 对象应包含这些统计数据

**响应格式** (DayMetricsResponse):
```typescript
{
  dayId: string,
  date: string,
  metrics: {
    walkingDistance: number,    // 步行距离 (km)
    drivingTime: number,         // 车程 (分钟)
    bufferTime: number,           // 缓冲时间 (分钟)
    riskLevel: 'LOW' | 'MEDIUM' | 'HIGH',  // 风险等级
    // 其他指标...
  }
}
```

**状态**: ⚠️ 接口已存在 (`getDayMetrics`)，但页面未调用

---

### 3. Top Risks（风险列表） ⚠️ **高优先级**

**位置**: 第829-840行

**当前代码**:
```typescript
<div className="p-3 bg-red-50 border border-red-200 rounded text-sm">
  <div className="font-medium text-red-800">时间窗冲突</div>
  <div className="text-xs text-red-600 mt-1">
    Abu: 缺少缓冲可能导致延误连锁反应
  </div>
</div>
<div className="p-3 bg-yellow-50 border border-yellow-200 rounded text-sm">
  <div className="font-medium text-yellow-800">道路封闭风险</div>
  <div className="text-xs text-yellow-600 mt-1">
    Day 2 计划路线经过封闭路段
  </div>
</div>
```

**问题**: 风险列表完全硬编码

**需要的接口**:
- **接口路径**: `GET /trips/:id/persona-alerts` (已存在，但未在详情页使用)
- **或者**: `GET /trips/:id/risk-alerts` (根据文档，此接口待实现)

**响应格式** (PersonaAlert[]):
```typescript
Array<{
  id: string,
  persona: 'ABU' | 'DR_DRE' | 'NEPTUNE',
  severity: 'HIGH' | 'MEDIUM' | 'LOW',
  title: string,
  description: string,
  affectedDays?: string[],
  metadata?: any,
}>
```

**状态**: ⚠️ 接口已存在 (`getPersonaAlerts`)，但页面未调用

---

### 4. 关键证据（Evidence Quick Peek） ⚠️ **高优先级**

**位置**: 第860-871行

**当前代码**:
```typescript
<div className="text-sm">
  <div className="font-medium">营业时间</div>
  <div className="text-xs text-muted-foreground">09:00-18:00</div>
</div>
<div className="text-sm">
  <div className="font-medium">封路信息</div>
  <div className="text-xs text-muted-foreground">Route X 在 2024-01-20 封闭</div>
</div>
<div className="text-sm">
  <div className="font-medium">天气窗口</div>
  <div className="text-xs text-muted-foreground">Day 2 预计有雨</div>
</div>
```

**问题**: 关键证据完全硬编码

**需要的接口**:
- **接口路径**: `GET /trips/:id/evidence` (已存在，但未在详情页使用)
- **查询参数**: `limit=3` (只获取前3条关键证据)

**响应格式** (EvidenceListResponse):
```typescript
{
  items: Array<{
    id: string,
    type: 'OPENING_HOURS' | 'ROAD_CLOSURE' | 'WEATHER' | 'PERMIT' | ...,
    title: string,
    description: string,
    date?: string,
    dayId?: string,
    // ...
  }>,
  total: number,
}
```

**状态**: ⚠️ 接口已存在 (`getEvidence`)，但页面未调用

---

### 5. 收藏和点赞状态 ⚠️ **中优先级**

**位置**: 第287-289行（TODO注释），第232-234行（状态定义）

**当前代码**:
```typescript
// TODO: 如果后端返回收藏和点赞状态，在这里设置
// 目前需要单独检查收藏状态
await checkCollectionStatus();
```

**问题**: 
- 收藏状态通过 `getCollected()` 获取所有收藏列表后查找，效率低
- 点赞状态和点赞数未获取（`isLiked` 和 `likeCount` 初始化为 false 和 0）

**需要的接口**:
- **方案1**: 在 `GET /trips/:id` 响应中包含收藏和点赞状态
- **方案2**: 提供专门的接口 `GET /trips/:id/social-status`

**响应格式**:
```typescript
{
  isCollected: boolean,
  isLiked: boolean,
  likeCount: number,
}
```

**状态**: ❌ 未对接，需要后端提供接口或在详情接口中包含

---

### 6. 保存为模板功能 ⚠️ **低优先级**

**位置**: 第1032行（TODO注释）

**当前代码**:
```typescript
// TODO: 保存为模板
alert('保存为模板功能开发中');
```

**问题**: 功能未实现

**需要的接口**:
- **接口路径**: `POST /trips/:id/save-as-template` 或 `POST /route-templates`
- **请求体**:
```typescript
{
  name: string,
  description?: string,
  isPublic?: boolean,
}
```

**状态**: ❌ 未对接，需要后端提供接口

---

### 7. 行程标签（节奏、交通方式） ⚠️ **中优先级**

**位置**: 第615-616行

**当前代码**:
```typescript
<Badge variant="secondary">标准节奏</Badge>
<Badge variant="secondary">自驾</Badge>
```

**问题**: 节奏和交通方式标签硬编码

**需要的接口**:
- 这些信息应该从 `GET /trips/:id` 的响应中获取
- 或者在 `TripDetail` 类型中添加 `rhythm` 和 `transportMode` 字段

**状态**: ⚠️ 需要确认后端是否在详情接口中返回这些字段

---

## 已存在但未使用的接口

以下接口在 `src/api/trips.ts` 中已定义，但在行程详情页中**未使用**：

1. ✅ `getEvidence(tripId, params)` - 获取证据列表
2. ✅ `getPersonaAlerts(id)` - 获取人格警报（包含风险信息）
3. ✅ `getDayMetrics(id, dayId)` - 获取每日指标
4. ✅ `getMetrics(id, params)` - 获取行程指标
5. ✅ `getConflicts(id, params)` - 获取冲突列表

---

## 总结

### 需要后端提供的接口（按优先级）

#### P0 - 高优先级（必须实现）

1. **健康度指标接口**
   - `GET /trips/:id/health-metrics`
   - 或从 `GET /trips/:id/metrics` 中返回健康度相关字段

2. **每日统计数据**
   - 在 `GET /trips/:id` 响应中，每个 `TripDay` 包含：
     - `walkingDistance` (km)
     - `drivingTime` (分钟)
     - `bufferTime` (分钟)
     - `riskLevel` ('LOW' | 'MEDIUM' | 'HIGH')

3. **风险列表接口**
   - `GET /trips/:id/risk-alerts` (如果 `getPersonaAlerts` 不满足需求)
   - 或确保 `getPersonaAlerts` 返回的风险信息足够详细

4. **关键证据接口**
   - 确保 `GET /trips/:id/evidence` 支持 `limit` 参数，用于获取前N条关键证据

#### P1 - 中优先级（建议实现）

5. **收藏和点赞状态**
   - 在 `GET /trips/:id` 响应中包含：
     - `isCollected: boolean`
     - `isLiked: boolean`
     - `likeCount: number`

6. **行程标签**
   - 在 `GET /trips/:id` 响应中包含：
     - `rhythm: string` (节奏类型)
     - `transportMode: string` (交通方式)

#### P2 - 低优先级（可选）

7. **保存为模板接口**
   - `POST /trips/:id/save-as-template`
   - 或 `POST /route-templates` (从行程创建模板)

---

## 前端需要修改的地方

1. **第559-565行**: 调用健康度指标接口，替换硬编码
2. **第801-808行**: 从 `TripDay` 数据或调用 `getDayMetrics` 获取每日统计
3. **第829-840行**: 调用 `getPersonaAlerts` 或 `getRiskAlerts` 获取风险列表
4. **第860-871行**: 调用 `getEvidence` 获取关键证据（limit=3）
5. **第287-289行**: 从详情接口获取收藏和点赞状态，或调用专门的接口
6. **第615-616行**: 从详情接口获取节奏和交通方式标签
7. **第1032行**: 实现保存为模板功能

---

## 建议

1. **优先使用已有接口**: 先检查 `getPersonaAlerts`、`getEvidence`、`getDayMetrics` 等接口是否满足需求
2. **扩展详情接口**: 如果可能，在 `GET /trips/:id` 中直接返回更多字段，减少额外的API调用
3. **统一数据格式**: 确保所有接口返回的数据格式一致，便于前端处理

