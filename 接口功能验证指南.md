# 接口功能验证指南

## 一、验证前准备

### 1.1 环境检查

1. **确保后端服务运行**
   ```bash
   # 检查后端服务是否正常运行
   # 确认 API 基础 URL 配置正确
   ```

2. **确保前端服务运行**
   ```bash
   npm run dev
   # 或
   yarn dev
   ```

3. **准备测试数据**
   - 至少有一个已创建的行程
   - 行程最好有多个日期和行程项
   - 确保行程有相关的证据、风险、指标数据

---

## 二、验证方法

### 方法1: 浏览器开发者工具（推荐）

#### 2.1 打开开发者工具

1. 打开浏览器（Chrome/Edge/Firefox）
2. 按 `F12` 或 `Ctrl+Shift+I`（Windows/Linux）或 `Cmd+Option+I`（Mac）
3. 切换到 **Network（网络）** 标签页

#### 2.2 访问行程详情页

1. 导航到行程列表页：`/dashboard/trips`
2. 点击任意一个行程，进入详情页：`/dashboard/trips/:id`
3. 观察 Network 标签页中的 API 请求

#### 2.3 检查接口调用

在 Network 标签页中，你应该能看到以下请求：

| 接口 | 请求路径 | 方法 | 预期状态码 |
|------|---------|------|-----------|
| 获取证据 | `/trips/:id/evidence?limit=3&offset=0` | GET | 200 |
| 获取人格警报 | `/trips/:id/persona-alerts` | GET | 200 |
| 获取行程指标 | `/trips/:id/metrics` | GET | 200 |
| 获取冲突列表 | `/trips/:id/conflicts` | GET | 200 |
| 获取行程详情 | `/trips/:id` | GET | 200 |

#### 2.4 检查响应数据

点击每个请求，查看 **Response（响应）** 标签页：

**getEvidence 响应示例**:
```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": "evidence-1",
        "type": "opening_hours",
        "title": "营业时间",
        "description": "09:00-18:00",
        "day": 1,
        "severity": "low"
      }
    ],
    "total": 5,
    "limit": 3,
    "offset": 0
  }
}
```

**getPersonaAlerts 响应示例**:
```json
{
  "success": true,
  "data": [
    {
      "id": "alert-1",
      "persona": "ABU",
      "name": "Abu",
      "title": "时间窗冲突",
      "message": "缺少缓冲可能导致延误连锁反应",
      "severity": "warning"
    }
  ]
}
```

**getMetrics 响应示例**:
```json
{
  "success": true,
  "data": {
    "tripId": "trip-id",
    "days": [
      {
        "date": "2024-01-10",
        "metrics": {
          "walk": 8.5,
          "drive": 30,
          "buffer": 45,
          "fatigue": 60,
          "ascent": 200,
          "cost": 500
        },
        "conflicts": []
      }
    ],
    "summary": {
      "totalWalk": 85,
      "totalDrive": 300,
      "totalBuffer": 450,
      "totalFatigue": 600,
      "totalCost": 5000
    }
  }
}
```

---

### 方法2: 控制台日志检查

#### 2.1 查看控制台输出

1. 在开发者工具中切换到 **Console（控制台）** 标签页
2. 刷新页面或重新加载行程详情页
3. 查看是否有错误信息

**正常情况**:
- 不应该有红色错误信息
- 可能有一些警告（可以忽略）

**异常情况**:
- 如果看到 `Failed to load evidence:` 等错误，说明接口调用失败
- 检查错误信息中的 URL 和状态码

#### 2.2 添加调试日志（可选）

如果需要更详细的调试信息，可以在代码中添加 `console.log`：

```typescript
const loadEvidence = async () => {
  if (!id) return;
  try {
    setEvidenceLoading(true);
    console.log('[DEBUG] Loading evidence for trip:', id);
    const data = await tripsApi.getEvidence(id, { limit: 3, offset: 0 });
    console.log('[DEBUG] Evidence loaded:', data);
    setEvidence(data);
  } catch (err: any) {
    console.error('Failed to load evidence:', err);
  } finally {
    setEvidenceLoading(false);
  }
};
```

---

### 方法3: 页面UI验证

#### 3.1 验证"关键证据"卡片

**位置**: 总览标签页 → 右侧 → "关键证据"卡片

**检查点**:
- [ ] 卡片标题显示"关键证据"
- [ ] 显示证据列表（如果有数据）
- [ ] 证据类型正确显示（营业时间、封路信息、天气窗口等）
- [ ] 显示证据描述
- [ ] 如果有关联日期，显示 "Day X"
- [ ] 如果数据为空，显示"暂无关键证据"
- [ ] 加载时显示加载动画

**测试场景**:
1. 有数据：应该显示前3条证据
2. 无数据：应该显示"暂无关键证据"
3. 加载中：应该显示加载动画

---

#### 3.2 验证"Top Risks"卡片

**位置**: 总览标签页 → 右侧 → "Top Risks"卡片

**检查点**:
- [ ] 卡片标题显示"Top Risks"
- [ ] 显示风险提示列表（如果有数据）
- [ ] 风险提示显示人格名称（Abu、Dr.Dre、Neptune）
- [ ] 根据严重程度显示不同颜色：
  - `warning` = 黄色背景
  - `info` = 蓝色背景
  - `success` = 绿色背景
- [ ] 如果数据为空，显示"暂无风险提示"
- [ ] 如果超过3条，显示"还有 X 条风险提示"
- [ ] 降级方案：如果 `personaAlerts` 为空，显示 `conflicts`

**测试场景**:
1. 有 personaAlerts：显示人格警报
2. 无 personaAlerts 但有 conflicts：显示冲突列表
3. 都为空：显示"暂无风险提示"

---

#### 3.3 验证"路线骨架图"中的每日指标

**位置**: 总览标签页 → 左侧 → "路线骨架图"卡片

**检查点**:
- [ ] 每个日期卡片显示正确的日期
- [ ] 显示步行距离（格式：X.X km）
- [ ] 显示车程（格式：X min）
- [ ] 显示缓冲时间（格式：X min）
- [ ] 显示风险等级（高/中/低）
- [ ] 风险等级颜色正确：
  - 高 = 红色背景
  - 中 = 黄色背景
  - 低 = 绿色背景
- [ ] 如果数据未加载，显示 "--"
- [ ] 加载时显示加载动画

**测试场景**:
1. 有数据：显示实际指标
2. 无数据：显示 "--"
3. 加载中：显示加载动画

---

#### 3.4 验证健康度指标

**位置**: 页面顶部 → 中间 → HealthBar 组件

**检查点**:
- [ ] 显示可执行度（0-100）
- [ ] 显示缓冲（0-100）
- [ ] 显示风险（0-100，越低越好）
- [ ] 显示成本控制（0-100）
- [ ] 数值应该基于实际数据计算，不是固定值

**验证方法**:
1. 打开开发者工具 → Console
2. 输入以下代码查看计算值：
   ```javascript
   // 在 React DevTools 中查看组件状态
   // 或添加 console.log 查看 healthMetrics
   ```

**计算逻辑验证**:
- 可执行度：基于缓冲时间和疲劳指数
- 缓冲：基于总缓冲时间
- 风险：基于冲突数量
- 成本：基于预算使用比例

---

## 三、测试用例

### 测试用例1: 正常数据流

**步骤**:
1. 打开一个已有数据的行程详情页
2. 等待页面加载完成
3. 检查所有卡片是否显示数据

**预期结果**:
- ✅ 所有接口调用成功（状态码 200）
- ✅ 关键证据显示数据
- ✅ Top Risks 显示数据
- ✅ 每日指标显示数据
- ✅ 健康度指标显示计算后的值

---

### 测试用例2: 空数据场景

**步骤**:
1. 创建一个新的、空的行程（或使用没有数据的行程）
2. 打开行程详情页
3. 检查各个卡片

**预期结果**:
- ✅ 接口调用成功（可能返回空数组或空对象）
- ✅ 关键证据显示"暂无关键证据"
- ✅ Top Risks 显示"暂无风险提示"
- ✅ 每日指标显示 "--"
- ✅ 健康度指标显示默认值或计算值

---

### 测试用例3: 接口错误场景

**模拟方法**:
1. 在浏览器开发者工具 → Network 标签页
2. 找到对应的接口请求
3. 右键 → Block request URL（或使用网络节流）
4. 刷新页面

**预期结果**:
- ✅ 页面不会崩溃
- ✅ 显示默认值或空状态
- ✅ 控制台有错误日志（但不影响主流程）
- ✅ 其他功能正常工作

---

### 测试用例4: 加载状态

**步骤**:
1. 打开开发者工具 → Network 标签页
2. 设置网络节流为 "Slow 3G"
3. 刷新页面
4. 观察加载状态

**预期结果**:
- ✅ 显示加载动画（Spinner）
- ✅ 数据加载完成后正确显示
- ✅ 没有闪烁或布局跳动

---

### 测试用例5: 数据更新

**步骤**:
1. 打开行程详情页
2. 在另一个标签页修改行程（添加/删除行程项）
3. 回到详情页，刷新

**预期结果**:
- ✅ 数据正确更新
- ✅ 指标重新计算
- ✅ 风险列表更新

---

## 四、常见问题排查

### 问题1: 接口返回 404

**可能原因**:
- 后端路由未配置
- 接口路径错误
- 行程 ID 不存在

**解决方法**:
1. 检查 Network 标签页中的请求 URL
2. 确认后端服务正常运行
3. 检查 API 基础 URL 配置

---

### 问题2: 接口返回 401/403

**可能原因**:
- 未登录或 token 过期
- 权限不足

**解决方法**:
1. 检查登录状态
2. 刷新 token
3. 检查权限配置

---

### 问题3: 数据不显示

**可能原因**:
- 接口返回空数据
- 数据格式不正确
- 前端解析错误

**解决方法**:
1. 检查 Network 标签页中的响应数据
2. 检查控制台是否有错误
3. 验证数据格式是否符合类型定义

---

### 问题4: 健康度指标始终是固定值

**可能原因**:
- `tripMetrics` 未加载
- 计算逻辑错误
- 数据格式不匹配

**解决方法**:
1. 检查 `tripMetrics` 是否已加载
2. 在控制台查看 `tripMetrics` 的值
3. 检查计算逻辑是否正确

---

## 五、自动化测试建议

### 5.1 使用 Postman/Insomnia

创建 API 测试集合，测试所有接口：

```json
{
  "name": "Trip Detail APIs",
  "requests": [
    {
      "name": "Get Evidence",
      "method": "GET",
      "url": "{{baseUrl}}/trips/{{tripId}}/evidence?limit=3&offset=0"
    },
    {
      "name": "Get Persona Alerts",
      "method": "GET",
      "url": "{{baseUrl}}/trips/{{tripId}}/persona-alerts"
    },
    {
      "name": "Get Metrics",
      "method": "GET",
      "url": "{{baseUrl}}/trips/{{tripId}}/metrics"
    },
    {
      "name": "Get Conflicts",
      "method": "GET",
      "url": "{{baseUrl}}/trips/{{tripId}}/conflicts"
    }
  ]
}
```

---

### 5.2 使用 Cypress/Playwright

编写端到端测试：

```typescript
describe('Trip Detail Page - API Integration', () => {
  it('should load evidence data', () => {
    cy.visit('/dashboard/trips/trip-id');
    cy.intercept('GET', '**/trips/*/evidence**').as('getEvidence');
    cy.wait('@getEvidence').then((interception) => {
      expect(interception.response.statusCode).to.eq(200);
      expect(interception.response.body.data).to.have.property('items');
    });
    cy.contains('关键证据').should('be.visible');
  });

  it('should load persona alerts', () => {
    cy.visit('/dashboard/trips/trip-id');
    cy.intercept('GET', '**/trips/*/persona-alerts').as('getPersonaAlerts');
    cy.wait('@getPersonaAlerts');
    cy.contains('Top Risks').should('be.visible');
  });
});
```

---

## 六、验证清单

### 接口调用验证

- [ ] `GET /trips/:id/evidence` 调用成功
- [ ] `GET /trips/:id/persona-alerts` 调用成功
- [ ] `GET /trips/:id/metrics` 调用成功
- [ ] `GET /trips/:id/conflicts` 调用成功
- [ ] 所有接口返回状态码 200
- [ ] 响应数据格式正确

### UI 显示验证

- [ ] 关键证据卡片显示数据
- [ ] Top Risks 卡片显示数据
- [ ] 每日指标显示数据
- [ ] 健康度指标显示计算值
- [ ] 加载状态正确显示
- [ ] 空状态正确显示
- [ ] 错误状态正确处理

### 功能验证

- [ ] 数据正确映射到 UI
- [ ] 数据格式化正确（单位、小数位等）
- [ ] 颜色和样式根据数据变化
- [ ] 降级方案正常工作
- [ ] 错误处理不影响主流程

---

## 七、快速验证脚本

在浏览器控制台中运行以下代码，快速检查接口状态：

```javascript
// 获取当前行程 ID（需要先打开行程详情页）
const tripId = window.location.pathname.split('/').pop();

// 检查接口是否可访问
async function checkAPIs() {
  const baseUrl = 'http://localhost:3000/api'; // 根据实际情况修改
  const apis = [
    { name: 'Evidence', url: `${baseUrl}/trips/${tripId}/evidence?limit=3&offset=0` },
    { name: 'Persona Alerts', url: `${baseUrl}/trips/${tripId}/persona-alerts` },
    { name: 'Metrics', url: `${baseUrl}/trips/${tripId}/metrics` },
    { name: 'Conflicts', url: `${baseUrl}/trips/${tripId}/conflicts` },
  ];

  for (const api of apis) {
    try {
      const response = await fetch(api.url, {
        headers: {
          'Authorization': `Bearer ${localStorage.getItem('accessToken')}` // 根据实际情况修改
        }
      });
      const data = await response.json();
      console.log(`✅ ${api.name}:`, response.status, data);
    } catch (error) {
      console.error(`❌ ${api.name}:`, error);
    }
  }
}

checkAPIs();
```

---

## 八、总结

### 验证步骤总结

1. **打开开发者工具** → Network 标签页
2. **访问行程详情页**
3. **检查接口调用** → 确认所有接口都调用
4. **检查响应数据** → 确认数据格式正确
5. **检查 UI 显示** → 确认数据正确显示
6. **测试各种场景** → 正常、空数据、错误等

### 关键检查点

- ✅ 接口调用成功（状态码 200）
- ✅ 数据正确显示在 UI 上
- ✅ 加载状态和空状态正确处理
- ✅ 错误处理不影响主流程
- ✅ 数据格式化和样式正确

---

**提示**: 如果遇到问题，优先检查 Network 标签页中的请求和响应，这是最直接的验证方法。

