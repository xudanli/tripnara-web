# 智能行程生成 - 前端对接完成清单

## ✅ 已完成的工作

### 1. 类型定义 (`src/types/trip.ts`)

- ✅ `GenerateTripDraftRequest` - 生成草案请求参数
- ✅ `TripDraftResponse` - 草案响应
- ✅ `DraftItineraryItem` - 行程项草案
- ✅ `DraftDay` - 一天的行程草案
- ✅ `SaveDraftRequest` - 保存草案请求
- ✅ `ReplaceItineraryItemRequest/Response` - 替换行程项
- ✅ `RegenerateTripRequest/Response` - 重生成行程
- ✅ `CreateTripResponse` - 已扩展，包含 `itemsCount` 和 `days` 字段

### 2. API 接口 (`src/api/trips.ts`)

- ✅ `generateDraft()` - POST `/trips/draft` - 生成行程草案
- ✅ `saveDraft()` - POST `/trips` (支持从草案保存) - 保存草案为正式行程
- ✅ `replaceItem()` - POST `/trips/:tripId/items/:itemId/replace` - 替换单个行程项
- ✅ `regenerate()` - POST `/trips/:tripId/regenerate` - 全局重生成行程
- ✅ `getEvidence()` - GET `/trips/:id/evidence` - 获取行程证据列表
- ✅ `getAttentionQueue()` - GET `/trips/attention-queue` - 获取关注队列

### 3. 生成页面 (`src/pages/trips/generate.tsx`)

- ✅ 参数输入表单（目的地、天数、风格、强度等）
- ✅ 约束条件选择（带娃、老人、早起困难等）
- ✅ 实时预览生成的行程草案
- ✅ 锁定/解锁行程项功能
- ✅ 保存为正式行程
- ✅ 错误处理（支持不同错误码的友好提示）

### 4. 行程详情页集成 (`src/pages/trips/[id].tsx`)

- ✅ 替换行程项功能（集成 `ReplaceItineraryItemDialog`）
- ✅ 重生成行程功能（在 Plan Tab 顶部）
- ✅ 替换按钮（在行程项的下拉菜单中）

### 5. 替换对话框 (`src/components/trips/ReplaceItineraryItemDialog.tsx`)

- ✅ 替换原因选择
- ✅ 风格偏好设置（当 reason 为 `change_style` 时）
- ✅ 显示替换方案和备选方案
- ✅ 显示证据（营业时间、评分等）
- ✅ 确认替换功能

### 6. 使用模板创建行程 (`src/components/trips/CreateTripFromTemplateDialog.tsx`)

- ✅ 完整的表单（目的地、日期、预算、偏好等）
- ✅ 自动计算结束日期（基于模板天数）
- ✅ 约束条件选择
- ✅ 创建成功后跳转

### 7. 证据与关注队列 (`src/components/layout/EvidenceDrawer.tsx`, `src/pages/Dashboard.tsx`)

- ✅ 证据列表展示（EvidenceDrawer组件）
- ✅ 关注队列展示（Dashboard页面）
- ✅ 支持按天、类型过滤证据
- ✅ 支持按严重程度、类型、行程ID过滤关注队列
- ✅ 显示严重程度标签和状态
- ✅ 支持跳转到相关行程

---

## 📋 接口对接状态

### 核心接口

| 接口 | 方法 | 路径 | 前端状态 | 后端状态 | 说明 |
|------|------|------|---------|---------|------|
| 生成草案 | POST | `/trips/draft` | ✅ 已对接 | ⏳ 待实现 | 生成行程草案（不落库，先预览） |
| 保存草案 | POST | `/trips` | ✅ 已对接 | ⏳ 待实现 | 保存草案为正式行程 |
| 替换单项 | POST | `/trips/:tripId/items/:itemId/replace` | ✅ 已对接 | ⏳ 待实现 | 替换单个行程项（Neptune修复） |
| 重生成 | POST | `/trips/:tripId/regenerate` | ✅ 已对接 | ⏳ 待实现 | 全局重生成行程（保持用户已锁定的项） |

### 证据与关注队列接口

| 接口 | 方法 | 路径 | 前端状态 | 后端状态 | 说明 |
|------|------|------|---------|---------|------|
| 获取证据列表 | GET | `/trips/:id/evidence` | ✅ 已对接 | ⏳ 待实现 | 获取行程证据列表（支持按天、类型过滤） |
| 获取关注队列 | GET | `/trips/attention-queue` | ✅ 已对接 | ⏳ 待实现 | 获取关注队列（支持按严重程度、类型、行程ID过滤） |

### 相关支持接口

以下接口在智能行程生成流程中也会使用到：

| 接口 | 方法 | 路径 | 前端状态 | 后端状态 | 说明 |
|------|------|------|---------|---------|------|
| 创建行程 | POST | `/trips` | ✅ 已对接 | ✅ 已实现 | 创建新行程（通用接口） |
| 获取行程详情 | GET | `/trips/:id` | ✅ 已对接 | ✅ 已实现 | 获取行程详情（全景视图） |
| 更新行程 | PUT | `/trips/:id` | ✅ 已对接 | ✅ 已实现 | 更新行程信息 |
| 获取行程项详情 | GET | `/itinerary-items/:id` | ✅ 已对接 | ✅ 已实现 | 获取行程项详情 |
| 更新行程项 | PATCH | `/itinerary-items/:id` | ✅ 已对接 | ✅ 已实现 | 更新行程项信息 |
| 删除行程项 | DELETE | `/itinerary-items/:id` | ✅ 已对接 | ✅ 已实现 | 删除行程项 |
| 路线节点替换 | POST | `/decision/replace-nodes` | ✅ 已对接 | ✅ 已实现 | Neptune策略：路线节点智能替换 |
| 行程节奏调整 | POST | `/decision/adjust-pacing` | ✅ 已对接 | ✅ 已实现 | Dr.Dre策略：行程节奏智能调整 |
| 安全规则校验 | POST | `/decision/validate-safety` | ✅ 已对接 | ✅ 已实现 | Abu策略：安全规则校验 |
| 获取三人格提醒 | GET | `/trips/:id/persona-alerts` | ✅ 已对接 | ✅ 已实现 | 获取三人格提醒列表 |
| 获取决策日志 | GET | `/trips/:id/decision-log` | ✅ 已对接 | ✅ 已实现 | 获取决策记录/透明日志 |

---

## 🎯 功能流程

### 流程 1: 生成新行程

1. 用户访问 `/dashboard/trips/generate`
2. 填写参数（目的地、天数、风格等）
3. 点击"生成行程"
4. 系统调用 `POST /trips/draft`
5. 显示草案预览（可锁定/解锁项）
6. 点击"保存行程"
7. 系统调用 `POST /trips`（传入草案）
8. 跳转到行程详情页

### 流程 2: 替换单个行程项

1. 用户在行程详情页的 Plan Tab
2. 点击行程项的下拉菜单 → "替换"
3. 弹出 `ReplaceItineraryItemDialog`
4. 选择替换原因（太累/天气变化/想换风格等）
5. 点击"查找替换方案"
6. 系统调用 `POST /trips/:tripId/items/:itemId/replace`
7. 显示新项和备选方案
8. 用户确认后，更新行程项

### 流程 3: 重生成行程

1. 用户在行程详情页的 Plan Tab
2. 点击"重生成行程"按钮
3. 确认后，系统调用 `POST /trips/:tripId/regenerate`
4. 显示变更列表
5. 用户确认后，应用变更

---

## 🔧 错误处理

前端已实现以下错误处理：

### 生成草案错误

```typescript
switch (error.code) {
  case 'INSUFFICIENT_CANDIDATES':
    // 显示友好提示，建议用户选择其他目的地
    break;
  case 'VALIDATION_FAILED':
    // 显示校验警告
    break;
  case 'LLM_ERROR':
    // 提示重试
    break;
}
```

### 统一响应格式

所有接口都遵循文档中的统一响应格式：
- 成功：`{ success: true, data: {...} }`
- 失败：`{ success: false, error: { code, message } }`

---

## 📝 注意事项

### 1. 时段定义

已按照文档定义：
- `morning`: 9:00-12:00
- `lunch`: 12:00-13:30
- `afternoon`: 13:30-17:30
- `dinner`: 18:00-20:00
- `evening`: 可选

### 2. ItemType 映射

前端在保存时会根据 slot 和 place category 自动映射：
- morning/afternoon/evening → `ACTIVITY`
- lunch/dinner + RESTAURANT → `MEAL_ANCHOR`
- lunch/dinner + 其他 → `MEAL_FLOATING`

### 3. 日期格式

- 所有日期使用 `YYYY-MM-DD` 格式
- 所有时间使用 ISO 8601 格式

### 4. 锁定机制

- 锁定项使用 `${dayIndex}-${slot}` 作为 key
- 保存时会转换为 `lockedItemIds` 数组

---

## 📊 接口统计汇总

### 智能行程生成核心接口
- **生成草案**: 1 个接口
- **保存草案**: 1 个接口
- **替换单项**: 1 个接口
- **重生成**: 1 个接口
- **证据与关注队列**: 2 个接口
- **小计**: 6 个核心接口（前端已对接，后端待实现）

### 相关支持接口
- **行程管理**: 3 个接口（已实现）
- **行程项管理**: 3 个接口（已实现）
- **决策引擎**: 3 个接口（已实现）
- **Dashboard决策系统**: 2 个接口（已实现）
- **小计**: 11 个支持接口（前后端均已实现）

### 总计
- **核心接口**: 6 个（前端 ✅，后端 ⏳）
- **支持接口**: 11 个（前后端 ✅）
- **接口总数**: 17 个

---

## ✅ 检查清单

### 核心功能
- [x] 类型定义完整（智能行程生成相关类型）
- [x] API 方法实现（6个核心接口）
- [x] 生成页面完成（`src/pages/trips/generate.tsx`）
- [x] 替换功能集成（`ReplaceItineraryItemDialog`）
- [x] 重生成功能集成（行程详情页）
- [x] 错误处理完善
- [x] 使用模板创建行程
- [x] 路由配置正确

### 证据与关注队列
- [x] 证据列表类型定义
- [x] 关注队列类型定义
- [x] API 方法实现（2个接口）
- [x] EvidenceDrawer 组件集成
- [x] Dashboard 关注队列集成
- [x] 过滤和排序功能
- [x] 跳转功能

### 待完成
- [ ] 后端接口实现（6个核心接口）
- [ ] 端到端测试（待后端）

---

## 📚 相关文档

- `API-智能行程生成接口规范.md` - 详细接口规范
- `API-智能行程生成-快速参考.md` - 快速参考
- `API-路线模板接口说明.md` - 路线模板接口
- `证据与关注队列-前端对接完成清单.md` - 证据与关注队列详细说明
- `API对接清单.md` - 项目所有已对接接口清单（共104个接口）

---

**状态**: 前端代码已完成，等待后端实现 6 个核心接口即可使用。

**最后更新**: 2025-01-01

