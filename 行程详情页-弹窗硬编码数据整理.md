# è¡Œç¨‹è¯¦æƒ…é¡µ - å¼¹çª—ç¡¬ç¼–ç æ•°æ®æ•´ç†

**ç”Ÿæˆæ—¶é—´**: 2025-01-XX  
**æ–‡ä»¶**: `src/pages/trips/[id].tsx` åŠç›¸å…³è§†å›¾ç»„ä»¶

---

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [å¼¹çª—åˆ†ç±»](#å¼¹çª—åˆ†ç±»)
3. [ç¡¬ç¼–ç å¼¹çª—è¯¦ç»†åˆ†æ](#ç¡¬ç¼–ç å¼¹çª—è¯¦ç»†åˆ†æ)
4. [å·²å¯¹æ¥å¼¹çª—åˆ—è¡¨](#å·²å¯¹æ¥å¼¹çª—åˆ—è¡¨)
5. [å®ç°å»ºè®®](#å®ç°å»ºè®®)

---

## ğŸ“Š æ¦‚è¿°

è¡Œç¨‹è¯¦æƒ…é¡µåŒ…å«å¤šç§å¼¹çª—ï¼ˆDialog/Sheet/AlertDialogï¼‰ï¼Œç”¨äºå±•ç¤ºå’Œç¼–è¾‘æ•°æ®ã€‚è¿™äº›å¼¹çª—å¯ä»¥åˆ†ä¸ºä¸¤ç±»ï¼š
- **å·²å¯¹æ¥å¼¹çª—**ï¼šæ•°æ®æ¥è‡ª APIï¼ŒåŠŸèƒ½å®Œæ•´
- **ç¡¬ç¼–ç å¼¹çª—**ï¼šæ•°æ®ä¸ºç¡¬ç¼–ç ï¼Œéœ€è¦å¯¹æ¥ API

---

## ğŸ“¦ å¼¹çª—åˆ†ç±»

### âœ… å·²å¯¹æ¥å¼¹çª—ï¼ˆ6ä¸ªï¼‰

è¿™äº›å¼¹çª—æ•°æ®æ¥è‡ª APIï¼ŒåŠŸèƒ½å®Œæ•´ï¼š

1. **EditTripDialog** - ç¼–è¾‘è¡Œç¨‹å¯¹è¯æ¡†
2. **ShareTripDialog** - åˆ†äº«å¯¹è¯æ¡†
3. **CollaboratorsDialog** - åä½œè€…å¯¹è¯æ¡†
4. **CreateItineraryItemDialog** - åˆ›å»ºè¡Œç¨‹é¡¹å¯¹è¯æ¡†
5. **EditItineraryItemDialog** - ç¼–è¾‘è¡Œç¨‹é¡¹å¯¹è¯æ¡†
6. **ReplaceItineraryItemDialog** - æ›¿æ¢è¡Œç¨‹é¡¹å¯¹è¯æ¡†
7. **AlertDialog (åˆ é™¤ç¡®è®¤)** - åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†ï¼ˆæ— æ•°æ®å±•ç¤ºï¼‰

### âš ï¸ ç¡¬ç¼–ç å¼¹çª—ï¼ˆ3ä¸ªï¼‰

è¿™äº›å¼¹çª—ä¸­çš„æ•°æ®ä¸ºç¡¬ç¼–ç ï¼Œéœ€è¦å¯¹æ¥ APIï¼š

1. **AbuView - EvidenceSheet** - é£é™©è¯¦æƒ…æŠ½å±‰
2. **NeptuneView - AlternativesSheet** - æ›¿ä»£æ–¹æ¡ˆæŠ½å±‰
3. **NeptuneView - PatchSheet** - ä¿®å¤è¯¦æƒ…æŠ½å±‰

---

## ğŸ” ç¡¬ç¼–ç å¼¹çª—è¯¦ç»†åˆ†æ

### 1. AbuView - EvidenceSheetï¼ˆé£é™©è¯¦æƒ…æŠ½å±‰ï¼‰

#### åŸºæœ¬ä¿¡æ¯
- **æ–‡ä»¶**: `src/components/trips/views/AbuView.tsx`
- **ç»„ä»¶**: `Sheet` (Shadcn UI)
- **çŠ¶æ€**: `evidenceSheetOpen` (è¡Œ 43)
- **è§¦å‘**: ç‚¹å‡»è¡Œç¨‹é¡¹æ—¶æ‰“å¼€ï¼ˆè¡Œ 125-131ï¼‰
- **ä½ç½®**: è¡Œ 286-438

#### ç¡¬ç¼–ç æ•°æ®

**1.1 riskMapï¼ˆé£é™©æ˜ å°„ï¼‰**
- **ä½ç½®**: è¡Œ 73-77
- **ç±»å‹**: `RiskMap` (å¯¹è±¡)
- **ç”¨é€”**: å­˜å‚¨æ¯ä¸ªè¡Œç¨‹é¡¹çš„é£é™©ä¿¡æ¯
- **ç»“æ„**:
  ```typescript
  {
    [itemId: string]: {
      level: 'HIGH' | 'MEDIUM' | 'LOW' | 'NONE';
      tags: string[];
      confidence: number;
    };
  }
  ```
- **ç¡¬ç¼–ç ç¤ºä¾‹**:
  ```typescript
  const riskMap: RiskMap = {
    'item-1': { level: 'LOW', tags: [...], confidence: 0.8 },
    'item-2': { level: 'HIGH', tags: [...], confidence: 0.95 },
    'item-3': { level: 'MEDIUM', tags: [...], confidence: 0.7 },
  };
  ```
- **åœ¨å¼¹çª—ä¸­çš„ä½¿ç”¨**:
  - è¡Œ 322: `const itemRisk = getItemRisk(selectedItem.id);`
  - è¡Œ 133-135: `getItemRisk` å‡½æ•°ä» `riskMap` ä¸­è·å–æ•°æ®
  - è¡Œ 325-350: æ˜¾ç¤ºé£é™©çº§åˆ«ã€æ ‡ç­¾ã€ç½®ä¿¡åº¦

**1.2 violationsï¼ˆè¿è§„åˆ—è¡¨ï¼‰**
- **ä½ç½®**: è¡Œ 47-71
- **ç±»å‹**: `RiskViolation[]` (æ•°ç»„)
- **ç”¨é€”**: å­˜å‚¨æ‰€æœ‰å®‰å…¨è¿è§„é¡¹
- **ç»“æ„**:
  ```typescript
  {
    level: 'HARD' | 'SOFT';
    code: string;
    title: string;
    reason: string;
    evidence: Array<{ field: string; value: string; timestamp?: string }>;
    affectedItemIds: string[];
  }
  ```
- **ç¡¬ç¼–ç ç¤ºä¾‹**:
  ```typescript
  const violations: RiskViolation[] = [
    {
      level: 'HARD',
      code: 'NIGHT_HIKE',
      title: 'å¤œé—´å¾’æ­¥é£é™©',
      reason: '...',
      evidence: [
        { field: 'æ—¥è½æ—¶é—´', value: '18:30', timestamp: '2024-01-15' },
        { field: 'é¢„è®¡ç»“æŸæ—¶é—´', value: '19:45' },
        { field: 'è·¯çº¿éš¾åº¦', value: 'CHALLENGE' },
      ],
      affectedItemIds: ['item-2'],
    },
    // ...
  ];
  ```
- **åœ¨å¼¹çª—ä¸­çš„ä½¿ç”¨**:
  - è¡Œ 351-430: æ˜¾ç¤ºç›¸å…³è¿è§„é¡¹åˆ—è¡¨
  - è¿‡æ»¤é€»è¾‘: `violations.filter(v => v.affectedItemIds.includes(selectedItem.id))`
  - æ˜¾ç¤ºè¿è§„é¡¹æ ‡é¢˜ã€åŸå› ã€è¯æ®åˆ—è¡¨

#### å¼¹çª—å†…å®¹ç»“æ„

```
é£é™©è¯¦æƒ…æŠ½å±‰
â”œâ”€ SheetHeader
â”‚  â”œâ”€ æ ‡é¢˜: "é£é™©è¯¦æƒ…"
â”‚  â””â”€ æè¿°: "{åœ°ç‚¹åç§°} çš„é£é™©è¯„ä¼°ä¸è¯æ®"
â”œâ”€ è¡Œç¨‹é¡¹ä¿¡æ¯å¡ç‰‡
â”‚  â”œâ”€ åœ°ç‚¹åç§°
â”‚  â”œâ”€ æ—¶é—´èŒƒå›´
â”‚  â””â”€ ç±»å‹
â”œâ”€ é£é™©è¯„ä¼°å¡ç‰‡
â”‚  â”œâ”€ é£é™©çº§åˆ«ï¼ˆHIGH/MEDIUM/LOW/NONEï¼‰
â”‚  â”œâ”€ é£é™©æ ‡ç­¾åˆ—è¡¨
â”‚  â””â”€ ç½®ä¿¡åº¦
â””â”€ ç›¸å…³è¿è§„é¡¹åˆ—è¡¨
   â”œâ”€ è¿è§„é¡¹å¡ç‰‡ï¼ˆæ¯ä¸ªï¼‰
   â”‚  â”œâ”€ è¿è§„çº§åˆ«ï¼ˆHARD/SOFTï¼‰
   â”‚  â”œâ”€ è¿è§„æ ‡é¢˜
   â”‚  â”œâ”€ è¿è§„åŸå› 
   â”‚  â””â”€ è¯æ®åˆ—è¡¨
   â””â”€ æ— è¿è§„é¡¹æç¤º
```

#### éœ€è¦å¯¹æ¥çš„æ¥å£

1. **è·å–å•é¡¹é£é™©**
   - æ¥å£: `GET /trips/:id/items/:itemId/risk`
   - ç”¨é€”: è·å–æŒ‡å®šè¡Œç¨‹é¡¹çš„é£é™©ä¿¡æ¯ï¼ˆlevel, tags, confidenceï¼‰
   - ä¼˜å…ˆçº§: ğŸ”´ é«˜

2. **è·å–è¿è§„åˆ—è¡¨**
   - æ¥å£: `GET /trips/:id/violations`
   - ç”¨é€”: è·å–æ‰€æœ‰å®‰å…¨è¿è§„é¡¹
   - ä¼˜å…ˆçº§: ğŸ”´ é«˜

---

### 2. NeptuneView - AlternativesSheetï¼ˆæ›¿ä»£æ–¹æ¡ˆæŠ½å±‰ï¼‰

#### åŸºæœ¬ä¿¡æ¯
- **æ–‡ä»¶**: `src/components/trips/views/NeptuneView.tsx`
- **ç»„ä»¶**: `Sheet` (Shadcn UI)
- **çŠ¶æ€**: `alternativesSheetOpen` (è¡Œ 62)
- **è§¦å‘**: ç‚¹å‡»è¡Œç¨‹é¡¹æ—¶æ‰“å¼€ï¼ˆè¡Œ 172-178ï¼‰
- **ä½ç½®**: è¡Œ 375-478

#### ç¡¬ç¼–ç æ•°æ®

**alternativesï¼ˆæ›¿ä»£æ–¹æ¡ˆæ˜ å°„ï¼‰**
- **ä½ç½®**: è¡Œ 119-136
- **ç±»å‹**: `{ [itemId: string]: Alternative[] }` (å¯¹è±¡)
- **ç”¨é€”**: å­˜å‚¨æ¯ä¸ªè¡Œç¨‹é¡¹çš„æ›¿ä»£åœ°ç‚¹åˆ—è¡¨
- **ç»“æ„**:
  ```typescript
  {
    placeId: number;
    placeName: string;
    reasonFit: string;
    delta: {
      time: number;
      distance: number;
      cost: number;
    };
    bookingInfo?: string;
  }
  ```
- **ç¡¬ç¼–ç ç¤ºä¾‹**:
  ```typescript
  const alternatives: { [itemId: string]: Alternative[] } = {
    'item-2': [
      {
        placeId: 123,
        placeName: 'æ›¿ä»£è·¯çº¿A',
        reasonFit: 'è·ç¦»æ›´çŸ­ï¼Œæ—¶é—´æ›´å°‘',
        delta: { time: -30, distance: -2, cost: -30 },
        bookingInfo: 'æ— éœ€é¢„è®¢',
      },
      {
        placeId: 124,
        placeName: 'æ›¿ä»£è·¯çº¿B',
        reasonFit: 'æ›´å®‰å…¨ï¼Œä½†éœ€è¦é¢„è®¢',
        delta: { time: 0, distance: 0, cost: 0 },
        bookingInfo: 'éœ€è¦é¢„è®¢',
      },
    ],
  };
  ```
- **åœ¨å¼¹çª—ä¸­çš„ä½¿ç”¨**:
  - è¡Œ 169: `getItemAlternatives` å‡½æ•°ä» `alternatives` ä¸­è·å–æ•°æ®
  - è¡Œ 397-472: æ˜¾ç¤ºæ›¿ä»£æ–¹æ¡ˆåˆ—è¡¨
  - æ¯ä¸ªæ›¿ä»£æ–¹æ¡ˆæ˜¾ç¤ºï¼š
    - åœ°ç‚¹åç§°å’ŒID
    - é€‚åˆåŸå› 
    - å˜æ›´é‡ï¼ˆæ—¶é—´ã€è·ç¦»ã€æˆæœ¬ï¼‰
    - é¢„è®¢ä¿¡æ¯
    - "åº”ç”¨æ›¿ä»£"æŒ‰é’®ï¼ˆè¡Œ 460-469ï¼Œå½“å‰ä»… console.logï¼‰

#### å¼¹çª—å†…å®¹ç»“æ„

```
æ›¿ä»£æ–¹æ¡ˆæŠ½å±‰
â”œâ”€ SheetHeader
â”‚  â”œâ”€ æ ‡é¢˜: "æ›¿ä»£å€™é€‰åˆ—è¡¨"
â”‚  â””â”€ æè¿°
â”œâ”€ æ›¿ä»£æ–¹æ¡ˆåˆ—è¡¨ï¼ˆæ¯ä¸ªï¼‰
â”‚  â”œâ”€ Card
â”‚  â”‚  â”œâ”€ åœ°ç‚¹åç§°å’ŒID
â”‚  â”‚  â”œâ”€ é€‚åˆåŸå› 
â”‚  â”‚  â”œâ”€ å˜æ›´é‡å±•ç¤º
â”‚  â”‚  â”‚  â”œâ”€ æ—¶é—´å˜æ›´ï¼ˆ+/-åˆ†é’Ÿï¼‰
â”‚  â”‚  â”‚  â”œâ”€ è·ç¦»å˜æ›´ï¼ˆ+/-å…¬é‡Œï¼‰
â”‚  â”‚  â”‚  â””â”€ æˆæœ¬å˜æ›´ï¼ˆ+/-é‡‘é¢ï¼‰
â”‚  â”‚  â”œâ”€ é¢„è®¢ä¿¡æ¯
â”‚  â”‚  â””â”€ "åº”ç”¨æ›¿ä»£"æŒ‰é’®ï¼ˆç¡¬ç¼–ç ï¼šä»…console.logï¼‰
â”‚  â””â”€ ç©ºçŠ¶æ€æç¤º
```

#### éœ€è¦å¯¹æ¥çš„æ¥å£

1. **è·å–æ›¿ä»£æ–¹æ¡ˆ**
   - æ¥å£: `GET /trips/:id/items/:itemId/alternatives`
   - ç”¨é€”: è·å–æŒ‡å®šè¡Œç¨‹é¡¹çš„æ›¿ä»£åœ°ç‚¹åˆ—è¡¨
   - ä¼˜å…ˆçº§: ğŸŸ¡ ä¸­

2. **åº”ç”¨æ›¿ä»£æ–¹æ¡ˆ**
   - æ¥å£: `POST /trips/:id/items/:itemId/replace` æˆ–ç±»ä¼¼æ¥å£
   - ç”¨é€”: åº”ç”¨é€‰æ‹©çš„æ›¿ä»£æ–¹æ¡ˆ
   - ä¼˜å…ˆçº§: ğŸ”´ é«˜
   - **å½“å‰çŠ¶æ€**: è¡Œ 464 ä»… `console.log`ï¼Œæœªå®ç°

---

### 3. NeptuneView - PatchSheetï¼ˆä¿®å¤è¯¦æƒ…æŠ½å±‰ï¼‰

#### åŸºæœ¬ä¿¡æ¯
- **æ–‡ä»¶**: `src/components/trips/views/NeptuneView.tsx`
- **ç»„ä»¶**: `Sheet` (Shadcn UI)
- **çŠ¶æ€**: `patchSheetOpen` (è¡Œ 64)
- **è§¦å‘**: 
  - ç‚¹å‡»ä¿®å¤å»ºè®®å¡ç‰‡æ—¶æ‰“å¼€ï¼ˆè¡Œ 227-229ï¼‰
  - ç‚¹å‡»"ä¸€é”®æ­¢è¡€"æŒ‰é’®æ—¶æ‰“å¼€ï¼ˆè¡Œ 184-186ï¼‰
- **ä½ç½®**: è¡Œ 481-600

#### ç¡¬ç¼–ç æ•°æ®

**repairsï¼ˆä¿®å¤å»ºè®®åˆ—è¡¨ï¼‰**
- **ä½ç½®**: è¡Œ 67-117
- **ç±»å‹**: `Repair[]` (æ•°ç»„)
- **ç”¨é€”**: å­˜å‚¨æ‰€æœ‰ä¿®å¤å»ºè®®
- **ç»“æ„**:
  ```typescript
  {
    id: string;
    type: 'REPLACE' | 'SKIP' | 'RESCHEDULE' | 'ADD_BUFFER';
    severity: 'CRITICAL' | 'WARNING';
    targetItemId: string;
    patchOps: Array<{ op: string; path: string; value: any }>;
    beforeMetrics: {
      time: number;
      distance: number;
      effort: number;
      cost: number;
      risk: string;
    };
    afterMetrics: {
      time: number;
      distance: number;
      effort: number;
      cost: number;
      risk: string;
    };
    confidence: number;
    description: string;
  }
  ```
- **ç¡¬ç¼–ç ç¤ºä¾‹**:
  ```typescript
  const repairs: Repair[] = [
    {
      id: 'repair-1',
      type: 'REPLACE',
      severity: 'CRITICAL',
      targetItemId: 'item-2',
      patchOps: [
        { op: 'replace', path: '/items/1/placeId', value: 123 },
        { op: 'replace', path: '/items/1/startTime', value: '2024-01-16T10:00:00Z' },
      ],
      beforeMetrics: { time: 180, distance: 8, effort: 70, cost: 150, risk: 'é«˜' },
      afterMetrics: { time: 150, distance: 6, effort: 50, cost: 120, risk: 'ä¸­' },
      confidence: 0.9,
      description: 'æ›¿æ¢è·¯çº¿ä»¥é™ä½é£é™©',
    },
    // ...
  ];
  ```
- **åœ¨å¼¹çª—ä¸­çš„ä½¿ç”¨**:
  - è¡Œ 189-194: `handleApplyRepair` å‡½æ•°ï¼ˆå½“å‰ä»… console.logï¼‰
  - è¡Œ 490-595: æ˜¾ç¤ºä¿®å¤è¯¦æƒ…
  - æ˜¾ç¤ºå†…å®¹ï¼š
    - ä¿®å¤æè¿°å’Œç±»å‹
    - Before/After æŒ‡æ ‡å¯¹æ¯”
    - JSON Patch æ“ä½œé¢„è§ˆ
    - "åº”ç”¨ä¿®å¤"æŒ‰é’®ï¼ˆè¡Œ 540-560ï¼Œå½“å‰ä»… console.logï¼‰

#### å¼¹çª—å†…å®¹ç»“æ„

```
ä¿®å¤è¯¦æƒ…æŠ½å±‰
â”œâ”€ SheetHeader
â”‚  â”œâ”€ æ ‡é¢˜: "ä¿®å¤è¯¦æƒ…"
â”‚  â””â”€ æè¿°: "Before / After å¯¹æ¯”"
â”œâ”€ ä¿®å¤ä¿¡æ¯
â”‚  â”œâ”€ ä¿®å¤ç±»å‹å’Œä¸¥é‡ç¨‹åº¦
â”‚  â”œâ”€ ä¿®å¤æè¿°
â”‚  â””â”€ ç½®ä¿¡åº¦
â”œâ”€ Before/After å¯¹æ¯”å¡ç‰‡
â”‚  â”œâ”€ Before æŒ‡æ ‡
â”‚  â”‚  â”œâ”€ æ—¶é—´
â”‚  â”‚  â”œâ”€ è·ç¦»
â”‚  â”‚  â”œâ”€ åŠªåŠ›ç¨‹åº¦
â”‚  â”‚  â”œâ”€ æˆæœ¬
â”‚  â”‚  â””â”€ é£é™©
â”‚  â”œâ”€ After æŒ‡æ ‡
â”‚  â”‚  â””â”€ (åŒä¸Š)
â”‚  â””â”€ å˜æ›´é‡ï¼ˆå·®å€¼ï¼‰
â”œâ”€ JSON Patch é¢„è§ˆ
â”‚  â””â”€ æ“ä½œåˆ—è¡¨ï¼ˆreplace/add/removeï¼‰
â””â”€ æ“ä½œæŒ‰é’®
   â”œâ”€ "åº”ç”¨ä¿®å¤ï¼ˆä»…ä»Šå¤©ï¼‰"
   â”œâ”€ "åº”ç”¨ä¿®å¤ï¼ˆå…¨éƒ¨ï¼‰"
   â””â”€ "ä¿å­˜ä¸ºè‰ç¨¿"ï¼ˆç¡¬ç¼–ç ï¼šä»…console.logï¼‰
```

#### éœ€è¦å¯¹æ¥çš„æ¥å£

1. **è·å–ä¿®å¤å»ºè®®**
   - æ¥å£: `GET /trips/:id/repairs`
   - ç”¨é€”: è·å–æ‰€æœ‰ä¿®å¤å»ºè®®åˆ—è¡¨
   - ä¼˜å…ˆçº§: ğŸ”´ é«˜

2. **åº”ç”¨ä¿®å¤**
   - æ¥å£: `POST /trips/:id/repairs/:repairId/apply`
   - ç”¨é€”: åº”ç”¨ä¿®å¤å»ºè®®
   - ä¼˜å…ˆçº§: ğŸ”´ é«˜
   - **å½“å‰çŠ¶æ€**: è¡Œ 189-194 ä»… `console.log`ï¼Œæœªå®ç°
   - **å‚æ•°**: `scope: 'all' | 'today' | 'save'`

---

## âœ… å·²å¯¹æ¥å¼¹çª—åˆ—è¡¨

### 1. EditTripDialogï¼ˆç¼–è¾‘è¡Œç¨‹å¯¹è¯æ¡†ï¼‰

- **æ–‡ä»¶**: `src/components/trips/EditTripDialog.tsx`
- **ä½ç½®**: `src/pages/trips/[id].tsx` è¡Œ 1554-1561
- **çŠ¶æ€**: `editDialogOpen`
- **æ•°æ®æº**: `trip` propï¼ˆæ¥è‡ª APIï¼‰
- **æ¥å£**: `PUT /trips/:id`
- **çŠ¶æ€**: âœ… å·²å¯¹æ¥

### 2. ShareTripDialogï¼ˆåˆ†äº«å¯¹è¯æ¡†ï¼‰

- **æ–‡ä»¶**: `src/components/trips/ShareTripDialog.tsx`
- **ä½ç½®**: `src/pages/trips/[id].tsx` è¡Œ 1564-1570
- **çŠ¶æ€**: `shareDialogOpen`
- **æ•°æ®æº**: API
- **æ¥å£**: `POST /trips/:id/share`, `GET /trips/shared/:shareToken`
- **çŠ¶æ€**: âœ… å·²å¯¹æ¥

### 3. CollaboratorsDialogï¼ˆåä½œè€…å¯¹è¯æ¡†ï¼‰

- **æ–‡ä»¶**: `src/components/trips/CollaboratorsDialog.tsx`
- **ä½ç½®**: `src/pages/trips/[id].tsx` è¡Œ 1573-1579
- **çŠ¶æ€**: `collaboratorsDialogOpen`
- **æ•°æ®æº**: API
- **æ¥å£**: `GET /trips/:id/collaborators`, `POST /trips/:id/collaborators`
- **çŠ¶æ€**: âœ… å·²å¯¹æ¥

### 4. CreateItineraryItemDialogï¼ˆåˆ›å»ºè¡Œç¨‹é¡¹å¯¹è¯æ¡†ï¼‰

- **æ–‡ä»¶**: `src/components/trips/CreateItineraryItemDialog.tsx`
- **ä½ç½®**: `src/pages/trips/[id].tsx` è¡Œ 1582-1594
- **çŠ¶æ€**: `createItemDialogOpen`
- **æ•°æ®æº**: APIï¼ˆåœ°ç‚¹æœç´¢ç­‰ï¼‰
- **æ¥å£**: `POST /itinerary-items`
- **çŠ¶æ€**: âœ… å·²å¯¹æ¥

### 5. EditItineraryItemDialogï¼ˆç¼–è¾‘è¡Œç¨‹é¡¹å¯¹è¯æ¡†ï¼‰

- **æ–‡ä»¶**: `src/components/trips/EditItineraryItemDialog.tsx`
- **ä½ç½®**: `src/pages/trips/[id].tsx` è¡Œ 1597-1609
- **çŠ¶æ€**: `editItemDialogOpen`
- **æ•°æ®æº**: `editingItem` propï¼ˆæ¥è‡ªè¡Œç¨‹æ•°æ®ï¼‰
- **æ¥å£**: `PATCH /itinerary-items/:id`
- **çŠ¶æ€**: âœ… å·²å¯¹æ¥

### 6. ReplaceItineraryItemDialogï¼ˆæ›¿æ¢è¡Œç¨‹é¡¹å¯¹è¯æ¡†ï¼‰

- **æ–‡ä»¶**: `src/components/trips/ReplaceItineraryItemDialog.tsx`
- **ä½ç½®**: `src/pages/trips/[id].tsx` è¡Œ 1612-1626
- **çŠ¶æ€**: `replaceDialogOpen`
- **æ•°æ®æº**: API
- **æ¥å£**: `POST /trips/:tripId/items/:itemId/replace`
- **çŠ¶æ€**: âœ… å·²å¯¹æ¥

### 7. AlertDialogï¼ˆåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†ï¼‰

- **ä½ç½®**: `src/pages/trips/[id].tsx` è¡Œ 857-873
- **çŠ¶æ€**: `deleteDialogOpen`
- **æ•°æ®æº**: æ— æ•°æ®å±•ç¤ºï¼Œä»…ç¡®è®¤æ“ä½œ
- **æ¥å£**: `DELETE /trips/:id`
- **çŠ¶æ€**: âœ… å·²å¯¹æ¥ï¼ˆåŠŸèƒ½å®Œæ•´ï¼Œæ— éœ€æ•°æ®ï¼‰

---

## ğŸ’¡ å®ç°å»ºè®®

### ä¼˜å…ˆçº§æ’åº

**é«˜ä¼˜å…ˆçº§ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰**:
1. âœ… **NeptuneView - PatchSheet**: è·å–ä¿®å¤å»ºè®® + åº”ç”¨ä¿®å¤
2. âœ… **AbuView - EvidenceSheet**: è·å–å•é¡¹é£é™© + è·å–è¿è§„åˆ—è¡¨
3. âœ… **NeptuneView - AlternativesSheet**: åº”ç”¨æ›¿ä»£æ–¹æ¡ˆåŠŸèƒ½

**ä¸­ä¼˜å…ˆçº§ï¼ˆå¢å¼ºåŠŸèƒ½ï¼‰**:
4. **NeptuneView - AlternativesSheet**: è·å–æ›¿ä»£æ–¹æ¡ˆåˆ—è¡¨

### å®ç°æ­¥éª¤

#### æ­¥éª¤1: NeptuneView - PatchSheetï¼ˆä¿®å¤è¯¦æƒ…æŠ½å±‰ï¼‰

**1.1 æ·»åŠ çŠ¶æ€å’ŒAPIè°ƒç”¨**
```typescript
// åœ¨ NeptuneView ç»„ä»¶ä¸­æ·»åŠ 
const [repairs, setRepairs] = useState<Repair[]>([]);
const [repairsLoading, setRepairsLoading] = useState(false);

// åŠ è½½ä¿®å¤å»ºè®®
useEffect(() => {
  const loadRepairs = async () => {
    if (!trip?.id) return;
    try {
      setRepairsLoading(true);
      const data = await tripsApi.getRepairs(trip.id);
      setRepairs(data.repairs);
    } catch (err) {
      console.error('Failed to load repairs:', err);
    } finally {
      setRepairsLoading(false);
    }
  };
  loadRepairs();
}, [trip?.id]);
```

**1.2 å®ç°åº”ç”¨ä¿®å¤åŠŸèƒ½**
```typescript
const handleApplyRepair = async (repair: Repair, scope: 'all' | 'today' | 'save') => {
  if (!trip?.id) return;
  try {
    await tripsApi.applyRepair(trip.id, repair.id, { scope });
    setPatchSheetOpen(false);
    setSelectedRepair(null);
    // é‡æ–°åŠ è½½è¡Œç¨‹æ•°æ®
    // æˆ–è€…è§¦å‘çˆ¶ç»„ä»¶åˆ·æ–°
  } catch (err) {
    console.error('Failed to apply repair:', err);
    // æ˜¾ç¤ºé”™è¯¯æç¤º
  }
};
```

#### æ­¥éª¤2: AbuView - EvidenceSheetï¼ˆé£é™©è¯¦æƒ…æŠ½å±‰ï¼‰

**2.1 æ·»åŠ çŠ¶æ€å’ŒAPIè°ƒç”¨**
```typescript
// åœ¨ AbuView ç»„ä»¶ä¸­æ·»åŠ 
const [riskMap, setRiskMap] = useState<RiskMap>({});
const [violations, setViolations] = useState<RiskViolation[]>([]);
const [riskLoading, setRiskLoading] = useState(false);

// åŠ è½½é£é™©è¯„ä¼°æ•°æ®
useEffect(() => {
  const loadRiskData = async () => {
    if (!trip?.id) return;
    try {
      setRiskLoading(true);
      const [violationsData, assessment] = await Promise.all([
        tripsApi.getViolations(trip.id),
        tripsApi.getRiskAssessment(trip.id),
      ]);
      setViolations(violationsData.violations);
      
      // åŠ è½½å•é¡¹é£é™©ï¼ˆæ‰¹é‡æˆ–æŒ‰éœ€ï¼‰
      const risks: RiskMap = {};
      for (const day of trip.TripDay || []) {
        for (const item of day.items || []) {
          const risk = await tripsApi.getItemRisk(trip.id, item.id);
          risks[item.id] = risk;
        }
      }
      setRiskMap(risks);
    } catch (err) {
      console.error('Failed to load risk data:', err);
    } finally {
      setRiskLoading(false);
    }
  };
  loadRiskData();
}, [trip?.id]);
```

#### æ­¥éª¤3: NeptuneView - AlternativesSheetï¼ˆæ›¿ä»£æ–¹æ¡ˆæŠ½å±‰ï¼‰

**3.1 æ·»åŠ çŠ¶æ€å’ŒAPIè°ƒç”¨**
```typescript
// åœ¨ NeptuneView ç»„ä»¶ä¸­æ·»åŠ 
const [alternatives, setAlternatives] = useState<{ [itemId: string]: Alternative[] }>({});
const [alternativesLoading, setAlternativesLoading] = useState(false);

// åŠ è½½æ›¿ä»£æ–¹æ¡ˆï¼ˆæŒ‰éœ€åŠ è½½ï¼‰
const loadAlternatives = async (itemId: string) => {
  if (!trip?.id || alternatives[itemId]) return; // å·²åŠ è½½åˆ™è·³è¿‡
  try {
    setAlternativesLoading(true);
    const data = await tripsApi.getAlternatives(trip.id, itemId);
    setAlternatives(prev => ({ ...prev, [itemId]: data.alternatives }));
  } catch (err) {
    console.error('Failed to load alternatives:', err);
  } finally {
    setAlternativesLoading(false);
  }
};

// åœ¨æ‰“å¼€æŠ½å±‰æ—¶åŠ è½½
useEffect(() => {
  if (alternativesSheetOpen && selectedItem?.id) {
    loadAlternatives(selectedItem.id);
  }
}, [alternativesSheetOpen, selectedItem?.id]);
```

**3.2 å®ç°åº”ç”¨æ›¿ä»£æ–¹æ¡ˆåŠŸèƒ½**
```typescript
const handleApplyAlternative = async (itemId: string, alternative: Alternative) => {
  if (!trip?.id) return;
  try {
    await tripsApi.replaceItem(trip.id, itemId, {
      reason: 'user_preference',
      placeId: alternative.placeId,
      constraints: {},
    });
    setAlternativesSheetOpen(false);
    // é‡æ–°åŠ è½½è¡Œç¨‹æ•°æ®
  } catch (err) {
    console.error('Failed to apply alternative:', err);
    // æ˜¾ç¤ºé”™è¯¯æç¤º
  }
};
```

### API æ¥å£éœ€æ±‚æ±‡æ€»

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | ç”¨é€” | ä¼˜å…ˆçº§ |
|------|------|------|------|--------|
| è·å–ä¿®å¤å»ºè®® | GET | `/trips/:id/repairs` | NeptuneView - PatchSheet | ğŸ”´ é«˜ |
| åº”ç”¨ä¿®å¤ | POST | `/trips/:id/repairs/:repairId/apply` | NeptuneView - PatchSheet | ğŸ”´ é«˜ |
| è·å–è¿è§„åˆ—è¡¨ | GET | `/trips/:id/violations` | AbuView - EvidenceSheet | ğŸ”´ é«˜ |
| è·å–å•é¡¹é£é™© | GET | `/trips/:id/items/:itemId/risk` | AbuView - EvidenceSheet | ğŸ”´ é«˜ |
| è·å–æ›¿ä»£æ–¹æ¡ˆ | GET | `/trips/:id/items/:itemId/alternatives` | NeptuneView - AlternativesSheet | ğŸŸ¡ ä¸­ |

---

## ğŸ“Š ç»Ÿè®¡æ€»ç»“

### å¼¹çª—æ€»æ•°
- **å·²å¯¹æ¥å¼¹çª—**: 7ä¸ªï¼ˆåŠŸèƒ½å®Œæ•´ï¼‰
- **ç¡¬ç¼–ç å¼¹çª—**: 3ä¸ªï¼ˆéœ€è¦å¯¹æ¥ï¼‰
- **æ€»è®¡**: 10ä¸ªå¼¹çª—

### ç¡¬ç¼–ç æ•°æ®ç»Ÿè®¡
- **AbuView - EvidenceSheet**: 2ä¸ªç¡¬ç¼–ç æ•°æ®æºï¼ˆriskMap, violationsï¼‰
- **NeptuneView - AlternativesSheet**: 1ä¸ªç¡¬ç¼–ç æ•°æ®æºï¼ˆalternativesï¼‰
- **NeptuneView - PatchSheet**: 1ä¸ªç¡¬ç¼–ç æ•°æ®æºï¼ˆrepairsï¼‰
- **æ€»è®¡**: 4ä¸ªç¡¬ç¼–ç æ•°æ®æº

### æ¥å£éœ€æ±‚ç»Ÿè®¡
- **é«˜ä¼˜å…ˆçº§æ¥å£**: 4ä¸ª
- **ä¸­ä¼˜å…ˆçº§æ¥å£**: 1ä¸ª
- **æ€»è®¡**: 5ä¸ªæ¥å£éœ€è¦å¯¹æ¥

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-01-XX  
**ç»´æŠ¤è€…**: å‰ç«¯å›¢é˜Ÿ

