# 规划工作台三视图实现 - 总结报告

**日期**: 2025-01-01  
**功能**: 规划工作台（Plan Studio）三视图模式实现（Abu / Dr.Dre / Neptune）

---

## 一、实现概述

### 1.1 已完成的功能

1. **统一右侧栏组件** (`PlanStudioSidebar`)
   - 位置: `src/components/plan-studio/PlanStudioSidebar.tsx`
   - 功能: 根据三种视图模式显示不同的策略预览、提示卡和操作按钮

2. **页面布局调整**
   - 位置: `src/pages/plan-studio/index.tsx`
   - 变更: 添加左右分栏布局（主内容区 8/12，右侧栏 4/12）
   - 变更: IntentTab 移除内部右侧栏，统一使用全局右侧栏

3. **视图切换策略**
   - 默认进入 Abu 视图
   - 点击 `optimize` Tab 自动切换到 Dr.Dre 视图

---

## 二、硬编码数据清单

### 2.1 PlanStudioSidebar 组件中的硬编码

#### 2.1.1 Abu 视图 - 门控状态数据

**位置**: `src/components/plan-studio/PlanStudioSidebar.tsx` (第18-24行)

```typescript
// ❌ 硬编码
const abuGatingStatus: 'ALLOW' | 'WARN' | 'BLOCK' = 'WARN';
const abuViolations = {
  hard: 3,  // 硬红线数量
  soft: 2,  // 软红线/警告数量
};
```

**待对接API**:
- `GET /trips/{tripId}/gating-status` - 获取门控状态
- `GET /trips/{tripId}/violations` - 获取红线/警告列表
- 返回格式建议:
  ```typescript
  {
    status: 'ALLOW' | 'WARN' | 'BLOCK',
    violations: {
      hard: number,
      soft: number,
      list: Array<{
        level: 'HARD' | 'SOFT',
        code: string,
        title: string,
        reason: string,
        affectedItemIds: string[],
      }>,
    },
  }
  ```

#### 2.1.2 Dr.Dre 视图 - 指标数据

**位置**: `src/components/plan-studio/PlanStudioSidebar.tsx` (第26-37行)

```typescript
// ❌ 硬编码
const dreMetrics = {
  timeTotal: 1440,        // 总耗时（分钟）
  bufferTotal: 180,       // 总缓冲（分钟）
  fatigueScore: 65,       // 疲劳指数（0-100）
  ascent: 1200,           // 总爬升（米）
  costEstimate: 5000,     // 预计花费
  weights: {
    comfort: 40,
    experience: 30,
    cost: 30,
  },
};
```

**待对接API**:
- `GET /trips/{tripId}/metrics` - 获取行程指标
- `GET /trips/{tripId}/weights` - 获取当前权重配置
- 返回格式建议:
  ```typescript
  {
    metrics: {
      timeTotal: number,
      bufferTotal: number,
      fatigueScore: number,
      ascent: number,
      costEstimate: number,
      distanceTotal: number,
    },
    weights: {
      comfort: number,
      experience: number,
      cost: number,
      time?: number,
    },
  }
  ```

#### 2.1.3 Neptune 视图 - 修复进度数据

**位置**: `src/components/plan-studio/PlanStudioSidebar.tsx` (第31-38行)

```typescript
// ❌ 硬编码
const neptuneFixes = {
  total: 5,              // 发现问题总数
  applied: 2,            // 已修复数量
  minimalChanges: {
    replacePoints: 1,    // 需要替换的点数
    moveTimeSlots: 2,    // 需要移动的时段数
  },
};
```

**待对接API**:
- `GET /trips/{tripId}/repairs` - 获取修复队列
- `GET /trips/{tripId}/repair-progress` - 获取修复进度
- 返回格式建议:
  ```typescript
  {
    total: number,
    applied: number,
    pending: number,
    minimalChanges: {
      replacePoints: number,
      moveTimeSlots: number,
      addBuffers?: number,
      skipItems?: number,
    },
  }
  ```

#### 2.1.4 提示卡数据（所有视图）

**位置**: `src/components/plan-studio/PlanStudioSidebar.tsx`

**Abu 视图提示卡** (第119-155行):
```typescript
// ❌ 硬编码 - 风险提示列表
// 包含: 缺失必选点、缓冲时间不足、日照窗口风险等
```

**待对接API**:
- `GET /trips/{tripId}/risk-alerts` - 获取风险提示（Abu视图）
- 返回格式建议:
  ```typescript
  Array<{
    type: 'MISSING_REQUIRED' | 'BUFFER_INSUFFICIENT' | 'SUNLIGHT_WINDOW' | 'EQUIPMENT' | 'CLOSURE',
    severity: 'HIGH' | 'MEDIUM' | 'LOW',
    title: string,
    description: string,
    affectedDays?: string[],
  }>
  ```

**Dr.Dre 视图提示卡** (第158-189行):
```typescript
// ❌ 硬编码 - 指标异常列表
// 包含: 疲劳峰值过高、缓冲不足、成本超出预算等
```

**待对接API**:
- `GET /trips/{tripId}/metric-anomalies` - 获取指标异常（Dr.Dre视图）
- 返回格式建议:
  ```typescript
  Array<{
    type: 'FATIGUE_PEAK' | 'BUFFER_INSUFFICIENT' | 'COST_OVER' | 'TIME_CONFLICT',
    severity: 'HIGH' | 'MEDIUM' | 'LOW',
    title: string,
    description: string,
    currentValue: number,
    threshold: number,
    affectedDays?: string[],
  }>
  ```

**Neptune 视图提示卡** (第192-223行):
```typescript
// ❌ 硬编码 - 修复建议列表
// 包含: 替换建议、时间调整、替代路线等
```

**待对接API**:
- `GET /trips/{tripId}/repair-suggestions` - 获取修复建议（Neptune视图）
- 返回格式建议:
  ```typescript
  Array<{
    type: 'REPLACE' | 'RESCHEDULE' | 'ADD_BUFFER' | 'ALTERNATIVE_ROUTE',
    severity: 'CRITICAL' | 'WARNING' | 'INFO',
    title: string,
    description: string,
    targetItemId?: string,
    alternatives?: Array<{
      placeId: number,
      placeName: string,
      reason: string,
    }>,
  }>
  ```

#### 2.1.5 底部按钮操作

**位置**: `src/components/plan-studio/PlanStudioSidebar.tsx` (第226-251行)

```typescript
// ❌ 硬编码 - 按钮仅显示，未实现实际API调用
// Abu: "Ask Agent to refine constraints"
// Dr.Dre: "Ask Agent to optimize with weights"
// Neptune: "Ask Agent to apply minimal fixes"
```

**待对接API**:
- `POST /agent/route-and-run` - 已存在，需要根据视图模式传递不同的message
- 建议: 在各个按钮的onClick中调用agent API，传递对应的prompt

---

### 2.2 视图切换逻辑中的硬编码

**位置**: `src/pages/plan-studio/index.tsx` (第40行)

```typescript
// ⚠️ 部分硬编码 - 视图切换逻辑
if (value === 'optimize' && personaMode !== 'dre') {
  setPersonaMode('dre');
}
```

**待完善**:
- 检测到不可执行（硬门控失败）时自动切换到Neptune视图
- 需要从API获取门控状态: `GET /trips/{tripId}/gating-status`
- 如果 `status === 'BLOCK'`，应该提示并建议切换到Neptune视图

---

## 三、数据流设计建议

### 3.1 数据获取时机

1. **初始化时**:
   - 进入Plan Studio时，根据当前`personaMode`加载对应数据
   - 使用 `useEffect` 监听 `tripId` 和 `personaMode` 的变化

2. **视图切换时**:
   - 切换视图模式时，重新加载对应视图的数据
   - 考虑缓存机制，避免重复请求

3. **数据更新时**:
   - 在Tab中进行操作后（如IntentTab保存约束），刷新右侧栏数据
   - 使用状态管理或事件机制通知右侧栏更新

### 3.2 推荐的数据获取方式

```typescript
// 示例: 在PlanStudioSidebar中使用
useEffect(() => {
  if (!tripId) return;
  
  const loadData = async () => {
    switch (personaMode) {
      case 'abu':
        const gatingData = await tripsApi.getGatingStatus(tripId);
        // 更新状态
        break;
      case 'dre':
        const metricsData = await tripsApi.getMetrics(tripId);
        // 更新状态
        break;
      case 'neptune':
        const repairsData = await tripsApi.getRepairs(tripId);
        // 更新状态
        break;
    }
  };
  
  loadData();
}, [tripId, personaMode]);
```

---

## 四、待对接API清单

### 4.1 必需API（核心功能）

| API路径 | 方法 | 视图 | 用途 | 优先级 |
|---------|------|------|------|--------|
| `/trips/{tripId}/gating-status` | GET | Abu | 获取门控状态 | P0 |
| `/trips/{tripId}/violations` | GET | Abu | 获取红线/警告列表 | P0 |
| `/trips/{tripId}/risk-alerts` | GET | Abu | 获取风险提示 | P0 |
| `/trips/{tripId}/metrics` | GET | Dr.Dre | 获取行程指标 | P0 |
| `/trips/{tripId}/weights` | GET | Dr.Dre | 获取权重配置 | P0 |
| `/trips/{tripId}/metric-anomalies` | GET | Dr.Dre | 获取指标异常 | P0 |
| `/trips/{tripId}/repairs` | GET | Neptune | 获取修复队列 | P0 |
| `/trips/{tripId}/repair-progress` | GET | Neptune | 获取修复进度 | P0 |
| `/trips/{tripId}/repair-suggestions` | GET | Neptune | 获取修复建议 | P0 |

### 4.2 可选API（增强功能）

| API路径 | 方法 | 视图 | 用途 | 优先级 |
|---------|------|------|------|--------|
| `/trips/{tripId}/weights` | PUT | Dr.Dre | 调整权重配置 | P1 |
| `/trips/{tripId}/repairs/{repairId}/apply` | POST | Neptune | 应用单个修复 | P1 |
| `/trips/{tripId}/repairs/apply-all` | POST | Neptune | 应用所有修复 | P1 |
| `/trips/{tripId}/evidence` | GET | Abu | 获取证据详情（点击"查看证据"按钮） | P2 |

---

## 五、注意事项

### 5.1 类型定义

建议在 `src/types/trip.ts` 或新建 `src/types/plan-studio.ts` 中定义相关类型：

```typescript
// 示例类型定义
export interface GatingStatus {
  status: 'ALLOW' | 'WARN' | 'BLOCK';
  violations: {
    hard: number;
    soft: number;
    list: Violation[];
  };
}

export interface TripMetrics {
  timeTotal: number;
  bufferTotal: number;
  fatigueScore: number;
  ascent: number;
  costEstimate: number;
  distanceTotal: number;
}

export interface RepairProgress {
  total: number;
  applied: number;
  pending: number;
  minimalChanges: {
    replacePoints: number;
    moveTimeSlots: number;
  };
}
```

### 5.2 错误处理

- 所有API调用需要添加错误处理
- 数据加载失败时显示友好的错误提示
- 考虑使用 loading 状态，避免UI闪烁

### 5.3 性能优化

- 使用 `useMemo` 缓存计算结果
- 使用 `useCallback` 优化事件处理函数
- 考虑使用 `React Query` 或 `SWR` 管理API状态和缓存

---

## 六、文件变更清单

### 6.1 新增文件

- `src/components/plan-studio/PlanStudioSidebar.tsx` - 右侧栏组件

### 6.2 修改文件

- `src/pages/plan-studio/index.tsx` - 添加右侧栏布局和视图切换逻辑
- `src/pages/plan-studio/IntentTab.tsx` - 移除内部右侧栏，改为全宽布局

### 6.3 待修改文件（对接API时需要）

- `src/api/trips.ts` - 添加新的API方法
- `src/types/trip.ts` 或 `src/types/plan-studio.ts` - 添加类型定义

---

## 七、测试建议

### 7.1 功能测试

- [ ] 切换视图模式，验证右侧栏内容正确切换
- [ ] 点击 optimize Tab，验证自动切换到 Dr.Dre 视图
- [ ] 验证各视图的按钮点击事件（接入API后）

### 7.2 数据测试

- [ ] 验证API返回数据正确映射到UI组件
- [ ] 验证空数据状态显示
- [ ] 验证错误状态显示

### 7.3 边界情况

- [ ] tripId 为空时的处理
- [ ] API请求失败时的错误处理
- [ ] 数据加载中的loading状态

---

## 八、后续工作建议

1. **优先级P0**: 对接核心API，确保三个视图的基础功能可用
2. **优先级P1**: 实现按钮的API调用，完善交互流程
3. **优先级P2**: 优化用户体验（loading状态、错误处理、数据缓存）
4. **优先级P3**: 实现其他Tab在不同视图下的差异化显示

---

**报告生成时间**: 2025-01-01  
**报告版本**: 1.0

