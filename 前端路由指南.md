# 前端路由指南

**基于104个已对接接口的路由决策手册**

本文档为前端开发者提供清晰的接口调用策略：何时用 Agent，何时直连业务接口。

**最后更新**: 2025-01-01  
**接口总数**: 104 个（全部已对接）

---

## 核心原则

```
聊天/自然语言  →  统一走 /agent/route_and_run（让 Router 决定 System1/2）
界面按钮/确定性操作  →  直连业务接口（更快、更稳定、可控）
```

---

## 目录

1. [两条入口策略](#1-两条入口策略)
2. [场景 → 推荐接口（30个常用场景）](#2-场景--推荐接口30个常用场景)
3. [三条常见用户旅程的调用顺序](#3-三条常见用户旅程的调用顺序)
4. [快速决策：前端如何选接口](#4-快速决策前端如何选接口)
5. [黄金组合推荐](#5-黄金组合推荐)

---

## 1. 两条入口策略

### A. 统一入口（自然语言/聊天）

#### 适用场景
- ✅ 用户在输入框问一句话：查询/解释/规划/修复/建议
- ✅ 你不想在前端判断是 System1 还是 System2

#### 用哪个接口
**✅ POST `/agent/route_and_run`**

#### 你从返回里怎么处理
| routeType | 处理方式 |
|-----------|---------|
| `SYSTEM1_API` | 展示 `answer` + `data`（不改计划） |
| `SYSTEM1_RAG` | 展示 `answer` + `data`（不改计划） |
| `SYSTEM2_ORCHESTRATOR` | 展示 `plan`（或调整结果）+ `decisionLog` + `persona-alerts`（如果有） |

---

### B. 直连业务接口（页面按钮/明确动作）

#### 适用场景
- ✅ 用户点按钮：创建/保存/撤销/重做/收藏/点赞/分享/导出/离线包
- ✅ UI 操作已经是结构化的，不需要 NLP

#### 用哪个接口
直接使用 Trips/Places/Decision/Policy 等模块接口（见下文场景→接口表）

---

## 2. 场景 → 推荐接口（30个常用场景）

### 2.1 认证/用户态

| 场景 | 用哪个接口 | 备注 |
|------|-----------|------|
| 发送邮箱验证码 | POST `/auth/email/send-code` | - |
| 邮箱注册 | POST `/auth/email/register` | - |
| 邮箱登录 | POST `/auth/email/login` | - |
| Google 登录（授权码） | POST `/auth/google/code` | - |
| Google 登录（ID Token） | POST `/auth/google/id-token` | - |
| 刷新 token | POST `/auth/refresh` | - |
| 登出 | POST `/auth/logout` | - |
| 获取用户信息 | GET `/users/profile` | - |
| 更新用户偏好 | PUT `/users/profile` | - |

---

### 2.2 行程"列表/详情/状态"页（读多写少）

| 场景 | 用哪个接口 | 备注 |
|------|-----------|------|
| 行程列表 | GET `/trips` | 首页/我的行程 |
| 行程详情 | GET `/trips/:id` | 详情页主数据 |
| 行程状态（世界模型/规划状态） | GET `/trips/:id/state` | 适合做顶部状态条 |
| 某天 Schedule 读取 | GET `/trips/:id/schedule` | 日程编辑页 |
| 某天 Schedule 保存 | PUT `/trips/:id/schedule` | 日程编辑页 |

---

### 2.3 创建行程（3种入口）

| 场景 | 推荐接口 | 何时用 |
|------|----------|--------|
| 表单创建 | POST `/trips` | 已有结构化参数（目的地/天数/日期等） |
| 自然语言创建 | POST `/trips/from-natural-language` | 希望直接生成 trip 基础信息（如"帮我建一个冰岛10天行程"） |
| 自然语言创建 + 直接规划 | ✅ POST `/agent/route_and_run` | 创建 + 直接规划可执行行程（Agent 会走 System2） |
| 只做 NLP 参数解析 | POST `/llm/natural-language-to-params` | 想前端先展示参数确认再创建 |

**实战建议**：
- "创建 trip（目的地/天数）"用 `/trips/from-natural-language` 很合适
- "创建 + 直接规划可执行行程"就让 Agent 走 System2（`/agent/route_and_run`）

---

### 2.4 规划一个新行程（生成可执行计划）

| 场景 | 推荐接口 | 备注 |
|------|----------|------|
| 用户一句话要"规划" | ✅ POST `/agent/route_and_run` | Router 会走 System2 |
| UI 里点"生成计划"按钮（结构化） | POST `/itinerary-optimization/optimize` + 决策链 | 更像"优化算法"，不是完整三人格规划入口 |

**显式三人格链的直连接口**（如果你要在 UI 做"分步决策"）：
- POST `/decision/validate-safety`（Abu - 安全校验）
- POST `/decision/adjust-pacing`（Dr.Dre - 节奏调整）
- POST `/decision/replace-nodes`（Neptune - 节点替换）

按这三个串起来调用（见第 3 节流程）。

---

### 2.5 修改/修复行程（会产生 diff）

| 场景 | 推荐接口 | 备注 |
|------|----------|------|
| 用户一句话"第5天太累，帮我调一下" | ✅ POST `/agent/route_and_run` | System2 |
| UI 按钮"智能调整" | ✅ POST `/trips/:id/adjust` | 这是最像"一键修复"的业务口 |
| 把调整拆成"节奏/替换/安全校验" | POST `/decision/validate-safety` → POST `/decision/adjust-pacing` → POST `/decision/replace-nodes` | 强可控，可做可视化 diff |

---

### 2.6 撤销/重做（编辑器必备）

| 场景 | 接口 |
|------|------|
| 看操作历史 | GET `/trips/:id/actions` |
| 撤销 | POST `/trips/:id/actions/undo` |
| 重做 | POST `/trips/:id/actions/redo` |

---

### 2.7 分享/导入

| 场景 | 接口 |
|------|------|
| 生成分享链接 | POST `/trips/:id/share` |
| 打开分享页 | GET `/trips/shared/:shareToken` |
| 导入到我的行程 | POST `/trips/shared/:shareToken/import` |

---

### 2.8 离线包

| 场景 | 接口 |
|------|------|
| 生成离线包 | GET `/trips/:id/offline-pack` |
| 查询离线包状态 | GET `/trips/:id/offline-status` |
| 离线修改同步 | POST `/trips/:id/offline-sync` |

---

### 2.9 路线问答 / 解释为什么（RAG）

| 场景 | 推荐接口 | 备注 |
|------|----------|------|
| 用户问"为什么选择这条路线？" | ✅ POST `/agent/route_and_run`（会走 System1_RAG） | 最省事 |
| 做一个"知识检索面板/证据列表" | GET `/rag/retrieve` | 只检索，不生成回答 |

---

### 2.10 地点/POI 搜索与推荐

| 场景 | 接口 |
|------|------|
| 关键词搜索 | GET `/places/search` |
| 语义搜索 | GET `/places/search/semantic` |
| 自动补全 | GET `/places/autocomplete` |
| 附近 | GET `/places/nearby` |
| 附近餐厅 | GET `/places/nearby/restaurants` |
| 推荐列表 | GET `/places/recommendations` |
| 批量取详情 | POST `/places/batch` |
| 计算路线难度 | POST `/places/route-difficulty` |

---

### 2.11 RouteDirection（路线母本卡片）

| 场景 | 接口 |
|------|------|
| 卡片列表 | GET `/route-directions/cards` |
| 详情（通过ID） | GET `/route-directions/:id` |
| 详情（通过查询参数，支持id/uuid） | GET `/route-directions/details` |
| 交互信息 | GET `/route-directions/interactions` |

---

### 2.12 What-if（候选方案/评估/应用）

| 场景 | 接口 | 何时用 |
|------|------|--------|
| 只生成候选 | POST `/planning-policy/what-if/generate-candidates` | 让用户先选 |
| 评估候选 | POST `/planning-policy/what-if/evaluate-candidates` | 做对比 |
| 一步到位评估 | POST `/planning-policy/what-if/evaluate` | 省事 |
| 应用候选方案 | POST `/planning-policy/what-if/apply` | 会改计划/写库 |
| 一键复评 | POST `/planning-policy/what-if/re-evaluate` | 改完再验 |

---

### 2.13 决策看板（人格提醒/透明日志）

| 场景 | 接口 |
|------|------|
| 三人格提醒列表（前端做 banner/卡片） | GET `/trips/:id/persona-alerts` |
| 决策透明日志（审计/回放） | GET `/trips/:id/decision-log` |

---

### 2.14 其他常用场景

| 场景 | 接口 | 备注 |
|------|------|------|
| 交通路线规划 | POST `/transport/plan` | - |
| 行程项 CRUD | POST/GET/PATCH/DELETE `/itinerary-items` | - |
| 收藏/取消收藏行程 | POST/DELETE `/trips/:id/collect` | - |
| 点赞/取消点赞 | POST/DELETE `/trips/:id/like` | - |
| 协作者管理 | POST/GET/DELETE `/trips/:id/collaborators` | - |
| 行程复盘报告 | GET `/trips/:id/recap` | - |
| 导出复盘报告 | GET `/trips/:id/recap/export` | - |
| 3D轨迹视频数据 | GET `/trips/:id/trail-video-data` | - |
| 预算摘要 | GET `/trips/:id/budget/summary` | - |
| 预算预警 | GET `/trips/:id/budget/alert` | - |
| 预算优化建议 | GET `/trips/:id/budget/optimization` | - |
| 预算执行分析报告 | GET `/trips/:id/budget/report` | - |
| 紧急求救 | POST `/trips/:id/emergency/sos` | - |
| 求救记录 | GET `/trips/:id/emergency/history` | - |
| 酒店推荐 | GET `/places/hotels/recommend` | - |
| 酒店选项（便捷/舒适/经济） | GET `/places/hotels/options` | - |
| 国家列表 | GET `/countries` | - |
| 国家货币策略 | GET `/countries/:countryCode/currency-strategy` | - |
| 国家Pack配置 | GET `/countries/:countryCode/pack` | - |
| 国家支付信息 | GET `/countries/:countryCode/payment-info` | - |
| 国家地形适配建议 | GET `/countries/:countryCode/terrain-advice` | - |
| 系统状态 | GET `/system/status` | - |

---

## 3. 三条常见用户旅程的调用顺序

### 旅程 1：用户一句话规划行程（最推荐）⭐

**调用顺序**：
1. POST `/agent/route_and_run`
   ```json
   {
     "inputText": "帮我规划冰岛10天行程",
     "context": {
       "tripId": "xxx" // 可选，如果已有 tripId
     }
   }
   ```

2. 如果返回 `routeType === "SYSTEM2_ORCHESTRATOR"`：
   - 渲染 `plan`（或调整结果）
   - 渲染 `decisionLog`
   - 再拉一次看板：GET `/trips/:id/persona-alerts`（可选）

**✅ 优点**：前端不做判断，系统自动走 System2

---

### 旅程 2：用户修改后"一键智能调整"（现在已经有）⭐

**调用顺序**：
1. 用户手动改 schedule：PUT `/trips/:id/schedule`
2. 点"一键智能调整"：POST `/trips/:id/adjust`
3. 拉最新状态/日志：
   - GET `/trips/:id/state`
   - GET `/trips/:id/decision-log`

**✅ 优点**：确定性强、体验快  
**⚠️ 注意**：如果你希望"解释为什么这样调"，用 `decision-log` 或再走一次 agent（解释型）

---

### 旅程 3：三人格"可视化拆分"（适合做高级模式）⭐

**调用顺序**：
1. （可选）先做安全校验：POST `/decision/validate-safety`
2. 节奏调整：POST `/decision/adjust-pacing`
3. 空间替换：POST `/decision/replace-nodes`
4. 最终写入/呈现：根据后端实现（通常是保存 schedule 或触发 adjust/apply）
5. 拉决策日志：GET `/trips/:id/decision-log` 做回放

**✅ 优点**：每一步可控、可解释、可对比 diff  
**⚠️ 注意**：需要在前端管理"中间态 plan/diff"（适合 Pro 模式）

---

## 4. 快速决策：前端如何选接口

### 如果是聊天输入框（用户打字）

**永远先用**：**POST `/agent/route_and_run`**

- 规划/修复 → System2
- 解释/问答 → System1_RAG
- 查数据 → System1_API

---

### 如果是 UI 按钮（用户点）

**按功能直连**：

| 功能模块 | 接口 |
|---------|------|
| 编辑 schedule | PUT `/trips/:id/schedule` |
| 一键调优 | POST `/trips/:id/adjust` |
| What-if 面板 | `/planning-policy/what-if/*` |
| 人格看板 | GET `/trips/:id/persona-alerts`、GET `/trips/:id/decision-log` |
| 地点搜索/附近 | `/places/*` |
| 交通 | POST `/transport/plan` |
| 离线/分享/撤销重做 | `/trips/*` 对应接口 |
| 创建行程（表单） | POST `/trips` |
| 创建行程（自然语言） | POST `/trips/from-natural-language` |

---

## 5. 黄金组合推荐

### 主入口
- **POST `/agent/route_and_run`** - 统一自然语言入口

### 行程编辑器底座
- **GET/PUT `/trips/:id/schedule`** - 日程读写
- **POST `/trips/:id/actions/undo` / POST `/trips/:id/actions/redo`** - 撤销/重做

### 智能修复
- **POST `/trips/:id/adjust`** - 一键智能调整（用户体验最佳）

### 高级推演
- **`/planning-policy/what-if/*`** - 候选方案生成/评估/应用

### 决策透明
- **GET `/trips/:id/decision-log`** - 决策记录
- **GET `/trips/:id/persona-alerts`** - 三人格提醒

### POI/酒店/路线数据
- **`/places/*`** - 地点搜索/推荐
- **`/places/hotels/*`** - 酒店推荐
- **`/trails/*`** - 路线数据
- **`/route-directions/*`** - 路线方向卡片

---

## 附录：接口文件索引

| 模块 | API 文件路径 |
|------|-------------|
| 认证授权 | `src/api/auth.ts` |
| 行程管理 | `src/api/trips.ts` |
| 地点 | `src/api/places.ts` |
| 路线方向 | `src/api/route-directions.ts` |
| 规划策略 | `src/api/planning-policy.ts` |
| 决策引擎 | `src/api/decision.ts` |
| 行程优化 | `src/api/itinerary-optimization.ts` |
| 交通规划 | `src/api/transport.ts` |
| 用户 | `src/api/user.ts` |
| 系统状态 | `src/api/system.ts` |
| 智能体 | `src/api/agent.ts` |
| RAG 文档检索 | `src/api/rag.ts` |
| 酒店 | `src/api/hotels.ts` |
| 路线 | `src/api/trails.ts` |
| 国家档案 | `src/api/countries.ts` |

---

## 更新日志

- 2025-01-01: 初始版本，基于104个已对接接口整理

