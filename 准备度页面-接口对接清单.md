# å‡†å¤‡åº¦é¡µé¢ - æ¥å£å¯¹æ¥æ¸…å•

## æ¦‚è¿°

å‡†å¤‡åº¦é¡µé¢ (`src/pages/readiness/index.tsx`) å¯¹æ¥äº†å¤šä¸ª API æ¥å£ï¼Œé‡‡ç”¨ä¸»æ¥å£ + å¤‡ç”¨æ–¹æ¡ˆçš„ç­–ç•¥ï¼Œç¡®ä¿å³ä½¿æŸäº›æ¥å£å¤±è´¥ä¹Ÿèƒ½æ­£å¸¸æ˜¾ç¤ºæ•°æ®ã€‚

---

## ğŸ“‹ æ¥å£åˆ—è¡¨

### 1. è¡Œç¨‹ç›¸å…³æ¥å£

#### 1.1 è·å–è¡Œç¨‹åˆ—è¡¨
- **æ¥å£**: `GET /trips`
- **è°ƒç”¨ä½ç½®**: `loadRecentTrip()` å‡½æ•°ï¼ˆç¬¬75è¡Œï¼‰
- **ç”¨é€”**: å½“ URL ä¸­æ²¡æœ‰ tripId æ—¶ï¼Œè·å–æœ€è¿‘çš„è¡Œç¨‹
- **API æ–¹æ³•**: `tripsApi.getAll()`
- **ä¼˜å…ˆçº§**: è¾…åŠ©åŠŸèƒ½

#### 1.2 è·å–è¡Œç¨‹è¯¦æƒ…
- **æ¥å£**: `GET /trips/:id`
- **è°ƒç”¨ä½ç½®**: `loadData()` å‡½æ•°ï¼ˆç¬¬153è¡Œï¼‰
- **ç”¨é€”**: è·å–è¡Œç¨‹çš„åŸºæœ¬ä¿¡æ¯ï¼ˆç›®çš„åœ°ã€æ—¥æœŸç­‰ï¼‰
- **API æ–¹æ³•**: `tripsApi.getById(tripId)`
- **ä¼˜å…ˆçº§**: âœ… **å¿…éœ€**ï¼ˆå¹¶è¡ŒåŠ è½½ï¼‰

---

### 2. å‡†å¤‡åº¦æ ¸å¿ƒæ¥å£ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰

#### 2.1 è·å–è¡Œç¨‹å‡†å¤‡åº¦æ•°æ®ï¼ˆä¸»æ¥å£ï¼‰â­
- **æ¥å£**: `GET /readiness/trip/:tripId`
- **è°ƒç”¨ä½ç½®**: `loadData()` å‡½æ•°ï¼ˆç¬¬154è¡Œï¼‰
- **ç”¨é€”**: æ ¹æ®è¡Œç¨‹IDè‡ªåŠ¨è·å–è¡Œç¨‹ä¿¡æ¯å¹¶æ£€æŸ¥å‡†å¤‡åº¦
- **API æ–¹æ³•**: `readinessApi.getTripReadiness(tripId)`
- **è¿”å›æ ¼å¼**: `ReadinessCheckResult`
- **ä¼˜å…ˆçº§**: âœ… **æœ€é«˜ä¼˜å…ˆçº§**ï¼ˆä¸»æ¥å£ï¼‰
- **å¤‡ç”¨æ–¹æ¡ˆ**: å¦‚æœå¤±è´¥ï¼Œä¼šfallbackåˆ°å…¶ä»–æ¥å£
- **çŠ¶æ€**: âœ… å·²å¯¹æ¥ï¼Œè¿”å›ç±»å‹å·²æ›´æ–°ä¸º `ReadinessCheckResult`

#### 2.2 æ£€æŸ¥æ—…è¡Œå‡†å¤‡åº¦ï¼ˆå¤‡ç”¨æ–¹æ¡ˆ1ï¼‰
- **æ¥å£**: `POST /readiness/check`
- **è°ƒç”¨ä½ç½®**: `loadData()` å‡½æ•°ï¼ˆç¬¬187è¡Œï¼‰
- **ç”¨é€”**: å½“ä¸»æ¥å£å¤±è´¥æ—¶ï¼Œä½¿ç”¨è¡Œç¨‹æ•°æ®æ„å»ºè¯·æ±‚å‚æ•°æ£€æŸ¥å‡†å¤‡åº¦
- **API æ–¹æ³•**: `readinessApi.check(buildCheckReadinessDto(tripData))`
- **è¿”å›æ ¼å¼**: `ReadinessCheckResult`
- **ä¼˜å…ˆçº§**: ğŸ”„ **å¤‡ç”¨æ–¹æ¡ˆ1**
- **è§¦å‘æ¡ä»¶**: `getTripReadiness` å¤±è´¥æˆ–è¿”å› null

#### 2.3 è·å–ä¸ªæ€§åŒ–å‡†å¤‡æ¸…å•ï¼ˆå¤‡ç”¨æ–¹æ¡ˆ2-1ï¼‰
- **æ¥å£**: `GET /readiness/personalized-checklist?tripId=xxx`
- **è°ƒç”¨ä½ç½®**: `loadData()` å‡½æ•°ï¼ˆç¬¬200è¡Œï¼‰
- **ç”¨é€”**: å½“ä¸»æ¥å£å’Œ check æ¥å£éƒ½å¤±è´¥æ—¶ï¼Œè·å–ä¸ªæ€§åŒ–çš„å‡†å¤‡æ¸…å•
- **API æ–¹æ³•**: `readinessApi.getPersonalizedChecklist(tripId)`
- **è¿”å›æ ¼å¼**: `PersonalizedChecklistResponse`
- **ä¼˜å…ˆçº§**: ğŸ”„ **å¤‡ç”¨æ–¹æ¡ˆ2-1**
- **è§¦å‘æ¡ä»¶**: `getTripReadiness` å’Œ `check` éƒ½å¤±è´¥

#### 2.4 è·å–é£é™©é¢„è­¦ï¼ˆå¤‡ç”¨æ–¹æ¡ˆ2-2ï¼‰
- **æ¥å£**: `GET /readiness/risk-warnings?tripId=xxx`
- **è°ƒç”¨ä½ç½®**: `loadData()` å‡½æ•°ï¼ˆç¬¬204è¡Œï¼‰
- **ç”¨é€”**: å½“ä¸»æ¥å£å’Œ check æ¥å£éƒ½å¤±è´¥æ—¶ï¼Œè·å–é£é™©é¢„è­¦ä¿¡æ¯
- **API æ–¹æ³•**: `readinessApi.getRiskWarnings(tripId)`
- **è¿”å›æ ¼å¼**: `RiskWarningsResponse`
- **ä¼˜å…ˆçº§**: ğŸ”„ **å¤‡ç”¨æ–¹æ¡ˆ2-2**
- **è§¦å‘æ¡ä»¶**: `getTripReadiness` å’Œ `check` éƒ½å¤±è´¥

---

### 3. èƒ½åŠ›åŒ…ç›¸å…³æ¥å£

#### 3.1 è·å–èƒ½åŠ›åŒ…åˆ—è¡¨
- **æ¥å£**: `GET /readiness/capability-packs`
- **è°ƒç”¨ä½ç½®**: `loadCapabilityPacks()` å‡½æ•°ï¼ˆç¬¬129è¡Œï¼‰
- **ç”¨é€”**: è·å–æ‰€æœ‰å¯ç”¨çš„èƒ½åŠ›åŒ…ä¿¡æ¯
- **API æ–¹æ³•**: `readinessApi.getCapabilityPacks()`
- **è¿”å›æ ¼å¼**: `{ packs: CapabilityPack[] }`
- **ä¼˜å…ˆçº§**: ğŸ“Š **è¾…åŠ©åŠŸèƒ½**ï¼ˆä¸é˜»å¡ä¸»æµç¨‹ï¼‰
- **é”™è¯¯å¤„ç†**: å¤±è´¥æ—¶è¿”å› nullï¼Œä¸å½±å“ä¸»æµç¨‹

#### 3.2 è¯„ä¼°èƒ½åŠ›åŒ…
- **æ¥å£**: `POST /readiness/capability-packs/evaluate`
- **è°ƒç”¨ä½ç½®**: `loadCapabilityPacks()` å‡½æ•°ï¼ˆç¬¬130è¡Œï¼‰
- **ç”¨é€”**: è¯„ä¼°å“ªäº›èƒ½åŠ›åŒ…åº”è¯¥è¢«è§¦å‘
- **API æ–¹æ³•**: `readinessApi.evaluateCapabilityPacks(buildCheckReadinessDto(trip))`
- **è¿”å›æ ¼å¼**: `{ total: number; triggered: number; results: CapabilityPackEvaluateResult[] }`
- **ä¼˜å…ˆçº§**: ğŸ“Š **è¾…åŠ©åŠŸèƒ½**ï¼ˆä¸é˜»å¡ä¸»æµç¨‹ï¼‰
- **é”™è¯¯å¤„ç†**: å¤±è´¥æ—¶è¿”å› nullï¼Œä¸å½±å“ä¸»æµç¨‹

---

### 4. ä¿®å¤ç›¸å…³æ¥å£

#### 4.1 è·å–ä¿®å¤æ–¹æ¡ˆ
- **æ¥å£**: `POST /readiness/repair-options`
- **è°ƒç”¨ä½ç½®**: `handleFixBlocker()` å‡½æ•°ï¼ˆç¬¬437è¡Œï¼‰
- **ç”¨é€”**: ç‚¹å‡» Fix æŒ‰é’®æ—¶ï¼Œè·å–æŸä¸ª blocker çš„ä¿®å¤æ–¹æ¡ˆ
- **API æ–¹æ³•**: `readinessApi.getRepairOptions(tripId, blockerId)`
- **è¿”å›æ ¼å¼**: `{ options: RepairOption[] }`
- **è§¦å‘æ–¹å¼**: ç”¨æˆ·ç‚¹å‡» blocker çš„ "Fix" æŒ‰é’®
- **é”™è¯¯å¤„ç†**: å¤±è´¥æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®

#### 4.2 åº”ç”¨ä¿®å¤æ–¹æ¡ˆ
- **æ¥å£**: `POST /readiness/apply-repair`
- **è°ƒç”¨ä½ç½®**: `handleApplyFix()` å‡½æ•°ï¼ˆç¬¬515è¡Œï¼‰
- **ç”¨é€”**: åº”ç”¨é€‰ä¸­çš„ä¿®å¤æ–¹æ¡ˆ
- **API æ–¹æ³•**: `readinessApi.applyRepair(tripId, blockerId, optionId)`
- **è¿”å›æ ¼å¼**: `{ success: boolean; message?: string }`
- **è§¦å‘æ–¹å¼**: ç”¨æˆ·é€‰æ‹©å¹¶ç¡®è®¤åº”ç”¨ä¿®å¤æ–¹æ¡ˆ

#### 4.3 è¿è¡Œè‡ªåŠ¨ä¿®å¤ï¼ˆNeptuneï¼‰
- **æ¥å£**: `POST /readiness/auto-repair`
- **è°ƒç”¨ä½ç½®**: `handleRunRepair()` å‡½æ•°ï¼ˆç¬¬542è¡Œï¼‰
- **ç”¨é€”**: è¿è¡Œ Neptune è‡ªåŠ¨ä¿®å¤æ‰€æœ‰ blocker
- **API æ–¹æ³•**: `readinessApi.autoRepair(tripId)`
- **è¿”å›æ ¼å¼**: `{ success: boolean; message?: string }`
- **è§¦å‘æ–¹å¼**: ç”¨æˆ·ç‚¹å‡» "Run Repair" æŒ‰é’®

---

### 5. è¯æ®åˆ·æ–°æ¥å£

#### 5.1 åˆ·æ–°æ‰€æœ‰è¯æ®
- **æ¥å£**: `POST /readiness/refresh-evidence`
- **è°ƒç”¨ä½ç½®**: `handleRefreshAllEvidence()` å‡½æ•°ï¼ˆç¬¬556è¡Œï¼‰
- **ç”¨é€”**: åˆ·æ–°æ‰€æœ‰è¯æ®æ•°æ®
- **API æ–¹æ³•**: `readinessApi.refreshEvidence(tripId)`
- **è¿”å›æ ¼å¼**: `{ success: boolean }`
- **è§¦å‘æ–¹å¼**: ç”¨æˆ·ç‚¹å‡»åˆ·æ–°æŒ‰é’®

#### 5.2 åˆ·æ–°å•ä¸ªè¯æ®
- **æ¥å£**: `POST /readiness/refresh-evidence`
- **è°ƒç”¨ä½ç½®**: `handleRefreshSingleEvidence()` å‡½æ•°ï¼ˆç¬¬571è¡Œï¼‰
- **ç”¨é€”**: åˆ·æ–°å•ä¸ªè¯æ®æ•°æ®
- **API æ–¹æ³•**: `readinessApi.refreshEvidence(tripId, evidenceId)`
- **è¿”å›æ ¼å¼**: `{ success: boolean }`
- **è§¦å‘æ–¹å¼**: ç”¨æˆ·ç‚¹å‡»æŸä¸ªè¯æ®é¡¹çš„åˆ·æ–°æŒ‰é’®

---

## ğŸ”„ æ¥å£è°ƒç”¨æµç¨‹

### ä¸»æµç¨‹ï¼ˆåŠ è½½å‡†å¤‡åº¦æ•°æ®ï¼‰

```
1. å¹¶è¡ŒåŠ è½½ï¼š
   â”œâ”€ tripsApi.getById(tripId) âœ… å¿…éœ€
   â””â”€ readinessApi.getTripReadiness(tripId) â­ ä¸»æ¥å£
      â”‚
      â”œâ”€ æˆåŠŸ â†’ è½¬æ¢ä¸º ReadinessData â†’ æ˜¾ç¤º
      â”‚
      â””â”€ å¤±è´¥ â†’ å¤‡ç”¨æ–¹æ¡ˆ1: readinessApi.check(...)
                â”‚
                â”œâ”€ æˆåŠŸ â†’ è½¬æ¢ä¸º ReadinessData â†’ æ˜¾ç¤º
                â”‚
                â””â”€ å¤±è´¥ â†’ å¤‡ç”¨æ–¹æ¡ˆ2: å¹¶è¡Œè°ƒç”¨
                          â”œâ”€ readinessApi.getPersonalizedChecklist(tripId)
                          â””â”€ readinessApi.getRiskWarnings(tripId)
                             â”‚
                             â”œâ”€ æˆåŠŸ â†’ è½¬æ¢ä¸º ReadinessData â†’ æ˜¾ç¤º
                             â”‚
                             â””â”€ å¤±è´¥ â†’ ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼ˆgenerateMockReadinessDataï¼‰
```

### è¾…åŠ©æµç¨‹ï¼ˆèƒ½åŠ›åŒ…ï¼‰

```
loadCapabilityPacks():
  å¹¶è¡Œè°ƒç”¨ï¼š
  â”œâ”€ readinessApi.getCapabilityPacks()
  â””â”€ readinessApi.evaluateCapabilityPacks(...)
  
  å¤±è´¥æ—¶ï¼šè¿”å› nullï¼Œä¸å½±å“ä¸»æµç¨‹
```

---

## ğŸ“Š æ¥å£ä¼˜å…ˆçº§æ€»ç»“

| ä¼˜å…ˆçº§ | æ¥å£ | ç”¨é€” | æ˜¯å¦å¿…éœ€ |
|--------|------|------|----------|
| â­ æœ€é«˜ | `GET /readiness/trip/:tripId` | ä¸»æ¥å£ï¼Œè·å–å‡†å¤‡åº¦æ•°æ® | âœ… æ¨èä½¿ç”¨ |
| ğŸ”„ å¤‡ç”¨1 | `POST /readiness/check` | å¤‡ç”¨æ–¹æ¡ˆ1 | ğŸ”„ å¤‡ç”¨ |
| ğŸ”„ å¤‡ç”¨2-1 | `GET /readiness/personalized-checklist` | å¤‡ç”¨æ–¹æ¡ˆ2-1 | ğŸ”„ å¤‡ç”¨ |
| ğŸ”„ å¤‡ç”¨2-2 | `GET /readiness/risk-warnings` | å¤‡ç”¨æ–¹æ¡ˆ2-2 | ğŸ”„ å¤‡ç”¨ |
| âœ… å¿…éœ€ | `GET /trips/:id` | è·å–è¡Œç¨‹ä¿¡æ¯ | âœ… å¿…éœ€ |
| ğŸ“Š è¾…åŠ© | `GET /readiness/capability-packs` | èƒ½åŠ›åŒ…åˆ—è¡¨ | ğŸ“Š è¾…åŠ© |
| ğŸ“Š è¾…åŠ© | `POST /readiness/capability-packs/evaluate` | è¯„ä¼°èƒ½åŠ›åŒ… | ğŸ“Š è¾…åŠ© |
| ğŸ”§ åŠŸèƒ½ | `POST /readiness/repair-options` | è·å–ä¿®å¤æ–¹æ¡ˆ | ğŸ”§ åŠŸèƒ½ |
| ğŸ”§ åŠŸèƒ½ | `POST /readiness/apply-repair` | åº”ç”¨ä¿®å¤æ–¹æ¡ˆ | ğŸ”§ åŠŸèƒ½ |
| ğŸ”§ åŠŸèƒ½ | `POST /readiness/auto-repair` | è‡ªåŠ¨ä¿®å¤ | ğŸ”§ åŠŸèƒ½ |
| ğŸ”§ åŠŸèƒ½ | `POST /readiness/refresh-evidence` | åˆ·æ–°è¯æ® | ğŸ”§ åŠŸèƒ½ |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®è½¬æ¢

- `getTripReadiness` å’Œ `check` æ¥å£è¿”å› `ReadinessCheckResult` æ ¼å¼
- é¡µé¢éœ€è¦ `ReadinessData` æ ¼å¼
- ä½¿ç”¨ `convertCheckResultToReadinessData()` å‡½æ•°è¿›è¡Œè½¬æ¢
- **é—®é¢˜**: è½¬æ¢å‡½æ•°ä¸­éƒ¨åˆ†åˆ†æ•°ç»´åº¦ï¼ˆevidenceCoverage, scheduleFeasibility, transportCertainty, buffersï¼‰æ˜¯ç¡¬ç¼–ç çš„

### 2. å¤‡ç”¨æ–¹æ¡ˆ

- å¦‚æœä¸»æ¥å£å¤±è´¥ï¼Œä¼šè‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨æ–¹æ¡ˆ
- æ‰€æœ‰å¤‡ç”¨æ–¹æ¡ˆéƒ½å¤±è´¥æ—¶ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼ˆ`generateMockReadinessData()`ï¼‰
- æ¨¡æ‹Ÿæ•°æ®ä¸æ˜¯çœŸå®çš„ç›®çš„åœ°æ•°æ®

### 3. é”™è¯¯å¤„ç†

- æ‰€æœ‰æ¥å£è°ƒç”¨éƒ½æœ‰é”™è¯¯å¤„ç†ï¼ˆ`.catch()`ï¼‰
- å¤±è´¥æ—¶ä¸ä¼šé˜»å¡é¡µé¢æ¸²æŸ“
- ä¼šåœ¨æ§åˆ¶å°è¾“å‡ºè­¦å‘Šä¿¡æ¯

### 4. ç¡¬ç¼–ç é—®é¢˜

å½“å‰ `convertCheckResultToReadinessData` å‡½æ•°ä¸­ï¼Œä»¥ä¸‹åˆ†æ•°ç»´åº¦æ˜¯ç¡¬ç¼–ç çš„ï¼š
- `evidenceCoverage: 85`
- `scheduleFeasibility: 70`
- `transportCertainty: 65`
- `buffers: 60`
- `safetyRisk`: éƒ¨åˆ†è®¡ç®—ï¼ˆåŸºäºé£é™©æ•°é‡ï¼‰

éœ€è¦ä»åç«¯æ•°æ®ä¸­æå–æˆ–è®¡ç®—è¿™äº›å€¼ã€‚

---

## ğŸ“ ä»£ç ä½ç½®

- **é¡µé¢æ–‡ä»¶**: `src/pages/readiness/index.tsx`
- **API å®šä¹‰**: `src/api/readiness.ts`
- **ç±»å‹å®šä¹‰**: `src/types/readiness.ts`

---

## ğŸ” è°ƒè¯•å»ºè®®

1. **æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—**ï¼š
   - `"Using getTripReadiness data"` - ä½¿ç”¨äº†ä¸»æ¥å£
   - `"Trying check API"` - ä½¿ç”¨äº†å¤‡ç”¨æ–¹æ¡ˆ1
   - `"Using checklist/riskWarnings data"` - ä½¿ç”¨äº†å¤‡ç”¨æ–¹æ¡ˆ2
   - `"All APIs failed, using mock data"` - æ‰€æœ‰æ¥å£å¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®

2. **æŸ¥çœ‹ç½‘ç»œè¯·æ±‚**ï¼š
   - æ£€æŸ¥ `GET /readiness/trip/:tripId` çš„çŠ¶æ€ç ï¼ˆ200 = æˆåŠŸï¼Œ404 = æœªå®ç°ï¼‰
   - æŸ¥çœ‹å“åº”å†…å®¹ï¼Œç¡®è®¤æ•°æ®æ ¼å¼

3. **éªŒè¯æ•°æ®**ï¼š
   - æŸ¥çœ‹ `"Raw readiness data from API"` æ—¥å¿—ï¼Œç¡®è®¤åç«¯è¿”å›çš„æ•°æ®
   - æŸ¥çœ‹ `"Converted readiness data"` æ—¥å¿—ï¼Œç¡®è®¤è½¬æ¢åçš„æ•°æ®

