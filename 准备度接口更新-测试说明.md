# 准备度接口更新 - 测试说明

## 更新内容

根据 API 文档更新了 `getTripReadiness` 接口的类型定义：

- **接口**: `GET /readiness/trip/:tripId`
- **返回类型**: 从 `ReadinessData` 改为 `ReadinessCheckResult`（与 API 文档一致）
- **数据转换**: 在页面代码中将 `ReadinessCheckResult` 转换为 `ReadinessData` 供页面使用

## 测试步骤

### 1. 启动开发服务器

```bash
npm run dev
# 或
pnpm dev
```

### 2. 打开准备度页面

访问准备度页面，URL 格式：
```
http://localhost:5173/dashboard/readiness?tripId={your-trip-id}
```

### 3. 查看控制台日志

打开浏览器开发者工具（F12），查看 Console 标签页，应该能看到以下日志：

#### 成功情况（如果 `getTripReadiness` 接口可用）:
```
Using getTripReadiness data for trip: {tripId} destination: IS
```

#### 备用方案（如果 `getTripReadiness` 返回 404）:
```
getTripReadiness failed, trying fallback: ...
Trying check API with DTO: {destinationId: "IS", ...}
✅ Using check API result for trip: {tripId} destination: IS result: {...}
```

#### 如果所有接口都失败:
```
❌ check API failed, trying fallback 2: ...
All APIs failed, using mock data for trip: {tripId} destination: IS
```

### 4. 检查网络请求

在 Network 标签页中，查找以下请求：

1. **主接口** (如果后端已实现):
   - `GET /api/readiness/trip/{tripId}`
   - 状态码：200（成功）或 404（未实现）

2. **备用接口** (如果主接口失败):
   - `POST /api/readiness/check`
   - 查看请求体（Payload），确认 `destinationId` 是否正确（如 "IS"）

3. **其他备用接口** (如果 check 接口也失败):
   - `GET /api/readiness/personalized-checklist?tripId={tripId}`
   - `GET /api/readiness/risk-warnings?tripId={tripId}`

### 5. 验证页面显示

确认页面正常显示，没有错误：

- ✅ 准备度状态（Ready/Nearly/Not Ready）
- ✅ 分数显示（0-100）
- ✅ Blockers 列表（如果有）
- ✅ Watchlist（如果状态为 Ready）

### 6. 验证数据格式

如果 `getTripReadiness` 接口成功返回数据，检查返回的数据格式是否符合 `ReadinessCheckResult` 格式：

```typescript
{
  findings: Array<{
    category: string;
    blockers: Array<{message: string; tasks?: string[]; evidence?: string}>;
    must: Array<{message: string; tasks?: string[]}>;
    should: Array<{message: string; tasks?: string[]}>;
    optional: Array<{message: string; tasks?: string[]}>;
    risks?: Array<{type: string; severity: string; summary: string}>;
  }>;
  summary: {
    totalBlockers: number;
    totalMust: number;
    totalShould: number;
    totalOptional: number;
  };
  risks: Array<{type: string; severity: string; summary: string}>;
  constraints: Array<{type: string; message: string}>;
}
```

## 预期行为

### 场景 1: 后端已实现 `GET /readiness/trip/:id`

1. 调用 `getTripReadiness(tripId)`
2. 返回 `ReadinessCheckResult`
3. 转换为 `ReadinessData`
4. 显示在页面上

### 场景 2: 后端未实现 `GET /readiness/trip/:id`（返回 404）

1. `getTripReadiness` 失败
2. 自动切换到备用方案：调用 `check` 接口
3. 如果 `check` 接口成功，转换为 `ReadinessData` 并显示
4. 如果 `check` 接口失败，继续使用其他备用方案

### 场景 3: 所有接口都失败

1. 所有 API 调用都失败
2. 使用模拟数据（`generateMockReadinessData()`）
3. 页面显示模拟数据，但这不是真实的目的地数据

## 常见问题

### Q: 页面显示 "数据格式错误，请刷新页面重试"

**原因**: 返回的数据格式不符合预期

**解决**: 
- 检查控制台日志，查看实际返回的数据
- 确认后端返回的数据格式是否符合 `ReadinessCheckResult` 格式
- 检查数据转换函数是否正确处理了所有字段

### Q: 页面显示模拟数据而不是真实数据

**原因**: 所有 API 接口都失败了

**解决**:
- 检查后端服务是否运行
- 检查网络请求，查看错误信息
- 确认后端接口是否已实现

### Q: 控制台显示 "Cannot read properties of undefined (reading 'overall')"

**原因**: `readinessData.score` 为 `undefined`

**解决**: 
- 已添加安全检查，如果出现此错误，说明数据验证失败
- 检查数据转换函数是否正确创建了 `score` 字段
- 查看控制台日志，确认实际的数据结构

## 测试检查清单

- [ ] 开发服务器正常启动
- [ ] 准备度页面可以正常打开
- [ ] 控制台没有错误信息
- [ ] 网络请求正常（即使返回 404 也是正常的，说明接口未实现）
- [ ] 页面正常显示准备度数据（即使是模拟数据）
- [ ] 数据格式验证通过（如果有真实数据返回）
- [ ] 备用方案正常工作（如果主接口失败）

## 更新文件

- `src/api/readiness.ts` - 更新了 `getTripReadiness` 接口的返回类型
- `src/pages/readiness/index.tsx` - 更新了数据转换逻辑

