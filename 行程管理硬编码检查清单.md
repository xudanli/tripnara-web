# 行程管理硬编码检查清单

本文档列出了行程管理相关页面中需要对接 API 的硬编码数据位置。

**生成时间**: 2025-01-XX  
**检查范围**: Dashboard、EvidenceDrawer、Insights 等行程管理相关页面

---

## 1. Dashboard 页面 (`src/pages/Dashboard.tsx`)

### 1.1 Attention Queue（需要关注的队列）

**位置**: 第 144-149 行  
**当前状态**: 硬编码模拟数据

```typescript
// 模拟 Attention Queue 数据
const attentionItems = [
  { id: 'att-1', type: 'schedule_conflict', title: 'Schedule conflict', tripId: recentTrip?.id },
  { id: 'att-2', type: 'road_closed', title: 'Road closed', tripId: recentTrip?.id },
  { id: 'att-3', type: 'weather_risk', title: 'Weather risk', tripId: recentTrip?.id },
];
```

**需要的接口**: ⚠️ **需要新增接口**
- `GET /trips/attention-queue` - 获取需要关注的队列列表
- 或 `GET /trips/:id/attention-queue` - 获取特定行程的关注队列

**建议的响应格式**:
```typescript
interface AttentionItem {
  id: string;
  type: 'schedule_conflict' | 'road_closed' | 'weather_risk' | 'budget_alert' | 'safety_risk';
  title: string;
  description?: string;
  tripId: string;
  severity: 'low' | 'medium' | 'high' | 'critical';
  createdAt: string;
}
```

---

### 1.2 Blockers（阻塞项）

**位置**: 第 142 行  
**当前状态**: 硬编码为 1，有 TODO 注释

```typescript
const blockers = 1; // TODO: 从 readiness API 获取
```

**需要的接口**: ✅ **已有接口**
- `GET /readiness/trip/:tripId` - 获取行程准备度数据（包含 blockers）
- 已在 `src/api/readiness.ts` 中实现 `getTripReadiness` 方法
- 返回的 `ReadinessData` 包含 `blockers` 数组

**需要修改**:
- 可以从 readiness 数据中提取 blockers 数量
- 如果需要跨所有行程的 blockers 统计，可能需要调用多个接口并汇总

---

### 1.3 Templates（模板列表）

**位置**: 第 151-155 行  
**当前状态**: 硬编码模拟数据

```typescript
// 模拟模板数据
const templates = [
  { id: 'tpl-1', name: 'Iceland South Coast', desc: '稳健版', days: 7 },
  { id: 'tpl-2', name: 'City 48h', desc: '高密度', days: 2 },
];
```

**需要的接口**: ✅ **已有接口**（路线模板）
- `GET /route-directions/templates` - 查询路线模板列表
- 已在 `src/api/route-directions.ts` 中实现 `queryTemplates` 方法

**需要修改**:
- 使用 `routeDirectionsApi.queryTemplates()` 替换硬编码数据
- 可能需要转换数据格式以匹配 Dashboard 的显示需求

---

## 2. EvidenceDrawer 组件 (`src/components/layout/EvidenceDrawer.tsx`)

### 2.1 Evidence Items（证据项）

**位置**: 第 60-92 行  
**当前状态**: 硬编码模拟数据，有 TODO 注释

```typescript
// TODO: 从 API 获取真实数据
const evidenceItems: EvidenceItem[] = [
  {
    id: 'ev-1',
    type: 'opening_hours',
    title: '营业时间',
    description: '景点 A 营业时间：09:00-18:00',
    source: 'Google Places API',
    link: 'https://example.com',
    timestamp: '2024-01-15 10:30',
    poiId: 'poi-1',
    day: 1,
  },
  // ...
];
```

**需要的接口**: ⚠️ **需要新增接口或确认现有接口**
- `GET /trips/:id/evidence` - 获取行程的证据列表
- 或从其他接口的数据中提取证据信息

---

### 2.2 Risk Items（风险项）

**位置**: 第 94-125 行  
**当前状态**: 硬编码模拟数据

```typescript
const riskItems: RiskItem[] = [
  {
    id: 'risk-1',
    level: 'high',
    category: 'time',
    title: '时间窗冲突',
    description: 'Day 1 下午行程过于紧凑，缺少缓冲时间',
    reason: 'Abu: 缺少缓冲可能导致延误连锁反应',
    affectedItems: ['poi-1', 'poi-2'],
    evidenceIds: ['ev-1'],
  },
  // ...
];
```

**需要的接口**: ⚠️ **需要新增接口或确认现有接口**
- `GET /trips/:id/risks` - 获取行程的风险列表
- 或从 `GET /trips/:id/persona-alerts` 中提取风险信息（已有接口）

**注意**: `GET /trips/:id/persona-alerts` 已经存在，可能需要检查其返回数据是否包含风险信息

---

### 2.3 Decision Log Items（决策日志）

**位置**: 第 127-154 行  
**当前状态**: 硬编码模拟数据

```typescript
const decisionLogItems: DecisionLogItem[] = [
  {
    id: 'dec-1',
    timestamp: '2024-01-15 10:30',
    action: '调整 Day 1 时间轴',
    reason: 'Dr.Dre: 检测到时间窗冲突，自动添加缓冲',
    persona: 'dre',
    result: '成功：添加 20 分钟缓冲',
    evidenceIds: ['ev-1'],
  },
  // ...
];
```

**需要的接口**: ✅ **已有接口**
- `GET /trips/:id/decision-log` - 获取决策记录/透明日志
- 已在 `src/api/trips.ts` 中实现 `getDecisionLog` 方法

**需要修改**:
- 使用 `tripsApi.getDecisionLog(tripId, limit, offset)` 替换硬编码数据
- 需要确认响应格式是否匹配 `DecisionLogItem` 类型

---

## 3. Insights 页面 (`src/pages/insights/index.tsx`)

### 3.1 Report（复盘报告）

**位置**: 第 39-49 行  
**当前状态**: 硬编码模拟数据

```typescript
// 模拟复盘数据
const report = {
  robustness: 8.5,
  rhythm: '标准',
  highlights: [
    { id: 1, title: '最佳体验点', description: '某个地点的体验超出预期' },
    { id: 2, title: '最值回忆点', description: '某个时刻特别难忘' },
  ],
  failures: [
    { id: 1, title: '时间安排过紧', description: '某天行程过于紧凑，导致疲劳' },
  ],
};
```

**需要的接口**: ✅ **已有接口**
- `GET /trips/:id/recap` - 生成行程复盘报告
- 已在 `src/api/trips.ts` 中实现 `getRecap` 方法

**需要修改**:
- 使用 `tripsApi.getRecap(tripId)` 替换硬编码数据
- 需要确认响应格式是否包含 `robustness`、`rhythm`、`highlights`、`failures` 等字段

---

### 3.2 Preferences（用户偏好）

**位置**: 第 51-55 行  
**当前状态**: 硬编码模拟数据

```typescript
const preferences = {
  preferredRhythm: '标准',
  preferredPlaces: ['自然', '历史'],
  avgDailyWalk: 8.5,
};
```

**需要的接口**: ✅ **已有接口**
- `GET /users/profile` - 获取用户信息（包含偏好设置）
- 已在 `src/api/user.ts` 中实现

**需要修改**:
- 使用 `userApi.getProfile()` 获取用户偏好
- 或从行程详情中提取偏好信息

---

### 3.3 Templates（模板列表）

**位置**: 第 57-60 行  
**当前状态**: 硬编码模拟数据

```typescript
const templates = [
  { id: 1, name: '冰岛南岸稳健版', description: '适合初次访问，节奏适中' },
  { id: 2, name: '日本关西体验优先', description: '最大化体验密度' },
];
```

**需要的接口**: ✅ **已有接口**（路线模板）
- `GET /route-directions/templates` - 查询路线模板列表
- 已在 `src/api/route-directions.ts` 中实现

**需要修改**:
- 使用 `routeDirectionsApi.queryTemplates()` 替换硬编码数据

---

## 总结

### 已对接但需要使用的接口

| 接口 | 路径 | 状态 | 需要修改的文件 |
|------|------|------|---------------|
| 决策日志 | `GET /trips/:id/decision-log` | ✅ 已实现 | `src/components/layout/EvidenceDrawer.tsx` |
| 复盘报告 | `GET /trips/:id/recap` | ✅ 已实现 | `src/pages/insights/index.tsx` |
| 路线模板列表 | `GET /route-directions/templates` | ✅ 已实现 | `src/pages/Dashboard.tsx`, `src/pages/insights/index.tsx` |
| 用户偏好 | `GET /users/profile` | ✅ 已实现 | `src/pages/insights/index.tsx` |
| 人格提醒 | `GET /trips/:id/persona-alerts` | ✅ 已实现 | 可用于 `EvidenceDrawer.tsx` 的风险项 |

### 需要新增或确认的接口

| 功能 | 建议接口 | 优先级 | 说明 |
|------|---------|--------|------|
| Attention Queue | `GET /trips/attention-queue` 或 `GET /trips/:id/attention-queue` | 高 | Dashboard 需要显示需要关注的队列 |
| Evidence Items | `GET /trips/:id/evidence` | 中 | EvidenceDrawer 需要显示证据列表 |
| Risk Items | `GET /trips/:id/risks` | 中 | 可能需要从 persona-alerts 中提取，或需要独立接口 |
| Blockers 统计 | `GET /trips/blockers` 或从 readiness 接口获取 | 中 | Dashboard 需要显示阻塞项统计 |

### 修改优先级

1. **高优先级**:
   - ✅ EvidenceDrawer: 决策日志 (使用已有接口)
   - ✅ Insights: 复盘报告 (使用已有接口)
   - ✅ Dashboard/Insights: 路线模板 (使用已有接口)

2. **中优先级**:
   - ⚠️ Dashboard: Attention Queue (需要新增接口)
   - ⚠️ EvidenceDrawer: Evidence Items (需要确认/新增接口)
   - ⚠️ EvidenceDrawer: Risk Items (可能需要从 persona-alerts 提取)

3. **低优先级**:
   - Dashboard: Blockers 统计 (可以从 readiness 获取或新增接口)

---

## 下一步行动

1. **确认现有接口的响应格式**，确保与前端类型定义匹配
2. **优先对接已有接口**，替换硬编码数据
3. **与后端确认**是否需要新增 Attention Queue、Evidence、Risks 接口
4. **统一数据格式**，确保各页面显示一致

