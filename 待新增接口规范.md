# 待新增接口规范

本文档定义了需要后端新增的两个接口的详细规范。

**生成时间**: 2025-01-XX

---

## 1. 获取行程证据列表接口

### 1.1 接口信息

- **方法**: `GET`
- **路径**: `/trips/:id/evidence`
- **描述**: 获取指定行程的所有证据项列表，用于 EvidenceDrawer 组件的证据标签页显示

### 1.2 路径参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | string | 是 | 行程ID |

### 1.3 查询参数（可选）

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| limit | number | 否 | 返回数量限制，默认 50 |
| offset | number | 否 | 偏移量，默认 0 |
| day | number | 否 | 筛选特定天数的证据 |
| type | string | 否 | 筛选特定类型的证据（opening_hours, road_closure, weather, booking, other）|

### 1.4 响应格式

```typescript
{
  success: true,
  data: {
    items: EvidenceItem[],
    total: number,
    limit: number,
    offset: number
  },
  error: null
}
```

### 1.5 EvidenceItem 数据结构

```typescript
interface EvidenceItem {
  id: string;                    // 证据项ID
  type: 'opening_hours' | 'road_closure' | 'weather' | 'booking' | 'other';  // 证据类型
  title: string;                 // 证据标题
  description: string;           // 证据描述
  source?: string;               // 数据来源（如 "Google Places API", "交通部门公告", "Weather API"）
  link?: string;                 // 相关链接（可选）
  timestamp: string;             // 时间戳（ISO 8601 格式）
  poiId?: string;                // 关联的POI ID（可选）
  day?: number;                  // 关联的行程天数（可选，1-based）
  severity?: 'low' | 'medium' | 'high';  // 严重程度（可选）
  metadata?: {                   // 额外元数据（可选）
    [key: string]: any;
  };
}
```

### 1.6 响应示例

```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": "ev-1",
        "type": "opening_hours",
        "title": "营业时间",
        "description": "景点 A 营业时间：09:00-18:00",
        "source": "Google Places API",
        "link": "https://maps.google.com/place/...",
        "timestamp": "2024-01-15T10:30:00Z",
        "poiId": "poi-123",
        "day": 1,
        "severity": "low"
      },
      {
        "id": "ev-2",
        "type": "road_closure",
        "title": "道路封闭",
        "description": "Route X 在 2024-01-20 至 2024-01-25 期间封闭施工",
        "source": "交通部门公告",
        "link": "https://traffic.gov/notice/...",
        "timestamp": "2024-01-15T11:00:00Z",
        "day": 2,
        "severity": "high"
      },
      {
        "id": "ev-3",
        "type": "weather",
        "title": "天气预报",
        "description": "Day 2 预计有雨，建议调整户外活动",
        "source": "Weather API",
        "timestamp": "2024-01-15T12:00:00Z",
        "day": 2,
        "severity": "medium"
      }
    ],
    "total": 3,
    "limit": 50,
    "offset": 0
  },
  "error": null
}
```

### 1.7 错误响应

```json
{
  "success": false,
  "data": null,
  "error": {
    "code": "TRIP_NOT_FOUND",
    "message": "行程不存在"
  }
}
```

### 1.8 使用场景

- **EvidenceDrawer 组件**: 在"证据"标签页中显示所有证据项
- **决策日志**: 证据项可以被决策日志引用（通过 evidenceIds）
- **风险项**: 风险项可以关联多个证据项（通过 evidenceIds）

### 1.9 数据来源建议

证据数据可能来自多个来源：
- **Google Places API**: POI 营业时间、地址信息
- **交通部门API**: 道路封闭、施工信息
- **Weather API**: 天气预报信息
- **预订系统**: 酒店、餐厅预订状态
- **内部系统**: 用户反馈、历史数据等

---

## 2. 获取关注队列接口

### 2.1 接口信息

- **方法**: `GET`
- **路径**: `/trips/attention-queue` 或 `/trips/:id/attention-queue`
- **描述**: 获取需要用户关注的队列列表，用于 Dashboard 页面的 Attention Queue 显示

### 2.2 方案A：全局关注队列（推荐）

**路径**: `/trips/attention-queue`

获取当前用户所有行程中需要关注的事项。

#### 查询参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| limit | number | 否 | 返回数量限制，默认 20 |
| offset | number | 否 | 偏移量，默认 0 |
| severity | string | 否 | 筛选严重程度（critical, high, medium, low）|
| type | string | 否 | 筛选类型（schedule_conflict, road_closed, weather_risk, budget_alert, safety_risk）|

#### 响应格式

```typescript
{
  success: true,
  data: {
    items: AttentionItem[],
    total: number,
    limit: number,
    offset: number
  },
  error: null
}
```

### 2.3 方案B：特定行程关注队列

**路径**: `/trips/:id/attention-queue`

获取特定行程中需要关注的事项。

#### 路径参数

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | string | 是 | 行程ID |

#### 查询参数（同上）

### 2.4 AttentionItem 数据结构

```typescript
interface AttentionItem {
  id: string;                    // 关注项ID
  type: 'schedule_conflict' | 'road_closed' | 'weather_risk' | 'budget_alert' | 'safety_risk' | 'booking_issue' | 'other';  // 类型
  title: string;                 // 标题
  description?: string;          // 详细描述（可选）
  tripId: string;                // 关联的行程ID
  severity: 'critical' | 'high' | 'medium' | 'low';  // 严重程度
  createdAt: string;             // 创建时间（ISO 8601 格式）
  updatedAt?: string;            // 更新时间（可选）
  status?: 'new' | 'acknowledged' | 'resolved';  // 状态（可选）
  metadata?: {                   // 额外元数据（可选）
    day?: number;                // 关联的行程天数
    poiId?: string;              // 关联的POI ID
    evidenceIds?: string[];      // 关联的证据ID列表
    actionUrl?: string;          // 建议的操作链接（可选）
    [key: string]: any;
  };
}
```

### 2.5 响应示例

```json
{
  "success": true,
  "data": {
    "items": [
      {
        "id": "att-1",
        "type": "schedule_conflict",
        "title": "时间窗冲突",
        "description": "Day 1 下午行程过于紧凑，缺少缓冲时间",
        "tripId": "trip-123",
        "severity": "high",
        "createdAt": "2024-01-15T10:30:00Z",
        "updatedAt": "2024-01-15T10:30:00Z",
        "status": "new",
        "metadata": {
          "day": 1,
          "evidenceIds": ["ev-1"],
          "actionUrl": "/dashboard/trips/trip-123?tab=schedule"
        }
      },
      {
        "id": "att-2",
        "type": "road_closed",
        "title": "道路封闭",
        "description": "Day 2 计划路线经过封闭路段",
        "tripId": "trip-123",
        "severity": "critical",
        "createdAt": "2024-01-15T11:00:00Z",
        "status": "new",
        "metadata": {
          "day": 2,
          "evidenceIds": ["ev-2"],
          "actionUrl": "/dashboard/trips/trip-123?tab=risk"
        }
      },
      {
        "id": "att-3",
        "type": "weather_risk",
        "title": "天气风险",
        "description": "Day 2 预计有雨，建议调整户外活动",
        "tripId": "trip-123",
        "severity": "medium",
        "createdAt": "2024-01-15T12:00:00Z",
        "status": "new",
        "metadata": {
          "day": 2,
          "evidenceIds": ["ev-3"]
        }
      }
    ],
    "total": 3,
    "limit": 20,
    "offset": 0
  },
  "error": null
}
```

### 2.6 错误响应

```json
{
  "success": false,
  "data": null,
  "error": {
    "code": "UNAUTHORIZED",
    "message": "未授权访问"
  }
}
```

### 2.7 使用场景

- **Dashboard 页面**: 在首页显示需要用户关注的事项列表
- **通知系统**: 可以作为通知的数据源
- **优先级排序**: 按照严重程度（severity）和时间排序显示

### 2.8 数据来源建议

关注队列的数据应该基于：
- **Persona Alerts**: 从三人格（Abu, Dr.Dre, Neptune）的提醒中提取
- **Risk Items**: 高风险项应该出现在关注队列中
- **Evidence**: 基于证据自动生成关注项
- **决策日志**: 从决策日志中提取需要用户注意的事项
- **Readiness Check**: 从准备度检查结果中提取阻塞项

### 2.9 推荐实现方案

建议采用**方案A（全局关注队列）**，原因：
1. Dashboard 页面需要显示所有行程的关注事项
2. 便于用户快速了解需要处理的所有事项
3. 可以按严重程度和时间统一排序

如果需要获取特定行程的关注项，可以在查询参数中添加 `tripId` 过滤。

---

## 3. 接口实现优先级

### 高优先级
1. **获取关注队列接口** (`GET /trips/attention-queue`)
   - Dashboard 页面的核心功能
   - 影响用户体验

### 中优先级
2. **获取行程证据列表接口** (`GET /trips/:id/evidence`)
   - EvidenceDrawer 组件的重要功能
   - 可以提供更详细的证据展示

---

## 4. 前端对接计划

一旦后端接口实现完成，前端需要：

1. **在 `src/api/trips.ts` 中添加接口方法**:
   ```typescript
   getEvidence: async (id: string, params?: { limit?: number; offset?: number; day?: number; type?: string }): Promise<EvidenceResponse>
   getAttentionQueue: async (params?: { limit?: number; offset?: number; severity?: string; type?: string; tripId?: string }): Promise<AttentionQueueResponse>
   ```

2. **更新类型定义** (`src/types/trip.ts`):
   - 添加 `EvidenceItem` 接口
   - 添加 `AttentionItem` 接口
   - 添加响应类型

3. **更新组件**:
   - `src/components/layout/EvidenceDrawer.tsx`: 使用 `getEvidence` 接口
   - `src/pages/Dashboard.tsx`: 使用 `getAttentionQueue` 接口

---

## 5. 注意事项

1. **权限控制**: 两个接口都需要确保用户只能访问自己拥有的行程数据
2. **性能优化**: 
   - 关注队列接口建议使用缓存
   - 证据列表接口建议支持分页
3. **数据一致性**: 确保证据数据和关注队列数据与决策日志、风险项等数据保持一致
4. **实时性**: 关注队列应该反映最新的状态，建议支持实时更新或轮询

