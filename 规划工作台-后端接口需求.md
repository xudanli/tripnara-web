# è§„åˆ’å·¥ä½œå°åç«¯æ¥å£éœ€æ±‚æ–‡æ¡£

**ç”Ÿæˆæ—¶é—´**: 2025-01-XX  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**çŠ¶æ€**: å¾…å®ç°

---

## ğŸ“‹ ç›®å½•

1. [è¡Œç¨‹è°ƒæ•´æ¥å£](#1-è¡Œç¨‹è°ƒæ•´æ¥å£)
2. [æ¯æ—¥æŒ‡æ ‡æ¥å£](#2-æ¯æ—¥æŒ‡æ ‡æ¥å£)
3. [å†²çªæ£€æµ‹æ¥å£](#3-å†²çªæ£€æµ‹æ¥å£)
4. [æ„å›¾ä¸çº¦æŸä¿å­˜æ¥å£](#4-æ„å›¾ä¸çº¦æŸä¿å­˜æ¥å£)
5. [ä¼˜åŒ–ç»“æœåº”ç”¨æ¥å£](#5-ä¼˜åŒ–ç»“æœåº”ç”¨æ¥å£)

---

## 1. è¡Œç¨‹è°ƒæ•´æ¥å£

### 1.1 è‡ªåŠ¨æ·»åŠ ç¼“å†²æ—¶é—´

**å½“å‰çŠ¶æ€**: å‰ç«¯å·²å®ç°è°ƒç”¨é€»è¾‘ï¼Œä½† `ModificationType` ä¸æ”¯æŒ `add_buffers`

**æ¥å£è·¯å¾„**: `POST /trips/:id/adjust`

**éœ€æ±‚**: æ‰©å±• `ModificationType` æ”¯æŒ `ADD_BUFFERS` ç±»å‹

**è¯·æ±‚æ ¼å¼**:
```typescript
interface AdjustTripRequest {
  modifications: TripModification[];
}

interface TripModification {
  type: ModificationType; // éœ€è¦æ·»åŠ  'ADD_BUFFERS'
  itemId?: string;
  newDate?: string;
  newStartTime?: string;
  activityData?: {
    placeId: number;
    startTime: string;
    endTime: string;
    type: string;
    [key: string]: any;
  };
  // æ–°å¢å­—æ®µï¼ˆç”¨äº ADD_BUFFERSï¼‰
  options?: {
    bufferDuration?: number; // ç¼“å†²æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰ï¼Œé»˜è®¤ 30
    applyToAllDays?: boolean; // æ˜¯å¦åº”ç”¨åˆ°æ‰€æœ‰æ—¥æœŸï¼Œé»˜è®¤ false
    dayId?: string; // å¦‚æœ applyToAllDays ä¸º falseï¼ŒæŒ‡å®šæ—¥æœŸ ID
  };
}

// éœ€è¦æ‰©å±•çš„ç±»å‹
type ModificationType = 
  | 'CHANGE_DATE' 
  | 'MOVE_ACTIVITY' 
  | 'ADD_ACTIVITY' 
  | 'REMOVE_ACTIVITY'
  | 'ADD_BUFFERS'; // æ–°å¢
```

**å“åº”æ ¼å¼**:
```typescript
interface TripAdjustmentResult {
  success: boolean;
  adjustedTrip: {
    id: string;
    destination: string;
    startDate: string;
    endDate: string;
    // ... å…¶ä»–å­—æ®µ
  };
  modifications: Array<{
    type: string;
    itemId?: string;
    description: string;
  }>;
}
```

**ä½¿ç”¨åœºæ™¯**:
- ScheduleTab ä¸­ç‚¹å‡» "Auto-add buffers" æŒ‰é’®
- è‡ªåŠ¨åœ¨è¡Œç¨‹é¡¹ä¹‹é—´æ·»åŠ ç¼“å†²æ—¶é—´

**ä¼˜å…ˆçº§**: P1

---

## 2. æ¯æ—¥æŒ‡æ ‡æ¥å£

### 2.1 è·å–æ¯æ—¥è¡Œç¨‹æŒ‡æ ‡

**å½“å‰çŠ¶æ€**: å‰ç«¯ä»è¡Œç¨‹é¡¹æ•°æ®è®¡ç®—ï¼Œä½†è®¡ç®—é€»è¾‘è¾ƒç®€å•ï¼Œéœ€è¦åç«¯æä¾›å‡†ç¡®æ•°æ®

**æ¥å£è·¯å¾„**: `GET /trips/:id/days/:dayId/metrics`

**è¯·æ±‚å‚æ•°**:
- `id` (è·¯å¾„å‚æ•°): è¡Œç¨‹ ID
- `dayId` (è·¯å¾„å‚æ•°): æ—¥æœŸ ID

**å“åº”æ ¼å¼**:
```typescript
interface DayMetricsResponse {
  date: string;
  metrics: {
    walk: number;        // æ€»æ­¥è¡Œè·ç¦»ï¼ˆå…¬é‡Œï¼‰ï¼Œç²¾ç¡®è®¡ç®—
    drive: number;       // æ€»è½¦ç¨‹ï¼ˆåˆ†é’Ÿï¼‰ï¼ŒåŸºäºå®é™…è·¯çº¿
    buffer: number;      // æ€»ç¼“å†²æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰ï¼Œç²¾ç¡®è®¡ç®—
    fatigue: number;     // æ€»ç–²åŠ³æŒ‡æ•°ï¼ˆ0-100ï¼‰
    ascent: number;      // æ€»çˆ¬å‡ï¼ˆç±³ï¼‰
    cost: number;        // é¢„è®¡èŠ±è´¹
  };
  conflicts: Array<{
    type: 'TIME_CONFLICT' | 'LUNCH_WINDOW' | 'FATIGUE_EXCEEDED' | 'BUFFER_INSUFFICIENT';
    severity: 'HIGH' | 'MEDIUM' | 'LOW';
    title: string;
    description: string;
    affectedItemIds: string[];
  }>;
}
```

**ä½¿ç”¨åœºæ™¯**:
- ScheduleTab ä¸­æ˜¾ç¤ºæ¯æ—¥æ‘˜è¦ï¼ˆæ€»æ­¥è¡Œã€è½¦ç¨‹ã€ç¼“å†²ï¼‰
- æ˜¾ç¤ºå†²çªåˆ—è¡¨

**ä¼˜å…ˆçº§**: P1

### 2.2 æ‰¹é‡è·å–å¤šæ—¥æŒ‡æ ‡

**æ¥å£è·¯å¾„**: `GET /trips/:id/metrics`

**æŸ¥è¯¢å‚æ•°**:
- `dates` (å¯é€‰): æ—¥æœŸæ•°ç»„ï¼Œå¦‚ `?dates=2025-01-01&dates=2025-01-02`
- å¦‚æœä¸æä¾›ï¼Œè¿”å›æ‰€æœ‰æ—¥æœŸçš„æŒ‡æ ‡

**å“åº”æ ¼å¼**:
```typescript
interface TripMetricsResponse {
  tripId: string;
  days: Array<DayMetricsResponse>;
  summary: {
    totalWalk: number;
    totalDrive: number;
    totalBuffer: number;
    totalFatigue: number;
    totalCost: number;
    averageWalkPerDay: number;
    averageDrivePerDay: number;
  };
}
```

**ä¼˜å…ˆçº§**: P1

---

## 3. å†²çªæ£€æµ‹æ¥å£

### 3.1 è·å–è¡Œç¨‹å†²çªåˆ—è¡¨

**å½“å‰çŠ¶æ€**: å‰ç«¯ç®€å•è®¡ç®—ï¼Œéœ€è¦åç«¯æä¾›å®Œæ•´çš„å†²çªæ£€æµ‹

**æ¥å£è·¯å¾„**: `GET /trips/:id/conflicts`

**æŸ¥è¯¢å‚æ•°**:
- `date` (å¯é€‰): æŒ‡å®šæ—¥æœŸï¼Œå¦‚æœä¸æä¾›åˆ™è¿”å›æ‰€æœ‰æ—¥æœŸçš„å†²çª
- `severity` (å¯é€‰): è¿‡æ»¤ä¸¥é‡ç¨‹åº¦ï¼Œ`HIGH` | `MEDIUM` | `LOW`

**å“åº”æ ¼å¼**:
```typescript
interface ConflictsResponse {
  tripId: string;
  conflicts: Array<{
    id: string;
    type: ConflictType;
    severity: 'HIGH' | 'MEDIUM' | 'LOW';
    title: string;
    description: string;
    affectedDays: string[]; // æ—¥æœŸæ•°ç»„
    affectedItemIds: string[]; // è¡Œç¨‹é¡¹ ID æ•°ç»„
    suggestions?: Array<{
      action: string;
      description: string;
      impact: string;
    }>;
  }>;
  total: number;
}

type ConflictType = 
  | 'TIME_CONFLICT'           // æ—¶é—´å†²çª
  | 'LUNCH_WINDOW'            // åˆé¤æ—¶é—´çª—è¿‡çŸ­
  | 'FATIGUE_EXCEEDED'        // ä½“åŠ›è¶…æ ‡
  | 'BUFFER_INSUFFICIENT'     // ç¼“å†²ä¸è¶³
  | 'CLOSURE_RISK'            // é—­å›­é£é™©
  | 'ACCESSIBILITY_MISMATCH'  // æ— éšœç¢ä¸åŒ¹é…
  | 'TRANSPORT_TOO_LONG';     // äº¤é€šè¿‡é•¿
```

**ä½¿ç”¨åœºæ™¯**:
- ScheduleTab å³ä¾§å†²çªåˆ—è¡¨
- æ¯æ—¥å†²çªæç¤º

**ä¼˜å…ˆçº§**: P0

---

## 4. æ„å›¾ä¸çº¦æŸä¿å­˜æ¥å£

### 4.1 æ›´æ–°è¡Œç¨‹æ„å›¾ä¸çº¦æŸ

**å½“å‰çŠ¶æ€**: å‰ç«¯åªèƒ½ä¿å­˜ `totalBudget`ï¼Œå…¶ä»–å­—æ®µéœ€è¦å­˜å‚¨åœ¨ metadata ä¸­

**æ¥å£è·¯å¾„**: `PUT /trips/:id/intent`

**è¯·æ±‚æ ¼å¼**:
```typescript
interface UpdateIntentRequest {
  // èŠ‚å¥é…ç½®
  pacingConfig?: {
    maxDailyActivities?: number; // æ ¹æ® rhythm è®¡ç®—ï¼šrelaxed=3, standard=5, tight=7
    restIntervalHours?: number;
    level?: 'relaxed' | 'standard' | 'tight';
  };
  
  // åå¥½è®¾ç½®
  preferences?: string[]; // ['nature', 'city', 'photography', 'food', ...]
  
  // çº¦æŸæ¡ä»¶
  constraints?: {
    dailyWalkLimit?: number;      // æ¯æ—¥æ­¥è¡Œé™åˆ¶ï¼ˆå…¬é‡Œï¼‰
    earlyRiser?: boolean;         // æ—©èµ·è€…
    nightOwl?: boolean;           // å¤œçŒ«å­
    mustPlaces?: number[];        // å¿…å»åœ°ç‚¹ ID æ•°ç»„
    avoidPlaces?: number[];       // é¿å…åœ°ç‚¹ ID æ•°ç»„
  };
  
  // è§„åˆ’ç­–ç•¥
  planningPolicy?: 'safe' | 'experience' | 'challenge';
  
  // é¢„ç®—ï¼ˆå¯é€‰ï¼Œä¹Ÿå¯ä»¥å•ç‹¬æ›´æ–°ï¼‰
  totalBudget?: number;
}
```

**å“åº”æ ¼å¼**:
```typescript
interface UpdateIntentResponse {
  success: boolean;
  trip: {
    id: string;
    pacingConfig?: PacingConfig;
    budgetConfig?: BudgetConfig;
    // ... å…¶ä»–å­—æ®µ
  };
  metadata?: {
    preferences?: string[];
    constraints?: {
      dailyWalkLimit?: number;
      earlyRiser?: boolean;
      nightOwl?: boolean;
      mustPlaces?: number[];
      avoidPlaces?: number[];
    };
    planningPolicy?: string;
  };
}
```

**ä½¿ç”¨åœºæ™¯**:
- IntentTab ä¸­ä¿å­˜æ„å›¾ä¸çº¦æŸ
- ä¿å­˜èŠ‚å¥ã€åå¥½ã€çº¦æŸæ¡ä»¶ã€è§„åˆ’ç­–ç•¥ç­‰

**ä¼˜å…ˆçº§**: P0

### 4.2 è·å–è¡Œç¨‹æ„å›¾ä¸çº¦æŸ

**æ¥å£è·¯å¾„**: `GET /trips/:id/intent`

**å“åº”æ ¼å¼**: åŒ `UpdateIntentResponse`

**ä½¿ç”¨åœºæ™¯**:
- IntentTab åŠ è½½æ—¶è·å–å·²æœ‰è®¾ç½®

**ä¼˜å…ˆçº§**: P0

---

## 5. ä¼˜åŒ–ç»“æœåº”ç”¨æ¥å£

### 5.1 åº”ç”¨ä¼˜åŒ–ç»“æœåˆ°è¡Œç¨‹

**å½“å‰çŠ¶æ€**: å‰ç«¯è°ƒç”¨ä¼˜åŒ–æ¥å£åï¼Œç»“æœåªæ˜¾ç¤ºåœ¨ OptimizeTabï¼Œæ— æ³•åº”ç”¨åˆ°å®é™…è¡Œç¨‹

**æ¥å£è·¯å¾„**: `POST /trips/:id/apply-optimization`

**è¯·æ±‚æ ¼å¼**:
```typescript
interface ApplyOptimizationRequest {
  optimizationId?: string; // ä¼˜åŒ–ç»“æœ IDï¼ˆå¦‚æœåç«¯ä¿å­˜äº†ä¼˜åŒ–ç»“æœï¼‰
  result: OptimizeRouteResponse; // æˆ–è€…åªä¼ å…³é”®æ•°æ®
  options?: {
    replaceExisting?: boolean; // æ˜¯å¦æ›¿æ¢ç°æœ‰è¡Œç¨‹é¡¹ï¼Œé»˜è®¤ true
    preserveManualEdits?: boolean; // æ˜¯å¦ä¿ç•™æ‰‹åŠ¨ç¼–è¾‘çš„é¡¹ï¼Œé»˜è®¤ true
    dryRun?: boolean; // æ˜¯å¦åªæ˜¯é¢„è§ˆï¼Œä¸å®é™…åº”ç”¨ï¼Œé»˜è®¤ false
  };
}
```

**å“åº”æ ¼å¼**:
```typescript
interface ApplyOptimizationResponse {
  success: boolean;
  appliedItems: number; // åº”ç”¨çš„è¡Œç¨‹é¡¹æ•°é‡
  modifiedDays: string[]; // ä¿®æ”¹çš„æ—¥æœŸæ•°ç»„
  preview?: {
    // å¦‚æœ dryRun=trueï¼Œè¿”å›é¢„è§ˆæ•°æ®
    changes: Array<{
      dayId: string;
      date: string;
      added: number;
      removed: number;
      modified: number;
    }>;
  };
}
```

**ä½¿ç”¨åœºæ™¯**:
- OptimizeTab ä¸­åº”ç”¨ä¼˜åŒ–ç»“æœ
- ScheduleTab ä¸­åº”ç”¨ä¼˜åŒ–ç»“æœ

**ä¼˜å…ˆçº§**: P1

---

## 6. å…¶ä»–å¢å¼ºæ¥å£

### 6.1 è·å–è¡Œç¨‹é¡¹è¯¦ç»†ä¿¡æ¯ï¼ˆåŒ…å«å®Œæ•´ metadataï¼‰

**å½“å‰çŠ¶æ€**: å‰ç«¯éœ€è¦è®¿é—® `Place.physicalMetadata` å’Œ `Place.metadata`ï¼Œä½†ç±»å‹å®šä¹‰å¯èƒ½ä¸å®Œæ•´

**æ¥å£è·¯å¾„**: `GET /trips/:id/items/:itemId/detail`

**å“åº”æ ¼å¼**: éœ€è¦åŒ…å«å®Œæ•´çš„ `Place` ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š
- `physicalMetadata`: å®Œæ•´çš„ç‰©ç†å…ƒæ•°æ®
- `metadata`: å®Œæ•´çš„å…ƒæ•°æ®ï¼ˆåŒ…æ‹¬ `openingHours`, `externalSource`, `lastCrawledAt` ç­‰ï¼‰

**ä¼˜å…ˆçº§**: P2

### 6.2 æ‰¹é‡æ›´æ–°è¡Œç¨‹é¡¹

**æ¥å£è·¯å¾„**: `POST /trips/:id/items/batch-update`

**è¯·æ±‚æ ¼å¼**:
```typescript
interface BatchUpdateItemsRequest {
  updates: Array<{
    itemId: string;
    startTime?: string;
    endTime?: string;
    placeId?: number;
    note?: string;
  }>;
}
```

**ä½¿ç”¨åœºæ™¯**:
- åº”ç”¨ä¼˜åŒ–ç»“æœæ—¶æ‰¹é‡æ›´æ–°
- æ‰¹é‡è°ƒæ•´æ—¶é—´

**ä¼˜å…ˆçº§**: P2

---

## 7. æ¥å£ä¼˜å…ˆçº§æ€»ç»“

### P0 - é«˜ä¼˜å…ˆçº§ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
1. âœ… `GET /trips/:id/conflicts` - å†²çªæ£€æµ‹
2. âœ… `PUT /trips/:id/intent` - ä¿å­˜æ„å›¾ä¸çº¦æŸ
3. âœ… `GET /trips/:id/intent` - è·å–æ„å›¾ä¸çº¦æŸ

### P1 - ä¸­ä¼˜å…ˆçº§ï¼ˆé‡è¦åŠŸèƒ½ï¼‰
4. âœ… `GET /trips/:id/days/:dayId/metrics` - æ¯æ—¥æŒ‡æ ‡
5. âœ… `GET /trips/:id/metrics` - æ‰¹é‡æŒ‡æ ‡
6. âœ… `POST /trips/:id/adjust` - æ‰©å±•æ”¯æŒ ADD_BUFFERS
7. âœ… `POST /trips/:id/apply-optimization` - åº”ç”¨ä¼˜åŒ–ç»“æœ

### P2 - ä½ä¼˜å…ˆçº§ï¼ˆå¢å¼ºåŠŸèƒ½ï¼‰
8. âœ… `GET /trips/:id/items/:itemId/detail` - è¯¦ç»†ä¿¡æ¯
9. âœ… `POST /trips/:id/items/batch-update` - æ‰¹é‡æ›´æ–°

---

## 8. æ³¨æ„äº‹é¡¹

1. **ç±»å‹æ‰©å±•**: éœ€è¦æ‰©å±• `ModificationType` æ”¯æŒ `ADD_BUFFERS`
2. **Metadata å­—æ®µ**: å¦‚æœä½¿ç”¨ metadata å­˜å‚¨é…ç½®ï¼Œéœ€è¦æ˜ç¡®å­—æ®µç»“æ„
3. **é”™è¯¯å¤„ç†**: æ‰€æœ‰æ¥å£éœ€è¦è¿”å›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
4. **æ€§èƒ½è€ƒè™‘**: æ‰¹é‡æ¥å£éœ€è¦è€ƒè™‘æ€§èƒ½ï¼Œå¯èƒ½éœ€è¦åˆ†é¡µæˆ–é™åˆ¶æ•°é‡
5. **æ•°æ®ä¸€è‡´æ€§**: æ›´æ–°æ“ä½œéœ€è¦è€ƒè™‘äº‹åŠ¡æ€§ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§

---

## 9. æ¥å£æµ‹è¯•å»ºè®®

1. **å•å…ƒæµ‹è¯•**: æ¯ä¸ªæ¥å£çš„è¯·æ±‚/å“åº”æ ¼å¼
2. **é›†æˆæµ‹è¯•**: ä¸å‰ç«¯äº¤äº’çš„å®Œæ•´æµç¨‹
3. **æ€§èƒ½æµ‹è¯•**: æ‰¹é‡æ“ä½œå’Œå¤§é‡æ•°æ®çš„å¤„ç†
4. **è¾¹ç•Œæµ‹è¯•**: ç©ºæ•°æ®ã€å¼‚å¸¸æ•°æ®ã€å¹¶å‘æ“ä½œç­‰

---

**æœ€åæ›´æ–°**: 2025-01-XX  
**è”ç³»äºº**: å‰ç«¯å¼€å‘å›¢é˜Ÿ

