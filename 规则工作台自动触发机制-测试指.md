# 规划工作台自动触发机制 - 测试指南

**版本**: 1.0  
**创建时间**: 2025-01-XX  
**测试范围**: 规划工作台所有 Tab 的自动触发机制

---

## 📋 测试概述

本文档提供详细的测试步骤，用于验证规划工作台中所有用户操作是否正确触发 LangGraph Orchestrator，以及三人格是否自动执行检查和调整。

---

## 🔧 测试前准备

### 1. 环境检查

- [ ] 确保后端服务正常运行（`BACKEND_HOST=10.107.189.126`）
- [ ] 确保前端开发服务器运行（`npm run dev` 或 `pnpm dev`）
- [ ] 确保已登录用户账户
- [ ] 确保至少有一个测试行程（Trip）

### 2. 浏览器开发者工具设置

- [ ] 打开浏览器开发者工具（F12）
- [ ] 切换到 **Network（网络）** 标签
- [ ] 切换到 **Console（控制台）** 标签
- [ ] 启用 **Preserve log（保留日志）**

### 3. 关键接口监控

在 Network 标签中，过滤以下接口：
- `POST /agent/route_and_run` - LangGraph Orchestrator 入口
- `GET /trips/:id/persona-alerts` - 获取人格提醒
- `GET /trips/:id/metrics` - 获取指标
- `GET /trips/:id/decision-log` - 获取决策日志

---

## 🧪 测试用例

### 测试用例 1: PlacesTab - 添加地点自动触发

**目标**: 验证添加地点时是否自动触发 LangGraph Orchestrator

**步骤**:
1. 打开规划工作台页面
2. 切换到 **Places（地点）** Tab
3. 搜索一个地点（例如："埃菲尔铁塔"）
4. 点击地点卡片上的 **"添加到行程"** 按钮
5. 在对话框中选择日期
6. 点击 **"确认添加"** 按钮

**预期结果**:
- ✅ 地点成功添加到行程
- ✅ Network 标签中出现 `POST /agent/route_and_run` 请求
- ✅ Console 中显示 Orchestrator 执行日志
- ✅ 显示 Toast 提示：
  - "系统已自动检查，发现 X 条提醒"（如果有提醒）
  - "系统已自动调整 X 项"（如果有调整）
  - 显示系统解释（如果有）

**验证点**:
- [ ] 请求参数包含正确的 `tripId`、`userId`、`message`
- [ ] 请求返回成功（status 200）
- [ ] 响应中包含 `personaAlerts`、`autoAdjustments`、`explanation`
- [ ] PlanStudioSidebar 中的提醒卡片更新

---

### 测试用例 2: ScheduleTab - 删除操作自动触发

**目标**: 验证删除行程项时是否自动触发 LangGraph Orchestrator

**步骤**:
1. 切换到 **Schedule（日程）** Tab
2. 在时间轴上找到一个行程项
3. 点击行程项右侧的 **"更多"** 按钮（三个点）
4. 选择 **"删除"**
5. 在确认对话框中点击 **"确认删除"**

**预期结果**:
- ✅ 行程项成功删除
- ✅ Network 标签中出现 `POST /agent/route_and_run` 请求
- ✅ 请求的 `message` 包含 "从行程中移除地点"
- ✅ 显示 Toast 提示（如果有自动检查结果）

**验证点**:
- [ ] 请求参数正确
- [ ] 响应处理正确
- [ ] 侧边栏提醒更新

---

### 测试用例 3: ScheduleTab - 替换操作自动触发

**目标**: 验证替换行程项时是否自动触发 LangGraph Orchestrator

**步骤**:
1. 在 **Schedule（日程）** Tab 中
2. 点击行程项右侧的 **"更多"** 按钮
3. 选择 **"替换"**
4. 在替换对话框中选择新地点
5. 点击 **"确认替换"**

**预期结果**:
- ✅ 行程项成功替换
- ✅ Network 标签中出现 `POST /agent/route_and_run` 请求
- ✅ 请求的 `message` 包含 "修改行程日程"
- ✅ 显示自动检查结果

**验证点**:
- [ ] 替换操作成功
- [ ] Orchestrator 正确调用
- [ ] 自动调整结果正确显示

---

### 测试用例 4: ScheduleTab - 移动操作自动触发

**目标**: 验证移动行程项时是否自动触发 LangGraph Orchestrator

**步骤**:
1. 在 **Schedule（日程）** Tab 中
2. 点击行程项右侧的 **"更多"** 按钮
3. 选择 **"移动"**
4. 在移动对话框中选择新日期和时间
5. 点击 **"确认移动"**

**预期结果**:
- ✅ 行程项成功移动
- ✅ Network 标签中出现 `POST /agent/route_and_run` 请求
- ✅ 请求的 `message` 包含 "修改行程日程"
- ✅ 显示自动检查结果

**验证点**:
- [ ] 移动操作成功
- [ ] Orchestrator 正确调用
- [ ] 自动调整结果正确显示

---

### 测试用例 5: ScheduleTab - 编辑操作自动触发

**目标**: 验证编辑行程项时是否自动触发 LangGraph Orchestrator

**步骤**:
1. 在 **Schedule（日程）** Tab 中
2. 点击行程项右侧的 **"更多"** 按钮
3. 选择 **"编辑"**
4. 在编辑对话框中修改时间或其他信息
5. 点击 **"保存"**

**预期结果**:
- ✅ 行程项成功更新
- ✅ Network 标签中出现 `POST /agent/route_and_run` 请求
- ✅ 请求的 `message` 包含 "修改行程日程"
- ✅ 显示自动检查结果

**验证点**:
- [ ] 编辑操作成功
- [ ] Orchestrator 正确调用
- [ ] 自动调整结果正确显示

---

### 测试用例 6: IntentTab - 配置保存自动触发

**目标**: 验证保存配置时是否自动触发 LangGraph Orchestrator

**步骤**:
1. 切换到 **Intent（意图）** Tab
2. 修改以下任一配置：
   - 节奏（轻松/标准/紧凑）
   - 偏好（自然/城市/摄影等）
   - 每日步行限制
   - 必须地点
   - 避免地点
   - 预算
   - 规划策略
3. 点击 **"保存"** 按钮

**预期结果**:
- ✅ 配置成功保存
- ✅ Network 标签中出现 `POST /agent/route_and_run` 请求
- ✅ 请求的 `message` 包含 "修改行程日程"
- ✅ 显示自动检查结果

**验证点**:
- [ ] 配置保存成功
- [ ] Orchestrator 正确调用
- [ ] 自动调整结果正确显示

---

### 测试用例 7: OptimizeTab - 优化操作自动触发

**目标**: 验证优化操作时是否自动触发 LangGraph Orchestrator

**步骤**:
1. 切换到 **Optimize（优化）** Tab
2. 确保行程中至少有一个地点
3. 点击 **"运行优化"** 按钮

**预期结果**:
- ✅ 优化操作成功执行
- ✅ Network 标签中出现 `POST /agent/route_and_run` 请求
- ✅ 请求的 `message` 包含 "优化行程路线"
- ✅ 显示优化结果和自动检查结果

**验证点**:
- [ ] 优化操作成功
- [ ] Orchestrator 正确调用
- [ ] 自动调整结果正确显示

---

## 🔍 调试技巧

### 1. 检查 Network 请求

在浏览器开发者工具的 Network 标签中：

1. **过滤请求**: 输入 `route_and_run` 过滤相关请求
2. **查看请求详情**:
   - 点击请求，查看 **Headers** 标签
   - 查看 **Payload** 标签，确认请求参数正确
3. **查看响应**:
   - 切换到 **Response** 标签
   - 确认响应结构包含 `result`、`explain`、`route` 等字段

### 2. 检查 Console 日志

在浏览器开发者工具的 Console 标签中：

- 查找 `Orchestrator execution` 相关日志
- 查找错误信息（如果有）
- 查找 Toast 提示的触发日志

### 3. 检查 PlanStudioSidebar

在规划工作台右侧栏中：

1. **策略概览卡片**: 检查是否显示所有人格的数据（Abu、Dr.Dre、Neptune）
2. **人格提醒卡片**: 检查是否显示所有人格的提醒
3. **筛选器**: 测试筛选功能是否正常工作

### 4. 常见问题排查

**问题 1: 没有触发 Orchestrator**

- 检查用户是否已登录（`user` 是否存在）
- 检查 `tripId` 是否正确
- 检查 Console 是否有错误信息

**问题 2: Orchestrator 调用失败**

- 检查后端服务是否正常运行
- 检查 Network 请求的响应状态码
- 检查响应中的错误信息

**问题 3: 没有显示自动检查结果**

- 检查响应中是否包含 `personaAlerts`、`autoAdjustments`
- 检查 Toast 是否正确触发
- 检查 PlanStudioSidebar 是否正确更新

---

## 📊 测试检查清单

### 功能测试

- [ ] PlacesTab 添加地点自动触发 ✅
- [ ] ScheduleTab 删除操作自动触发 ✅
- [ ] ScheduleTab 替换操作自动触发 ✅
- [ ] ScheduleTab 移动操作自动触发 ✅
- [ ] ScheduleTab 编辑操作自动触发 ✅
- [ ] IntentTab 配置保存自动触发 ✅
- [ ] OptimizeTab 优化操作自动触发 ✅

### UI 测试

- [ ] PlanStudioSidebar 显示所有人格的数据（Abu、Dr.Dre、Neptune）
- [ ] PlanStudioSidebar 显示所有人格的提醒
- [ ] 提醒筛选功能正常工作
- [ ] Toast 提示正确显示
- [ ] 加载状态正确显示
- [ ] 错误状态正确处理

### 性能测试

- [ ] Orchestrator 调用响应时间 < 5秒
- [ ] 多个连续操作不会导致重复调用
- [ ] 侧边栏数据更新及时
- [ ] 没有内存泄漏

### 集成测试

- [ ] 所有 Tab 的操作都能正确触发 Orchestrator
- [ ] 侧边栏数据与操作结果一致
- [ ] 错误处理机制正常工作
- [ ] 网络错误时显示友好提示

---

## 📝 测试报告模板

### 测试环境

- **测试日期**: YYYY-MM-DD
- **测试人员**: [姓名]
- **浏览器**: Chrome/Firefox/Safari [版本]
- **后端版本**: [版本号]
- **前端版本**: [版本号]

### 测试结果汇总

| 测试用例 | 状态 | 备注 |
|---------|------|------|
| PlacesTab 添加地点 | ✅/❌ | |
| ScheduleTab 删除操作 | ✅/❌ | |
| ScheduleTab 替换操作 | ✅/❌ | |
| ScheduleTab 移动操作 | ✅/❌ | |
| ScheduleTab 编辑操作 | ✅/❌ | |
| IntentTab 配置保存 | ✅/❌ | |
| OptimizeTab 优化操作 | ✅/❌ | |

### 发现的问题

#### 问题 1: [问题标题]

- **严重程度**: 高/中/低
- **描述**: [详细描述]
- **复现步骤**: 
  1. [步骤1]
  2. [步骤2]
- **预期结果**: [预期]
- **实际结果**: [实际]
- **截图**: [如有]

#### 问题 2: [问题标题]

...

### 测试结论

- **通过率**: X/Y (Z%)
- **主要问题**: [列出主要问题]
- **建议**: [改进建议]

---

## 🔗 相关文档

- [规划工作台信息架构图](./规划工作台-信息架构图.md)
- [三人格定位文档](./三人格定位文档.md)
- [API 文档](./API文档.md)

---

## 📞 联系方式

如有问题或建议，请联系：
- **开发团队**: [联系方式]
- **测试团队**: [联系方式]

---

## 📌 附录

### 附录 A: Orchestrator 请求示例

#### 添加地点请求

```json
{
  "tripId": "trip_123",
  "userId": "user_456",
  "message": "用户添加了地点：埃菲尔铁塔",
  "params": {
    "action": "add_place",
    "placeId": "place_789",
    "date": "2025-01-15"
  }
}
```

#### 修改日程请求

```json
{
  "tripId": "trip_123",
  "userId": "user_456",
  "message": "用户修改了行程日程",
  "params": {
    "action": "modify_schedule",
    "itemId": "item_101",
    "changes": {
      "startTime": "2025-01-15T10:00:00Z"
    }
  }
}
```

#### 优化路线请求

```json
{
  "tripId": "trip_123",
  "userId": "user_456",
  "message": "用户请求优化行程路线",
  "params": {
    "action": "optimize_route",
    "optimizationType": "distance"
  }
}
```

### 附录 B: Orchestrator 响应示例

```json
{
  "result": {
    "personaAlerts": [
      {
        "persona": "abu",
        "type": "safety",
        "severity": "warning",
        "message": "检测到潜在安全风险",
        "itemId": "item_101"
      }
    ],
    "autoAdjustments": [
      {
        "type": "time_adjustment",
        "itemId": "item_101",
        "oldValue": "2025-01-15T10:00:00Z",
        "newValue": "2025-01-15T11:00:00Z",
        "reason": "为安全考虑，调整了时间"
      }
    ],
    "explanation": "系统已自动检查并调整了行程，以确保安全性和合理性。"
  },
  "explain": "Abu 检测到潜在风险，Dr.Dre 调整了时间节奏，Neptune 提供了替代方案。",
  "route": {
    "items": [...]
  }
}
```

### 附录 C: 测试数据准备

#### 测试行程数据

建议准备以下测试场景：

1. **基础行程**: 3-5 个地点，简单路线
2. **复杂行程**: 10+ 个地点，多天行程
3. **边界情况**: 
   - 只有 1 个地点
   - 地点之间距离很远
   - 时间冲突的行程项

#### 测试地点数据

建议使用以下测试地点：

- **巴黎**: 埃菲尔铁塔、卢浮宫、凯旋门
- **东京**: 东京塔、浅草寺、新宿
- **纽约**: 自由女神像、中央公园、时代广场

### 附录 D: 快捷键参考

| 操作 | 快捷键 |
|------|--------|
| 打开开发者工具 | F12 |
| 刷新页面 | F5 / Ctrl+R |
| 清除控制台 | Ctrl+L |
| 搜索 Network | Ctrl+F |

---

**文档结束**

---

*最后更新: 2025-01-XX*  
*版本: 1.0*