# 行程详情页 - 接口对接检查报告

**检查时间**: 2025-01-XX  
**文件**: `src/pages/trips/[id].tsx`  
**状态**: 📊 分析完成

---

## 📋 目录

1. [已对接的接口](#已对接的接口)
2. [硬编码数据](#硬编码数据)
3. [接口测试验证方法](#接口测试验证方法)
4. [未对接的接口](#未对接的接口)
5. [优化建议](#优化建议)

---

## ✅ 已对接的接口

### 1. 核心行程数据

| 接口 | 方法 | 路径 | 状态 | 调用位置 |
|------|------|------|------|----------|
| 获取行程详情 | GET | `/trips/:id` | ✅ 已对接 | `loadTrip()` (行278) |
| 获取行程状态 | GET | `/trips/:id/state` | ✅ 已对接 | `loadTripState()` (行458) |
| 获取决策记录 | GET | `/trips/:id/decision-log` | ✅ 已对接 | `loadDecisionLogs()` (行73) |

### 2. 建议系统接口

| 接口 | 方法 | 路径 | 状态 | 调用位置 |
|------|------|------|------|----------|
| 获取建议列表 | GET | `/trips/:id/suggestions` | ✅ 已对接 | `loadSuggestions()` (行485) |
| 获取建议统计 | GET | `/trips/:id/suggestions/stats` | ✅ 已对接 | `loadSuggestions()` (行511) |
| 应用建议 | POST | `/trips/:id/suggestions/:suggestionId/apply` | ✅ 已对接 | `onActionClick` (行1129) |
| 忽略建议 | POST | `/trips/:id/suggestions/:suggestionId/dismiss` | ✅ 已对接 | `onActionClick` (行1121) |

### 3. 证据和冲突接口

| 接口 | 方法 | 路径 | 状态 | 调用位置 |
|------|------|------|------|----------|
| 获取证据列表 | GET | `/trips/:id/evidence` | ✅ 已对接 | `loadEvidence()` (行470) |
| 获取冲突列表 | GET | `/trips/:id/conflicts` | ✅ 已对接 | `loadConflicts()` (行564) |

### 4. 指标接口

| 接口 | 方法 | 路径 | 状态 | 调用位置 |
|------|------|------|------|----------|
| 获取行程指标 | GET | `/trips/:id/metrics` | ✅ 已对接 | `loadTripMetrics()` (行524) |
| 获取每日指标 | GET | `/trips/:id/days/:dayId/metrics` | ✅ 已对接 | `loadDayMetrics()` (行548) |

### 5. 社交功能接口

| 接口 | 方法 | 路径 | 状态 | 调用位置 |
|------|------|------|------|----------|
| 获取收藏列表 | GET | `/trips/collected` | ✅ 已对接 | `checkCollectionStatus()` (行396) |
| 收藏行程 | POST | `/trips/:id/collect` | ✅ 已对接 | `handleCollect()` (行426) |
| 取消收藏 | POST | `/trips/:id/uncollect` | ✅ 已对接 | `handleCollect()` (行423) |
| 点赞行程 | POST | `/trips/:id/like` | ✅ 已对接 | `handleLike()` (行446) |
| 取消点赞 | POST | `/trips/:id/unlike` | ✅ 已对接 | `handleLike()` (行442) |

### 6. 其他接口

| 接口 | 方法 | 路径 | 状态 | 调用位置 |
|------|------|------|------|----------|
| 获取国家列表 | GET | `/countries` | ✅ 已对接 | `loadCountryInfo()` (行348) |

---

## ⚠️ 硬编码数据

### 1. 视图组件中的硬编码

#### AbuView (`src/components/trips/views/AbuView.tsx`)

**硬编码数据**:
- `gatingStatus`: 'ALLOW' | 'WARN' | 'BLOCK' = 'WARN' (行46)
- `violations`: RiskViolation[] (行47-71)
  - 夜间徒步风险
  - 缓冲时间不足
- `riskMap`: RiskMap (行73-77)
  - item-1: LOW 风险
  - item-2: HIGH 风险
  - item-3: MEDIUM 风险

**应该对接的接口**:
- ❌ `GET /trips/:id/risk-assessment` - 获取风险评估
- ❌ `GET /trips/:id/violations` - 获取违规列表
- ❌ `GET /trips/:id/items/:itemId/risk` - 获取单项风险

#### DrDreView (`src/components/trips/views/DrDreView.tsx`)

**硬编码数据**:
- `metrics`: Metrics (行66-73)
  - timeTotal: 1440 (24小时)
  - bufferTotal: 180 (3小时)
  - fatigueScore: 65
  - ascent: 1200
  - costEstimate: 5000
  - reliability: 85
- `metricsByItem`: MetricsByItem (行75-96)
  - 每个 item 的指标都是硬编码

**应该对接的接口**:
- ⚠️ `GET /trips/:id/metrics` - 已对接，但视图组件未使用
- ❌ `GET /trips/:id/items/:itemId/metrics` - 获取单项指标
- ❌ `POST /trips/:id/optimize` - 优化行程（候选方案生成）

#### NeptuneView (`src/components/trips/views/NeptuneView.tsx`)

**硬编码数据**:
- `repairs`: Repair[] (行67-117)
  - repair-1: 替换路线
  - repair-2: 添加缓冲
- `alternatives`: { [itemId: string]: Alternative[] } (行119-136)
  - item-2 的替代方案

**应该对接的接口**:
- ❌ `GET /trips/:id/repairs` - 获取修复建议
- ❌ `GET /trips/:id/items/:itemId/alternatives` - 获取替代方案
- ❌ `POST /trips/:id/repairs/:repairId/apply` - 应用修复

#### AutoView (`src/components/trips/views/AutoView.tsx`)

**硬编码数据**:
- `overallMetrics` (行41-48)
  - safetyScore: 75
  - rhythmScore: 80
  - readinessScore: 85
  - criticalIssues: 2
  - warnings: 3
  - suggestions: 5
- 关键问题列表 (行127-145)
  - 夜间徒步风险
  - 缓冲时间不足

**应该对接的接口**:
- ⚠️ `GET /trips/:id/suggestions/stats` - 已对接，但未在 AutoView 中使用
- ❌ `GET /trips/:id/overall-metrics` - 获取综合指标
- ❌ `GET /trips/:id/critical-issues` - 获取关键问题列表

### 2. 页面中的硬编码

**硬编码数据**:
- 货币符号映射 (行365-383)
  - 这是合理的硬编码，用于显示格式化
- 状态颜色映射 (行198-211)
  - 这是合理的硬编码，用于UI显示

---

## 🧪 接口测试验证方法

### 1. 核心行程数据接口

#### GET `/trips/:id`

**测试步骤**:
```bash
# 1. 使用浏览器开发者工具
# 打开 Network 标签页
# 访问行程详情页: http://localhost:5173/trips/{tripId}

# 2. 检查请求
# - 请求方法: GET
# - 请求URL: /api/trips/{tripId}
# - 状态码: 200

# 3. 验证响应数据
# - 检查 trip 对象是否包含所有必需字段
# - 检查 TripDay 数组是否正确
# - 检查 statistics 对象是否存在
```

**验证点**:
- [ ] 响应状态码为 200
- [ ] 返回的 trip 对象包含 id, name, destination 等字段
- [ ] TripDay 数组不为空
- [ ] statistics 对象包含所有统计字段

#### GET `/trips/:id/state`

**测试步骤**:
```bash
# 在浏览器控制台执行
const tripId = 'your-trip-id';
const response = await fetch(`/api/trips/${tripId}/state`);
const data = await response.json();
console.log('Trip State:', data);
```

**验证点**:
- [ ] 返回 state 对象
- [ ] 包含 undoStack, redoStack 等字段

### 2. 建议系统接口

#### GET `/trips/:id/suggestions`

**测试步骤**:
```javascript
// 在浏览器控制台执行
const tripId = 'your-trip-id';
const response = await fetch(`/api/trips/${tripId}/suggestions?status=new`);
const data = await response.json();
console.log('Suggestions:', data);

// 验证数据
console.log('Total:', data.total);
console.log('Items:', data.items.length);
data.items.forEach(s => {
  console.log(`- ${s.persona}: ${s.title} (${s.severity})`);
});
```

**验证点**:
- [ ] 返回 items 数组
- [ ] 每个 suggestion 包含 id, persona, severity, title 等字段
- [ ] 支持 status 参数过滤

#### GET `/trips/:id/suggestions/stats`

**测试步骤**:
```javascript
const tripId = 'your-trip-id';
const response = await fetch(`/api/trips/${tripId}/suggestions/stats`);
const data = await response.json();
console.log('Stats:', data);

// 验证统计
console.log('Abu total:', data.byPersona.abu.total);
console.log('Dr.Dre total:', data.byPersona.drdre.total);
console.log('Neptune total:', data.byPersona.neptune.total);
```

**验证点**:
- [ ] 返回 byPersona 对象
- [ ] 每个 persona 包含 total 和 bySeverity
- [ ] byScope 包含 trip, day, item 统计

#### POST `/trips/:id/suggestions/:suggestionId/apply`

**测试步骤**:
```javascript
const tripId = 'your-trip-id';
const suggestionId = 'your-suggestion-id';
const response = await fetch(`/api/trips/${tripId}/suggestions/${suggestionId}/apply`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    actionId: 'apply',
    preview: false
  })
});
const data = await response.json();
console.log('Apply result:', data);
```

**验证点**:
- [ ] 返回 success: true
- [ ] 包含 appliedChanges 数组
- [ ] 可能包含 triggeredSuggestions 数组

### 3. 证据和冲突接口

#### GET `/trips/:id/evidence`

**测试步骤**:
```javascript
const tripId = 'your-trip-id';
const response = await fetch(`/api/trips/${tripId}/evidence?limit=3&offset=0`);
const data = await response.json();
console.log('Evidence:', data);

// 验证数据
data.items.forEach(e => {
  console.log(`- ${e.type}: ${e.title} (Day ${e.day})`);
});
```

**验证点**:
- [ ] 返回 items 数组
- [ ] 支持 limit 和 offset 参数
- [ ] 每个 evidence 包含 type, title, description, day 等字段

#### GET `/trips/:id/conflicts`

**测试步骤**:
```javascript
const tripId = 'your-trip-id';
const response = await fetch(`/api/trips/${tripId}/conflicts`);
const data = await response.json();
console.log('Conflicts:', data);
```

**验证点**:
- [ ] 返回 conflicts 数组
- [ ] 每个 conflict 包含类型、描述等信息

### 4. 指标接口

#### GET `/trips/:id/metrics`

**测试步骤**:
```javascript
const tripId = 'your-trip-id';
const response = await fetch(`/api/trips/${tripId}/metrics`);
const data = await response.json();
console.log('Trip Metrics:', data);

// 验证指标
console.log('Fatigue:', data.fatigueScore);
console.log('Buffer:', data.bufferTotal);
```

**验证点**:
- [ ] 返回 metrics 对象
- [ ] 包含 fatigueScore, bufferTotal 等字段

#### GET `/trips/:id/days/:dayId/metrics`

**测试步骤**:
```javascript
const tripId = 'your-trip-id';
const dayId = 'your-day-id';
const response = await fetch(`/api/trips/${tripId}/days/${dayId}/metrics`);
const data = await response.json();
console.log('Day Metrics:', data);
```

**验证点**:
- [ ] 返回 day metrics 对象
- [ ] 包含该天的各项指标

### 5. 自动化测试脚本

创建测试文件: `test-trip-detail-apis.js`

```javascript
// 在浏览器控制台执行
async function testTripDetailAPIs(tripId) {
  const baseUrl = '/api/trips';
  const tests = [];
  
  // 测试1: 获取行程详情
  try {
    const res = await fetch(`${baseUrl}/${tripId}`);
    const data = await res.json();
    tests.push({ name: 'GET /trips/:id', success: !!data.data, data });
  } catch (e) {
    tests.push({ name: 'GET /trips/:id', success: false, error: e.message });
  }
  
  // 测试2: 获取建议列表
  try {
    const res = await fetch(`${baseUrl}/${tripId}/suggestions?status=new`);
    const data = await res.json();
    tests.push({ name: 'GET /trips/:id/suggestions', success: !!data.data, data });
  } catch (e) {
    tests.push({ name: 'GET /trips/:id/suggestions', success: false, error: e.message });
  }
  
  // 测试3: 获取建议统计
  try {
    const res = await fetch(`${baseUrl}/${tripId}/suggestions/stats`);
    const data = await res.json();
    tests.push({ name: 'GET /trips/:id/suggestions/stats', success: !!data.data, data });
  } catch (e) {
    tests.push({ name: 'GET /trips/:id/suggestions/stats', success: false, error: e.message });
  }
  
  // 测试4: 获取证据
  try {
    const res = await fetch(`${baseUrl}/${tripId}/evidence?limit=3`);
    const data = await res.json();
    tests.push({ name: 'GET /trips/:id/evidence', success: !!data.data, data });
  } catch (e) {
    tests.push({ name: 'GET /trips/:id/evidence', success: false, error: e.message });
  }
  
  // 测试5: 获取指标
  try {
    const res = await fetch(`${baseUrl}/${tripId}/metrics`);
    const data = await res.json();
    tests.push({ name: 'GET /trips/:id/metrics', success: !!data.data, data });
  } catch (e) {
    tests.push({ name: 'GET /trips/:id/metrics', success: false, error: e.message });
  }
  
  // 输出结果
  console.table(tests.map(t => ({
    '接口': t.name,
    '状态': t.success ? '✅ 成功' : '❌ 失败',
    '错误': t.error || '-'
  })));
  
  return tests;
}

// 使用示例
// testTripDetailAPIs('your-trip-id');
```

---

## ❌ 未对接的接口

### 1. 风险评估接口

| 接口 | 方法 | 路径 | 用途 | 优先级 |
|------|------|------|------|--------|
| 获取风险评估 | GET | `/trips/:id/risk-assessment` | 获取整体安全状态 | 🔴 高 |
| 获取违规列表 | GET | `/trips/:id/violations` | 获取所有违规项 | 🔴 高 |
| 获取单项风险 | GET | `/trips/:id/items/:itemId/risk` | 获取单个行程项的风险 | 🟡 中 |

### 2. 指标接口（视图组件未使用）

| 接口 | 方法 | 路径 | 用途 | 优先级 |
|------|------|------|------|--------|
| 获取单项指标 | GET | `/trips/:id/items/:itemId/metrics` | 获取单个行程项的指标 | 🟡 中 |
| 优化行程 | POST | `/trips/:id/optimize` | 生成优化候选方案 | 🟡 中 |

### 3. 修复建议接口

| 接口 | 方法 | 路径 | 用途 | 优先级 |
|------|------|------|------|--------|
| 获取修复建议 | GET | `/trips/:id/repairs` | 获取所有修复建议 | 🔴 高 |
| 获取替代方案 | GET | `/trips/:id/items/:itemId/alternatives` | 获取替代地点列表 | 🟡 中 |
| 应用修复 | POST | `/trips/:id/repairs/:repairId/apply` | 应用修复建议 | 🔴 高 |

### 4. 综合视图接口

| 接口 | 方法 | 路径 | 用途 | 优先级 |
|------|------|------|------|--------|
| 获取综合指标 | GET | `/trips/:id/overall-metrics` | 获取三人格综合评分 | 🟡 中 |
| 获取关键问题 | GET | `/trips/:id/critical-issues` | 获取关键问题摘要 | 🟡 中 |

---

## 💡 优化建议

### 1. 立即对接（高优先级）

1. **风险评估接口**
   - 对接 `GET /trips/:id/risk-assessment`
   - 替换 AbuView 中的硬编码 `gatingStatus`
   - 对接 `GET /trips/:id/violations`
   - 替换硬编码的 `violations` 数组

2. **修复建议接口**
   - 对接 `GET /trips/:id/repairs`
   - 替换 NeptuneView 中的硬编码 `repairs` 数组
   - 对接 `POST /trips/:id/repairs/:repairId/apply`

### 2. 中期对接（中优先级）

1. **指标接口使用**
   - 在 DrDreView 中使用已对接的 `GET /trips/:id/metrics`
   - 对接 `GET /trips/:id/items/:itemId/metrics` 用于单项指标

2. **综合视图接口**
   - 对接 `GET /trips/:id/overall-metrics`
   - 在 AutoView 中使用真实数据替换硬编码

### 3. 长期优化（低优先级）

1. **替代方案接口**
   - 对接 `GET /trips/:id/items/:itemId/alternatives`
   - 替换 NeptuneView 中的硬编码替代方案

2. **优化接口**
   - 对接 `POST /trips/:id/optimize`
   - 实现真实的候选方案生成

---

## 📊 统计总结

### 接口对接情况

- ✅ **已对接**: 15 个接口
- ❌ **未对接**: 11 个接口
- ⚠️ **已对接但未使用**: 2 个接口（metrics 相关）

### 硬编码情况

- 🔴 **严重硬编码**: 4 个视图组件（AbuView, DrDreView, NeptuneView, AutoView）
- 🟡 **合理硬编码**: 2 处（货币符号、状态颜色）

### 优先级分布

- 🔴 **高优先级**: 5 个接口（风险评估、修复建议）
- 🟡 **中优先级**: 5 个接口（指标、综合视图）
- 🟢 **低优先级**: 1 个接口（替代方案）

---

## 📝 下一步行动

1. **立即行动**:
   - [ ] 对接风险评估接口，替换 AbuView 硬编码
   - [ ] 对接修复建议接口，替换 NeptuneView 硬编码

2. **短期行动**:
   - [ ] 在视图组件中使用已对接的 metrics 接口
   - [ ] 对接综合指标接口，替换 AutoView 硬编码

3. **长期行动**:
   - [ ] 对接替代方案接口
   - [ ] 对接优化接口

---

**报告生成时间**: 2025-01-XX  
**维护者**: 前端团队

