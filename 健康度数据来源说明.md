# 健康度数据来源说明

## 概述

行程详情页的健康度指标（可执行度、缓冲、风险、成本）是基于多个 API 数据源计算得出的。

## 数据来源

### 1. 行程指标 API
- **接口**: `GET /trips/:id/metrics`
- **函数**: `loadTripMetrics()` (第 646-667 行)
- **状态变量**: `tripMetrics` (类型: `TripMetricsResponse`)
- **用途**: 提供缓冲时间、疲劳指数等基础指标

### 2. 冲突列表 API
- **接口**: `GET /trips/:id/conflicts`
- **函数**: `loadConflicts()` (第 686-698 行)
- **状态变量**: `conflicts` (类型: `ConflictsResponse`)
- **用途**: 提供时间冲突、高风险冲突等信息

### 3. 行程基本信息 API
- **接口**: `GET /trips/:id`
- **函数**: `loadTrip()` (第 317-367 行)
- **状态变量**: `trip` (类型: `TripDetail`)
- **用途**: 提供总天数、预算使用情况等

## 计算逻辑

健康度指标的计算在 `src/pages/trips/[id].tsx` 第 842-890 行：

```typescript
const healthMetrics = (() => {
  // 默认值（当 tripMetrics 不存在时使用）
  const defaultMetrics = {
    executable: 85,
    buffer: 70,
    risk: 25,
    cost: 80,
  };

  if (!tripMetrics) return defaultMetrics;

  const summary = tripMetrics.summary;
  const totalDays = trip?.statistics?.totalDays || trip?.TripDay?.length || 1;
  
  // 1. 可执行度 (executable)
  // 基于缓冲时间和疲劳指数
  const avgBufferPerDay = summary.totalBuffer / totalDays;
  const avgFatigue = summary.totalFatigue / totalDays;
  const executable = Math.min(100, Math.max(0, 
    (avgBufferPerDay / 60) * 20 +        // 缓冲时间（小时）* 20，最多20分
    (100 - avgFatigue) * 0.65            // 疲劳指数越低越好，最多65分
  ));

  // 2. 缓冲 (buffer)
  // 基于总缓冲时间，假设每天理想缓冲2小时（120分钟）
  const buffer = Math.min(100, Math.max(0, 
    (summary.totalBuffer / (totalDays * 120)) * 100
  ));

  // 3. 风险 (risk)
  // 基于冲突数量和高风险冲突
  const highRiskConflicts = conflicts?.conflicts?.filter(c => c.severity === 'HIGH').length || 0;
  const totalConflicts = conflicts?.total || 0;
  const risk = Math.min(100, Math.max(0, 
    (highRiskConflicts * 30) +           // 高风险冲突每个30分
    (totalConflicts * 5)                 // 总冲突每个5分
  ));

  // 4. 成本控制 (cost)
  // 基于预算使用情况，预算使用越少越好
  const budgetUsed = trip?.statistics?.budgetUsed || 0;
  const totalBudget = trip?.totalBudget || 1;
  const budgetRatio = budgetUsed / totalBudget;
  const cost = Math.min(100, Math.max(0, (1 - budgetRatio) * 100));

  return {
    executable: Math.round(executable),
    buffer: Math.round(buffer),
    risk: Math.round(risk),
    cost: Math.round(cost),
  };
})();
```

## 综合健康度计算

综合健康度（79%）在 `HealthBar` 组件中计算（第 28 行）：

```typescript
const overallHealth = Math.round(
  executable * 0.4 +        // 可执行度权重 40%
  buffer * 0.2 +            // 缓冲权重 20%
  (100 - risk) * 0.3 +      // 风险权重 30%（风险越低越好）
  cost * 0.1                // 成本权重 10%
);
```

## 数据加载时机

这些数据在页面加载时通过 `useEffect` 自动加载（第 313-377 行）：

```typescript
useEffect(() => {
  if (id) {
    loadTrip();
  }
}, [id]);

useEffect(() => {
  if (trip) {
    Promise.all([
      loadPersonaAlerts(),
      loadDecisionLogs(),
      loadTripMetrics(),      // 加载行程指标
      loadConflicts(),         // 加载冲突列表
      loadSuggestions(),
      loadEvidence(),
    ]).catch(console.error);
  }
}, [trip]);
```

## 默认值

如果 `tripMetrics` 不存在（API 调用失败或数据未加载），会使用以下默认值：

```typescript
{
  executable: 85,  // 可执行度 85%
  buffer: 70,      // 缓冲 70%
  risk: 25,        // 风险 25%
  cost: 80,        // 成本 80%
}
```

## 注意事项

1. **数据依赖**: 健康度计算依赖于 `tripMetrics`，如果该数据未加载，会使用默认值
2. **实时更新**: 当行程数据更新时（如调整时间、添加/删除行程项），需要重新调用 `loadTripMetrics()` 和 `loadConflicts()` 来更新健康度
3. **错误处理**: 所有 API 调用都有错误处理，失败时不会影响页面显示，但会使用默认值

