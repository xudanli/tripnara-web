# 行程管理模块完整接口文档

本文档包含行程管理模块（trips）的所有接口，用于前端对接。每个接口都包含详细的请求参数、响应格式和前端对接要点。

---

## 接口 1: 创建新行程

**接口地址**: `POST /trips`

**接口描述**: 创建新行程并自动计算节奏策略（木桶效应）和预算切分。系统会根据旅行者信息自动计算体力限制和地形限制，并根据预算推荐酒店档次。

**请求体**:

```json
{
  "destination": "JP",
  "startDate": "2024-05-01",
  "endDate": "2024-05-05",
  "totalBudget": 20000,
  "travelers": [
    {
      "type": "ADULT",
      "mobilityTag": "CITY_POTATO"
    },
    {
      "type": "ELDERLY",
      "mobilityTag": "ACTIVE_SENIOR"
    }
  ]
}
```

**参数说明**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `destination` | string | 是 | 目的地国家代码（ISO 3166-1 alpha-2），如：JP、IS、US、CN |
| `startDate` | string | 是 | 行程开始日期（ISO 8601格式：YYYY-MM-DD） |
| `endDate` | string | 是 | 行程结束日期（ISO 8601格式：YYYY-MM-DD） |
| `totalBudget` | number | 是 | 总预算（单位：人民币 CNY），最小值：0 |
| `travelers` | array | 是 | 旅行者列表 |

**旅行者类型 (type)**:

- `ADULT` - 成人
- `ELDERLY` - 老年人
- `CHILD` - 儿童

**行动能力标签 (mobilityTag)**:

- `IRON_LEGS` - 特种兵：体力充沛，可以高强度活动
- `ACTIVE_SENIOR` - 银发徒步：老年人但体力尚可，但地形受限
- `CITY_POTATO` - 城市脆皮：年轻人但体力一般，需要频繁休息
- `LIMITED` - 行动不便：需要轮椅或特殊设施

**响应示例**:

```json
{
  "success": true,
  "data": {
    "id": "f3626ff1-7a9b-46d9-8b8b-7f53a14583b1",
    "destination": "JP",
    "startDate": "2024-05-01",
    "endDate": "2024-05-05",
    "totalBudget": 20000,
    "status": "PLANNING",
    "createdAt": "2024-04-01T10:00:00.000Z",
    "updatedAt": "2024-04-01T10:00:00.000Z",
    "pacingConfig": {
      "travelers": [
        {
          "type": "ADULT",
          "mobilityTag": "CITY_POTATO"
        }
      ],
      "maxDailyActivities": 4,
      "restIntervalHours": 2
    },
    "budgetConfig": {
      "totalBudget": 20000,
      "currency": "CNY",
      "dailyBudget": 4000
    }
  }
}
```

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "startDate 必须是有效的日期字符串 (ISO 8601)"
  }
}
```

**前端对接要点**:

1. **表单验证**: 
   - 日期格式必须为 YYYY-MM-DD
   - 结束日期必须晚于开始日期
   - 预算必须大于等于 0
   - 至少需要一个旅行者

2. **用户体验**:
   - 创建成功后跳转到行程详情页
   - 显示创建成功提示
   - 保存行程 ID 用于后续操作

3. **错误处理**:
   - 显示具体的验证错误信息
   - 提供友好的错误提示

**TypeScript 类型定义**:

```typescript
interface CreateTripRequest {
  destination: string;
  startDate: string;
  endDate: string;
  totalBudget: number;
  travelers: Array<{
    type: 'ADULT' | 'ELDERLY' | 'CHILD';
    mobilityTag: 'IRON_LEGS' | 'ACTIVE_SENIOR' | 'CITY_POTATO' | 'LIMITED';
  }>;
}

interface CreateTripResponse {
  id: string;
  destination: string;
  startDate: string;
  endDate: string;
  totalBudget: number;
  status: string;
  createdAt: string;
  updatedAt: string;
  pacingConfig: any;
  budgetConfig: any;
}
```

---

## 接口 2: 获取所有行程

**接口地址**: `GET /trips`

**接口描述**: 返回当前用户的所有行程列表，包含每个行程的基本信息和关联的 TripDay。用于行程列表页面展示。

**请求参数**: 无

**响应示例**:

```json
{
  "success": true,
  "data": [
    {
      "id": "f3626ff1-7a9b-46d9-8b8b-7f53a14583b1",
      "destination": "JP",
      "startDate": "2024-05-01",
      "endDate": "2024-05-05",
      "status": "PLANNING",
      "totalBudget": 20000,
      "createdAt": "2024-04-01T10:00:00.000Z",
      "days": [
        {
          "id": "day-1",
          "date": "2024-05-01"
        },
        {
          "id": "day-2",
          "date": "2024-05-02"
        }
      ]
    },
    {
      "id": "a1234567-89ab-cdef-0123-456789abcdef",
      "destination": "IS",
      "startDate": "2024-06-01",
      "endDate": "2024-06-10",
      "status": "IN_PROGRESS",
      "totalBudget": 30000,
      "createdAt": "2024-05-01T10:00:00.000Z",
      "days": []
    }
  ]
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `data` | array | 行程列表 |
| `data[].id` | string | 行程 ID |
| `data[].destination` | string | 目的地国家代码 |
| `data[].startDate` | string | 开始日期 |
| `data[].endDate` | string | 结束日期 |
| `data[].status` | string | 行程状态：`PLANNING`（规划中）、`IN_PROGRESS`（进行中）、`COMPLETED`（已完成）、`CANCELLED`（已取消） |
| `data[].totalBudget` | number | 总预算 |
| `data[].createdAt` | string | 创建时间 |
| `data[].days` | array | 行程天数列表 |

**前端对接要点**:

1. **列表展示**:
   - 按创建时间或开始日期排序
   - 显示行程状态标签（不同颜色）
   - 显示目的地、日期范围、预算等关键信息

2. **状态标识**:
   - `PLANNING` - 规划中（蓝色）
   - `IN_PROGRESS` - 进行中（绿色）
   - `COMPLETED` - 已完成（灰色）
   - `CANCELLED` - 已取消（红色）

3. **交互设计**:
   - 点击行程卡片跳转到详情页
   - 提供快速操作按钮（编辑、删除、分享等）
   - 支持筛选和搜索功能

4. **空状态**:
   - 如果没有行程，显示友好的空状态提示
   - 提供"创建新行程"的引导按钮

**TypeScript 类型定义**:

```typescript
interface TripListItem {
  id: string;
  destination: string;
  startDate: string;
  endDate: string;
  status: 'PLANNING' | 'IN_PROGRESS' | 'COMPLETED' | 'CANCELLED';
  totalBudget: number;
  createdAt: string;
  days: Array<{
    id: string;
    date: string;
  }>;
}

type GetAllTripsResponse = TripListItem[];
```

---

## 接口 3: 自然语言创建行程

**接口地址**: `POST /trips/from-natural-language`

**接口描述**: 使用自然语言描述创建行程，大模型会自动解析需求并转换为接口参数。例如："帮我规划带娃去东京5天的行程，预算2万"。如果信息不足，系统会返回澄清问题。

**请求体**:

```json
{
  "text": "帮我规划带娃去东京5天的行程，预算2万",
  "llmProvider": "DEEPSEEK"
}
```

**参数说明**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `text` | string | 是 | 自然语言输入，描述行程需求 |
| `llmProvider` | string | 否 | LLM提供商，可选值：`DEEPSEEK`、`OPENAI`、`ANTHROPIC` 等 |

**响应示例（成功创建）**:

```json
{
  "success": true,
  "data": {
    "trip": {
      "id": "f3626ff1-7a9b-46d9-8b8b-7f53a14583b1",
      "destination": "JP",
      "startDate": "2024-05-01",
      "endDate": "2024-05-05",
      "totalBudget": 20000,
      "status": "PLANNING"
    },
    "parsedParams": {
      "destination": "JP",
      "startDate": "2024-05-01",
      "endDate": "2024-05-05",
      "totalBudget": 20000,
      "hasChildren": true,
      "hasElderly": false
    }
  }
}
```

**响应示例（需要澄清）**:

```json
{
  "success": true,
  "data": {
    "needsClarification": true,
    "clarificationQuestions": [
      "请确认具体的目的地城市？",
      "请确认具体的出行日期？",
      "请确认预算金额？"
    ],
    "partialParams": {
      "destination": "JP",
      "hasChildren": true
    }
  }
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `trip` | object | 创建的行程对象（成功时返回） |
| `parsedParams` | object | 解析出的参数（成功时返回） |
| `needsClarification` | boolean | 是否需要澄清（需要澄清时为 true） |
| `clarificationQuestions` | array | 澄清问题列表（需要澄清时返回） |
| `partialParams` | object | 部分解析出的参数（需要澄清时返回） |

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "BUSINESS_ERROR",
    "message": "处理您的请求时遇到了问题。请检查输入参数是否正确。",
    "details": {
      "clarificationQuestions": ["请提供更详细的行程信息"],
      "suggestedActions": ["重试", "使用标准创建行程接口"]
    }
  }
}
```

**前端对接要点**:

1. **输入提示**:
   - 提供示例文本，帮助用户理解如何描述需求
   - 支持多轮对话，根据澄清问题继续完善信息

2. **澄清处理**:
   - 如果返回 `needsClarification: true`，显示澄清问题列表
   - 允许用户回答澄清问题后重新提交
   - 可以显示已解析的部分参数，让用户确认

3. **加载状态**:
   - LLM 解析可能需要几秒钟，显示加载动画
   - 可以显示"正在理解您的需求..."等提示

4. **错误处理**:
   - 如果 LLM 解析失败，提供友好的错误提示
   - 建议用户使用标准创建行程接口
   - 可以保存用户的输入，方便重试

5. **成功处理**:
   - 创建成功后跳转到行程详情页
   - 显示解析出的参数，让用户确认是否正确

**使用场景**:

- 快速创建行程，无需填写复杂表单
- 语音输入创建行程
- 从聊天记录中提取行程需求

**TypeScript 类型定义**:

```typescript
interface CreateTripFromNLRequest {
  text: string;
  llmProvider?: 'DEEPSEEK' | 'OPENAI' | 'ANTHROPIC';
}

interface CreateTripFromNLResponse {
  trip?: {
    id: string;
    destination: string;
    startDate: string;
    endDate: string;
    totalBudget: number;
    status: string;
  };
  parsedParams?: {
    destination: string;
    startDate: string;
    endDate: string;
    totalBudget: number;
    hasChildren?: boolean;
    hasElderly?: boolean;
  };
  needsClarification?: boolean;
  clarificationQuestions?: string[];
  partialParams?: any;
}
```

---

## 接口 4: 获取单个行程详情（全景视图）

**接口地址**: `GET /trips/:id`

**接口描述**: 根据行程 ID 获取完整的行程树形结构，包括所有 TripDay（按日期排序）、每个 Day 下的所有 ItineraryItem（按时间排序）、每个 Item 关联的 Place 详情，以及统计信息（总天数、总活动数、行程状态等）。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 行程 ID (UUID) |

**请求参数**: 无

**响应示例**:

```json
{
  "success": true,
  "data": {
    "id": "f3626ff1-7a9b-46d9-8b8b-7f53a14583b1",
    "destination": "JP",
    "startDate": "2024-05-01",
    "endDate": "2024-05-05",
    "totalBudget": 20000,
    "status": "PLANNING",
    "createdAt": "2024-04-01T10:00:00.000Z",
    "updatedAt": "2024-04-01T10:00:00.000Z",
    "TripDay": [
      {
        "id": "day-1",
        "date": "2024-05-01",
        "ItineraryItem": [
          {
            "id": "item-1",
            "type": "ACTIVITY",
            "startTime": "2024-05-01T09:00:00.000Z",
            "endTime": "2024-05-01T11:00:00.000Z",
            "note": "参观东京塔",
            "Place": {
              "id": "place-1",
              "nameCN": "东京塔",
              "nameEN": "Tokyo Tower",
              "category": "ATTRACTION",
              "address": "4 Chome-2-8 Shibakoen, Minato City, Tokyo",
              "rating": 4.5,
              "metadata": {
                "cost": 1000,
                "duration": 120
              }
            }
          },
          {
            "id": "item-2",
            "type": "MEAL_ANCHOR",
            "startTime": "2024-05-01T12:00:00.000Z",
            "endTime": "2024-05-01T13:30:00.000Z",
            "note": "午餐",
            "Place": {
              "id": "place-2",
              "nameCN": "浅草寺附近餐厅",
              "nameEN": "Restaurant near Senso-ji",
              "category": "RESTAURANT",
              "address": "1 Chome-2-3 Asakusa, Taito City, Tokyo",
              "rating": 4.2
            }
          }
        ]
      },
      {
        "id": "day-2",
        "date": "2024-05-02",
        "ItineraryItem": []
      }
    ],
    "statistics": {
      "totalDays": 5,
      "totalItems": 25,
      "totalActivities": 15,
      "totalMeals": 8,
      "totalRest": 2,
      "totalTransit": 0,
      "progress": "PLANNING",
      "budgetUsed": 0,
      "budgetRemaining": 20000
    }
  }
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | string | 行程 ID |
| `destination` | string | 目的地国家代码 |
| `startDate` | string | 开始日期 |
| `endDate` | string | 结束日期 |
| `totalBudget` | number | 总预算 |
| `status` | string | 行程状态 |
| `TripDay` | array | 行程天数列表（按日期排序） |
| `TripDay[].id` | string | 天数 ID |
| `TripDay[].date` | string | 日期 |
| `TripDay[].ItineraryItem` | array | 行程项列表（按时间排序） |
| `TripDay[].ItineraryItem[].id` | string | 行程项 ID |
| `TripDay[].ItineraryItem[].type` | string | 行程项类型：`ACTIVITY`、`MEAL_ANCHOR`、`MEAL_FLOATING`、`REST`、`TRANSIT` |
| `TripDay[].ItineraryItem[].startTime` | string | 开始时间（ISO 8601） |
| `TripDay[].ItineraryItem[].endTime` | string | 结束时间（ISO 8601） |
| `TripDay[].ItineraryItem[].note` | string | 备注 |
| `TripDay[].ItineraryItem[].Place` | object | 关联的地点信息（可选） |
| `statistics` | object | 统计信息 |
| `statistics.totalDays` | number | 总天数 |
| `statistics.totalItems` | number | 总行程项数 |
| `statistics.totalActivities` | number | 总活动数 |
| `statistics.totalMeals` | number | 总用餐数 |
| `statistics.progress` | string | 进度状态：`PLANNING`、`ONGOING`、`COMPLETED` |

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "行程 ID f3626ff1-7a9b-46d9-8b8b-7f53a14583b1 不存在"
  }
}
```

**前端对接要点**:

1. **数据展示**:
   - 使用时间轴或日历视图展示行程
   - 按日期分组显示，每天内的活动按时间排序
   - 显示地点信息（名称、地址、评分等）

2. **交互设计**:
   - 支持展开/折叠每天的行程
   - 点击行程项可查看详情或编辑
   - 支持拖拽调整行程项顺序

3. **统计信息**:
   - 在页面顶部或侧边栏显示统计信息
   - 使用进度条显示行程完成度
   - 显示预算使用情况

4. **空状态处理**:
   - 如果某天没有行程项，显示"暂无安排"
   - 提供快速添加活动的入口

5. **性能优化**:
   - 对于长行程，考虑虚拟滚动或分页加载
   - 缓存行程数据，减少重复请求

**使用场景**:

- 查看行程完整详情
- 编辑行程安排
- 分享行程给他人

**TypeScript 类型定义**:

```typescript
interface Place {
  id: string;
  nameCN: string;
  nameEN: string;
  category: string;
  address: string;
  rating: number;
  metadata?: any;
}

interface ItineraryItem {
  id: string;
  type: 'ACTIVITY' | 'MEAL_ANCHOR' | 'MEAL_FLOATING' | 'REST' | 'TRANSIT';
  startTime: string;
  endTime: string;
  note?: string;
  Place?: Place;
}

interface TripDay {
  id: string;
  date: string;
  ItineraryItem: ItineraryItem[];
}

interface TripDetail {
  id: string;
  destination: string;
  startDate: string;
  endDate: string;
  totalBudget: number;
  status: string;
  createdAt: string;
  updatedAt: string;
  TripDay: TripDay[];
  statistics: {
    totalDays: number;
    totalItems: number;
    totalActivities: number;
    totalMeals: number;
    totalRest: number;
    totalTransit: number;
    progress: 'PLANNING' | 'ONGOING' | 'COMPLETED';
    budgetUsed: number;
    budgetRemaining: number;
  };
}

type GetTripDetailResponse = TripDetail;
```

---

## 接口 5: 获取行程当前状态

**接口地址**: `GET /trips/:id/state`

**接口描述**: 返回行程的当前状态，包括当前日期、当前行程项、下一站信息等。用于语音问"下一站"和按钮操作，帮助用户了解当前在行程中的位置。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 行程 ID (UUID) |

**查询参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `now` | string | 否 | 当前时间（ISO 8601格式），如：`2024-05-01T10:30:00.000Z`。如果不提供，使用服务器当前时间 |

**请求示例**:

```
GET /trips/f3626ff1-7a9b-46d9-8b8b-7f53a14583b1/state
GET /trips/f3626ff1-7a9b-46d9-8b8b-7f53a14583b1/state?now=2024-05-01T10:30:00.000Z
```

**响应示例**:

```json
{
  "success": true,
  "data": {
    "currentDayId": "day-1",
    "currentItemId": "item-2",
    "nextStop": {
      "itemId": "item-3",
      "placeId": 123,
      "placeName": "浅草寺",
      "startTime": "2024-05-01T14:00:00.000Z",
      "estimatedArrivalTime": "2024-05-01T14:00:00.000Z"
    },
    "eta": "2024-05-01T14:00:00.000Z",
    "timezone": "Asia/Tokyo",
    "now": "2024-05-01T10:30:00.000Z"
  }
}
```

**响应示例（行程未开始）**:

```json
{
  "success": true,
  "data": {
    "currentDayId": null,
    "currentItemId": null,
    "nextStop": {
      "itemId": "item-1",
      "placeId": 456,
      "placeName": "东京塔",
      "startTime": "2024-05-01T09:00:00.000Z",
      "estimatedArrivalTime": "2024-05-01T09:00:00.000Z"
    },
    "eta": "2024-05-01T09:00:00.000Z",
    "timezone": "Asia/Tokyo",
    "now": "2024-05-01T08:00:00.000Z"
  }
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `currentDayId` | string \| null | 当前日期 ID，如果行程未开始或已结束则为 null |
| `currentItemId` | string \| null | 当前正在进行的行程项 ID，如果没有正在进行的项则为 null |
| `nextStop` | object \| null | 下一站信息，如果没有下一站则为 null |
| `nextStop.itemId` | string | 下一站行程项 ID |
| `nextStop.placeId` | number | 下一站地点 ID |
| `nextStop.placeName` | string | 下一站地点名称 |
| `nextStop.startTime` | string | 下一站开始时间（ISO 8601） |
| `nextStop.estimatedArrivalTime` | string | 预计到达时间（ISO 8601） |
| `eta` | string | 预计到达时间（ISO 8601），与 nextStop.estimatedArrivalTime 相同 |
| `timezone` | string | 时区，如：`Asia/Tokyo` |
| `now` | string | 当前时间（ISO 8601） |

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "行程 ID f3626ff1-7a9b-46d9-8b8b-7f53a14583b1 不存在"
  }
}
```

**前端对接要点**:

1. **实时更新**:
   - 建议每30秒或1分钟轮询一次，获取最新状态
   - 可以在用户打开行程详情页时开始轮询
   - 离开页面时停止轮询

2. **状态展示**:
   - 如果 `currentItemId` 不为 null，显示"当前正在进行：XXX"
   - 如果 `nextStop` 不为 null，显示"下一站：XXX，预计 XX:XX 到达"
   - 如果两者都为 null，显示"行程未开始"或"行程已结束"

3. **语音交互**:
   - 支持语音问"下一站"，直接读取 `nextStop.placeName`
   - 支持语音问"现在在哪"，读取当前项的地点名称

4. **时间处理**:
   - 注意时区转换，使用 `timezone` 字段
   - 计算距离下一站的时间差，显示倒计时

5. **空状态处理**:
   - 如果行程未开始，显示第一个行程项作为下一站
   - 如果行程已结束，显示友好的结束提示

**使用场景**:

- 语音助手查询"下一站"
- 行程进行中的实时状态展示
- 导航和提醒功能

**TypeScript 类型定义**:

```typescript
interface TripState {
  currentDayId: string | null;
  currentItemId: string | null;
  nextStop?: {
    itemId: string;
    placeId: number;
    placeName: string;
    startTime: string;
    estimatedArrivalTime?: string;
  };
  eta?: string;
  timezone: string;
  now: string;
}

type GetTripStateResponse = TripState;
```

---

## 接口 6: 获取指定日期的 Schedule

**接口地址**: `GET /trips/:id/schedule`

**接口描述**: 从数据库读取指定日期的 Schedule（DayScheduleResult 格式）。如果该日期没有 Schedule，返回 null。用于获取某一天的详细行程安排。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 行程 ID (UUID) |

**查询参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `date` | string | 是 | 日期（YYYY-MM-DD格式），如：`2024-05-01` |

**请求示例**:

```
GET /trips/f3626ff1-7a9b-46d9-8b8b-7f53a14583b1/schedule?date=2024-05-01
```

**响应示例（有 Schedule）**:

```json
{
  "success": true,
  "data": {
    "date": "2024-05-01",
    "schedule": {
      "items": [
        {
          "startTime": "09:00",
          "endTime": "11:00",
          "placeId": 123,
          "placeName": "东京塔",
          "type": "ACTIVITY",
          "metadata": {
            "cost": 1000,
            "duration": 120
          }
        },
        {
          "startTime": "12:00",
          "endTime": "13:30",
          "placeId": 456,
          "placeName": "浅草寺附近餐厅",
          "type": "MEAL_ANCHOR",
          "metadata": {}
        }
      ],
      "totalDuration": 270,
      "totalCost": 1000
    },
    "persisted": true
  }
}
```

**响应示例（无 Schedule）**:

```json
{
  "success": true,
  "data": {
    "date": "2024-05-01",
    "schedule": null,
    "persisted": false
  }
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `date` | string | 查询的日期（YYYY-MM-DD） |
| `schedule` | object \| null | 行程计划（DayScheduleResult 格式），如果没有则为 null |
| `schedule.items` | array | 行程项列表，按时间排序 |
| `schedule.items[].startTime` | string | 开始时间（HH:mm格式） |
| `schedule.items[].endTime` | string | 结束时间（HH:mm格式） |
| `schedule.items[].placeId` | number | 地点 ID |
| `schedule.items[].placeName` | string | 地点名称 |
| `schedule.items[].type` | string | 行程项类型：`ACTIVITY`、`MEAL_ANCHOR`、`MEAL_FLOATING`、`REST`、`TRANSIT` |
| `schedule.items[].metadata` | object | 元数据，可能包含 cost、duration 等信息 |
| `schedule.totalDuration` | number | 总时长（分钟） |
| `schedule.totalCost` | number | 总费用 |
| `persisted` | boolean | 是否已保存到数据库 |

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "行程 ID f3626ff1-7a9b-46d9-8b8b-7f53a14583b1 不存在"
  }
}
```

**前端对接要点**:

1. **日期选择**:
   - 提供日期选择器，让用户选择要查看的日期
   - 默认显示当前日期或行程的第一天

2. **空状态处理**:
   - 如果 `schedule` 为 null，显示"该日期暂无安排"
   - 提供"创建安排"或"生成行程"的按钮

3. **数据展示**:
   - 使用时间轴或列表展示当天的行程
   - 按时间顺序排列，显示开始和结束时间
   - 显示地点名称和类型图标

4. **编辑功能**:
   - 如果 `persisted` 为 true，表示已保存，可以编辑
   - 如果 `persisted` 为 false，表示是临时生成的，需要保存

5. **缓存策略**:
   - 可以缓存已获取的 Schedule，减少重复请求
   - 在保存 Schedule 后，更新缓存

**使用场景**:

- 查看某一天的详细行程安排
- 编辑当天的行程
- 生成新的行程安排

**TypeScript 类型定义**:

```typescript
interface ScheduleItem {
  startTime: string;
  endTime: string;
  placeId: number;
  placeName: string;
  type: 'ACTIVITY' | 'MEAL_ANCHOR' | 'MEAL_FLOATING' | 'REST' | 'TRANSIT';
  metadata?: any;
}

interface DayScheduleResult {
  items: ScheduleItem[];
  totalDuration?: number;
  totalCost?: number;
}

interface ScheduleResponse {
  date: string;
  schedule: DayScheduleResult | null;
  persisted: boolean;
}

type GetScheduleResponse = ScheduleResponse;
```

---

## 接口 7: 保存指定日期的 Schedule

**接口地址**: `PUT /trips/:id/schedule`

**接口描述**: 将 Schedule（DayScheduleResult）保存到数据库，转换为 ItineraryItem。用于保存 apply-action、what-if apply 后的新 schedule。如果该日期不存在，会自动创建 TripDay。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 行程 ID (UUID) |

**查询参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `date` | string | 是 | 日期（YYYY-MM-DD格式），如：`2024-05-01` |

**请求体**:

```json
{
  "schedule": {
    "items": [
      {
        "startTime": "09:00",
        "endTime": "11:00",
        "placeId": 123,
        "placeName": "东京塔",
        "type": "ACTIVITY",
        "metadata": {
          "cost": 1000,
          "duration": 120
        }
      },
      {
        "startTime": "12:00",
        "endTime": "13:30",
        "placeId": 456,
        "placeName": "浅草寺附近餐厅",
        "type": "MEAL_ANCHOR",
        "metadata": {}
      }
    ],
    "totalDuration": 270,
    "totalCost": 1000
  }
}
```

**参数说明**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `schedule` | object | 是 | 行程计划（DayScheduleResult 格式） |
| `schedule.items` | array | 是 | 行程项列表 |
| `schedule.items[].startTime` | string | 是 | 开始时间（HH:mm格式） |
| `schedule.items[].endTime` | string | 是 | 结束时间（HH:mm格式） |
| `schedule.items[].placeId` | number | 是 | 地点 ID |
| `schedule.items[].placeName` | string | 是 | 地点名称 |
| `schedule.items[].type` | string | 是 | 行程项类型：`ACTIVITY`、`MEAL_ANCHOR`、`MEAL_FLOATING`、`REST`、`TRANSIT` |
| `schedule.items[].metadata` | object | 否 | 元数据，可包含 cost、duration 等信息 |

**响应示例**:

```json
{
  "success": true,
  "data": {
    "date": "2024-05-01",
    "schedule": {
      "items": [
        {
          "startTime": "09:00",
          "endTime": "11:00",
          "placeId": 123,
          "placeName": "东京塔",
          "type": "ACTIVITY",
          "metadata": {
            "cost": 1000,
            "duration": 120
          }
        },
        {
          "startTime": "12:00",
          "endTime": "13:30",
          "placeId": 456,
          "placeName": "浅草寺附近餐厅",
          "type": "MEAL_ANCHOR",
          "metadata": {}
        }
      ],
      "totalDuration": 270,
      "totalCost": 1000
    },
    "persisted": true
  }
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `date` | string | 保存的日期（YYYY-MM-DD） |
| `schedule` | object | 保存的行程计划 |
| `persisted` | boolean | 是否已保存到数据库（通常为 true） |

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "行程 ID f3626ff1-7a9b-46d9-8b8b-7f53a14583b1 不存在"
  }
}
```

**前端对接要点**:

1. **保存时机**:
   - 在用户完成编辑后调用此接口
   - 在应用 AI 建议后自动保存
   - 在 what-if 场景应用后保存

2. **数据验证**:
   - 确保时间格式正确（HH:mm）
   - 确保时间不冲突（开始时间 < 结束时间）
   - 验证 placeId 是否存在

3. **用户体验**:
   - 保存时显示加载状态
   - 保存成功后显示成功提示
   - 保存失败时显示错误信息，允许重试

4. **数据同步**:
   - 保存成功后，刷新当天的 Schedule 显示
   - 更新行程详情页的数据
   - 触发操作历史记录

5. **自动保存**:
   - 可以考虑实现自动保存功能（如每30秒保存一次）
   - 在用户离开页面时提示是否保存

**使用场景**:

- 保存编辑后的行程安排
- 应用 AI 生成的行程建议
- 保存 what-if 场景的结果

**TypeScript 类型定义**:

```typescript
interface SaveScheduleRequest {
  schedule: DayScheduleResult;
}

interface SaveScheduleResponse {
  date: string;
  schedule: DayScheduleResult;
  persisted: boolean;
}
```

---

## 接口 8: 获取操作历史

**接口地址**: `GET /trips/:id/actions`

**接口描述**: 获取行程的操作历史记录，支持按日期筛选。用于审计回放和撤销功能。系统会记录每次对行程的修改操作，包括操作前后的状态。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 行程 ID (UUID) |

**查询参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `date` | string | 否 | 日期（YYYY-MM-DD格式），如：`2024-05-01`。如果提供，只返回该日期的操作历史 |

**请求示例**:

```
GET /trips/f3626ff1-7a9b-46d9-8b8b-7f53a14583b1/actions
GET /trips/f3626ff1-7a9b-46d9-8b8b-7f53a14583b1/actions?date=2024-05-01
```

**响应示例**:

```json
{
  "success": true,
  "data": [
    {
      "id": "action-1",
      "tripId": "f3626ff1-7a9b-46d9-8b8b-7f53a14583b1",
      "dateISO": "2024-05-01",
      "actionType": "ADD_ACTIVITY",
      "action": {
        "type": "ADD_ACTIVITY",
        "params": {
          "placeId": 123,
          "startTime": "09:00",
          "endTime": "11:00"
        }
      },
      "scheduleBefore": {
        "items": []
      },
      "scheduleAfter": {
        "items": [
          {
            "startTime": "09:00",
            "endTime": "11:00",
            "placeId": 123,
            "placeName": "东京塔",
            "type": "ACTIVITY"
          }
        ]
      },
      "timestamp": "2024-05-01T10:00:00.000Z"
    },
    {
      "id": "action-2",
      "tripId": "f3626ff1-7a9b-46d9-8b8b-7f53a14583b1",
      "dateISO": "2024-05-01",
      "actionType": "REMOVE_ACTIVITY",
      "action": {
        "type": "REMOVE_ACTIVITY",
        "params": {
          "itemId": "item-1"
        }
      },
      "scheduleBefore": {
        "items": [
          {
            "startTime": "09:00",
            "endTime": "11:00",
            "placeId": 123,
            "placeName": "东京塔",
            "type": "ACTIVITY"
          }
        ]
      },
      "scheduleAfter": {
        "items": []
      },
      "timestamp": "2024-05-01T10:30:00.000Z"
    }
  ]
}
```

**空列表响应**:

```json
{
  "success": true,
  "data": []
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `data` | array | 操作历史列表（按时间倒序排列） |
| `data[].id` | string | 操作记录 ID |
| `data[].tripId` | string | 行程 ID |
| `data[].dateISO` | string | 操作日期（YYYY-MM-DD） |
| `data[].actionType` | string | 操作类型：`ADD_ACTIVITY`、`REMOVE_ACTIVITY`、`MOVE_ACTIVITY`、`UPDATE_ACTIVITY` 等 |
| `data[].action` | object | 操作详情，包含操作类型和参数 |
| `data[].scheduleBefore` | object | 操作前的 Schedule 状态 |
| `data[].scheduleAfter` | object | 操作后的 Schedule 状态 |
| `data[].timestamp` | string | 操作时间（ISO 8601格式） |

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "行程 ID f3626ff1-7a9b-46d9-8b8b-7f53a14583b1 不存在"
  }
}
```

**前端对接要点**:

1. **列表展示**:
   - 按时间倒序显示，最新的操作在最上方
   - 显示操作类型、时间和日期
   - 可以展开查看操作前后的详细对比

2. **操作类型标识**:
   - 使用不同图标或颜色区分不同操作类型
   - 显示操作描述（如："添加活动：东京塔"）

3. **日期筛选**:
   - 提供日期选择器，筛选特定日期的操作
   - 显示筛选结果数量

4. **撤销功能**:
   - 每个操作记录提供"撤销"按钮
   - 撤销时使用 `scheduleBefore` 恢复状态
   - 撤销后更新操作历史列表

5. **对比查看**:
   - 可以对比操作前后的 Schedule
   - 高亮显示变更的部分
   - 支持时间轴回放

6. **性能优化**:
   - 系统只保留最近 50 条历史记录
   - 对于大量历史，考虑分页加载

**使用场景**:

- 查看行程修改历史
- 撤销误操作
- 审计和回放操作
- 了解行程变更轨迹

**TypeScript 类型定义**:

```typescript
interface ActionHistory {
  id: string;
  tripId: string;
  dateISO: string;
  actionType: string;
  action: {
    type: string;
    params: any;
  };
  scheduleBefore: DayScheduleResult;
  scheduleAfter: DayScheduleResult;
  timestamp: string;
}

type GetActionHistoryResponse = ActionHistory[];
```

---

## 接口 9: 撤销操作

**接口地址**: `POST /trips/:id/actions/undo`

**接口描述**: 撤销最后一次操作，返回操作前的 Schedule。用于恢复误操作或取消最近的修改。系统会从操作历史中获取最后一次操作，并返回操作前的状态。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 行程 ID (UUID) |

**请求体**:

```json
{
  "date": "2024-05-01"
}
```

**参数说明**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `date` | string | 是 | 日期（YYYY-MM-DD格式），如：`2024-05-01` |

**响应示例（成功撤销）**:

```json
{
  "success": true,
  "data": {
    "schedule": {
      "items": [
        {
          "startTime": "09:00",
          "endTime": "11:00",
          "placeId": 123,
          "placeName": "东京塔",
          "type": "ACTIVITY",
          "metadata": {}
        }
      ],
      "totalDuration": 120,
      "totalCost": 1000
    }
  }
}
```

**响应示例（无操作可撤销）**:

```json
{
  "success": false,
  "error": {
    "code": "BUSINESS_ERROR",
    "message": "没有可撤销的操作"
  }
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `schedule` | object | 撤销后的 Schedule（操作前的状态） |
| `schedule.items` | array | 行程项列表 |
| `schedule.totalDuration` | number | 总时长（分钟） |
| `schedule.totalCost` | number | 总费用 |

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "行程 ID f3626ff1-7a9b-46d9-8b8b-7f53a14583b1 不存在"
  }
}
```

**前端对接要点**:

1. **撤销按钮**:
   - 在编辑页面提供"撤销"按钮
   - 按钮状态：如果有可撤销的操作则启用，否则禁用
   - 可以显示撤销次数或操作描述

2. **撤销流程**:
   - 调用撤销接口获取操作前的 Schedule
   - 将返回的 Schedule 应用到当前页面
   - 更新操作历史列表
   - 显示撤销成功提示

3. **状态同步**:
   - 撤销后需要调用保存接口保存新的状态
   - 或者提供"应用撤销"按钮，让用户确认后再保存

4. **多级撤销**:
   - 可以连续调用撤销接口，实现多级撤销
   - 建议限制撤销次数（如最多10次）
   - 显示当前可撤销的操作数量

5. **用户体验**:
   - 撤销前可以显示确认对话框
   - 撤销后显示操作描述（如："已撤销：添加活动"）
   - 提供重做功能，允许恢复撤销的操作

**使用场景**:

- 误操作后快速恢复
- 取消最近的修改
- 多级撤销历史操作

**TypeScript 类型定义**:

```typescript
interface UndoActionRequest {
  date: string;
}

interface UndoActionResponse {
  schedule: DayScheduleResult;
}
```

---

## 接口 10: 重做操作

**接口地址**: `POST /trips/:id/actions/redo`

**接口描述**: 重做最后一次撤销的操作，返回操作后的 Schedule。用于恢复被撤销的操作。系统会从操作历史中获取最后一次操作，并返回操作后的状态。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 行程 ID (UUID) |

**请求体**:

```json
{
  "date": "2024-05-01"
}
```

**参数说明**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `date` | string | 是 | 日期（YYYY-MM-DD格式），如：`2024-05-01` |

**响应示例（成功重做）**:

```json
{
  "success": true,
  "data": {
    "schedule": {
      "items": [
        {
          "startTime": "09:00",
          "endTime": "11:00",
          "placeId": 123,
          "placeName": "东京塔",
          "type": "ACTIVITY",
          "metadata": {}
        },
        {
          "startTime": "12:00",
          "endTime": "13:30",
          "placeId": 456,
          "placeName": "浅草寺附近餐厅",
          "type": "MEAL_ANCHOR",
          "metadata": {}
        }
      ],
      "totalDuration": 270,
      "totalCost": 1000
    }
  }
}
```

**响应示例（无操作可重做）**:

```json
{
  "success": false,
  "error": {
    "code": "BUSINESS_ERROR",
    "message": "没有可重做的操作"
  }
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `schedule` | object | 重做后的 Schedule（操作后的状态） |
| `schedule.items` | array | 行程项列表 |
| `schedule.totalDuration` | number | 总时长（分钟） |
| `schedule.totalCost` | number | 总费用 |

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "行程 ID f3626ff1-7a9b-46d9-8b8b-7f53a14583b1 不存在"
  }
}
```

**前端对接要点**:

1. **重做按钮**:
   - 在编辑页面提供"重做"按钮
   - 按钮状态：如果有可重做的操作则启用，否则禁用
   - 通常与撤销按钮一起显示

2. **重做流程**:
   - 调用重做接口获取操作后的 Schedule
   - 将返回的 Schedule 应用到当前页面
   - 更新操作历史列表
   - 显示重做成功提示

3. **状态同步**:
   - 重做后需要调用保存接口保存新的状态
   - 或者提供"应用重做"按钮，让用户确认后再保存

4. **撤销/重做栈**:
   - 维护撤销栈和重做栈
   - 执行新操作时清空重做栈
   - 撤销时推入重做栈，重做时推入撤销栈

5. **快捷键支持**:
   - 支持 Ctrl+Z（撤销）和 Ctrl+Y（重做）快捷键
   - 在按钮上显示快捷键提示

6. **用户体验**:
   - 重做后显示操作描述（如："已重做：添加活动"）
   - 提供操作历史查看，让用户了解可重做的操作

**使用场景**:

- 恢复被撤销的操作
- 在撤销和重做之间切换
- 快速测试不同的行程方案

**TypeScript 类型定义**:

```typescript
interface RedoActionRequest {
  date: string;
}

interface RedoActionResponse {
  schedule: DayScheduleResult;
}
```

---

## 接口 11: 生成行程分享链接

**接口地址**: `POST /trips/:id/share`

**接口描述**: 生成行程分享链接/二维码，设置查看/编辑权限。生成的分享链接可以通过分享令牌访问行程，支持设置过期时间和权限控制。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 行程 ID (UUID) |

**请求体**:

```json
{
  "permission": "VIEW",
  "expiresAt": "2024-12-31T23:59:59.000Z"
}
```

**参数说明**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `permission` | string | 否 | 分享权限，可选值：`VIEW`（查看）、`EDIT`（编辑）。默认为 `VIEW` |
| `expiresAt` | string | 否 | 过期时间（ISO 8601格式），如：`2024-12-31T23:59:59.000Z`。如果不提供，链接永久有效 |

**响应示例**:

```json
{
  "success": true,
  "data": {
    "id": "share-123",
    "tripId": "f3626ff1-7a9b-46d9-8b8b-7f53a14583b1",
    "shareToken": "550e8400-e29b-41d4-a716-446655440000",
    "permission": "VIEW",
    "expiresAt": "2024-12-31T23:59:59.000Z",
    "shareUrl": "/trips/shared/550e8400-e29b-41d4-a716-446655440000",
    "createdAt": "2024-05-01T10:00:00.000Z"
  }
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | string | 分享记录 ID |
| `tripId` | string | 行程 ID |
| `shareToken` | string | 分享令牌（UUID），用于访问分享的行程 |
| `permission` | string | 分享权限：`VIEW`（查看）、`EDIT`（编辑） |
| `expiresAt` | string \| null | 过期时间（ISO 8601格式），如果为 null 表示永久有效 |
| `shareUrl` | string | 分享链接（相对路径），需要拼接前端域名 |
| `createdAt` | string | 创建时间（ISO 8601格式） |

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "行程不存在: f3626ff1-7a9b-46d9-8b8b-7f53a14583b1"
  }
}
```

**前端对接要点**:

1. **分享功能**:
   - 在行程详情页提供"分享"按钮
   - 弹出分享设置对话框，让用户选择权限和过期时间
   - 生成分享链接后，显示完整的分享 URL

2. **分享链接处理**:
   - `shareUrl` 是相对路径，需要拼接前端域名
   - 完整 URL 格式：`https://yourdomain.com/trips/shared/{shareToken}`
   - 可以生成二维码，方便移动端分享

3. **权限设置**:
   - `VIEW`：只能查看行程，不能编辑
   - `EDIT`：可以查看和编辑行程
   - 根据权限在分享页面显示不同的操作按钮

4. **过期时间**:
   - 提供日期时间选择器设置过期时间
   - 显示过期倒计时
   - 过期后链接自动失效

5. **分享方式**:
   - 复制链接
   - 生成二维码
   - 直接分享到社交媒体
   - 通过邮件分享

6. **分享管理**:
   - 可以查看所有已生成的分享链接
   - 支持撤销分享（删除分享记录）
   - 显示分享统计（访问次数等）

**使用场景**:

- 分享行程给朋友
- 协作编辑行程
- 公开展示行程

**TypeScript 类型定义**:

```typescript
enum SharePermission {
  VIEW = 'VIEW',
  EDIT = 'EDIT',
}

interface CreateTripShareRequest {
  permission?: SharePermission;
  expiresAt?: string;
}

interface TripShareResponse {
  id: string;
  tripId: string;
  shareToken: string;
  permission: SharePermission;
  expiresAt: string | null;
  shareUrl: string;
  createdAt: string;
}
```

---

## 接口 12: 添加行程协作者

**接口地址**: `POST /trips/:id/collaborators`

**接口描述**: 通过邮箱添加行程协作者，设置查看/编辑权限。协作者可以通过自己的账号访问和编辑行程，实现多人协作。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 行程 ID (UUID) |

**请求体**:

```json
{
  "email": "user@example.com",
  "role": "EDITOR"
}
```

**参数说明**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `email` | string | 是 | 用户邮箱，要添加为协作者的用户邮箱地址 |
| `role` | string | 是 | 角色，可选值：`VIEWER`（查看者）、`EDITOR`（编辑者）、`OWNER`（所有者） |

**角色说明**:

- `VIEWER` - 查看者：只能查看行程，不能编辑
- `EDITOR` - 编辑者：可以查看和编辑行程
- `OWNER` - 所有者：拥有所有权限，包括删除行程、管理协作者等

**响应示例**:

```json
{
  "success": true,
  "data": {
    "id": "collab-123",
    "tripId": "f3626ff1-7a9b-46d9-8b8b-7f53a14583b1",
    "userId": "user-123",
    "role": "EDITOR",
    "createdAt": "2024-05-01T10:00:00.000Z"
  }
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | string | 协作者记录 ID |
| `tripId` | string | 行程 ID |
| `userId` | string | 用户 ID |
| `role` | string | 角色：`VIEWER`、`EDITOR`、`OWNER` |
| `createdAt` | string | 创建时间（ISO 8601格式） |

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "行程不存在: f3626ff1-7a9b-46d9-8b8b-7f53a14583b1"
  }
}
```

```json
{
  "success": false,
  "error": {
    "code": "BUSINESS_ERROR",
    "message": "该用户已经是协作者"
  }
}
```

**前端对接要点**:

1. **添加协作者**:
   - 在行程设置页面提供"添加协作者"功能
   - 通过输入用户邮箱地址添加协作者
   - 选择角色（VIEWER 或 EDITOR）

2. **邮箱输入**:
   - 提供邮箱输入框，支持输入用户邮箱地址
   - 系统会根据邮箱查找用户，如果用户不存在会返回错误
   - 如果用户已经是协作者，会返回相应提示

3. **权限控制**:
   - 只有行程所有者可以添加协作者
   - 根据当前用户角色显示不同的操作按钮
   - VIEWER 角色只能查看，EDITOR 可以编辑

4. **协作者列表**:
   - 显示所有协作者列表
   - 显示每个协作者的角色和添加时间
   - 提供移除协作者功能（仅所有者）

5. **通知功能**:
   - 添加协作者后，发送通知给被添加的用户
   - 通知内容包含行程信息和权限说明

6. **权限提示**:
   - 在行程页面显示当前用户的角色
   - 根据角色禁用或隐藏某些操作按钮
   - 显示权限说明

**使用场景**:

- 多人协作规划行程
- 分享行程给家人朋友
- 团队旅行规划

**TypeScript 类型定义**:

```typescript
enum CollaboratorRole {
  VIEWER = 'VIEWER',
  EDITOR = 'EDITOR',
  OWNER = 'OWNER',
}

interface AddCollaboratorRequest {
  email: string;
  role: CollaboratorRole;
}

interface CollaboratorResponse {
  id: string;
  tripId: string;
  userId: string;
  role: CollaboratorRole;
  createdAt: string;
}
```

---

## 接口 13: 获取协作者列表

**接口地址**: `GET /trips/:id/collaborators`

**接口描述**: 获取行程的所有协作者列表，包括协作者的用户ID、角色和添加时间。用于显示和管理行程的协作者。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 行程 ID (UUID) |

**请求参数**: 无

**响应示例**:

```json
{
  "success": true,
  "data": [
    {
      "id": "collab-1",
      "tripId": "f3626ff1-7a9b-46d9-8b8b-7f53a14583b1",
      "userId": "user-123",
      "role": "EDITOR",
      "createdAt": "2024-05-01T10:00:00.000Z"
    },
    {
      "id": "collab-2",
      "tripId": "f3626ff1-7a9b-46d9-8b8b-7f53a14583b1",
      "userId": "user-456",
      "role": "VIEWER",
      "createdAt": "2024-05-01T11:00:00.000Z"
    }
  ]
}
```

**空列表响应**:

```json
{
  "success": true,
  "data": []
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `data` | array | 协作者列表 |
| `data[].id` | string | 协作者记录 ID |
| `data[].tripId` | string | 行程 ID |
| `data[].userId` | string | 用户 ID |
| `data[].role` | string | 角色：`VIEWER`（查看者）、`EDITOR`（编辑者）、`OWNER`（所有者） |
| `data[].createdAt` | string | 创建时间（ISO 8601格式） |

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "行程不存在: f3626ff1-7a9b-46d9-8b8b-7f53a14583b1"
  }
}
```

**前端对接要点**:

1. **列表展示**:
   - 在行程设置页面显示协作者列表
   - 显示用户信息（头像、名称等，需要通过 userId 查询用户服务）
   - 显示角色标签（不同颜色区分）
   - 显示添加时间

2. **角色标识**:
   - `OWNER` - 所有者（金色/特殊标识）
   - `EDITOR` - 编辑者（蓝色）
   - `VIEWER` - 查看者（灰色）

3. **操作按钮**:
   - 只有 OWNER 可以移除其他协作者
   - 可以修改协作者角色（OWNER 除外）
   - 提供"添加协作者"按钮

4. **用户信息获取**:
   - 需要通过 userId 调用用户服务获取用户详细信息
   - 显示用户头像、名称、邮箱等
   - 处理用户不存在的情况

5. **权限提示**:
   - 显示当前用户的角色
   - 根据角色显示/隐藏操作按钮
   - 提示权限说明

6. **实时更新**:
   - 添加或移除协作者后，刷新列表
   - 可以轮询更新（如果支持实时通知）

**使用场景**:

- 查看行程的所有协作者
- 管理协作者权限
- 了解谁可以访问行程

**TypeScript 类型定义**:

```typescript
interface CollaboratorResponse {
  id: string;
  tripId: string;
  userId: string;
  role: CollaboratorRole;
  createdAt: string;
}

type GetCollaboratorsResponse = CollaboratorResponse[];
```

---

## 接口 14: 移除协作者

**接口地址**: `DELETE /trips/:id/collaborators/:userId`

**接口描述**: 移除行程的指定协作者。只有行程所有者可以移除其他协作者。移除后，该用户将无法再访问该行程。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 行程 ID (UUID) |
| `userId` | string | 是 | 要移除的用户 ID |

**请求参数**: 无

**请求示例**:

```
DELETE /trips/f3626ff1-7a9b-46d9-8b8b-7f53a14583b1/collaborators/user-123
```

**响应示例**:

```json
{
  "success": true,
  "data": {
    "success": true,
    "message": "协作者已移除"
  }
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `success` | boolean | 操作是否成功 |
| `message` | string | 操作结果消息 |

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "行程不存在: f3626ff1-7a9b-46d9-8b8b-7f53a14583b1"
  }
}
```

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "协作者不存在"
  }
}
```

**前端对接要点**:

1. **移除操作**:
   - 在协作者列表中，每个协作者提供"移除"按钮
   - 只有 OWNER 可以看到移除按钮
   - 不能移除 OWNER 自己

2. **确认对话框**:
   - 点击移除前显示确认对话框
   - 提示移除后该用户将无法访问行程
   - 提供"确认"和"取消"选项

3. **移除后处理**:
   - 移除成功后，从列表中删除该协作者
   - 显示成功提示
   - 刷新协作者列表

4. **权限检查**:
   - 前端检查当前用户是否为 OWNER
   - 如果不是 OWNER，隐藏移除按钮
   - 后端也会进行权限验证

5. **错误处理**:
   - 如果协作者不存在，显示友好提示
   - 如果权限不足，显示权限错误提示
   - 提供重试机制

6. **通知功能**:
   - 移除协作者后，可以发送通知给被移除的用户
   - 通知内容包含行程信息和移除原因

**使用场景**:

- 移除不再需要协作的用户
- 撤销之前的协作者邀请
- 管理行程访问权限

**TypeScript 类型定义**:

```typescript
interface RemoveCollaboratorResponse {
  success: boolean;
  message: string;
}
```

---

## 接口 15: 收藏行程

**接口地址**: `POST /trips/:id/collect`

**接口描述**: 收藏行程，用于后续参考。用户可以将感兴趣的行程收藏起来，方便以后查看和使用。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 行程 ID (UUID) |

**请求参数**: 无

**响应示例**:

```json
{
  "success": true,
  "data": {
    "success": true,
    "message": "行程已收藏",
    "tripId": "f3626ff1-7a9b-46d9-8b8b-7f53a14583b1",
    "userId": "user-123",
    "collectedAt": "2024-05-01T10:00:00.000Z"
  }
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `success` | boolean | 操作是否成功 |
| `message` | string | 操作结果消息 |
| `tripId` | string | 行程 ID |
| `userId` | string | 用户 ID |
| `collectedAt` | string | 收藏时间（ISO 8601格式） |

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "行程不存在: f3626ff1-7a9b-46d9-8b8b-7f53a14583b1"
  }
}
```

```json
{
  "success": false,
  "error": {
    "code": "BUSINESS_ERROR",
    "message": "行程已被收藏"
  }
}
```

**前端对接要点**:

1. **收藏按钮**:
   - 在行程详情页和列表页提供收藏按钮
   - 按钮状态：已收藏显示实心图标，未收藏显示空心图标
   - 点击后切换状态

2. **收藏反馈**:
   - 收藏成功后显示成功提示
   - 更新按钮状态为已收藏
   - 可以显示收藏数量

3. **重复收藏处理**:
   - 如果行程已被收藏，可以显示提示或直接忽略
   - 或者提供"取消收藏"选项

4. **收藏列表**:
   - 提供"我的收藏"页面，显示所有收藏的行程
   - 支持取消收藏操作
   - 可以按时间、目的地等排序

5. **用户体验**:
   - 收藏操作应该是即时的，不需要等待
   - 可以添加动画效果（如心形动画）
   - 支持批量收藏功能

**使用场景**:

- 收藏感兴趣的行程模板
- 保存参考行程
- 创建个人行程库

**TypeScript 类型定义**:

```typescript
interface CollectTripResponse {
  success: boolean;
  message: string;
  tripId: string;
  userId: string;
  collectedAt: string;
}
```

---

## 接口 16: 取消收藏行程

**接口地址**: `DELETE /trips/:id/collect`

**接口描述**: 取消收藏行程。用户可以从收藏列表中移除不再需要的行程。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 行程 ID (UUID) |

**请求参数**: 无

**响应示例**:

```json
{
  "success": true,
  "data": {
    "success": true,
    "message": "已取消收藏",
    "tripId": "f3626ff1-7a9b-46d9-8b8b-7f53a14583b1",
    "userId": "user-123"
  }
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `success` | boolean | 操作是否成功 |
| `message` | string | 操作结果消息 |
| `tripId` | string | 行程 ID |
| `userId` | string | 用户 ID |

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "INTERNAL_ERROR",
    "message": "取消收藏失败"
  }
}
```

**前端对接要点**:

1. **取消收藏按钮**:
   - 在已收藏的行程上显示"取消收藏"按钮
   - 或者在收藏列表中提供删除/取消收藏操作
   - 按钮状态更新为未收藏

2. **取消收藏反馈**:
   - 取消收藏成功后显示提示
   - 更新按钮状态为未收藏
   - 从收藏列表中移除该行程

3. **确认操作**:
   - 可以添加确认对话框，防止误操作
   - 或者使用撤销功能，允许恢复

4. **批量操作**:
   - 在收藏列表页面支持批量取消收藏
   - 提供"全选"和"取消全选"功能

5. **用户体验**:
   - 取消收藏操作应该是即时的
   - 可以添加淡出动画效果
   - 支持撤销操作（短时间内可以恢复）

6. **状态同步**:
   - 取消收藏后，更新所有相关页面的收藏状态
   - 如果当前在收藏列表页，移除该条目

**使用场景**:

- 从收藏列表中移除行程
- 清理不再需要的收藏
- 管理个人行程库

**TypeScript 类型定义**:

```typescript
interface UncollectTripResponse {
  success: boolean;
  message: string;
  tripId: string;
  userId: string;
}
```

---

## 接口 17: 获取用户收藏的行程列表

**接口地址**: `GET /trips/collected`

**接口描述**: 获取当前用户收藏的所有行程列表。返回用户收藏的行程详情，按收藏时间倒序排列。

**请求参数**: 无

**响应示例**:

```json
{
  "success": true,
  "data": [
    {
      "id": "collection-1",
      "trip": {
        "id": "f3626ff1-7a9b-46d9-8b8b-7f53a14583b1",
        "destination": "JP",
        "startDate": "2024-05-01",
        "endDate": "2024-05-05",
        "totalBudget": 20000,
        "status": "PLANNING",
        "TripDay": [
          {
            "id": "day-1",
            "date": "2024-05-01"
          }
        ]
      },
      "createdAt": "2024-05-01T10:00:00.000Z"
    },
    {
      "id": "collection-2",
      "trip": {
        "id": "a1234567-89ab-cdef-0123-456789abcdef",
        "destination": "IS",
        "startDate": "2024-06-01",
        "endDate": "2024-06-10",
        "totalBudget": 30000,
        "status": "PLANNING",
        "TripDay": []
      },
      "createdAt": "2024-04-30T15:00:00.000Z"
    }
  ]
}
```

**空列表响应**:

```json
{
  "success": true,
  "data": []
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `data` | array | 收藏列表（按收藏时间倒序排列） |
| `data[].id` | string | 收藏记录 ID |
| `data[].trip` | object | 行程详情，包含行程基本信息和 TripDay 列表 |
| `data[].trip.id` | string | 行程 ID |
| `data[].trip.destination` | string | 目的地国家代码 |
| `data[].trip.startDate` | string | 开始日期 |
| `data[].trip.endDate` | string | 结束日期 |
| `data[].trip.totalBudget` | number | 总预算 |
| `data[].trip.status` | string | 行程状态 |
| `data[].trip.TripDay` | array | 行程天数列表 |
| `data[].createdAt` | string | 收藏时间（ISO 8601格式） |

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "INTERNAL_ERROR",
    "message": "获取收藏列表失败"
  }
}
```

**前端对接要点**:

1. **列表展示**:
   - 创建"我的收藏"页面，展示所有收藏的行程
   - 使用卡片或列表形式展示行程信息
   - 显示收藏时间，帮助用户回忆

2. **行程信息**:
   - 显示行程的关键信息：目的地、日期、预算、状态
   - 可以点击卡片跳转到行程详情页
   - 显示行程天数统计

3. **操作功能**:
   - 每个行程卡片提供"取消收藏"按钮
   - 支持批量取消收藏
   - 提供"查看详情"、"复制行程"等快捷操作

4. **排序和筛选**:
   - 默认按收藏时间倒序排列（最新的在前）
   - 可以按目的地、日期、预算等排序
   - 支持搜索功能，快速找到特定行程

5. **空状态处理**:
   - 如果没有收藏，显示友好的空状态提示
   - 提供"去发现行程"的引导按钮
   - 可以推荐热门行程

6. **分页加载**:
   - 如果收藏数量较多，支持分页或无限滚动
   - 每次加载一定数量的行程（如20条）

**使用场景**:

- 查看个人收藏的行程
- 管理收藏列表
- 快速访问参考行程

**TypeScript 类型定义**:

```typescript
interface CollectedTrip {
  id: string;
  trip: {
    id: string;
    destination: string;
    startDate: string;
    endDate: string;
    totalBudget: number;
    status: string;
    TripDay: Array<{
      id: string;
      date: string;
    }>;
  };
  createdAt: string;
}

type GetCollectedTripsResponse = CollectedTrip[];
```

---

## 接口 18: 点赞行程

**接口地址**: `POST /trips/:id/like`

**接口描述**: 点赞行程，用于热门行程推荐。用户可以为喜欢的行程点赞，系统会根据点赞数推荐热门行程。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 行程 ID (UUID) |

**请求参数**: 无

**响应示例**:

```json
{
  "success": true,
  "data": {
    "success": true,
    "message": "点赞成功",
    "tripId": "f3626ff1-7a9b-46d9-8b8b-7f53a14583b1",
    "userId": "user-123"
  }
}
```

**响应示例（已点赞）**:

```json
{
  "success": true,
  "data": {
    "success": true,
    "message": "已点赞",
    "tripId": "f3626ff1-7a9b-46d9-8b8b-7f53a14583b1",
    "userId": "user-123"
  }
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `success` | boolean | 操作是否成功 |
| `message` | string | 操作结果消息 |
| `tripId` | string | 行程 ID |
| `userId` | string | 用户 ID |

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "行程不存在: f3626ff1-7a9b-46d9-8b8b-7f53a14583b1"
  }
}
```

**前端对接要点**:

1. **点赞按钮**:
   - 在行程详情页和列表页提供点赞按钮
   - 按钮状态：已点赞显示实心图标，未点赞显示空心图标
   - 显示点赞数量

2. **点赞反馈**:
   - 点赞成功后显示成功提示
   - 更新按钮状态为已点赞
   - 更新点赞数量（+1）
   - 可以添加点赞动画效果

3. **重复点赞处理**:
   - 如果行程已被点赞，返回"已点赞"消息
   - 前端可以忽略或显示提示
   - 按钮状态保持为已点赞

4. **点赞数量**:
   - 实时显示点赞数量
   - 点赞后立即更新数量
   - 可以从行程详情接口获取最新数量

5. **用户体验**:
   - 点赞操作应该是即时的，不需要等待
   - 可以添加点赞动画（如心形动画）
   - 支持双击点赞（类似社交平台）

6. **热门推荐**:
   - 点赞数高的行程会出现在热门推荐中
   - 可以在热门推荐页面展示点赞数
   - 支持按点赞数排序

**使用场景**:

- 为喜欢的行程点赞
- 支持优质行程内容
- 参与热门行程推荐

**TypeScript 类型定义**:

```typescript
interface LikeTripResponse {
  success: boolean;
  message: string;
  tripId: string;
  userId: string;
}
```

---

## 接口 19: 取消点赞行程

**接口地址**: `DELETE /trips/:id/like`

**接口描述**: 取消点赞行程。用户可以从已点赞的行程中移除点赞，系统会更新点赞数和热门推荐。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 行程 ID (UUID) |

**请求参数**: 无

**响应示例**:

```json
{
  "success": true,
  "data": {
    "success": true,
    "message": "已取消点赞",
    "tripId": "f3626ff1-7a9b-46d9-8b8b-7f53a14583b1",
    "userId": "user-123"
  }
}
```

**响应示例（未点赞）**:

```json
{
  "success": true,
  "data": {
    "success": true,
    "message": "未点赞",
    "tripId": "f3626ff1-7a9b-46d9-8b8b-7f53a14583b1",
    "userId": "user-123"
  }
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `success` | boolean | 操作是否成功 |
| `message` | string | 操作结果消息 |
| `tripId` | string | 行程 ID |
| `userId` | string | 用户 ID |

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "INTERNAL_ERROR",
    "message": "取消点赞失败"
  }
}
```

**前端对接要点**:

1. **取消点赞按钮**:
   - 在已点赞的行程上显示"取消点赞"按钮
   - 按钮状态更新为未点赞（空心图标）
   - 更新点赞数量（-1）

2. **取消点赞反馈**:
   - 取消点赞成功后显示提示
   - 更新按钮状态为未点赞
   - 更新点赞数量

3. **重复操作处理**:
   - 如果行程未点赞，返回"未点赞"消息
   - 前端可以忽略或显示提示
   - 按钮状态保持为未点赞

4. **状态同步**:
   - 取消点赞后，更新所有相关页面的点赞状态
   - 如果当前在热门推荐页，更新列表中的点赞数

5. **用户体验**:
   - 取消点赞操作应该是即时的
   - 可以添加淡出动画效果
   - 支持撤销操作（短时间内可以恢复点赞）

6. **热门推荐影响**:
   - 取消点赞后，行程的热度分数会降低
   - 可能从热门推荐列表中移除
   - 实时更新热门推荐列表

**使用场景**:

- 取消误点的赞
- 改变对行程的评价
- 管理个人点赞列表

**TypeScript 类型定义**:

```typescript
interface UnlikeTripResponse {
  success: boolean;
  message: string;
  tripId: string;
  userId: string;
}
```

---

## 接口 20: 获取热门推荐行程

**接口地址**: `GET /trips/featured`

**接口描述**: 根据点赞数和收藏数获取热门推荐行程列表。系统会计算每个行程的热度分数（点赞数 + 收藏数 × 2），按分数从高到低排序返回。

**查询参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `limit` | number | 否 | 返回数量限制，默认值为 10，最大建议不超过 50 |

**请求示例**:

```
GET /trips/featured
GET /trips/featured?limit=20
```

**响应示例**:

```json
{
  "success": true,
  "data": [
    {
      "id": "f3626ff1-7a9b-46d9-8b8b-7f53a14583b1",
      "destination": "JP",
      "startDate": "2024-05-01",
      "endDate": "2024-05-05",
      "totalBudget": 20000,
      "status": "PLANNING",
      "createdAt": "2024-04-01T10:00:00.000Z",
      "likeCount": 25,
      "collectionCount": 15,
      "popularityScore": 55,
      "TripLike": [],
      "TripCollection": []
    },
    {
      "id": "a1234567-89ab-cdef-0123-456789abcdef",
      "destination": "IS",
      "startDate": "2024-06-01",
      "endDate": "2024-06-10",
      "totalBudget": 30000,
      "status": "PLANNING",
      "createdAt": "2024-03-15T10:00:00.000Z",
      "likeCount": 18,
      "collectionCount": 12,
      "popularityScore": 42,
      "TripLike": [],
      "TripCollection": []
    }
  ]
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `data` | array | 热门行程列表（按热度分数降序排列） |
| `data[].id` | string | 行程 ID |
| `data[].destination` | string | 目的地国家代码 |
| `data[].startDate` | string | 开始日期 |
| `data[].endDate` | string | 结束日期 |
| `data[].totalBudget` | number | 总预算 |
| `data[].status` | string | 行程状态 |
| `data[].createdAt` | string | 创建时间 |
| `data[].likeCount` | number | 点赞数 |
| `data[].collectionCount` | number | 收藏数 |
| `data[].popularityScore` | number | 热度分数（点赞数 + 收藏数 × 2） |

**空列表响应**:

```json
{
  "success": true,
  "data": []
}
```

**前端对接要点**:

1. **热门推荐页面**:
   - 创建"热门推荐"或"发现"页面
   - 使用卡片或网格布局展示热门行程
   - 突出显示热度分数、点赞数和收藏数

2. **热度展示**:
   - 显示热度分数，可以用星级或进度条表示
   - 显示点赞数和收藏数
   - 可以添加"热门"标签

3. **排序选项**:
   - 默认按热度分数排序
   - 可以按点赞数、收藏数、创建时间等排序
   - 提供筛选功能（按目的地、预算等）

4. **交互功能**:
   - 点击行程卡片跳转到详情页
   - 提供点赞和收藏按钮
   - 支持分享功能

5. **实时更新**:
   - 定期刷新热门推荐列表（如每5分钟）
   - 点赞或收藏后，更新对应行程的热度分数
   - 如果分数变化，重新排序列表

6. **分页加载**:
   - 支持分页或无限滚动
   - 每次加载一定数量的行程
   - 显示加载状态

7. **空状态处理**:
   - 如果没有热门行程，显示友好提示
   - 可以推荐其他类型的行程

**使用场景**:

- 发现优质行程模板
- 浏览热门行程
- 寻找旅行灵感

**TypeScript 类型定义**:

```typescript
interface FeaturedTrip {
  id: string;
  destination: string;
  startDate: string;
  endDate: string;
  totalBudget: number;
  status: string;
  createdAt: string;
  likeCount: number;
  collectionCount: number;
  popularityScore: number;
  TripLike: any[];
  TripCollection: any[];
}

type GetFeaturedTripsResponse = FeaturedTrip[];
```

---

## 接口 21: 导出行程离线数据包

**接口地址**: `GET /trips/:id/offline-pack`

**接口描述**: 导出行程离线数据包（包含地点详情、路线、Schedule），用于离线查看和编辑。系统会将行程的所有相关信息打包，包括行程基本信息、每日行程安排、地点详情等，并保存为离线数据包版本。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 行程 ID (UUID) |

**请求参数**: 无

**响应示例**:

```json
{
  "success": true,
  "data": {
    "tripId": "f3626ff1-7a9b-46d9-8b8b-7f53a14583b1",
    "version": 3,
    "data": {
      "trip": {
        "id": "f3626ff1-7a9b-46d9-8b8b-7f53a14583b1",
        "destination": "JP",
        "startDate": "2024-05-01",
        "endDate": "2024-05-05",
        "budgetConfig": {
          "totalBudget": 20000,
          "currency": "CNY"
        },
        "pacingConfig": {
          "level": "MODERATE"
        }
      },
      "days": [
        {
          "id": "day-1",
          "date": "2024-05-01",
          "items": [
            {
              "id": "item-1",
              "type": "ATTRACTION",
              "startTime": "09:00",
              "endTime": "12:00",
              "place": {
                "id": "place-1",
                "nameCN": "东京塔",
                "nameEN": "Tokyo Tower",
                "category": "ATTRACTION",
                "address": "4 Chome-2-8 Shibakoen, Minato City, Tokyo 105-0011, Japan",
                "metadata": {}
              },
              "note": "参观东京塔"
            }
          ]
        }
      ],
      "exportedAt": "2024-04-15T10:30:00.000Z"
    },
    "createdAt": "2024-04-10T08:00:00.000Z",
    "updatedAt": "2024-04-15T10:30:00.000Z"
  }
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `tripId` | string | 行程 ID |
| `version` | number | 离线数据包版本号（每次导出递增） |
| `data` | object | 离线数据包内容 |
| `data.trip` | object | 行程基本信息 |
| `data.trip.id` | string | 行程 ID |
| `data.trip.destination` | string | 目的地国家代码 |
| `data.trip.startDate` | string | 开始日期 |
| `data.trip.endDate` | string | 结束日期 |
| `data.trip.budgetConfig` | object | 预算配置 |
| `data.trip.pacingConfig` | object | 节奏配置 |
| `data.days` | array | 每日行程安排 |
| `data.days[].id` | string | 日期 ID |
| `data.days[].date` | string | 日期 |
| `data.days[].items` | array | 当日行程项 |
| `data.days[].items[].id` | string | 行程项 ID |
| `data.days[].items[].type` | string | 行程项类型 |
| `data.days[].items[].startTime` | string | 开始时间 |
| `data.days[].items[].endTime` | string | 结束时间 |
| `data.days[].items[].place` | object\|null | 地点信息 |
| `data.days[].items[].note` | string | 备注 |
| `data.exportedAt` | string | 导出时间 |
| `createdAt` | string | 数据包创建时间 |
| `updatedAt` | string | 数据包更新时间 |

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "行程不存在: f3626ff1-7a9b-46d9-8b8b-7f53a14583b1"
  }
}
```

**前端对接要点**:

1. **离线数据包导出**:
   - 在行程详情页提供"导出离线包"按钮
   - 显示导出进度（加载状态）
   - 导出成功后提示用户

2. **数据存储**:
   - 将离线数据包保存到本地存储（如 IndexedDB、LocalStorage）
   - 使用 `tripId` 作为存储键
   - 保存版本号，用于后续同步

3. **离线查看**:
   - 检测网络状态，离线时自动切换到离线模式
   - 从本地存储加载离线数据包
   - 显示离线标识（如"离线模式"标签）

4. **离线编辑**:
   - 支持在离线模式下编辑行程
   - 记录所有修改操作（增删改）
   - 保存修改到本地存储的变更日志

5. **版本管理**:
   - 检查本地版本和服务器版本
   - 如果服务器版本更新，提示用户同步
   - 处理版本冲突（合并或覆盖）

6. **数据同步**:
   - 联网后自动检测是否有离线修改
   - 提示用户是否同步离线修改
   - 使用 `syncOfflineChanges` 接口同步数据

7. **用户体验**:
   - 导出时显示数据包大小
   - 显示导出时间和版本号
   - 提供"重新导出"功能

**使用场景**:

- 出国旅行前导出离线数据包
- 在无网络环境下查看和编辑行程
- 节省流量，提高加载速度

**TypeScript 类型定义**:

```typescript
interface OfflinePackData {
  trip: {
    id: string;
    destination: string;
    startDate: string;
    endDate: string;
    budgetConfig: any;
    pacingConfig: any;
  };
  days: Array<{
    id: string;
    date: string;
    items: Array<{
      id: string;
      type: string;
      startTime: string;
      endTime: string;
      place: {
        id: string;
        nameCN: string;
        nameEN: string;
        category: string;
        address: string;
        metadata: any;
      } | null;
      note: string;
    }>;
  }>;
  exportedAt: string;
}

interface ExportOfflinePackResponse {
  tripId: string;
  version: number;
  data: OfflinePackData;
  createdAt: string;
  updatedAt: string;
}
```

---

## 接口 22: 查询离线数据包状态

**接口地址**: `GET /trips/:id/offline-status`

**接口描述**: 查询行程的离线数据包是否存在及其版本信息。用于检查是否需要重新导出离线数据包，或判断本地版本是否过期。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 行程 ID (UUID) |

**请求参数**: 无

**响应示例（存在离线包）**:

```json
{
  "success": true,
  "data": {
    "exists": true,
    "tripId": "f3626ff1-7a9b-46d9-8b8b-7f53a14583b1",
    "version": 3,
    "createdAt": "2024-04-10T08:00:00.000Z",
    "updatedAt": "2024-04-15T10:30:00.000Z"
  }
}
```

**响应示例（不存在离线包）**:

```json
{
  "success": true,
  "data": {
    "exists": false
  }
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `exists` | boolean | 离线数据包是否存在 |
| `tripId` | string | 行程 ID（仅当 exists 为 true 时存在） |
| `version` | number | 离线数据包版本号（仅当 exists 为 true 时存在） |
| `createdAt` | string | 数据包创建时间（仅当 exists 为 true 时存在） |
| `updatedAt` | string | 数据包最后更新时间（仅当 exists 为 true 时存在） |

**前端对接要点**:

1. **状态检查**:
   - 在行程详情页加载时检查离线包状态
   - 显示离线包状态（已导出/未导出）
   - 显示版本号和最后更新时间

2. **版本对比**:
   - 获取本地存储的离线包版本号
   - 与服务器版本号对比
   - 如果服务器版本更新，提示用户重新导出

3. **状态指示**:
   - 已导出：显示"已导出离线包 v3"和更新时间
   - 未导出：显示"未导出离线包"和"立即导出"按钮
   - 版本过期：显示"离线包已过期，请重新导出"

4. **自动检查**:
   - 进入行程详情页时自动检查
   - 定期检查（如每5分钟）
   - 行程更新后自动检查

5. **用户提示**:
   - 如果本地版本低于服务器版本，提示更新
   - 提供"重新导出"快捷按钮
   - 显示版本差异说明

6. **离线模式判断**:
   - 检查本地是否有离线包
   - 如果有，允许进入离线模式
   - 如果没有，提示需要先导出

7. **同步时机**:
   - 联网后自动检查版本
   - 如果本地有修改且服务器版本更新，提示冲突处理
   - 提供"查看版本差异"功能

**使用场景**:

- 检查是否需要导出离线包
- 判断本地离线包是否过期
- 决定是否进入离线模式

**TypeScript 类型定义**:

```typescript
interface OfflinePackStatus {
  exists: boolean;
  tripId?: string;
  version?: number;
  createdAt?: string;
  updatedAt?: string;
}
```

---

## 接口 23: 同步离线修改

**接口地址**: `POST /trips/:id/offline-sync`

**接口描述**: 联网后同步离线修改的内容。当用户在离线模式下对行程进行了修改，重新联网后可以使用此接口将离线修改同步到服务器。系统会合并离线修改和服务器数据，处理冲突。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 行程 ID (UUID) |

**请求体**:

```json
{
  "version": 3,
  "changes": [
    {
      "type": "UPDATE_ITEM",
      "itemId": "item-1",
      "data": {
        "startTime": "10:00",
        "endTime": "13:00",
        "note": "修改后的备注"
      }
    },
    {
      "type": "ADD_ITEM",
      "dayId": "day-1",
      "data": {
        "type": "ATTRACTION",
        "startTime": "14:00",
        "endTime": "16:00",
        "placeId": "place-2"
      }
    },
    {
      "type": "DELETE_ITEM",
      "itemId": "item-3"
    }
  ],
  "offlinePackVersion": 3,
  "lastSyncTime": "2024-04-15T10:30:00.000Z"
}
```

**请求字段说明**:

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `version` | number | 是 | 离线数据包版本号 |
| `changes` | array | 是 | 离线修改列表 |
| `changes[].type` | string | 是 | 修改类型：`UPDATE_ITEM`、`ADD_ITEM`、`DELETE_ITEM`、`MOVE_ITEM` |
| `changes[].itemId` | string | 否 | 行程项 ID（更新/删除/移动时需要） |
| `changes[].dayId` | string | 否 | 日期 ID（添加时需要） |
| `changes[].data` | object | 否 | 修改的数据内容 |
| `offlinePackVersion` | number | 是 | 离线数据包版本号 |
| `lastSyncTime` | string | 否 | 上次同步时间 |

**响应示例**:

```json
{
  "success": true,
  "data": {
    "success": true,
    "message": "离线数据已同步",
    "syncedAt": "2024-04-15T15:30:00.000Z",
    "syncedChanges": 3,
    "conflicts": []
  }
}
```

**响应示例（有冲突）**:

```json
{
  "success": true,
  "data": {
    "success": true,
    "message": "离线数据已同步，存在冲突",
    "syncedAt": "2024-04-15T15:30:00.000Z",
    "syncedChanges": 2,
    "conflicts": [
      {
        "itemId": "item-1",
        "type": "CONFLICT",
        "localChange": {
          "startTime": "10:00"
        },
        "serverChange": {
          "startTime": "09:30"
        },
        "resolution": "SERVER_WINS"
      }
    ]
  }
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `success` | boolean | 同步是否成功 |
| `message` | string | 同步结果消息 |
| `syncedAt` | string | 同步完成时间 |
| `syncedChanges` | number | 成功同步的修改数量 |
| `conflicts` | array | 冲突列表（如果有） |
| `conflicts[].itemId` | string | 冲突的行程项 ID |
| `conflicts[].type` | string | 冲突类型 |
| `conflicts[].localChange` | object | 本地修改内容 |
| `conflicts[].serverChange` | object | 服务器修改内容 |
| `conflicts[].resolution` | string | 冲突解决方式：`SERVER_WINS`、`LOCAL_WINS`、`MERGED` |

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "行程不存在: f3626ff1-7a9b-46d9-8b8b-7f53a14583b1"
  }
}
```

**前端对接要点**:

1. **同步时机**:
   - 检测到网络恢复时自动触发同步
   - 用户手动点击"同步离线修改"按钮
   - 进入行程详情页时检查是否有未同步的修改

2. **数据准备**:
   - 收集所有离线修改操作（增删改）
   - 记录修改时间戳和版本号
   - 构建符合接口格式的请求数据

3. **冲突处理**:
   - 检查服务器版本是否更新
   - 如果服务器版本更新，可能存在冲突
   - 提供冲突解决选项：
     - 使用服务器版本（覆盖本地）
     - 使用本地版本（覆盖服务器）
     - 手动合并（显示差异，用户选择）

4. **同步反馈**:
   - 显示同步进度（加载状态）
   - 同步成功后显示成功提示
   - 如果有冲突，显示冲突列表和解决选项

5. **状态更新**:
   - 同步成功后，更新本地离线数据包版本
   - 清除离线修改记录
   - 刷新行程数据

6. **错误处理**:
   - 如果同步失败，保留离线修改记录
   - 提示用户稍后重试
   - 记录错误日志

7. **用户体验**:
   - 同步过程不阻塞用户操作
   - 可以后台同步
   - 提供"查看同步历史"功能

**使用场景**:

- 离线编辑行程后联网同步
- 多设备同步行程修改
- 处理离线修改冲突

**TypeScript 类型定义**:

```typescript
interface OfflineChange {
  type: 'UPDATE_ITEM' | 'ADD_ITEM' | 'DELETE_ITEM' | 'MOVE_ITEM';
  itemId?: string;
  dayId?: string;
  data?: any;
}

interface SyncOfflineChangesRequest {
  version: number;
  changes: OfflineChange[];
  offlinePackVersion: number;
  lastSyncTime?: string;
}

interface Conflict {
  itemId: string;
  type: string;
  localChange: any;
  serverChange: any;
  resolution: 'SERVER_WINS' | 'LOCAL_WINS' | 'MERGED';
}

interface SyncOfflineChangesResponse {
  success: boolean;
  message: string;
  syncedAt: string;
  syncedChanges: number;
  conflicts: Conflict[];
}
```

---

## 接口 24: 生成行程复盘报告

**接口地址**: `GET /trips/:id/recap`

**接口描述**: 生成包含景点打卡顺序、徒步总里程、海拔变化等数据的完整复盘报告。系统会分析行程中的所有景点和徒步路线，生成详细的统计信息、时间线和轨迹数据，用于行程回顾和分享。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 行程 ID (UUID) |

**请求参数**: 无

**响应示例**:

```json
{
  "success": true,
  "data": {
    "tripId": "f3626ff1-7a9b-46d9-8b8b-7f53a14583b1",
    "destination": "JP",
    "startDate": "2024-05-01",
    "endDate": "2024-05-05",
    "totalDays": 5,
    "places": [
      {
        "id": 1,
        "nameCN": "东京塔",
        "nameEN": "Tokyo Tower",
        "category": "ATTRACTION",
        "visitDate": "2024-05-01",
        "visitTime": "09:00"
      },
      {
        "id": 2,
        "nameCN": "浅草寺",
        "nameEN": "Sensō-ji",
        "category": "ATTRACTION",
        "visitDate": "2024-05-01",
        "visitTime": "14:00"
      }
    ],
    "trails": [
      {
        "id": 1,
        "nameCN": "富士山登山路线",
        "nameEN": "Mount Fuji Trail",
        "distanceKm": 12.5,
        "elevationGainM": 1500,
        "durationHours": 6,
        "visitDate": "2024-05-02",
        "gpxData": {
          "points": [
            { "lat": 35.3606, "lng": 138.7274, "elevation": 2305 },
            { "lat": 35.3610, "lng": 138.7280, "elevation": 2350 }
          ]
        },
        "waypoints": [
          {
            "placeId": 3,
            "placeName": "五合目",
            "latitude": 35.3606,
            "longitude": 138.7274,
            "elevation": 2305
          },
          {
            "placeId": 4,
            "placeName": "山顶",
            "latitude": 35.3608,
            "longitude": 138.7278,
            "elevation": 3776
          }
        ]
      }
    ],
    "statistics": {
      "totalPlaces": 15,
      "totalTrails": 3,
      "totalTrailDistanceKm": 28.5,
      "totalElevationGainM": 3200,
      "totalTrailDurationHours": 14,
      "placesByCategory": {
        "ATTRACTION": 8,
        "RESTAURANT": 5,
        "HOTEL": 2
      }
    },
    "timeline": [
      {
        "date": "2024-05-01",
        "items": [
          {
            "type": "PLACE",
            "name": "东京塔",
            "time": "09:00",
            "duration": 3,
            "note": "参观东京塔"
          },
          {
            "type": "MEAL",
            "name": "午餐",
            "time": "12:00",
            "duration": 1
          },
          {
            "type": "PLACE",
            "name": "浅草寺",
            "time": "14:00",
            "duration": 2
          }
        ]
      }
    ],
    "metadata": {
      "photos": ["photo1.jpg", "photo2.jpg"],
      "notes": "非常愉快的旅行",
      "rating": 5
    }
  }
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `tripId` | string | 行程 ID |
| `destination` | string | 目的地国家代码 |
| `startDate` | string | 开始日期 |
| `endDate` | string | 结束日期 |
| `totalDays` | number | 总天数 |
| `places` | array | 访问的景点列表 |
| `places[].id` | number | 地点 ID |
| `places[].nameCN` | string | 中文名称 |
| `places[].nameEN` | string | 英文名称（可选） |
| `places[].category` | string | 地点类别 |
| `places[].visitDate` | string | 访问日期 |
| `places[].visitTime` | string | 访问时间 |
| `places[].photos` | array | 照片列表（可选） |
| `trails` | array | 徒步路线列表 |
| `trails[].id` | number | 路线 ID |
| `trails[].nameCN` | string | 中文名称 |
| `trails[].nameEN` | string | 英文名称（可选） |
| `trails[].distanceKm` | number | 距离（公里） |
| `trails[].elevationGainM` | number | 累计爬升（米） |
| `trails[].durationHours` | number | 预计时长（小时） |
| `trails[].visitDate` | string | 访问日期 |
| `trails[].gpxData` | object | GPX 轨迹数据（可选） |
| `trails[].waypoints` | array | 途经点列表 |
| `statistics` | object | 统计信息 |
| `statistics.totalPlaces` | number | 总景点数 |
| `statistics.totalTrails` | number | 总路线数 |
| `statistics.totalTrailDistanceKm` | number | 总徒步距离（公里） |
| `statistics.totalElevationGainM` | number | 总累计爬升（米） |
| `statistics.totalTrailDurationHours` | number | 总徒步时长（小时） |
| `statistics.placesByCategory` | object | 按类别统计的景点数 |
| `timeline` | array | 时间线数据 |
| `timeline[].date` | string | 日期 |
| `timeline[].items` | array | 当日行程项 |
| `timeline[].items[].type` | string | 类型：`PLACE`、`TRAIL`、`REST`、`MEAL` |
| `timeline[].items[].name` | string | 名称 |
| `timeline[].items[].time` | string | 时间 |
| `timeline[].items[].duration` | number | 时长（小时） |
| `timeline[].items[].note` | string | 备注（可选） |
| `metadata` | object | 元数据（可选） |
| `metadata.photos` | array | 照片列表 |
| `metadata.notes` | string | 备注 |
| `metadata.rating` | number | 评分 |

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "行程 ID f3626ff1-7a9b-46d9-8b8b-7f53a14583b1 不存在"
  }
}
```

**前端对接要点**:

1. **复盘报告页面**:
   - 创建"行程复盘"页面
   - 使用卡片或时间轴布局展示
   - 突出显示统计数据和关键指标

2. **统计信息展示**:
   - 使用图表展示统计数据（如饼图、柱状图）
   - 显示总景点数、总路线数、总距离、总爬升等
   - 按类别统计景点分布

3. **时间线展示**:
   - 使用时间轴组件展示每日行程
   - 区分不同类型（景点、路线、休息、用餐）
   - 显示时间、时长和备注

4. **地图展示**:
   - 在地图上标记所有访问的景点
   - 绘制徒步路线轨迹
   - 显示海拔变化曲线

5. **轨迹可视化**:
   - 如果有 GPX 数据，在地图上绘制轨迹
   - 显示途经点和关键位置
   - 可以播放轨迹动画

6. **分享功能**:
   - 提供"生成分享链接"功能
   - 导出为图片或 PDF
   - 支持社交媒体分享

7. **数据导出**:
   - 导出为 JSON 格式
   - 导出为 CSV 格式（统计数据）
   - 导出 GPX 文件（轨迹数据）

8. **加载优化**:
   - 报告生成可能需要时间，显示加载状态
   - 可以缓存生成的报告
   - 支持增量更新

**使用场景**:

- 行程结束后回顾和总结
- 分享旅行经历
- 生成旅行纪念册
- 分析旅行数据

**TypeScript 类型定义**:

```typescript
interface PlaceRecap {
  id: number;
  nameCN: string;
  nameEN?: string;
  category: string;
  visitDate: string;
  visitTime: string;
  photos?: string[];
}

interface TrailRecap {
  id: number;
  nameCN: string;
  nameEN?: string;
  distanceKm: number;
  elevationGainM: number;
  durationHours: number;
  visitDate: string;
  gpxData?: any;
  waypoints?: Array<{
    placeId?: number;
    placeName?: string;
    latitude: number;
    longitude: number;
    elevation?: number;
  }>;
}

interface RecapStatistics {
  totalPlaces: number;
  totalTrails: number;
  totalTrailDistanceKm: number;
  totalElevationGainM: number;
  totalTrailDurationHours: number;
  placesByCategory: Record<string, number>;
}

interface TimelineItem {
  type: 'PLACE' | 'TRAIL' | 'REST' | 'MEAL';
  name: string;
  time: string;
  duration?: number;
  note?: string;
}

interface TripRecapReport {
  tripId: string;
  destination: string;
  startDate: string;
  endDate: string;
  totalDays: number;
  places: PlaceRecap[];
  trails: TrailRecap[];
  statistics: RecapStatistics;
  timeline: Array<{
    date: string;
    items: TimelineItem[];
  }>;
  metadata?: {
    photos?: string[];
    notes?: string;
    rating?: number;
  };
}
```

---

## 接口 25: 导出行程复盘报告（用于分享）

**接口地址**: `GET /trips/:id/recap/export`

**接口描述**: 导出为可分享的格式，包含完整的景点和徒步轨迹数据。系统会生成完整的复盘报告，并返回分享链接（如果已存在），用于分享给其他用户或导出为文件。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 行程 ID (UUID) |

**请求参数**: 无

**响应示例**:

```json
{
  "success": true,
  "data": {
    "recap": {
      "tripId": "f3626ff1-7a9b-46d9-8b8b-7f53a14583b1",
      "destination": "JP",
      "startDate": "2024-05-01",
      "endDate": "2024-05-05",
      "totalDays": 5,
      "places": [
        {
          "id": 1,
          "nameCN": "东京塔",
          "nameEN": "Tokyo Tower",
          "category": "ATTRACTION",
          "visitDate": "2024-05-01",
          "visitTime": "09:00"
        }
      ],
      "trails": [
        {
          "id": 1,
          "nameCN": "富士山登山路线",
          "nameEN": "Mount Fuji Trail",
          "distanceKm": 12.5,
          "elevationGainM": 1500,
          "durationHours": 6,
          "visitDate": "2024-05-02",
          "gpxData": {},
          "waypoints": []
        }
      ],
      "statistics": {
        "totalPlaces": 15,
        "totalTrails": 3,
        "totalTrailDistanceKm": 28.5,
        "totalElevationGainM": 3200,
        "totalTrailDurationHours": 14,
        "placesByCategory": {
          "ATTRACTION": 8,
          "RESTAURANT": 5,
          "HOTEL": 2
        }
      },
      "timeline": [],
      "metadata": {}
    },
    "shareUrl": "/trips/shared/550e8400-e29b-41d4-a716-446655440000",
    "exportDate": "2024-05-10T10:30:00.000Z"
  }
}
```

**响应示例（无分享链接）**:

```json
{
  "success": true,
  "data": {
    "recap": {
      "tripId": "f3626ff1-7a9b-46d9-8b8b-7f53a14583b1",
      "destination": "JP",
      "startDate": "2024-05-01",
      "endDate": "2024-05-05",
      "totalDays": 5,
      "places": [],
      "trails": [],
      "statistics": {
        "totalPlaces": 0,
        "totalTrails": 0,
        "totalTrailDistanceKm": 0,
        "totalElevationGainM": 0,
        "totalTrailDurationHours": 0,
        "placesByCategory": {}
      },
      "timeline": [],
      "metadata": {}
    },
    "shareUrl": "",
    "exportDate": "2024-05-10T10:30:00.000Z"
  }
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `recap` | object | 完整的复盘报告数据（与接口 24 相同结构） |
| `shareUrl` | string | 分享链接（如果已存在），格式为 `/trips/shared/{shareToken}`，如果不存在则为空字符串 |
| `exportDate` | string | 导出时间 |

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "行程 ID f3626ff1-7a9b-46d9-8b8b-7f53a14583b1 不存在"
  }
}
```

**前端对接要点**:

1. **导出功能**:
   - 在复盘报告页面提供"导出"按钮
   - 支持导出为 JSON 文件
   - 支持导出为 PDF（前端生成）
   - 支持导出为图片（前端生成）

2. **分享链接处理**:
   - 如果 `shareUrl` 不为空，显示"已生成分享链接"
   - 提供"复制分享链接"功能
   - 如果为空，提示用户先创建分享链接

3. **数据格式**:
   - 导出 JSON 时，直接使用 `recap` 数据
   - 可以添加额外的元数据（如导出时间、版本号）
   - 保持数据结构的完整性

4. **文件下载**:
   - 使用 Blob API 创建文件
   - 设置正确的 MIME 类型
   - 提供文件名（如 `trip-recap-{tripId}.json`）

5. **PDF 导出**:
   - 使用 PDF 生成库（如 jsPDF、pdfkit）
   - 格式化报告内容
   - 包含统计图表、时间线、地图等

6. **图片导出**:
   - 使用 Canvas API 或 html2canvas
   - 生成包含关键信息的图片
   - 支持自定义尺寸和格式

7. **用户体验**:
   - 显示导出进度
   - 导出成功后提示用户
   - 提供"打开文件"选项

**使用场景**:

- 导出复盘报告用于备份
- 分享给朋友或家人
- 生成旅行纪念册
- 发布到社交媒体

**TypeScript 类型定义**:

```typescript
interface ExportRecapResponse {
  recap: TripRecapReport;
  shareUrl: string;
  exportDate: string;
}
```

---

## 接口 26: 生成3D轨迹视频数据

**接口地址**: `GET /trips/:id/trail-video-data`

**接口描述**: 返回GPX和关键点信息，前端可据此生成3D轨迹视频。系统会提取行程中所有徒步路线的GPX数据和关键点（起点、终点、途经点），并计算时间戳，用于生成3D轨迹动画视频。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 行程 ID (UUID) |

**请求参数**: 无

**响应示例**:

```json
{
  "success": true,
  "data": {
    "trails": [
      {
        "trailId": 1,
        "name": "富士山登山路线",
        "gpxData": {
          "points": [
            { "lat": 35.3606, "lng": 138.7274, "elevation": 2305 },
            { "lat": 35.3610, "lng": 138.7280, "elevation": 2350 },
            { "lat": 35.3615, "lng": 138.7285, "elevation": 2400 }
          ],
          "metadata": {
            "distance": 12.5,
            "duration": 21600
          }
        },
        "keyPoints": [
          {
            "latitude": 35.3606,
            "longitude": 138.7274,
            "elevation": 2305,
            "timestamp": "2024-05-02T06:00:00.000Z",
            "description": "起点"
          },
          {
            "latitude": 35.3610,
            "longitude": 138.7280,
            "elevation": 2350,
            "timestamp": "2024-05-02T07:30:00.000Z",
            "description": "途经点 1"
          },
          {
            "latitude": 35.3615,
            "longitude": 138.7285,
            "elevation": 2400,
            "timestamp": "2024-05-02T09:00:00.000Z",
            "description": "途经点 2"
          },
          {
            "latitude": 35.3620,
            "longitude": 138.7290,
            "elevation": 3776,
            "timestamp": "2024-05-02T12:00:00.000Z",
            "description": "终点"
          }
        ]
      },
      {
        "trailId": 2,
        "name": "箱根登山路线",
        "gpxData": {
          "points": [
            { "lat": 35.2333, "lng": 139.1033, "elevation": 1000 }
          ]
        },
        "keyPoints": [
          {
            "latitude": 35.2333,
            "longitude": 139.1033,
            "elevation": 1000,
            "timestamp": "2024-05-03T08:00:00.000Z",
            "description": "起点"
          }
        ]
      }
    ]
  }
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `trails` | array | 轨迹列表 |
| `trails[].trailId` | number | 路线 ID |
| `trails[].name` | string | 路线名称 |
| `trails[].gpxData` | object | GPX 轨迹数据（包含所有点） |
| `trails[].gpxData.points` | array | 轨迹点数组 |
| `trails[].gpxData.points[].lat` | number | 纬度 |
| `trails[].gpxData.points[].lng` | number | 经度 |
| `trails[].gpxData.points[].elevation` | number | 海拔（可选） |
| `trails[].keyPoints` | array | 关键点列表（起点、终点、途经点） |
| `trails[].keyPoints[].latitude` | number | 纬度 |
| `trails[].keyPoints[].longitude` | number | 经度 |
| `trails[].keyPoints[].elevation` | number | 海拔 |
| `trails[].keyPoints[].timestamp` | string | 时间戳（ISO 8601 格式） |
| `trails[].keyPoints[].description` | string | 描述（起点、终点、途经点 N） |

**空轨迹响应**:

```json
{
  "success": true,
  "data": {
    "trails": []
  }
}
```

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "行程 ID f3626ff1-7a9b-46d9-8b8b-7f53a14583b1 不存在"
  }
}
```

**前端对接要点**:

1. **3D轨迹视频生成**:
   - 使用 3D 地图库（如 Cesium、Three.js + Mapbox）
   - 根据 GPX 数据绘制轨迹线
   - 使用关键点作为动画控制点

2. **轨迹可视化**:
   - 在地图上绘制完整轨迹（使用所有 GPX 点）
   - 标记关键点（起点、终点、途经点）
   - 显示海拔变化曲线

3. **动画播放**:
   - 根据时间戳计算动画进度
   - 相机跟随轨迹移动
   - 显示当前位置标记
   - 可以调整播放速度

4. **3D效果**:
   - 使用地形数据渲染3D地形
   - 根据海拔数据调整高度
   - 添加阴影和光照效果
   - 可以切换视角（跟随、俯视、侧视）

5. **视频导出**:
   - 使用 Canvas API 或 WebGL 录制
   - 支持导出为 MP4、GIF 等格式
   - 可以添加标题、时间、统计信息等叠加层

6. **性能优化**:
   - 对于长轨迹，使用 LOD（细节层次）技术
   - 关键点数量控制在合理范围（10-20个）
   - 使用 Web Workers 处理大量数据

7. **交互功能**:
   - 播放/暂停控制
   - 进度条拖拽
   - 速度调节（0.5x、1x、2x）
   - 视角切换
   - 显示/隐藏关键点标签

8. **数据使用**:
   - `gpxData.points` 用于绘制完整轨迹
   - `keyPoints` 用于动画关键帧
   - `timestamp` 用于同步时间轴
   - `elevation` 用于3D高度计算

**使用场景**:

- 生成3D轨迹动画视频
- 分享徒步路线体验
- 制作旅行纪念视频
- 分析徒步路线难度

**TypeScript 类型定义**:

```typescript
interface GPXPoint {
  lat: number;
  lng: number;
  elevation?: number;
}

interface GPXData {
  points: GPXPoint[];
  metadata?: {
    distance?: number;
    duration?: number;
  };
}

interface TrailKeyPoint {
  latitude: number;
  longitude: number;
  elevation: number;
  timestamp: string;
  description?: string;
}

interface TrailVideoData {
  trailId: number;
  name: string;
  gpxData: GPXData;
  keyPoints: TrailKeyPoint[];
}

interface GenerateTrailVideoDataResponse {
  trails: TrailVideoData[];
}
```

---

## 接口 27: 根据分享令牌获取行程

**接口地址**: `GET /trips/shared/:shareToken`

**接口描述**: 获取分享的行程数据，包括所有Trail信息、行程项、景点等完整数据。可用于预览分享的行程。系统会验证分享令牌的有效性和过期时间。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `shareToken` | string | 是 | 分享令牌（UUID格式） |

**请求参数**: 无

**响应示例**:

```json
{
  "success": true,
  "data": {
    "trip": {
      "id": "f3626ff1-7a9b-46d9-8b8b-7f53a14583b1",
      "destination": "JP",
      "startDate": "2024-05-01",
      "endDate": "2024-05-05",
      "totalBudget": 20000,
      "status": "PLANNING",
      "TripDay": [
        {
          "id": "day-1",
          "date": "2024-05-01",
          "ItineraryItem": [
            {
              "id": "item-1",
              "type": "ATTRACTION",
              "startTime": "2024-05-01T09:00:00.000Z",
              "endTime": "2024-05-01T12:00:00.000Z",
              "Place": {
                "id": 1,
                "nameCN": "东京塔",
                "nameEN": "Tokyo Tower",
                "category": "ATTRACTION"
              },
              "Trail": null
            },
            {
              "id": "item-2",
              "type": "TRAIL",
              "startTime": "2024-05-01T14:00:00.000Z",
              "endTime": "2024-05-01T20:00:00.000Z",
              "Place": null,
              "Trail": {
                "id": 1,
                "nameCN": "富士山登山路线",
                "nameEN": "Mount Fuji Trail",
                "distanceKm": 12.5,
                "elevationGainM": 1500,
                "gpxData": {},
                "Place_Trail_startPlaceIdToPlace": {
                  "id": 2,
                  "nameCN": "五合目",
                  "nameEN": "5th Station"
                },
                "Place_Trail_endPlaceIdToPlace": {
                  "id": 3,
                  "nameCN": "山顶",
                  "nameEN": "Summit"
                },
                "TrailWaypoint": [
                  {
                    "id": 1,
                    "order": 1,
                    "placeId": 2,
                    "Place": {
                      "id": 2,
                      "nameCN": "五合目",
                      "nameEN": "5th Station"
                    }
                  }
                ]
              }
            }
          ]
        }
      ]
    },
    "permission": "VIEW",
    "shareToken": "550e8400-e29b-41d4-a716-446655440000"
  }
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `trip` | object | 完整的行程数据 |
| `trip.id` | string | 行程 ID |
| `trip.destination` | string | 目的地国家代码 |
| `trip.startDate` | string | 开始日期 |
| `trip.endDate` | string | 结束日期 |
| `trip.totalBudget` | number | 总预算 |
| `trip.status` | string | 行程状态 |
| `trip.TripDay` | array | 每日行程安排 |
| `trip.TripDay[].ItineraryItem` | array | 行程项列表 |
| `trip.TripDay[].ItineraryItem[].Place` | object\|null | 地点信息 |
| `trip.TripDay[].ItineraryItem[].Trail` | object\|null | 徒步路线信息（包含GPX数据、途经点等） |
| `permission` | string | 分享权限（VIEW、EDIT等） |
| `shareToken` | string | 分享令牌 |

**错误响应（链接不存在）**:

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "分享链接不存在或已失效"
  }
}
```

**错误响应（链接已过期）**:

```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "分享链接已过期"
  }
}
```

**前端对接要点**:

1. **分享链接预览**:
   - 创建分享链接预览页面
   - 使用分享令牌从URL获取（如 `/trips/shared/{shareToken}`）
   - 显示完整的行程信息

2. **数据展示**:
   - 展示行程基本信息（目的地、日期、预算等）
   - 展示每日行程安排
   - 展示所有景点和徒步路线
   - 如果有GPX数据，在地图上绘制轨迹

3. **权限控制**:
   - 根据 `permission` 字段控制操作权限
   - `VIEW` 权限：只能查看，不能编辑
   - `EDIT` 权限：可以查看和编辑

4. **导入功能**:
   - 提供"导入此行程"按钮
   - 点击后调用导入接口
   - 允许用户修改目的地和日期

5. **错误处理**:
   - 链接不存在：显示"分享链接已失效"
   - 链接过期：显示"分享链接已过期"
   - 提供友好的错误提示

6. **用户体验**:
   - 显示加载状态
   - 如果数据量大，使用分页或懒加载
   - 提供"返回"或"关闭"按钮

7. **数据完整性**:
   - 确保所有Trail数据完整显示
   - 包括GPX数据、途经点、起点终点等
   - 支持查看轨迹详情

**使用场景**:

- 预览分享的行程
- 查看他人的行程模板
- 导入行程作为模板

**TypeScript 类型定义**:

```typescript
interface SharedTripResponse {
  trip: {
    id: string;
    destination: string;
    startDate: string;
    endDate: string;
    totalBudget: number;
    status: string;
    TripDay: Array<{
      id: string;
      date: string;
      ItineraryItem: Array<{
        id: string;
        type: string;
        startTime: string;
        endTime: string;
        Place: any | null;
        Trail: {
          id: number;
          nameCN: string;
          nameEN?: string;
          distanceKm: number;
          elevationGainM: number;
          gpxData: any;
          Place_Trail_startPlaceIdToPlace: any;
          Place_Trail_endPlaceIdToPlace: any;
          TrailWaypoint: Array<{
            id: number;
            order: number;
            placeId: number | null;
            Place: any | null;
          }>;
        } | null;
      }>;
    }>;
  };
  permission: string;
  shareToken: string;
}
```

---

## 接口 28: 导入分享的行程

**接口地址**: `POST /trips/shared/:shareToken/import`

**接口描述**: 从分享链接导入行程，包括所有Trail数据，创建新的行程副本。会完整复制所有行程项、Trail关联、GPX数据等。用户需要提供新的目的地、开始日期和结束日期。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `shareToken` | string | 是 | 分享令牌（UUID格式） |

**请求体**:

```json
{
  "destination": "JP",
  "startDate": "2024-06-01",
  "endDate": "2024-06-05",
  "userId": "user-123"
}
```

**请求字段说明**:

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `destination` | string | 是 | 目的地（国家代码或地名） |
| `startDate` | string | 是 | 开始日期（ISO 8601格式，如 `2024-06-01`） |
| `endDate` | string | 是 | 结束日期（ISO 8601格式，如 `2024-06-05`） |
| `userId` | string | 否 | 用户ID（可选，如果不提供则使用默认用户） |

**响应示例**:

```json
{
  "success": true,
  "data": {
    "tripId": "a1234567-89ab-cdef-0123-456789abcdef",
    "importedFrom": "550e8400-e29b-41d4-a716-446655440000",
    "message": "行程导入成功，包括所有Trail数据"
  }
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `tripId` | string | 新创建的行程 ID |
| `importedFrom` | string | 来源分享令牌 |
| `message` | string | 导入结果消息 |

**错误响应（链接不存在）**:

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "分享链接不存在或已失效"
  }
}
```

**错误响应（链接已过期）**:

```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "分享链接已过期"
  }
}
```

**错误响应（数据验证失败）**:

```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "开始日期不能晚于结束日期"
  }
}
```

**前端对接要点**:

1. **导入流程**:
   - 在分享链接预览页面提供"导入此行程"按钮
   - 弹出导入对话框，让用户填写目的地、开始日期、结束日期
   - 提交后显示加载状态

2. **表单验证**:
   - 验证目的地不能为空
   - 验证开始日期和结束日期的格式
   - 验证开始日期不能晚于结束日期
   - 提供日期选择器组件

3. **导入成功处理**:
   - 显示成功提示
   - 跳转到新创建的行程详情页
   - 或者显示新行程ID，让用户选择是否跳转

4. **数据复制**:
   - 系统会自动复制所有行程项
   - 复制所有Trail关联和GPX数据
   - 复制所有途经点信息
   - 保持原有的行程结构

5. **日期调整**:
   - 如果新日期范围与原行程不同，系统会调整日期
   - 保持每日行程的相对时间关系
   - 可能需要用户手动调整部分活动

6. **错误处理**:
   - 链接不存在：提示用户分享链接已失效
   - 链接过期：提示用户分享链接已过期
   - 验证失败：显示具体的验证错误信息

7. **用户体验**:
   - 提供"取消"按钮
   - 显示导入进度（如果需要）
   - 导入成功后提供快捷操作（查看行程、继续编辑等）

**使用场景**:

- 从分享链接导入行程作为模板
- 复制他人的行程安排
- 基于现有行程创建新行程

**TypeScript 类型定义**:

```typescript
interface ImportTripFromShareRequest {
  destination: string;
  startDate: string;
  endDate: string;
  userId?: string;
}

interface ImportTripFromShareResponse {
  tripId: string;
  importedFrom: string;
  message: string;
}
```

---

## 接口 29: 发送紧急求救信号

**接口地址**: `POST /trips/:id/emergency/sos`

**接口描述**: 在行程中遇到危险时一键发送求救信号，包含精准经纬度和行程相关背景。系统会自动记录当前位置、时间戳和行程上下文信息，用于紧急救援。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 行程 ID (UUID) |

**请求体**:

```json
{
  "latitude": 64.1283,
  "longitude": -21.8278,
  "message": "迷路，需要救援"
}
```

**请求字段说明**:

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `latitude` | number | 是 | 纬度（-90 到 90） |
| `longitude` | number | 是 | 经度（-180 到 180） |
| `message` | string | 否 | 求救消息（可选，用于描述紧急情况） |

**响应示例**:

```json
{
  "success": true,
  "data": {
    "sosId": "550e8400-e29b-41d4-a716-446655440000",
    "tripId": "f3626ff1-7a9b-46d9-8b8b-7f53a14583b1",
    "status": "SENT",
    "coordinates": {
      "latitude": 64.1283,
      "longitude": -21.8278
    },
    "sentAt": "2024-05-02T14:30:00.000Z"
  }
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `sosId` | string | 求救信号 ID（UUID） |
| `tripId` | string | 行程 ID |
| `status` | string | 求救状态：`SENT`（已发送）、`ACKNOWLEDGED`（已确认）、`IN_PROGRESS`（救援中）、`RESOLVED`（已解决） |
| `coordinates` | object | 坐标信息 |
| `coordinates.latitude` | number | 纬度 |
| `coordinates.longitude` | number | 经度 |
| `sentAt` | string | 发送时间（ISO 8601 格式） |

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "行程 f3626ff1-7a9b-46d9-8b8b-7f53a14583b1 不存在"
  }
}
```

**前端对接要点**:

1. **紧急求救按钮**:
   - 在行程详情页或地图页面提供醒目的"紧急求救"按钮
   - 按钮应该易于访问，但需要防止误触（如二次确认）
   - 使用红色或橙色等警示颜色

2. **位置获取**:
   - 使用浏览器的 Geolocation API 获取当前位置
   - 如果无法获取位置，提示用户手动输入坐标
   - 显示当前位置在地图上的标记

3. **求救消息**:
   - 提供文本输入框，让用户描述紧急情况
   - 可以预设一些常见情况（如"迷路"、"受伤"、"设备故障"等）
   - 消息为可选，但建议用户填写

4. **发送确认**:
   - 发送前显示确认对话框
   - 显示位置坐标和求救消息
   - 提醒用户这是真实的求救信号

5. **发送反馈**:
   - 发送成功后显示确认信息
   - 显示求救信号 ID（用于后续查询）
   - 提供"查看求救记录"链接

6. **行程上下文**:
   - 系统会自动包含行程信息（目的地、日期、行程安排等）
   - 这些信息有助于救援人员了解情况
   - 前端不需要手动传递这些信息

7. **状态更新**:
   - 定期轮询或使用 WebSocket 获取求救状态更新
   - 如果状态变为 `ACKNOWLEDGED` 或 `IN_PROGRESS`，显示救援信息
   - 显示预计到达时间、联系方式等

8. **离线支持**:
   - 如果网络不可用，将求救信息保存到本地
   - 网络恢复后自动发送
   - 提示用户可能需要使用卫星通信设备

9. **安全考虑**:
   - 确保求救信号的真实性
   - 防止恶意发送求救信号
   - 记录所有求救操作日志

**使用场景**:

- 在野外迷路需要救援
- 遇到危险情况需要帮助
- 设备故障无法继续行程
- 突发疾病或受伤

**注意事项**:

- 这是真实的紧急求救功能，请谨慎使用
- 误发求救信号可能浪费救援资源
- 建议在发送前确认情况确实紧急

**TypeScript 类型定义**:

```typescript
interface SendSOSRequest {
  latitude: number;
  longitude: number;
  message?: string;
}

interface SendSOSResponse {
  sosId: string;
  tripId: string;
  status: 'SENT' | 'ACKNOWLEDGED' | 'IN_PROGRESS' | 'RESOLVED';
  coordinates: {
    latitude: number;
    longitude: number;
  };
  sentAt: string;
  rescueInfo?: {
    estimatedArrival?: string;
    contactNumber?: string;
    progress?: string;
  };
}
```

---

## 接口 30: 获取求救记录

**接口地址**: `GET /trips/:id/emergency/history`

**接口描述**: 获取行程的所有求救记录。返回该行程历史上发送的所有求救信号，包括位置、时间、状态和救援信息。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 行程 ID (UUID) |

**请求参数**: 无

**响应示例**:

```json
{
  "success": true,
  "data": [
    {
      "sosId": "550e8400-e29b-41d4-a716-446655440000",
      "tripId": "f3626ff1-7a9b-46d9-8b8b-7f53a14583b1",
      "status": "RESOLVED",
      "coordinates": {
        "latitude": 64.1283,
        "longitude": -21.8278
      },
      "sentAt": "2024-05-02T14:30:00.000Z",
      "rescueInfo": {
        "estimatedArrival": "2024-05-02T16:00:00.000Z",
        "contactNumber": "+86-138-0000-0000",
        "progress": "救援队已出发，预计2小时后到达"
      }
    },
    {
      "sosId": "a1234567-89ab-cdef-0123-456789abcdef",
      "tripId": "f3626ff1-7a9b-46d9-8b8b-7f53a14583b1",
      "status": "SENT",
      "coordinates": {
        "latitude": 64.1500,
        "longitude": -21.8500
      },
      "sentAt": "2024-05-01T10:00:00.000Z",
      "rescueInfo": null
    }
  ]
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `data` | array | 求救记录列表（按时间倒序） |
| `data[].sosId` | string | 求救信号 ID |
| `data[].tripId` | string | 行程 ID |
| `data[].status` | string | 求救状态：`SENT`、`ACKNOWLEDGED`、`IN_PROGRESS`、`RESOLVED` |
| `data[].coordinates` | object | 坐标信息 |
| `data[].coordinates.latitude` | number | 纬度 |
| `data[].coordinates.longitude` | number | 经度 |
| `data[].sentAt` | string | 发送时间（ISO 8601 格式） |
| `data[].rescueInfo` | object\|null | 救援信息（如果有） |
| `data[].rescueInfo.estimatedArrival` | string | 预计到达时间（ISO 8601 格式） |
| `data[].rescueInfo.contactNumber` | string | 救援队联系电话 |
| `data[].rescueInfo.progress` | string | 救援进度描述 |

**空列表响应**:

```json
{
  "success": true,
  "data": []
}
```

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "行程 f3626ff1-7a9b-46d9-8b8b-7f53a14583b1 不存在"
  }
}
```

**前端对接要点**:

1. **求救记录页面**:
   - 在行程详情页提供"求救记录"入口
   - 创建专门的求救记录列表页面
   - 使用时间轴或列表布局展示

2. **记录展示**:
   - 显示每条求救记录的时间、位置、状态
   - 使用不同颜色标识不同状态：
     - `SENT`: 黄色（已发送）
     - `ACKNOWLEDGED`: 蓝色（已确认）
     - `IN_PROGRESS`: 橙色（救援中）
     - `RESOLVED`: 绿色（已解决）
   - 显示坐标信息，可以点击查看地图位置

3. **地图展示**:
   - 在地图上标记所有求救位置
   - 使用不同图标表示不同状态
   - 点击标记可以查看详细信息

4. **救援信息展示**:
   - 如果有救援信息，突出显示
   - 显示预计到达时间（倒计时）
   - 提供联系电话，可以一键拨打
   - 显示救援进度描述

5. **状态更新**:
   - 定期刷新求救记录（如每30秒）
   - 如果状态发生变化，高亮显示
   - 可以手动刷新获取最新状态

6. **详细信息**:
   - 点击记录可以查看详细信息
   - 显示发送时间、位置坐标、求救消息等
   - 显示完整的救援信息

7. **操作功能**:
   - 提供"在地图上查看"功能
   - 提供"复制坐标"功能
   - 提供"分享位置"功能（如果需要）

8. **空状态处理**:
   - 如果没有求救记录，显示友好提示
   - 可以显示"如何发送求救信号"的说明

9. **紧急情况处理**:
   - 如果有未解决的求救（状态不是 `RESOLVED`），突出显示
   - 在行程详情页显示紧急提示
   - 提供快速联系救援的入口

**使用场景**:

- 查看历史求救记录
- 跟踪救援进度
- 了解救援状态
- 获取救援联系方式

**TypeScript 类型定义**:

```typescript
interface SOSHistoryItem {
  sosId: string;
  tripId: string;
  status: 'SENT' | 'ACKNOWLEDGED' | 'IN_PROGRESS' | 'RESOLVED';
  coordinates: {
    latitude: number;
    longitude: number;
  };
  sentAt: string;
  rescueInfo?: {
    estimatedArrival?: string;
    contactNumber?: string;
    progress?: string;
  } | null;
}

type GetSOSHistoryResponse = SOSHistoryItem[];
```

---

## 接口 12: 更新行程

**接口地址**: `PUT /trips/:id`

**接口描述**: 更新行程的基本信息，包括目的地、日期、预算和旅行者信息。更新后系统会重新计算节奏策略和预算切分。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 行程 ID (UUID) |

**请求体**:

```json
{
  "destination": "JP",
  "startDate": "2024-05-01",
  "endDate": "2024-05-07",
  "totalBudget": 25000,
  "travelers": [
    {
      "type": "ADULT",
      "mobilityTag": "CITY_POTATO"
    }
  ]
}
```

**参数说明**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `destination` | string | 否 | 目的地国家代码（ISO 3166-1 alpha-2），如：JP、IS、US、CN |
| `startDate` | string | 否 | 行程开始日期（ISO 8601格式：YYYY-MM-DD） |
| `endDate` | string | 否 | 行程结束日期（ISO 8601格式：YYYY-MM-DD） |
| `totalBudget` | number | 否 | 总预算（单位：人民币 CNY），最小值：0 |
| `travelers` | array | 否 | 旅行者列表 |

**旅行者类型 (type)**:

- `ADULT` - 成人
- `ELDERLY` - 老年人
- `CHILD` - 儿童

**行动能力标签 (mobilityTag)**:

- `IRON_LEGS` - 特种兵：体力充沛，可以高强度活动
- `ACTIVE_SENIOR` - 银发徒步：老年人但体力尚可，但地形受限
- `CITY_POTATO` - 城市脆皮：年轻人但体力一般，需要频繁休息
- `LIMITED` - 行动不便：需要轮椅或特殊设施

**响应示例**:

```json
{
  "success": true,
  "data": {
    "id": "f3626ff1-7a9b-46d9-8b8b-7f53a14583b1",
    "destination": "JP",
    "startDate": "2024-05-01",
    "endDate": "2024-05-07",
    "totalBudget": 25000,
    "status": "PLANNING",
    "createdAt": "2024-04-01T10:00:00.000Z",
    "updatedAt": "2024-04-15T14:30:00.000Z",
    "pacingConfig": {
      "travelers": [
        {
          "type": "ADULT",
          "mobilityTag": "CITY_POTATO"
        }
      ],
      "maxDailyActivities": 4,
      "restIntervalHours": 2
    },
    "budgetConfig": {
      "totalBudget": 25000,
      "currency": "CNY",
      "dailyBudget": 3571
    }
  }
}
```

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "行程 ID f3626ff1-7a9b-46d9-8b8b-7f53a14583b1 不存在"
  }
}
```

```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "endDate 必须晚于 startDate"
  }
}
```

**前端对接要点**:

1. **部分更新**:
   - 只需要传递需要更新的字段
   - 未传递的字段保持不变
   - 所有字段都是可选的

2. **表单验证**:
   - 日期格式必须为 YYYY-MM-DD
   - 如果更新了日期，结束日期必须晚于开始日期
   - 预算必须大于等于 0
   - 如果更新了旅行者列表，至少需要一个旅行者

3. **用户体验**:
   - 更新成功后刷新行程详情页
   - 显示更新成功提示
   - 如果更新了日期或预算，提示用户可能需要重新规划行程

4. **错误处理**:
   - 显示具体的验证错误信息
   - 如果行程不存在，提示用户并跳转到行程列表页

5. **数据同步**:
   - 更新后可能需要重新获取行程详情
   - 如果更新了日期，可能需要重新生成行程排期

**TypeScript 类型定义**:

```typescript
interface UpdateTripRequest {
  destination?: string;
  startDate?: string;
  endDate?: string;
  totalBudget?: number;
  travelers?: Array<{
    type: 'ADULT' | 'ELDERLY' | 'CHILD';
    mobilityTag: 'IRON_LEGS' | 'ACTIVE_SENIOR' | 'CITY_POTATO' | 'LIMITED';
  }>;
}

interface UpdateTripResponse {
  id: string;
  destination: string;
  startDate: string;
  endDate: string;
  totalBudget: number;
  status: string;
  createdAt: string;
  updatedAt: string;
  pacingConfig: any;
  budgetConfig: any;
}
```

---

## 接口 14: 修改行程并自动适配调整

**接口地址**: `POST /trips/:id/adjust`

**接口描述**: 修改行程中的日期或活动安排，系统自动触发节奏修复机制，调整关联服务（如酒店、交通）并更新预算。支持批量修改多个行程项。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 行程 ID (UUID) |

**请求体**:

```json
{
  "modifications": [
    {
      "type": "CHANGE_DATE",
      "newDate": "2024-05-03"
    },
    {
      "type": "MOVE_ACTIVITY",
      "itemId": "item-123",
      "newDate": "2024-05-02",
      "newStartTime": "14:00"
    },
    {
      "type": "ADD_ACTIVITY",
      "activityData": {
        "placeId": 456,
        "startTime": "2024-05-01T10:00:00.000Z",
        "endTime": "2024-05-01T12:00:00.000Z",
        "type": "ACTIVITY"
      }
    },
    {
      "type": "REMOVE_ACTIVITY",
      "itemId": "item-789"
    }
  ]
}
```

**参数说明**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `modifications` | array | 是 | 修改列表 |

**修改类型 (type)**:

- `CHANGE_DATE` - 更改行程日期（需要 `newDate`）
- `MOVE_ACTIVITY` - 移动活动到新日期/时间（需要 `itemId`、`newDate` 或 `newStartTime`）
- `ADD_ACTIVITY` - 添加新活动（需要 `activityData`）
- `REMOVE_ACTIVITY` - 删除活动（需要 `itemId`）

**修改项详细说明**:

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `type` | string | 是 | 修改类型 |
| `itemId` | string | 条件必填 | 行程项 ID（修改/删除时必填） |
| `newDate` | string | 条件必填 | 新日期（YYYY-MM-DD），更改日期或移动活动时使用 |
| `newStartTime` | string | 条件必填 | 新开始时间（HH:mm），移动活动时使用 |
| `activityData` | object | 条件必填 | 活动数据（添加活动时必填） |

**响应示例**:

```json
{
  "success": true,
  "data": {
    "success": true,
    "adjustedTrip": {
      "id": "f3626ff1-7a9b-46d9-8b8b-7f53a14583b1",
      "destination": "JP",
      "startDate": "2024-05-01",
      "endDate": "2024-05-05",
      "status": "PLANNING"
    },
    "changes": [
      {
        "type": "DATE_CHANGED",
        "description": "行程日期已从 2024-05-01 更新为 2024-05-03",
        "affectedItems": ["item-123", "item-456"]
      },
      {
        "type": "ACTIVITY_MOVED",
        "description": "活动已移动到 2024-05-02 14:00",
        "affectedItems": ["item-123"]
      },
      {
        "type": "ACTIVITY_ADDED",
        "description": "已添加新活动",
        "affectedItems": ["item-new-789"]
      },
      {
        "type": "ACTIVITY_REMOVED",
        "description": "已删除活动",
        "affectedItems": ["item-789"]
      }
    ],
    "budgetUpdate": {
      "oldBudget": 20000,
      "newBudget": 19500,
      "changes": ["删除活动节省了 500 元"]
    },
    "notifications": [
      {
        "type": "HOTEL",
        "message": "由于日期变更，建议检查酒店预订是否需要调整",
        "actionRequired": true
      },
      {
        "type": "TRANSPORT",
        "message": "交通安排已自动调整",
        "actionRequired": false
      }
    ]
  }
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `success` | boolean | 调整是否成功 |
| `adjustedTrip` | object | 调整后的行程基本信息 |
| `changes` | array | 变更列表 |
| `changes[].type` | string | 变更类型 |
| `changes[].description` | string | 变更描述 |
| `changes[].affectedItems` | array | 受影响的行程项 ID 列表 |
| `budgetUpdate` | object | 预算更新信息（如果有） |
| `budgetUpdate.oldBudget` | number | 原预算 |
| `budgetUpdate.newBudget` | number | 新预算 |
| `budgetUpdate.changes` | array | 预算变更说明 |
| `notifications` | array | 通知列表 |
| `notifications[].type` | string | 通知类型：`HOTEL`、`TRANSPORT`、`ACTIVITY` |
| `notifications[].message` | string | 通知消息 |
| `notifications[].actionRequired` | boolean | 是否需要用户操作 |

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "行程 ID f3626ff1-7a9b-46d9-8b8b-7f53a14583b1 不存在"
  }
}
```

```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "修改类型 MOVE_ACTIVITY 需要提供 itemId"
  }
}
```

**前端对接要点**:

1. **批量修改**:
   - 支持一次提交多个修改操作
   - 系统会按顺序处理所有修改
   - 如果某个修改失败，会返回错误但已执行的修改不会回滚

2. **修改类型**:
   - `CHANGE_DATE`: 更改整个行程的日期范围
   - `MOVE_ACTIVITY`: 将活动移动到其他日期或时间
   - `ADD_ACTIVITY`: 添加新的活动项
   - `REMOVE_ACTIVITY`: 删除指定的活动项

3. **自动适配**:
   - 系统会自动调整关联的酒店、交通等服务
   - 自动重新计算预算
   - 自动修复节奏冲突

4. **通知处理**:
   - 检查 `notifications` 数组，显示需要用户关注的通知
   - 对于 `actionRequired: true` 的通知，提供操作按钮
   - 可以跳转到相关页面（如酒店预订页面）

5. **变更展示**:
   - 在界面上展示 `changes` 数组中的变更信息
   - 高亮显示受影响的行程项
   - 显示预算变更情况

6. **用户体验**:
   - 提交修改后显示加载状态
   - 成功后刷新行程详情页
   - 显示变更摘要和通知
   - 提供撤销操作（如果支持）

7. **错误处理**:
   - 验证修改参数是否完整
   - 显示具体的错误信息
   - 如果行程不存在，提示用户

**使用场景**:

- 用户需要更改行程日期
- 用户想要调整活动顺序
- 用户需要添加或删除活动
- 系统自动修复节奏冲突

**TypeScript 类型定义**:

```typescript
type ModificationType = 'CHANGE_DATE' | 'MOVE_ACTIVITY' | 'ADD_ACTIVITY' | 'REMOVE_ACTIVITY';

interface TripModification {
  type: ModificationType;
  itemId?: string;
  newDate?: string;
  newStartTime?: string;
  activityData?: {
    placeId: number;
    startTime: string;
    endTime: string;
    type: string;
    [key: string]: any;
  };
}

interface AdjustTripRequest {
  modifications: TripModification[];
}

interface TripAdjustmentResult {
  success: boolean;
  adjustedTrip: {
    id: string;
    destination: string;
    startDate: string;
    endDate: string;
    status: string;
  };
  changes: Array<{
    type: string;
    description: string;
    affectedItems: string[];
  }>;
  budgetUpdate?: {
    oldBudget: number;
    newBudget: number;
    changes: string[];
  };
  notifications: Array<{
    type: 'HOTEL' | 'TRANSPORT' | 'ACTIVITY';
    message: string;
    actionRequired: boolean;
  }>;
}
```

---

## 接口 15: 获取行程项详情

**接口地址**: `GET /itinerary-items/:id`

**接口描述**: 根据行程项 ID 获取完整的行程项信息，包括关联的地点（Place）、徒步路线（Trail）和所属的行程日期（TripDay）等详细信息。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 行程项 ID (UUID) |

**响应示例**:

```json
{
  "success": true,
  "data": {
    "id": "f3626ff1-7a9b-46d9-8b8b-7f53a14583b1",
    "tripDayId": "d0f6ab6c-0e94-491b-954c-bb0355e797cf",
    "placeId": 123,
    "trailId": null,
    "type": "ACTIVITY",
    "startTime": "2024-05-01T10:00:00.000Z",
    "endTime": "2024-05-01T12:00:00.000Z",
    "note": "记得穿和服拍照",
    "Place": {
      "id": 123,
      "nameCN": "东京塔",
      "nameEN": "Tokyo Tower",
      "category": "ATTRACTION",
      "address": "4 Chome-2-8 Shibakoen, Minato City, Tokyo",
      "rating": 4.5,
      "metadata": {
        "cost": 1000,
        "duration": 120
      },
      "City": {
        "id": 1,
        "nameCN": "东京",
        "nameEN": "Tokyo"
      }
    },
    "Trail": null,
    "TripDay": {
      "id": "d0f6ab6c-0e94-491b-954c-bb0355e797cf",
      "date": "2024-05-01",
      "Trip": {
        "id": "trip-123",
        "destination": "JP",
        "startDate": "2024-05-01",
        "endDate": "2024-05-05"
      },
      "ItineraryItem": [
        {
          "id": "item-1",
          "type": "ACTIVITY",
          "startTime": "2024-05-01T09:00:00.000Z"
        },
        {
          "id": "item-2",
          "type": "MEAL_ANCHOR",
          "startTime": "2024-05-01T12:00:00.000Z"
        }
      ]
    }
  }
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | string | 行程项 ID |
| `tripDayId` | string | 所属行程日期 ID |
| `placeId` | number \| null | 关联的地点 ID（如果是 TRANSIT 或 REST 可能为空） |
| `trailId` | number \| null | 关联的徒步路线 ID（如果是徒步活动） |
| `type` | string | 行程项类型：`ACTIVITY`、`REST`、`MEAL_ANCHOR`、`MEAL_FLOATING`、`TRANSIT` |
| `startTime` | string | 开始时间（ISO 8601） |
| `endTime` | string | 结束时间（ISO 8601） |
| `note` | string \| null | 备注信息 |
| `Place` | object \| null | 关联的地点详情（如果有关联地点） |
| `Place.id` | number | 地点 ID |
| `Place.nameCN` | string | 地点中文名 |
| `Place.nameEN` | string | 地点英文名 |
| `Place.category` | string | 地点类别 |
| `Place.address` | string | 地址 |
| `Place.rating` | number | 评分 |
| `Place.metadata` | object | 地点元数据（费用、时长等） |
| `Place.City` | object | 所属城市信息 |
| `Trail` | object \| null | 关联的徒步路线详情（如果是徒步活动） |
| `TripDay` | object | 所属行程日期信息 |
| `TripDay.id` | string | 行程日期 ID |
| `TripDay.date` | string | 日期 |
| `TripDay.Trip` | object | 所属行程信息 |
| `TripDay.ItineraryItem` | array | 同一天的其他行程项列表（按时间排序） |

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "行程项 ID f3626ff1-7a9b-46d9-8b8b-7f53a14583b1 不存在"
  }
}
```

**前端对接要点**:

1. **详情展示**:
   - 显示行程项的完整信息
   - 展示关联的地点详情（名称、地址、评分等）
   - 如果是徒步活动，展示徒步路线信息
   - 显示所属的行程日期和行程信息

2. **时间格式化**:
   - 将 ISO 8601 格式的时间转换为用户友好的格式
   - 考虑时区转换
   - 显示持续时长（endTime - startTime）

3. **关联信息**:
   - 如果有关联地点，可以跳转到地点详情页
   - 如果有关联徒步路线，可以跳转到路线详情页
   - 显示同一天的其他行程项，方便用户查看时间安排

4. **编辑功能**:
   - 提供编辑按钮，跳转到编辑页面
   - 提供删除按钮（需要确认）

5. **空值处理**:
   - `Place` 和 `Trail` 可能为 null，需要判断后再显示
   - `note` 可能为空，不显示或显示占位文本

**使用场景**:

- 查看行程项详情
- 编辑行程项前的信息确认
- 查看地点或路线的详细信息

**TypeScript 类型定义**:

```typescript
interface ItineraryItemDetail {
  id: string;
  tripDayId: string;
  placeId: number | null;
  trailId: number | null;
  type: 'ACTIVITY' | 'REST' | 'MEAL_ANCHOR' | 'MEAL_FLOATING' | 'TRANSIT';
  startTime: string;
  endTime: string;
  note: string | null;
  Place: {
    id: number;
    nameCN: string;
    nameEN: string;
    category: string;
    address: string;
    rating: number;
    metadata: any;
    City: {
      id: number;
      nameCN: string;
      nameEN: string;
    };
  } | null;
  Trail: {
    id: number;
    nameCN: string;
    nameEN: string;
    distanceKm: number;
    Place_Trail_startPlaceIdToPlace: any;
    Place_Trail_endPlaceIdToPlace: any;
    TrailWaypoint: any[];
  } | null;
  TripDay: {
    id: string;
    date: string;
    Trip: {
      id: string;
      destination: string;
      startDate: string;
      endDate: string;
    };
    ItineraryItem: Array<{
      id: string;
      type: string;
      startTime: string;
    }>;
  };
}

type GetItineraryItemDetailResponse = ItineraryItemDetail;
```

---

## 接口 16: 更新行程项

**接口地址**: `PATCH /itinerary-items/:id`

**接口描述**: 更新行程项信息（时间、地点、类型、备注等）。如果更新了时间，系统会重新校验营业时间和时间逻辑。支持部分更新，只需传递需要修改的字段。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 行程项 ID (UUID) |

**请求体**:

```json
{
  "startTime": "2024-05-01T11:00:00.000Z",
  "endTime": "2024-05-01T13:00:00.000Z",
  "placeId": 456,
  "note": "更新后的备注信息"
}
```

**参数说明**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `tripDayId` | string | 否 | 行程日期 ID（移动到其他日期时使用） |
| `placeId` | number | 否 | 地点 ID（更换地点时使用） |
| `trailId` | number | 否 | 徒步路线 ID（更换徒步路线时使用） |
| `type` | string | 否 | 行程项类型：`ACTIVITY`、`REST`、`MEAL_ANCHOR`、`MEAL_FLOATING`、`TRANSIT` |
| `startTime` | string | 否 | 开始时间（ISO 8601格式） |
| `endTime` | string | 否 | 结束时间（ISO 8601格式） |
| `note` | string | 否 | 备注信息 |

**响应示例**:

```json
{
  "success": true,
  "data": {
    "id": "f3626ff1-7a9b-46d9-8b8b-7f53a14583b1",
    "tripDayId": "d0f6ab6c-0e94-491b-954c-bb0355e797cf",
    "placeId": 456,
    "trailId": null,
    "type": "ACTIVITY",
    "startTime": "2024-05-01T11:00:00.000Z",
    "endTime": "2024-05-01T13:00:00.000Z",
    "note": "更新后的备注信息",
    "Place": {
      "id": 456,
      "nameCN": "浅草寺",
      "nameEN": "Senso-ji",
      "category": "ATTRACTION",
      "address": "2 Chome-3-1 Asakusa, Taito City, Tokyo",
      "rating": 4.7
    },
    "Trail": null,
    "TripDay": {
      "id": "d0f6ab6c-0e94-491b-954c-bb0355e797cf",
      "date": "2024-05-01"
    }
  }
}
```

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "行程项 ID f3626ff1-7a9b-46d9-8b8b-7f53a14583b1 不存在"
  }
}
```

```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "结束时间必须晚于开始时间"
  }
}
```

```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "该地点在指定时间不营业"
  }
}
```

**前端对接要点**:

1. **部分更新**:
   - 只需要传递需要更新的字段
   - 未传递的字段保持不变
   - 所有字段都是可选的

2. **时间校验**:
   - 如果更新了时间，系统会自动校验：
     - 结束时间必须晚于开始时间
     - 如果有关联地点，校验地点营业时间
     - 校验是否与其他行程项时间冲突
   - 前端也应该进行基本的时间校验，提前提示用户

3. **地点更新**:
   - 如果更新了 `placeId`，系统会重新关联地点信息
   - 如果更新了地点，可能需要重新校验营业时间

4. **日期移动**:
   - 如果更新了 `tripDayId`，行程项会移动到其他日期
   - 需要确保新的日期在行程日期范围内

5. **用户体验**:
   - 更新成功后刷新行程项详情或列表
   - 显示更新成功提示
   - 如果校验失败，显示具体的错误信息
   - 提供撤销操作（如果支持）

6. **表单验证**:
   - 时间格式必须为 ISO 8601
   - 结束时间必须晚于开始时间
   - 如果提供了 `placeId`，验证地点是否存在

7. **错误处理**:
   - 显示具体的验证错误信息
   - 如果行程项不存在，提示用户
   - 如果时间冲突，提示用户并建议调整

**使用场景**:

- 调整行程项的时间
- 更换行程项的地点
- 修改行程项的类型
- 更新备注信息
- 将行程项移动到其他日期

**TypeScript 类型定义**:

```typescript
interface UpdateItineraryItemRequest {
  tripDayId?: string;
  placeId?: number;
  trailId?: number;
  type?: 'ACTIVITY' | 'REST' | 'MEAL_ANCHOR' | 'MEAL_FLOATING' | 'TRANSIT';
  startTime?: string;
  endTime?: string;
  note?: string;
}

interface UpdateItineraryItemResponse {
  id: string;
  tripDayId: string;
  placeId: number | null;
  trailId: number | null;
  type: string;
  startTime: string;
  endTime: string;
  note: string | null;
  Place: any | null;
  Trail: any | null;
  TripDay: {
    id: string;
    date: string;
  };
}
```

---

## 接口 31: 获取行程预算摘要

**接口地址**: `GET /trips/:id/budget/summary`

**接口描述**: 实时查看行程消费和预算情况，包含各类消费明细分类。系统会计算总预算、已消费、剩余预算、每日预算和各类别消费统计，并生成预算警告。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 行程 ID (UUID) |

**请求参数**: 无

**响应示例**:

```json
{
  "success": true,
  "data": {
    "totalBudget": 20000,
    "totalSpent": 8500,
    "remaining": 11500,
    "dailyBudget": 4000,
    "dailySpent": {
      "2024-05-01": 3500,
      "2024-05-02": 2800,
      "2024-05-03": 2200
    },
    "categoryBreakdown": {
      "accommodation": 3000,
      "transportation": 2000,
      "food": 2500,
      "activities": 800,
      "other": 200
    },
    "warnings": [
      {
        "type": "APPROACHING_LIMIT",
        "message": "预算使用率已达 42.5%，接近预算上限",
        "severity": "warning"
      },
      {
        "type": "DAILY_EXCEEDED",
        "message": "2024-05-01 当日消费 3500 CNY，超出每日预算 12.5%",
        "severity": "warning"
      }
    ]
  }
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `totalBudget` | number | 总预算（单位：人民币 CNY） |
| `totalSpent` | number | 已消费金额 |
| `remaining` | number | 剩余预算 |
| `dailyBudget` | number | 每日预算（总预算 / 天数） |
| `dailySpent` | object | 每日消费记录，键为日期（YYYY-MM-DD），值为消费金额 |
| `categoryBreakdown` | object | 按类别统计的消费 |
| `categoryBreakdown.accommodation` | number | 住宿消费 |
| `categoryBreakdown.transportation` | number | 交通消费 |
| `categoryBreakdown.food` | number | 餐饮消费 |
| `categoryBreakdown.activities` | number | 活动消费 |
| `categoryBreakdown.other` | number | 其他消费 |
| `warnings` | array | 预算警告列表 |
| `warnings[].type` | string | 警告类型：`OVERSPEND`（超支）、`APPROACHING_LIMIT`（接近上限）、`DAILY_EXCEEDED`（每日超支） |
| `warnings[].message` | string | 警告消息 |
| `warnings[].severity` | string | 严重程度：`warning`（警告）、`error`（错误） |

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "行程 f3626ff1-7a9b-46d9-8b8b-7f53a14583b1 不存在"
  }
}
```

**前端对接要点**:

1. **预算概览页面**:
   - 创建预算管理页面
   - 使用卡片或仪表盘布局展示关键指标
   - 突出显示总预算、已消费、剩余预算

2. **数据可视化**:
   - 使用进度条显示预算使用率
   - 使用饼图展示类别消费分布
   - 使用柱状图展示每日消费趋势
   - 使用不同颜色标识预算状态（绿色：正常，黄色：警告，红色：超支）

3. **警告展示**:
   - 如果有警告，在页面顶部显示警告横幅
   - 根据 `severity` 使用不同颜色（警告：黄色，错误：红色）
   - 显示警告消息，提供"查看详情"链接

4. **类别消费**:
   - 展示各类别消费金额和占比
   - 可以点击查看该类别的详细消费列表
   - 提供筛选功能，按类别查看

5. **每日消费**:
   - 展示每日消费金额
   - 对比每日预算，显示是否超支
   - 可以点击日期查看当日详细消费

6. **实时更新**:
   - 添加或修改行程项后，自动刷新预算摘要
   - 可以手动刷新获取最新数据
   - 使用轮询或 WebSocket 实时更新

7. **操作功能**:
   - 提供"查看优化建议"按钮
   - 提供"生成预算报告"按钮
   - 提供"导出预算数据"功能

8. **用户体验**:
   - 显示加载状态
   - 如果数据为空，显示友好提示
   - 提供帮助说明，解释各项指标的含义

**使用场景**:

- 查看行程预算使用情况
- 监控消费趋势
- 及时发现预算超支
- 规划后续消费

**TypeScript 类型定义**:

```typescript
interface BudgetSummary {
  totalBudget: number;
  totalSpent: number;
  remaining: number;
  dailyBudget: number;
  dailySpent: Record<string, number>;
  categoryBreakdown: {
    accommodation: number;
    transportation: number;
    food: number;
    activities: number;
    other: number;
  };
  warnings: Array<{
    type: 'OVERSPEND' | 'APPROACHING_LIMIT' | 'DAILY_EXCEEDED';
    message: string;
    severity: 'warning' | 'error';
  }>;
}
```

---

## 接口 32: 检查预算预警

**接口地址**: `GET /trips/:id/budget/alert`

**接口描述**: 添加新活动前检查是否会触发预算预警。系统会计算添加新活动后的预算使用情况，如果可能超支或接近预算上限，会返回预警信息和建议。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 行程 ID (UUID) |

**查询参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `cost` | number | 是 | 新增项的成本（单位：人民币 CNY） |

**请求示例**:

```
GET /trips/f3626ff1-7a9b-46d9-8b8b-7f53a14583b1/budget/alert?cost=5000
```

**响应示例（有预警）**:

```json
{
  "success": true,
  "data": {
    "type": "APPROACHING_LIMIT",
    "message": "添加此项后预算使用率将达 92.5%",
    "severity": "warning",
    "suggestions": [
      "考虑选择更便宜的替代方案",
      "调整其他天的活动安排"
    ]
  }
}
```

**响应示例（超支预警）**:

```json
{
  "success": true,
  "data": {
    "type": "OVERSPEND",
    "message": "添加此项将导致预算超支 12.5%",
    "severity": "error",
    "suggestions": [
      "移除其他可选活动",
      "选择更便宜的替代方案",
      "调整其他天的预算分配"
    ]
  }
}
```

**响应示例（无预警）**:

```json
{
  "success": true,
  "data": null
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `data` | object\|null | 预算预警（如果没有预警则为 null） |
| `data.type` | string | 预警类型：`OVERSPEND`（超支）、`APPROACHING_LIMIT`（接近上限） |
| `data.message` | string | 预警消息 |
| `data.severity` | string | 严重程度：`warning`（警告）、`error`（错误） |
| `data.suggestions` | array | 优化建议列表 |

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "行程 f3626ff1-7a9b-46d9-8b8b-7f53a14583b1 不存在"
  }
}
```

**前端对接要点**:

1. **添加活动时检查**:
   - 在添加新活动或选择地点时，自动调用此接口
   - 传入活动的预估成本
   - 在用户确认添加前显示预警

2. **预警展示**:
   - 如果有预警，在添加活动对话框中显示警告
   - 根据 `severity` 使用不同颜色和图标
   - 显示预警消息和优化建议

3. **用户选择**:
   - 提供"继续添加"和"取消"按钮
   - 如果预警严重（`severity: 'error'`），建议用户谨慎操作
   - 可以点击建议查看相关操作

4. **建议处理**:
   - 显示所有优化建议
   - 可以点击建议执行相应操作（如查看替代方案）
   - 提供"查看预算优化建议"链接

5. **成本输入**:
   - 如果活动没有预设成本，提供输入框让用户输入
   - 实时检查并显示预警
   - 可以调整成本后重新检查

6. **无预警处理**:
   - 如果没有预警，显示"预算充足"提示
   - 可以正常添加活动
   - 仍然显示添加后的预算使用率

7. **集成到流程**:
   - 在选择地点时显示预估成本
   - 在确认添加前检查预算
   - 添加成功后更新预算摘要

8. **用户体验**:
   - 预警信息要清晰易懂
   - 提供具体的优化建议
   - 不要阻止用户操作，只是提醒

**使用场景**:

- 添加新活动前检查预算
- 选择地点时评估成本
- 防止预算超支
- 获取优化建议

**TypeScript 类型定义**:

```typescript
interface BudgetAlert {
  type: 'OVERSPEND' | 'APPROACHING_LIMIT';
  message: string;
  severity: 'warning' | 'error';
  suggestions: string[];
}

type CheckBudgetAlertResponse = BudgetAlert | null;
```

---

## 接口 19: 地点推荐

**接口地址**: `GET /places/recommendations`

**接口描述**: 根据用户偏好、行程信息、地理位置等条件，获取地点推荐列表。系统会综合考虑用户偏好、地点评分、距离、类别等因素进行智能推荐。

**查询参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `tripId` | string | 否 | 行程 ID，如果提供，会根据行程信息推荐相关地点 |
| `lat` | number | 否 | 纬度，用于距离排序和筛选 |
| `lng` | number | 否 | 经度，用于距离排序和筛选 |
| `radius` | number | 否 | 搜索半径（米），默认 5000 |
| `category` | string | 否 | 地点类别：`RESTAURANT`、`ATTRACTION`、`SHOPPING`、`HOTEL` |
| `preferredTypes` | string | 否 | 偏好的景点类型（逗号分隔），如：`ATTRACTION,NATURE,CULTURE` |
| `preferOffbeat` | boolean | 否 | 是否偏好小众景点，默认 false |
| `limit` | number | 否 | 返回数量限制，默认 20，最大 100 |

**请求示例**:

```
GET /places/recommendations?tripId=f3626ff1-7a9b-46d9-8b8b-7f53a14583b1&category=ATTRACTION&limit=10
GET /places/recommendations?lat=34.6937&lng=135.5023&radius=2000&preferredTypes=ATTRACTION,NATURE&preferOffbeat=true
```

**响应示例**:

```json
{
  "success": true,
  "data": [
    {
      "id": 123,
      "nameCN": "东京塔",
      "nameEN": "Tokyo Tower",
      "category": "ATTRACTION",
      "address": "4 Chome-2-8 Shibakoen, Minato City, Tokyo",
      "rating": 4.5,
      "distance": 1200,
      "matchReasons": [
        "符合您的景点类型偏好",
        "评分较高（4.5/5）",
        "距离当前位置较近"
      ],
      "metadata": {
        "cost": 1000,
        "duration": 120,
        "openingHours": "09:00-22:00"
      }
    },
    {
      "id": 456,
      "nameCN": "浅草寺",
      "nameEN": "Senso-ji",
      "category": "ATTRACTION",
      "address": "2 Chome-3-1 Asakusa, Taito City, Tokyo",
      "rating": 4.7,
      "distance": 2500,
      "matchReasons": [
        "符合您的文化景点偏好",
        "评分很高（4.7/5）",
        "热门景点"
      ],
      "metadata": {
        "cost": 0,
        "duration": 90,
        "openingHours": "06:00-17:00"
      }
    }
  ]
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `data` | array | 推荐地点列表 |
| `data[].id` | number | 地点 ID |
| `data[].nameCN` | string | 地点中文名 |
| `data[].nameEN` | string \| null | 地点英文名 |
| `data[].category` | string | 地点类别 |
| `data[].address` | string | 地址 |
| `data[].rating` | number | 评分（0-5） |
| `data[].distance` | number \| null | 距离（米），如果提供了经纬度 |
| `data[].matchReasons` | array | 推荐原因列表 |
| `data[].metadata` | object | 地点元数据（费用、时长、营业时间等） |

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "radius 必须大于 0"
  }
}
```

**前端对接要点**:

1. **推荐展示**:
   - 使用卡片或列表布局展示推荐地点
   - 显示地点名称、评分、距离等关键信息
   - 突出显示推荐原因（`matchReasons`）

2. **筛选和排序**:
   - 提供类别筛选（餐厅、景点、购物、酒店）
   - 提供距离排序（如果提供了经纬度）
   - 提供评分排序
   - 支持偏好筛选（小众景点、特定类型等）

3. **个性化推荐**:
   - 如果用户已登录，自动应用用户偏好设置
   - 根据行程信息推荐相关地点
   - 考虑用户的历史行为（如果可用）

4. **地图展示**:
   - 如果提供了经纬度，在地图上标记推荐地点
   - 显示距离和路线
   - 支持点击地点查看详情

5. **交互功能**:
   - 点击地点卡片跳转到地点详情页
   - 提供"添加到行程"按钮
   - 提供"收藏"功能
   - 支持分享推荐

6. **加载和分页**:
   - 显示加载状态
   - 支持分页或无限滚动
   - 可以调整返回数量（limit）

7. **空状态处理**:
   - 如果没有推荐结果，显示友好提示
   - 建议用户调整筛选条件
   - 提供"查看所有地点"链接

8. **推荐原因展示**:
   - 在卡片上显示推荐原因
   - 使用图标或标签标识不同类型的推荐原因
   - 帮助用户理解为什么推荐这个地点

**使用场景**:

- 创建行程时寻找合适的地点
- 在行程中添加新活动
- 探索目的地附近的景点
- 根据偏好发现小众地点

**TypeScript 类型定义**:

```typescript
interface PlaceRecommendation {
  id: number;
  nameCN: string;
  nameEN: string | null;
  category: 'RESTAURANT' | 'ATTRACTION' | 'SHOPPING' | 'HOTEL';
  address: string;
  rating: number;
  distance?: number;
  matchReasons: string[];
  metadata: {
    cost?: number;
    duration?: number;
    openingHours?: string;
    [key: string]: any;
  };
}

type GetPlaceRecommendationsResponse = PlaceRecommendation[];
```

---

## 接口 20: 路线方向查询

**接口地址**: `GET /route-directions/details`

**接口描述**: 获取路线方向详情信息，包括路线名称、描述、标签、区域、入口枢纽、季节性信息、约束条件、风险档案、标志性景点、行程骨架等详细信息。用于了解特定路线方向的完整信息。

**查询参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | number | 条件必填 | 路线方向 ID（与 uuid 二选一） |
| `uuid` | string | 条件必填 | 路线方向 UUID（与 id 二选一） |
| `countryCode` | string | 否 | 国家代码，用于筛选 |
| `tag` | string | 否 | 标签，用于筛选 |
| `tags` | string | 否 | 标签数组（逗号分隔），用于筛选 |
| `isActive` | boolean | 否 | 是否激活，默认 true |
| `month` | number | 否 | 月份（1-12），用于季节性筛选 |

**请求示例**:

```
GET /route-directions/details?id=1
GET /route-directions/details?uuid=abc-123-def
GET /route-directions/details?countryCode=JP&tag=CULTURE&month=4
```

**响应示例**:

```json
{
  "success": true,
  "data": {
    "id": 1,
    "uuid": "abc-123-def-456",
    "countryCode": "JP",
    "name": "关西文化之旅",
    "nameCN": "关西文化之旅",
    "nameEN": "Kansai Culture Route",
    "description": "探索关西地区的传统文化，包括京都、奈良、大阪等历史名城",
    "tags": ["CULTURE", "HISTORY", "TRADITIONAL"],
    "regions": ["Kansai", "Kansai Region"],
    "entryHubs": ["Osaka", "Kyoto"],
    "seasonality": {
      "bestMonths": [3, 4, 10, 11],
      "avoidMonths": [7, 8],
      "reasons": {
        "best": "春季樱花和秋季红叶",
        "avoid": "夏季高温多雨"
      }
    },
    "constraints": {
      "minDays": 5,
      "maxDays": 10,
      "recommendedDays": 7,
      "difficulty": "EASY",
      "budgetRange": {
        "min": 15000,
        "max": 30000,
        "currency": "CNY"
      }
    },
    "riskProfile": {
      "safety": "HIGH",
      "health": "LOW",
      "weather": "MODERATE",
      "notes": "整体安全，注意夏季高温"
    },
    "signaturePois": [
      {
        "id": 123,
        "nameCN": "清水寺",
        "nameEN": "Kiyomizu-dera",
        "category": "ATTRACTION",
        "importance": "HIGH"
      },
      {
        "id": 456,
        "nameCN": "奈良公园",
        "nameEN": "Nara Park",
        "category": "ATTRACTION",
        "importance": "HIGH"
      }
    ],
    "itinerarySkeleton": {
      "days": 7,
      "dailyPlan": [
        {
          "day": 1,
          "city": "Osaka",
          "highlights": ["大阪城", "道顿堀"]
        },
        {
          "day": 2,
          "city": "Kyoto",
          "highlights": ["清水寺", "金阁寺"]
        }
      ]
    },
    "metadata": {
      "popularity": 8.5,
      "rating": 4.6,
      "reviewCount": 1250
    },
    "isActive": true,
    "status": "active",
    "version": "1.0",
    "createdAt": "2024-01-01T00:00:00.000Z",
    "updatedAt": "2024-04-01T00:00:00.000Z"
  }
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | number | 路线方向 ID |
| `uuid` | string | 路线方向 UUID |
| `countryCode` | string | 国家代码 |
| `name` | string | 路线名称 |
| `nameCN` | string | 路线中文名 |
| `nameEN` | string \| null | 路线英文名 |
| `description` | string \| null | 路线描述 |
| `tags` | array | 标签列表 |
| `regions` | array | 区域列表 |
| `entryHubs` | array | 入口枢纽（推荐入口城市） |
| `seasonality` | object \| null | 季节性信息 |
| `seasonality.bestMonths` | array | 最佳月份（1-12） |
| `seasonality.avoidMonths` | array | 避免月份（1-12） |
| `seasonality.reasons` | object | 原因说明 |
| `constraints` | object \| null | 约束条件 |
| `constraints.minDays` | number | 最少天数 |
| `constraints.maxDays` | number | 最多天数 |
| `constraints.recommendedDays` | number | 推荐天数 |
| `constraints.difficulty` | string | 难度等级 |
| `constraints.budgetRange` | object | 预算范围 |
| `riskProfile` | object \| null | 风险档案 |
| `riskProfile.safety` | string | 安全等级：`HIGH`、`MODERATE`、`LOW` |
| `riskProfile.health` | string | 健康风险：`HIGH`、`MODERATE`、`LOW` |
| `riskProfile.weather` | string | 天气风险：`HIGH`、`MODERATE`、`LOW` |
| `signaturePois` | array | 标志性景点列表 |
| `itinerarySkeleton` | object \| null | 行程骨架（建议行程框架） |
| `metadata` | object | 元数据（受欢迎程度、评分等） |
| `isActive` | boolean | 是否激活 |
| `status` | string | 状态 |
| `version` | string \| null | 版本号 |

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "Route direction with ID 1 not found"
  }
}
```

```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "必须提供 id 或 uuid 之一"
  }
}
```

**前端对接要点**:

1. **详情展示**:
   - 使用详情页展示路线方向的完整信息
   - 分区块展示：基本信息、季节性、约束条件、风险档案、标志性景点、行程骨架等
   - 使用卡片或标签展示标签、区域等信息

2. **季节性信息**:
   - 使用日历或月份选择器展示最佳月份和避免月份
   - 显示季节性原因说明
   - 如果当前月份不在最佳月份，给出提示

3. **约束条件**:
   - 显示天数范围和建议天数
   - 显示难度等级（使用图标或颜色标识）
   - 显示预算范围，与用户预算对比

4. **风险档案**:
   - 使用颜色标识不同风险等级（绿色：低，黄色：中，红色：高）
   - 显示风险说明和注意事项
   - 提供安全建议

5. **标志性景点**:
   - 展示标志性景点列表
   - 可以点击跳转到地点详情页
   - 显示景点重要性（HIGH、MEDIUM、LOW）

6. **行程骨架**:
   - 展示建议的行程框架
   - 显示每日城市和亮点
   - 可以作为创建行程的模板

7. **交互功能**:
   - 提供"使用此路线创建行程"按钮
   - 提供"收藏"功能
   - 提供"分享"功能
   - 可以查看相关路线方向

8. **筛选和查询**:
   - 支持按国家代码筛选
   - 支持按标签筛选
   - 支持按月份筛选（季节性）
   - 支持按激活状态筛选

9. **地图展示**:
   - 在地图上展示路线方向覆盖的区域
   - 标记入口枢纽城市
   - 标记标志性景点

10. **用户体验**:
    - 显示加载状态
    - 如果路线方向不存在，显示友好提示
    - 提供返回列表的链接
    - 支持打印或导出路线信息

**使用场景**:

- 了解特定路线方向的详细信息
- 规划行程时选择路线方向
- 查看路线方向的季节性建议
- 了解路线方向的风险和安全信息

**TypeScript 类型定义**:

```typescript
interface Seasonality {
  bestMonths: number[];
  avoidMonths: number[];
  reasons: {
    best?: string;
    avoid?: string;
  };
}

interface Constraints {
  minDays: number;
  maxDays: number;
  recommendedDays: number;
  difficulty: 'EASY' | 'MODERATE' | 'HARD';
  budgetRange: {
    min: number;
    max: number;
    currency: string;
  };
}

interface RiskProfile {
  safety: 'HIGH' | 'MODERATE' | 'LOW';
  health: 'HIGH' | 'MODERATE' | 'LOW';
  weather: 'HIGH' | 'MODERATE' | 'LOW';
  notes?: string;
}

interface SignaturePoi {
  id: number;
  nameCN: string;
  nameEN: string;
  category: string;
  importance: 'HIGH' | 'MEDIUM' | 'LOW';
}

interface ItinerarySkeleton {
  days: number;
  dailyPlan: Array<{
    day: number;
    city: string;
    highlights: string[];
  }>;
}

interface RouteDirectionDetail {
  id: number;
  uuid: string;
  countryCode: string;
  name: string;
  nameCN: string;
  nameEN: string | null;
  description: string | null;
  tags: string[];
  regions: string[];
  entryHubs: string[];
  seasonality: Seasonality | null;
  constraints: Constraints | null;
  riskProfile: RiskProfile | null;
  signaturePois: SignaturePoi[];
  itinerarySkeleton: ItinerarySkeleton | null;
  metadata: Record<string, any>;
  isActive: boolean;
  status: string;
  version: string | null;
  createdAt: string;
  updatedAt: string;
}

type GetRouteDirectionDetailsResponse = RouteDirectionDetail | RouteDirectionDetail[];
```

---

## 接口 17: 删除行程项

**接口地址**: `DELETE /itinerary-items/:id`

**接口描述**: 删除指定的行程项。删除后，该行程项将从行程中移除，系统不会自动调整其他行程项的时间。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 行程项 ID (UUID) |

**响应示例**:

```json
{
  "success": true,
  "data": {
    "message": "删除成功"
  }
}
```

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "找不到指定的行程项 (ID: f3626ff1-7a9b-46d9-8b8b-7f53a14583b1)"
  }
}
```

**前端对接要点**:

1. **删除确认**:
   - 删除操作不可逆，必须显示确认对话框
   - 确认对话框中显示要删除的行程项信息（地点名称、时间等）
   - 提供"确认删除"和"取消"按钮

2. **删除后处理**:
   - 删除成功后，从列表中移除该行程项
   - 刷新行程详情页或列表页
   - 显示删除成功提示
   - 如果删除的是当前正在查看的行程项，跳转到行程列表或详情页

3. **批量删除**:
   - 如果支持批量删除，可以一次删除多个行程项
   - 显示删除数量确认
   - 批量删除时，逐个调用删除接口或使用批量删除接口（如果有）

4. **关联检查**:
   - 如果行程项有关联的预订或服务，删除前需要提示用户
   - 建议用户先取消相关预订再删除

5. **用户体验**:
   - 删除操作应该有加载状态
   - 删除成功后显示友好的提示信息
   - 如果删除失败，显示具体的错误信息
   - 可以考虑添加撤销功能（在一定时间内可以恢复）

6. **权限检查**:
   - 确保用户有权限删除该行程项
   - 如果是共享行程，检查用户是否有删除权限

7. **数据同步**:
   - 删除后需要更新相关的统计数据（如总活动数、预算等）
   - 如果删除后导致时间空档，可以提示用户是否需要添加新活动

**使用场景**:

- 用户想要移除不需要的活动
- 调整行程安排
- 取消已添加的活动

**TypeScript 类型定义**:

```typescript
interface DeleteItineraryItemResponse {
  message: string;
}
```

---

## 接口 18: 获取用户信息

**接口地址**: `GET /users/profile`

**接口描述**: 获取当前登录用户的偏好画像信息，包括喜欢的景点类型、饮食禁忌、是否偏好小众景点、出行偏好等。如果用户没有设置过偏好，返回空画像。需要 JWT Bearer token 认证。

**请求头**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `Authorization` | string | 是 | JWT Bearer token，格式：`Bearer <token>` |

**响应示例（有偏好设置）**:

```json
{
  "success": true,
  "data": {
    "userId": "user-123",
    "preferences": {
      "preferredAttractionTypes": ["ATTRACTION", "NATURE", "CULTURE"],
      "dietaryRestrictions": ["VEGETARIAN", "NO_PORK"],
      "preferOffbeatAttractions": false,
      "travelPreferences": {
        "pace": "LEISURE",
        "budget": "MEDIUM",
        "accommodation": "COMFORTABLE"
      },
      "other": {
        "accessibility": true,
        "petFriendly": false
      }
    },
    "createdAt": "2024-04-01T10:00:00.000Z",
    "updatedAt": "2024-04-15T14:30:00.000Z"
  }
}
```

**响应示例（无偏好设置）**:

```json
{
  "success": true,
  "data": {
    "userId": "user-123",
    "preferences": undefined,
    "createdAt": "2024-04-01T10:00:00.000Z",
    "updatedAt": "2024-04-01T10:00:00.000Z"
  }
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `userId` | string | 用户 ID |
| `preferences` | object \| undefined | 用户偏好配置（如果未设置则为 undefined） |
| `preferences.preferredAttractionTypes` | array | 喜欢的景点类型列表，如：`["ATTRACTION", "NATURE", "CULTURE"]` |
| `preferences.dietaryRestrictions` | array | 饮食禁忌列表，如：`["VEGETARIAN", "NO_PORK", "NO_SEAFOOD"]` |
| `preferences.preferOffbeatAttractions` | boolean | 是否偏好小众景点 |
| `preferences.travelPreferences` | object | 出行偏好 |
| `preferences.travelPreferences.pace` | string | 节奏偏好：`LEISURE`（悠闲）、`MODERATE`（适中）、`FAST`（快速） |
| `preferences.travelPreferences.budget` | string | 预算偏好：`LOW`（低）、`MEDIUM`（中）、`HIGH`（高） |
| `preferences.travelPreferences.accommodation` | string | 住宿偏好：`BUDGET`（经济）、`COMFORTABLE`（舒适）、`LUXURY`（豪华） |
| `preferences.other` | object | 其他偏好（JSON 格式，可扩展） |
| `createdAt` | string | 创建时间（ISO 8601） |
| `updatedAt` | string | 更新时间（ISO 8601） |

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "UNAUTHORIZED",
    "message": "未认证或 token 无效"
  }
}
```

```json
{
  "success": false,
  "error": {
    "code": "INTERNAL_ERROR",
    "message": "获取用户信息失败"
  }
}
```

**前端对接要点**:

1. **认证处理**:
   - 必须在请求头中携带 JWT Bearer token
   - 如果 token 过期或无效，跳转到登录页
   - 处理 401 未认证错误

2. **用户偏好展示**:
   - 在用户设置页面展示偏好信息
   - 如果 `preferences` 为 `undefined`，显示"未设置偏好"提示
   - 提供编辑按钮，跳转到偏好设置页面

3. **偏好应用**:
   - 在创建行程时，使用用户偏好作为默认值
   - 在推荐地点时，考虑用户的偏好设置
   - 在筛选地点时，应用饮食禁忌等偏好

4. **空状态处理**:
   - 如果用户没有设置偏好，显示引导用户设置偏好的提示
   - 提供"立即设置"按钮

5. **数据缓存**:
   - 用户偏好信息变化不频繁，可以缓存
   - 在应用启动时获取用户偏好
   - 更新偏好后刷新缓存

6. **个性化推荐**:
   - 根据用户偏好推荐相关地点
   - 在行程规划时考虑用户的节奏偏好
   - 根据预算偏好推荐酒店档次

7. **用户体验**:
   - 显示加载状态
   - 如果获取失败，显示友好的错误提示
   - 提供重试机制

**使用场景**:

- 查看用户偏好设置
- 创建行程时应用用户偏好
- 个性化推荐地点和活动
- 用户设置页面展示

**TypeScript 类型定义**:

```typescript
interface UserPreferences {
  preferredAttractionTypes?: string[];
  dietaryRestrictions?: string[];
  preferOffbeatAttractions?: boolean;
  travelPreferences?: {
    pace?: 'LEISURE' | 'MODERATE' | 'FAST';
    budget?: 'LOW' | 'MEDIUM' | 'HIGH';
    accommodation?: 'BUDGET' | 'COMFORTABLE' | 'LUXURY';
  };
  other?: Record<string, any>;
}

interface GetUserProfileResponse {
  userId: string;
  preferences?: UserPreferences;
  createdAt: string;
  updatedAt: string;
}
```

---

## 接口 33: 获取预算优化建议

**接口地址**: `GET /trips/:id/budget/optimization`

**接口描述**: 提供合理的预算优化建议，包括替换、移除、调整等方案。系统会分析当前预算使用情况，如果预算超支或接近上限，会提供具体的优化建议和预估节省金额。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 行程 ID (UUID) |

**查询参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `category` | string | 否 | 消费类别（可选，用于筛选特定类别的优化建议） |

**请求示例**:

```
GET /trips/f3626ff1-7a9b-46d9-8b8b-7f53a14583b1/budget/optimization
GET /trips/f3626ff1-7a9b-46d9-8b8b-7f53a14583b1/budget/optimization?category=activities
```

**响应示例**:

```json
{
  "success": true,
  "data": [
    {
      "type": "REMOVE",
      "message": "移除 \"东京塔\" 可节省约 500.00 元",
      "itemId": "item-123",
      "itemName": "东京塔",
      "estimatedSavings": 500
    },
    {
      "type": "REPLACE",
      "message": "将 \"高级餐厅\" 替换为 \"经济餐厅\" 可节省约 300.00 元",
      "itemId": "item-456",
      "itemName": "高级餐厅",
      "estimatedSavings": 300
    },
    {
      "type": "RESCHEDULE",
      "message": "将活动调整到其他日期可节省约 200.00 元",
      "itemId": "item-789",
      "itemName": "某活动",
      "estimatedSavings": 200
    }
  ]
}
```

**空列表响应**:

```json
{
  "success": true,
  "data": []
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `data` | array | 优化建议列表 |
| `data[].type` | string | 建议类型：`REPLACE`（替换）、`REMOVE`（移除）、`RESCHEDULE`（调整时间） |
| `data[].message` | string | 建议描述 |
| `data[].itemId` | string | 相关行程项 ID（可选） |
| `data[].itemName` | string | 相关行程项名称（可选） |
| `data[].estimatedSavings` | number | 预估节省金额（单位：人民币 CNY） |

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "行程 f3626ff1-7a9b-46d9-8b8b-7f53a14583b1 不存在"
  }
}
```

**前端对接要点**:

1. **优化建议页面**:
   - 在预算管理页面提供"查看优化建议"按钮
   - 创建专门的优化建议页面
   - 使用卡片或列表布局展示建议

2. **建议展示**:
   - 按节省金额排序（从高到低）
   - 使用不同图标标识建议类型
   - 突出显示预估节省金额
   - 显示相关行程项信息

3. **操作功能**:
   - 对于 `REMOVE` 类型，提供"移除"按钮
   - 对于 `REPLACE` 类型，提供"查看替代方案"按钮
   - 对于 `RESCHEDULE` 类型，提供"调整时间"按钮
   - 点击后执行相应操作

4. **筛选功能**:
   - 如果提供了 `category` 参数，只显示该类别的建议
   - 提供筛选器，让用户按类别筛选
   - 可以按建议类型筛选

5. **批量操作**:
   - 提供"应用所有建议"功能（谨慎使用）
   - 允许用户选择多个建议一起应用
   - 显示应用后的预估节省总额

6. **详细信息**:
   - 点击建议可以查看详细信息
   - 显示相关行程项的完整信息
   - 显示应用建议后的预算变化

7. **空状态处理**:
   - 如果没有优化建议，显示友好提示
   - 说明当前预算使用情况良好
   - 可以显示预算使用率

8. **实时更新**:
   - 应用建议后，自动刷新预算摘要
   - 重新获取优化建议
   - 更新相关数据

**使用场景**:

- 预算超支时寻找优化方案
- 想要节省预算
- 寻找更经济的替代方案
- 调整行程以控制成本

**TypeScript 类型定义**:

```typescript
interface BudgetOptimizationSuggestion {
  type: 'REPLACE' | 'REMOVE' | 'RESCHEDULE';
  message: string;
  itemId?: string;
  itemName?: string;
  estimatedSavings: number;
}

type GetBudgetOptimizationResponse = BudgetOptimizationSuggestion[];
```

---

## 接口 34: 生成预算执行分析报告

**接口地址**: `GET /trips/:id/budget/report`

**接口描述**: 行程结束后生成预算执行分析报告，包含消费趋势和优化建议。系统会分析整个行程的预算使用情况，生成每日消费趋势、类别分布和优化建议，用于行程总结和未来规划。

**路径参数**:

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| `id` | string | 是 | 行程 ID (UUID) |

**请求参数**: 无

**响应示例**:

```json
{
  "success": true,
  "data": {
    "summary": {
      "totalBudget": 20000,
      "totalSpent": 18500,
      "remaining": 1500,
      "dailyBudget": 4000,
      "dailySpent": {
        "2024-05-01": 3500,
        "2024-05-02": 4200,
        "2024-05-03": 3800,
        "2024-05-04": 3500,
        "2024-05-05": 3500
      },
      "categoryBreakdown": {
        "accommodation": 6000,
        "transportation": 4000,
        "food": 5000,
        "activities": 3000,
        "other": 500
      },
      "warnings": []
    },
    "trends": {
      "dailySpending": [
        {
          "date": "2024-05-01",
          "budget": 4000,
          "spent": 3500,
          "ratio": 0.875
        },
        {
          "date": "2024-05-02",
          "budget": 4000,
          "spent": 4200,
          "ratio": 1.05
        },
        {
          "date": "2024-05-03",
          "budget": 4000,
          "spent": 3800,
          "ratio": 0.95
        },
        {
          "date": "2024-05-04",
          "budget": 4000,
          "spent": 3500,
          "ratio": 0.875
        },
        {
          "date": "2024-05-05",
          "budget": 4000,
          "spent": 3500,
          "ratio": 0.875
        }
      ],
      "categoryDistribution": {
        "accommodation": 0.324,
        "transportation": 0.216,
        "food": 0.270,
        "activities": 0.162,
        "other": 0.027
      }
    },
    "recommendations": [
      "餐饮消费占比偏高，可考虑选择更经济的餐厅",
      "活动消费占比偏低，可适当增加体验类活动"
    ]
  }
}
```

**响应字段说明**:

| 字段 | 类型 | 说明 |
|------|------|------|
| `summary` | object | 预算摘要（与接口31相同结构） |
| `trends` | object | 消费趋势数据 |
| `trends.dailySpending` | array | 每日消费趋势 |
| `trends.dailySpending[].date` | string | 日期（YYYY-MM-DD） |
| `trends.dailySpending[].budget` | number | 当日预算 |
| `trends.dailySpending[].spent` | number | 当日消费 |
| `trends.dailySpending[].ratio` | number | 消费比率（spent / budget） |
| `trends.categoryDistribution` | object | 类别分布（占比，0-1之间） |
| `trends.categoryDistribution.accommodation` | number | 住宿占比 |
| `trends.categoryDistribution.transportation` | number | 交通占比 |
| `trends.categoryDistribution.food` | number | 餐饮占比 |
| `trends.categoryDistribution.activities` | number | 活动占比 |
| `trends.categoryDistribution.other` | number | 其他占比 |
| `recommendations` | array | 优化建议列表 |

**错误响应**:

```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "行程 f3626ff1-7a9b-46d9-8b8b-7f53a14583b1 不存在"
  }
}
```

**前端对接要点**:

1. **报告页面**:
   - 创建预算分析报告页面
   - 使用仪表盘或报告布局
   - 包含摘要、趋势图表和建议

2. **数据可视化**:
   - 使用折线图展示每日消费趋势
   - 对比每日预算和实际消费
   - 使用饼图展示类别分布
   - 使用柱状图对比各类别消费

3. **趋势分析**:
   - 展示每日消费趋势曲线
   - 标记超支日期（ratio > 1）
   - 显示平均每日消费
   - 显示消费波动情况

4. **类别分析**:
   - 展示各类别消费占比
   - 对比各类别预算和实际消费
   - 标识占比异常的类别
   - 提供类别详情查看

5. **建议展示**:
   - 展示所有优化建议
   - 使用列表或卡片布局
   - 可以点击查看详细说明
   - 提供"应用建议"功能

6. **报告导出**:
   - 提供"导出报告"功能
   - 支持导出为 PDF
   - 支持导出为图片
   - 包含所有图表和数据

7. **分享功能**:
   - 提供"分享报告"功能
   - 生成分享链接
   - 支持社交媒体分享

8. **打印功能**:
   - 提供"打印报告"功能
   - 优化打印布局
   - 包含所有关键信息

9. **交互功能**:
   - 图表支持缩放和筛选
   - 可以点击数据点查看详情
   - 支持日期范围筛选
   - 支持类别筛选

10. **用户体验**:
    - 显示报告生成时间
    - 提供刷新功能
    - 显示加载状态
    - 提供帮助说明

**使用场景**:

- 行程结束后总结预算使用情况
- 分析消费趋势和模式
- 为未来行程规划提供参考
- 分享预算执行情况

**TypeScript 类型定义**:

```typescript
interface DailySpendingTrend {
  date: string;
  budget: number;
  spent: number;
  ratio: number;
}

interface CategoryDistribution {
  accommodation: number;
  transportation: number;
  food: number;
  activities: number;
  other: number;
}

interface BudgetReport {
  summary: BudgetSummary;
  trends: {
    dailySpending: DailySpendingTrend[];
    categoryDistribution: CategoryDistribution;
  };
  recommendations: string[];
}
```

---

