# æ™ºèƒ½ä½“åŠ©æ‰‹ API æ–‡æ¡£

## æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°ä¸¤ä¸ªæ™ºèƒ½ä½“åŠ©æ‰‹çš„ API æ¥å£ï¼š
- **è§„åˆ’åŠ©æ‰‹ (Planning Assistant)**: å¸®ç”¨æˆ·è§„åˆ’æ—…è¡Œ
- **è¡Œç¨‹åŠ©æ‰‹ (Journey Assistant)**: é™ªç”¨æˆ·æ‰§è¡Œæ—…ç¨‹

**Base URL**: `/api/agent`

---

## ä¸€ã€è§„åˆ’åŠ©æ‰‹ API

### 1.1 åˆ›å»ºä¼šè¯

å¼€å§‹ä¸€ä¸ªæ–°çš„æ—…è¡Œè§„åˆ’å¯¹è¯ä¼šè¯ã€‚

```
POST /agent/planning-assistant/sessions
```

#### è¯·æ±‚ä½“

```typescript
interface CreateSessionRequest {
  userId?: string;  // ç”¨æˆ·IDï¼ˆå¯é€‰ï¼‰
}
```

#### å“åº”

```typescript
interface CreateSessionResponse {
  sessionId: string;  // ä¼šè¯ID
}
```

#### ç¤ºä¾‹

**è¯·æ±‚**:
```bash
curl -X POST http://localhost:3000/api/agent/planning-assistant/sessions \
  -H "Content-Type: application/json" \
  -d '{}'
```

**å“åº”**:
```json
{
  "sessionId": "cf50c461-e727-45d6-a50f-c6fe1dff3840"
}
```

---

### 1.2 å¯¹è¯

å‘è§„åˆ’åŠ©æ‰‹å‘é€æ¶ˆæ¯ï¼Œè·å–æ™ºèƒ½å›å¤ã€æ¨èå’Œè¡Œç¨‹æ–¹æ¡ˆã€‚

```
POST /agent/planning-assistant/chat
```

#### è¯·æ±‚ä½“

```typescript
interface PlanningChatRequest {
  sessionId: string;           // ä¼šè¯IDï¼ˆå¿…å¡«ï¼‰
  message: string;             // ç”¨æˆ·æ¶ˆæ¯ï¼ˆå¿…å¡«ï¼‰
  userId?: string;             // ç”¨æˆ·ID
  language?: 'en' | 'zh';      // è¯­è¨€åå¥½
  context?: {
    currentLocation?: {        // å½“å‰ä½ç½®
      lat: number;
      lng: number;
    };
    timezone?: string;         // æ—¶åŒº
  };
}
```

#### å“åº”

```typescript
interface PlanningChatResponse {
  // å›å¤æ¶ˆæ¯
  message: string;             // è‹±æ–‡å›å¤
  messageCN: string;           // ä¸­æ–‡å›å¤
  
  // å½“å‰å¯¹è¯é˜¶æ®µ
  phase: 'INITIAL' | 'EXPLORING' | 'RECOMMENDING' | 'PLANNING' | 'COMPARING' | 'ADJUSTING' | 'CONFIRMING' | 'COMPLETED';
  
  // å¼•å¯¼é—®é¢˜ï¼ˆæ¢ç´¢é˜¶æ®µï¼‰
  guidingQuestions?: {
    question: string;
    questionCN: string;
    options?: string[];
    optionsCN?: string[];
    type: 'single' | 'multiple' | 'text' | 'date' | 'number';
  }[];
  
  // ç›®çš„åœ°æ¨èï¼ˆæ¨èé˜¶æ®µï¼‰
  recommendations?: DestinationRecommendation[];
  
  // æ–¹æ¡ˆå€™é€‰ï¼ˆè§„åˆ’é˜¶æ®µï¼‰
  planCandidates?: PlanCandidate[];
  
  // æ–¹æ¡ˆå¯¹æ¯”ï¼ˆå¯¹æ¯”é˜¶æ®µï¼‰
  comparison?: {
    dimensions: string[];
    candidates: { id: string; name: string; scores: Record<string, number>; }[];
    recommendation: string;
    recommendationCN: string;
  };
  
  // ç¡®è®¤çš„è¡Œç¨‹IDï¼ˆå®Œæˆé˜¶æ®µï¼‰
  confirmedTripId?: string;
  
  // å»ºè®®æ“ä½œ
  suggestedActions?: {
    action: string;
    label: string;
    labelCN: string;
  }[];
}

// ç›®çš„åœ°æ¨è
interface DestinationRecommendation {
  id: string;
  countryCode: string;
  name: string;
  nameCN: string;
  description: string;
  descriptionCN: string;
  highlights: string[];
  highlightsCN: string[];
  matchScore: number;           // åŒ¹é…åˆ†æ•° 0-100
  matchReasons: string[];
  matchReasonsCN: string[];
  estimatedBudget: {
    min: number;
    max: number;
    currency: string;
  };
  bestSeasons: string[];
  imageUrl?: string;
  tags: string[];
}

// æ–¹æ¡ˆå€™é€‰
interface PlanCandidate {
  id: string;
  name: string;
  nameCN: string;
  description: string;
  descriptionCN: string;
  destination: string;
  duration: number;              // å¤©æ•°
  highlights: string[];
  estimatedBudget: {
    total: number;
    breakdown: {
      flight: number;
      accommodation: number;
      activities: number;
      food: number;
      other: number;
    };
  };
  pace: 'relaxed' | 'moderate' | 'intensive';
  suitability: {
    score: number;
    reasons: string[];
  };
  warnings?: string[];
}
```

#### ç¤ºä¾‹

**è¯·æ±‚ - æ¢ç´¢é˜¶æ®µ**:
```bash
curl -X POST http://localhost:3000/api/agent/planning-assistant/chat \
  -H "Content-Type: application/json" \
  -d '{
    "sessionId": "cf50c461-e727-45d6-a50f-c6fe1dff3840",
    "message": "æˆ‘æƒ³å»æ—…è¡Œ"
  }'
```

**å“åº”**:
```json
{
  "message": "Great! I'd love to help you plan your trip! ğŸŒŸ\n\nTo give you the best recommendations, I'd like to know a bit more:\n\n1. **When** are you planning to travel?\n2. **Who** will be traveling?\n3. **What's your budget** range?",
  "messageCN": "å¤ªå¥½äº†ï¼æˆ‘å¾ˆä¹æ„å¸®ä½ è§„åˆ’æ—…è¡Œï¼ğŸŒŸ\n\nä¸ºäº†ç»™ä½ æ›´å¥½çš„æ¨èï¼Œæˆ‘æƒ³å…ˆäº†è§£ä¸€ä¸‹ï¼š\n\n1. **ä»€ä¹ˆæ—¶å€™**å‡ºå‘ï¼Ÿ\n2. **è°ä¸€èµ·å»**ï¼Ÿ\n3. **é¢„ç®—å¤§æ¦‚å¤šå°‘**ï¼Ÿ",
  "phase": "EXPLORING",
  "guidingQuestions": [
    {
      "question": "When are you planning to travel?",
      "questionCN": "è®¡åˆ’ä»€ä¹ˆæ—¶å€™å‡ºå‘ï¼Ÿ",
      "type": "text"
    },
    {
      "question": "Who will be traveling?",
      "questionCN": "è°ä¸€èµ·å»ï¼Ÿ",
      "options": ["Solo", "Couple", "Family", "Friends"],
      "optionsCN": ["ç‹¬è‡ªå‡ºè¡Œ", "æƒ…ä¾£", "å®¶åº­", "æœ‹å‹"],
      "type": "single"
    }
  ]
}
```

**è¯·æ±‚ - ç”Ÿæˆæ–¹æ¡ˆ**:
```bash
curl -X POST http://localhost:3000/api/agent/planning-assistant/chat \
  -H "Content-Type: application/json" \
  -d '{
    "sessionId": "cf50c461-e727-45d6-a50f-c6fe1dff3840",
    "message": "æˆ‘æƒ³å»å†°å²›ç©10å¤©ï¼Œé¢„ç®—3ä¸‡"
  }'
```

**å“åº”**:
```json
{
  "message": "I've created 3 itinerary options for å†°å²›...",
  "messageCN": "æˆ‘ä¸ºä½ çš„å†°å²›ä¹‹æ—…åˆ›å»ºäº† 3 ä¸ªæ–¹æ¡ˆï¼š\n\n1. **æ‚ é—²æ¢ç´¢è€…** - $4,500\n   10å¤© | èˆ’é€‚èŠ‚å¥...\n\nğŸ»â€â„ï¸ **Abu è¯´**: ç»è¿‡å®‰å…¨æ£€æŸ¥ï¼Œå½“å‰æ–¹æ¡ˆåœ¨ç‰©ç†ç°å®å’Œåˆè§„æ€§æ–¹é¢æ²¡æœ‰é—®é¢˜ã€‚\nğŸ• **Dr.Dre è¯´**: å½“å‰èŠ‚å¥åˆç†ï¼Œæ¯ä¸€å¤©éƒ½åˆšåˆšå¥½ã€‚\nğŸ¦¦ **Neptune è¯´**: å½“å‰æ–¹æ¡ˆåœ¨ç©ºé—´å’Œè·¯çº¿å“²å­¦æ–¹é¢æ²¡æœ‰é—®é¢˜ã€‚",
  "phase": "PLANNING",
  "planCandidates": [
    {
      "id": "plan-relaxed",
      "name": "Relaxed Explorer",
      "nameCN": "æ‚ é—²æ¢ç´¢è€…",
      "description": "Comfortable pace with time to enjoy",
      "descriptionCN": "èˆ’é€‚èŠ‚å¥ï¼Œå……åˆ†äº«å—æ¯ä¸ªç›®çš„åœ°",
      "destination": "å†°å²›",
      "duration": 10,
      "highlights": ["Scenic views", "Local cuisine", "Cultural sites"],
      "estimatedBudget": {
        "total": 4500,
        "breakdown": {
          "flight": 1200,
          "accommodation": 1800,
          "activities": 800,
          "food": 500,
          "other": 200
        }
      },
      "pace": "relaxed",
      "suitability": {
        "score": 92,
        "reasons": ["Matches pace preference", "Within budget"]
      }
    }
  ],
  "suggestedActions": [
    { "action": "view_plan-relaxed", "label": "View Relaxed Explorer", "labelCN": "æŸ¥çœ‹æ‚ é—²æ¢ç´¢è€…" }
  ]
}
```

**è¯·æ±‚ - ç¡®è®¤æ–¹æ¡ˆ**:
```bash
curl -X POST http://localhost:3000/api/agent/planning-assistant/chat \
  -H "Content-Type: application/json" \
  -d '{
    "sessionId": "cf50c461-e727-45d6-a50f-c6fe1dff3840",
    "message": "å°±é€‰ç²¾åå¹³è¡¡ç‰ˆï¼Œç¡®è®¤"
  }'
```

**å“åº”**:
```json
{
  "message": "ğŸ‰ Excellent choice! Your trip has been confirmed!...",
  "messageCN": "ğŸ‰ å¤ªæ£’äº†ï¼ä½ çš„è¡Œç¨‹å·²ç¡®è®¤ï¼\n\n**è¡Œç¨‹ç¼–å·**: trip-1768584179404\n**ç›®çš„åœ°**: å†°å²›\n**æ—¶é•¿**: 10å¤©\n**æ–¹æ¡ˆ**: ç²¾åå¹³è¡¡ç‰ˆ\n\næ¥ä¸‹æ¥å¯ä»¥ï¼š\n- æŸ¥çœ‹è¯¦ç»†è¡Œç¨‹å®‰æ’\n- å¼€å§‹å‡†å¤‡ï¼ˆæ‰“åŒ…æ¸…å•ã€ç­¾è¯ä¿¡æ¯ç­‰ï¼‰\n- åˆ†äº«ç»™åŒè¡Œä¼™ä¼´\n\nç¥ä½ æ—…é€”æ„‰å¿«ï¼ğŸŒŸ",
  "phase": "COMPLETED",
  "confirmedTripId": "trip-1768584179404",
  "suggestedActions": [
    { "action": "view_itinerary", "label": "View Itinerary", "labelCN": "æŸ¥çœ‹è¡Œç¨‹" },
    { "action": "start_preparing", "label": "Start Preparing", "labelCN": "å¼€å§‹å‡†å¤‡" }
  ]
}
```

---

### 1.3 è·å–ä¼šè¯çŠ¶æ€

è·å–æŒ‡å®šä¼šè¯çš„å½“å‰çŠ¶æ€ã€‚

```
GET /agent/planning-assistant/sessions/:sessionId
```

#### è·¯å¾„å‚æ•°

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| sessionId | string | ä¼šè¯ID |

#### å“åº”

```typescript
interface SessionStateResponse {
  sessionId: string;
  userId?: string;
  phase: string;
  preferences: UserPreferences;
  recommendations?: DestinationRecommendation[];
  selectedDestination?: string;
  planCandidates?: PlanCandidate[];
  selectedPlanId?: string;
  confirmedTripId?: string;
  messageCount: number;
  createdAt: string;
  updatedAt: string;
}

interface UserPreferences {
  travelers?: {
    adults?: number;
    children?: number;
    childrenAges?: number[];
  };
  dateRange?: {
    startDate?: string;
    endDate?: string;
    flexible?: boolean;
    preferredMonths?: number[];
  };
  budget?: {
    total?: number;
    currency?: string;
    level?: 'low' | 'medium' | 'high' | 'luxury';
  };
  destination?: {
    continents?: string[];
    countries?: string[];
    type?: ('beach' | 'city' | 'nature' | 'culture' | 'adventure')[];
  };
  activities?: {
    preferred?: string[];
    avoid?: string[];
    pacePreference?: 'relaxed' | 'moderate' | 'intensive';
  };
}
```

#### ç¤ºä¾‹

```bash
curl http://localhost:3000/api/agent/planning-assistant/sessions/cf50c461-e727-45d6-a50f-c6fe1dff3840
```

---

### 1.4 å¿«é€Ÿæ¨è

æ— éœ€åˆ›å»ºä¼šè¯ï¼Œç›´æ¥è·å–ç›®çš„åœ°æ¨èã€‚

```
GET /agent/planning-assistant/quick-recommend
```

#### æŸ¥è¯¢å‚æ•°

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| budget | string | é¢„ç®—ï¼ˆå¯é€‰ï¼‰ |
| travelersCount | string | äººæ•°ï¼ˆå¯é€‰ï¼‰ |
| preferredType | string | åå¥½ç±»å‹ï¼ˆå¯é€‰ï¼‰ |
| language | 'en' \| 'zh' | è¯­è¨€ï¼ˆå¯é€‰ï¼Œé»˜è®¤ zhï¼‰ |

#### ç¤ºä¾‹

```bash
curl "http://localhost:3000/api/agent/planning-assistant/quick-recommend?budget=30000&travelersCount=2&preferredType=nature"
```

---

### 1.5 è·å–ç”¨æˆ·åå¥½æ‘˜è¦ (P1 æ–°åŠŸèƒ½)

è·å–ç³»ç»Ÿå­¦ä¹ åˆ°çš„ç”¨æˆ·æ—…è¡Œåå¥½ï¼Œç”¨äºä¸ªæ€§åŒ–æ¨èã€‚

```
GET /agent/planning-assistant/users/:userId/preferences
```

#### è·¯å¾„å‚æ•°

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| userId | string | ç”¨æˆ·ID |

#### å“åº”

```typescript
interface UserPreferenceSummaryResponse {
  summary: string;           // è‹±æ–‡æ‘˜è¦
  summaryCN: string;         // ä¸­æ–‡æ‘˜è¦
  topPreferences: {
    label: string;           // æ ‡ç­¾ï¼ˆè‹±æ–‡ï¼‰
    labelCN: string;         // æ ‡ç­¾ï¼ˆä¸­æ–‡ï¼‰
    value: string;           // å€¼
  }[];
  learnedPreferences?: {     // å­¦ä¹ åˆ°çš„åå¥½è¯¦æƒ…
    destination?: { ... };
    budget?: { total: number };
    travelers?: { adults?: number; children?: number };
    activities?: { preferred?: string[] };
  };
}
```

#### ç¤ºä¾‹

```bash
curl http://localhost:3000/api/agent/planning-assistant/users/user-123/preferences
```

**å“åº”**:
```json
{
  "summary": "2 trips completed, avg budget $4500, prefer 10-day trips",
  "summaryCN": "å·²å®Œæˆ 2 æ¬¡æ—…è¡Œï¼Œå¹³å‡é¢„ç®— $4500ï¼Œåå¥½ 10 å¤©è¡Œç¨‹",
  "topPreferences": [
    { "label": "Budget", "labelCN": "é¢„ç®—", "value": "$4500" },
    { "label": "Duration", "labelCN": "æ—¶é•¿", "value": "10 days" },
    { "label": "Destination Type", "labelCN": "ç›®çš„åœ°ç±»å‹", "value": "nature, adventure" }
  ],
  "learnedPreferences": {
    "budget": { "total": 4500 },
    "destination": { "type": ["nature", "adventure"] }
  }
}
```

---

### 1.6 æ¸…é™¤ç”¨æˆ·åå¥½ (P1 æ–°åŠŸèƒ½)

æ¸…é™¤ç³»ç»Ÿå­¦ä¹ åˆ°çš„ç”¨æˆ·æ—…è¡Œåå¥½ã€‚

```
POST /agent/planning-assistant/users/:userId/preferences/clear
```

#### è·¯å¾„å‚æ•°

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| userId | string | ç”¨æˆ·ID |

#### å“åº”

```json
{ "success": true }
```

#### ç¤ºä¾‹

```bash
curl -X POST http://localhost:3000/api/agent/planning-assistant/users/user-123/preferences/clear
```

---

## äºŒã€è¡Œç¨‹åŠ©æ‰‹ API

### 2.1 å¯¹è¯

æ—…é€”ä¸­ä¸è¡Œç¨‹åŠ©æ‰‹å¯¹è¯ã€‚

```
POST /agent/journey-assistant/chat
```

#### è¯·æ±‚ä½“

```typescript
interface JourneyChatRequest {
  tripId: string;              // è¡Œç¨‹IDï¼ˆå¿…å¡«ï¼‰
  userId: string;              // ç”¨æˆ·IDï¼ˆå¿…å¡«ï¼‰
  message: string;             // ç”¨æˆ·æ¶ˆæ¯ï¼ˆå¿…å¡«ï¼‰
  language?: 'en' | 'zh';      // è¯­è¨€åå¥½
  context?: {
    currentLocation?: {        // å½“å‰ä½ç½®
      lat: number;
      lng: number;
    };
    timezone?: string;         // æ—¶åŒº
  };
}
```

#### å“åº”

```typescript
interface JourneyAssistantResponse {
  message?: string;            // è‹±æ–‡å›å¤
  messageCN?: string;          // ä¸­æ–‡å›å¤
  journeyState?: JourneyState; // è¡Œç¨‹çŠ¶æ€
  reminders?: Reminder[];      // æé†’åˆ—è¡¨
  event?: TripEvent;           // äº‹ä»¶ä¿¡æ¯
  options?: EmergencyOption[]; // åº”æ€¥æ–¹æ¡ˆ
  adjustmentResult?: AdjustmentResult;  // è°ƒæ•´ç»“æœ
  searchResults?: SearchResults;        // æœç´¢ç»“æœ
  suggestedActions?: SuggestedAction[]; // å»ºè®®æ“ä½œ
}

interface JourneyState {
  tripId: string;
  userId: string;
  phase: 'PRE_TRIP' | 'DEPARTURE_DAY' | 'ON_TRIP' | 'RETURN_DAY' | 'POST_TRIP';
  currentDay: number;
  totalDays: number;
  currentDate: string;
  currentLocation?: { lat: number; lng: number; name?: string; };
  todaySchedule: ScheduleItem[];
  upcomingReminders: Reminder[];
  activeEvents: TripEvent[];
  stats: {
    completedActivities: number;
    totalActivities: number;
    spentBudget: number;
    totalBudget: number;
  };
  lastUpdated: string;
}

interface ScheduleItem {
  id: string;
  type: 'flight' | 'hotel' | 'activity' | 'transport' | 'meal' | 'rest';
  title: string;
  titleCN: string;
  startTime: string;
  endTime?: string;
  location?: {
    name: string;
    nameCN: string;
    lat: number;
    lng: number;
    address?: string;
  };
  status: 'upcoming' | 'in_progress' | 'completed' | 'cancelled' | 'modified';
  notes?: string;
  notesCN?: string;
}

interface Reminder {
  id: string;
  type: 'FLIGHT' | 'HOTEL' | 'ACTIVITY' | 'TRANSPORT' | 'WEATHER' | 'SAFETY' | 'DOCUMENT' | 'PACKING' | 'BUDGET';
  title: string;
  titleCN: string;
  message: string;
  messageCN: string;
  priority: 'low' | 'medium' | 'high' | 'urgent';
  scheduledAt: string;
  relatedItemId?: string;
  actionRequired?: boolean;
  actions?: { action: string; label: string; labelCN: string; }[];
}
```

#### ç¤ºä¾‹

**è¯·æ±‚ - é™„è¿‘æœç´¢**:
```bash
curl -X POST http://localhost:3000/api/agent/journey-assistant/chat \
  -H "Content-Type: application/json" \
  -d '{
    "tripId": "trip-123",
    "userId": "user-456",
    "message": "é™„è¿‘æœ‰ä»€ä¹ˆå¥½åƒçš„"
  }'
```

**å“åº”**ï¼ˆâš ï¸ ä»¥ä¸‹ä¸ºæ ¼å¼ç¤ºä¾‹ï¼Œåç«¯å¿…é¡»è¿”å›**çœŸå® POI æ•°æ®**ï¼Œç¦æ­¢è¿”å›ã€Œé¤å…A/B/Cã€ç­‰å ä½å†…å®¹ã€‚è¯¦è§ `docs/api/journey-assistant-quick-actions.md`ï¼‰:
```json
{
  "message": "I found 3 restaurants near you:\n\n1. **Restaurant A** - 200m away â­ 4.5\n2. **Restaurant B** - 350m away â­ 4.3\n3. **Restaurant C** - 500m away â­ 4.7\n\nWould you like me to navigate you to any of these?",
  "messageCN": "æˆ‘åœ¨é™„è¿‘æ‰¾åˆ°äº† 3 å®¶é¤å…ï¼š\n\n1. **é¤å…A** - 200ç±³ â­ 4.5\n2. **é¤å…B** - 350ç±³ â­ 4.3\n3. **é¤å…C** - 500ç±³ â­ 4.7\n\néœ€è¦æˆ‘å¸®ä½ å¯¼èˆªåˆ°å“ªä¸€å®¶å—ï¼Ÿ",
  "searchResults": {
    "type": "restaurants",
    "items": [
      { "name": "Restaurant A", "nameCN": "é¤å…A", "distance": "200m", "rating": 4.5, "location": { "lat": 64.14, "lng": -21.94 } }
    ]
  },
  "suggestedActions": [
    { "action": "navigate_1", "label": "Navigate to Restaurant A", "labelCN": "å¯¼èˆªåˆ°é¤å…A" }
  ]
}
```

---

### 2.2 è·å–è¡Œç¨‹çŠ¶æ€

è·å–å½“å‰è¡Œç¨‹çš„çŠ¶æ€ã€‚

```
GET /agent/journey-assistant/trips/:tripId/status
```

#### è·¯å¾„å‚æ•°

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| tripId | string | è¡Œç¨‹ID |

#### ç¤ºä¾‹

```bash
curl http://localhost:3000/api/agent/journey-assistant/trips/trip-123/status
```

**å“åº”**:
```json
{
  "message": "ğŸ“ Day 1 of 10\n\nCurrent status: ON TRIP\nToday's activities: 2\nCompleted: 3/15\nBudget used: $1200/$5000",
  "messageCN": "ğŸ“ ç¬¬ 1 å¤© / å…± 10 å¤©\n\nå½“å‰çŠ¶æ€ï¼šæ—…é€”ä¸­\nä»Šæ—¥æ´»åŠ¨ï¼š2 é¡¹\nå·²å®Œæˆï¼š3/15\nå·²ç”¨é¢„ç®—ï¼šÂ¥8400/Â¥35000",
  "journeyState": {
    "tripId": "trip-123",
    "phase": "ON_TRIP",
    "currentDay": 1,
    "totalDays": 10,
    "todaySchedule": [
      {
        "id": "s1",
        "type": "activity",
        "title": "Golden Circle Tour",
        "titleCN": "é»„é‡‘åœˆä¸€æ—¥æ¸¸",
        "startTime": "2026-01-16T09:00:00",
        "status": "in_progress"
      }
    ],
    "stats": {
      "completedActivities": 3,
      "totalActivities": 15,
      "spentBudget": 1200,
      "totalBudget": 5000
    }
  },
  "suggestedActions": [
    { "action": "view_schedule", "label": "View today's schedule", "labelCN": "æŸ¥çœ‹ä»Šæ—¥è¡Œç¨‹" }
  ]
}
```

---

### 2.3 è·å–æé†’åˆ—è¡¨

è·å–å½“å‰è¡Œç¨‹çš„æ‰€æœ‰å¾…åŠæé†’ã€‚

```
GET /agent/journey-assistant/trips/:tripId/reminders
```

#### ç¤ºä¾‹

```bash
curl http://localhost:3000/api/agent/journey-assistant/trips/trip-123/reminders
```

---

### 2.4 å¤„ç†çªå‘äº‹ä»¶

å¤„ç†èˆªç­å»¶è¯¯ã€æ™¯ç‚¹å…³é—­ç­‰çªå‘äº‹ä»¶ã€‚

```
POST /agent/journey-assistant/events/handle
```

#### è¯·æ±‚ä½“

```typescript
interface HandleEventRequest {
  tripId: string;              // è¡Œç¨‹IDï¼ˆå¿…å¡«ï¼‰
  userId: string;              // ç”¨æˆ·IDï¼ˆå¿…å¡«ï¼‰
  eventId: string;             // äº‹ä»¶IDï¼ˆå¿…å¡«ï¼‰
  selectedOptionId?: string;   // é€‰æ‹©çš„æ–¹æ¡ˆIDï¼ˆå¯é€‰ï¼‰
  language?: 'en' | 'zh';
  context?: { ... };
}
```

#### ç¤ºä¾‹

```bash
curl -X POST http://localhost:3000/api/agent/journey-assistant/events/handle \
  -H "Content-Type: application/json" \
  -d '{
    "tripId": "trip-123",
    "userId": "user-456",
    "eventId": "event-789"
  }'
```

---

### 2.5 è°ƒæ•´è¡Œç¨‹

è°ƒæ•´è¡Œç¨‹å®‰æ’ï¼ˆæ”¹æ—¶é—´ã€å–æ¶ˆæ´»åŠ¨ç­‰ï¼‰ã€‚

```
POST /agent/journey-assistant/schedule/adjust
```

#### è¯·æ±‚ä½“

```typescript
interface AdjustScheduleRequest {
  tripId: string;
  userId: string;
  adjustmentParams: {
    itemId: string;            // è¡Œç¨‹é¡¹ID
    newTime?: string;          // æ–°æ—¶é—´
    cancel?: boolean;          // æ˜¯å¦å–æ¶ˆ
    replace?: {                // æ›¿æ¢å†…å®¹
      type: string;
      details: any;
    };
  };
  language?: 'en' | 'zh';
}
```

#### ç¤ºä¾‹

```bash
curl -X POST http://localhost:3000/api/agent/journey-assistant/schedule/adjust \
  -H "Content-Type: application/json" \
  -d '{
    "tripId": "trip-123",
    "userId": "user-456",
    "adjustmentParams": {
      "itemId": "s1",
      "newTime": "2026-01-16T14:00:00"
    }
  }'
```

---

### 2.6 ç´§æ€¥æ±‚åŠ©

ç´§æ€¥æƒ…å†µä¸‹è·å–å¸®åŠ©ã€‚

```
POST /agent/journey-assistant/emergency
```

#### è¯·æ±‚ä½“

```typescript
interface EmergencyRequest {
  tripId: string;
  userId: string;
  language?: 'en' | 'zh';
  context?: {
    currentLocation?: { lat: number; lng: number; };
  };
}
```

#### å“åº”ç¤ºä¾‹

```json
{
  "message": "ğŸš¨ I'm here to help! What's the emergency?",
  "messageCN": "ğŸš¨ æˆ‘æ¥å¸®ä½ ï¼å‘ç”Ÿäº†ä»€ä¹ˆç´§æ€¥æƒ…å†µï¼Ÿ\n\n**å¿«é€Ÿæ“ä½œï¼š**\n- ğŸ¥ æŸ¥æ‰¾æœ€è¿‘åŒ»é™¢\n- ğŸ‘® è”ç³»å½“åœ°è­¦å¯Ÿ\n- ğŸ›ï¸ è”ç³»å¤§ä½¿é¦†\n- ğŸ“ ç´§æ€¥çƒ­çº¿ï¼š112",
  "suggestedActions": [
    { "action": "find_hospital", "label": "Find hospital", "labelCN": "æ‰¾åŒ»é™¢" },
    { "action": "call_police", "label": "Call police", "labelCN": "æŠ¥è­¦" },
    { "action": "contact_embassy", "label": "Contact embassy", "labelCN": "è”ç³»å¤§ä½¿é¦†" }
  ]
}
```

---

### 2.7 é™„è¿‘æœç´¢

æœç´¢é™„è¿‘çš„é¤å…ã€æ™¯ç‚¹ç­‰ã€‚

```
POST /agent/journey-assistant/nearby
```

#### è¯·æ±‚ä½“

```typescript
interface NearbySearchRequest {
  tripId: string;
  userId: string;
  message: string;             // æœç´¢å†…å®¹ï¼Œå¦‚"é™„è¿‘æœ‰ä»€ä¹ˆå¥½åƒçš„"
  language?: 'en' | 'zh';
  context?: {
    currentLocation?: { lat: number; lng: number; };
  };
}
```

---

## ä¸‰ã€å¯¹è¯é˜¶æ®µæµç¨‹

### è§„åˆ’åŠ©æ‰‹å¯¹è¯æµç¨‹

```
INITIAL â†’ EXPLORING â†’ RECOMMENDING â†’ PLANNING â†’ COMPARING â†’ ADJUSTING â†’ CONFIRMING â†’ COMPLETED
```

| é˜¶æ®µ | è¯´æ˜ | ä¸»è¦è¾“å‡º |
|------|------|----------|
| INITIAL | åˆå§‹é˜¶æ®µ | æ¬¢è¿è¯­ |
| EXPLORING | æ¢ç´¢é˜¶æ®µ | guidingQuestions |
| RECOMMENDING | æ¨èé˜¶æ®µ | recommendations |
| PLANNING | è§„åˆ’é˜¶æ®µ | planCandidates |
| COMPARING | å¯¹æ¯”é˜¶æ®µ | comparison |
| ADJUSTING | è°ƒæ•´é˜¶æ®µ | planCandidates (æ›´æ–°) |
| CONFIRMING | ç¡®è®¤é˜¶æ®µ | confirmedTripId |
| COMPLETED | å®Œæˆé˜¶æ®µ | suggestedActions |

### è¡Œç¨‹åŠ©æ‰‹é˜¶æ®µ

| é˜¶æ®µ | è¯´æ˜ | è§¦å‘æ—¶æœº |
|------|------|----------|
| PRE_TRIP | å‡ºå‘å‰ | å‡ºå‘å‰1-7å¤© |
| DEPARTURE_DAY | å‡ºå‘å½“å¤© | å‡ºå‘å½“å¤© |
| ON_TRIP | æ—…é€”ä¸­ | æ—…è¡ŒæœŸé—´ |
| RETURN_DAY | è¿”ç¨‹å½“å¤© | è¿”ç¨‹å½“å¤© |
| POST_TRIP | æ—…è¡Œç»“æŸå | è¿”ç¨‹å |

---

## å››ã€é”™è¯¯å“åº”

æ‰€æœ‰æ¥å£åœ¨å‡ºé”™æ—¶è¿”å›ç»Ÿä¸€æ ¼å¼ï¼š

```typescript
interface ErrorResponse {
  statusCode: number;
  timestamp: string;
  path: string;
  method: string;
  message: string[];
}
```

### å¸¸è§é”™è¯¯ç 

| çŠ¶æ€ç  | è¯´æ˜ |
|--------|------|
| 400 | è¯·æ±‚å‚æ•°é”™è¯¯ |
| 401 | æœªæˆæƒï¼ˆéœ€è¦ç™»å½•ï¼‰ |
| 404 | ä¼šè¯/è¡Œç¨‹ä¸å­˜åœ¨ |
| 500 | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ |

---

## äº”ã€å‰ç«¯é›†æˆç¤ºä¾‹

### TypeScript ç±»å‹å®šä¹‰

```typescript
// types/assistant.ts

export interface PlanningSession {
  sessionId: string;
}

export interface PlanningChatRequest {
  sessionId: string;
  message: string;
  userId?: string;
  language?: 'en' | 'zh';
}

export interface PlanningChatResponse {
  message: string;
  messageCN: string;
  phase: string;
  guidingQuestions?: GuidingQuestion[];
  recommendations?: DestinationRecommendation[];
  planCandidates?: PlanCandidate[];
  confirmedTripId?: string;
  suggestedActions?: SuggestedAction[];
}
```

### React Hook ç¤ºä¾‹

```typescript
// hooks/usePlanningAssistant.ts

import { useState, useCallback } from 'react';
import axios from 'axios';

const API_BASE = '/api/agent/planning-assistant';

export function usePlanningAssistant() {
  const [sessionId, setSessionId] = useState<string | null>(null);
  const [messages, setMessages] = useState<any[]>([]);
  const [loading, setLoading] = useState(false);

  // åˆ›å»ºä¼šè¯
  const createSession = useCallback(async () => {
    const { data } = await axios.post(`${API_BASE}/sessions`);
    setSessionId(data.sessionId);
    return data.sessionId;
  }, []);

  // å‘é€æ¶ˆæ¯
  const sendMessage = useCallback(async (message: string) => {
    if (!sessionId) {
      await createSession();
    }
    
    setLoading(true);
    try {
      const { data } = await axios.post(`${API_BASE}/chat`, {
        sessionId,
        message,
        language: 'zh',
      });
      
      setMessages(prev => [...prev, 
        { role: 'user', content: message },
        { role: 'assistant', content: data.messageCN, ...data }
      ]);
      
      return data;
    } finally {
      setLoading(false);
    }
  }, [sessionId, createSession]);

  return { sessionId, messages, loading, sendMessage, createSession };
}
```

### ä½¿ç”¨ç¤ºä¾‹

```tsx
function PlanningChat() {
  const { messages, loading, sendMessage } = usePlanningAssistant();
  const [input, setInput] = useState('');

  const handleSend = async () => {
    if (!input.trim()) return;
    await sendMessage(input);
    setInput('');
  };

  return (
    <div>
      <div className="messages">
        {messages.map((msg, i) => (
          <div key={i} className={`message ${msg.role}`}>
            {msg.content}
            {msg.planCandidates && (
              <PlanCandidateList candidates={msg.planCandidates} />
            )}
          </div>
        ))}
      </div>
      <input 
        value={input} 
        onChange={e => setInput(e.target.value)}
        onKeyPress={e => e.key === 'Enter' && handleSend()}
        disabled={loading}
      />
      <button onClick={handleSend} disabled={loading}>
        {loading ? 'æ€è€ƒä¸­...' : 'å‘é€'}
      </button>
    </div>
  );
}
```

---

## å…­ã€P1 åŠŸèƒ½å¢å¼º

### 6.1 äººæ ¼è¯­è¨€é£æ ¼ä¼˜åŒ–

ä¸‰äººæ ¼ï¼ˆAbuã€Dr.Dreã€Neptuneï¼‰ç°åœ¨ä¼šç”Ÿæˆæ›´æœ‰ä¸ªæ€§ã€æ›´æœ‰æ¸©åº¦çš„å‘è¨€ã€‚

#### äººæ ¼ç‰¹ç‚¹

| äººæ ¼ | è§’è‰² | é£æ ¼ | å£å¤´ç¦…ç¤ºä¾‹ |
|------|------|------|-----------|
| ğŸ»â€â„ï¸ Abu | å®‰å…¨å®ˆæŠ¤è€… | ç¨³é‡ã€å¯é ã€ç›´æ¥ | "è¿™æ¡è·¯ï¼Œæˆ‘ç¡®è®¤è¿‡äº†" |
| ğŸ• Dr.Dre | èŠ‚å¥ç®¡å®¶ | æ¸©æš–ã€å…³å¿ƒã€è´´å¿ƒ | "åˆ«å¤ªç´¯ï¼Œæ…¢æ…¢æ¥" |
| ğŸ¦¦ Neptune | æ–¹æ¡ˆå¤§å¸ˆ | çµæ´»ã€åˆ›æ„ã€ä¹è§‚ | "æˆ‘æœ‰æ›´æ£’çš„æ›¿ä»£æ–¹æ¡ˆï¼" |

#### åœ¨å“åº”ä¸­çš„ä½“ç°

```json
{
  "messageCN": "...\n\nğŸ»â€â„ï¸ **Abu è¯´**: æˆ‘ä»”ç»†æ£€æŸ¥è¿‡å†°å²›çš„è·¯çº¿äº†â€”â€”å®‰å…¨å¯è¡Œã€‚æ”¾å¿ƒå‡ºå‘å§ï¼\nğŸ• **Dr.Dre è¯´**: è¿™ä¸ªèŠ‚å¥åˆšåˆšå¥½â€”â€”ä¸æ€¥ä¸æ…¢ã€‚ä½ ä¼šäº«å—æ¯ä¸€åˆ»çš„ï¼\nğŸ¦¦ **Neptune è¯´**: å†°å²›ä¼šå¾ˆæ£’ï¼åˆ«æ‹…å¿ƒï¼Œæˆ‘éšæ—¶å‡†å¤‡ç€ Plan Bã€‚"
}
```

### 6.2 æ¨èç®—æ³•ä¼˜åŒ–

ç›®çš„åœ°æ¨èç°åœ¨é‡‡ç”¨å¤šå› ç´ è¯„åˆ†ç®—æ³•ï¼š

| è¯„åˆ†ç»´åº¦ | åˆ†å€¼ | è¯´æ˜ |
|----------|------|------|
| é¢„ç®—åŒ¹é…åº¦ | 0-25 | ç”¨æˆ·é¢„ç®—ä¸ç›®çš„åœ°æ¶ˆè´¹æ°´å¹³åŒ¹é… |
| å­£èŠ‚é€‚åˆåº¦ | 0-20 | å‡ºè¡Œæ—¶é—´ä¸ç›®çš„åœ°æœ€ä½³å­£èŠ‚åŒ¹é… |
| åå¥½åŒ¹é…åº¦ | 0-25 | ç”¨æˆ·åå¥½æ ‡ç­¾ä¸ç›®çš„åœ°ç‰¹ç‚¹åŒ¹é… |
| äººæ•°é€‚åˆåº¦ | 0-15 | å‡ºè¡Œäººæ•°ä¸ç›®çš„åœ°é€‚åˆäººç¾¤åŒ¹é… |
| çƒ­é—¨ç¨‹åº¦ | 0-15 | ç›®çš„åœ°ç»¼åˆçƒ­é—¨åº¦ |

#### å“åº”ç¤ºä¾‹

```json
{
  "recommendations": [
    {
      "id": "iceland",
      "name": "Iceland",
      "nameCN": "å†°å²›",
      "matchScore": 87,
      "matchReasons": ["Within your budget", "Perfect season to visit", "Matches your interests"],
      "matchReasonsCN": ["é¢„ç®—å‹å¥½", "æœ€ä½³æ—…è¡Œå­£èŠ‚", "ç¬¦åˆä½ çš„å…´è¶£"]
    }
  ]
}
```

### 6.3 ç”¨æˆ·åå¥½å­¦ä¹ 

ç³»ç»Ÿä¼šè¢«åŠ¨å­¦ä¹ ç”¨æˆ·çš„æ—…è¡Œåå¥½ï¼Œç”¨äºä¼˜åŒ–åç»­æ¨èã€‚

#### å­¦ä¹ è§¦å‘æ—¶æœº

| è¡Œä¸º | å­¦ä¹ æƒé‡ | è¯´æ˜ |
|------|----------|------|
| destination_selected | 0.3 | ç”¨æˆ·é€‰æ‹©ç›®çš„åœ° |
| plan_generated | 0.2 | ç”¨æˆ·è¯·æ±‚ç”Ÿæˆæ–¹æ¡ˆ |
| plan_confirmed | 0.6 | ç”¨æˆ·ç¡®è®¤æ–¹æ¡ˆ |
| trip_completed | 1.0 | ç”¨æˆ·å®Œæˆæ—…è¡Œ |
| preference_stated | 0.8 | ç”¨æˆ·æ˜ç¡®è¡¨è¿°åå¥½ |

#### å­¦ä¹ ç»´åº¦

- **ç›®çš„åœ°ç±»å‹åå¥½**: è‡ªç„¶/åŸå¸‚/æµ·æ»©/æ–‡åŒ–/å†’é™©
- **é¢„ç®—èŒƒå›´**: å¹³å‡é¢„ç®—æ°´å¹³
- **æ—…è¡ŒèŠ‚å¥åå¥½**: æ‚ é—²/é€‚ä¸­/ç´§å‡‘
- **å‡ºè¡Œäººæ•°ä¹ æƒ¯**: ç‹¬è‡ª/æƒ…ä¾£/å®¶åº­/æœ‹å‹
- **å­£èŠ‚åå¥½**: åå¥½çš„å‡ºè¡Œæœˆä»½
- **æ´»åŠ¨åå¥½**: å–œæ¬¢çš„æ´»åŠ¨ç±»å‹

#### API æ¥å£

- `GET /agent/planning-assistant/users/:userId/preferences` - è·å–å­¦ä¹ åˆ°çš„åå¥½
- `POST /agent/planning-assistant/users/:userId/preferences/clear` - æ¸…é™¤åå¥½

---

## ä¸ƒã€Swagger æ–‡æ¡£

å¯åŠ¨æœåŠ¡åè®¿é—®ï¼š

```
http://localhost:3000/api/docs
```

å¯æŸ¥çœ‹å®Œæ•´çš„ Swagger API æ–‡æ¡£ï¼ŒåŒ…æ‹¬ï¼š
- æ‰€æœ‰æ¥å£çš„è¯¦ç»†å‚æ•°è¯´æ˜
- åœ¨çº¿æµ‹è¯•åŠŸèƒ½
- å“åº”ç¤ºä¾‹
