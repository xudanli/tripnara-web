# è¡Œç¨‹è¯¦æƒ…é¡µ - æœªå¯¹æ¥æ¥å£åˆ†ææŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: 2025-01-XX  
**æ–‡ä»¶**: `src/pages/trips/[id].tsx`  
**è§†å›¾ç»„ä»¶**: `src/components/trips/views/`

---

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [æœªå¯¹æ¥æ¥å£æ¸…å•](#æœªå¯¹æ¥æ¥å£æ¸…å•)
3. [è¯¦ç»†åˆ†æ](#è¯¦ç»†åˆ†æ)
4. [ç›¸å…³é€»è¾‘è¯´æ˜](#ç›¸å…³é€»è¾‘è¯´æ˜)
5. [å®ç°å»ºè®®](#å®ç°å»ºè®®)

---

## ğŸ“Š æ¦‚è¿°

è¡Œç¨‹è¯¦æƒ…é¡µä½¿ç”¨äº†4ä¸ªè§†å›¾ç»„ä»¶æ¥å±•ç¤ºä¸åŒçš„äººæ ¼è§†è§’ï¼š
- **AbuView** - å®‰å…¨è§†å›¾ï¼ˆAbuäººæ ¼ï¼‰
- **DrDreView** - èŠ‚å¥è§†å›¾ï¼ˆDr.Dreäººæ ¼ï¼‰
- **NeptuneView** - ä¿®å¤è§†å›¾ï¼ˆNeptuneäººæ ¼ï¼‰
- **AutoView** - ç»¼åˆè§†å›¾ï¼ˆæ•´åˆè§†å›¾ï¼‰

è¿™äº›è§†å›¾ç»„ä»¶ä¸­å¤§é‡ä½¿ç”¨äº†ç¡¬ç¼–ç æ•°æ®ï¼Œç¼ºå°‘å¯¹åº”çš„APIæ¥å£å¯¹æ¥ã€‚

---

## âŒ æœªå¯¹æ¥æ¥å£æ¸…å•

### 1. é£é™©è¯„ä¼°æ¥å£ï¼ˆAbuViewï¼‰

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | ç”¨é€” | ä¼˜å…ˆçº§ |
|------|------|------|------|--------|
| è·å–é£é™©è¯„ä¼° | GET | `/trips/:id/risk-assessment` | è·å–æ•´ä½“å®‰å…¨çŠ¶æ€ï¼ˆgatingStatusï¼‰ | ğŸ”´ é«˜ |
| è·å–è¿è§„åˆ—è¡¨ | GET | `/trips/:id/violations` | è·å–æ‰€æœ‰è¿è§„é¡¹ï¼ˆviolationsï¼‰ | ğŸ”´ é«˜ |
| è·å–å•é¡¹é£é™© | GET | `/trips/:id/items/:itemId/risk` | è·å–å•ä¸ªè¡Œç¨‹é¡¹çš„é£é™©ï¼ˆriskMapï¼‰ | ğŸŸ¡ ä¸­ |

### 2. æŒ‡æ ‡æ¥å£ï¼ˆDrDreViewï¼‰

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | ç”¨é€” | ä¼˜å…ˆçº§ |
|------|------|------|------|--------|
| è·å–å•é¡¹æŒ‡æ ‡ | GET | `/trips/:id/items/:itemId/metrics` | è·å–å•ä¸ªè¡Œç¨‹é¡¹çš„æŒ‡æ ‡ï¼ˆmetricsByItemï¼‰ | ğŸŸ¡ ä¸­ |
| ä¼˜åŒ–è¡Œç¨‹ | POST | `/trips/:id/optimize` | ç”Ÿæˆä¼˜åŒ–å€™é€‰æ–¹æ¡ˆï¼ˆhandleRegenerateï¼‰ | ğŸ”´ é«˜ |

**æ³¨æ„**: `GET /trips/:id/metrics` å·²å¯¹æ¥ï¼Œä½†è§†å›¾ç»„ä»¶æœªä½¿ç”¨ã€‚

### 3. ä¿®å¤å»ºè®®æ¥å£ï¼ˆNeptuneViewï¼‰

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | ç”¨é€” | ä¼˜å…ˆçº§ |
|------|------|------|------|--------|
| è·å–ä¿®å¤å»ºè®® | GET | `/trips/:id/repairs` | è·å–æ‰€æœ‰ä¿®å¤å»ºè®®ï¼ˆrepairsï¼‰ | ğŸ”´ é«˜ |
| è·å–æ›¿ä»£æ–¹æ¡ˆ | GET | `/trips/:id/items/:itemId/alternatives` | è·å–æ›¿ä»£åœ°ç‚¹åˆ—è¡¨ï¼ˆalternativesï¼‰ | ğŸŸ¡ ä¸­ |
| åº”ç”¨ä¿®å¤ | POST | `/trips/:id/repairs/:repairId/apply` | åº”ç”¨ä¿®å¤å»ºè®® | ğŸ”´ é«˜ |

### 4. ç»¼åˆè§†å›¾æ¥å£ï¼ˆAutoViewï¼‰

| æ¥å£ | æ–¹æ³• | è·¯å¾„ | ç”¨é€” | ä¼˜å…ˆçº§ |
|------|------|------|------|--------|
| è·å–ç»¼åˆæŒ‡æ ‡ | GET | `/trips/:id/overall-metrics` | è·å–ä¸‰äººæ ¼ç»¼åˆè¯„åˆ†ï¼ˆoverallMetricsï¼‰ | ğŸŸ¡ ä¸­ |
| è·å–å…³é”®é—®é¢˜ | GET | `/trips/:id/critical-issues` | è·å–å…³é”®é—®é¢˜æ‘˜è¦ | ğŸŸ¡ ä¸­ |

---

## ğŸ” è¯¦ç»†åˆ†æ

### 1. AbuViewï¼ˆå®‰å…¨è§†å›¾ï¼‰

#### ç¡¬ç¼–ç æ•°æ®ä½ç½®
- **æ–‡ä»¶**: `src/components/trips/views/AbuView.tsx`
- **è¡Œå·**: 45-77

#### ç¡¬ç¼–ç å†…å®¹

**1.1 gatingStatusï¼ˆå®‰å…¨çŠ¶æ€ï¼‰**
```typescript
// è¡Œ 46
const gatingStatus: 'ALLOW' | 'WARN' | 'BLOCK' = 'WARN';
```

**é€»è¾‘è¯´æ˜**:
- `gatingStatus` ç”¨äºæ˜¾ç¤ºè¡Œç¨‹çš„æ•´ä½“å®‰å…¨çŠ¶æ€
- ä¸‰ç§çŠ¶æ€ï¼š
  - `ALLOW` - å…è®¸æ‰§è¡Œï¼ˆç»¿è‰²ï¼‰
  - `WARN` - éœ€è¦ç¡®è®¤ï¼ˆé»„è‰²ï¼‰
  - `BLOCK` - è¢«é˜»æ­¢ï¼ˆçº¢è‰²ï¼‰
- åœ¨ UI ä¸­æ˜¾ç¤ºä¸ºé¡¶éƒ¨å®‰å…¨çŠ¶æ€æ¡ï¼ˆè¡Œ 140-159ï¼‰

**åº”è¯¥å¯¹æ¥çš„æ¥å£**:
- `GET /trips/:id/risk-assessment`
- è¿”å›æ ¼å¼ï¼š
  ```typescript
  {
    gatingStatus: 'ALLOW' | 'WARN' | 'BLOCK';
    summary?: string;
    confidence?: number;
  }
  ```

**1.2 violationsï¼ˆè¿è§„åˆ—è¡¨ï¼‰**
```typescript
// è¡Œ 47-71
const violations: RiskViolation[] = [
  {
    level: 'HARD',
    code: 'NIGHT_HIKE',
    title: t('tripViews.abu.violations.nightHikeRisk'),
    reason: t('tripViews.abu.violations.reason.nightHike'),
    evidence: [
      { field: t('tripViews.abu.violations.evidence.sunsetTime'), value: '18:30', timestamp: '2024-01-15' },
      { field: t('tripViews.abu.violations.evidence.estimatedEndTime'), value: '19:45' },
      { field: t('tripViews.abu.violations.evidence.routeDifficulty'), value: 'CHALLENGE' },
    ],
    affectedItemIds: ['item-2'],
  },
  // ...
];
```

**é€»è¾‘è¯´æ˜**:
- `violations` æ•°ç»„åŒ…å«æ‰€æœ‰æ£€æµ‹åˆ°çš„å®‰å…¨è¿è§„é¡¹
- æ¯ä¸ªè¿è§„é¡¹åŒ…å«ï¼š
  - `level`: 'HARD' | 'SOFT' - ç¡¬æ€§è¿è§„æˆ–è½¯æ€§è¿è§„
  - `code`: è¿è§„ä»£ç ï¼ˆå¦‚ 'NIGHT_HIKE', 'BUFFER_INSUFFICIENT'ï¼‰
  - `title`: è¿è§„æ ‡é¢˜
  - `reason`: è¿è§„åŸå› 
  - `evidence`: è¯æ®åˆ—è¡¨ï¼ˆå­—æ®µã€å€¼ã€æ—¶é—´æˆ³ï¼‰
  - `affectedItemIds`: å—å½±å“çš„è¡Œç¨‹é¡¹IDåˆ—è¡¨
- åœ¨ UI ä¸­æ˜¾ç¤ºä¸ºè¿è§„åˆ—è¡¨å¡ç‰‡ï¼ˆè¡Œ 161-220ï¼‰

**åº”è¯¥å¯¹æ¥çš„æ¥å£**:
- `GET /trips/:id/violations`
- è¿”å›æ ¼å¼ï¼š
  ```typescript
  {
    violations: RiskViolation[];
    total: number;
  }
  ```

**1.3 riskMapï¼ˆé£é™©æ˜ å°„ï¼‰**
```typescript
// è¡Œ 73-77
const riskMap: RiskMap = {
  'item-1': { level: 'LOW', tags: [...], confidence: 0.8 },
  'item-2': { level: 'HIGH', tags: [...], confidence: 0.95 },
  'item-3': { level: 'MEDIUM', tags: [...], confidence: 0.7 },
};
```

**é€»è¾‘è¯´æ˜**:
- `riskMap` æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé”®ä¸ºè¡Œç¨‹é¡¹IDï¼Œå€¼ä¸ºé£é™©ä¿¡æ¯
- æ¯ä¸ªé£é™©ä¿¡æ¯åŒ…å«ï¼š
  - `level`: 'HIGH' | 'MEDIUM' | 'LOW' | 'NONE' - é£é™©çº§åˆ«
  - `tags`: string[] - é£é™©æ ‡ç­¾
  - `confidence`: number - ç½®ä¿¡åº¦ï¼ˆ0-1ï¼‰
- åœ¨ UI ä¸­ç”¨äºæ˜¾ç¤ºæ¯ä¸ªè¡Œç¨‹é¡¹çš„é£é™©å¾½ç« ï¼ˆè¡Œ 221-440ï¼‰
- é€šè¿‡ `getItemRisk` å‡½æ•°è·å–ï¼ˆè¡Œ 133-135ï¼‰

**åº”è¯¥å¯¹æ¥çš„æ¥å£**:
- `GET /trips/:id/items/:itemId/risk`
- æˆ–è€…æ‰¹é‡è·å–ï¼š
  - `GET /trips/:id/items/risks` (è¿”å›æ‰€æœ‰é¡¹çš„é£é™©æ˜ å°„)
- è¿”å›æ ¼å¼ï¼š
  ```typescript
  {
    itemId: string;
    level: 'HIGH' | 'MEDIUM' | 'LOW' | 'NONE';
    tags: string[];
    confidence: number;
  }
  ```

---

### 2. DrDreViewï¼ˆèŠ‚å¥è§†å›¾ï¼‰

#### ç¡¬ç¼–ç æ•°æ®ä½ç½®
- **æ–‡ä»¶**: `src/components/trips/views/DrDreView.tsx`
- **è¡Œå·**: 65-96, 108-130

#### ç¡¬ç¼–ç å†…å®¹

**2.1 metricsï¼ˆè¡Œç¨‹æŒ‡æ ‡ï¼‰**
```typescript
// è¡Œ 66-73
const metrics: Metrics = {
  timeTotal: 1440, // 24å°æ—¶
  bufferTotal: 180, // 3å°æ—¶
  fatigueScore: 65,
  ascent: 1200,
  costEstimate: 5000,
  reliability: 85,
};
```

**é€»è¾‘è¯´æ˜**:
- `metrics` åŒ…å«æ•´ä¸ªè¡Œç¨‹çš„èŠ‚å¥æŒ‡æ ‡
- å­—æ®µè¯´æ˜ï¼š
  - `timeTotal`: æ€»è€—æ—¶ï¼ˆåˆ†é’Ÿï¼‰
  - `bufferTotal`: æ€»ç¼“å†²æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
  - `fatigueScore`: ç–²åŠ³æŒ‡æ•°ï¼ˆ0-100ï¼‰
  - `ascent`: ç´¯ç§¯çˆ¬å‡ï¼ˆç±³ï¼‰
  - `costEstimate`: é¢„ä¼°æˆæœ¬
  - `reliability`: å¯é æ€§ï¼ˆ0-100ï¼‰
- åœ¨ UI ä¸­æ˜¾ç¤ºä¸ºæŒ‡æ ‡å¡ç‰‡ï¼ˆè¡Œ 150-200ï¼‰

**å·²å¯¹æ¥ä½†æœªä½¿ç”¨**:
- `GET /trips/:id/metrics` å·²å¯¹æ¥ï¼ˆ`src/api/trips.ts` è¡Œ 775ï¼‰
- ä½†è§†å›¾ç»„ä»¶æœªä½¿ç”¨è¯¥æ¥å£

**åº”è¯¥ä½¿ç”¨**:
- åœ¨ç»„ä»¶ä¸­è°ƒç”¨ `tripsApi.getMetrics(tripId)`
- å°†è¿”å›çš„ `TripMetricsResponse` è½¬æ¢ä¸º `Metrics` æ ¼å¼

**2.2 metricsByItemï¼ˆå•é¡¹æŒ‡æ ‡ï¼‰**
```typescript
// è¡Œ 75-96
const metricsByItem: MetricsByItem = {
  'item-1': {
    duration: 120,
    buffer: 15,
    effort: 40,
    cost: 200,
    distance: 5,
  },
  // ...
};
```

**é€»è¾‘è¯´æ˜**:
- `metricsByItem` æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé”®ä¸ºè¡Œç¨‹é¡¹IDï¼Œå€¼ä¸ºè¯¥è¡Œç¨‹é¡¹çš„æŒ‡æ ‡
- æ¯ä¸ªæŒ‡æ ‡åŒ…å«ï¼š
  - `duration`: æŒç»­æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
  - `buffer`: ç¼“å†²æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰
  - `effort`: åŠªåŠ›ç¨‹åº¦ï¼ˆ0-100ï¼‰
  - `cost`: æˆæœ¬
  - `distance`: è·ç¦»ï¼ˆå…¬é‡Œï¼‰
  - `ascent?`: çˆ¬å‡ï¼ˆç±³ï¼Œå¯é€‰ï¼‰
- åœ¨ UI ä¸­ç”¨äºæ˜¾ç¤ºæ¯ä¸ªè¡Œç¨‹é¡¹çš„è¯¦ç»†æŒ‡æ ‡ï¼ˆè¡Œ 250-350ï¼‰

**åº”è¯¥å¯¹æ¥çš„æ¥å£**:
- `GET /trips/:id/items/:itemId/metrics`
- æˆ–è€…æ‰¹é‡è·å–ï¼š
  - `GET /trips/:id/items/metrics` (è¿”å›æ‰€æœ‰é¡¹çš„æŒ‡æ ‡æ˜ å°„)

**2.3 handleRegenerateï¼ˆç”Ÿæˆå€™é€‰æ–¹æ¡ˆï¼‰**
```typescript
// è¡Œ 108-130
const handleRegenerate = async () => {
  // æ¨¡æ‹Ÿç”Ÿæˆå€™é€‰æ–¹æ¡ˆ
  setShowCandidates(true);
  setCandidates([
    {
      id: 'candidate-1',
      deltaSummary: t('tripViews.dre.candidates.deltaSummary.timeOptimization'),
      metrics: { ...metrics, timeTotal: 1320, bufferTotal: 150 },
      patchPreview: {},
    },
    // ...
  ]);
};
```

**é€»è¾‘è¯´æ˜**:
- `handleRegenerate` å‡½æ•°ç”¨äºç”Ÿæˆä¼˜åŒ–å€™é€‰æ–¹æ¡ˆ
- å€™é€‰æ–¹æ¡ˆåŒ…å«ï¼š
  - `id`: å€™é€‰æ–¹æ¡ˆID
  - `deltaSummary`: å˜æ›´æ‘˜è¦
  - `metrics`: ä¼˜åŒ–åçš„æŒ‡æ ‡
  - `patchPreview`: è¡¥ä¸é¢„è§ˆï¼ˆJSON Patchæ ¼å¼ï¼‰
- åœ¨ UI ä¸­æ˜¾ç¤ºä¸ºå€™é€‰æ–¹æ¡ˆåˆ—è¡¨ï¼ˆè¡Œ 400-480ï¼‰

**åº”è¯¥å¯¹æ¥çš„æ¥å£**:
- `POST /trips/:id/optimize`
- è¯·æ±‚æ ¼å¼ï¼š
  ```typescript
  {
    priorities?: {
      time?: number;
      comfort?: number;
      cost?: number;
      experience?: number;
    };
    constraints?: {
      latestEndTime?: boolean;
      fixedLunch?: boolean;
      maxDailySteps?: boolean;
      avoidNightRoute?: boolean;
    };
    lockedItemIds?: string[];
  }
  ```
- è¿”å›æ ¼å¼ï¼š
  ```typescript
  {
    candidates: Candidate[];
  }
  ```

**æ³¨æ„**: å¯èƒ½éœ€è¦ä½¿ç”¨ `planningPolicyApi.generateCandidates` æˆ– `planningPolicyApi.whatIfEvaluate`

---

### 3. NeptuneViewï¼ˆä¿®å¤è§†å›¾ï¼‰

#### ç¡¬ç¼–ç æ•°æ®ä½ç½®
- **æ–‡ä»¶**: `src/components/trips/views/NeptuneView.tsx`
- **è¡Œå·**: 67-136

#### ç¡¬ç¼–ç å†…å®¹

**3.1 repairsï¼ˆä¿®å¤å»ºè®®ï¼‰**
```typescript
// è¡Œ 67-117
const repairs: Repair[] = [
  {
    id: 'repair-1',
    type: 'REPLACE',
    severity: 'CRITICAL',
    targetItemId: 'item-2',
    patchOps: [
      { op: 'replace', path: '/items/1/placeId', value: 123 },
      { op: 'replace', path: '/items/1/startTime', value: '2024-01-16T10:00:00Z' },
    ],
    beforeMetrics: { time: 180, distance: 8, effort: 70, cost: 150, risk: 'é«˜' },
    afterMetrics: { time: 150, distance: 6, effort: 50, cost: 120, risk: 'ä¸­' },
    confidence: 0.9,
    description: t('tripViews.neptune.descriptions.replaceRoute'),
  },
  // ...
];
```

**é€»è¾‘è¯´æ˜**:
- `repairs` æ•°ç»„åŒ…å«æ‰€æœ‰æ£€æµ‹åˆ°çš„ä¿®å¤å»ºè®®
- æ¯ä¸ªä¿®å¤å»ºè®®åŒ…å«ï¼š
  - `id`: ä¿®å¤å»ºè®®ID
  - `type`: 'REPLACE' | 'SKIP' | 'RESCHEDULE' | 'ADD_BUFFER' - ä¿®å¤ç±»å‹
  - `severity`: 'CRITICAL' | 'WARNING' - ä¸¥é‡ç¨‹åº¦
  - `targetItemId`: ç›®æ ‡è¡Œç¨‹é¡¹ID
  - `patchOps`: JSON Patch æ“ä½œæ•°ç»„
  - `beforeMetrics`: ä¿®å¤å‰çš„æŒ‡æ ‡
  - `afterMetrics`: ä¿®å¤åçš„æŒ‡æ ‡
  - `confidence`: ç½®ä¿¡åº¦ï¼ˆ0-1ï¼‰
  - `description`: ä¿®å¤æè¿°
- åœ¨ UI ä¸­æ˜¾ç¤ºä¸ºä¿®å¤å»ºè®®åˆ—è¡¨ï¼ˆè¡Œ 200-350ï¼‰

**åº”è¯¥å¯¹æ¥çš„æ¥å£**:
- `GET /trips/:id/repairs`
- è¿”å›æ ¼å¼ï¼š
  ```typescript
  {
    repairs: Repair[];
    total: number;
  }
  ```

**æ³¨æ„**: å¯èƒ½éœ€è¦ä½¿ç”¨ `readinessApi.getRepairOptions` æˆ–ç±»ä¼¼çš„æ¥å£

**3.2 alternativesï¼ˆæ›¿ä»£æ–¹æ¡ˆï¼‰**
```typescript
// è¡Œ 119-136
const alternatives: { [itemId: string]: Alternative[] } = {
  'item-2': [
    {
      placeId: 123,
      placeName: t('tripViews.neptune.alternatives.alternativeRouteA'),
      reasonFit: t('tripViews.neptune.alternatives.reasonFit1'),
      delta: { time: -30, distance: -2, cost: -30 },
      bookingInfo: t('tripViews.neptune.alternatives.noBooking'),
    },
    // ...
  ],
};
```

**é€»è¾‘è¯´æ˜**:
- `alternatives` æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œé”®ä¸ºè¡Œç¨‹é¡¹IDï¼Œå€¼ä¸ºè¯¥è¡Œç¨‹é¡¹çš„æ›¿ä»£åœ°ç‚¹åˆ—è¡¨
- æ¯ä¸ªæ›¿ä»£æ–¹æ¡ˆåŒ…å«ï¼š
  - `placeId`: åœ°ç‚¹ID
  - `placeName`: åœ°ç‚¹åç§°
  - `reasonFit`: é€‚åˆåŸå› 
  - `delta`: å˜æ›´é‡ï¼ˆæ—¶é—´ã€è·ç¦»ã€æˆæœ¬ï¼‰
  - `bookingInfo`: é¢„è®¢ä¿¡æ¯
- åœ¨ UI ä¸­ç”¨äºæ˜¾ç¤ºæ›¿ä»£åœ°ç‚¹é€‰æ‹©ï¼ˆè¡Œ 400-500ï¼‰

**åº”è¯¥å¯¹æ¥çš„æ¥å£**:
- `GET /trips/:id/items/:itemId/alternatives`
- è¿”å›æ ¼å¼ï¼š
  ```typescript
  {
    alternatives: Alternative[];
  }
  ```

**3.3 åº”ç”¨ä¿®å¤**
- å½“å‰ä»£ç ä¸­æ²¡æœ‰æ˜ç¡®çš„"åº”ç”¨ä¿®å¤"é€»è¾‘
- åº”è¯¥å¯¹æ¥çš„æ¥å£ï¼š
  - `POST /trips/:id/repairs/:repairId/apply`
  - æˆ–è€…ä½¿ç”¨ `readinessApi.applyRepair`

---

### 4. AutoViewï¼ˆç»¼åˆè§†å›¾ï¼‰

#### ç¡¬ç¼–ç æ•°æ®ä½ç½®
- **æ–‡ä»¶**: `src/components/trips/views/AutoView.tsx`
- **è¡Œå·**: 41-48

#### ç¡¬ç¼–ç å†…å®¹

**4.1 overallMetricsï¼ˆç»¼åˆæŒ‡æ ‡ï¼‰**
```typescript
// è¡Œ 41-48
const overallMetrics = {
  safetyScore: 75, // å®‰å…¨è¯„åˆ† 0-100
  rhythmScore: 80, // èŠ‚å¥è¯„åˆ† 0-100
  readinessScore: 85, // å‡†å¤‡åº¦è¯„åˆ† 0-100
  criticalIssues: 2, // å…³é”®é—®é¢˜æ•°
  warnings: 3, // è­¦å‘Šæ•°
  suggestions: 5, // å»ºè®®æ•°
};
```

**é€»è¾‘è¯´æ˜**:
- `overallMetrics` åŒ…å«ä¸‰äººæ ¼ç³»ç»Ÿçš„ç»¼åˆè¯„ä¼°
- å­—æ®µè¯´æ˜ï¼š
  - `safetyScore`: å®‰å…¨è¯„åˆ†ï¼ˆ0-100ï¼Œæ¥è‡ªAbuï¼‰
  - `rhythmScore`: èŠ‚å¥è¯„åˆ†ï¼ˆ0-100ï¼Œæ¥è‡ªDr.Dreï¼‰
  - `readinessScore`: å‡†å¤‡åº¦è¯„åˆ†ï¼ˆ0-100ï¼Œæ¥è‡ªNeptuneï¼‰
  - `criticalIssues`: å…³é”®é—®é¢˜æ•°
  - `warnings`: è­¦å‘Šæ•°
  - `suggestions`: å»ºè®®æ•°
- åœ¨ UI ä¸­æ˜¾ç¤ºä¸ºç»¼åˆæ¦‚è§ˆå¡ç‰‡ï¼ˆè¡Œ 67-120ï¼‰

**åº”è¯¥å¯¹æ¥çš„æ¥å£**:
- `GET /trips/:id/overall-metrics`
- è¿”å›æ ¼å¼ï¼š
  ```typescript
  {
    safetyScore: number;
    rhythmScore: number;
    readinessScore: number;
    criticalIssues: number;
    warnings: number;
    suggestions: number;
  }
  ```

**æ³¨æ„**: éƒ¨åˆ†æ•°æ®å¯ä»¥ä»å·²æœ‰çš„æ¥å£è·å–ï¼š
- `suggestions` å¯ä»¥ä» `getSuggestionStats` è·å–
- å…¶ä»–æ•°æ®éœ€è¦æ–°æ¥å£

**4.2 å…³é”®é—®é¢˜æ‘˜è¦**
- å½“å‰ä»£ç ä¸­æœ‰ç¡¬ç¼–ç çš„å…³é”®é—®é¢˜åˆ—è¡¨ï¼ˆè¡Œ 127-145ï¼‰
- åº”è¯¥å¯¹æ¥çš„æ¥å£ï¼š
  - `GET /trips/:id/critical-issues`
  - è¿”å›æ ¼å¼ï¼š
    ```typescript
    {
      issues: Array<{
        id: string;
        persona: 'abu' | 'drdre' | 'neptune';
        severity: 'critical' | 'warning' | 'info';
        title: string;
        description: string;
        affectedItemIds?: string[];
      }>;
    }
    ```

---

## ğŸ”— ç›¸å…³é€»è¾‘è¯´æ˜

### æ•°æ®æµ

```
è¡Œç¨‹è¯¦æƒ…é¡µ (src/pages/trips/[id].tsx)
  â”œâ”€ æ ¹æ® viewMode é€‰æ‹©è§†å›¾
  â”‚   â”œâ”€ 'abu' â†’ AbuView
  â”‚   â”œâ”€ 'drdre' â†’ DrDreView
  â”‚   â”œâ”€ 'neptune' â†’ NeptuneView
  â”‚   â””â”€ 'auto' â†’ AutoView
  â”‚
  â””â”€ è§†å›¾ç»„ä»¶
      â”œâ”€ ä½¿ç”¨ç¡¬ç¼–ç æ•°æ®ï¼ˆå½“å‰ï¼‰
      â””â”€ åº”è¯¥ä» API è·å–æ•°æ®ï¼ˆæœªæ¥ï¼‰
```

### è§†å›¾åˆ‡æ¢é€»è¾‘

- `viewMode` çŠ¶æ€ç®¡ç†åœ¨ `src/pages/trips/[id].tsx` ä¸­ï¼ˆè¡Œ 256ï¼‰
- é€šè¿‡ `PersonaModeToggle` ç»„ä»¶åˆ‡æ¢ï¼ˆè¡Œ 1450-1455ï¼‰
- åˆ‡æ¢æ—¶ï¼Œè§†å›¾ç»„ä»¶ä¼šé‡æ–°æ¸²æŸ“

### æ•°æ®ä¾èµ–å…³ç³»

**AbuView**:
- éœ€è¦ï¼š`gatingStatus`, `violations`, `riskMap`
- ä¾èµ–ï¼šè¡Œç¨‹é¡¹åˆ—è¡¨ï¼ˆä» `trip` prop è·å–ï¼‰

**DrDreView**:
- éœ€è¦ï¼š`metrics`, `metricsByItem`, `candidates`
- ä¾èµ–ï¼šè¡Œç¨‹é¡¹åˆ—è¡¨ï¼ˆä» `trip` prop è·å–ï¼‰
- å·²æœ‰ä½†æœªä½¿ç”¨ï¼š`tripsApi.getMetrics`

**NeptuneView**:
- éœ€è¦ï¼š`repairs`, `alternatives`
- ä¾èµ–ï¼šè¡Œç¨‹é¡¹åˆ—è¡¨ï¼ˆä» `trip` prop è·å–ï¼‰

**AutoView**:
- éœ€è¦ï¼š`overallMetrics`, å…³é”®é—®é¢˜åˆ—è¡¨
- ä¾èµ–ï¼šæ‰€æœ‰ä¸‰äººæ ¼çš„æ•°æ®
- å¯ä»¥å¤ç”¨ï¼š`getSuggestionStats`ï¼ˆå·²å¯¹æ¥ï¼‰

---

## ğŸ’¡ å®ç°å»ºè®®

### ä¼˜å…ˆçº§æ’åº

**é«˜ä¼˜å…ˆçº§ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰**:
1. âœ… `GET /trips/:id/risk-assessment` - AbuView æ ¸å¿ƒæ•°æ®
2. âœ… `GET /trips/:id/violations` - AbuView æ ¸å¿ƒæ•°æ®
3. âœ… `GET /trips/:id/repairs` - NeptuneView æ ¸å¿ƒæ•°æ®
4. âœ… `POST /trips/:id/repairs/:repairId/apply` - NeptuneView æ ¸å¿ƒåŠŸèƒ½
5. âœ… `POST /trips/:id/optimize` - DrDreView æ ¸å¿ƒåŠŸèƒ½

**ä¸­ä¼˜å…ˆçº§ï¼ˆå¢å¼ºåŠŸèƒ½ï¼‰**:
6. `GET /trips/:id/items/:itemId/risk` - AbuView è¯¦ç»†æ•°æ®
7. `GET /trips/:id/items/:itemId/metrics` - DrDreView è¯¦ç»†æ•°æ®
8. `GET /trips/:id/items/:itemId/alternatives` - NeptuneView è¯¦ç»†æ•°æ®
9. `GET /trips/:id/overall-metrics` - AutoView æ ¸å¿ƒæ•°æ®
10. `GET /trips/:id/critical-issues` - AutoView è¯¦ç»†æ•°æ®

### å®ç°æ­¥éª¤

1. **ç¬¬ä¸€æ­¥ï¼šAbuView é£é™©è¯„ä¼°æ¥å£**
   - å®ç° `GET /trips/:id/risk-assessment`
   - å®ç° `GET /trips/:id/violations`
   - æ›¿æ¢ç¡¬ç¼–ç çš„ `gatingStatus` å’Œ `violations`

2. **ç¬¬äºŒæ­¥ï¼šNeptuneView ä¿®å¤å»ºè®®æ¥å£**
   - å®ç° `GET /trips/:id/repairs`
   - å®ç° `POST /trips/:id/repairs/:repairId/apply`
   - æ›¿æ¢ç¡¬ç¼–ç çš„ `repairs`

3. **ç¬¬ä¸‰æ­¥ï¼šDrDreView ä¼˜åŒ–æ¥å£**
   - ä½¿ç”¨å·²å¯¹æ¥çš„ `GET /trips/:id/metrics`ï¼ˆéœ€è¦è½¬æ¢æ ¼å¼ï¼‰
   - å®ç° `POST /trips/:id/optimize`
   - æ›¿æ¢ç¡¬ç¼–ç çš„ `metrics` å’Œ `handleRegenerate`

4. **ç¬¬å››æ­¥ï¼šAutoView ç»¼åˆæŒ‡æ ‡æ¥å£**
   - å®ç° `GET /trips/:id/overall-metrics`
   - æ›¿æ¢ç¡¬ç¼–ç çš„ `overallMetrics`

5. **ç¬¬äº”æ­¥ï¼šè¯¦ç»†æ•°æ®æ¥å£**
   - å®ç°å•é¡¹é£é™©å’ŒæŒ‡æ ‡æ¥å£
   - å®ç°æ›¿ä»£æ–¹æ¡ˆæ¥å£
   - å®ç°å…³é”®é—®é¢˜æ¥å£

### ä»£ç ä¿®æ”¹å»ºè®®

**AbuView ç¤ºä¾‹**:
```typescript
// æ·»åŠ çŠ¶æ€
const [gatingStatus, setGatingStatus] = useState<'ALLOW' | 'WARN' | 'BLOCK' | null>(null);
const [violations, setViolations] = useState<RiskViolation[]>([]);
const [riskMap, setRiskMap] = useState<RiskMap>({});

// åŠ è½½æ•°æ®
useEffect(() => {
  const loadRiskData = async () => {
    try {
      const [assessment, violationsData] = await Promise.all([
        tripsApi.getRiskAssessment(trip.id),
        tripsApi.getViolations(trip.id),
      ]);
      setGatingStatus(assessment.gatingStatus);
      setViolations(violationsData.violations);
      
      // åŠ è½½å•é¡¹é£é™©
      const risks: RiskMap = {};
      for (const item of trip.TripDay.flatMap(day => day.items || [])) {
        const risk = await tripsApi.getItemRisk(trip.id, item.id);
        risks[item.id] = risk;
      }
      setRiskMap(risks);
    } catch (err) {
      console.error('Failed to load risk data:', err);
    }
  };
  
  if (trip?.id) {
    loadRiskData();
  }
}, [trip?.id]);
```

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-01-XX  
**ç»´æŠ¤è€…**: å‰ç«¯å›¢é˜Ÿ

