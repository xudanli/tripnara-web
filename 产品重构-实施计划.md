# 产品重构实施计划：从视图切换模式到事件驱动信号系统

## 一、核心设计理念转变

### 之前的问题
- 用户必须切换视图才能看到三人格信息
- 工具感重，需要理解"人格"概念
- 无法实现"静默校验、轻提示"的用户故事

### 新的设计理念
- **默认综合视图**：用户不切换也能看到最小提示（角标/摘要）
- **Lens聚焦**：切换视图是"强调信号"，不是"看见的前提"
- **事件驱动**：三人格自动触发，不需要手动切换
- **统一信号系统**：角标 → 小条 → 卡片（轻到重）

---

## 二、统一数据结构设计

### Suggestion/Insight 数据结构

```typescript
// src/types/suggestion.ts

export type PersonaType = 'abu' | 'drdre' | 'neptune';
export type SuggestionScope = 'trip' | 'day' | 'item' | 'segment';
export type SuggestionSeverity = 'info' | 'warn' | 'blocker';
export type SuggestionStatus = 'new' | 'seen' | 'applied' | 'dismissed';

export interface Suggestion {
  id: string;
  persona: PersonaType;
  scope: SuggestionScope;
  scopeId?: string; // dayId, itemId, etc.
  
  severity: SuggestionSeverity;
  status: SuggestionStatus;
  
  title: string;
  summary: string;
  evidence?: EvidenceLink[]; // Abu必须有
  
  actions: SuggestionAction[];
  
  createdAt: string;
  updatedAt?: string;
  
  refreshPolicy?: {
    triggers: string[]; // 哪些事件触发重新计算
  };
  
  metadata?: {
    [key: string]: any;
  };
}

export interface EvidenceLink {
  id: string;
  type: 'opening_hours' | 'road_closure' | 'weather' | 'booking' | 'other';
  title: string;
  link?: string;
}

export interface SuggestionAction {
  id: string;
  label: string;
  type: 'apply' | 'preview' | 'dismiss' | 'snooze' | 'view_evidence';
  primary?: boolean;
  handler: () => void | Promise<void>;
}

export interface SuggestionListResponse {
  items: Suggestion[];
  total: number;
  filters?: {
    persona?: PersonaType;
    scope?: SuggestionScope;
    scopeId?: string;
    severity?: SuggestionSeverity;
  };
}
```

---

## 三、信号系统设计

### 1. 节点角标（最轻）

位置：Day卡片、行程项右上角

显示规则：
- Abu：🛡 数字（风险点数量）
- Dr.Dre：📈 数字（节奏建议数量）
- Neptune：🛠 数字（可修复项数量）

行为：
- 默认只显示角标（无弹窗）
- 点击角标 → 打开右侧助手中心，过滤到对应项
- 无信号时不显示

### 2. 行内小条（中等）

位置：Day卡片内部、行程项下方

显示规则：
- 只在"需要立即注意，但不打断"时出现
- 一句话摘要 + 一个动作按钮

示例：
```
"发现 2 个风险点、1 个节奏建议，已汇总在右侧助手中心" [查看建议]
```

### 3. 助手卡片（重）

位置：右侧栏助手中心

统一结构：
- 人格icon + 严重级别
- 标题 + 摘要
- 行动按钮（最多2个）

---

## 四、页面改造方案

### A. 行程详情页 (`src/pages/trips/[id].tsx`)

#### 1. 顶部Header区改造

**1.1 健康度条升级**
- 子指标低于阈值 → 显示黄色/红色小点
- 点击 → 跳到助手中心并过滤

**1.2 视图模式按钮改造**
- 默认显示："Auto 综合"（推荐）
- 点击展开：Abu Lens / Dr Lens / Neptune Lens
- Auto模式：只展示最小提示，不展示仪表盘
- Lens模式：高亮对应信号，右栏自动切换

#### 2. 护航提示条（新增）

位置：Header下方，仅在需要时显示

显示规则：
- 无待处理：不显示
- 有待处理：显示轻提示 + "查看建议"按钮

#### 3. Day卡片改造

**3.1 添加微指标胶囊**
- 🚶 步行总量
- 🕒 通勤时长  
- 🧘 缓冲分钟
- 超阈值变色

**3.2 添加人格角标行**
- 仅在有问题时显示
- 点击角标 → 打开助手中心并过滤

**3.3 行程项角标**
- 每个行程项右上角也可挂角标
- 更精准的信号定位

#### 4. 右侧栏升级为助手中心

**4.1 Header**
- Tab：全部 / 风险 / 节奏 / 修复
- 过滤器：当前Day / 全行程

**4.2 建议卡片列表**
- 统一结构（见信号系统设计）
- 空态：友好提示 + 轻入口

**4.3 抽屉体系**
- Risk Drawer（Abu）
- Rhythm Drawer（Dr.Dre）
- Repair Drawer（Neptune）

---

### B. 规划工作台 (`src/pages/plan-studio/index.tsx`)

#### 1. 顶部改造

**1.1 添加助手中心入口**
- 小图标 + 数字（🛡 2 / 📈 1 / 🛠 3）
- 常驻显示，不藏在视图切换里

**1.2 视图模式改造**
- 同行程详情页

#### 2. 右下方Agent改造

**2.1 三种形态**
- 静默态：轻量按钮"让助手检查一下"
- 有事态：带数字/风险级别的胶囊条
- 召唤态：弹出动作菜单

**2.2 自动选人格**
- 根据当前问题类型默认推荐主动作
- 其他人格作为备选

**2.3 交互流程**
1. 生成建议卡（Preview）
2. 展示影响（Impact）
3. 一键应用（Apply）+ 自动触发复检

---

## 五、事件驱动触发器系统

### Abu触发器

触发条件：
- 生成/编辑路线后
- 夜间路段、危险区域
- 封路/落石预警
- 徒步难度超标
- 缺少撤离点
- 交通风险

响应：
- 有风险：节点角标 + 风险摘要卡
- 无风险：不出现（完全隐身）

### Dr.Dre触发器

触发条件：
- 连续高强度日
- 缓冲不足
- 用餐窗过短
- 通勤过长
- 体力指数超阈值
- 日程冲突

响应：
- 有问题：Day卡片标签 + 右栏建议卡
- 用户点"调整节奏"才进入重交互

### Neptune触发器

触发条件：
- POI闭馆/不可达
- 超预算
- 天气不适配
- 交通班次冲突
- 用户手动删除导致断链

响应：
- 有问题：节点旁淡黄色对话气泡 + "查看3个替代"
- 执行替换后：自动触发Abu + Dr复算

---

## 六、实施步骤

### Phase 1: 数据结构与类型定义
1. ✅ 创建 `src/types/suggestion.ts`
2. ✅ 更新相关类型定义

### Phase 2: 行程详情页改造
1. ✅ 添加角标组件
2. ✅ 改造右侧栏为助手中心
3. ✅ 添加护航提示条
4. ✅ 改造Day卡片（添加角标和微指标）
5. ✅ 改造视图模式按钮

### Phase 3: 信号系统实现
1. ✅ 角标系统
2. ✅ 行内小条组件
3. ✅ 助手卡片组件
4. ✅ 抽屉体系统一

### Phase 4: 规划工作台改造
1. ✅ 右下方Agent改造
2. ✅ 添加助手中心入口
3. ✅ 各Tab的信号系统集成

### Phase 5: 事件驱动系统
1. ✅ 触发器定义
2. ✅ 事件监听与响应
3. ✅ 自动更新机制

### Phase 6: 跨人格协同
1. ✅ Neptune应用后自动触发Abu+Dr复检
2. ✅ Toast提示系统
3. ✅ 状态同步

---

## 七、技术实现要点

### 1. 状态管理
- 使用React Context管理Suggestion列表
- 使用状态管理库（如Zustand）管理视图模式、过滤条件

### 2. 性能优化
- 角标计算使用useMemo
- 建议列表虚拟滚动（如果数据量大）
- 事件触发防抖处理

### 3. 用户体验
- 加载状态：骨架屏
- 空状态：友好提示
- 错误处理：静默失败，不影响主流程
- 动画：角标出现/消失、卡片展开/收起

### 4. 数据同步
- 应用建议后自动刷新相关数据
- 跨人格协同时避免重复请求
- 使用乐观更新提升体验

---

## 八、关键组件清单

### 新增组件
1. `SuggestionBadge` - 角标组件
2. `SuggestionInlineBar` - 行内小条
3. `SuggestionCard` - 助手卡片
4. `AssistantCenter` - 助手中心容器
5. `PersonaLensToggle` - Lens切换按钮
6. `AgentActionButton` - 右下方Agent按钮
7. `SuggestionDrawer` - 统一抽屉组件

### 改造组件
1. `TripDetailPage` - 行程详情页
2. `PlanStudioPage` - 规划工作台
3. `HealthBar` - 健康度条
4. `DayCard` - Day卡片
5. `ItineraryItemCard` - 行程项卡片

---

## 九、API接口需求

### 新增接口
1. `GET /trips/:id/suggestions` - 获取建议列表
2. `POST /trips/:id/suggestions/:suggestionId/apply` - 应用建议
3. `POST /trips/:id/suggestions/:suggestionId/dismiss` - 忽略建议
4. `GET /trips/:id/suggestions/stats` - 获取建议统计（用于角标数字）

### 现有接口改造
1. `getPersonaAlerts` → 返回Suggestion格式
2. `getConflicts` → 返回Suggestion格式
3. `getMetrics` → 包含触发建议的阈值信息

---

## 十、测试要点

### 功能测试
- [ ] 角标正确显示和隐藏
- [ ] 点击角标打开助手中心并过滤
- [ ] 建议应用后自动刷新
- [ ] 跨人格协同正常工作
- [ ] 事件触发器正确响应

### 用户体验测试
- [ ] 默认视图不干扰用户
- [ ] Lens切换流畅
- [ ] 角标/小条/卡片层级清晰
- [ ] 空状态友好
- [ ] 加载状态不闪烁

### 性能测试
- [ ] 大量建议时的渲染性能
- [ ] 事件触发频率控制
- [ ] 数据同步效率

---

## 十一、迁移策略

### 向后兼容
- 保留现有的视图切换功能（标记为deprecated）
- 新功能默认启用，可通过配置关闭
- 数据格式兼容，渐进式迁移

### 用户引导
- 首次使用时的轻引导（10秒Coachmark）
- 帮助文档更新
- 视频教程（可选）

---

## 十二、时间估算

- Phase 1: 数据结构设计 - 0.5天
- Phase 2: 行程详情页改造 - 3天
- Phase 3: 信号系统实现 - 2天
- Phase 4: 规划工作台改造 - 3天
- Phase 5: 事件驱动系统 - 2天
- Phase 6: 跨人格协同 - 1天
- 测试与优化 - 2天

**总计：约13.5个工作日**

---

## 十三、风险与应对

### 技术风险
- **风险**：大量组件改造可能引入bug
- **应对**：分阶段实施，每个阶段充分测试

### 性能风险
- **风险**：实时计算建议可能影响性能
- **应对**：使用缓存、防抖、虚拟滚动

### 用户体验风险
- **风险**：用户习惯改变可能不适应
- **应对**：保持向后兼容，提供引导

---

## 十四、成功标准

1. ✅ 用户无需切换视图即可看到关键信息
2. ✅ 三人格信息以轻量方式呈现（角标为主）
3. ✅ 事件驱动系统正常工作
4. ✅ 跨人格协同无缝联动
5. ✅ 性能无明显下降
6. ✅ 用户反馈正面

