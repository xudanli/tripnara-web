# 分享、收藏、协作功能接口对接总结

## 一、功能实现状态

### ✅ 已完成

1. **行程列表页** (`src/pages/trips/index.tsx`)
   - ✅ 收藏功能：已实现，包括状态显示和切换
   - ✅ 分享功能：已实现，打开分享对话框
   - ✅ 协作功能：已实现，打开协作对话框

2. **行程详情页** (`src/pages/trips/[id].tsx`)
   - ✅ 收藏功能：已实现
   - ✅ 分享功能：已实现（使用 `ShareTripDialog`）
   - ✅ 协作功能：已实现（使用 `CollaboratorsDialog`）

3. **API 接口** (`src/api/trips.ts`)
   - ✅ 所有接口已定义并实现

---

## 二、已对接的接口

### 2.1 收藏相关接口

| 接口路径 | 方法 | 状态 | 说明 |
|---------|------|------|------|
| `POST /trips/:id/collect` | POST | ✅ 已对接 | 收藏行程 |
| `DELETE /trips/:id/collect` | DELETE | ✅ 已对接 | 取消收藏 |
| `GET /trips/collected` | GET | ✅ 已对接 | 获取收藏列表 |

**使用位置**:
- `src/pages/trips/index.tsx` - 列表页收藏功能
- `src/pages/trips/[id].tsx` - 详情页收藏功能
- `src/pages/trips/collected.tsx` - 收藏列表页

---

### 2.2 分享相关接口

| 接口路径 | 方法 | 状态 | 说明 |
|---------|------|------|------|
| `POST /trips/:id/share` | POST | ✅ 已对接 | 创建分享链接 |
| `GET /trips/shared/:shareToken` | GET | ✅ 已对接 | 获取分享的行程 |
| `POST /trips/shared/:shareToken/import` | POST | ✅ 已对接 | 导入分享的行程 |

**使用位置**:
- `src/components/trips/ShareTripDialog.tsx` - 分享对话框
- `src/pages/trips/shared/[shareToken].tsx` - 分享行程查看页
- `src/pages/trips/index.tsx` - 列表页分享按钮
- `src/pages/trips/[id].tsx` - 详情页分享按钮

---

### 2.3 协作相关接口

| 接口路径 | 方法 | 状态 | 说明 |
|---------|------|------|------|
| `POST /trips/:id/collaborators` | POST | ✅ 已对接 | 添加协作者 |
| `GET /trips/:id/collaborators` | GET | ✅ 已对接 | 获取协作者列表 |
| `DELETE /trips/:id/collaborators/:userId` | DELETE | ✅ 已对接 | 移除协作者 |

**使用位置**:
- `src/components/trips/CollaboratorsDialog.tsx` - 协作者管理对话框
- `src/pages/trips/index.tsx` - 列表页协作按钮
- `src/pages/trips/[id].tsx` - 详情页协作按钮

---

## 三、需要后端优化的接口

### 3.1 收藏和点赞状态（推荐优化）

**当前实现**:
- 详情页通过调用 `GET /trips/collected` 获取所有收藏列表，然后查找当前行程是否在列表中
- 效率较低，特别是收藏列表很大时

**建议优化**:
在 `GET /trips/:id` 响应中添加以下字段：

```typescript
interface TripDetail {
  // ... 现有字段
  isCollected?: boolean;    // 当前用户是否已收藏
  isLiked?: boolean;        // 当前用户是否已点赞
  likeCount?: number;      // 点赞总数
}
```

**优势**:
- 减少一次 API 调用
- 提升页面加载速度
- 数据更准确（实时状态）

**优先级**: P1（中优先级）

---

### 3.2 行程列表项中的收藏状态（可选）

**当前实现**:
- 列表页在加载时调用 `GET /trips/collected` 获取所有收藏，然后建立 Set 来快速查找

**建议优化**:
在 `GET /trips` 响应中，每个 `TripListItem` 添加 `isCollected` 字段：

```typescript
interface TripListItem {
  // ... 现有字段
  isCollected?: boolean;    // 当前用户是否已收藏
}
```

**优势**:
- 减少一次 API 调用
- 列表加载更快

**优先级**: P2（低优先级，当前实现已足够高效）

---

## 四、接口规范参考

### 4.1 创建分享链接

**请求**:
```http
POST /trips/:id/share
Content-Type: application/json

{
  "permission": "VIEW" | "EDIT",
  "expiresAt": "2024-12-31T23:59:59Z"  // 可选
}
```

**响应**:
```json
{
  "success": true,
  "data": {
    "id": "share-id",
    "tripId": "trip-id",
    "shareToken": "abc123...",
    "shareUrl": "/trips/shared/abc123...",
    "permission": "VIEW",
    "expiresAt": "2024-12-31T23:59:59Z",
    "createdAt": "2024-01-01T00:00:00Z"
  }
}
```

---

### 4.2 添加协作者

**请求**:
```http
POST /trips/:id/collaborators
Content-Type: application/json

{
  "email": "user@example.com",
  "role": "VIEWER" | "EDITOR"
}
```

**响应**:
```json
{
  "success": true,
  "data": {
    "id": "collaborator-id",
    "tripId": "trip-id",
    "userId": "user-id",
    "email": "user@example.com",
    "role": "VIEWER",
    "createdAt": "2024-01-01T00:00:00Z"
  }
}
```

---

### 4.3 收藏行程

**请求**:
```http
POST /trips/:id/collect
```

**响应**:
```json
{
  "success": true,
  "data": {
    "success": true,
    "message": "行程已收藏",
    "tripId": "trip-id",
    "userId": "user-id",
    "collectedAt": "2024-01-01T00:00:00Z"
  }
}
```

---

## 五、前端实现细节

### 5.1 收藏功能

**列表页实现**:
- 使用 `Set<string>` 存储已收藏的行程 ID
- 页面加载时调用 `getCollected()` 初始化收藏状态
- 点击收藏按钮时调用 `collect()` 或 `uncollect()`，并更新本地状态
- 收藏按钮显示实心/空心图标，根据收藏状态变化

**详情页实现**:
- 使用 `isCollected` state 存储收藏状态
- 页面加载时调用 `checkCollectionStatus()` 检查收藏状态
- 点击收藏按钮时切换收藏状态

---

### 5.2 分享功能

**实现方式**:
- 使用 `ShareTripDialog` 组件
- 支持设置分享权限（VIEW/EDIT）和过期时间
- 生成分享链接后可以复制链接
- 分享链接格式：`/trips/shared/:shareToken`

**使用流程**:
1. 用户点击"分享"按钮
2. 打开分享对话框
3. 设置权限和过期时间（可选）
4. 点击"创建分享链接"
5. 显示生成的链接，可以复制

---

### 5.3 协作功能

**实现方式**:
- 使用 `CollaboratorsDialog` 组件
- 支持添加协作者（通过邮箱）
- 支持设置协作者权限（VIEWER/EDITOR）
- 支持查看和移除协作者

**使用流程**:
1. 用户点击"协作"按钮
2. 打开协作者管理对话框
3. 查看现有协作者列表
4. 添加新协作者（输入邮箱和选择权限）
5. 可以移除协作者

---

## 六、错误处理

### 6.1 收藏功能错误处理

- 如果 `getCollected()` 失败，静默处理，不影响主流程
- 如果 `collect()` 或 `uncollect()` 失败，显示错误提示
- 使用 `toast` 显示操作结果

### 6.2 分享功能错误处理

- 如果创建分享链接失败，在对话框中显示错误信息
- 用户可以重试或取消

### 6.3 协作功能错误处理

- 如果加载协作者列表失败，在对话框中显示错误信息
- 如果添加/移除协作者失败，显示错误提示
- 用户可以重试操作

---

## 七、测试建议

### 7.1 收藏功能测试

- [ ] 测试收藏/取消收藏功能
- [ ] 测试收藏状态在列表页和详情页的同步
- [ ] 测试收藏列表页显示是否正确
- [ ] 测试未登录用户的收藏功能（应该提示登录）

### 7.2 分享功能测试

- [ ] 测试创建分享链接
- [ ] 测试设置分享权限（VIEW/EDIT）
- [ ] 测试设置过期时间
- [ ] 测试通过分享链接查看行程
- [ ] 测试导入分享的行程
- [ ] 测试过期链接的访问

### 7.3 协作功能测试

- [ ] 测试添加协作者
- [ ] 测试设置协作者权限
- [ ] 测试查看协作者列表
- [ ] 测试移除协作者
- [ ] 测试协作者权限的实际效果（VIEWER 只能查看，EDITOR 可以编辑）

---

## 八、后续优化建议

1. **性能优化**:
   - 如果后端在详情接口中返回收藏和点赞状态，可以减少一次 API 调用
   - 列表页可以考虑使用虚拟滚动，如果行程数量很大

2. **用户体验优化**:
   - 添加收藏/取消收藏的动画效果
   - 分享链接可以生成二维码
   - 协作者管理可以显示协作者的头像和名称

3. **功能扩展**:
   - 支持批量收藏/取消收藏
   - 支持分享到社交媒体
   - 支持协作者评论功能

---

## 九、总结

✅ **所有功能已实现并对接完成**

- 收藏功能：✅ 已对接，工作正常
- 分享功能：✅ 已对接，工作正常
- 协作功能：✅ 已对接，工作正常

**建议后端优化**:
- 在 `GET /trips/:id` 响应中添加 `isCollected`、`isLiked`、`likeCount` 字段（P1）
- 在 `GET /trips` 响应中添加 `isCollected` 字段（P2，可选）

**当前实现已满足基本需求，可以正常使用。**

