# 行程详情页 - 未对接接口检查报告

**文件**: `src/pages/trips/[id].tsx`  
**检查日期**: 2025-01-XX  
**代码行数**: 1825行

---

## 📋 目录

1. [已对接接口清单](#已对接接口清单)
2. [未完全对接的功能](#未完全对接的功能)
3. [TODO 项目](#todo-项目)
4. [错误处理改进建议](#错误处理改进建议)

---

## ✅ 已对接接口清单

### 1. 核心数据加载接口

| 接口 | 方法 | 调用位置 | 函数名 | 状态 |
|------|------|---------|--------|------|
| `GET /trips/:id` | GET | 第325行 | `loadTrip()` → `tripsApi.getById()` | ✅ 已对接 |
| `GET /trips/:id/state` | GET | 第463行 | `loadTripState()` → `tripsApi.getState()` | ✅ 已对接 |
| `GET /trips/:id/evidence` | GET | 第476行 | `loadEvidence()` → `tripsApi.getEvidence()` | ✅ 已对接 |
| `GET /trips/:id/suggestions` | GET | 第544行 | `loadSuggestions()` → `tripsApi.getSuggestions()` | ✅ 已对接 |
| `GET /trips/:id/suggestions/stats` | GET | 第573行 | `loadSuggestions()` → `tripsApi.getSuggestionStats()` | ✅ 已对接 |
| `GET /trips/:id/persona-alerts` | GET | 第615行 | `loadPersonaAlerts()` → `tripsApi.getPersonaAlerts()` | ✅ 已对接 |
| `GET /trips/:id/decision-log` | GET | 第634行 | `loadDecisionLogs()` → `tripsApi.getDecisionLog()` | ✅ 已对接 |
| `GET /trips/:id/metrics` | GET | 第650行 | `loadTripMetrics()` → `tripsApi.getMetrics()` | ✅ 已对接 |
| `GET /trips/:id/days/:dayId/metrics` | GET | 第673行 | `loadDayMetrics()` → `tripsApi.getDayMetrics()` | ✅ 已对接 |
| `GET /trips/:id/conflicts` | GET | 第690行 | `loadConflicts()` → `tripsApi.getConflicts()` | ✅ 已对接 |
| `GET /trips/:id/recap` | GET | 第790行 | `loadRecapReport()` → `tripsApi.getRecap()` | ✅ 已对接 |
| `GET /countries` | GET | 第392行 | `loadCountryInfo()` → `countriesApi.getAll()` | ✅ 已对接 |

### 2. 操作接口

| 接口 | 方法 | 调用位置 | 函数名 | 状态 |
|------|------|---------|--------|------|
| `POST /trips/:id/collect` | POST | 第428行 | `handleCollect()` → `tripsApi.collect()` | ✅ 已对接 |
| `DELETE /trips/:id/collect` | DELETE | 第425行 | `handleCollect()` → `tripsApi.uncollect()` | ✅ 已对接 |
| `POST /trips/:id/like` | POST | 第448行 | `handleLike()` → `tripsApi.like()` | ✅ 已对接 |
| `DELETE /trips/:id/like` | DELETE | 第444行 | `handleLike()` → `tripsApi.unlike()` | ✅ 已对接 |
| `DELETE /itinerary-items/:id` | DELETE | 第709行 | `handleDeleteItem()` → `itineraryItemsApi.delete()` | ✅ 已对接 |
| `PATCH /itinerary-items/:id` | PATCH | 第725行 | `handleReplaceSuccess()` → `itineraryItemsApi.update()` | ✅ 已对接 |
| `POST /trips/:id/regenerate` | POST | 第747行 | `handleRegenerate()` → `tripsApi.regenerate()` | ✅ 已对接 |
| `POST /trips/draft` | POST | 第759行 | `handleRegenerate()` → `tripsApi.saveDraft()` | ✅ 已对接 |
| `DELETE /trips/:id` | DELETE | 第810行 | `handleDelete()` → `tripsApi.delete()` | ✅ 已对接 |
| `POST /trips/:id/suggestions/:suggestionId/dismiss` | POST | 第1182行 | `onActionClick()` → `tripsApi.dismissSuggestion()` | ✅ 已对接 |
| `POST /trips/:id/suggestions/:suggestionId/apply` | POST | 第1190, 1231行 | `onActionClick()` → `tripsApi.applySuggestion()` | ✅ 已对接 |

---

## ⚠️ 未完全对接的功能

### 1. 预览功能（Preview）

**位置**: 第1207-1214行

**当前状态**:
```typescript
// 预览操作
if (actionId === 'preview') {
  const previewResult = await tripsApi.applySuggestion(id, suggestion.id, {
    actionId: actionId,
    preview: true,
  });
  console.log('预览结果:', previewResult);
  // TODO: 显示预览对话框
  return;
}
```

**问题**:
- ✅ 接口已调用（`tripsApi.applySuggestion()` with `preview: true`）
- ❌ 预览结果未显示给用户（只有 console.log）
- ❌ 缺少预览对话框组件

**建议**:
- 创建预览对话框组件显示变更预览
- 允许用户确认或取消应用

---

### 2. Toast 提示功能

**位置**: 第1200-1201行, 第1241行

**当前状态**:
```typescript
if (result.triggeredSuggestions && result.triggeredSuggestions.length > 0) {
  console.log('应用建议后触发了新建议:', result.triggeredSuggestions);
  // TODO: 可以显示toast提示
}
```

**问题**:
- ❌ 应用建议后触发的建议未提示用户
- ❌ 使用 console.log 而不是用户可见的提示

**建议**:
- 使用 `sonner` 或类似的 toast 库显示提示
- 提示用户："应用建议后产生了 X 个新建议"

---

### 3. 错误提示功能

**位置**: 第1248-1250行

**当前状态**:
```typescript
} catch (error: any) {
  console.error('Failed to handle suggestion action:', error);
  // TODO: 显示错误提示
}
```

**问题**:
- ❌ 错误只记录到 console，用户看不到
- ❌ 操作失败时用户无反馈

**建议**:
- 使用 toast 显示错误提示
- 根据错误类型显示不同的提示信息

---

### 4. 保存为模板功能

**位置**: 第1554-1557行

**当前状态**:
```typescript
onClick={() => {
  // TODO: 保存为模板
  alert('保存为模板功能开发中');
}}
```

**问题**:
- ❌ 功能未实现
- ❌ 使用 alert 临时提示

**需要的接口**:
- `POST /trips/:id/save-as-template` 或类似接口
- 或 `POST /templates` 创建模板

**建议**:
- 实现保存为模板的对话框
- 允许用户输入模板名称和描述
- 调用后端接口保存

---

## 📝 TODO 项目清单

| 行号 | 内容 | 优先级 | 状态 |
|------|------|--------|------|
| 1201 | 可以显示toast提示 | 🟡 中 | ⚠️ 未实现 |
| 1213 | 显示预览对话框 | 🔴 高 | ⚠️ 未实现 |
| 1250 | 显示错误提示 | 🔴 高 | ⚠️ 未实现 |
| 1555 | 保存为模板 | 🟡 中 | ⚠️ 未实现 |

---

## 🔧 错误处理改进建议

### 1. 使用 Toast 替代 console.log/alert

**当前问题**:
- 多处使用 `console.log` 和 `alert` 提示用户
- 用户体验不佳

**建议**:
- 引入 `sonner` toast 库（项目可能已安装）
- 统一错误提示方式

**需要修改的位置**:
- 第1200行：应用建议后的提示
- 第1212行：预览结果提示
- 第1247行：操作处理日志
- 第1249行：错误提示
- 第1556行：功能开发中提示

### 2. 错误处理完善

**当前状态**:
- 大部分接口调用都有 try-catch
- 但错误处理方式不统一：
  - 有些使用 `console.error` + 静默处理
  - 有些使用 `alert` 显示错误
  - 有些完全没有用户反馈

**建议**:
- 统一错误处理策略
- 关键操作失败时显示 toast 提示
- 非关键操作失败时静默处理（已实现）

---

## 📊 接口调用统计

### 已对接接口：**13个**
- ✅ 数据加载接口：12个
- ✅ 操作接口：11个

### 未完全对接功能：**4个**
- ⚠️ 预览功能（接口已调用，UI未实现）
- ⚠️ Toast提示（功能未实现）
- ⚠️ 错误提示（功能未实现）
- ⚠️ 保存为模板（功能未实现）

### TODO 项目：**4个**
- 全部为UI/UX改进，非接口对接问题

---

## 🎯 总结

### ✅ 好消息
- **所有核心接口都已对接**
- 数据加载、操作接口都已实现
- 错误处理基本完善（静默处理策略）

### ⚠️ 需要改进
- **UI反馈不完善**：缺少 toast 提示
- **预览功能未完成**：接口已调用但UI未实现
- **保存为模板功能缺失**：需要新增接口和UI

### 📌 优先级建议
1. **高优先级**：实现错误提示和预览对话框
2. **中优先级**：实现 toast 提示和保存为模板功能

---

**检查完成时间**: 2025-01-XX

