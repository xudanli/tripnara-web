# 准备度页面硬编码问题检查报告

## 概述

检查了准备度页面 (`src/pages/readiness/index.tsx`) 和相关组件，发现以下硬编码问题：

---

## 1. 分数计算中的硬编码值 ⚠️

### 位置 1: `convertCheckResultToReadinessData` 函数（第 332-340 行）

```typescript
score: {
  overall: overallScore,  // ✅ 基于数据计算
  evidenceCoverage: 85,  // ❌ 硬编码
  scheduleFeasibility: 70,  // ❌ 硬编码
  transportCertainty: 65,  // ❌ 硬编码
  safetyRisk: Math.max(0, 100 - (highRiskCount * 20)),  // ⚠️ 公式硬编码
  buffers: 60,  // ❌ 硬编码
}
```

### 位置 2: `convertToReadinessData` 函数（第 408-416 行）

```typescript
score: {
  overall: overallScore,  // ✅ 基于数据计算
  evidenceCoverage: checklist ? 85 : 0,  // ⚠️ 硬编码（有 checklist 时是 85，否则是 0）
  scheduleFeasibility: 70,  // ❌ 硬编码
  transportCertainty: 65,  // ❌ 硬编码
  safetyRisk: Math.max(0, 100 - (highRiskCount * 20)),  // ⚠️ 公式硬编码
  buffers: 60,  // ❌ 硬编码
}
```

**问题说明：**
- `evidenceCoverage`、`scheduleFeasibility`、`transportCertainty`、`buffers` 都是硬编码的固定值
- `safetyRisk` 虽然基于风险计算，但计算公式是硬编码的
- 这些值应该从后端 API 返回，或者基于实际数据计算

**建议：**
- 如果后端 API 返回这些分数，应该使用 API 数据
- 如果后端不返回，应该基于实际数据计算（例如：基于 evidence 数量计算 coverage，基于行程项计算 feasibility 等）
- 如果无法计算，应该标记为 `null` 或 `undefined`，而不是硬编码

---

## 2. 模拟数据函数 ⚠️

### 位置: `generateMockReadinessData` 函数（第 423-473 行）

```typescript
const generateMockReadinessData = (): ReadinessData => {
  return {
    status: 'nearly',
    score: {
      overall: 72,  // ❌ 硬编码
      evidenceCoverage: 85,  // ❌ 硬编码
      scheduleFeasibility: 70,  // ❌ 硬编码
      transportCertainty: 65,  // ❌ 硬编码
      safetyRisk: 80,  // ❌ 硬编码
      buffers: 60,  // ❌ 硬编码
    },
    executableWindow: {
      start: '08:30',  // ❌ 硬编码
      end: '18:00',  // ❌ 硬编码
    },
    blockers: [
      // ❌ 硬编码的 blockers 数据
      {
        id: 'blocker-1',
        title: 'Road closed on Segment 2',
        // ...
      },
      // ...
    ],
    // ...
  };
};
```

**问题说明：**
- 这是降级方案，当所有 API 都失败时使用
- 包含硬编码的分数、时间窗口、blockers 等
- 虽然这是降级方案，但应该考虑是否真的需要，或者至少应该更明确地标记

**建议：**
- 如果这是必要的降级方案，应该添加更明确的注释说明
- 考虑是否应该显示错误信息而不是显示模拟数据
- 或者使用更通用的空状态，而不是硬编码的假数据

---

## 3. 修复选项的模拟数据 ⚠️

### 位置: `handleGetRepairOptions` 函数（第 517-553 行）

```typescript
catch (err) {
  console.error('Failed to load repair options:', err);
  // 降级方案：使用模拟数据
  const mockRepairOptions: RepairOption[] = [
    {
      id: 'repair-1',
      title: '替换 POI',
      description: '使用附近的替代 POI，距离增加 30 分钟',
      changes: {
        time: '+30min',
        distance: '+2km',
        risk: '下降',
      },
      reasonCode: 'REPLACE_POI',
      evidenceLink: '#',
    },
    // ... 更多硬编码的修复选项
  ];
  // ...
}
```

**问题说明：**
- 当获取修复选项失败时，使用硬编码的模拟数据
- 这些数据与实际的 blocker 无关，是通用的示例数据

**建议：**
- 应该显示错误信息，而不是显示不相关的模拟数据
- 或者至少应该标记这些是示例数据，不是真实的修复选项

---

## 4. 计算公式硬编码 ⚠️

### 位置: 多个地方

```typescript
// overallScore 计算公式
const overallScore = Math.max(0, 100 - (totalBlockers * 20) - (highRiskCount * 10) - (riskCount * 5));

// safetyRisk 计算公式
const safetyRisk = Math.max(0, 100 - (highRiskCount * 20));
```

**问题说明：**
- 计算公式中的权重（20, 10, 5）是硬编码的
- 这些权重应该由后端决定，或者至少应该是可配置的

**建议：**
- 如果后端返回分数，应该使用后端数据
- 如果必须在前端计算，应该将权重提取为常量或配置
- 或者从后端获取计算公式/权重

---

## 5. 时间戳硬编码 ⚠️

### 位置: `generateMockReadinessData` 函数

```typescript
timestamp: new Date(Date.now() - 3600000).toISOString(),  // 1小时前
timestamp: new Date(Date.now() - 7200000).toISOString(),  // 2小时前
```

**问题说明：**
- 模拟数据中的时间戳是硬编码的相对时间
- 虽然这是模拟数据，但应该使用更合理的时间

**建议：**
- 如果这是必要的降级方案，时间戳可以保持相对时间
- 但应该添加注释说明这是模拟数据

---

## 总结

### 严重程度分类

1. **高优先级（需要修复）：**
   - ✅ 分数计算中的硬编码值（`evidenceCoverage`, `scheduleFeasibility`, `transportCertainty`, `buffers`）
   - ✅ 修复选项的模拟数据（应该显示错误而不是假数据）

2. **中优先级（建议修复）：**
   - ⚠️ 计算公式中的硬编码权重
   - ⚠️ `safetyRisk` 的计算公式

3. **低优先级（可接受，但需要改进）：**
   - ⚠️ 模拟数据函数（降级方案，但应该更明确）
   - ⚠️ 时间戳硬编码（模拟数据中可接受）

### 建议的修复方案

1. **检查后端 API 是否返回分数数据**
   - 如果返回，使用 API 数据
   - 如果不返回，考虑添加 API 端点

2. **如果必须在前端计算分数**
   - 基于实际数据计算（例如：基于 evidence 数量、行程项数量等）
   - 将计算公式和权重提取为常量或配置
   - 添加注释说明计算逻辑

3. **改进错误处理**
   - 修复选项获取失败时，显示错误信息而不是模拟数据
   - 所有 API 失败时，显示友好的错误提示而不是模拟数据

4. **标记模拟数据**
   - 如果必须使用模拟数据，应该明确标记为"示例数据"或"降级方案"
   - 添加警告提示用户这是模拟数据

---

## 相关文件

- `src/pages/readiness/index.tsx` - 主页面（包含所有硬编码）
- `src/components/readiness/ReadinessDrawer.tsx` - 抽屉组件（未发现硬编码）
- `src/components/readiness/RiskCard.tsx` - 风险卡片（未发现硬编码）
- `src/components/readiness/ChecklistSection.tsx` - 清单部分（未发现硬编码）

---

## 检查日期

2025-01-XX
