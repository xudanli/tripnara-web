# PRD: 行程项时间与距离智能校验系统

> **产品经理**: Danny  
> **版本**: v1.0  
> **创建日期**: 2026-01-21  
> **状态**: 待评审

---

## 1. 背景与目标

### 1.1 背景

当前系统在创建/修改行程项时，已具备以下校验能力：
- ✅ 基础时间逻辑校验（结束时间 > 开始时间）
- ✅ 营业时间校验（检查地点是否在指定时间营业）
- ✅ 徒步路线时长校验（Trail 的 estimatedDurationHours）
- ✅ 冲突检测服务（TripConflictsService）

**痛点分析**：
1. **时间冲突检测滞后**：冲突检测是事后查询，而非创建/修改时实时拦截
2. **距离校验缺失**：用户可能安排相距 100km 的两个地点，中间只留 30 分钟
3. **交通时间未考虑**：系统有 SmartRoutesService，但未在创建时强制校验
4. **用户体验差**：用户创建后才发现问题，需要手动修复

### 1.2 目标

| 目标 | 指标 | 基线 | 目标值 |
|------|------|------|--------|
| 降低不可行行程比例 | 创建后存在 HIGH 级冲突的行程 | 估计 40% | < 5% |
| 提升用户效率 | 行程项修改次数 | - | 减少 50% |
| 保持灵活性 | 用户可覆盖警告 | N/A | 100% 支持 |

---

## 2. 用户故事

### 2.1 核心场景

```
作为一名旅行规划用户，
我希望在添加/修改行程项时，系统能自动校验时间和距离是否合理，
以便我能快速发现问题并做出调整，避免规划出不可行的行程。
```

### 2.2 详细用户故事

| ID | 用户故事 | 优先级 |
|----|----------|--------|
| US-01 | 作为用户，当我添加行程项时，如果与前一个活动存在时间重叠，系统应阻止并提示 | P0 |
| US-02 | 作为用户，当我添加行程项时，如果距离前一个地点太远且时间不够，系统应警告 | P0 |
| US-03 | 作为用户，我希望看到系统推荐的最早可行开始时间 | P1 |
| US-04 | 作为用户，我希望能选择忽略警告强制添加（高级用户） | P1 |
| US-05 | 作为用户，修改行程项时间时，系统应自动检查对后续行程的影响 | P1 |
| US-06 | 作为用户，我希望系统能推荐合适的交通方式 | P2 |

---

## 3. 功能需求

### 3.1 创建行程项时的校验 (P0)

#### 3.1.1 时间重叠校验

**触发条件**：创建行程项时

**校验规则**：
```
IF 新行程项.startTime < 同日任意现有行程项.endTime 
   AND 新行程项.endTime > 同日任意现有行程项.startTime
THEN 返回错误：时间重叠
```

**响应格式**：
```json
{
  "success": false,
  "error": {
    "code": "TIME_OVERLAP",
    "message": "时间冲突：与「Golden Circle 环线」(10:00-14:00) 存在重叠",
    "details": {
      "conflictingItemId": "uuid-xxx",
      "conflictingItemName": "Golden Circle 环线",
      "conflictingTimeRange": {
        "start": "2025-12-05T10:00:00Z",
        "end": "2025-12-05T14:00:00Z"
      },
      "suggestedStartTime": "2025-12-05T14:15:00Z"
    }
  }
}
```

#### 3.1.2 距离-时间可行性校验

**触发条件**：创建行程项时，且同日存在前序行程项

**校验规则**：
```
1. 获取前一个行程项的结束位置 (fromLocation)
2. 获取新行程项的位置 (toLocation)
3. 计算直线距离 (Haversine)
4. 根据距离选择交通方式：
   - < 2km: 步行 (预估 15min/km)
   - 2-50km: 驾车 (调用 SmartRoutesService)
   - > 50km: 公共交通 (调用 SmartRoutesService)
5. 计算所需时间 = 交通时间 + 缓冲时间(15min)
6. IF 前一个行程项.endTime + 所需时间 > 新行程项.startTime
   THEN 返回警告
```

**响应格式**：
```json
{
  "success": false,
  "error": {
    "code": "INSUFFICIENT_TRAVEL_TIME",
    "message": "交通时间不足：从「蓝湖温泉」到「雷克雅未克市区」需要约 45 分钟，但您仅预留了 20 分钟",
    "details": {
      "fromPlace": {
        "id": 123,
        "name": "蓝湖温泉",
        "coordinates": [63.8804, -22.4495]
      },
      "toPlace": {
        "id": 456,
        "name": "雷克雅未克市区",
        "coordinates": [64.1466, -21.9426]
      },
      "distance": {
        "straight": 42.5,
        "road": 48.2,
        "unit": "km"
      },
      "travelTime": {
        "estimated": 45,
        "withBuffer": 60,
        "unit": "minutes"
      },
      "recommendedTransport": "DRIVING",
      "availableTime": 20,
      "suggestedStartTime": "2025-12-05T15:00:00Z",
      "alternatives": [
        {
          "transport": "DRIVING",
          "duration": 45,
          "suggestedStart": "2025-12-05T15:00:00Z"
        }
      ]
    }
  }
}
```

#### 3.1.3 校验严格程度配置

| 级别 | 行为 | 适用场景 |
|------|------|----------|
| `strict` | 阻止创建，必须修正 | 时间重叠 |
| `warning` | 允许创建，返回警告 | 交通时间不足 |
| `info` | 仅提示，不影响操作 | 缓冲时间 < 30min |

### 3.2 修改行程项时的校验 (P0)

#### 3.2.1 级联影响检测

**触发条件**：修改行程项的 `startTime` 或 `endTime`

**校验规则**：
```
1. 获取同日所有后续行程项
2. 对每个后续行程项：
   a. 计算从当前位置到该行程项位置的交通时间
   b. 检查时间是否充足
3. 如果任意后续行程项受影响，返回影响报告
```

**响应格式**：
```json
{
  "success": true,
  "data": { /* 更新后的行程项 */ },
  "warnings": [
    {
      "type": "CASCADE_IMPACT",
      "message": "此修改将影响后续 2 个行程项",
      "affectedItems": [
        {
          "id": "uuid-2",
          "name": "午餐",
          "originalTime": "12:00-13:00",
          "suggestedTime": "12:30-13:30",
          "reason": "需要延后 30 分钟以留出交通时间"
        },
        {
          "id": "uuid-3",
          "name": "博物馆",
          "originalTime": "14:00-16:00",
          "suggestedTime": "14:30-16:30",
          "reason": "受前序行程影响需要延后"
        }
      ],
      "autoAdjust": false
    }
  ]
}
```

### 3.3 强制覆盖机制 (P1)

**请求参数**：
```typescript
interface CreateItineraryItemDto {
  // ... 现有字段
  
  /**
   * 强制创建，忽略警告级别的校验
   * 仅对 warning 级别生效，strict 级别无法覆盖
   */
  forceCreate?: boolean;
  
  /**
   * 忽略的警告类型列表
   */
  ignoreWarnings?: ('INSUFFICIENT_TRAVEL_TIME' | 'SHORT_BUFFER')[];
}
```

### 3.4 批量校验接口 (P1)

**场景**：草案保存为正式行程时，批量校验所有行程项

**接口**：
```
POST /api/trips/:tripId/validate-itinerary
```

**响应**：
```json
{
  "valid": false,
  "errors": [
    {
      "day": "2025-12-05",
      "items": ["uuid-1", "uuid-2"],
      "type": "TIME_OVERLAP",
      "message": "..."
    }
  ],
  "warnings": [
    {
      "day": "2025-12-05",
      "items": ["uuid-2", "uuid-3"],
      "type": "INSUFFICIENT_TRAVEL_TIME",
      "message": "..."
    }
  ],
  "suggestions": [
    {
      "action": "REORDER",
      "description": "建议将「蓝湖温泉」移至下午，避免长距离往返",
      "estimatedSaving": "60 分钟"
    }
  ]
}
```

---

## 4. 技术方案

### 4.1 架构设计

```
┌─────────────────────────────────────────────────────────────────┐
│                     ItineraryItemsController                     │
└─────────────────────────────────┬───────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                   ItineraryValidationService                     │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │ TimeValidator   │  │ DistanceValidator│  │ BufferValidator │ │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘ │
│           │                    │                    │           │
│           └────────────────────┼────────────────────┘           │
│                                ▼                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │              ValidationResultAggregator                     ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────┬───────────────────────────────┘
                                  │
                    ┌─────────────┴─────────────┐
                    ▼                           ▼
        ┌───────────────────┐       ┌───────────────────┐
        │ SmartRoutesService│       │ TripConflictsService│
        │  (交通时间计算)    │       │  (现有冲突检测)     │
        └───────────────────┘       └───────────────────┘
```

### 4.2 核心接口定义

```typescript
// src/itinerary-items/interfaces/validation.interface.ts

export enum ValidationSeverity {
  ERROR = 'error',      // 阻止操作
  WARNING = 'warning',  // 警告但允许
  INFO = 'info'         // 仅提示
}

export enum ValidationCode {
  TIME_OVERLAP = 'TIME_OVERLAP',
  INSUFFICIENT_TRAVEL_TIME = 'INSUFFICIENT_TRAVEL_TIME',
  SHORT_BUFFER = 'SHORT_BUFFER',
  BUSINESS_HOURS_VIOLATION = 'BUSINESS_HOURS_VIOLATION',
  CASCADE_IMPACT = 'CASCADE_IMPACT'
}

export interface ValidationResult {
  valid: boolean;
  severity: ValidationSeverity;
  code: ValidationCode;
  message: string;
  details: Record<string, any>;
  suggestions?: ValidationSuggestion[];
}

export interface ValidationSuggestion {
  action: 'ADJUST_TIME' | 'CHANGE_TRANSPORT' | 'REORDER' | 'REMOVE';
  description: string;
  newValue?: any;
  estimatedImprovement?: string;
}

export interface ValidationContext {
  tripDayId: string;
  existingItems: ItineraryItem[];
  newItem: CreateItineraryItemDto;
  previousItem?: ItineraryItem;
  nextItem?: ItineraryItem;
}
```

### 4.3 数据流

```
1. 用户提交创建/修改请求
   │
   ▼
2. Controller 调用 ValidationService.validate()
   │
   ├─→ TimeValidator.check() ──→ 检查时间重叠
   ├─→ DistanceValidator.check() ──→ 检查交通时间
   └─→ BufferValidator.check() ──→ 检查缓冲时间
   │
   ▼
3. 聚合校验结果
   │
   ├─ 有 ERROR 级别 → 返回错误，阻止操作
   ├─ 仅有 WARNING 且 forceCreate=true → 继续创建，返回警告
   ├─ 仅有 WARNING 且 forceCreate=false → 返回警告，阻止操作
   └─ 全部通过 → 创建/修改成功
```

---

## 5. API 变更

### 5.1 创建行程项 (增强)

```
POST /api/itinerary-items
```

**请求体变更**：
```typescript
interface CreateItineraryItemDto {
  tripDayId: string;
  placeId?: number;
  trailId?: number;
  type: ItemType;
  startTime: string;
  endTime: string;
  note?: string;
  
  // === 新增字段 ===
  /** 强制创建，忽略 WARNING 级别校验 */
  forceCreate?: boolean;
  /** 指定忽略的警告类型 */
  ignoreWarnings?: ValidationCode[];
}
```

**响应体变更**：
```typescript
interface CreateItineraryItemResponse {
  success: boolean;
  data?: ItineraryItem;
  error?: {
    code: ValidationCode;
    message: string;
    details: any;
  };
  // === 新增字段 ===
  warnings?: ValidationResult[];
  travelInfo?: {
    fromPlace?: string;
    toPlace?: string;
    distance: number;
    estimatedDuration: number;
    recommendedTransport: string;
  };
}
```

### 5.2 修改行程项 (增强)

```
PATCH /api/itinerary-items/:id
```

**响应体新增**：
```typescript
interface UpdateItineraryItemResponse {
  success: boolean;
  data?: ItineraryItem;
  // === 新增字段 ===
  cascadeImpact?: {
    affectedCount: number;
    affectedItems: Array<{
      id: string;
      name: string;
      suggestedTimeChange: {
        from: { start: string; end: string };
        to: { start: string; end: string };
      };
    }>;
    autoAdjusted: boolean;
  };
}
```

### 5.3 新增：预校验接口

```
POST /api/itinerary-items/validate
```

**用途**：前端在用户输入时实时校验，无需实际创建

**请求体**：与 `CreateItineraryItemDto` 相同

**响应体**：
```typescript
interface ValidateResponse {
  valid: boolean;
  errors: ValidationResult[];
  warnings: ValidationResult[];
  suggestions: ValidationSuggestion[];
  travelInfo?: TravelInfo;
}
```

### 5.4 新增：批量校验接口

```
POST /api/trips/:tripId/validate-itinerary
```

**请求体**：
```typescript
interface ValidateItineraryRequest {
  /** 仅校验指定日期，不传则校验全部 */
  dates?: string[];
  /** 校验严格程度 */
  strictLevel?: 'strict' | 'normal' | 'relaxed';
}
```

---

## 6. 前端交互设计

### 6.1 创建行程项弹窗

```
┌─────────────────────────────────────────────────────┐
│  添加行程项                                    [X]  │
├─────────────────────────────────────────────────────┤
│                                                     │
│  地点: [蓝湖温泉                          ▼]       │
│                                                     │
│  时间: [09:00] - [12:00]                           │
│                                                     │
│  ┌─────────────────────────────────────────────┐   │
│  │ ⚠️ 交通时间警告                              │   │
│  │                                             │   │
│  │ 从「酒店」到「蓝湖温泉」约 48km，           │   │
│  │ 预计驾车需要 45 分钟。                      │   │
│  │                                             │   │
│  │ 建议开始时间: 09:45                         │   │
│  │                                             │   │
│  │ [调整为建议时间]  [仍然使用 09:00]          │   │
│  └─────────────────────────────────────────────┘   │
│                                                     │
│                        [取消]  [确认添加]           │
└─────────────────────────────────────────────────────┘
```

### 6.2 时间轴视图增强

```
08:00 ┃ ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
      ┃ 
09:00 ┃ ████████████████████████████  酒店早餐
      ┃ ════════════════════════════  ↓ 驾车 45min
10:00 ┃ ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
      ┃ ⚠️ 缓冲时间不足 (仅15min)
11:00 ┃ ████████████████████████████████████  蓝湖温泉
      ┃ ████████████████████████████████████
12:00 ┃ ████████████████████████████████████
      ┃ ════════════════════════════  ↓ 驾车 45min
13:00 ┃ ░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░
```

### 6.3 错误状态展示

| 状态 | 视觉表现 | 交互 |
|------|----------|------|
| ERROR | 红色边框 + 红色背景 | 阻止提交，必须修正 |
| WARNING | 黄色边框 + 黄色背景 | 可展开详情，可选择忽略 |
| INFO | 蓝色图标 | 仅显示提示信息 |

---

## 7. 非功能需求

### 7.1 性能要求

| 指标 | 要求 |
|------|------|
| 单次校验响应时间 | < 500ms (P95) |
| 批量校验 (10天行程) | < 3s |
| 路线查询缓存 | 相同起终点 + 2小时内复用 |

### 7.2 降级策略

| 场景 | 降级行为 |
|------|----------|
| SmartRoutesService 不可用 | 使用 Haversine 距离估算时间 |
| 外部路线 API 超时 | 返回 WARNING 而非 ERROR |
| 数据库查询超时 | 跳过校验，记录日志 |

### 7.3 监控指标

- 校验拦截率（被阻止的创建请求比例）
- 警告忽略率（用户选择强制创建的比例）
- 校验耗时分布
- 路线 API 调用量和成功率

---

## 8. 实施计划

### Phase 1: 基础校验 (P0)
- [ ] 时间重叠校验
- [ ] 基于 Haversine 距离的交通时间估算
- [ ] 创建接口增强

### Phase 2: 智能校验 (P1)
- [ ] 集成 SmartRoutesService 精确计算
- [ ] 级联影响检测
- [ ] 批量校验接口
- [ ] forceCreate 机制

### Phase 3: 体验优化 (P2)
- [ ] 预校验接口
- [ ] 前端实时校验
- [ ] 智能建议系统
- [ ] 路线缓存优化

---

## 9. 风险与缓解

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| SmartRoutesService 限流 | 中 | 高 | 实现请求队列 + 本地缓存 |
| 校验过于严格影响用户体验 | 中 | 中 | forceCreate + 可配置严格程度 |
| 复杂行程校验超时 | 低 | 中 | 异步校验 + 降级策略 |

---

## 10. 附录

### A. 现有代码参考

| 模块 | 路径 | 说明 |
|------|------|------|
| 行程项服务 | `src/itinerary-items/itinerary-items.service.ts` | 已有营业时间校验 |
| 冲突检测 | `src/trips/services/trip-conflicts.service.ts` | 事后冲突检测 |
| 路线服务 | `src/transport/services/smart-routes.service.ts` | 交通时间计算 |
| 距离计算 | `itinerary-items.service.ts#calculateHaversineDistance` | Haversine 公式 |

### B. 相关文档

- [Trip Conflicts DTO](../src/trips/dto/trip-conflicts.dto.ts)
- [Create Itinerary Item DTO](../src/itinerary-items/dto/create-itinerary-item.dto.ts)
- [Smart Routes Service](../src/transport/services/smart-routes.service.ts)

---

**审批签署**

| 角色 | 姓名 | 日期 | 签名 |
|------|------|------|------|
| 产品经理 | Danny | 2026-01-21 | ✍️ |
| 技术负责人 | - | - | - |
| 测试负责人 | - | - | - |
