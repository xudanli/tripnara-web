# é¢„ç®—åŠŸèƒ½æ¥å£éœ€æ±‚æ¸…å•

> ç”Ÿæˆæ—¶é—´: 2025-01-XX  
> è§’è‰²: äº§å“ç»ç†ï¼ˆDannyï¼‰  
> åˆ†æèŒƒå›´: TripNARA å†³ç­–å‹æ—…è¡Œåº”ç”¨çš„é¢„ç®—åŠŸèƒ½å®Œæ•´æ¥å£éœ€æ±‚

---

## ğŸ“‹ ç›®å½•

1. [æ¥å£æ¦‚è§ˆ](#æ¥å£æ¦‚è§ˆ)
2. [é¢„ç®—çº¦æŸç®¡ç†æ¥å£](#é¢„ç®—çº¦æŸç®¡ç†æ¥å£)
3. [é¢„ç®—æŸ¥è¯¢ä¸åˆ†ææ¥å£](#é¢„ç®—æŸ¥è¯¢ä¸åˆ†ææ¥å£)
4. [é¢„ç®—å†³ç­–é—¨æ§æ¥å£](#é¢„ç®—å†³ç­–é—¨æ§æ¥å£)
5. [é¢„ç®—ä¼˜åŒ–å»ºè®®æ¥å£](#é¢„ç®—ä¼˜åŒ–å»ºè®®æ¥å£)
6. [é¢„ç®—æ‰§è¡Œç›‘æ§æ¥å£](#é¢„ç®—æ‰§è¡Œç›‘æ§æ¥å£)
7. [é¢„ç®—ä¸è§„åˆ’å·¥ä½œå°é›†æˆæ¥å£](#é¢„ç®—ä¸è§„åˆ’å·¥ä½œå°é›†æˆæ¥å£)
8. [æ¥å£ä¼˜å…ˆçº§ä¸ä¾èµ–å…³ç³»](#æ¥å£ä¼˜å…ˆçº§ä¸ä¾èµ–å…³ç³»)
9. [æ•°æ®æ¨¡å‹ä¸å­—æ®µå®šä¹‰](#æ•°æ®æ¨¡å‹ä¸å­—æ®µå®šä¹‰)
10. [éªŒæ”¶æ ‡å‡†](#éªŒæ”¶æ ‡å‡†)

---

## æ¥å£æ¦‚è§ˆ

### æ¥å£åˆ†ç±»

é¢„ç®—åŠŸèƒ½æ¥å£æŒ‰ä½¿ç”¨åœºæ™¯åˆ†ä¸ºä»¥ä¸‹ 6 å¤§ç±»ï¼š

| åˆ†ç±» | æ¥å£æ•°é‡ | ä¼˜å…ˆçº§ | è¯´æ˜ |
|------|---------|--------|------|
| **é¢„ç®—çº¦æŸç®¡ç†** | 3 | P0 | è®¾ç½®ã€æ›´æ–°ã€åˆ é™¤é¢„ç®—çº¦æŸ |
| **é¢„ç®—æŸ¥è¯¢ä¸åˆ†æ** | 4 | P0 | æŸ¥è¯¢é¢„ç®—æ‘˜è¦ã€æ˜ç»†ã€è¶‹åŠ¿ |
| **é¢„ç®—å†³ç­–é—¨æ§** | 2 | P0 | Should-Exist Gate é¢„ç®—è¯„ä¼° |
| **é¢„ç®—ä¼˜åŒ–å»ºè®®** | 2 | P1 | è·å–ä¼˜åŒ–å»ºè®®ã€åº”ç”¨ä¼˜åŒ– |
| **é¢„ç®—æ‰§è¡Œç›‘æ§** | 3 | P1 | å®æ—¶ç›‘æ§ã€é¢„è­¦ã€æŠ¥å‘Š |
| **è§„åˆ’å·¥ä½œå°é›†æˆ** | 2 | P0 | è§„åˆ’é˜¶æ®µçš„é¢„ç®—çº¦æŸä¸è¯„ä¼° |

**æ€»è®¡**: 16 ä¸ªæ¥å£

### æ¥å£çŠ¶æ€

| çŠ¶æ€ | æ•°é‡ | è¯´æ˜ |
|------|------|------|
| âœ… **å·²å®ç°** | 4 | åŸºç¡€æŸ¥è¯¢æ¥å£å·²å®ç° |
| ğŸ”¨ **éœ€å®ç°** | 12 | çº¦æŸç®¡ç†ã€å†³ç­–é—¨æ§ã€ä¼˜åŒ–å»ºè®®ç­‰ |
| ğŸ“ **éœ€å®Œå–„** | 4 | ç°æœ‰æ¥å£éœ€å¢å¼ºåŠŸèƒ½ |

---

## é¢„ç®—çº¦æŸç®¡ç†æ¥å£

### 1. è®¾ç½®è¡Œç¨‹é¢„ç®—çº¦æŸ

**æ¥å£**: `POST /trips/:id/budget/constraint`

**åŠŸèƒ½**: ä¸ºè¡Œç¨‹è®¾ç½®æˆ–æ›´æ–°é¢„ç®—çº¦æŸï¼ˆæ€»é¢„ç®—ã€è´§å¸å•ä½ã€æ—¥å‡é¢„ç®—ç­‰ï¼‰

**è¯·æ±‚å‚æ•°**:
```typescript
interface SetBudgetConstraintRequest {
  total?: number;           // æ€»é¢„ç®—ï¼ˆå¿…å¡«ï¼Œå•ä½ï¼šCNYï¼‰
  currency?: string;        // è´§å¸å•ä½ï¼ˆé»˜è®¤ "CNY"ï¼‰
  dailyBudget?: number;     // æ—¥å‡é¢„ç®—ï¼ˆå¯é€‰ï¼Œè‡ªåŠ¨è®¡ç®—æˆ–æ‰‹åŠ¨è®¾ç½®ï¼‰
  categoryLimits?: {        // åˆ†ç±»é¢„ç®—é™åˆ¶ï¼ˆå¯é€‰ï¼‰
    accommodation?: number;
    transportation?: number;
    food?: number;
    activities?: number;
    other?: number;
  };
  alertThreshold?: number;  // é¢„è­¦é˜ˆå€¼ï¼ˆé»˜è®¤ 0.8ï¼Œå³ 80%ï¼‰
}
```

**å“åº”æ•°æ®**:
```typescript
interface SetBudgetConstraintResponse {
  tripId: string;
  budgetConstraint: BudgetConstraint;
  updatedAt: string;
}
```

**ä½¿ç”¨åœºæ™¯**:
- åˆ›å»ºè¡Œç¨‹æ—¶è®¾ç½®é¢„ç®—
- åœ¨è§„åˆ’å·¥ä½œå°è°ƒæ•´é¢„ç®—çº¦æŸ
- ç”¨æˆ·æ‰‹åŠ¨æ›´æ–°é¢„ç®—ä¸Šé™

**ç›¸å…³æ–‡ä»¶**:
- `src/api/planning-workbench.ts` - `BudgetConstraint` ç±»å‹å®šä¹‰
- `src/pages/plan-studio/IntentTab.tsx` - é¢„ç®—è®¾ç½® UI
- `src/types/trip.ts` - `BudgetConfig` ç±»å‹å®šä¹‰

**éªŒæ”¶æ ‡å‡†**:
- âœ… é¢„ç®—èŒƒå›´éªŒè¯ï¼š100 - 1,000,000 CNY
- âœ… è´§å¸å•ä½æ”¯æŒï¼šCNYã€USDã€EURã€JPY
- âœ… æ—¥å‡é¢„ç®—è‡ªåŠ¨è®¡ç®—ï¼š`totalBudget / days`
- âœ… åˆ†ç±»é¢„ç®—æ€»å’Œä¸è¶…è¿‡æ€»é¢„ç®—

---

### 2. è·å–é¢„ç®—çº¦æŸ

**æ¥å£**: `GET /trips/:id/budget/constraint`

**åŠŸèƒ½**: è·å–è¡Œç¨‹çš„é¢„ç®—çº¦æŸé…ç½®

**å“åº”æ•°æ®**:
```typescript
interface GetBudgetConstraintResponse {
  budgetConstraint: BudgetConstraint;
  createdAt: string;
  updatedAt: string;
}
```

**ä½¿ç”¨åœºæ™¯**:
- è§„åˆ’å·¥ä½œå°åŠ è½½é¢„ç®—çº¦æŸ
- é¢„ç®—é¡µé¢å±•ç¤ºå½“å‰çº¦æŸ
- é¢„ç®—ä¼˜åŒ–å»ºè®®è®¡ç®—

**éªŒæ”¶æ ‡å‡†**:
- âœ… è¿”å›å®Œæ•´çš„é¢„ç®—çº¦æŸé…ç½®
- âœ… åŒ…å«åˆ›å»ºå’Œæ›´æ–°æ—¶é—´

---

### 3. åˆ é™¤é¢„ç®—çº¦æŸ

**æ¥å£**: `DELETE /trips/:id/budget/constraint`

**åŠŸèƒ½**: åˆ é™¤è¡Œç¨‹çš„é¢„ç®—çº¦æŸï¼ˆæ¢å¤ä¸ºæ— é¢„ç®—é™åˆ¶ï¼‰

**å“åº”æ•°æ®**:
```typescript
interface DeleteBudgetConstraintResponse {
  tripId: string;
  deletedAt: string;
}
```

**ä½¿ç”¨åœºæ™¯**:
- ç”¨æˆ·å–æ¶ˆé¢„ç®—é™åˆ¶
- é‡ç½®é¢„ç®—é…ç½®

**éªŒæ”¶æ ‡å‡†**:
- âœ… æˆåŠŸåˆ é™¤åï¼Œåç»­è§„åˆ’ä¸å†å—é¢„ç®—é™åˆ¶
- âœ… å·²ç”Ÿæˆçš„é¢„ç®—æŠ¥å‘Šå’Œå†å²æ•°æ®ä¿ç•™

---

## é¢„ç®—æŸ¥è¯¢ä¸åˆ†ææ¥å£

### 4. è·å–é¢„ç®—æ‘˜è¦ âœ… **å·²å®ç°**

**æ¥å£**: `GET /trips/:id/budget/summary`

**åŠŸèƒ½**: è·å–è¡Œç¨‹çš„é¢„ç®—æ‘˜è¦ä¿¡æ¯ï¼ˆæ€»é¢„ç®—ã€å·²èŠ±è´¹ã€å‰©ä½™ã€åˆ†ç±»æ˜ç»†ã€è­¦å‘Šï¼‰

**å“åº”æ•°æ®**: `BudgetSummary`ï¼ˆå®šä¹‰åœ¨ `src/types/trip.ts`ï¼‰

**å½“å‰å®ç°**: `src/api/trips.ts` - `getBudgetSummary()`

**ä½¿ç”¨åœºæ™¯**:
- é¢„ç®—é¡µé¢å±•ç¤ºæ¦‚è§ˆ
- è§„åˆ’å·¥ä½œå°æ˜¾ç¤ºé¢„ç®—çŠ¶æ€
- Dashboard é¢„ç®—å¡ç‰‡

**éœ€å®Œå–„åŠŸèƒ½**:
- âš ï¸ æ”¯æŒæ—¶é—´èŒƒå›´æŸ¥è¯¢ï¼ˆ`?startDate=xxx&endDate=xxx`ï¼‰
- âš ï¸ æ”¯æŒåˆ†ç±»ç­›é€‰ï¼ˆ`?category=accommodation`ï¼‰

**éªŒæ”¶æ ‡å‡†**:
- âœ… è¿”å›å®Œæ•´çš„é¢„ç®—æ‘˜è¦
- âœ… åŒ…å«åˆ†ç±»æ˜ç»†å’Œè­¦å‘Šä¿¡æ¯
- âœ… æ”¯æŒæ—¶é—´èŒƒå›´å’Œåˆ†ç±»ç­›é€‰ï¼ˆéœ€å®ç°ï¼‰

---

### 5. è·å–é¢„ç®—æ˜ç»†

**æ¥å£**: `GET /trips/:id/budget/details`

**åŠŸèƒ½**: è·å–é¢„ç®—çš„è¯¦ç»†æ”¯å‡ºæ˜ç»†ï¼ˆæŒ‰æ—¥æœŸã€åˆ†ç±»ã€é¡¹ç›®ï¼‰

**è¯·æ±‚å‚æ•°**:
```typescript
interface GetBudgetDetailsParams {
  startDate?: string;      // å¼€å§‹æ—¥æœŸï¼ˆISO 8601ï¼‰
  endDate?: string;        // ç»“æŸæ—¥æœŸï¼ˆISO 8601ï¼‰
  category?: string;        // åˆ†ç±»ç­›é€‰ï¼ˆaccommodation/transportation/food/activities/otherï¼‰
  limit?: number;          // åˆ†é¡µé™åˆ¶ï¼ˆé»˜è®¤ 50ï¼‰
  offset?: number;         // åˆ†é¡µåç§»ï¼ˆé»˜è®¤ 0ï¼‰
}
```

**å“åº”æ•°æ®**:
```typescript
interface BudgetDetailsResponse {
  items: Array<{
    id: string;
    date: string;
    category: string;
    itemName: string;
    amount: number;
    currency: string;
    itineraryItemId?: string;  // å…³è”çš„è¡Œç¨‹é¡¹ ID
    evidenceRefs?: string[];    // è¯æ®å¼•ç”¨ï¼ˆä»·æ ¼æ¥æºï¼‰
  }>;
  total: number;
  limit: number;
  offset: number;
}
```

**ä½¿ç”¨åœºæ™¯**:
- é¢„ç®—é¡µé¢å±•ç¤ºè¯¦ç»†æ”¯å‡ºåˆ—è¡¨
- é¢„ç®—æŠ¥å‘Šç”Ÿæˆ
- é¢„ç®—ä¼˜åŒ–å»ºè®®è®¡ç®—

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ”¯æŒæŒ‰æ—¥æœŸèŒƒå›´æŸ¥è¯¢
- âœ… æ”¯æŒæŒ‰åˆ†ç±»ç­›é€‰
- âœ… æ”¯æŒåˆ†é¡µ
- âœ… å…³è”è¡Œç¨‹é¡¹å’Œè¯æ®å¼•ç”¨

---

### 6. è·å–é¢„ç®—è¶‹åŠ¿

**æ¥å£**: `GET /trips/:id/budget/trends`

**åŠŸèƒ½**: è·å–é¢„ç®—æ‰§è¡Œè¶‹åŠ¿ï¼ˆæ¯æ—¥æ”¯å‡ºè¶‹åŠ¿ã€åˆ†ç±»åˆ†å¸ƒè¶‹åŠ¿ï¼‰

**è¯·æ±‚å‚æ•°**:
```typescript
interface GetBudgetTrendsParams {
  startDate?: string;
  endDate?: string;
  granularity?: 'daily' | 'weekly' | 'monthly';  // ç²’åº¦ï¼ˆé»˜è®¤ 'daily'ï¼‰
}
```

**å“åº”æ•°æ®**:
```typescript
interface BudgetTrendsResponse {
  dailySpending: Array<{
    date: string;
    budget: number;
    spent: number;
    ratio: number;  // spent / budget
  }>;
  categoryDistribution: {
    accommodation: number;
    transportation: number;
    food: number;
    activities: number;
    other: number;
  };
  forecast?: {      // é¢„ç®—é¢„æµ‹ï¼ˆå¯é€‰ï¼‰
    projectedTotal: number;
    projectedRemaining: number;
    confidence: number;  // 0-1
  };
}
```

**ä½¿ç”¨åœºæ™¯**:
- é¢„ç®—æŠ¥å‘Šå›¾è¡¨å±•ç¤º
- é¢„ç®—é¢„æµ‹åˆ†æ
- Dashboard è¶‹åŠ¿å¯è§†åŒ–

**éªŒæ”¶æ ‡å‡†**:
- âœ… è¿”å›æ¯æ—¥/æ¯å‘¨/æ¯æœˆè¶‹åŠ¿æ•°æ®
- âœ… åŒ…å«åˆ†ç±»åˆ†å¸ƒ
- âœ… æ”¯æŒé¢„ç®—é¢„æµ‹ï¼ˆåŸºäºå†å²è¶‹åŠ¿ï¼‰

---

### 7. è·å–é¢„ç®—æŠ¥å‘Š âœ… **å·²å®ç°**

**æ¥å£**: `GET /trips/:id/budget/report`

**åŠŸèƒ½**: ç”Ÿæˆå®Œæ•´çš„é¢„ç®—æ‰§è¡Œåˆ†ææŠ¥å‘Š

**å“åº”æ•°æ®**: `BudgetReport`ï¼ˆå®šä¹‰åœ¨ `src/types/trip.ts`ï¼‰

**å½“å‰å®ç°**: `src/api/trips.ts` - `getBudgetReport()`

**ä½¿ç”¨åœºæ™¯**:
- é¢„ç®—é¡µé¢å®Œæ•´æŠ¥å‘Šå±•ç¤º
- è¡Œç¨‹ç»“æŸåé¢„ç®—æ€»ç»“
- å¯¼å‡ºé¢„ç®—æŠ¥å‘Š

**éªŒæ”¶æ ‡å‡†**:
- âœ… åŒ…å«æ‘˜è¦ã€è¶‹åŠ¿ã€å»ºè®®
- âœ… æ”¯æŒ PDF/Excel å¯¼å‡ºï¼ˆéœ€å®ç°ï¼‰

---

## é¢„ç®—å†³ç­–é—¨æ§æ¥å£

### 8. é¢„ç®—åˆç†æ€§è¯„ä¼°ï¼ˆShould-Exist Gateï¼‰

**æ¥å£**: `POST /planning-workbench/budget/evaluate`

**åŠŸèƒ½**: è¯„ä¼°è§„åˆ’æ–¹æ¡ˆçš„é¢„ç®—åˆç†æ€§ï¼ˆShould-Exist Gate çš„ä¸€éƒ¨åˆ†ï¼‰

**è¯·æ±‚å‚æ•°**:
```typescript
interface EvaluateBudgetRequest {
  planId: string;
  tripId: string;
  estimatedCost: number;      // é¢„ä¼°æ€»æˆæœ¬
  categoryBreakdown: {         // åˆ†ç±»æˆæœ¬æ˜ç»†
    accommodation: number;
    transportation: number;
    food: number;
    activities: number;
    other: number;
  };
  budgetConstraint: BudgetConstraint;  // é¢„ç®—çº¦æŸ
}
```

**å“åº”æ•°æ®**:
```typescript
interface BudgetEvaluationResponse {
  verdict: 'ALLOW' | 'NEED_ADJUST' | 'REJECT';  // è¯„ä¼°ç»“æœ
  reason: string;                                // è¯„ä¼°åŸå› 
  confidence: number;                            // ç½®ä¿¡åº¦ï¼ˆ0-1ï¼‰
  violations?: Array<{                          // è¿è§„é¡¹ï¼ˆå¦‚æœ‰ï¼‰
    category: string;
    exceeded: number;  // è¶…å‡ºé‡‘é¢
    percentage: number;  // è¶…å‡ºç™¾åˆ†æ¯”
  }>;
  recommendations?: Array<{                     // è°ƒæ•´å»ºè®®
    action: string;
    impact: string;
    estimatedSavings: number;
  }>;
  evidenceRefs?: string[];                     // è¯æ®å¼•ç”¨
}
```

**ä½¿ç”¨åœºæ™¯**:
- è§„åˆ’å·¥ä½œå°ç”Ÿæˆæ–¹æ¡ˆåè¯„ä¼°é¢„ç®—
- Should-Exist Gate æµç¨‹ä¸­çš„é¢„ç®—é—¨æ§
- ä¸‰äººæ ¼è¯„ä¼°ï¼ˆAbuï¼‰çš„é¢„ç®—ç»´åº¦

**ç›¸å…³æ–‡ä»¶**:
- `src/api/planning-workbench.ts` - `ExecutePlanningWorkbenchRequest`
- `src/api/agent.ts` - `GateResult`ï¼ˆä¸‰äººæ ¼è¯„ä¼°ç»“æœï¼‰

**éªŒæ”¶æ ‡å‡†**:
- âœ… è¯„ä¼°ç»“æœï¼šALLOWï¼ˆé¢„ç®—å……è¶³ï¼‰ã€NEED_ADJUSTï¼ˆéœ€è°ƒæ•´ï¼‰ã€REJECTï¼ˆä¸¥é‡è¶…æ”¯ï¼‰
- âœ… æä¾›è¯¦ç»†çš„è¿è§„é¡¹å’Œå»ºè®®
- âœ… å…³è”è¯æ®å¼•ç”¨ï¼ˆä»·æ ¼æ¥æºï¼‰

---

### 9. é¢„ç®—é—¨æ§å†³ç­–æ—¥å¿—

**æ¥å£**: `GET /planning-workbench/budget/decision-log`

**åŠŸèƒ½**: è·å–é¢„ç®—è¯„ä¼°çš„å†³ç­–æ—¥å¿—ï¼ˆç”¨äºå¯è§£é‡Šæ€§ï¼‰

**è¯·æ±‚å‚æ•°**:
```typescript
interface GetBudgetDecisionLogParams {
  planId: string;
  tripId: string;
  limit?: number;
  offset?: number;
}
```

**å“åº”æ•°æ®**:
```typescript
interface BudgetDecisionLogResponse {
  items: Array<{
    id: string;
    timestamp: string;
    planId: string;
    verdict: 'ALLOW' | 'NEED_ADJUST' | 'REJECT';
    estimatedCost: number;
    budgetConstraint: BudgetConstraint;
    reason: string;
    evidenceRefs: string[];
    persona?: 'ABU';  // é¢„ç®—è¯„ä¼°å±äº Abu çš„èŒè´£
  }>;
  total: number;
}
```

**ä½¿ç”¨åœºæ™¯**:
- è§„åˆ’å·¥ä½œå°å±•ç¤ºé¢„ç®—å†³ç­–è¿‡ç¨‹
- ä¸‰äººæ ¼å†³ç­–æ—¥å¿—ï¼ˆAbuï¼‰
- ç”¨æˆ·ç†è§£é¢„ç®—è¯„ä¼°åŸå› 

**éªŒæ”¶æ ‡å‡†**:
- âœ… è®°å½•æ¯æ¬¡é¢„ç®—è¯„ä¼°çš„å®Œæ•´ä¿¡æ¯
- âœ… å…³è”ä¸‰äººæ ¼ï¼ˆAbuï¼‰
- âœ… åŒ…å«è¯æ®å¼•ç”¨

---

## é¢„ç®—ä¼˜åŒ–å»ºè®®æ¥å£

### 10. è·å–é¢„ç®—ä¼˜åŒ–å»ºè®® âœ… **å·²å®ç°**

**æ¥å£**: `GET /trips/:id/budget/optimization`

**åŠŸèƒ½**: è·å–é¢„ç®—ä¼˜åŒ–å»ºè®®ï¼ˆæ›¿æ¢æ›´ä¾¿å®œçš„é€‰é¡¹ã€è°ƒæ•´è¡Œç¨‹ç­‰ï¼‰

**è¯·æ±‚å‚æ•°**:
```typescript
interface GetBudgetOptimizationParams {
  category?: string;  // åˆ†ç±»ç­›é€‰ï¼ˆå¯é€‰ï¼‰
  maxSuggestions?: number;  // æœ€å¤§å»ºè®®æ•°ï¼ˆé»˜è®¤ 10ï¼‰
}
```

**å“åº”æ•°æ®**: `BudgetOptimizationSuggestion[]`ï¼ˆå®šä¹‰åœ¨ `src/types/trip.ts`ï¼‰

**å½“å‰å®ç°**: `src/api/trips.ts` - `getBudgetOptimization()`

**ä½¿ç”¨åœºæ™¯**:
- é¢„ç®—é¡µé¢å±•ç¤ºä¼˜åŒ–å»ºè®®
- è§„åˆ’å·¥ä½œå°è‡ªåŠ¨ä¿®å¤é¢„ç®—è¶…æ”¯
- ç”¨æˆ·ä¸»åŠ¨å¯»æ±‚ä¼˜åŒ–æ–¹æ¡ˆ

**éœ€å®Œå–„åŠŸèƒ½**:
- âš ï¸ æ”¯æŒæŒ‰åˆ†ç±»ç­›é€‰
- âš ï¸ æ”¯æŒæŒ‰èŠ‚çœé‡‘é¢æ’åº

**éªŒæ”¶æ ‡å‡†**:
- âœ… è¿”å›å¯è¡Œçš„ä¼˜åŒ–å»ºè®®
- âœ… åŒ…å«é¢„ä¼°èŠ‚çœé‡‘é¢
- âœ… æ”¯æŒåˆ†ç±»ç­›é€‰å’Œæ’åºï¼ˆéœ€å®ç°ï¼‰

---

### 11. åº”ç”¨é¢„ç®—ä¼˜åŒ–å»ºè®®

**æ¥å£**: `POST /planning-workbench/budget/apply-optimization`

**åŠŸèƒ½**: åº”ç”¨é¢„ç®—ä¼˜åŒ–å»ºè®®ï¼ˆè‡ªåŠ¨è°ƒæ•´è¡Œç¨‹é¡¹ï¼‰

**è¯·æ±‚å‚æ•°**:
```typescript
interface ApplyBudgetOptimizationRequest {
  planId: string;
  tripId: string;
  optimizationIds: string[];  // è¦åº”ç”¨çš„ä¼˜åŒ–å»ºè®® ID åˆ—è¡¨
  autoCommit?: boolean;        // æ˜¯å¦è‡ªåŠ¨æäº¤ï¼ˆé»˜è®¤ falseï¼‰
}
```

**å“åº”æ•°æ®**:
```typescript
interface ApplyBudgetOptimizationResponse {
  planId: string;
  newPlanId?: string;  // å¦‚æœç”Ÿæˆäº†æ–°æ–¹æ¡ˆ
  appliedOptimizations: Array<{
    id: string;
    type: string;
    estimatedSavings: number;
    status: 'success' | 'failed';
    reason?: string;
  }>;
  totalSavings: number;
  newEstimatedCost: number;
}
```

**ä½¿ç”¨åœºæ™¯**:
- è§„åˆ’å·¥ä½œå°è‡ªåŠ¨ä¿®å¤é¢„ç®—è¶…æ”¯
- ç”¨æˆ·æ‰‹åŠ¨åº”ç”¨ä¼˜åŒ–å»ºè®®
- REPAIR é˜¶æ®µçš„é¢„ç®—ä¿®å¤

**éªŒæ”¶æ ‡å‡†**:
- âœ… æˆåŠŸåº”ç”¨ä¼˜åŒ–å»ºè®®
- âœ… è¿”å›æ–°çš„é¢„ä¼°æˆæœ¬å’ŒèŠ‚çœé‡‘é¢
- âœ… æ”¯æŒæ‰¹é‡åº”ç”¨

---

## é¢„ç®—æ‰§è¡Œç›‘æ§æ¥å£

### 12. æ£€æŸ¥é¢„ç®—é¢„è­¦ âœ… **å·²å®ç°**

**æ¥å£**: `GET /trips/:id/budget/alert`

**åŠŸèƒ½**: æ£€æŸ¥æŒ‡å®šæˆæœ¬æ˜¯å¦è§¦å‘é¢„ç®—é¢„è­¦

**è¯·æ±‚å‚æ•°**:
```typescript
interface CheckBudgetAlertParams {
  cost: number;  // è¦æ£€æŸ¥çš„æˆæœ¬
  category?: string;  // åˆ†ç±»ï¼ˆå¯é€‰ï¼‰
}
```

**å“åº”æ•°æ®**: `BudgetAlert | null`ï¼ˆå®šä¹‰åœ¨ `src/types/trip.ts`ï¼‰

**å½“å‰å®ç°**: `src/api/trips.ts` - `checkBudgetAlert()`

**ä½¿ç”¨åœºæ™¯**:
- æ·»åŠ è¡Œç¨‹é¡¹æ—¶å®æ—¶æ£€æŸ¥
- è§„åˆ’å·¥ä½œå°ç”Ÿæˆæ–¹æ¡ˆæ—¶æ£€æŸ¥
- é¢„ç®—é¡µé¢å®æ—¶ç›‘æ§

**éªŒæ”¶æ ‡å‡†**:
- âœ… è§¦å‘æ¡ä»¶ï¼šè¶…å‡ºé¢„ç®— 80%ï¼ˆwarningï¼‰æˆ– 100%ï¼ˆerrorï¼‰
- âœ… è¿”å›é¢„è­¦ç±»å‹å’Œå»ºè®®

---

### 13. å®æ—¶é¢„ç®—ç›‘æ§

**æ¥å£**: `GET /trips/:id/budget/monitor`

**åŠŸèƒ½**: è·å–å®æ—¶é¢„ç®—ç›‘æ§æ•°æ®ï¼ˆWebSocket æˆ–è½®è¯¢ï¼‰

**è¯·æ±‚å‚æ•°**:
```typescript
interface GetBudgetMonitorParams {
  realtime?: boolean;  // æ˜¯å¦å¯ç”¨å®æ—¶æ¨é€ï¼ˆWebSocketï¼‰
}
```

**å“åº”æ•°æ®**:
```typescript
interface BudgetMonitorResponse {
  currentSpent: number;
  remaining: number;
  dailySpent: Record<string, number>;
  alerts: BudgetAlert[];
  lastUpdated: string;
}
```

**ä½¿ç”¨åœºæ™¯**:
- Dashboard å®æ—¶é¢„ç®—å¡ç‰‡
- é¢„ç®—é¡µé¢å®æ—¶æ›´æ–°
- ç§»åŠ¨ç«¯æ¨é€é€šçŸ¥

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ”¯æŒ WebSocket å®æ—¶æ¨é€
- âœ… æ”¯æŒè½®è¯¢æ¨¡å¼
- âœ… åŒ…å«å®æ—¶é¢„è­¦ä¿¡æ¯

---

### 14. é¢„ç®—æ‰§è¡Œç»Ÿè®¡

**æ¥å£**: `GET /trips/:id/budget/statistics`

**åŠŸèƒ½**: è·å–é¢„ç®—æ‰§è¡Œçš„ç»Ÿè®¡ä¿¡æ¯ï¼ˆå®Œæˆåº¦ã€è¶…æ”¯ç‡ã€åˆ†ç±»å æ¯”ç­‰ï¼‰

**å“åº”æ•°æ®**:
```typescript
interface BudgetStatisticsResponse {
  completionRate: number;      // å®Œæˆåº¦ï¼ˆ0-1ï¼‰
  overspendRate: number;       // è¶…æ”¯ç‡ï¼ˆè´Ÿæ•°è¡¨ç¤ºèŠ‚çœï¼‰
  categoryPercentages: {       // åˆ†ç±»å æ¯”
    accommodation: number;
    transportation: number;
    food: number;
    activities: number;
    other: number;
  };
  dailyAverage: number;        // æ—¥å‡æ”¯å‡º
  projectedCompletion: string;  // é¢„è®¡å®Œæˆæ—¥æœŸ
  riskLevel: 'low' | 'medium' | 'high';  // é£é™©ç­‰çº§
}
```

**ä½¿ç”¨åœºæ™¯**:
- Dashboard é¢„ç®—ç»Ÿè®¡å¡ç‰‡
- é¢„ç®—æŠ¥å‘Šç»Ÿè®¡éƒ¨åˆ†
- é¢„ç®—è¶‹åŠ¿åˆ†æ

**éªŒæ”¶æ ‡å‡†**:
- âœ… è¿”å›å®Œæ•´çš„ç»Ÿè®¡ä¿¡æ¯
- âœ… åŒ…å«é£é™©ç­‰çº§è¯„ä¼°

---

## é¢„ç®—ä¸è§„åˆ’å·¥ä½œå°é›†æˆæ¥å£

### 15. è§„åˆ’å·¥ä½œå°é¢„ç®—çº¦æŸè®¾ç½®

**æ¥å£**: `POST /planning-workbench/execute`ï¼ˆå·²å®ç°ï¼Œéœ€å¢å¼ºé¢„ç®—çº¦æŸï¼‰

**åŠŸèƒ½**: åœ¨è§„åˆ’å·¥ä½œå°æ‰§è¡Œæµç¨‹ä¸­è®¾ç½®é¢„ç®—çº¦æŸ

**å½“å‰å®ç°**: `src/api/planning-workbench.ts` - `execute()`

**è¯·æ±‚å‚æ•°å¢å¼º**:
```typescript
interface ExecutePlanningWorkbenchRequest {
  context: PlanningContext;
  context.constraints.budget: BudgetConstraint;  // é¢„ç®—çº¦æŸ
  // ... å…¶ä»–å­—æ®µ
}
```

**ä½¿ç”¨åœºæ™¯**:
- è§„åˆ’å·¥ä½œå°ç”Ÿæˆæ–¹æ¡ˆæ—¶åº”ç”¨é¢„ç®—çº¦æŸ
- ç”¨æˆ·è°ƒæ•´é¢„ç®—åé‡æ–°ç”Ÿæˆæ–¹æ¡ˆ
- é¢„ç®—çº¦æŸä½œä¸º Should-Exist Gate çš„ä¸€éƒ¨åˆ†

**éªŒæ”¶æ ‡å‡†**:
- âœ… é¢„ç®—çº¦æŸæ­£ç¡®ä¼ é€’åˆ°è§„åˆ’æµç¨‹
- âœ… ç”Ÿæˆçš„æ–¹æ¡ˆç¬¦åˆé¢„ç®—çº¦æŸ
- âœ… é¢„ç®—è¯„ä¼°ç»“æœåŒ…å«åœ¨ä¸‰äººæ ¼è¯„ä¼°ä¸­

---

### 16. è§„åˆ’å·¥ä½œå°é¢„ç®—è¯„ä¼°ç»“æœ

**æ¥å£**: `GET /planning-workbench/plans/:planId/budget-evaluation`

**åŠŸèƒ½**: è·å–è§„åˆ’æ–¹æ¡ˆçš„é¢„ç®—è¯„ä¼°ç»“æœ

**å“åº”æ•°æ®**:
```typescript
interface PlanBudgetEvaluationResponse {
  planId: string;
  budgetEvaluation: BudgetEvaluationResponse;  // è§æ¥å£ 8
  personaOutput?: {  // ä¸‰äººæ ¼è¾“å‡ºï¼ˆAbuï¼‰
    persona: 'ABU';
    verdict: 'ALLOW' | 'NEED_CONFIRM' | 'REJECT';
    explanation: string;
    evidence: EvidenceItem[];
  };
}
```

**ä½¿ç”¨åœºæ™¯**:
- è§„åˆ’å·¥ä½œå°å±•ç¤ºæ–¹æ¡ˆçš„é¢„ç®—è¯„ä¼°
- æ–¹æ¡ˆå¯¹æ¯”æ—¶æ˜¾ç¤ºé¢„ç®—ç»´åº¦
- ä¸‰äººæ ¼å¡ç‰‡ï¼ˆAbuï¼‰å±•ç¤ºé¢„ç®—è¯„ä¼°

**éªŒæ”¶æ ‡å‡†**:
- âœ… è¿”å›å®Œæ•´çš„é¢„ç®—è¯„ä¼°ç»“æœ
- âœ… å…³è”ä¸‰äººæ ¼è¾“å‡ºï¼ˆAbuï¼‰
- âœ… åŒ…å«è¯æ®å’Œè§£é‡Š

---

## æ¥å£ä¼˜å…ˆçº§ä¸ä¾èµ–å…³ç³»

### ä¼˜å…ˆçº§å®šä¹‰

- **P0ï¼ˆå¿…é¡»ï¼‰**: æ ¸å¿ƒåŠŸèƒ½ï¼Œå½±å“ä¸»æµç¨‹
- **P1ï¼ˆé‡è¦ï¼‰**: å¢å¼ºåŠŸèƒ½ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
- **P2ï¼ˆå¯é€‰ï¼‰**: é”¦ä¸Šæ·»èŠ±ï¼Œå¯åç»­è¿­ä»£

### ä¼˜å…ˆçº§åˆ†é…

| æ¥å£ç¼–å· | æ¥å£åç§° | ä¼˜å…ˆçº§ | ä¾èµ–å…³ç³» |
|---------|---------|--------|---------|
| 1 | è®¾ç½®é¢„ç®—çº¦æŸ | P0 | - |
| 2 | è·å–é¢„ç®—çº¦æŸ | P0 | - |
| 4 | è·å–é¢„ç®—æ‘˜è¦ | P0 | âœ… å·²å®ç° |
| 8 | é¢„ç®—åˆç†æ€§è¯„ä¼° | P0 | ä¾èµ–æ¥å£ 1ã€2 |
| 15 | è§„åˆ’å·¥ä½œå°é¢„ç®—çº¦æŸ | P0 | âœ… å·²å®ç°ï¼ˆéœ€å¢å¼ºï¼‰ |
| 16 | è§„åˆ’å·¥ä½œå°é¢„ç®—è¯„ä¼° | P0 | ä¾èµ–æ¥å£ 8 |
| 3 | åˆ é™¤é¢„ç®—çº¦æŸ | P1 | ä¾èµ–æ¥å£ 1 |
| 5 | è·å–é¢„ç®—æ˜ç»† | P1 | ä¾èµ–æ¥å£ 4 |
| 6 | è·å–é¢„ç®—è¶‹åŠ¿ | P1 | ä¾èµ–æ¥å£ 4 |
| 7 | è·å–é¢„ç®—æŠ¥å‘Š | P1 | âœ… å·²å®ç° |
| 9 | é¢„ç®—å†³ç­–æ—¥å¿— | P1 | ä¾èµ–æ¥å£ 8 |
| 10 | è·å–ä¼˜åŒ–å»ºè®® | P1 | âœ… å·²å®ç° |
| 11 | åº”ç”¨ä¼˜åŒ–å»ºè®® | P1 | ä¾èµ–æ¥å£ 10 |
| 12 | æ£€æŸ¥é¢„ç®—é¢„è­¦ | P1 | âœ… å·²å®ç° |
| 13 | å®æ—¶é¢„ç®—ç›‘æ§ | P2 | ä¾èµ–æ¥å£ 4 |
| 14 | é¢„ç®—æ‰§è¡Œç»Ÿè®¡ | P2 | ä¾èµ–æ¥å£ 4 |

### å®ç°é¡ºåºå»ºè®®

**Phase 1ï¼ˆMVPï¼‰**:
1. æ¥å£ 1ã€2ï¼šé¢„ç®—çº¦æŸç®¡ç†
2. æ¥å£ 8ï¼šé¢„ç®—åˆç†æ€§è¯„ä¼°ï¼ˆShould-Exist Gateï¼‰
3. æ¥å£ 15ã€16ï¼šè§„åˆ’å·¥ä½œå°é›†æˆ

**Phase 2ï¼ˆå¢å¼ºï¼‰**:
4. æ¥å£ 5ã€6ï¼šé¢„ç®—æ˜ç»†å’Œè¶‹åŠ¿
5. æ¥å£ 9ï¼šé¢„ç®—å†³ç­–æ—¥å¿—
6. æ¥å£ 11ï¼šåº”ç”¨ä¼˜åŒ–å»ºè®®

**Phase 3ï¼ˆå®Œå–„ï¼‰**:
7. æ¥å£ 3ï¼šåˆ é™¤é¢„ç®—çº¦æŸ
8. æ¥å£ 13ã€14ï¼šå®æ—¶ç›‘æ§å’Œç»Ÿè®¡

---

## æ•°æ®æ¨¡å‹ä¸å­—æ®µå®šä¹‰

### BudgetConstraintï¼ˆé¢„ç®—çº¦æŸï¼‰

**å®šä¹‰ä½ç½®**: `src/api/planning-workbench.ts`

```typescript
interface BudgetConstraint {
  total?: number;      // æ€»é¢„ç®—ï¼ˆå¿…å¡«ï¼Œå•ä½ï¼šCNYï¼‰
  currency?: string;   // è´§å¸å•ä½ï¼ˆé»˜è®¤ "CNY"ï¼‰
}
```

**æ‰©å±•å»ºè®®**:
```typescript
interface BudgetConstraint {
  total: number;                    // æ€»é¢„ç®—ï¼ˆå¿…å¡«ï¼‰
  currency: string;                 // è´§å¸å•ä½ï¼ˆé»˜è®¤ "CNY"ï¼‰
  dailyBudget?: number;             // æ—¥å‡é¢„ç®—ï¼ˆå¯é€‰ï¼‰
  categoryLimits?: {                // åˆ†ç±»é¢„ç®—é™åˆ¶ï¼ˆå¯é€‰ï¼‰
    accommodation?: number;
    transportation?: number;
    food?: number;
    activities?: number;
    other?: number;
  };
  alertThreshold?: number;          // é¢„è­¦é˜ˆå€¼ï¼ˆé»˜è®¤ 0.8ï¼‰
  createdAt?: string;               // åˆ›å»ºæ—¶é—´
  updatedAt?: string;               // æ›´æ–°æ—¶é—´
}
```

### BudgetSummaryï¼ˆé¢„ç®—æ‘˜è¦ï¼‰

**å®šä¹‰ä½ç½®**: `src/types/trip.ts`

**å½“å‰å®šä¹‰**: âœ… å·²å®Œæ•´

### BudgetEvaluationResponseï¼ˆé¢„ç®—è¯„ä¼°å“åº”ï¼‰

**æ–°å¢ç±»å‹å®šä¹‰**:
```typescript
interface BudgetEvaluationResponse {
  verdict: 'ALLOW' | 'NEED_ADJUST' | 'REJECT';
  reason: string;
  confidence: number;
  violations?: Array<{
    category: string;
    exceeded: number;
    percentage: number;
  }>;
  recommendations?: Array<{
    action: string;
    impact: string;
    estimatedSavings: number;
  }>;
  evidenceRefs?: string[];
}
```

---

## éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

1. **é¢„ç®—çº¦æŸç®¡ç†**
   - âœ… å¯ä»¥è®¾ç½®ã€è·å–ã€åˆ é™¤é¢„ç®—çº¦æŸ
   - âœ… é¢„ç®—èŒƒå›´éªŒè¯ï¼š100 - 1,000,000 CNY
   - âœ… æ”¯æŒå¤šç§è´§å¸å•ä½

2. **é¢„ç®—æŸ¥è¯¢ä¸åˆ†æ**
   - âœ… å¯ä»¥æŸ¥è¯¢é¢„ç®—æ‘˜è¦ã€æ˜ç»†ã€è¶‹åŠ¿ã€æŠ¥å‘Š
   - âœ… æ”¯æŒæ—¶é—´èŒƒå›´å’Œåˆ†ç±»ç­›é€‰
   - âœ… æ•°æ®å‡†ç¡®æ— è¯¯

3. **é¢„ç®—å†³ç­–é—¨æ§**
   - âœ… é¢„ç®—è¯„ä¼°ç»“æœå‡†ç¡®ï¼ˆALLOW/NEED_ADJUST/REJECTï¼‰
   - âœ… æä¾›è¯¦ç»†çš„è¿è§„é¡¹å’Œå»ºè®®
   - âœ… å…³è”è¯æ®å¼•ç”¨å’Œå†³ç­–æ—¥å¿—

4. **é¢„ç®—ä¼˜åŒ–å»ºè®®**
   - âœ… å¯ä»¥è·å–å’Œåº”ç”¨ä¼˜åŒ–å»ºè®®
   - âœ… ä¼˜åŒ–å»ºè®®å¯è¡Œä¸”æœ‰æ•ˆ
   - âœ… é¢„ä¼°èŠ‚çœé‡‘é¢å‡†ç¡®

5. **é¢„ç®—æ‰§è¡Œç›‘æ§**
   - âœ… å®æ—¶ç›‘æ§é¢„ç®—æ‰§è¡Œæƒ…å†µ
   - âœ… é¢„è­¦æœºåˆ¶æ­£å¸¸å·¥ä½œ
   - âœ… ç»Ÿè®¡ä¿¡æ¯å‡†ç¡®

6. **è§„åˆ’å·¥ä½œå°é›†æˆ**
   - âœ… é¢„ç®—çº¦æŸæ­£ç¡®ä¼ é€’åˆ°è§„åˆ’æµç¨‹
   - âœ… ç”Ÿæˆçš„æ–¹æ¡ˆç¬¦åˆé¢„ç®—çº¦æŸ
   - âœ… é¢„ç®—è¯„ä¼°ç»“æœåŒ…å«åœ¨ä¸‰äººæ ¼è¯„ä¼°ä¸­

### æ€§èƒ½éªŒæ”¶

- âœ… é¢„ç®—æŸ¥è¯¢æ¥å£å“åº”æ—¶é—´ < 200ms
- âœ… é¢„ç®—è¯„ä¼°æ¥å£å“åº”æ—¶é—´ < 500ms
- âœ… æ”¯æŒå¹¶å‘è¯·æ±‚ï¼ˆ100+ QPSï¼‰

### å®‰å…¨éªŒæ”¶

- âœ… é¢„ç®—æ•°æ®æƒé™æ§åˆ¶ï¼ˆä»…è¡Œç¨‹åˆ›å»ºè€…å¯ä¿®æ”¹ï¼‰
- âœ… é¢„ç®—æ•°æ®è„±æ•ï¼ˆæ•æ„Ÿä¿¡æ¯ä¸æ³„éœ²ï¼‰
- âœ… è¾“å…¥éªŒè¯ï¼ˆé˜²æ­¢ SQL æ³¨å…¥ã€XSS ç­‰ï¼‰

### å…¼å®¹æ€§éªŒæ”¶

- âœ… å‘åå…¼å®¹ç°æœ‰æ¥å£
- âœ… ç±»å‹å®šä¹‰ä¸å‰ç«¯ä¸€è‡´
- âœ… é”™è¯¯å¤„ç†å‹å¥½

---

## ç›¸å…³æ–‡ä»¶å¼•ç”¨

### ç±»å‹å®šä¹‰
- `src/api/planning-workbench.ts` - `BudgetConstraint`ã€`Constraints`
- `src/types/trip.ts` - `BudgetConfig`ã€`BudgetSummary`ã€`BudgetAlert`ã€`BudgetOptimizationSuggestion`ã€`BudgetReport`

### API å®ç°
- `src/api/trips.ts` - é¢„ç®—æŸ¥è¯¢æ¥å£ï¼ˆå·²å®ç°ï¼‰
- `src/api/planning-workbench.ts` - è§„åˆ’å·¥ä½œå°æ¥å£ï¼ˆéœ€å¢å¼ºï¼‰

### å‰ç«¯ç»„ä»¶
- `src/pages/trips/budget.tsx` - é¢„ç®—é¡µé¢
- `src/pages/plan-studio/IntentTab.tsx` - é¢„ç®—è®¾ç½® UI
- `src/pages/plan-studio/PlanningWorkbenchTab.tsx` - è§„åˆ’å·¥ä½œå°é¢„ç®—å±•ç¤º

### æ–‡æ¡£
- `docs/è§„åˆ’å·¥ä½œå°æ¥å£éœ€æ±‚åˆ†æ.md` - è§„åˆ’å·¥ä½œå°æ¥å£åˆ†æ
- `docs/API-æ¥å£å¯¹æ¥æƒ…å†µ.md` - API å¯¹æ¥æƒ…å†µ

---

## å¾…ç¡®è®¤é—®é¢˜

1. **é¢„ç®—è´§å¸å•ä½æ”¯æŒèŒƒå›´**
   - å½“å‰å‡è®¾ï¼šCNYã€USDã€EURã€JPY
   - å¾…ç¡®è®¤ï¼šæ˜¯å¦éœ€è¦æ”¯æŒæ›´å¤šè´§å¸ï¼Ÿ

2. **é¢„ç®—é¢„è­¦é˜ˆå€¼**
   - å½“å‰å‡è®¾ï¼š80%ï¼ˆwarningï¼‰ã€100%ï¼ˆerrorï¼‰
   - å¾…ç¡®è®¤ï¼šé˜ˆå€¼æ˜¯å¦å¯é…ç½®ï¼Ÿ

3. **é¢„ç®—ä¼˜åŒ–å»ºè®®çš„è‡ªåŠ¨åº”ç”¨**
   - å½“å‰å‡è®¾ï¼šç”¨æˆ·æ‰‹åŠ¨åº”ç”¨
   - å¾…ç¡®è®¤ï¼šæ˜¯å¦æ”¯æŒè‡ªåŠ¨åº”ç”¨ï¼ˆREPAIR é˜¶æ®µï¼‰ï¼Ÿ

4. **é¢„ç®—å†³ç­–æ—¥å¿—çš„ä¿ç•™æœŸé™**
   - å½“å‰å‡è®¾ï¼šæ°¸ä¹…ä¿ç•™
   - å¾…ç¡®è®¤ï¼šæ˜¯å¦éœ€è¦è®¾ç½®ä¿ç•™æœŸé™ï¼Ÿ

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-01-XX  
**ç»´æŠ¤è€…**: äº§å“ç»ç†ï¼ˆDannyï¼‰
