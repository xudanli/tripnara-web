# 用户端优化系统 V2 产品需求文档 (PRD)

**文档类型**: 产品需求文档  
**版本**: 1.0.0  
**编制**: 产品团队  
**依据**: 用户端 API 接口文档 (`/api/v2/user/*`)  
**最后更新**: 2026-02-15  
**交互原则**：遵循 `tripnara-interaction-philosophy-prd.md`（单决策、AI 主导、渐进揭示）

---

## 1. 文档目的

本 PRD 基于用户端 API 接口能力，定义前端产品的功能范围、用户价值、优先级及验收标准，为设计研发提供产品依据。

---

## 2. 产品目标与用户价值

### 2.1 产品目标

- 让用户在规划行程时，**看得懂**计划的优劣、风险与可改进空间。
- 支持**多人协作**场景（家庭、朋友、探险队等），通过协商达成共识。
- 在执行行程中，**实时感知**天气、路况、体能等状态，并支持用户反馈。

### 2.2 目标用户

| 用户类型 | 典型场景 | 核心诉求 |
|----------|----------|----------|
|  solo 规划者 | 单人规划自驾/徒步 | 评估计划、一键优化、风险预判 |
| 团队规划者 | 家庭/朋友共同规划 | 团队权重、协商结论、冲突解决 |
| 执行中用户 | 行程进行中 | 实时状态、实地报告、疲劳反馈 |

### 2.3 成功指标

- **使用率**: 行程页优化相关功能月活用户占比
- **满意度**: 反馈表单提交率、平均评分
- **留存**: 使用过优化/团队/实时功能用户的复访率

---

## 3. 功能需求

### 3.1 计划优化 (Optimization)

#### 3.1.1 评估计划得分

| 需求 ID | 功能描述 | 优先级 | 验收标准 |
|---------|----------|--------|----------|
| O1 | 展示 8 维效用得分及总效用 | P0 | 用户可看到 safety/experience/philosophy/timeSlack/fatigueRisk/weatherRisk/budget/crowd 八项得分及总分 |
| O2 | 支持自定义权重评估 | P1 | 用户可调整权重，重新评估后得分变化 |
| O3 | 得分与计划变更联动 | P0 | 计划修改后，可一键重新评估 |

**交互要点**：雷达图/条形图展示维度；总分用 0–100 或 0–1 表示，配合色彩语义（绿/黄/红）。

#### 3.1.2 比较两个计划

| 需求 ID | 功能描述 | 优先级 | 验收标准 |
|---------|----------|--------|----------|
| O4 | 并排对比两个计划 | P0 | 展示 preferredPlan、utilityDifference、各维度对比 |
| O5 | 突出优胜维度 | P1 | 各维度标注 A/B 胜出或持平 |

**典型场景**：What-If 页、规划助手多方案对比。

#### 3.1.3 一键优化计划

| 需求 ID | 功能描述 | 优先级 | 验收标准 |
|---------|----------|--------|----------|
| O6 | 一键触发优化 | P0 | 用户点击「优化」后，展示优化后计划及变更列表 |
| O7 | 展示优化变更明细 | P0 | 展示 CONSTRAINT_FIX/SCHEDULE_OPT/STABILITY_FIX 类型变更及 utilityDelta |
| O8 | 支持采纳/拒绝优化结果 | P0 | 用户可采纳或放弃，采纳后行程数据更新 |

**交互要点**：优化过程有 loading；结果用 diff 或列表展示变更；提供「采纳」「放弃」按钮。

#### 3.1.4 风险评估

| 需求 ID | 功能描述 | 优先级 | 验收标准 |
|---------|----------|--------|----------|
| O9 | 展示 Monte Carlo 评估结果 | P0 | 展示 expectedUtility、95% 置信区间、feasibilityProbability、downsideRisk |
| O10 | 展示 riskFactors 及 recommendation | P1 | 列表展示风险因素，突出 recommendation |

**交互要点**：可用仪表盘或卡片；高风险用醒目颜色提示。

#### 3.1.5 三守护者协商

| 需求 ID | 功能描述 | 优先级 | 验收标准 |
|---------|----------|--------|----------|
| O11 | 展示协商结论 | P0 | 展示 decision、consensusLevel、keyTradeoffs、conditions、humanDecisionPoints |
| O12 | 展示各守护者效用及投票 | P1 | 展示 abuUtility/dreUtility/neptuneUtility 及 votingResult |
| O13 | 需人类决策时明确提示 | P0 | decision=NEEDS_HUMAN 时，突出 humanDecisionPoints |

**交互要点**：与 Abu/Dre/Neptune 人设一致；决策类型用 Badge 区分。

#### 3.1.6 提交反馈

| 需求 ID | 功能描述 | 优先级 | 验收标准 |
|---------|----------|--------|----------|
| O14 | 支持多种反馈类型 | P1 | SATISFACTION_RATING / FATIGUE_REPORT / PLAN_MODIFICATION / PREFERENCE_UPDATE / TRIP_COMPLETION / EARLY_TERMINATION |
| O15 | 表单字段与类型匹配 | P1 | 每种类型展示对应 data 字段（如满意度 1–5 星、疲劳 0–2、修改类型等）|
| O16 | 提交成功反馈 | P1 | 成功返回 feedbackId 并给用户明确提示 |

**典型场景**：行程结束弹窗、执行页疲劳上报。

#### 3.1.7 获取个性化偏好

| 需求 ID | 功能描述 | 优先级 | 验收标准 |
|---------|----------|--------|----------|
| O17 | 展示学习到的权重 | P2 | 有偏好数据时展示 weights、confidence、lastUpdated |
| O18 | 无偏好时使用默认权重 | P1 | 无数据时使用系统默认，不阻塞评估 |

---

### 3.2 团队协同 (Team)

#### 3.2.1 创建与管理团队

| 需求 ID | 功能描述 | 优先级 | 验收标准 |
|---------|----------|--------|----------|
| T1 | 创建团队 | P0 | 支持 name、type、decisionWeightMode、members |
| T2 | 成员配置 | P0 | 每人配置 role、decisionWeight、fitnessLevel、experienceLevel、personalWeights、specialConstraints |
| T3 | 获取/编辑团队信息 | P0 | GET/PATCH 团队，支持更新成员与约束 |
| T4 | 添加/移除成员 | P0 | POST 添加、DELETE 移除 |

**交互要点**：团队类型与决策模式用下拉选择；成员列表可编辑；权重可用 slider。

#### 3.2.2 团队协商

| 需求 ID | 功能描述 | 优先级 | 验收标准 |
|---------|----------|--------|----------|
| T5 | 以团队身份协商计划 | P0 | 传入 plan、world，展示 decision、memberEvaluations、conflicts |
| T6 | 展示成员评估与冲突 | P1 | 每人 utility、concerns；冲突列出 members、description、suggestedResolution |
| T7 | 团队约束满足状态 | P1 | 展示 teamConstraintsSatisfied |

#### 3.2.3 团队权重与约束

| 需求 ID | 功能描述 | 优先级 | 验收标准 |
|---------|----------|--------|----------|
| T8 | 展示综合权重 | P1 | 展示聚合 weights 及 memberContributions |
| T9 | 展示最弱链约束 | P1 | 展示 constraints 及 constraintSources |

---

### 3.3 实时状态 (Realtime)

#### 3.3.1 状态初始化与展示

| 需求 ID | 功能描述 | 优先级 | 验收标准 |
|---------|----------|--------|----------|
| R1 | 自动初始化状态 | P0 | 使用 autoInit=true 或先 check exists 再 initialize |
| R2 | 展示当前状态 | P0 | weather、roads、human 三大块，含 temperatureC、visibility、alerts、segment 状态、fatigueLevel、recommendations |
| R3 | 状态不可用时的降级 | P1 | 请求失败时展示「状态暂时不可用」等提示 |

**典型位置**：行程页顶部 Banner 或侧边卡片。

#### 3.3.2 预测与订阅

| 需求 ID | 功能描述 | 优先级 | 验收标准 |
|---------|----------|--------|----------|
| R4 | 预测未来状态 | P1 | 支持 hoursAhead 参数，展示 weather 均值/方差、feasibility、confidence |
| R5 | 订阅实时更新 | P1 | 支持订阅 WEATHER_CHANGE 等事件，通过 SSE 或轮询更新 |
| R6 | 取消订阅 | P2 | 离开页面时取消订阅，释放资源 |

#### 3.3.3 实地报告

| 需求 ID | 功能描述 | 优先级 | 验收标准 |
|---------|----------|--------|----------|
| R7 | 提交实地报告 | P1 | 支持 WEATHER/ROAD_STATUS/HAZARD/HUMAN_STATE 类型 |
| R8 | 报告表单与类型匹配 | P1 | 根据 type 展示 condition、windStrong、roadCondition、hazardType、feeling、symptoms 等字段 |
| R9 | 提交成功反馈 | P1 | 展示 thanksMessage |

**典型位置**：执行页快捷入口或浮窗。

---

## 4. 信息架构与页面映射

```
├── 行程详情 (trips/[id])
│   ├── 计划评估卡片 (O1, O2, O3)
│   ├── 协商结果卡片 (O11, O12, O13)
│   ├── 风险评估卡片 (O9, O10)
│   ├── 一键优化入口 (O6, O7, O8)
│   ├── 实时状态 Banner (R1, R2, R3)
│   ├── 团队协商入口 (T5, T6) [若已选团队]
│   └── 反馈入口 (O14, O15)
│
├── 计划工作台 (plan-studio)
│   ├── 优化仪表盘 (O1–O8, O9–O13)
│   ├── 计划对比视图 (O4, O5)
│   └── 团队管理 (T1–T9)
│
├── What-If 页 (what-if)
│   ├── 计划比较 (O4, O5)
│   └── 风险评估 (O9, O10)
│
└── 执行页 (execute)
    ├── 实时状态 (R1, R2, R4, R5)
    └── 实地报告 (R7, R8, R9)
```

---

## 5. 优先级与迭代建议

### 5.1 迭代 1：核心优化能力 (2–3 周)

- O1, O3, O6, O7, O8：评估 + 一键优化 + 采纳
- O9, O10：风险评估
- O11, O12, O13：三守护者协商
- R1, R2, R3：实时状态展示

### 5.2 迭代 2：对比与反馈 (1–2 周)

- O4, O5：计划比较
- O14, O15, O16：反馈表单
- O2：自定义权重

### 5.3 迭代 3：团队与高级能力 (2–3 周)

- T1–T9：团队创建、成员管理、协商、权重与约束
- R4, R5, R7, R8, R9：预测、订阅、实地报告
- O17, O18：个性化偏好

---

## 6. 非功能需求

| 类型 | 描述 |
|------|------|
| 性能 | 评估/比较/风险接口 < 3s 首屏；优化接口 < 10s |
| 可用性 | API 不可用时，有明确错误提示与重试入口 |
| 国际化 | 所有文案支持 i18n（含错误提示、维度名称、建议文案）|
| 无障碍 | 关键交互支持键盘与屏幕阅读器 |

---

## 7. 依赖与假设

- 后端 `/api/v2/user/*` 接口已就绪且符合文档约定。
- 行程详情、用户信息、路线方向等数据可通过现有 API 获取。
- 认证与鉴权由现有体系负责，本模块不单独实现登录。

---

## 8. 附录：需求 ID 速查

| 模块 | 需求 ID 范围 | 说明 |
|------|--------------|------|
| 计划优化 | O1–O18 | 评估、比较、优化、风险、协商、反馈、偏好 |
| 团队 | T1–T9 | 创建、成员、协商、权重、约束 |
| 实时状态 | R1–R9 | 初始化、展示、预测、订阅、实地报告 |
