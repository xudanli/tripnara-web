# 准备度页面接口文档

## 概述

准备度页面 (`/readiness`) 用于检查旅行准备度，显示阻塞项、必须项、建议项和可选清单，并提供修复方案。

**重要更新（2025-01-XX）**：本文档已根据后端 API 文档更新，主要变更：
- `ReadinessFindingItem.tasks` 改为字符串数组（原为对象数组）
- `ReadinessFindingItem.evidence` 改为字符串（原为对象数组）
- `ReadinessFinding.category` 改为必填字段
- `Risk.message` 和 `Risk.mitigation` 字段使用（原为 `summary` 和 `mitigations`）

前端代码已添加兼容性处理，支持新旧两种格式。

## 核心接口列表

### 1. 获取行程准备度（主要接口）

**接口：** `GET /readiness/trip/:tripId?lang=zh`

**调用方式：**
```typescript
readinessApi.getTripReadiness(tripId: string, lang?: string)
```

**响应结构：** `ReadinessCheckResult`
```typescript
{
  findings: ReadinessFinding[];  // 多个目的地的检查结果
  summary: {
    totalBlockers: number;        // 阻塞项总数
    totalMust: number;            // 必须项总数
    totalShould: number;          // 建议项总数
    totalOptional: number;       // 可选项总数
  };
  risks: Risk[];                  // 风险列表
  constraints: Constraint[];     // 约束列表
}
```

**ReadinessFinding 结构：**
```typescript
{
  destinationId?: string;         // 目的地ID，如 "IS-ICELAND"
  packId?: string;                // Pack ID，如 "pack.is.iceland"
  packVersion?: string;           // Pack 版本，如 "1.0.0"
  blockers: ReadinessFindingItem[];  // 阻塞项列表
  must: ReadinessFindingItem[];      // 必须项列表
  should: ReadinessFindingItem[];    // 建议项列表
  optional: ReadinessFindingItem[];  // 可选项列表
  risks?: Risk[];                    // 风险列表
}
```

**ReadinessFindingItem 结构：**
```typescript
{
  id?: string;                    // 规则ID
  category?: string;               // 分类
  severity?: string;               // 严重程度
  level?: 'blocker' | 'must' | 'should' | 'optional';
  message: string;                 // 消息内容
  tasks?: Array<{                 // 任务列表
    title: string;
    dueOffsetDays: number;        // 相对出发日期的天数偏移（负数表示出发前）
    tags?: string[];
  }>;
  askUser?: string[];             // 需要询问用户的问题
  evidence?: Array<{              // 证据引用
    sourceId: string;
    sectionId?: string;
    quote?: string;
  }>;
}
```

**Risk 结构：**
```typescript
{
  type: string;                    // 风险类型（如 'altitude', 'terrain', 'weather'）
  severity: 'low' | 'medium' | 'high';
  summary: string;                 // 风险摘要
  mitigations?: string[];          // 应对措施列表
  emergencyContacts?: string[];    // 紧急联系方式
}
```

---

### 2. 检查准备度（备用接口）

**接口：** `POST /readiness/check`

**调用方式：**
```typescript
readinessApi.check(dto: CheckReadinessDto)
```

**请求结构：** `CheckReadinessDto`
```typescript
{
  destinationId: string;           // 目的地ID（必填）
  traveler?: {
    nationality?: string;          // 国籍
    residencyCountry?: string;     // 居住国
    tags?: string[];                // 标签
    budgetLevel?: 'low' | 'medium' | 'high';
    riskTolerance?: 'low' | 'medium' | 'high';
  };
  trip?: {
    startDate?: string;            // 开始日期
    endDate?: string;              // 结束日期
  };
  itinerary?: {
    countries?: string[];          // 国家列表
    activities?: string[];          // 活动列表
    season?: string;                // 季节
    region?: string;                // 区域
    hasSeaCrossing?: boolean;       // 是否有跨海
    hasAuroraActivity?: boolean;   // 是否有极光活动
    vehicleType?: string;          // 车辆类型
    routeLength?: number;           // 路线长度
  };
  geo?: {
    lat?: number;                   // 纬度
    lng?: number;                   // 经度
    enhanceWithGeo?: boolean;        // 是否使用地理位置增强
  };
}
```

**响应结构：** 与 `getTripReadiness` 相同，返回 `ReadinessCheckResult`

---

### 3. 获取个性化准备清单

**接口：** `GET /readiness/personalized-checklist?tripId=xxx&lang=zh`

**调用方式：**
```typescript
readinessApi.getPersonalizedChecklist(tripId: string, lang?: string)
```

**响应结构：** `PersonalizedChecklistResponse`
```typescript
{
  tripId: string;
  checklist: {
    blocker: ReadinessFindingItem[];
    must: ReadinessFindingItem[];
    should: ReadinessFindingItem[];
    optional: ReadinessFindingItem[];
  };
  summary: {
    totalBlockers: number;
    totalMust: number;
    totalShould: number;
    totalOptional: number;
  };
}
```

---

### 4. 获取行程潜在风险预警

**接口：** `GET /readiness/risk-warnings?tripId=xxx&lang=zh`

**调用方式：**
```typescript
readinessApi.getRiskWarnings(tripId: string, lang?: string)
```

**响应结构：** `RiskWarningsResponse`
```typescript
{
  tripId: string;
  risks: Risk[];
  summary: {
    totalRisks: number;
    highSeverity: number;
    mediumSeverity: number;
    lowSeverity: number;
  };
}
```

---

### 5. 获取修复方案

**接口：** `POST /readiness/repair-options`

**调用方式：**
```typescript
readinessApi.getRepairOptions(tripId: string, blockerId: string)
```

**请求体：**
```typescript
{
  tripId: string;
  blockerId: string;
}
```

**响应结构：**
```typescript
{
  options: RepairOption[];
}
```

**RepairOption 结构：**
```typescript
{
  id: string;
  title: string;
  description: string;
  changes: {
    time?: string;        // "+30min" / "-15min"
    distance?: string;    // "+12km" / "-5km"
    elevation?: string;  // "+200m" / "-100m"
    risk?: string;       // "下降" / "上升"
  };
  reasonCode: string;
  evidenceLink?: string;
}
```

---

### 6. 应用修复方案

**接口：** `POST /readiness/apply-repair`

**调用方式：**
```typescript
readinessApi.applyRepair(tripId: string, blockerId: string, optionId: string)
```

**请求体：**
```typescript
{
  tripId: string;
  blockerId: string;
  optionId: string;
}
```

**响应结构：**
```typescript
{
  success: boolean;
  message?: string;
}
```

---

### 7. 运行自动修复（Neptune）

**接口：** `POST /readiness/auto-repair`

**调用方式：**
```typescript
readinessApi.autoRepair(tripId: string)
```

**请求体：**
```typescript
{
  tripId: string;
}
```

**响应结构：**
```typescript
{
  success: boolean;
  message?: string;
}
```

---

### 8. 刷新证据

**接口：** `POST /readiness/refresh-evidence`

**调用方式：**
```typescript
readinessApi.refreshEvidence(tripId: string, evidenceId?: string)
```

**请求体：**
```typescript
{
  tripId: string;
  evidenceId?: string;  // 可选，如果提供则只刷新指定证据
}
```

**响应结构：**
```typescript
{
  success: boolean;
}
```

---

### 9. 更新勾选状态

**接口：** `PUT /readiness/trip/:tripId/checklist/status`

**调用方式：**
```typescript
readinessApi.updateChecklistStatus(tripId: string, checkedItems: string[])
```

**请求体：**
```typescript
{
  checkedItems: string[];  // 已勾选的 finding ID 列表
}
```

**响应结构：**
```typescript
{
  updated: number;         // 更新的数量
  checkedItems: string[];  // 更新后的勾选列表
}
```

---

### 10. 获取勾选状态

**接口：** `GET /readiness/trip/:tripId/checklist/status`

**调用方式：**
```typescript
readinessApi.getChecklistStatus(tripId: string)
```

**响应结构：**
```typescript
{
  checkedItems: string[];  // 已勾选的 finding ID 列表
  lastUpdated: string;    // 最后更新时间（ISO 格式）
}
```

---

### 11. 获取阻塞项解决方案

**接口：** `GET /readiness/trip/:tripId/blockers/:blockerId/solutions`

**调用方式：**
```typescript
readinessApi.getSolutions(tripId: string, blockerId: string)
```

**响应结构：**
```typescript
{
  blockerId: string;
  blockerMessage: string;
  solutions: any[];  // 解决方案列表（具体结构待确认）
}
```

---

### 12. 标记为不适用

**接口：** `POST /readiness/trip/:tripId/findings/:findingId/mark-not-applicable`

**调用方式：**
```typescript
readinessApi.markNotApplicable(tripId: string, findingId: string, reason?: string)
```

**请求体：**
```typescript
{
  reason?: string;  // 不适用原因（可选）
}
```

**响应结构：**
```typescript
{
  findingId: string;
  marked: boolean;
  reason?: string;
  markedAt: string;  // ISO 格式时间戳
}
```

---

### 13. 取消标记不适用

**接口：** `DELETE /readiness/trip/:tripId/findings/:findingId/mark-not-applicable`

**调用方式：**
```typescript
readinessApi.unmarkNotApplicable(tripId: string, findingId: string)
```

**响应结构：**
```typescript
{
  findingId: string;
  marked: boolean;
}
```

---

### 14. 添加到稍后处理

**接口：** `POST /readiness/trip/:tripId/findings/:findingId/add-to-later`

**调用方式：**
```typescript
readinessApi.addToLater(tripId: string, findingId: string, reminderDate?: string, note?: string)
```

**请求体：**
```typescript
{
  reminderDate?: string;  // 提醒日期（ISO 格式）
  note?: string;          // 备注
}
```

**响应结构：**
```typescript
{
  findingId: string;
  added: boolean;
  reminderDate?: string;
  note?: string;
  addedAt: string;  // ISO 格式时间戳
}
```

---

### 15. 从稍后处理移除

**接口：** `DELETE /readiness/trip/:tripId/findings/:findingId/remove-from-later`

**调用方式：**
```typescript
readinessApi.removeFromLater(tripId: string, findingId: string)
```

**响应结构：**
```typescript
{
  findingId: string;
  removed: boolean;
}
```

---

### 16. 获取不适用项列表

**接口：** `GET /readiness/trip/:tripId/findings/not-applicable`

**调用方式：**
```typescript
readinessApi.getNotApplicableItems(tripId: string)
```

**响应结构：**
```typescript
{
  notApplicableItems: Array<{
    findingId: string;
    reason?: string;
    markedAt: string;  // ISO 格式时间戳
  }>;
}
```

---

### 17. 获取稍后处理列表

**接口：** `GET /readiness/trip/:tripId/findings/later`

**调用方式：**
```typescript
readinessApi.getLaterItems(tripId: string)
```

**响应结构：**
```typescript
{
  laterItems: Array<{
    findingId: string;
    reminderDate?: string;
    note?: string;
    addedAt: string;  // ISO 格式时间戳
  }>;
}
```

---

### 18. 生成打包清单

**接口：** `POST /readiness/trip/:tripId/packing-list/generate`

**调用方式：**
```typescript
readinessApi.generatePackingList(tripId: string, options?: {
  includeOptional?: boolean;
  categories?: string[];
  customItems?: Array<{ name: string; category: string; quantity?: number; note?: string }>;
})
```

**请求体（可选）：**
```typescript
{
  includeOptional?: boolean;  // 是否包含可选物品
  categories?: string[];       // 分类列表
  customItems?: Array<{       // 自定义物品
    name: string;
    category: string;
    quantity?: number;
    note?: string;
  }>;
}
```

**响应结构：**
```typescript
{
  tripId: string;
  generatedAt: string;  // ISO 格式时间戳
  items: Array<{
    id: string;
    name: string;
    category: string;
    quantity: number;
    unit?: string;
    priority: 'must' | 'should' | 'optional';
    reason?: string;
    sourceFindingId?: string;
    checked: boolean;
    note?: string;
  }>;
  summary: {
    totalItems: number;
    byCategory: Record<string, number>;
  };
}
```

---

### 19. 获取打包清单

**接口：** `GET /readiness/trip/:tripId/packing-list`

**调用方式：**
```typescript
readinessApi.getPackingList(tripId: string)
```

**响应结构：**
```typescript
{
  tripId: string;
  items: any[];  // 打包清单项列表（具体结构待确认）
  summary: {
    totalItems: number;
    checkedItems: number;
    byCategory: Record<string, number>;
  };
  lastGeneratedAt?: string;  // ISO 格式时间戳
}
```

---

### 20. 更新打包清单项状态

**接口：** `PUT /readiness/trip/:tripId/packing-list/items/:itemId`

**调用方式：**
```typescript
readinessApi.updatePackingListItem(tripId: string, itemId: string, updates: {
  checked?: boolean;
  quantity?: number;
  note?: string;
})
```

**请求体：**
```typescript
{
  checked?: boolean;   // 是否已勾选
  quantity?: number;   // 数量
  note?: string;       // 备注
}
```

**响应结构：**
```typescript
{
  itemId: string;
  updated: boolean;
}
```

---

### 21. 获取能力包列表

**接口：** `GET /readiness/capability-packs`

**调用方式：**
```typescript
readinessApi.getCapabilityPacks()
```

**响应结构：**
```typescript
{
  packs: CapabilityPack[];
}
```

**CapabilityPack 结构：**
```typescript
{
  type: string;
  displayName: string;
  description: string;
}
```

---

### 22. 评估能力包

**接口：** `POST /readiness/capability-packs/evaluate`

**调用方式：**
```typescript
readinessApi.evaluateCapabilityPacks(dto: CheckReadinessDto)
```

**请求体：** 与 `POST /readiness/check` 相同，使用 `CheckReadinessDto`

**响应结构：**
```typescript
{
  total: number;       // 总能力包数
  triggered: number;   // 触发的能力包数
  results: CapabilityPackEvaluateResult[];
}
```

**CapabilityPackEvaluateResult 结构：**
```typescript
{
  pack: CapabilityPack;
  triggered: boolean;
  reason?: string;
}
```

---

## 页面使用的主要接口

准备度页面 (`src/pages/readiness/index.tsx`) 主要使用以下接口：

1. **主要接口（优先）：**
   - `GET /readiness/trip/:tripId?lang=zh` - 获取行程准备度

2. **备用接口（降级方案）：**
   - `POST /readiness/check` - 检查准备度
   - `GET /readiness/personalized-checklist?tripId=xxx&lang=zh` - 获取个性化清单
   - `GET /readiness/risk-warnings?tripId=xxx&lang=zh` - 获取风险预警

3. **交互功能接口：**
   - `POST /readiness/repair-options` - 获取修复方案
   - `POST /readiness/apply-repair` - 应用修复方案
   - `POST /readiness/auto-repair` - 自动修复
   - `POST /readiness/refresh-evidence` - 刷新证据
   - `GET /readiness/trip/:tripId/checklist/status` - 获取勾选状态
   - `PUT /readiness/trip/:tripId/checklist/status` - 更新勾选状态

4. **能力包相关（可选）：**
   - `GET /readiness/capability-packs` - 获取能力包列表
   - `POST /readiness/capability-packs/evaluate` - 评估能力包

---

## 数据转换

前端需要将 `ReadinessCheckResult` 转换为 `ReadinessData` 格式用于 UI 展示。

**ReadinessData 结构：**
```typescript
{
  status: 'ready' | 'nearly' | 'not-ready';
  score: {
    overall: number;              // 0-100
    evidenceCoverage: number;
    scheduleFeasibility: number;
    transportCertainty: number;
    safetyRisk: number;
    buffers: number;
  };
  executableWindow?: {
    start: string;  // "08:30"
    end: string;    // "18:00"
  };
  blockers: Blocker[];
  watchlist?: Blocker[];  // Ready 状态时显示潜在风险
  repairOptions?: RepairOption[];
  selectedBlockerId?: string;
}
```

**Blocker 结构：**
```typescript
{
  id: string;
  title: string;
  severity: 'critical' | 'high' | 'medium';
  impactScope: string;  // "Day 1" / "Segment 2" / "POI #3"
  evidenceSummary: {
    source: string;     // "road.is" / "opening hours" / "forecast"
    timestamp: string;
  };
  category: 'road' | 'weather' | 'poi' | 'ticket' | 'lodging' | 'other';
}
```

转换逻辑在 `src/pages/readiness/index.tsx` 的 `convertCheckResultToReadinessData` 函数中实现。

---

## 语言支持

所有接口都支持 `lang` 参数（可选）：
- `lang=zh` - 中文
- `lang=en` - 英文（默认）

---

## 错误处理

所有接口都遵循统一的响应格式：

**成功响应：**
```typescript
{
  success: true;
  data: T;  // 具体的数据类型
  error: null;
}
```

**错误响应：**
```typescript
{
  success: false;
  data: null;
  error: {
    code: string;
    message: string;
  };
}
```

前端在 `src/api/readiness.ts` 中使用 `handleResponse` 函数统一处理响应。

---

## 接口优先级

准备度页面按以下优先级尝试加载数据：

1. **第一优先级：** `GET /readiness/trip/:tripId?lang=zh`
2. **第二优先级：** `POST /readiness/check`（需要构建 `CheckReadinessDto`）
3. **第三优先级：** `GET /readiness/personalized-checklist` + `GET /readiness/risk-warnings`
4. **降级方案：** 使用模拟数据（`generateMockReadinessData()`）

---

## 相关文件

- API 定义：`src/api/readiness.ts`
- 类型定义：`src/types/readiness.ts`
- 页面组件：`src/pages/readiness/index.tsx`
- 抽屉组件：`src/components/readiness/ReadinessDrawer.tsx`
