# å†³ç­–è¯„ä¼°æ¥å£æµ‹è¯•æŒ‡å—

> åˆ›å»ºæ—¶é—´ï¼š2025-01-XX  
> æµ‹è¯•è„šæœ¬ï¼š`test-decision-evaluation.ts`

---

## ğŸ“‹ æ¦‚è¿°

æœ¬æµ‹è¯•è„šæœ¬ç”¨äºå®Œæ•´æµ‹è¯•å†³ç­–è¯„ä¼°ï¼ˆè§„åˆ’å·¥ä½œå°ï¼‰ç›¸å…³çš„æ‰€æœ‰æ¥å£ï¼ŒåŒ…æ‹¬ï¼š

1. **åˆ›å»ºæ–°è¡Œç¨‹** - `POST /trips`
2. **ç”Ÿæˆæ–¹æ¡ˆ** - `POST /planning-workbench/execute` (userAction: 'generate')
3. **å¯¹æ¯”æ–¹æ¡ˆ** - `POST /planning-workbench/execute` (userAction: 'compare')
4. **æäº¤æ–¹æ¡ˆ** - `POST /planning-workbench/plans/:planId/commit`
5. **è°ƒæ•´æ–¹æ¡ˆ** - `POST /planning-workbench/execute` (userAction: 'adjust')

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®æ¡ä»¶

1. **åç«¯æœåŠ¡è¿è¡Œ**
   - ç¡®ä¿åç«¯æœåŠ¡è¿è¡Œåœ¨ `http://localhost:3000`
   - æˆ–è®¾ç½®ç¯å¢ƒå˜é‡ `API_BASE_URL`

2. **è·å– Access Token**
   - ç™»å½•å‰ç«¯åº”ç”¨
   - ä»æµè§ˆå™¨ `sessionStorage` ä¸­è·å– `accessToken`
   - æˆ–ä»åç«¯ API ç™»å½•æ¥å£è·å–

3. **å®‰è£…ä¾èµ–**ï¼ˆå¦‚æœéœ€è¦ï¼‰
   ```bash
   # å¦‚æœä½¿ç”¨ ts-node
   npm install --save-dev ts-node @types/node
   ```

### è¿è¡Œæµ‹è¯•

#### æ–¹æ³• 1: ä½¿ç”¨ ts-nodeï¼ˆæ¨èï¼‰

```bash
# è®¾ç½®ç¯å¢ƒå˜é‡
export ACCESS_TOKEN="your-token-here"
export API_BASE_URL="http://localhost:3000/api"  # å¯é€‰ï¼Œé»˜è®¤å€¼

# è¿è¡Œæµ‹è¯•
npx ts-node test-decision-evaluation.ts
```

#### æ–¹æ³• 2: ä½¿ç”¨ Node.js ESM Loader

```bash
# è®¾ç½®ç¯å¢ƒå˜é‡
export ACCESS_TOKEN="your-token-here"

# è¿è¡Œæµ‹è¯•
node --loader ts-node/esm test-decision-evaluation.ts
```

#### æ–¹æ³• 3: ç¼–è¯‘åè¿è¡Œ

```bash
# ç¼–è¯‘ TypeScript
tsc test-decision-evaluation.ts

# è¿è¡Œç¼–è¯‘åçš„ JavaScript
node test-decision-evaluation.js
```

---

## ğŸ“ æµ‹è¯•æµç¨‹

### 1. åˆ›å»ºæ–°è¡Œç¨‹

**æ¥å£**: `POST /trips`

**æµ‹è¯•æ•°æ®**:
- ç›®çš„åœ°: æ—¥æœ¬ (JP)
- è¡Œç¨‹å¤©æ•°: 7 å¤©
- é¢„ç®—: 50000 CNY
- æ—…è¡Œè€…: 1 äººï¼ˆ30 å²ï¼‰
- èŠ‚å¥: moderateï¼ˆä¸­ç­‰ï¼‰
- åå¥½: cultureï¼ˆæ–‡åŒ–ï¼‰ã€foodï¼ˆç¾é£Ÿï¼‰

**é¢„æœŸç»“æœ**:
- è¿”å›è¡Œç¨‹ ID
- è¡Œç¨‹çŠ¶æ€ä¸º `PLANNING`

---

### 2. ç”Ÿæˆæ–¹æ¡ˆï¼ˆGenerateï¼‰

**æ¥å£**: `POST /planning-workbench/execute`

**è¯·æ±‚å‚æ•°**:
```json
{
  "context": {
    "destination": { "country": "JP" },
    "days": 7,
    "travelMode": "public_transit",
    "constraints": {
      "budget": {
        "total": 50000,
        "currency": "CNY"
      }
    }
  },
  "tripId": "<trip-id>",
  "userAction": "generate"
}
```

**é¢„æœŸç»“æœ**:
- è¿”å› `planState`ï¼ˆåŒ…å« plan_idã€plan_versionã€statusï¼‰
- è¿”å› `uiOutput`ï¼ˆåŒ…å«ä¸‰äººæ ¼è¯„ä¼°ã€ç»¼åˆå†³ç­–ï¼‰
- æ–¹æ¡ˆçŠ¶æ€ä¸º `PROPOSED` æˆ– `NEED_CONFIRM`

**å…³é”®å­—æ®µ**:
- `planState.plan_id`: æ–¹æ¡ˆ ID
- `planState.plan_version`: æ–¹æ¡ˆç‰ˆæœ¬
- `uiOutput.consolidatedDecision.status`: ç»¼åˆå†³ç­–çŠ¶æ€
- `uiOutput.personas.abu.verdict`: Abu è¯„ä¼°ç»“æœ
- `uiOutput.personas.drdre.verdict`: Dr.Dre è¯„ä¼°ç»“æœ
- `uiOutput.personas.neptune.verdict`: Neptune è¯„ä¼°ç»“æœ

---

### 3. å¯¹æ¯”æ–¹æ¡ˆï¼ˆCompareï¼‰

**æ¥å£**: `POST /planning-workbench/execute`

**è¯·æ±‚å‚æ•°**:
```json
{
  "context": {
    "destination": { "country": "JP" },
    "days": 7,
    "travelMode": "public_transit"
  },
  "tripId": "<trip-id>",
  "userAction": "compare",
  "existingPlanState": {
    "plan_id": "<plan-id-1>"
  }
}
```

**é¢„æœŸç»“æœ**:
- è¿”å›å¯¹æ¯”ç»“æœ
- æ˜¾ç¤ºä¸åŒæ–¹æ¡ˆçš„å·®å¼‚

**æ³¨æ„**: æ­¤æ“ä½œå¯èƒ½éœ€è¦å¤šä¸ªæ–¹æ¡ˆï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªæ–¹æ¡ˆï¼Œæµ‹è¯•è„šæœ¬ä¼šè‡ªåŠ¨ç”Ÿæˆç¬¬äºŒä¸ªæ–¹æ¡ˆç”¨äºå¯¹æ¯”ã€‚

---

### 4. æäº¤æ–¹æ¡ˆï¼ˆCommitï¼‰

**æ¥å£**: `POST /planning-workbench/plans/:planId/commit`

**è¯·æ±‚å‚æ•°**:
```json
{
  "tripId": "<trip-id>",
  "options": {
    "partialCommit": false
  }
}
```

**é¢„æœŸç»“æœ**:
- è¿”å›æäº¤ç»“æœ
- åŒ…å«å˜æ›´ç»Ÿè®¡ï¼ˆaddedã€modifiedã€removedï¼‰
- æ–¹æ¡ˆçŠ¶æ€æ›´æ–°ä¸º `LOCKED`

---

### 5. è°ƒæ•´æ–¹æ¡ˆï¼ˆAdjustï¼‰

**æ¥å£**: `POST /planning-workbench/execute`

**è¯·æ±‚å‚æ•°**:
```json
{
  "context": {
    "destination": { "country": "JP" },
    "days": 7,
    "travelMode": "public_transit",
    "constraints": {
      "budget": {
        "total": 60000,
        "currency": "CNY"
      }
    }
  },
  "tripId": "<trip-id>",
  "userAction": "adjust",
  "existingPlanState": {
    "plan_id": "<plan-id>"
  }
}
```

**é¢„æœŸç»“æœ**:
- è¿”å›è°ƒæ•´åçš„æ–°æ–¹æ¡ˆ
- æ–°æ–¹æ¡ˆæœ‰æ–°çš„ `plan_id` å’Œ `plan_version`
- é¢„ç®—çº¦æŸå·²æ›´æ–°

---

## ğŸ” æµ‹è¯•è¾“å‡ºè¯´æ˜

### é¢œè‰²ç¼–ç 

- ğŸŸ¢ **ç»¿è‰²**: æˆåŠŸæ“ä½œ
- ğŸ”´ **çº¢è‰²**: é”™è¯¯/å¤±è´¥
- ğŸŸ¡ **é»„è‰²**: è­¦å‘Š/è·³è¿‡
- ğŸ”µ **è“è‰²**: ä¿¡æ¯/è¯·æ±‚è¯¦æƒ…
- ğŸŸ£ **ç´«è‰²**: æµ‹è¯•æ ‡é¢˜

### è¾“å‡ºç»“æ„

```
ğŸš€ å†³ç­–è¯„ä¼°æ¥å£å®Œæ•´æµ‹è¯•
API Base URL: http://localhost:3000/api
Access Token: å·²è®¾ç½®

======================================================================
æµ‹è¯•: 1. åˆ›å»ºæ–°è¡Œç¨‹
======================================================================

----------------------------------------------------------------------
è¯·æ±‚ä¿¡æ¯
----------------------------------------------------------------------
URL: http://localhost:3000/api/trips
æ–¹æ³•: POST
è¯·æ±‚ä½“:
{
  "destination": "JP",
  ...
}

----------------------------------------------------------------------
å“åº”ç»“æœ
----------------------------------------------------------------------
âœ… è¡Œç¨‹åˆ›å»ºæˆåŠŸï¼
çŠ¶æ€ç : 201
è¡Œç¨‹ ID: trip-xxx-xxx
...
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### 1. ACCESS_TOKEN æœªè®¾ç½®

**é”™è¯¯ä¿¡æ¯**:
```
âš ï¸  è­¦å‘Š: æœªè®¾ç½® ACCESS_TOKENï¼Œè¯·å…ˆç™»å½•è·å– token
```

**è§£å†³æ–¹æ³•**:
```bash
# ä»æµè§ˆå™¨è·å– token
# 1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·
# 2. è¿›å…¥ Application > Session Storage
# 3. æ‰¾åˆ° accessToken
# 4. å¤åˆ¶å¹¶è®¾ç½®ç¯å¢ƒå˜é‡

export ACCESS_TOKEN="your-token-here"
```

### 2. æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡

**é”™è¯¯ä¿¡æ¯**:
```
æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡
è¯·ç¡®è®¤åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œåœ¨ http://localhost:3000
```

**è§£å†³æ–¹æ³•**:
- ç¡®è®¤åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ
- æ£€æŸ¥ç«¯å£æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
- å¦‚æœåç«¯åœ¨ä¸åŒç«¯å£ï¼Œè®¾ç½® `API_BASE_URL` ç¯å¢ƒå˜é‡

### 3. è¶…æ—¶é”™è¯¯

**é”™è¯¯ä¿¡æ¯**:
```
timeout of 60000ms exceeded
```

**è§£å†³æ–¹æ³•**:
- ç”Ÿæˆæ–¹æ¡ˆå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œè¿™æ˜¯æ­£å¸¸çš„
- å¦‚æœç»å¸¸è¶…æ—¶ï¼Œå¯ä»¥å¢åŠ è¶…æ—¶æ—¶é—´ï¼ˆä¿®æ”¹è„šæœ¬ä¸­çš„ `timeout` å€¼ï¼‰
- æ£€æŸ¥åç«¯æœåŠ¡æ€§èƒ½

### 4. 401 Unauthorized

**é”™è¯¯ä¿¡æ¯**:
```
çŠ¶æ€ç : 401
é”™è¯¯ä¿¡æ¯: Unauthorized
```

**è§£å†³æ–¹æ³•**:
- æ£€æŸ¥ `ACCESS_TOKEN` æ˜¯å¦æœ‰æ•ˆ
- é‡æ–°ç™»å½•è·å–æ–°çš„ token
- ç¡®è®¤ token æ ¼å¼æ­£ç¡®ï¼ˆBearer tokenï¼‰

---

## ğŸ“Š æµ‹è¯•ç»“æœéªŒè¯

### æˆåŠŸæ ‡å‡†

1. âœ… **åˆ›å»ºè¡Œç¨‹**: è¿”å›æœ‰æ•ˆçš„è¡Œç¨‹ ID
2. âœ… **ç”Ÿæˆæ–¹æ¡ˆ**: è¿”å›æœ‰æ•ˆçš„æ–¹æ¡ˆ ID å’Œä¸‰äººæ ¼è¯„ä¼°ç»“æœ
3. âœ… **å¯¹æ¯”æ–¹æ¡ˆ**: è¿”å›å¯¹æ¯”ç»“æœï¼ˆå¯é€‰ï¼‰
4. âœ… **æäº¤æ–¹æ¡ˆ**: è¿”å›æäº¤æˆåŠŸå’Œå˜æ›´ç»Ÿè®¡
5. âœ… **è°ƒæ•´æ–¹æ¡ˆ**: è¿”å›æ–°çš„æ–¹æ¡ˆ ID å’Œç‰ˆæœ¬å·

### éªŒè¯è¦ç‚¹

- **æ–¹æ¡ˆçŠ¶æ€**: æ£€æŸ¥ `planState.status` æ˜¯å¦ç¬¦åˆé¢„æœŸ
- **ç»¼åˆå†³ç­–**: æ£€æŸ¥ `consolidatedDecision.status` æ˜¯å¦ä¸ºæœ‰æ•ˆå€¼ï¼ˆALLOWã€NEED_CONFIRMã€SUGGEST_REPLACEã€REJECTï¼‰
- **ä¸‰äººæ ¼è¯„ä¼°**: æ£€æŸ¥ä¸‰äººæ ¼çš„ `verdict` æ˜¯å¦éƒ½æœ‰å€¼
- **æ–¹æ¡ˆç‰ˆæœ¬**: è°ƒæ•´åçš„æ–¹æ¡ˆåº”è¯¥æœ‰æ–°çš„ `plan_version`

---

## ğŸ”„ æ¸…ç†æµ‹è¯•æ•°æ®

æµ‹è¯•å®Œæˆåï¼Œå¦‚æœéœ€è¦æ¸…ç†æµ‹è¯•æ•°æ®ï¼š

```bash
# åˆ é™¤æµ‹è¯•è¡Œç¨‹ï¼ˆéœ€è¦ç¡®è®¤æ–‡å­—ï¼‰
curl -X DELETE "http://localhost:3000/api/trips/<trip-id>" \
  -H "Authorization: Bearer <access-token>" \
  -H "Content-Type: application/json" \
  -d '{"confirmText": "JP"}'
```

---

## ğŸ“ æµ‹è¯•æŠ¥å‘Šæ¨¡æ¿

æµ‹è¯•å®Œæˆåï¼Œå¯ä»¥è®°å½•ä»¥ä¸‹ä¿¡æ¯ï¼š

```
æµ‹è¯•æ—¶é—´: 2025-01-XX
æµ‹è¯•äººå‘˜: XXX
åç«¯ç‰ˆæœ¬: XXX

æµ‹è¯•ç»“æœ:
- âœ… åˆ›å»ºè¡Œç¨‹: æˆåŠŸ
- âœ… ç”Ÿæˆæ–¹æ¡ˆ: æˆåŠŸ
- âš ï¸  å¯¹æ¯”æ–¹æ¡ˆ: è·³è¿‡ï¼ˆéœ€è¦å¤šä¸ªæ–¹æ¡ˆï¼‰
- âœ… æäº¤æ–¹æ¡ˆ: æˆåŠŸ
- âœ… è°ƒæ•´æ–¹æ¡ˆ: æˆåŠŸ

åˆ›å»ºçš„æµ‹è¯•æ•°æ®:
- Trip ID: trip-xxx-xxx
- Plan IDs: plan-xxx-xxx, plan-yyy-yyy

é—®é¢˜è®°å½•:
- æ— 
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥

æµ‹è¯•å®Œæˆåï¼Œå¯ä»¥ï¼š

1. **å‰ç«¯éªŒè¯**: è®¿é—® `/dashboard/plan-studio?tripId=<trip-id>` æŸ¥çœ‹å‰ç«¯ç•Œé¢
2. **åŠŸèƒ½æµ‹è¯•**: åœ¨å‰ç«¯æµ‹è¯•å†³ç­–è¯„ä¼°çš„å„ç§æ“ä½œ
3. **æ€§èƒ½æµ‹è¯•**: æµ‹è¯•å¤§é‡æ–¹æ¡ˆç”Ÿæˆå’Œå¯¹æ¯”çš„æ€§èƒ½
4. **é”™è¯¯å¤„ç†**: æµ‹è¯•å„ç§é”™è¯¯æƒ…å†µçš„å¤„ç†

---

**æµ‹è¯•è„šæœ¬ä½ç½®**: `test-decision-evaluation.ts`  
**ç›¸å…³æ–‡æ¡£**: 
- `docs/è§„åˆ’å·¥ä½œå°æ¥å£éœ€æ±‚åˆ†æ.md`
- `docs/è§„åˆ’å·¥ä½œå°é›†æˆå®ŒæˆæŠ¥å‘Š.md`
- `docs/è§„åˆ’å·¥ä½œå°commitæ¥å£å¯¹æ¥è¯´æ˜.md`
