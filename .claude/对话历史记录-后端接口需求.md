# 对话历史记录 - 后端接口需求文档

## 概述

前端需要后端提供对话历史记录的存储和恢复功能，以支持用户在多设备、多页面之间恢复对话状态。

---

## 数据模型

### 1. ConversationMessage（对话消息）

```typescript
interface ConversationMessage {
  id: string;                    // 消息唯一标识
  role: 'user' | 'assistant';    // 消息角色：用户或AI助手
  content: string;               // 消息内容（文本）
  timestamp: string;              // 时间戳（ISO 8601格式）
  metadata?: {                    // 扩展元数据（可选）
    // AI消息特有字段
    suggestedQuestions?: string[];                    // 建议的快捷回复选项
    parsedParams?: ParsedTripParams;                 // 解析出的行程参数
    showConfirmCard?: boolean;                        // 是否显示确认卡片
    responseBlocks?: PlannerResponseBlock[];           // 结构化回复内容块
    clarificationQuestions?: NLClarificationQuestion[] | string[];  // 澄清问题列表
    questionAnswers?: Record<string, string | string[] | number | boolean | null>;  // 问题答案映射
  };
}
```

### 2. NLConversation（自然语言对话会话）

```typescript
interface NLConversation {
  sessionId: string;                    // 会话唯一标识（UUID）
  userId: string;                        // 用户ID
  messages: ConversationMessage[];       // 消息列表（按时间顺序）
  conversationContext?: ConversationContext;  // 对话上下文（可选）
  partialParams?: ParsedTripParams;     // 部分解析的参数（可选）
  createdAt: string;                     // 创建时间（ISO 8601）
  updatedAt: string;                     // 更新时间（ISO 8601）
  expiresAt: string;                     // 过期时间（ISO 8601，建议24小时后）
}
```

---

## API 接口需求

### 1. 创建/更新会话（自动）

**接口**：`POST /trips/nl-conversation` 或 `PUT /trips/nl-conversation/:sessionId`

**说明**：
- 当用户发送消息时，前端会调用 `createFromNL` 接口
- 后端应该在处理消息时**自动保存**对话历史记录
- 如果请求中包含 `sessionId`，则更新现有会话；否则创建新会话

**请求参数**（在 `createFromNL` 请求中）：
```typescript
{
  text: string;
  sessionId?: string;  // 如果提供，更新现有会话；否则创建新会话
  // ... 其他字段
}
```

**后端处理逻辑**：
1. 如果 `sessionId` 存在：
   - 查找现有会话
   - 将用户消息和AI回复追加到 `messages` 数组
   - 更新 `updatedAt` 和 `expiresAt`
   - 更新 `conversationContext` 和 `partialParams`（如果有）
2. 如果 `sessionId` 不存在：
   - 创建新会话
   - 生成新的 `sessionId`（UUID）
   - 初始化 `messages` 数组
   - 设置 `createdAt`、`updatedAt`、`expiresAt`（24小时后）

**消息存储格式**：
```typescript
// 用户消息
{
  id: `user-${timestamp}`,
  role: 'user',
  content: userText,
  timestamp: new Date().toISOString(),
  metadata: {}
}

// AI回复消息
{
  id: `ai-${timestamp}`,
  role: 'assistant',
  content: response.plannerReply || '...',
  timestamp: new Date().toISOString(),
  metadata: {
    suggestedQuestions: response.suggestedQuestions,
    parsedParams: response.partialParams,
    showConfirmCard: !response.needsClarification && response.parsedParams,
    responseBlocks: response.plannerResponseBlocks,
    clarificationQuestions: response.clarificationQuestions,
    questionAnswers: {}  // 初始为空，用户回答后更新
  }
}
```

---

### 2. 获取单个会话

**接口**：`GET /trips/nl-conversation/:sessionId`

**请求**：
```
GET /trips/nl-conversation/abc123-def456-ghi789
```

**响应**：
```json
{
  "success": true,
  "data": {
    "sessionId": "abc123-def456-ghi789",
    "userId": "user123",
    "messages": [
      {
        "id": "user-1234567890",
        "role": "user",
        "content": "我想去格陵兰",
        "timestamp": "2026-01-30T10:00:00Z",
        "metadata": {}
      },
      {
        "id": "ai-1234567891",
        "role": "assistant",
        "content": "好的，让我了解一下您的需求...",
        "timestamp": "2026-01-30T10:00:01Z",
        "metadata": {
          "suggestedQuestions": ["计划几天？", "预算多少？"],
          "parsedParams": {
            "destination": "GL",
            "destinationName": "格陵兰"
          },
          "clarificationQuestions": [
            {
              "id": "q1",
              "text": "您的极地探险经验水平是？",
              "inputType": "single_choice",
              "options": ["无经验", "初级", "中级", "高级"],
              "required": true,
              "metadata": {
                "isCritical": true,
                "fieldName": "experienceLevel"
              }
            }
          ]
        }
      }
    ],
    "conversationContext": {
      // 对话上下文对象
    },
    "partialParams": {
      "destination": "GL",
      "destinationName": "格陵兰"
    },
    "createdAt": "2026-01-30T10:00:00Z",
    "updatedAt": "2026-01-30T10:05:00Z",
    "expiresAt": "2026-01-31T10:00:00Z"
  }
}
```

**错误响应**（会话不存在或已过期）：
```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "会话不存在或已过期"
  }
}
```

---

### 3. 获取用户的所有会话

**接口**：`GET /trips/nl-conversation`

**请求**：
```
GET /trips/nl-conversation
```

**响应**：
```json
{
  "success": true,
  "data": {
    "sessions": [
      {
        "sessionId": "abc123-def456-ghi789",
        "userId": "user123",
        "messages": [
          // 只返回最后一条消息（用于预览）
          {
            "id": "ai-1234567891",
            "role": "assistant",
            "content": "好的，让我了解一下您的需求...",
            "timestamp": "2026-01-30T10:00:01Z"
          }
        ],
        "partialParams": {
          "destination": "GL",
          "destinationName": "格陵兰"
        },
        "createdAt": "2026-01-30T10:00:00Z",
        "updatedAt": "2026-01-30T10:05:00Z",
        "expiresAt": "2026-01-31T10:00:00Z"
      }
    ]
  }
}
```

**说明**：
- 只返回当前用户的会话
- 可以只返回最后一条消息用于预览
- 按 `updatedAt` 倒序排列（最新的在前）

---

### 4. 更新会话上下文

**接口**：`PUT /trips/nl-conversation/:sessionId`

**请求**：
```json
{
  "sessionId": "abc123-def456-ghi789",
  "conversationContext": {
    // 更新的上下文对象
  },
  "partialParams": {
    "destination": "GL",
    "destinationName": "格陵兰",
    "startDate": "2026-06-01",
    "endDate": "2026-06-10"
  }
}
```

**响应**：
```json
{
  "success": true,
  "data": {
    "sessionId": "abc123-def456-ghi789",
    // ... 完整的会话对象
  }
}
```

**说明**：
- 用于更新会话的上下文和部分参数
- 前端在用户回答问题后可能会调用此接口更新 `questionAnswers`

---

### 5. 更新消息的问题答案

**接口**：`PUT /trips/nl-conversation/:sessionId/messages/:messageId`

**请求**：
```json
{
  "questionAnswers": {
    "q1": "中级",
    "q2": "7天",
    "q3": ["冰川徒步", "温泉体验"]
  }
}
```

**响应**：
```json
{
  "success": true,
  "data": {
    "messageId": "ai-1234567891",
    "questionAnswers": {
      "q1": "中级",
      "q2": "7天",
      "q3": ["冰川徒步", "温泉体验"]
    }
  }
}
```

**说明**：
- 用于更新特定消息的 `metadata.questionAnswers`
- 前端在用户回答问题后调用此接口

---

### 6. 删除会话

**接口**：`DELETE /trips/nl-conversation/:sessionId`

**请求**：
```
DELETE /trips/nl-conversation/abc123-def456-ghi789
```

**响应**：
```json
{
  "success": true
}
```

---

## 重要注意事项

### 1. 会话过期时间

- **建议过期时间**：24小时（从 `createdAt` 或 `updatedAt` 开始计算）
- **过期处理**：过期会话不应返回给用户，但可以保留在数据库中（用于数据分析）

### 2. 消息存储顺序

- `messages` 数组应按时间顺序排列（最早的消息在前）
- 前端依赖此顺序来正确显示对话历史

### 3. 元数据字段

- `metadata` 字段应支持任意 JSON 对象
- 前端会从 `metadata` 中恢复以下字段：
  - `suggestedQuestions`
  - `parsedParams`
  - `showConfirmCard`
  - `responseBlocks`
  - `clarificationQuestions`
  - `questionAnswers`

### 4. 用户隔离

- 所有接口都应验证用户身份
- 用户只能访问自己的会话
- `userId` 应从认证 token 中获取

### 5. 性能优化

- 获取所有会话时，可以只返回最后一条消息用于预览
- 考虑对 `messages` 数组进行分页（如果消息数量很大）
- 可以考虑对过期会话进行归档或删除

### 6. 数据一致性

- 当用户发送新消息时，应**原子性地**更新会话和消息列表
- 确保 `sessionId` 在 `createFromNL` 响应中返回，前端会保存到 `localStorage`

---

## 前端使用场景

### 场景1：页面加载时恢复会话

```typescript
// 1. 从 localStorage 读取 sessionId
const savedSessionId = localStorage.getItem('nl_conversation_session');

// 2. 调用 GET /trips/nl-conversation/:sessionId
const conversation = await tripsApi.getNLConversation(savedSessionId);

// 3. 恢复消息列表
setMessages(conversation.messages.map(msg => ({
  id: msg.id,
  role: msg.role,
  content: msg.content,
  timestamp: new Date(msg.timestamp),
  // 从 metadata 恢复其他字段
  suggestedQuestions: msg.metadata?.suggestedQuestions,
  parsedParams: msg.metadata?.parsedParams,
  // ...
})));
```

### 场景2：用户回答问题后更新

```typescript
// 用户回答问题后
const questionAnswers = {
  "q1": "中级",
  "q2": "7天"
};

// 更新消息的 questionAnswers
await tripsApi.updateNLConversation(sessionId, {
  // 或者调用 PUT /trips/nl-conversation/:sessionId/messages/:messageId
});
```

### 场景3：切换会话

```typescript
// 用户选择其他会话
const conversation = await tripsApi.getNLConversation(newSessionId);
// 恢复消息和状态
```

---

## 数据库设计建议

### 表结构

```sql
-- 会话表
CREATE TABLE nl_conversations (
  session_id VARCHAR(36) PRIMARY KEY,
  user_id VARCHAR(36) NOT NULL,
  conversation_context JSONB,
  partial_params JSONB,
  created_at TIMESTAMP NOT NULL,
  updated_at TIMESTAMP NOT NULL,
  expires_at TIMESTAMP NOT NULL,
  INDEX idx_user_id (user_id),
  INDEX idx_expires_at (expires_at)
);

-- 消息表
CREATE TABLE nl_conversation_messages (
  id VARCHAR(64) PRIMARY KEY,
  session_id VARCHAR(36) NOT NULL,
  role VARCHAR(20) NOT NULL,  -- 'user' | 'assistant'
  content TEXT NOT NULL,
  metadata JSONB,
  timestamp TIMESTAMP NOT NULL,
  FOREIGN KEY (session_id) REFERENCES nl_conversations(session_id) ON DELETE CASCADE,
  INDEX idx_session_id (session_id),
  INDEX idx_timestamp (timestamp)
);
```

---

## 总结

后端需要实现以下核心功能：

1. ✅ **自动保存对话历史**：在 `createFromNL` 接口中自动保存消息
2. ✅ **获取会话**：`GET /trips/nl-conversation/:sessionId`
3. ✅ **获取所有会话**：`GET /trips/nl-conversation`
4. ✅ **更新会话**：`PUT /trips/nl-conversation/:sessionId`
5. ✅ **删除会话**：`DELETE /trips/nl-conversation/:sessionId`
6. ✅ **会话过期**：24小时后过期
7. ✅ **用户隔离**：确保用户只能访问自己的会话

前端已经实现了所有调用逻辑，只需要后端提供这些接口即可。
