# 搜索附近功能 - 实施说明

**文档版本**: v1.0  
**创建日期**: 2026-02-06

---

## 🎯 功能位置

### 入口位置
**行程项右侧的三点菜单（⋮）**

当用户点击行程项右侧的"更多操作"按钮（三个竖点图标）时，会看到一个下拉菜单。

---

## 📋 菜单结构

### 完整菜单示例

```
┌─────────────────────────────┐
│  ⋮ (三点菜单按钮)            │
├─────────────────────────────┤
│                             │
│  🔍 搜索附近          →     │ ← 主菜单项（可展开）
│                             │
│  ────────────────────────   │ ← 分隔线
│                             │
│  ✏️ 编辑                     │
│  🔄 替换                     │
│  🗑️ 删除                     │
└─────────────────────────────┘
```

### 展开后的子菜单

当鼠标悬停在"搜索附近"上时，右侧会展开子菜单：

```
┌─────────────────────────────┐     ┌─────────────────────┐
│  ⋮ (三点菜单按钮)            │     │  ⭐ 景点            │
├─────────────────────────────┤     │  🍽️ 餐厅            │
│                             │     │  🏨 酒店            │
│  🔍 搜索附近          →     │ →   │  ☕ 休息点           │
│                             │     │  ⛽ 加油站          │
│  ────────────────────────   │     └─────────────────────┘
│                             │
│  ✏️ 编辑                     │
│  🔄 替换                     │
│  🗑️ 删除                     │
└─────────────────────────────┘
```

---

## 🎨 视觉设计细节

### 主菜单项样式
- **图标**：📍 MapPin（蓝色 #3b82f6）
- **文字**："搜索附近"（加粗）
- **右侧**：右箭头（ChevronRight）表示可展开
- **悬停效果**：背景色变浅灰色

### 子菜单项样式

每个类别使用不同颜色的图标：

| 类别 | 图标 | 颜色 | 文字 |
|------|------|------|------|
| 景点 | ⭐ Star | 金色 #f59e0b | 景点 |
| 餐厅 | 🍽️ Utensils | 红色 #ef4444 | 餐厅 |
| 酒店 | 🏨 Hotel | 紫色 #9333ea | 酒店 |
| 休息点 | ☕ Coffee | 棕色 #a16207 | 休息点 |
| 加油站 | ⛽ Fuel | 绿色 #10b981 | 加油站 |

### 禁用状态
- 如果行程点没有坐标信息：
  - 主菜单项和所有子菜单项显示为灰色（opacity: 0.5）
  - 主菜单项显示"（需坐标）"提示
  - 点击时显示错误提示

---

## 🔍 如何查看功能

### 步骤 1：找到行程项
1. 打开规划工作台页面
2. 切换到"行程"标签页
3. 找到任意一个行程项（如"辛格维利尔国家公园"）

### 步骤 2：打开菜单
1. 在行程项右侧找到三个竖点图标（⋮）
2. 点击该图标

### 步骤 3：查看"搜索附近"
1. 在菜单顶部应该能看到"搜索附近"选项
2. 右侧有一个右箭头（→）表示可以展开

### 步骤 4：展开子菜单
1. 将鼠标悬停在"搜索附近"上
2. 右侧会展开子菜单，显示5个类别选项

### 步骤 5：选择类别
1. 点击任意类别（如"餐厅"）
2. 会打开搜索对话框
3. 自动搜索该类别附近的地点

---

## ⚠️ 故障排查

### 如果看不到"搜索附近"选项

**可能原因 1**：`onSearchNearby` prop 未传递
- **检查**：确认 `ScheduleTab.tsx` 中 `ItineraryItemRow` 组件是否传递了 `onSearchNearby={handleSearchNearby}`
- **位置**：`src/pages/plan-studio/ScheduleTab.tsx` 第 1131 行

**可能原因 2**：`place` 为 null
- **检查**：确认行程项是否有 `Place` 数据
- **解决**：代码已优化，即使 `place` 为 null 也会显示菜单（但会禁用）

**可能原因 3**：浏览器缓存
- **解决**：硬刷新浏览器（Ctrl+Shift+R 或 Cmd+Shift+R）

### 如果子菜单不展开

**可能原因**：Radix UI 子菜单组件问题
- **检查**：确认是否正确导入了 `DropdownMenuSub`, `DropdownMenuSubTrigger`, `DropdownMenuSubContent`
- **位置**：`src/components/plan-studio/ItineraryItemRow.tsx` 第 19-26 行

---

## 🧪 测试步骤

### 测试用例 1：正常流程
1. ✅ 打开行程项菜单
2. ✅ 看到"搜索附近"选项
3. ✅ 悬停展开子菜单
4. ✅ 点击"餐厅"类别
5. ✅ 打开搜索对话框
6. ✅ 自动搜索附近餐厅

### 测试用例 2：无坐标情况
1. ✅ 打开没有坐标的行程项菜单
2. ✅ 看到"搜索附近"选项（灰色）
3. ✅ 显示"（需坐标）"提示
4. ✅ 子菜单项均为禁用状态

### 测试用例 3：移动端
1. ✅ 在移动设备上打开菜单
2. ✅ 点击"搜索附近"展开子菜单
3. ✅ 点击类别选项执行搜索

---

## 📝 代码检查清单

- [x] `ItineraryItemRow.tsx` 中导入了子菜单组件
- [x] `ItineraryItemRow.tsx` 中创建了子菜单结构
- [x] `ScheduleTab.tsx` 中传递了 `onSearchNearby` prop
- [x] `ScheduleTab.tsx` 中实现了 `handleSearchNearby` 函数
- [x] `EnhancedAddItineraryItemDialog.tsx` 支持 `initialCategory` prop
- [x] 所有类别选项都有对应的图标和颜色

---

## 🎯 下一步

如果功能仍然不可见，请：
1. 检查浏览器控制台是否有错误
2. 确认开发服务器是否正在运行
3. 尝试硬刷新浏览器
4. 检查网络请求是否正常

---

**文档结束**
