# Planning Assistant V2 逻辑问题检查报告

**检查时间**: 2026-02-08  
**检查角色**: 产品经理  
**检查范围**: Planning Assistant V2 核心逻辑

---

## 🔴 严重问题（需要立即修复）

### 1. **消息清空逻辑问题** ⚠️

**位置**: `src/hooks/useChatV2.ts:199-204`

**问题描述**:
```typescript
// 当 sessionId 变化时，清空消息
useEffect(() => {
  if (sessionId) {
    setMessages([]);
  }
}, [sessionId]);
```

**问题**:
- 当 `sessionId` 从 `null` 变为有值时，会清空消息（这是合理的）
- 但当 `sessionId` 从一个值变为另一个值时，也会清空消息（这可能不合理）
- 如果用户在同一个组件中切换会话，会丢失之前的对话历史

**影响**: 
- 用户体验：切换会话时丢失对话历史
- 数据一致性：可能导致用户困惑

**建议修复**:
```typescript
// 只在 sessionId 从 null 变为有值时清空，或者保留历史
const prevSessionIdRef = useRef<string | null>(null);
useEffect(() => {
  // 只在 sessionId 从 null 变为有值时清空
  if (sessionId && !prevSessionIdRef.current) {
    setMessages([]);
  }
  prevSessionIdRef.current = sessionId;
}, [sessionId]);
```

---

### 2. **推荐和方案数据提取逻辑不完整** ⚠️

**位置**: `src/components/planning-assistant-v2/PlanningAssistant.tsx:76-107`

**问题描述**:
```typescript
// 只从最新的 AI 消息中提取推荐数据
const latestMessage = messages
  .filter(m => m.role === 'assistant')
  .slice(-1)[0];

if (latestMessage?.recommendations && latestMessage.recommendations.length > 0) {
  setRecommendationsFromMessages(latestMessage.recommendations);
} else {
  setRecommendationsFromMessages([]);
}
```

**问题**:
- 只从**最新一条** AI 消息中提取推荐/方案数据
- 如果用户有多轮对话，之前的推荐/方案数据会被清空
- 用户可能期望看到**所有历史**的推荐和方案

**影响**:
- 用户体验：用户无法查看之前的推荐/方案
- 功能完整性：推荐和方案标签页可能显示为空

**建议修复**:
```typescript
// 累积所有消息中的推荐和方案数据
useEffect(() => {
  const allRecommendations: any[] = [];
  const allPlans: any[] = [];
  
  messages
    .filter(m => m.role === 'assistant')
    .forEach(msg => {
      if (msg.recommendations?.length) {
        allRecommendations.push(...msg.recommendations);
      }
      if (msg.plans?.length) {
        allPlans.push(...msg.plans);
      }
    });
  
  setRecommendationsFromMessages(allRecommendations);
  setPlansFromMessages(allPlans);
}, [messages]);
```

---

### 3. **onSendMessageReady 依赖可能导致无限循环** ⚠️

**位置**: `src/components/planning-assistant-v2/PlanningAssistant.tsx:69-74`

**问题描述**:
```typescript
useEffect(() => {
  if (onSendMessageReady && sessionId) {
    onSendMessageReady(sendMessage);
  }
}, [onSendMessageReady, sendMessage, sessionId]);
```

**问题**:
- `sendMessage` 函数每次渲染都可能变化（如果 `useChatV2` 没有用 `useCallback` 包装）
- 如果 `onSendMessageReady` 每次渲染都变化，会导致频繁调用
- 可能导致父组件频繁重新渲染

**影响**:
- 性能：可能导致不必要的重新渲染
- 稳定性：可能导致无限循环

**建议修复**:
```typescript
// 使用 useRef 存储 sendMessage，避免依赖变化
const sendMessageRef = useRef(sendMessage);
useEffect(() => {
  sendMessageRef.current = sendMessage;
}, [sendMessage]);

useEffect(() => {
  if (onSendMessageReady && sessionId) {
    onSendMessageReady(sendMessageRef.current);
  }
}, [onSendMessageReady, sessionId]); // 移除 sendMessage 依赖
```

---

## 🟡 中等问题（建议修复）

### 4. **错误处理不完善**

**位置**: `src/hooks/useChatV2.ts:160-163`

**问题描述**:
```typescript
onError: (error) => {
  console.error('发送消息失败:', error);
  // 可以在这里添加错误消息到对话列表
},
```

**问题**:
- 发送消息失败时，用户消息已经通过 `onMutate` 添加到消息列表
- 但错误没有显示给用户，用户可能不知道消息发送失败
- 应该回滚用户消息或显示错误提示

**建议修复**:
```typescript
onError: (error, variables, context) => {
  console.error('发送消息失败:', error);
  // 回滚乐观更新：移除最后一条用户消息
  setMessages((prev) => prev.slice(0, -1));
  // 添加错误消息
  const errorMessage: ChatMessage = {
    id: generateMessageId(),
    role: 'assistant',
    content: '抱歉，消息发送失败，请稍后重试',
    timestamp: new Date(),
  };
  setMessages((prev) => [...prev, errorMessage]);
},
```

---

### 5. **会话创建可能重复**

**位置**: `src/components/planning-assistant-v2/PlanningAssistant.tsx:130-135`

**问题描述**:
```typescript
useEffect(() => {
  if (!sessionId && !sessionLoading) {
    createSession(userId);
  }
}, [sessionId, sessionLoading, userId, createSession]);
```

**问题**:
- 如果 `createSession` 是异步的，在创建过程中 `sessionLoading` 可能还是 `false`
- 可能导致多次调用 `createSession`
- 需要检查 `usePlanningSessionV2` 是否有防重复机制

**建议**: 
- 检查 `usePlanningSessionV2` 的实现，确保有防重复创建的逻辑
- 或者添加本地状态来跟踪是否正在创建会话

---

### 6. **规划工作台场景的上下文传递逻辑**

**位置**: `src/components/planning-assistant-v2/PlanningAssistantSidebar.tsx:88-90`

**问题描述**:
```typescript
// destination 格式可能是 "IS" 或 "IS, Reykjavik"
// 提取第一部分作为 countryCode
const destinationParts = trip.destination?.split(',') || [];
const code = destinationParts[0]?.trim().toUpperCase() || null;
```

**问题**:
- 如果 `destination` 是 "Iceland" 而不是 "IS"，提取的 `countryCode` 会是 "ICELAND"
- 这可能导致 API 调用失败或返回错误结果
- 需要更健壮的国家代码提取逻辑

**建议**:
- 使用国家代码映射表
- 或者从 `trip` 的其他字段获取国家代码
- 或者让后端返回标准化的国家代码

---

## 🟢 轻微问题（可选优化）

### 7. **QuickActions 显示逻辑**

**位置**: `src/components/planning-assistant-v2/ChatPanel.tsx:136-144`

**问题描述**:
```typescript
{messages.length === 0 && (
  <div className="px-2 pb-4">
    <QuickActions
      onAction={sendMessage}
      destination={destination}
      disabled={isLoading || !sessionId}
    />
  </div>
)}
```

**问题**:
- 当 `messages.length === 0` 时显示快捷操作
- 但如果用户发送了消息但 AI 还没回复，`messages.length` 可能为 1（只有用户消息）
- 此时快捷操作会隐藏，用户可能无法快速操作

**建议**: 
- 考虑在用户发送第一条消息后也显示快捷操作
- 或者根据是否有 AI 回复来判断

---

### 8. **推荐和方案标签页的显示逻辑**

**位置**: `src/components/planning-assistant-v2/PlanningAssistant.tsx`

**问题描述**:
- 推荐和方案标签页始终显示，即使没有数据
- 用户点击空标签页可能感到困惑

**建议**:
- 只在有数据时显示标签页
- 或者显示空状态提示

---

## 📋 总结

### 优先级排序：

1. **🔴 高优先级**（影响核心功能）:
   - 消息清空逻辑问题（#1）
   - 推荐和方案数据提取逻辑（#2）
   - onSendMessageReady 依赖问题（#3）

2. **🟡 中优先级**（影响用户体验）:
   - 错误处理不完善（#4）
   - 会话创建可能重复（#5）
   - 规划工作台场景的上下文传递逻辑（#6）

3. **🟢 低优先级**（可选优化）:
   - QuickActions 显示逻辑（#7）
   - 推荐和方案标签页的显示逻辑（#8）

### 建议修复顺序：

1. 先修复 #1、#2、#3（核心逻辑问题）
2. 然后修复 #4、#5、#6（用户体验问题）
3. 最后优化 #7、#8（界面优化）

---

**检查人**: AI 产品经理  
**下一步**: 开发团队根据优先级修复问题
