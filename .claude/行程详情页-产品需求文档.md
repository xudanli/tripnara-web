# 行程详情页 - 产品需求文档（PRD）

## 文档信息

- **创建日期**: 2026-02-05
- **版本**: v2.0
- **状态**: 待评审
- **优先级**: P0（高优先级）
- **负责人**: 产品经理

---

## 一、需求背景

### 1.1 业务目标

行程详情页是用户管理行程的核心页面，承载以下关键业务目标：

1. **行程状态可视化**：让用户快速了解行程的整体健康状态
2. **问题发现与解决**：帮助用户识别并解决行程中的潜在问题
3. **决策支持**：提供数据驱动的决策建议，提升行程质量
4. **操作效率**：减少用户操作步骤，提高规划效率

### 1.2 用户痛点

基于当前实现和用户反馈，存在以下痛点：

1. **信息不一致**：头部健康度显示79%，但侧边栏显示100/100，用户困惑
2. **信息过载**：多个健康度指标分散在不同位置，缺乏统一展示
3. **操作路径不清晰**：改进建议、Auto综合等功能入口分散
4. **视觉层次混乱**：关键信息（健康度、建议）不够突出
5. **缺乏上下文**：指标定义不清晰，用户不理解分数的含义

---

## 一、用户故事（User Stories）

### 1.1 用户故事概览

行程详情页需要支持四种行程状态，每种状态下的用户需求和使用场景不同：

| 状态 | 中文名称 | 英文名称 | 用户目标 | 核心功能 |
|------|---------|---------|---------|---------|
| **PLANNING** | 规划中 | Planning | 完善行程规划，优化行程质量 | 健康度分析、改进建议、Auto综合优化 |
| **IN_PROGRESS** | 进行中 | In Progress | 实时跟踪行程执行，应对突发情况 | 实时状态、执行记录、应急调整 |
| **COMPLETED** | 已完成 | Completed | 回顾行程，总结经验 | 复盘报告、数据分析、经验沉淀 |
| **CANCELLED** | 已取消 | Cancelled | 查看历史记录，了解取消原因 | 只读展示、历史记录 |

---

### 1.2 规划中（PLANNING）状态用户故事

#### 用户故事 1.1：作为规划者，我想了解行程的整体健康状态

**故事描述**：
- **作为** 一个正在规划行程的用户
- **我想** 快速了解行程的整体健康状态
- **以便** 判断行程是否已经可以执行，或者还需要进一步优化

**验收标准**：
- ✅ 页面顶部显示统一的健康度分数（0-100）
- ✅ 健康度通过颜色编码（绿色≥80%、黄色60-79%、红色<60%）
- ✅ 显示4个维度指标：可执行度、缓冲、风险、成本
- ✅ 点击指标可以查看详细说明

**功能优先级**：P0

---

#### 用户故事 1.2：作为规划者，我想了解健康度指标的具体含义

**故事描述**：
- **作为** 一个正在规划行程的用户
- **我想** 了解每个健康度指标的具体含义和计算方法
- **以便** 理解为什么健康度是这个分数，以及如何改进

**验收标准**：
- ✅ 点击健康度指标（如"可执行度"）可以查看详细说明
- ✅ 详细说明包含：定义、计算方法、理想范围、当前状态分析
- ✅ 说明内容用户友好，避免技术术语

**功能优先级**：P0

---

#### 用户故事 1.3：作为规划者，我想查看并应用改进建议

**故事描述**：
- **作为** 一个正在规划行程的用户
- **我想** 查看系统提供的改进建议
- **以便** 快速优化行程，提升健康度

**验收标准**：
- ✅ 右侧助手中心显示所有改进建议
- ✅ 建议按人格（Abu风险、Dr.Dre节奏、Neptune修复）分类
- ✅ 建议显示严重程度（红线/警告/提示）
- ✅ 可以一键应用单个建议
- ✅ 应用前显示确认弹窗（显示变更预览）
- ✅ 应用后显示变更摘要

**功能优先级**：P0

---

#### 用户故事 1.4：作为规划者，我想一键优化整个行程

**故事描述**：
- **作为** 一个正在规划行程的用户
- **我想** 一键应用所有高优先级建议
- **以便** 快速提升行程整体健康度

**验收标准**：
- ✅ 页面顶部显示"Auto 综合"按钮
- ✅ 点击按钮显示确认弹窗（显示将应用的建议列表）
- ✅ 确认后执行优化，显示优化结果
- ✅ 优化结果包含：整体健康度变化、各维度指标变化

**功能优先级**：P0

---

#### 用户故事 1.5：作为规划者，我想查看每日行程概览

**故事描述**：
- **作为** 一个正在规划行程的用户
- **我想** 查看每日行程的路线概览
- **以便** 快速了解每天的行程安排和健康状态

**验收标准**：
- ✅ 主内容区域显示每日行程卡片列表
- ✅ 每个卡片显示：日期、路线（起点→终点）、行程项数量、每日健康度、每日预算
- ✅ 支持点击"查看行程"查看详细行程项
- ✅ 支持点击"添加行程项"快速添加

**功能优先级**：P0

---

#### 用户故事 1.6：作为规划者，我想进入规划工作台进行详细规划

**故事描述**：
- **作为** 一个正在规划行程的用户
- **我想** 进入规划工作台
- **以便** 进行更详细的行程规划（时间调整、行程项编辑等）

**验收标准**：
- ✅ 页面顶部显示"进入规划工作台"按钮
- ✅ 点击按钮跳转到规划工作台，携带当前行程ID
- ✅ 规划工作台支持返回行程详情页

**功能优先级**：P0

---

### 1.3 进行中（IN_PROGRESS）状态用户故事

#### 用户故事 2.1：作为执行者，我想查看行程的实时状态

**故事描述**：
- **作为** 一个正在执行行程的用户
- **我想** 查看行程的实时状态
- **以便** 了解当前进度和下一步安排

**验收标准**：
- ✅ 页面显示"执行"标签页（仅在IN_PROGRESS或COMPLETED状态显示）
- ✅ 执行标签页显示：当前日期、当前行程项、下一步安排
- ✅ 支持标记行程项为"已完成"
- ✅ 支持记录实际执行时间

**功能优先级**：P0

---

#### 用户故事 2.2：作为执行者，我想记录行程中的实际变更

**故事描述**：
- **作为** 一个正在执行行程的用户
- **我想** 记录行程中的实际变更（如时间调整、行程项取消等）
- **以便** 保持行程记录的准确性

**验收标准**：
- ✅ 执行标签页支持编辑行程项
- ✅ 支持调整行程项时间
- ✅ 支持取消或跳过行程项
- ✅ 变更记录保存到执行日志

**功能优先级**：P1

---

#### 用户故事 2.3：作为执行者，我想查看健康度变化趋势

**故事描述**：
- **作为** 一个正在执行行程的用户
- **我想** 查看健康度的变化趋势
- **以便** 了解行程执行过程中的质量变化

**验收标准**：
- ✅ 健康度区域显示历史趋势图（可选）
- ✅ 支持查看每日健康度变化
- ✅ 支持查看指标变化原因

**功能优先级**：P1

---

#### 用户故事 2.4：作为执行者，我想应对突发情况

**故事描述**：
- **作为** 一个正在执行行程的用户
- **我想** 在遇到突发情况时快速调整行程
- **以便** 保证行程的顺利进行

**验收标准**：
- ✅ 支持快速添加应急行程项
- ✅ 支持快速调整后续行程项时间
- ✅ 系统提供应急建议（如天气变化、交通延误等）

**功能优先级**：P1

---

### 1.4 已完成（COMPLETED）状态用户故事

#### 用户故事 3.1：作为完成者，我想查看行程复盘报告

**故事描述**：
- **作为** 一个已完成行程的用户
- **我想** 查看行程复盘报告
- **以便** 了解行程执行情况和经验总结

**验收标准**：
- ✅ 页面显示"复盘"标签页（仅在COMPLETED状态显示）
- ✅ 复盘标签页显示：行程总结、执行统计、健康度分析
- ✅ 显示计划vs实际的对比分析
- ✅ 显示经验教训和建议

**功能优先级**：P0

---

#### 用户故事 3.2：作为完成者，我想查看行程数据分析

**故事描述**：
- **作为** 一个已完成行程的用户
- **我想** 查看行程的详细数据分析
- **以便** 了解行程的各个方面表现

**验收标准**：
- ✅ 复盘报告包含：时间分析、预算分析、节奏分析、可达性分析
- ✅ 支持查看每日执行情况
- ✅ 支持查看健康度历史趋势
- ✅ 支持导出复盘报告（可选）

**功能优先级**：P1

---

#### 用户故事 3.3：作为完成者，我想保存行程经验

**故事描述**：
- **作为** 一个已完成行程的用户
- **我想** 保存行程经验
- **以便** 为未来的行程规划提供参考

**验收标准**：
- ✅ 支持添加行程笔记和心得
- ✅ 支持标记"值得推荐"的行程项
- ✅ 支持保存为模板（可选）

**功能优先级**：P2

---

### 1.5 已取消（CANCELLED）状态用户故事

#### 用户故事 4.1：作为查看者，我想查看已取消行程的历史记录

**故事描述**：
- **作为** 一个查看已取消行程的用户
- **我想** 查看行程的历史记录
- **以便** 了解为什么行程被取消，以及当时的规划情况

**验收标准**：
- ✅ 页面以只读模式展示（不支持编辑）
- ✅ 显示行程基本信息（名称、日期、目的地等）
- ✅ 显示取消时间（如果有）
- ✅ 显示取消时的健康度状态（如果有）
- ✅ 显示"此行程已取消"的明确提示

**功能优先级**：P0

---

#### 用户故事 4.2：作为查看者，我想了解取消原因

**故事描述**：
- **作为** 一个查看已取消行程的用户
- **我想** 了解行程被取消的原因
- **以便** 避免未来出现类似问题

**验收标准**：
- ✅ 如果记录了取消原因，显示取消原因
- ✅ 如果没有记录取消原因，显示"原因未记录"
- ✅ 支持查看取消前的行程规划（只读）

**功能优先级**：P1

---

### 1.6 状态转换用户故事

#### 用户故事 5.1：作为规划者，我想开始执行行程

**故事描述**：
- **作为** 一个规划中的行程用户
- **我想** 将行程状态改为"进行中"
- **以便** 开始实际执行行程

**验收标准**：
- ✅ 状态菜单显示"开始执行行程"选项
- ✅ 点击后显示确认弹窗（说明状态转换的影响）
- ✅ 确认后状态改为IN_PROGRESS
- ✅ 状态转换后显示"执行"标签页
- ✅ 状态转换不可撤销（无法返回PLANNING）

**功能优先级**：P0

---

#### 用户故事 5.2：作为执行者，我想完成行程

**故事描述**：
- **作为** 一个进行中的行程用户
- **我想** 将行程状态改为"已完成"
- **以便** 结束行程并查看复盘报告

**验收标准**：
- ✅ 状态菜单显示"完成行程"选项
- ✅ 点击后显示确认弹窗（说明状态转换的影响）
- ✅ 确认后状态改为COMPLETED
- ✅ 状态转换后显示"复盘"标签页
- ✅ 状态转换不可撤销（无法返回IN_PROGRESS）

**功能优先级**：P0

---

#### 用户故事 5.3：作为用户，我想取消行程

**故事描述**：
- **作为** 一个规划中或进行中的行程用户
- **我想** 取消行程
- **以便** 标记行程为已取消状态

**验收标准**：
- ✅ 状态菜单显示"取消行程"选项
- ✅ 点击后显示确认弹窗（说明取消的影响）
- ✅ 确认后状态改为CANCELLED
- ✅ 状态转换后页面变为只读模式
- ✅ 状态转换不可撤销（无法恢复）

**功能优先级**：P0

---

### 1.7 跨状态通用用户故事

#### 用户故事 6.1：作为用户，我想查看行程基本信息

**故事描述**：
- **作为** 任何状态的行程用户
- **我想** 查看行程的基本信息（名称、日期、目的地等）
- **以便** 快速了解行程概况

**验收标准**：
- ✅ 页面顶部显示行程名称
- ✅ 显示行程日期范围
- ✅ 显示目的地信息
- ✅ 显示行程状态徽章
- ✅ 显示节奏和交通方式

**功能优先级**：P0

---

#### 用户故事 6.2：作为用户，我想编辑行程基本信息

**故事描述**：
- **作为** 规划中或进行中的行程用户
- **我想** 编辑行程的基本信息
- **以便** 更新行程信息

**验收标准**：
- ✅ 支持编辑行程名称、日期、目的地等
- ✅ 编辑后保存到后端
- ✅ 已取消和已完成的行程不支持编辑（只读）

**功能优先级**：P0

---

#### 用户故事 6.3：作为用户，我想分享行程

**故事描述**：
- **作为** 任何状态的行程用户
- **我想** 分享行程给其他人
- **以便** 让其他人查看或协作

**验收标准**：
- ✅ 支持生成分享链接
- ✅ 支持设置分享权限（查看/编辑）
- ✅ 支持邀请协作者（可选）

**功能优先级**：P1

---

#### 用户故事 6.4：作为用户，我想删除行程

**故事描述**：
- **作为** 任何状态的行程用户
- **我想** 删除行程
- **以便** 清理不需要的行程记录

**验收标准**：
- ✅ 支持删除行程（需要确认）
- ✅ 删除前显示确认弹窗（说明删除的影响）
- ✅ 删除后行程从列表中移除
- ✅ 删除操作不可撤销

**功能优先级**：P1

---

## 二、功能需求

---

## 二、功能需求

### 2.1 核心功能清单

| 功能模块 | 功能点 | 优先级 | 状态 |
|---------|--------|--------|------|
| **健康度展示** | 统一健康度计算与展示 | P0 | 🆕 重构 |
| | 健康度指标详细说明 | P0 | 🆕 新增 |
| | 健康度历史趋势 | P1 | 待规划 |
| **改进建议** | 建议列表展示 | P0 | ✅ 已有 |
| | 建议应用（一键优化） | P0 | 🆕 新增 |
| | 建议预览 | P0 | ✅ 已有 |
| **每日行程概览** | 路线骨架图 | P0 | ✅ 已有 |
| | 每日健康度 | P1 | 🆕 新增 |
| | 快速操作入口 | P0 | ✅ 已有 |
| **预算管理** | 预算概览 | P0 | ✅ 已有 |
| | 预算预警 | P0 | ✅ 已有 |
| **操作入口** | Auto综合优化 | P0 | 🆕 新增 |
| | 规划工作台入口 | P0 | ✅ 已有 |

---

## 三、详细需求

### 3.1 健康度展示模块

#### 3.1.1 统一健康度计算

**需求描述**：
- 统一健康度计算逻辑，确保头部和侧边栏显示一致
- 健康度 = 加权平均（可执行度×40% + 缓冲×20% + (100-风险)×30% + 成本×10%）

**验收标准**：
- ✅ 头部和侧边栏的健康度数值一致
- ✅ 健康度计算逻辑清晰可追溯
- ✅ 支持健康度历史记录（可选）

#### 3.1.2 健康度指标详细说明

**需求描述**：
- 每个指标（可执行度、缓冲、风险、成本）提供详细说明
- 说明包括：定义、计算方法、理想范围、当前状态分析
- 支持点击指标查看详细说明（弹窗或侧边栏）

**交互设计**：
- 点击指标图标/文字 → 显示详细说明弹窗
- 弹窗包含：指标定义、计算公式、参数说明、当前状态分析

**验收标准**：
- ✅ 所有指标都有详细说明
- ✅ 说明内容用户友好，避免技术术语
- ✅ 支持快速关闭和返回

#### 3.1.3 健康度可视化

**需求描述**：
- 使用统一的视觉语言展示健康度
- 支持颜色编码：绿色（≥80%）、黄色（60-79%）、红色（<60%）
- 支持进度条、环形图等多种展示方式

**验收标准**：
- ✅ 视觉层次清晰，关键信息突出
- ✅ 颜色使用符合无障碍设计标准
- ✅ 支持暗色模式（可选）

---

### 3.2 改进建议模块

#### 3.2.1 建议列表展示

**需求描述**：
- 在右侧助手中心统一展示所有建议
- 支持按人格（Abu、Dr.Dre、Neptune）筛选
- 支持按优先级（高、中、低）排序
- 显示建议数量统计

**当前状态**：✅ 已实现

**优化需求**：
- 建议卡片信息更丰富（显示影响范围、预期改善）
- 支持批量操作（批量应用建议）

#### 3.2.2 建议应用（一键优化）

**需求描述**：
- 支持一键应用单个建议
- 支持批量应用多个建议（Auto综合）
- 应用后显示变更摘要（哪些指标改善了多少）

**交互流程**：
1. 用户点击"应用建议"按钮
2. 显示确认弹窗（显示变更预览）
3. 用户确认后，调用后端接口应用建议
4. 显示成功提示和变更摘要
5. 刷新健康度数据

**验收标准**：
- ✅ 应用建议操作流畅，有明确的反馈
- ✅ 变更摘要清晰，用户能理解发生了什么
- ✅ 支持撤销操作（可选）

#### 3.2.3 建议预览

**需求描述**：
- 在应用建议前，支持预览变更效果
- 预览显示：指标变化、行程项变化、健康度变化

**当前状态**：✅ 已实现（SuggestionPreviewDialog）

**优化需求**：
- 预览信息更详细（显示具体哪些行程项会变化）
- 支持对比视图（变更前 vs 变更后）

---

### 3.3 每日行程概览模块

#### 3.3.1 路线骨架图

**需求描述**：
- 展示每日行程的路线概览
- 显示：起点→终点、行程项数量、当日预算、健康度

**当前状态**：✅ 已实现（DayItineraryCard）

**优化需求**：
- 支持地图视图（可选）
- 支持时间轴视图（可选）
- 每日健康度更醒目

#### 3.3.2 每日健康度

**需求描述**：
- 为每日行程计算健康度
- 健康度基于：缓冲时间、冲突数量、步行距离等
- 在每日卡片中显示健康度徽章

**验收标准**：
- ✅ 每日健康度计算准确
- ✅ 健康度徽章清晰可见
- ✅ 支持点击查看详细分析

---

### 3.4 操作入口模块

#### 3.4.1 Auto综合优化

**需求描述**：
- 一键应用所有高优先级建议
- 优化多个维度（时间、预算、节奏、可达性）
- 显示优化前后的对比

**交互流程**：
1. 用户点击"Auto 综合"按钮
2. 显示确认弹窗（显示将应用的建议列表）
3. 用户确认后，调用后端接口执行优化
4. 显示优化结果（指标变化、变更摘要）
5. 刷新页面数据

**验收标准**：
- ✅ Auto综合操作流畅，有明确的反馈
- ✅ 优化结果清晰，用户能理解发生了什么
- ✅ 支持撤销操作（可选）

#### 3.4.2 规划工作台入口

**需求描述**：
- 提供快速入口跳转到规划工作台
- 支持携带上下文（当前行程ID、当前Tab等）

**当前状态**：✅ 已实现

**优化需求**：
- 入口更醒目
- 支持快捷键（可选）

---

## 四、数据需求

### 4.1 健康度数据

**数据来源**：`GET /api/trip-detail/:tripId/health`

**数据结构**：
```typescript
{
  tripId: string;
  overall: 'healthy' | 'warning' | 'critical';
  overallScore: number; // 0-100，统一计算
  dimensions: {
    schedule: DimensionStatusExtended;
    budget: DimensionStatusExtended;
    pace: DimensionStatusExtended;
    feasibility: DimensionStatusExtended;
  };
  lastUpdated: string;
}
```

**数据更新频率**：
- 实时计算（行程变更时）
- 缓存5-10分钟

### 4.2 改进建议数据

**数据来源**：`GET /api/trip-detail/:tripId/suggestions`

**数据结构**：见 API 文档

**数据更新频率**：
- 实时计算（行程变更时）
- 缓存5-10分钟

### 4.3 每日行程数据

**数据来源**：`GET /api/trip-detail/:tripId/days`

**数据结构**：见 API 文档

**数据更新频率**：
- 实时计算（行程变更时）

---

## 五、交互需求

### 5.1 页面布局

**布局结构**：
```
┌─────────────────────────────────────────────────────────┐
│ Header: 行程名称、状态、操作按钮                          │
├─────────────────────────────────────────────────────────┤
│ Health Bar: 健康度（统一展示）                          │
├─────────────────────────────────────────────────────────┤
│ Suggestion Banner: 建议提示（如有）                      │
├──────────────────────────┬──────────────────────────────┤
│                          │                              │
│ Main Content:            │ Sidebar:                     │
│ - Tabs (总览/规划/预算)  │ - 健康度详情                 │
│ - 每日行程卡片列表        │ - 预算概览                   │
│                          │ - 助手中心（建议列表）        │
│                          │                              │
└──────────────────────────┴──────────────────────────────┘
```

**响应式设计**：
- 桌面端：左右分栏布局
- 移动端：上下堆叠布局，侧边栏可收起

### 5.2 关键交互流程

#### 5.2.1 查看健康度详情

1. 用户点击健康度指标（如"可执行度"）
2. 显示详细说明弹窗
3. 弹窗包含：定义、计算方法、当前状态分析
4. 用户点击关闭或外部区域关闭弹窗

#### 5.2.2 应用改进建议

1. 用户在助手中心看到建议
2. 用户点击"应用建议"按钮
3. 显示确认弹窗（显示变更预览）
4. 用户确认后，调用后端接口
5. 显示成功提示和变更摘要
6. 刷新健康度数据

#### 5.2.3 Auto综合优化

1. 用户点击"Auto 综合"按钮
2. 显示确认弹窗（显示将应用的建议列表）
3. 用户确认后，调用后端接口
4. 显示优化结果（指标变化、变更摘要）
5. 刷新页面数据

---

## 六、非功能需求

### 6.1 性能要求

- 页面首次加载时间 < 2秒
- 健康度计算响应时间 < 500ms
- 建议列表加载时间 < 1秒
- 应用建议操作响应时间 < 2秒

### 6.2 可用性要求

- 支持键盘导航（Tab键切换焦点）
- 支持屏幕阅读器（ARIA标签）
- 支持暗色模式（可选）

### 6.3 兼容性要求

- 支持 Chrome、Safari、Firefox 最新版本
- 支持移动端浏览器（iOS Safari、Chrome Mobile）
- 支持响应式布局（桌面端、平板、移动端）

---

## 七、验收标准

### 7.1 功能验收

- ✅ 健康度计算统一，头部和侧边栏显示一致
- ✅ 所有指标都有详细说明
- ✅ 改进建议可以一键应用
- ✅ Auto综合优化功能正常
- ✅ 每日行程概览显示正确

### 7.2 交互验收

- ✅ 页面布局清晰，信息层次分明
- ✅ 关键操作（应用建议、Auto综合）流程顺畅
- ✅ 错误处理和加载状态正确

### 7.3 视觉验收

- ✅ 视觉设计符合设计规范
- ✅ 颜色使用符合无障碍标准
- ✅ 响应式布局正常

---

## 八、后续规划

### 8.1 短期优化（1-2周）

1. 统一健康度计算逻辑
2. 添加指标详细说明
3. 优化建议应用流程
4. 添加Auto综合优化功能

### 8.2 中期优化（1-2月）

1. 健康度历史趋势图
2. 批量操作建议
3. 建议对比视图
4. 地图视图集成

### 8.3 长期规划（3-6月）

1. AI智能推荐优化
2. 行程质量评分系统
3. 用户行为分析
4. 个性化建议

---

## 九、相关文档

- [行程详情页改版 - 后端接口需求文档](./trip-detail-enhancement.md)
- [行程详情页 - HCI/UX/视觉设计重构方案](./行程详情页-设计重构方案.md)

---

**文档状态**: ✅ 已完成  
**下一步**: 
1. 产品评审会议
2. 设计团队评审
3. 开发团队评审
4. 开始实施
