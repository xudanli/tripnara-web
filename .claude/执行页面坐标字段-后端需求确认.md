# æ‰§è¡Œé¡µé¢åæ ‡å­—æ®µ - åç«¯éœ€æ±‚ç¡®è®¤

**æ—¥æœŸ**: 2026-02-05  
**é—®é¢˜**: `nextStop.Place` ç¼ºå°‘ç»çº¬åº¦å­—æ®µ  
**ä¼˜å…ˆçº§**: P0

---

## âœ… ä¸€ã€é—®é¢˜ç¡®è®¤

### 1.1 å½“å‰æƒ…å†µ

**å‰ç«¯æ¥æ”¶çš„æ•°æ®** (`GET /api/trips/:id/state` å“åº”):
```typescript
{
  nextStop: {
    itemId: "item-uuid-789",
    placeId: 381084,
    placeName: "Gullfoss",
    startTime: "2026-02-05T22:33:00.000Z",
    estimatedArrivalTime: "2026-02-05T22:33:00.000Z",
    Place: {
      id: 381084,
      nameCN: "é»„é‡‘ç€‘å¸ƒ",
      nameEN: "Gullfoss",
      address: "Gullfossvegur, å†°å²› / å†°å³¶",
      category: "ATTRACTION",
      rating: 4.7,
      description: "...",
      // âŒ ç¼ºå°‘ latitude å’Œ longitude å­—æ®µ
    }
  }
}
```

**å‰ç«¯éœ€è¦çš„å­—æ®µ**:
- âœ… `Place.latitude` - çº¬åº¦ï¼ˆå¿…éœ€ï¼‰
- âœ… `Place.longitude` - ç»åº¦ï¼ˆå¿…éœ€ï¼‰

### 1.2 å½±å“åŠŸèƒ½

**å—å½±å“çš„åŠŸèƒ½**:
- âŒ "å¼€å§‹å¯¼èˆª"æŒ‰é’®æ— æ³•ä½¿ç”¨ï¼ˆéœ€è¦åæ ‡æ‰“å¼€ Google Mapsï¼‰
- âŒ æ˜¾ç¤º"æ— æ³•è·å–ç›®çš„åœ°åæ ‡"é”™è¯¯

---

## ğŸ“ äºŒã€åç«¯æ¥å£éœ€æ±‚

### 2.1 æ¥å£è·¯å¾„

**æ¥å£**: `GET /api/trips/:id/state`

**å½“å‰å“åº”æ ¼å¼**:
```typescript
{
  success: true,
  data: {
    currentDayId: string | null;
    currentItemId: string | null;
    nextStop: {
      itemId: string;
      placeId: number;
      placeName: string;
      startTime: string;
      estimatedArrivalTime?: string;
      Place?: {  // âš ï¸ å½“å‰å¯èƒ½ä¸åŒ…å«åæ ‡å­—æ®µ
        id: number;
        nameCN?: string;
        nameEN?: string;
        address?: string;
        // ... å…¶ä»–å­—æ®µ
      };
    } | null;
    // ...
  }
}
```

### 2.2 éœ€è¦æ–°å¢çš„å­—æ®µ

**`nextStop.Place` å¯¹è±¡éœ€è¦åŒ…å«**:
```typescript
Place?: {
  id: number;
  nameCN?: string;
  nameEN?: string | null;
  latitude: number;        // âš ï¸ æ–°å¢ï¼šçº¬åº¦ï¼ˆå¿…éœ€ï¼‰
  longitude: number;      // âš ï¸ æ–°å¢ï¼šç»åº¦ï¼ˆå¿…éœ€ï¼‰
  address?: string;
  rating?: number | null;
  businessHours?: {        // âš ï¸ å»ºè®®ï¼šè¥ä¸šæ—¶é—´
    open?: string;
    close?: string;
    timezone?: string;
  };
  // ... å…¶ä»–Placeå­—æ®µ
}
```

---

## âœ… ä¸‰ã€å‰ç«¯ç±»å‹å®šä¹‰æ›´æ–°

### 3.1 å·²æ›´æ–°çš„ç±»å‹å®šä¹‰

**æ–‡ä»¶**: `src/types/trip.ts`

**æ›´æ–°å†…å®¹**:
```typescript
export interface TripState {
  currentDayId: string | null;
  currentItemId: string | null;
  nextStop?: {
    itemId: string;
    placeId: number;
    placeName: string;
    startTime: string;
    estimatedArrivalTime?: string;
    // âš ï¸ æ–°å¢ï¼šPlace å­—æ®µ
    Place?: {
      id: number;
      nameCN?: string;
      nameEN?: string | null;
      latitude?: number;        // âš ï¸ æ–°å¢ï¼šçº¬åº¦
      longitude?: number;      // âš ï¸ æ–°å¢ï¼šç»åº¦
      address?: string;
      rating?: number | null;
      businessHours?: {
        open?: string;
        close?: string;
        timezone?: string;
      };
      metadata?: PlaceMetadata;
      // å…¼å®¹å…¶ä»–å¯èƒ½çš„åæ ‡å­—æ®µå
      lat?: number;
      lng?: number;
      location?: {
        lat?: number;
        lng?: number;
      };
    };
  } | null;
  // ...
}
```

### 3.2 å‰ç«¯ä»£ç å…¼å®¹æ€§

**å·²æ”¯æŒå¤šç§åæ ‡å­—æ®µæ ¼å¼**:
- âœ… `latitude` / `longitude`ï¼ˆæ ‡å‡†æ ¼å¼ï¼‰
- âœ… `lat` / `lng`ï¼ˆå…¼å®¹æ ¼å¼ï¼‰
- âœ… `metadata.location.lat` / `metadata.location.lng`ï¼ˆå…¼å®¹æ ¼å¼ï¼‰

**ä»£ç ä½ç½®**: `src/pages/execute/index.tsx` ç¬¬742-760è¡Œ

---

## ğŸ¯ å››ã€åç«¯å®ç°å»ºè®®

### 4.1 æ•°æ®æ¥æº

**å¯èƒ½çš„åæ ‡æ•°æ®æ¥æº**:
1. âœ… Place è¡¨/æ•°æ®åº“ä¸­çš„ `latitude` å’Œ `longitude` å­—æ®µ
2. âœ… ä»å¤–éƒ¨APIè·å–ï¼ˆå¦‚ Google Places API, OpenStreetMapï¼‰
3. âœ… ä» `metadata` å­—æ®µä¸­æå–

### 4.2 å®ç°æ­¥éª¤

**æ­¥éª¤1**: ç¡®è®¤ Place æ•°æ®æ˜¯å¦å·²æœ‰åæ ‡
```sql
-- æ£€æŸ¥ Place è¡¨æ˜¯å¦æœ‰åæ ‡å­—æ®µ
SELECT id, nameCN, latitude, longitude 
FROM places 
WHERE id = 381084;
```

**æ­¥éª¤2**: å¦‚æœæ²¡æœ‰åæ ‡å­—æ®µï¼Œéœ€è¦ï¼š
- æ·»åŠ  `latitude` å’Œ `longitude` å­—æ®µåˆ° Place è¡¨
- ä»å¤–éƒ¨APIè·å–åæ ‡å¹¶å­˜å‚¨
- æˆ–è€…åœ¨è¿”å›æ•°æ®æ—¶åŠ¨æ€è·å–åæ ‡

**æ­¥éª¤3**: æ›´æ–° `GET /trips/:id/state` æ¥å£
- åœ¨è¿”å› `nextStop` æ—¶ï¼ŒåŒ…å«å®Œæ•´çš„ `Place` ä¿¡æ¯
- ç¡®ä¿ `Place.latitude` å’Œ `Place.longitude` å­—æ®µå­˜åœ¨

### 4.3 æ¥å£å“åº”ç¤ºä¾‹

**æœŸæœ›çš„å“åº”æ ¼å¼**:
```json
{
  "success": true,
  "data": {
    "currentDayId": "day-uuid-456",
    "currentItemId": null,
    "nextStop": {
      "itemId": "item-uuid-789",
      "placeId": 381084,
      "placeName": "Gullfoss",
      "startTime": "2026-02-05T22:33:00.000Z",
      "estimatedArrivalTime": "2026-02-05T22:33:00.000Z",
      "Place": {
        "id": 381084,
        "nameCN": "é»„é‡‘ç€‘å¸ƒ",
        "nameEN": "Gullfoss",
        "latitude": 64.3275,        // âš ï¸ å¿…éœ€å­—æ®µ
        "longitude": -20.1214,      // âš ï¸ å¿…éœ€å­—æ®µ
        "address": "Gullfossvegur, å†°å²› / å†°å³¶",
        "rating": 4.7,
        "businessHours": {
          "open": "09:00",
          "close": "18:00",
          "timezone": "Atlantic/Reykjavik"
        }
      }
    },
    "timezone": "Asia/Tokyo",
    "now": "2026-02-05T22:27:00.000Z"
  }
}
```

---

## âš ï¸ äº”ã€å…¼å®¹æ€§å¤„ç†

### 5.1 å‰ç«¯å…¼å®¹æ€§

**å½“å‰å®ç°**:
- âœ… ä¼˜å…ˆä½¿ç”¨ `tripState.nextStop.Place.latitude/longitude`
- âœ… å¦‚æœä¸å­˜åœ¨ï¼Œä» `trip` æ•°æ®ä¸­æŸ¥æ‰¾
- âœ… æ”¯æŒå¤šç§åæ ‡å­—æ®µæ ¼å¼ï¼ˆ`lat/lng`, `metadata.location.lat/lng`ï¼‰

**é™çº§æ–¹æ¡ˆ**:
- âš ï¸ å¦‚æœåç«¯æš‚æ—¶æ— æ³•æä¾›åæ ‡ï¼Œå‰ç«¯ä¼šæ˜¾ç¤ºé”™è¯¯æç¤º
- âš ï¸ ç”¨æˆ·æ— æ³•ä½¿ç”¨"å¼€å§‹å¯¼èˆª"åŠŸèƒ½

### 5.2 ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

**å¦‚æœåç«¯æš‚æ—¶æ— æ³•æä¾›åæ ‡**:
1. âš ï¸ å‰ç«¯ä¼šå°è¯•ä» `trip.TripDay[].ItineraryItem[].Place` ä¸­æŸ¥æ‰¾
2. âš ï¸ å¦‚æœä»ç„¶æ‰¾ä¸åˆ°ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤º
3. ğŸ’¡ å»ºè®®åç«¯å°½å¿«å®ç°ï¼Œå› ä¸ºè¿™æ˜¯æ ¸å¿ƒåŠŸèƒ½

---

## ğŸ“Š å…­ã€ä¼˜å…ˆçº§å’Œå½±å“

### 6.1 ä¼˜å…ˆçº§

**P0 - é«˜ä¼˜å…ˆçº§**:
- âœ… åæ ‡å­—æ®µæ˜¯"å¼€å§‹å¯¼èˆª"åŠŸèƒ½çš„æ ¸å¿ƒéœ€æ±‚
- âœ… å½±å“ç”¨æˆ·ä½“éªŒï¼ˆæ— æ³•ä½¿ç”¨å¯¼èˆªåŠŸèƒ½ï¼‰
- âœ… å‰ç«¯ä»£ç å·²å‡†å¤‡å¥½ï¼Œç­‰å¾…åç«¯æ•°æ®

### 6.2 å½±å“èŒƒå›´

**å—å½±å“çš„åŠŸèƒ½**:
- âŒ "å¼€å§‹å¯¼èˆª"æŒ‰é’®ï¼ˆå®Œå…¨ä¾èµ–åæ ‡ï¼‰
- âš ï¸ å…¶ä»–å¯èƒ½ä½¿ç”¨åæ ‡çš„åŠŸèƒ½ï¼ˆå¦‚è·ç¦»è®¡ç®—ã€åœ°å›¾æ˜¾ç¤ºç­‰ï¼‰

**ç”¨æˆ·ä½“éªŒå½±å“**:
- âš ï¸ æ˜¾ç¤º"æ— æ³•è·å–ç›®çš„åœ°åæ ‡"é”™è¯¯
- âš ï¸ æ— æ³•ä½¿ç”¨å¯¼èˆªåŠŸèƒ½

---

## âœ… ä¸ƒã€æ€»ç»“

### 7.1 ç¡®è®¤äº‹é¡¹

- âœ… **éœ€è¦åç«¯æ–°å¢**: `nextStop.Place.latitude` å’Œ `nextStop.Place.longitude` å­—æ®µ
- âœ… **å‰ç«¯å·²å‡†å¤‡**: ç±»å‹å®šä¹‰å’Œä»£ç å·²æ›´æ–°ï¼Œæ”¯æŒå¤šç§åæ ‡æ ¼å¼
- âœ… **ä¼˜å…ˆçº§**: P0ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

### 7.2 åç«¯éœ€è¦åšçš„äº‹æƒ…

1. **ç¡®è®¤æ•°æ®æº**: æ£€æŸ¥ Place æ•°æ®æ˜¯å¦å·²æœ‰åæ ‡
2. **æ·»åŠ å­—æ®µ**: å¦‚æœæ•°æ®åº“æ²¡æœ‰åæ ‡å­—æ®µï¼Œéœ€è¦æ·»åŠ 
3. **æ›´æ–°æ¥å£**: åœ¨ `GET /api/trips/:id/state` æ¥å£ä¸­è¿”å› `nextStop.Place.latitude` å’Œ `longitude`
4. **æµ‹è¯•éªŒè¯**: ç¡®ä¿è¿”å›çš„åæ ‡æ•°æ®æ­£ç¡®

### 7.3 å‰ç«¯å·²å®Œæˆçš„å‡†å¤‡

1. âœ… æ›´æ–°ç±»å‹å®šä¹‰ï¼ˆ`TripState.nextStop.Place`ï¼‰
2. âœ… æ”¯æŒå¤šç§åæ ‡å­—æ®µæ ¼å¼
3. âœ… æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
4. âœ… æ”¹è¿›é”™è¯¯å¤„ç†

---

**çŠ¶æ€**: âœ… å‰ç«¯å·²å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…åç«¯å®ç°  
**ä¼˜å…ˆçº§**: P0  
**ä¸‹ä¸€æ­¥**: åç«¯å®ç°åæ ‡å­—æ®µè¿”å›
