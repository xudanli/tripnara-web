# æ¥å£æ£€æŸ¥æŠ¥å‘Š

**æ£€æŸ¥æ—¶é—´**ï¼š2026-01-26  
**æ£€æŸ¥èŒƒå›´**ï¼š`POST /trip-planner/apply-suggestion` å’Œ `POST /trip-planner/chat`

---

## âœ… 1. `POST /trip-planner/apply-suggestion` æ¥å£

### æ£€æŸ¥ç»“æœï¼š**æ— å˜åŒ–** âœ…

**æ–‡æ¡£ä¸­çš„å®šä¹‰**ï¼š
```typescript
POST /trip-planner/apply-suggestion
Body: ApplySuggestionDto {
  tripId: string;
  sessionId: string;
  suggestionId: string;
  targetDay: number;
  timeSlot?: { start: string; end: string };
  suggestionType: 'add_place' | 'modify_time' | 'add_meal' | 'optimize_route';
  place?: SuggestionPlaceDto;
}
```

**ä»£ç ä¸­çš„å®šä¹‰**ï¼ˆ`src/api/trip-planner.ts:555-582`ï¼‰ï¼š
```typescript
export interface ApplySuggestionRequest {
  tripId: string;
  sessionId: string;
  suggestionId: string;
  targetDay: number;
  timeSlot?: {
    start: string;  // HH:mm
    end: string;    // HH:mm
  };
  suggestionType: 'add_place' | 'modify_time' | 'add_meal' | 'optimize_route';
  place?: {
    name: string;
    nameCN?: string;
    placeId?: number;
    category?: string;
    address?: string;
    location?: {
      lat: number;
      lng: number;
    };
  };
}
```

**å¯¹æ¯”ç»“æœ**ï¼š
- âœ… æ‰€æœ‰å­—æ®µå®Œå…¨åŒ¹é…
- âœ… å­—æ®µç±»å‹ä¸€è‡´
- âœ… å¯é€‰å­—æ®µæ ‡è®°ä¸€è‡´
- âš ï¸ ç±»å‹åç§°ä¸åŒï¼ˆ`ApplySuggestionDto` vs `ApplySuggestionRequest`ï¼‰ï¼Œä½†è¿™æ˜¯å‘½åå·®å¼‚ï¼Œä¸å½±å“åŠŸèƒ½
- âœ… `place` å¯¹è±¡çš„å­—æ®µåœ¨ä»£ç ä¸­æ›´è¯¦ç»†ï¼ˆåŒ…å« `location`ï¼‰ï¼Œä½†æ–‡æ¡£ä¸­çš„å®šä¹‰æ˜¯å…¼å®¹çš„

---

## âš ï¸ 2. `POST /trip-planner/chat` æ¥å£

### æ£€æŸ¥ç»“æœï¼š**å‘ç°ä¸€ä¸ªæ–‡æ¡£å·®å¼‚** âš ï¸

**æ–‡æ¡£ä¸­çš„å®šä¹‰**ï¼š
```typescript
POST /trip-planner/chat
Body: TripPlannerChatDto {
  sessionId?: string;
  tripId: string;
  userId: string;  // âš ï¸ æ–‡æ¡£ä¸­æœ‰æ­¤å­—æ®µ
  message: string;
  targetDay?: number;
  targetItemId?: string;
  context?: {...};
}
```

**ä»£ç ä¸­çš„å®šä¹‰**ï¼ˆ`src/api/trip-planner.ts:448-492`ï¼‰ï¼š
```typescript
export interface PlannerChatRequest {
  tripId: string;
  message: string;
  sessionId?: string;
  targetDay?: number;
  targetItemId?: string;
  context?: {
    selectedContext?: {...};
    adjacentItems?: {...};
    dayStats?: {...};
    currentLocation?: {...};
    timezone?: string;
    language?: 'zh' | 'en';
  };
  clarificationData?: {...};
}
```

**å¯¹æ¯”ç»“æœ**ï¼š
- âœ… æ ¸å¿ƒå­—æ®µåŒ¹é…ï¼š`tripId`, `message`, `sessionId`, `targetDay`, `targetItemId`, `context`
- âš ï¸ **å·®å¼‚**ï¼šæ–‡æ¡£ä¸­æåˆ°äº† `userId: string` å­—æ®µï¼Œä½†ä»£ç ä¸­çš„æ¥å£å®šä¹‰**æ²¡æœ‰æ­¤å­—æ®µ**
- âœ… ä»£ç ä¸­æœ‰ `clarificationData` å­—æ®µï¼ˆæ–‡æ¡£ä¸­æœªæ˜ç¡®æåˆ°ï¼Œä½†è¿™æ˜¯æ–°å¢åŠŸèƒ½ï¼‰

**å…³äº `userId` å­—æ®µçš„è¯´æ˜**ï¼š
- ä» `src/api/client.ts` å¯ä»¥çœ‹åˆ°ï¼Œç”¨æˆ·èº«ä»½æ˜¯é€šè¿‡ **Authorization Bearer Token** åœ¨è¯·æ±‚å¤´ä¸­ä¼ é€’çš„
- å®é™…è°ƒç”¨ä»£ç ï¼ˆ`src/hooks/useTripPlannerAssistant.ts:335-350`ï¼‰ä¸­ä¹Ÿæ²¡æœ‰ä¼ é€’ `userId`
- **ç»“è®º**ï¼š`userId` å¯èƒ½æ˜¯æ–‡æ¡£é”™è¯¯ï¼Œæˆ–è€…åç«¯ä»è®¤è¯ token ä¸­æå–ï¼Œä¸éœ€è¦åœ¨è¯·æ±‚ä½“ä¸­ä¼ é€’

---

## ğŸ“‹ æ€»ç»“

### æ¥å£å®šä¹‰ä¸€è‡´æ€§

| æ¥å£ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| `POST /trip-planner/apply-suggestion` | âœ… å®Œå…¨ä¸€è‡´ | æ‰€æœ‰å­—æ®µåŒ¹é…ï¼Œæ— å·®å¼‚ |
| `POST /trip-planner/chat` | âš ï¸ åŸºæœ¬ä¸€è‡´ | æ–‡æ¡£ä¸­å¤šäº†ä¸€ä¸ª `userId` å­—æ®µï¼Œä½†ä»£ç ä¸­ä¸éœ€è¦ï¼ˆé€šè¿‡ token ä¼ é€’ï¼‰ |

### å»ºè®®

1. **`apply-suggestion` æ¥å£**ï¼š
   - âœ… æ— éœ€ä¿®æ”¹ï¼Œæ¥å£å®šä¹‰å®Œå…¨ä¸€è‡´
   - âœ… æ–‡æ¡£è¯´æ˜å‡†ç¡®

2. **`chat` æ¥å£**ï¼š
   - âš ï¸ å»ºè®®æ›´æ–°æ–‡æ¡£ï¼Œç§»é™¤ `userId` å­—æ®µè¯´æ˜ï¼Œæˆ–æ³¨æ˜"é€šè¿‡è®¤è¯ token ä¼ é€’ï¼Œæ— éœ€åœ¨è¯·æ±‚ä½“ä¸­åŒ…å«"
   - âœ… å…¶ä»–å­—æ®µå®šä¹‰ä¸€è‡´
   - âœ… ä»£ç ä¸­çš„ `clarificationData` å­—æ®µæ˜¯æ–°å¢åŠŸèƒ½ï¼Œæ–‡æ¡£å¯ä»¥è¡¥å……è¯´æ˜

### ç»“è®º

**âœ… æ–‡æ¡£ä¸­çš„ç»“è®ºæ˜¯æ­£ç¡®çš„**ï¼šå‰ç«¯æ¥å£æ²¡æœ‰å˜åŒ–ï¼Œæ‰€æœ‰ä¿®å¤éƒ½æ˜¯åç«¯å®ç°å±‚é¢çš„æ”¹è¿›ã€‚ç°æœ‰å‰ç«¯ä»£ç æ— éœ€ä¿®æ”¹å³å¯ä½¿ç”¨æ–°åŠŸèƒ½ã€‚

å”¯ä¸€çš„å·®å¼‚æ˜¯æ–‡æ¡£ä¸­æåˆ°çš„ `userId` å­—æ®µï¼Œä½†è¿™ä¸å½±å“åŠŸèƒ½ï¼Œå› ä¸ºï¼š
1. ä»£ç ä¸­æœ¬æ¥å°±æ²¡æœ‰è¿™ä¸ªå­—æ®µ
2. ç”¨æˆ·èº«ä»½é€šè¿‡è®¤è¯ token ä¼ é€’
3. å®é™…è°ƒç”¨ä»£ç ä¹Ÿæ²¡æœ‰ä¼ é€’æ­¤å­—æ®µ

---

**æ£€æŸ¥å®Œæˆæ—¶é—´**ï¼š2026-01-26
