# å­—æ®µæ˜ å°„ä¼˜åŒ– - å®ç°å®ŒæˆæŠ¥å‘Š

## å®ç°æ—¶é—´
2026-01-31

## æ¦‚è¿°

å·²æˆåŠŸå®ç°å­—æ®µæ˜ å°„ä¼˜åŒ–ï¼Œç¡®ä¿å‰ç«¯ä½¿ç”¨ `fieldName` è€Œä¸æ˜¯ `questionId` ä½œä¸ºç­”æ¡ˆçš„ keyï¼Œä»¥æé«˜ç”»åƒåŒ¹é…æˆåŠŸç‡ã€‚

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. NLClarificationQuestionCard ç»„ä»¶ä¿®æ”¹

**æ–‡ä»¶**ï¼š`src/components/trips/NLClarificationQuestionCard.tsx`

**ä¿®æ”¹**ï¼š
- `handleChange` å‡½æ•°ç°åœ¨ä½¿ç”¨ `question.metadata?.fieldName || question.id` ä½œä¸º key
- ç¡®ä¿ä¼ é€’ç»™ `onAnswer` å›è°ƒçš„æ˜¯ `fieldName`ï¼ˆå¦‚æœå­˜åœ¨ï¼‰

**ä»£ç **ï¼š
```typescript
const handleChange = (newValue: string | string[] | number | boolean | null) => {
  onChange(newValue);
  // ğŸ†• ä½¿ç”¨ fieldName è€Œä¸æ˜¯ questionIdï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  const fieldKey = question.metadata?.fieldName || question.id;
  onAnswer?.(fieldKey, newValue);
};
```

---

### 2. NLChatInterface ç­”æ¡ˆä¿å­˜é€»è¾‘ä¿®æ”¹

**æ–‡ä»¶**ï¼š`src/components/trips/NLChatInterface.tsx`

**ä¿®æ”¹ä½ç½®**ï¼š`onQuestionAnswer` å›è°ƒ

**ä¿®æ”¹å†…å®¹**ï¼š
- æ¥æ”¶ `fieldKey`ï¼ˆå¯èƒ½æ˜¯ `fieldName` æˆ– `questionId`ï¼‰è€Œä¸æ˜¯ `questionId`
- ä½¿ç”¨ `fieldKey` ä½œä¸ºç­”æ¡ˆçš„ key ä¿å­˜åˆ° `questionAnswers`
- ä½¿ç”¨ `fieldKey` æ›´æ–°åç«¯ API

**ä»£ç **ï¼š
```typescript
onQuestionAnswer={async (fieldKey, value) => {
  // ğŸ†• fieldKey å¯èƒ½æ˜¯ fieldName æˆ– questionIdï¼ˆå‘åå…¼å®¹ï¼‰
  // 1. æ›´æ–°æœ¬åœ°çŠ¶æ€ï¼ˆç«‹å³ï¼‰
  setMessages(prev => {
    const updated = prev.map(m => 
      m.id === msg.id 
        ? {
            ...m,
            questionAnswers: {
              ...(m.questionAnswers || {}),
              [fieldKey]: value,  // âœ… ä½¿ç”¨ fieldKey
            },
          }
        : m
    );
    return updated;
  });
  
  // 2. è°ƒç”¨åç«¯ APIï¼ˆæ˜¾å¼æ›´æ–°ï¼‰
  tripsApi.updateMessageQuestionAnswers(sessionId, msg.id, {
    [fieldKey]: value,  // âœ… ä½¿ç”¨ fieldKey
  });
}}
```

---

### 3. ç­”æ¡ˆè¯»å–é€»è¾‘ä¿®æ”¹ï¼ˆå‘åå…¼å®¹ï¼‰

**ä¿®æ”¹ä½ç½®**ï¼šæ‰€æœ‰è¯»å–ç­”æ¡ˆçš„åœ°æ–¹

**ä¿®æ”¹å†…å®¹**ï¼š
- ä¼˜å…ˆä½¿ç”¨ `fieldName` è¯»å–ç­”æ¡ˆ
- å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå›é€€åˆ°ä½¿ç”¨ `questionId`ï¼ˆå‘åå…¼å®¹ï¼‰

**ä»£ç æ¨¡å¼**ï¼š
```typescript
// ğŸ†• ä½¿ç”¨ fieldName æˆ– questionIdï¼ˆå‘åå…¼å®¹ï¼‰
const fieldKey = question.metadata?.fieldName || question.id;
const answer = message.questionAnswers?.[fieldKey] ?? message.questionAnswers?.[question.id] ?? null;
```

**ä¿®æ”¹çš„ä½ç½®**ï¼š
1. âœ… `allQuestionsAnswered` è®¡ç®—
2. âœ… Critical å­—æ®µè¿›åº¦è®¡ç®—
3. âœ… Critical å­—æ®µé—®é¢˜æ¸²æŸ“
4. âœ… Required å­—æ®µé—®é¢˜æ¸²æŸ“
5. âœ… Optional å­—æ®µé—®é¢˜æ¸²æŸ“
6. âœ… Filtered é—®é¢˜æ¸²æŸ“
7. âœ… æ‰€æœ‰é—®é¢˜æ£€æŸ¥é€»è¾‘
8. âœ… ç­”æ¡ˆé¢„è§ˆç”Ÿæˆ

---

### 4. clarificationAnswers æ„å»ºé€»è¾‘ä¿®æ”¹

**æ–‡ä»¶**ï¼š`src/components/trips/NLChatInterface.tsx`

**ä¿®æ”¹ä½ç½®**ï¼š`sendMessage` å‡½æ•°ä¸­çš„ `clarificationAnswers` æ„å»º

**ä¿®æ”¹å†…å®¹**ï¼š
- `questionAnswers` ä½¿ç”¨ `fieldName` ä½œä¸º key
- `clarificationAnswers` éœ€è¦ä¼ é€’ `questionId` ç»™åç«¯
- æ„å»ºæ˜ å°„ï¼š`fieldName` -> `questionId`

**ä»£ç **ï¼š
```typescript
clarificationAnswers: (() => {
  const latestMessage = messages[messages.length - 1];
  if (latestMessage?.clarificationQuestions) {
    // ğŸ†• æ„å»ºå­—æ®µåæ˜ å°„ï¼šfieldKey -> questionId
    const fieldToQuestionId = new Map<string, string>();
    latestMessage.clarificationQuestions.forEach(q => {
      const fieldKey = q.metadata?.fieldName || q.id;
      fieldToQuestionId.set(fieldKey, q.id);
    });
    
    // ğŸ†• è½¬æ¢ç­”æ¡ˆï¼šquestionAnswers ä½¿ç”¨ fieldName ä½œä¸º key
    // ä½† clarificationAnswers éœ€è¦ä¼ é€’ questionId ç»™åç«¯
    return Object.entries(questionAnswers).map(([fieldKey, value]) => {
      const questionId = fieldToQuestionId.get(fieldKey) || fieldKey;
      return {
        questionId,
        value,
      };
    });
  } else {
    // é™çº§ï¼šå¦‚æœæ²¡æœ‰é—®é¢˜åˆ—è¡¨ï¼Œç›´æ¥ä½¿ç”¨ fieldKey ä½œä¸º questionId
    return Object.entries(questionAnswers).map(([fieldKey, value]) => ({
      questionId: fieldKey,
      value,
    }));
  }
})(),
```

---

### 5. collectQuestionAnswers å‡½æ•°ä¿®æ”¹

**æ–‡ä»¶**ï¼š`src/components/trips/NLChatInterface.tsx`

**ä¿®æ”¹å†…å®¹**ï¼š
- è¿”å›ä½¿ç”¨ `fieldName` ä½œä¸º key çš„ç­”æ¡ˆå¯¹è±¡
- å¦‚æœç­”æ¡ˆä½¿ç”¨ `questionId`ï¼Œå°è¯•è½¬æ¢ä¸º `fieldName`

**ä»£ç **ï¼š
```typescript
const collectQuestionAnswers = useCallback((): Record<string, string | string[] | number | boolean | null> => {
  const latestMessage = messages[messages.length - 1];
  if (!latestMessage || latestMessage.role !== 'assistant') {
    return {};
  }
  
  const questionAnswers = latestMessage.questionAnswers || {};
  const clarificationQuestions = latestMessage.clarificationQuestions || [];
  
  // ğŸ†• å¦‚æœç­”æ¡ˆå·²ç»ä½¿ç”¨ fieldNameï¼Œç›´æ¥è¿”å›
  // å¦åˆ™ï¼Œå°è¯•å°† questionId è½¬æ¢ä¸º fieldName
  const normalizedAnswers: Record<string, string | string[] | number | boolean | null> = {};
  
  clarificationQuestions.forEach(q => {
    const fieldKey = q.metadata?.fieldName || q.id;
    // ğŸ†• ä¼˜å…ˆä½¿ç”¨ fieldNameï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ questionIdï¼ˆå‘åå…¼å®¹ï¼‰
    const answer = questionAnswers[fieldKey] ?? questionAnswers[q.id];
    if (answer !== null && answer !== undefined) {
      normalizedAnswers[fieldKey] = answer;
    }
  });
  
  // ğŸ†• å¦‚æœæ²¡æœ‰ä»»ä½•åŒ¹é…ï¼Œè¿”å›åŸå§‹ç­”æ¡ˆï¼ˆå‘åå…¼å®¹ï¼‰
  return Object.keys(normalizedAnswers).length > 0 ? normalizedAnswers : questionAnswers;
}, [messages]);
```

---

### 6. æ–‡æœ¬æå–ç­”æ¡ˆé€»è¾‘ä¿®æ”¹

**æ–‡ä»¶**ï¼š`src/components/trips/NLChatInterface.tsx`

**ä¿®æ”¹ä½ç½®**ï¼š`sendMessage` å‡½æ•°ä¸­çš„æ–‡æœ¬æå–é€»è¾‘

**ä¿®æ”¹å†…å®¹**ï¼š
- ä½¿ç”¨ `fieldName` è€Œä¸æ˜¯ `question.id` ä½œä¸ºç­”æ¡ˆçš„ key

**ä»£ç **ï¼š
```typescript
latestMessage.clarificationQuestions.forEach(question => {
  // ğŸ†• ä½¿ç”¨ fieldName æˆ– questionIdï¼ˆå‘åå…¼å®¹ï¼‰
  const fieldKey = question.metadata?.fieldName || question.id;
  
  // ... åŒ¹é…é€»è¾‘ ...
  
  if (matchedOptions.length > 0) {
    extractedAnswers[fieldKey] = matchedOptions;  // âœ… ä½¿ç”¨ fieldKey
    break;
  }
});
```

---

## ğŸ”„ æ•°æ®æµ

### 1. ç”¨æˆ·å›ç­”é—®é¢˜

```
ç”¨æˆ·å›ç­”é—®é¢˜
  â†“
NLClarificationQuestionCard.handleChange
  â†“
ä½¿ç”¨ fieldNameï¼ˆå¦‚æœå­˜åœ¨ï¼‰æˆ– questionId
  â†“
onQuestionAnswer(fieldKey, value)
  â†“
ä¿å­˜åˆ° questionAnswers[fieldKey]
  â†“
æ›´æ–°åç«¯ APIï¼ˆä½¿ç”¨ fieldKeyï¼‰
```

### 2. å‘é€æ¶ˆæ¯

```
ç”¨æˆ·å‘é€æ¶ˆæ¯
  â†“
collectQuestionAnswers()
  â†“
è¿”å›ä½¿ç”¨ fieldName ä½œä¸º key çš„ç­”æ¡ˆ
  â†“
æ„å»º clarificationAnswers
  â†“
æ˜ å°„ fieldName -> questionId
  â†“
å‘é€ç»™åç«¯ï¼ˆä½¿ç”¨ questionIdï¼‰
```

### 3. è¯»å–ç­”æ¡ˆï¼ˆå‘åå…¼å®¹ï¼‰

```
è¯»å–ç­”æ¡ˆ
  â†“
ä¼˜å…ˆä½¿ç”¨ fieldName
  â†“
å¦‚æœæ²¡æœ‰ï¼Œä½¿ç”¨ questionId
  â†“
è¿”å›ç­”æ¡ˆ
```

---

## ğŸ“Š å­—æ®µæ˜ å°„ç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šæ–¯ç“¦å°”å·´é—®é¢˜

**é—®é¢˜å®šä¹‰**ï¼š
```typescript
{
  id: 'sj_extreme_experience',
  text: 'æ‚¨æ˜¯å¦æœ‰æåœ°æ—…è¡Œç»éªŒï¼Ÿ',
  metadata: {
    fieldName: 'extremeExperience',  // âœ… å‰ç«¯ä½¿ç”¨è¿™ä¸ª
  }
}
```

**ç­”æ¡ˆä¿å­˜**ï¼š
```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ fieldName
questionAnswers = {
  extremeExperience: 'no_first_time',  // âœ… ä½¿ç”¨ fieldName
};

// âŒ é”™è¯¯ï¼šä½¿ç”¨ questionId
questionAnswers = {
  sj_extreme_experience: 'no_first_time',  // âŒ åç«¯æ— æ³•åŒ¹é…
};
```

**å‘é€ç»™åç«¯**ï¼š
```typescript
clarificationAnswers = [
  {
    questionId: 'sj_extreme_experience',  // âœ… åç«¯éœ€è¦ questionId
    value: 'no_first_time',
  }
];
```

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. å­—æ®µæ˜ å°„æµ‹è¯•

**æµ‹è¯•åœºæ™¯**ï¼š
1. åç«¯è¿”å›å¸¦æœ‰ `fieldName` çš„é—®é¢˜
2. ç”¨æˆ·å›ç­”é—®é¢˜
3. æ£€æŸ¥ç­”æ¡ˆæ˜¯å¦ä½¿ç”¨ `fieldName` ä½œä¸º key

**éªŒè¯ç‚¹**ï¼š
- âœ… ç­”æ¡ˆä½¿ç”¨ `fieldName` ä½œä¸º key
- âœ… åç«¯ API è°ƒç”¨ä½¿ç”¨ `fieldName`
- âœ… `clarificationAnswers` ä½¿ç”¨ `questionId`

### 2. å‘åå…¼å®¹æµ‹è¯•

**æµ‹è¯•åœºæ™¯**ï¼š
1. åç«¯è¿”å›æ²¡æœ‰ `fieldName` çš„é—®é¢˜ï¼ˆæ—§æ ¼å¼ï¼‰
2. ç”¨æˆ·å›ç­”é—®é¢˜
3. æ£€æŸ¥ç­”æ¡ˆæ˜¯å¦ä½¿ç”¨ `questionId` ä½œä¸º key

**éªŒè¯ç‚¹**ï¼š
- âœ… ç­”æ¡ˆä½¿ç”¨ `questionId` ä½œä¸º keyï¼ˆé™çº§ï¼‰
- âœ… åŠŸèƒ½æ­£å¸¸å·¥ä½œ

### 3. ç”»åƒåŒ¹é…æµ‹è¯•

**æµ‹è¯•åœºæ™¯**ï¼š
1. ç”¨æˆ·å›ç­”æ‰€æœ‰é—®é¢˜ï¼ˆä½¿ç”¨ `fieldName`ï¼‰
2. å‘é€æ¶ˆæ¯
3. æ£€æŸ¥åç«¯æ˜¯å¦èƒ½æ­£ç¡®åŒ¹é…ç”»åƒ

**éªŒè¯ç‚¹**ï¼š
- âœ… åç«¯æ¥æ”¶åˆ°æ­£ç¡®çš„å­—æ®µå
- âœ… ç”»åƒåŒ¹é…æˆåŠŸï¼ˆå¾—åˆ† > 0.3ï¼‰
- âœ… `personaInfo` ä¸ä¸º null

---

## ğŸ“ ä»£ç ç»Ÿè®¡

### ä¿®æ”¹çš„æ–‡ä»¶

1. **NLClarificationQuestionCard.tsx**ï¼š1 å¤„ä¿®æ”¹
2. **NLChatInterface.tsx**ï¼šçº¦ 20 å¤„ä¿®æ”¹

### ä¿®æ”¹çš„ç±»å‹

1. **ç­”æ¡ˆä¿å­˜**ï¼šä½¿ç”¨ `fieldName` ä½œä¸º key
2. **ç­”æ¡ˆè¯»å–**ï¼šä¼˜å…ˆä½¿ç”¨ `fieldName`ï¼Œå›é€€åˆ° `questionId`
3. **ç­”æ¡ˆä¼ é€’**ï¼š`clarificationAnswers` ä½¿ç”¨ `questionId`ï¼Œä½†å†…éƒ¨ä½¿ç”¨ `fieldName`

---

## âœ… æ£€æŸ¥æ¸…å•

- [x] ä¿®æ”¹ `NLClarificationQuestionCard`ï¼Œä½¿ç”¨ `fieldName`
- [x] ä¿®æ”¹ `onQuestionAnswer` å›è°ƒï¼Œæ¥æ”¶ `fieldKey`
- [x] ä¿®æ”¹ç­”æ¡ˆä¿å­˜é€»è¾‘ï¼Œä½¿ç”¨ `fieldKey`
- [x] ä¿®æ”¹ç­”æ¡ˆè¯»å–é€»è¾‘ï¼Œæ”¯æŒ `fieldName` å’Œ `questionId`
- [x] ä¿®æ”¹ `clarificationAnswers` æ„å»ºé€»è¾‘
- [x] ä¿®æ”¹ `collectQuestionAnswers` å‡½æ•°
- [x] ä¿®æ”¹æ–‡æœ¬æå–ç­”æ¡ˆé€»è¾‘
- [x] ç¡®ä¿å‘åå…¼å®¹

---

## ğŸ¯ å…³é”®ç‚¹

### 1. å­—æ®µåæ˜ å°„

- **å‰ç«¯å­˜å‚¨**ï¼šä½¿ç”¨ `fieldName` ä½œä¸º keyï¼ˆå¦‚æœå­˜åœ¨ï¼‰
- **åç«¯ä¼ é€’**ï¼š`clarificationAnswers` ä½¿ç”¨ `questionId`
- **å‘åå…¼å®¹**ï¼šå¦‚æœæ²¡æœ‰ `fieldName`ï¼Œä½¿ç”¨ `questionId`

### 2. ç­”æ¡ˆå€¼æ ¼å¼

- **å¿…é¡»å®Œå…¨åŒ¹é…**ï¼šç­”æ¡ˆå€¼å¿…é¡»ä¸é€‰é¡¹å€¼å®Œå…¨åŒ¹é…
- **ç±»å‹æ­£ç¡®**ï¼šå¸ƒå°”å€¼ä½¿ç”¨ `true`/`false`ï¼Œä¸æ˜¯å­—ç¬¦ä¸²
- **æ•°ç»„æ ¼å¼**ï¼šå¤šé€‰ä½¿ç”¨æ•°ç»„æ ¼å¼

### 3. å®Œæ•´ä¿¡æ¯ä¼ é€’

- **æ‰€æœ‰å­—æ®µ**ï¼šç¡®ä¿æ‰€æœ‰å…³é”®å­—æ®µéƒ½å·²ä¼ é€’
- **å­—æ®µåæ­£ç¡®**ï¼šä½¿ç”¨ `fieldName` è€Œä¸æ˜¯ `questionId`
- **å€¼æ ¼å¼æ­£ç¡®**ï¼šç¡®ä¿å€¼æ ¼å¼ä¸åç«¯æœŸæœ›ä¸€è‡´

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [å‰ç«¯å­—æ®µæ˜ å°„å’ŒåŒ¹é…ä¼˜åŒ–æŒ‡å—](./å‰ç«¯å­—æ®µæ˜ å°„å’ŒåŒ¹é…ä¼˜åŒ–æŒ‡å—.md) - åŸå§‹éœ€æ±‚æ–‡æ¡£
- [é—®é¢˜ç­”æ¡ˆæ˜¾å¼æ›´æ–°-å®ç°å®Œæˆ.md](./é—®é¢˜ç­”æ¡ˆæ˜¾å¼æ›´æ–°-å®ç°å®Œæˆ.md) - ç­”æ¡ˆæ›´æ–°åŠŸèƒ½

---

**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ

æ‰€æœ‰å­—æ®µæ˜ å°„ä¼˜åŒ–å·²å®Œæˆï¼Œå‰ç«¯ç°åœ¨ä½¿ç”¨ `fieldName` ä½œä¸ºç­”æ¡ˆçš„ keyï¼Œè¿™å°†æé«˜ç”»åƒåŒ¹é…æˆåŠŸç‡ã€‚
