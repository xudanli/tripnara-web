# 执行页面API 404错误 - 问题分析和解决方案

**问题日期**: 2026-02-05  
**问题描述**: 执行页面API调用返回404错误  
**错误信息**: `POST http://localhost:5173/api/execution/execute 404 (Not Found)`

---

## 🔍 一、问题分析

### 1.1 错误现象

**控制台错误**:
```
POST http://localhost:5173/api/execution/execute 404 (Not Found)
[Execution API] execute 请求失败
Failed to load reminders
[Execute Page] 无法获取坐标
```

**影响功能**:
- ❌ 无法加载提醒列表
- ❌ 无法执行操作（延迟、跳过、替换）
- ❌ 无法获取坐标（导航功能）

### 1.2 根本原因

**API路径问题**:
- 前端请求: `POST /api/execution/execute`
- 后端可能没有实现这个接口，或者路径不同

**可能的原因**:
1. ⚠️ 后端还没有实现 `/api/execution/execute` 接口
2. ⚠️ 后端路径可能不同（如 `/execution/execute` 而不是 `/api/execution/execute`）
3. ⚠️ Vite代理配置可能有问题
4. ⚠️ 后端服务可能没有运行

---

## ✅ 二、解决方案

### 2.1 检查后端接口实现

**步骤**:
1. 确认后端是否实现了 `/api/execution/execute` 接口
2. 检查后端路由配置
3. 确认接口路径是否正确

**后端接口文档要求**:
根据 `执行页面-后端接口需求文档.md`，后端应该实现：
- `POST /api/execution/execute` - 执行操作（remind, handle_change, fallback）

### 2.2 检查Vite代理配置

**当前配置** (`vite.config.ts`):
```typescript
proxy: {
  '/api': {
    target: BACKEND_TARGET,  // http://127.0.0.1:3000
    changeOrigin: true,
    secure: false,
    // 保留 /api 前缀，转发到后端
  },
}
```

**说明**:
- ✅ 前端请求 `/api/execution/execute`
- ✅ Vite代理转发到 `http://127.0.0.1:3000/api/execution/execute`
- ⚠️ 如果后端路径是 `/execution/execute`（没有 `/api` 前缀），需要修改代理配置

### 2.3 临时解决方案（如果后端路径不同）

**如果后端路径是 `/execution/execute`（没有 `/api` 前缀）**:

修改 `vite.config.ts`:
```typescript
proxy: {
  '/api': {
    target: BACKEND_TARGET,
    changeOrigin: true,
    secure: false,
    // 如果后端不需要 /api 前缀，取消注释：
    rewrite: (path) => path.replace(/^\/api/, ''),
  },
}
```

**或者添加专门的代理规则**:
```typescript
proxy: {
  '/api/execution': {
    target: BACKEND_TARGET,
    changeOrigin: true,
    secure: false,
    rewrite: (path) => path.replace(/^\/api\/execution/, '/execution'),
  },
  '/api': {
    target: BACKEND_TARGET,
    changeOrigin: true,
    secure: false,
  },
}
```

### 2.4 检查后端服务状态

**步骤**:
1. 确认后端服务是否运行在 `http://127.0.0.1:3000`
2. 检查后端日志，查看是否有相关错误
3. 使用 curl 或 Postman 测试后端接口

**测试命令**:
```bash
# 测试后端是否运行
curl http://127.0.0.1:3000/health

# 测试执行接口（如果后端已实现）
curl -X POST http://127.0.0.1:3000/api/execution/execute \
  -H "Content-Type: application/json" \
  -d '{
    "tripId": "test-trip-id",
    "action": "remind"
  }'
```

---

## 📝 三、前端代码检查

### 3.1 API调用代码

**当前实现** (`src/api/execution.ts`):
```typescript
const response = await apiClient.post<ApiResponseWrapper<ExecuteExecutionResponse>>(
  '/execution/execute',
  data,
  {
    timeout: 60000,
  }
);
```

**分析**:
- ✅ 使用相对路径 `/execution/execute`
- ✅ 通过 `apiClient` 发送，会自动添加 `baseURL`（`/api`）
- ✅ 最终请求路径: `/api/execution/execute`

### 3.2 API客户端配置

**当前配置** (`src/api/client.ts`):
```typescript
const baseURL = runtimeBase || import.meta.env.VITE_API_BASE_URL || '/api';
```

**分析**:
- ✅ 默认使用 `/api` 作为 baseURL
- ✅ 可以通过环境变量 `VITE_API_BASE_URL` 覆盖
- ✅ 可以通过 `window.__CONFIG__.apiBaseUrl` 动态配置

---

## ⚠️ 四、调试步骤

### 4.1 检查网络请求

1. 打开浏览器开发者工具
2. 切换到"网络"（Network）标签
3. 刷新页面或执行操作
4. 查看请求详情：
   - 请求URL: `http://localhost:5173/api/execution/execute`
   - 状态码: `404`
   - 响应内容: 查看后端返回的错误信息

### 4.2 检查API客户端日志

**控制台日志**:
```
[API Client] 初始化配置: {
  windowConfig: undefined,
  runtimeBase: undefined,
  viteEnv: undefined,
  finalBaseURL: '/api'
}

[API Client] 请求: {
  url: '/execution/execute',
  fullUrl: '/api/execution/execute',
  baseURL: '/api',
  method: 'POST',
  hasToken: true/false
}
```

**分析**:
- 如果 `fullUrl` 是 `/api/execution/execute`，说明前端配置正确
- 如果返回404，说明后端没有这个接口

### 4.3 检查后端日志

**后端应该记录**:
- 接收到的请求路径
- 路由匹配情况
- 404错误的原因

---

## 🔧 五、修复建议

### 5.1 如果后端还没有实现接口

**方案1: 等待后端实现**
- ⚠️ 前端代码已经准备好，等待后端实现接口
- ⚠️ 可以添加临时mock数据用于开发测试

**方案2: 添加Mock数据**
```typescript
// src/api/execution.ts
execute: async (data: ExecuteExecutionRequest): Promise<ExecuteExecutionResponse> => {
  // 临时Mock数据（仅用于开发）
  if (import.meta.env.DEV) {
    console.warn('[Execution API] 使用Mock数据（后端接口未实现）');
    return {
      executionState: {
        tripId: data.tripId,
        phase: 'ON_TRIP',
        currentDay: 1,
        currentDate: new Date().toISOString(),
        reminders: [],
        pendingChanges: [],
        activeFallbacks: [],
        lastUpdated: new Date().toISOString(),
      },
      uiOutput: {
        reminders: [],
      },
    };
  }
  
  // 实际API调用
  const response = await apiClient.post(...);
  // ...
}
```

### 5.2 如果后端路径不同

**方案1: 修改代理配置**
- 修改 `vite.config.ts`，添加路径重写规则

**方案2: 修改API调用**
- 如果后端路径是 `/execution/execute`（没有 `/api` 前缀）
- 可以创建专门的API客户端，或修改baseURL

### 5.3 如果后端服务未运行

**步骤**:
1. 启动后端服务
2. 确认服务运行在正确的端口（默认3000）
3. 检查防火墙和网络配置

---

## 📊 六、问题优先级

| 问题 | 优先级 | 解决方案 |
|------|--------|---------|
| **后端接口未实现** | P0 | 等待后端实现或添加Mock数据 |
| **后端路径不同** | P0 | 修改代理配置或API调用 |
| **后端服务未运行** | P0 | 启动后端服务 |
| **代理配置错误** | P1 | 检查并修复Vite代理配置 |

---

## ✅ 七、临时解决方案

### 7.1 添加错误处理改进

**当前问题**: 404错误导致页面功能完全失效

**改进方案**: 添加更友好的错误提示和降级处理

```typescript
// src/pages/execute/index.tsx
const loadReminders = async () => {
  if (!tripId) return;
  try {
    const result = await executionApi.execute({
      tripId,
      action: 'remind',
      remindParams: {
        reminderTypes: ['departure', 'transport', 'weather', 'check_in', 'check_out'],
        advanceHours: EXECUTE_CONFIG.REMINDER_ADVANCE_HOURS,
      },
    });
    setReminders(result.uiOutput.reminders || []);
  } catch (err: any) {
    console.error('Failed to load reminders:', err);
    
    // ⚠️ 改进：如果是404错误，提示后端接口未实现
    if (err?.response?.status === 404 || err?.code === 'ERR_BAD_REQUEST') {
      console.warn('[Execute Page] 后端接口未实现，使用空数据');
      // 不显示错误提示，避免打扰用户
    } else {
      // 其他错误显示提示
      toast.error('加载提醒失败', {
        description: err?.message || '请检查网络连接',
      });
    }
    
    setReminders([]);
  }
};
```

### 7.2 添加开发环境提示

**方案**: 在开发环境显示后端接口状态

```typescript
// src/pages/execute/index.tsx
useEffect(() => {
  if (import.meta.env.DEV && tripId) {
    // 检查后端接口是否可用
    fetch('/api/execution/execute', { method: 'POST', body: JSON.stringify({ tripId, action: 'get_status' }) })
      .then(res => {
        if (res.status === 404) {
          console.warn('[Execute Page] ⚠️ 后端接口 /api/execution/execute 未实现');
        }
      })
      .catch(() => {
        console.warn('[Execute Page] ⚠️ 无法连接到后端服务');
      });
  }
}, [tripId]);
```

---

## 📝 八、总结

### 8.1 问题根源

- ⚠️ **后端接口未实现**: `/api/execution/execute` 接口可能还没有实现
- ⚠️ **路径不匹配**: 后端路径可能与前端请求路径不同
- ⚠️ **服务未运行**: 后端服务可能没有运行

### 8.2 解决步骤

1. **检查后端服务**: 确认后端是否运行
2. **检查后端接口**: 确认接口是否实现
3. **检查路径匹配**: 确认路径是否正确
4. **添加错误处理**: 改进错误提示和降级处理

### 8.3 下一步行动

1. **联系后端团队**: 确认接口实现状态
2. **添加Mock数据**: 如果后端未实现，添加临时Mock数据
3. **改进错误处理**: 添加更友好的错误提示

---

**问题状态**: ⚠️ 待解决  
**优先级**: P0  
**下一步**: 检查后端接口实现状态
