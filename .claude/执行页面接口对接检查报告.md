# 执行页面接口对接检查报告

**检查日期**: 2026-02-05  
**检查页面**: `/dashboard/execute` (执行页面)  
**文件路径**: `src/pages/execute/index.tsx`

---

## 📋 一、页面功能概览

根据图片描述和代码分析，执行页面包含以下主要功能模块：

1. **顶部信息栏**：行程信息、状态、在线状态、天气、视图模式切换
2. **下一步操作卡片**：显示下一个目的地、时间、关键证据
3. **今日时间线**：显示今天的行程安排
4. **提醒卡片**：显示重要提醒事项
5. **快速操作面板**：延迟、跳过、替换、重新排序
6. **修复方案Sheet**：Neptune提供的修复方案

---

## ✅ 二、已对接的接口

### 2.1 数据加载接口 ✅

| 功能 | API调用 | 状态 | 说明 |
|------|---------|------|------|
| **行程数据** | `tripsApi.getById(tripId)` | ✅ 已对接 | 第180行，加载行程详情 |
| **行程状态** | `tripsApi.getState(tripId)` | ✅ 已对接 | 第182行，获取执行状态（包含nextStop） |
| **今日时间线** | `tripsApi.getSchedule(tripId, today)` | ✅ 已对接 | 第191行，获取今天的行程安排 |
| **提醒数据** | `executionApi.execute({ action: 'remind' })` | ✅ 已对接 | 第217行，获取提醒事项 |

**代码位置**：
```typescript
// 第176-202行：loadData 函数
const loadData = async () => {
  const [tripData, state] = await Promise.all([
    tripsApi.getById(tripId),
    tripsApi.getState(tripId),
  ]);
  // ...
  const schedule = await tripsApi.getSchedule(tripId, today);
};

// 第214-230行：loadReminders 函数
const loadReminders = async () => {
  const result = await executionApi.execute({
    tripId,
    action: 'remind',
    remindParams: { ... },
  });
};
```

### 2.2 操作接口 ✅

| 功能 | API调用 | 状态 | 说明 |
|------|---------|------|------|
| **延迟15分钟** | `executionApi.execute({ action: 'handle_change' })` | ✅ 已对接 | 第239行 |
| **延迟30分钟** | `executionApi.execute({ action: 'handle_change' })` | ✅ 已对接 | 第239行 |
| **跳过活动** | `executionApi.execute({ action: 'handle_change' })` | ✅ 已对接 | 第255行 |
| **替换活动** | `executionApi.execute({ action: 'fallback' })` | ✅ 已对接 | 第269行 |

**代码位置**：
```typescript
// 第232-290行：handleAction 函数
const handleAction = async (action: string) => {
  if (action === 'delay-15m' || action === 'delay-30m') {
    await executionApi.execute({
      tripId,
      action: 'handle_change',
      changeParams: {
        changeType: 'schedule_change',
        changeDetails: { reason: `用户请求延迟 ${delayMinutes} 分钟` },
      },
    });
  } else if (action === 'skip') {
    await executionApi.execute({
      tripId,
      action: 'handle_change',
      changeParams: {
        changeType: 'activity_cancelled',
        changeDetails: { reason: '用户请求跳过当前活动' },
      },
    });
  } else if (action === 'replace') {
    await executionApi.execute({
      tripId,
      action: 'fallback',
      fallbackParams: { ... },
    });
  }
};
```

### 2.3 天气接口 ✅

| 功能 | 组件 | 状态 | 说明 |
|------|------|------|------|
| **天气信息** | `WeatherCard` | ✅ 已对接 | 第398行，5分钟自动刷新 |

**代码位置**：
```typescript
// 第397-405行
{weatherLocation && (
  <WeatherCard
    location={weatherLocation.location}
    includeWindDetails={isIceland}
    compact={true}
    refreshInterval={5 * 60 * 1000}
    locationName={weatherLocation.name}
  />
)}
```

### 2.4 轮询更新 ✅

| 功能 | 实现方式 | 状态 | 说明 |
|------|---------|------|------|
| **状态轮询** | `setInterval` 30秒 | ✅ 已实现 | 第140-145行，每30秒更新状态和提醒 |

---

## ⚠️ 三、部分对接或硬编码的功能

### 3.1 在线状态 ⚠️

| 功能 | 当前实现 | 状态 | 建议 |
|------|---------|------|------|
| **在线状态显示** | 硬编码显示"在线" | ⚠️ 硬编码 | 应该检测实际网络状态 |

**代码位置**：
```typescript
// 第392-395行
<div className="flex items-center gap-2 text-sm text-muted-foreground">
  <Wifi className="h-4 w-4" />
  <span>在线</span>  {/* ⚠️ 硬编码 */}
</div>
```

**建议**：
- 使用 `navigator.onLine` 检测网络状态
- 监听 `online`/`offline` 事件
- 显示实际连接状态（在线/离线）

### 3.2 关键证据 ⚠️

| 功能 | 当前实现 | 状态 | 建议 |
|------|---------|------|------|
| **营业时间** | 硬编码 "09:00-18:00" | ❌ 硬编码 | 应该从Place数据或API获取 |
| **封路信息** | 硬编码 "无" | ❌ 硬编码 | 应该从交通API获取 |
| **天气窗口** | 硬编码 "晴朗，适合户外活动" | ❌ 硬编码 | 应该从天气API获取 |

**代码位置**：
```typescript
// 第464-479行
{showEvidence && (
  <div className="p-3 bg-blue-50 border border-blue-200 rounded-lg space-y-2 text-sm">
    <div>
      <span className="font-medium">营业时间：</span>
      <span className="text-muted-foreground">09:00-18:00</span>  {/* ⚠️ 硬编码 */}
    </div>
    <div>
      <span className="font-medium">封路信息：</span>
      <span className="text-muted-foreground">无</span>  {/* ⚠️ 硬编码 */}
    </div>
    <div>
      <span className="font-medium">天气窗口：</span>
      <span className="text-muted-foreground">晴朗，适合户外活动</span>  {/* ⚠️ 硬编码 */}
    </div>
  </div>
)}
```

**建议**：
- 营业时间：从 `nextStop.Place` 数据获取 `businessHours`
- 封路信息：调用交通API或从Place数据获取
- 天气窗口：基于当前天气数据动态生成

---

## ❌ 四、未对接的功能

### 4.1 重新排序功能 ❌

| 功能 | 当前实现 | 状态 | 建议 |
|------|---------|------|------|
| **Reorder today** | `handleAction('reorder')` 没有实现 | ❌ 未实现 | 需要实现重新排序逻辑 |

**代码位置**：
```typescript
// 第630-637行
<Button
  variant="outline"
  size="sm"
  onClick={() => handleAction('reorder')}  // ⚠️ 没有实现
  className="col-span-2"
>
  Reorder today
</Button>

// 第232-290行：handleAction 函数中没有处理 'reorder' 的情况
```

**建议**：
- 实现重新排序功能
- 调用 `executionApi.execute({ action: 'reorder' })` 或类似的API
- 或者打开一个重新排序对话框，让用户拖拽调整顺序

### 4.2 开始导航功能 ❌

| 功能 | 当前实现 | 状态 | 建议 |
|------|---------|------|------|
| **开始导航** | 按钮没有实际功能 | ❌ 未实现 | 应该调用导航API或打开地图应用 |

**代码位置**：
```typescript
// 第482-485行
<Button className="w-full" variant="outline">
  <Navigation className="w-4 h-4 mr-2" />
  开始导航  {/* ⚠️ 没有onClick处理 */}
</Button>
```

**建议**：
- 调用导航API（如Google Maps、高德地图等）
- 或者使用 `window.open()` 打开地图应用
- 传递目的地坐标：`nextStop.Place.latitude, nextStop.Place.longitude`

### 4.3 修复方案功能 ❌

| 功能 | 当前实现 | 状态 | 建议 |
|------|---------|------|------|
| **修复方案数据** | 硬编码3个方案 | ❌ 硬编码 | 应该从Neptune API获取实际方案 |
| **应用修复方案** | TODO注释 | ❌ 未实现 | 需要实现应用修复方案的逻辑 |

**代码位置**：
```typescript
// 第669-726行：修复方案卡片都是硬编码的
<Card className="border-primary cursor-pointer hover:shadow-md">
  <CardHeader>
    <CardTitle className="text-lg">最小改动</CardTitle>
    <Badge className="bg-primary">推荐</Badge>
  </CardHeader>
  <CardContent className="space-y-3">
    <div className="text-sm text-muted-foreground">
      仅调整后续时间，不删除任何地点  {/* ⚠️ 硬编码 */}
    </div>
    {/* ... */}
  </CardContent>
</Card>

// 第733-738行：应用按钮
<Button onClick={() => {
  // TODO: 应用修复方案  {/* ⚠️ 未实现 */}
  setShowRepairSheet(false);
}}>
  Apply Changes
</Button>
```

**建议**：
- 从 `executionApi.execute({ action: 'fallback' })` 的响应中获取修复方案
- 显示实际的修复方案数据（从API返回）
- 实现应用修复方案的逻辑（调用相应的API）

### 4.4 预览修复方案 ❌

| 功能 | 当前实现 | 状态 | 建议 |
|------|---------|------|------|
| **Preview按钮** | 没有实际功能 | ❌ 未实现 | 应该打开预览对话框或跳转到预览页面 |

**代码位置**：
```typescript
// 第687行、705行、723行
<Button className="w-full">Preview</Button>  {/* ⚠️ 没有onClick处理 */}
```

**建议**：
- 实现预览功能
- 显示修复方案的具体变更内容
- 或者跳转到规划工作台预览修复后的行程

---

## 📊 五、接口对接统计

| 类别 | 已对接 | 部分对接 | 未对接 | 总计 |
|------|--------|---------|--------|------|
| **数据加载** | 4 | 0 | 0 | 4 |
| **操作功能** | 3 | 0 | 1 | 4 |
| **辅助功能** | 1 | 1 | 3 | 5 |
| **总计** | **8** | **1** | **4** | **13** |

**对接完成度**：**61.5%** (8/13)

---

## 🎯 六、优先级建议

### P0（高优先级）- 必须实现

1. **重新排序功能** ❌
   - 用户可能需要调整今天的行程顺序
   - 影响用户体验

2. **开始导航功能** ❌
   - 执行阶段的核心功能
   - 用户需要导航到下一个目的地

### P1（中优先级）- 建议实现

3. **在线状态检测** ⚠️
   - 提升用户体验
   - 帮助用户了解网络状态

4. **关键证据数据** ⚠️
   - 提供准确的营业时间、封路信息
   - 帮助用户做出更好的决策

### P2（低优先级）- 可选实现

5. **修复方案数据** ❌
   - 如果Neptune API已支持，应该对接
   - 如果API未支持，可以保留硬编码作为占位

6. **预览修复方案** ❌
   - 增强用户体验
   - 让用户了解修复方案的具体内容

---

## 📝 七、具体实施建议

### 7.1 重新排序功能

**方案1：调用API**
```typescript
const handleAction = async (action: string) => {
  // ...
  } else if (action === 'reorder') {
    // 打开重新排序对话框
    setReorderDialogOpen(true);
  }
};

// 在对话框中实现拖拽排序，然后调用API
await executionApi.execute({
  tripId,
  action: 'reorder',
  reorderParams: {
    dayId: tripState.currentDayId,
    newOrder: reorderedItemIds, // 重新排序后的ID数组
  },
});
```

**方案2：使用现有组件**
- 如果规划工作台已有重新排序功能，可以复用
- 或者使用拖拽库（如 `@dnd-kit/core`）实现

### 7.2 开始导航功能

```typescript
const handleStartNavigation = () => {
  if (!nextStop?.Place) return;
  
  const lat = nextStop.Place.latitude;
  const lng = nextStop.Place.longitude;
  const placeName = nextStop.placeName;
  
  // 方案1：打开Google Maps
  window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`);
  
  // 方案2：打开高德地图（中国用户）
  // window.open(`https://uri.amap.com/navigation?to=${lng},${lat}&toname=${placeName}`);
  
  // 方案3：调用导航API（如果后端支持）
  // await navigationApi.startNavigation({ tripId, destination: { lat, lng } });
};
```

### 7.3 在线状态检测

```typescript
const [isOnline, setIsOnline] = useState(navigator.onLine);

useEffect(() => {
  const handleOnline = () => setIsOnline(true);
  const handleOffline = () => setIsOnline(false);
  
  window.addEventListener('online', handleOnline);
  window.addEventListener('offline', handleOffline);
  
  return () => {
    window.removeEventListener('online', handleOnline);
    window.removeEventListener('offline', handleOffline);
  };
}, []);

// 在UI中使用
<div className="flex items-center gap-2 text-sm text-muted-foreground">
  {isOnline ? <Wifi className="h-4 w-4" /> : <WifiOff className="h-4 w-4" />}
  <span>{isOnline ? '在线' : '离线'}</span>
</div>
```

### 7.4 关键证据数据

```typescript
// 从nextStop.Place获取营业时间
const businessHours = nextStop?.Place?.businessHours || '09:00-18:00';

// 从Place数据或API获取封路信息
const roadClosure = nextStop?.Place?.roadClosure || null;

// 基于天气数据生成天气窗口描述
const weatherWindow = useMemo(() => {
  if (!weatherData) return '晴朗，适合户外活动';
  // 根据天气数据生成描述
  // ...
}, [weatherData]);
```

---

## ✅ 八、总结

### 8.1 已完成 ✅

- ✅ 核心数据加载（行程、状态、时间线、提醒）
- ✅ 基本操作功能（延迟、跳过、替换）
- ✅ 天气信息显示
- ✅ 自动轮询更新

### 8.2 需要改进 ⚠️

- ⚠️ 在线状态检测（硬编码）
- ⚠️ 关键证据数据（硬编码）

### 8.3 需要实现 ❌

- ❌ 重新排序功能
- ❌ 开始导航功能
- ❌ 修复方案数据对接
- ❌ 预览修复方案功能

### 8.4 整体评估

**接口对接完成度**：**61.5%**

**核心功能**：✅ 基本完成（数据加载、基本操作）

**辅助功能**：⚠️ 部分完成（在线状态、关键证据）

**高级功能**：❌ 未完成（重新排序、导航、修复方案）

---

**检查人**：开发团队  
**检查时间**：2026-02-05  
**下一步行动**：优先实现P0功能（重新排序、开始导航）
