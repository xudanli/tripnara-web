# 目的地特化澄清系统 - 接口对接评估报告

**评估日期**：2026-01-30  
**评估对象**：目的地特化澄清系统 API 接口对接  
**评估范围**：用户侧接口对接实现方案

---

## 📋 目录

- [背景与目标](#背景与目标)
- [API 变更对比](#api-变更对比)
- [现有实现分析](#现有实现分析)
- [多角色评估](#多角色评估)
- [实施建议](#实施建议)
- [风险评估](#风险评估)

---

## 背景与目标

### 背景

TripNARA 计划引入**目的地特化澄清系统**，为高风险目的地（如格陵兰）提供定制化的澄清流程，包括：
- 多轮澄清（clarification rounds）
- Gate 预检查（gate prechecks）
- 结构化回复内容块（plannerResponseBlocks）
- 更丰富的澄清问题类型

### 目标

1. **对接新的 API 接口格式**
2. **保持向后兼容**（通用流程仍可使用）
3. **优化用户体验**（结构化内容展示、Gate 警告处理）
4. **支持会话管理**（sessionId 持久化）

---

## API 变更对比

### 1. 请求格式变更

#### 现有实现
```typescript
interface CreateTripFromNLRequest {
  text: string;
  llmProvider?: LLMProvider;
  sessionId?: string;
  contextPackageId?: string;
  context?: { ... };
  clarificationAnswers?: ClarificationAnswer[];
}
```

#### 新 API 文档
```typescript
{
  text: string;
  sessionId?: string;
  llmProvider?: string;  // 'openai' | 'gemini' | 'deepseek' | 'anthropic'
}
```

**变更**：
- ✅ `sessionId` 已支持
- ✅ `llmProvider` 类型略有差异（需要统一）
- ⚠️ `contextPackageId` 和 `context` 在新文档中未提及（需要确认是否保留）
- ⚠️ `clarificationAnswers` 在新文档中未提及（需要确认是否保留）

### 2. 响应格式变更

#### 现有实现
```typescript
interface CreateTripFromNLResponse {
  sessionId?: string;
  needsClarification?: boolean;
  plannerResponseBlocks?: PlannerResponseBlock[];
  plannerReply?: string;
  suggestedQuestions?: string[];
  clarificationQuestions?: NLClarificationQuestion[] | string[];
  conversationContext?: ConversationContext;
  partialParams?: ParsedTripParams;
  trip?: { ... };
  parsedParams?: ParsedTripParams;
  // ...
}
```

#### 新 API 文档
```typescript
{
  success: true;
  data: {
    sessionId: string;
    needsClarification: boolean;
    plannerResponseBlocks?: Array<{ ... }>;
    clarificationQuestions?: Array<{
      id: string;
      question: string;  // ⚠️ 字段名变更：question 而不是 text
      type: 'text' | 'single_choice' | 'multi_choice' | 'date' | 'number' | 'boolean';  // ⚠️ 字段名变更：type 而不是 inputType
      options?: string[];
      required: boolean;
      placeholder?: string;
      hint?: string;
      default?: string | string[] | boolean | number;
      metadata?: {
        category?: string;
        priority?: 'high' | 'medium' | 'low';
        isCritical?: boolean;  // 🆕 新增：Critical 字段
        fieldName?: string;    // 🆕 新增：字段名
      };
    }>;
    plannerReply?: string;
    suggestedQuestions?: string[];
    conversationContext?: Record<string, any>;
    partialParams?: Record<string, any>;
    trip?: { ... };
    generatingItems?: boolean;  // 🆕 新增：后台生成状态
  };
}
```

**关键变更**：
1. ⚠️ **字段名变更**：
   - `clarificationQuestions[].text` → `clarificationQuestions[].question`
   - `clarificationQuestions[].inputType` → `clarificationQuestions[].type`
   - `multi_choice` → `multi_choice`（保持一致）

2. 🆕 **新增字段**：
   - `metadata.isCritical`：Critical 字段未回答时不能创建行程
   - `metadata.fieldName`：字段名（用于存储）
   - `generatingItems`：后台生成状态

3. ⚠️ **响应包装**：
   - 新 API 使用 `{ success: true, data: T }` 格式
   - 现有实现已支持此格式（`ApiResponseWrapper<T>`）

### 3. Gate 预检查响应

#### 新 API 文档
```typescript
{
  success: true;
  data: {
    sessionId: string;
    needsClarification: true;
    plannerResponseBlocks: Array<{
      type: 'highlight';
      highlightType: 'warning';
      highlightText: string;
    } | {
      type: 'paragraph';
      content: string;  // 替代方案描述
    }>;
    clarificationQuestions?: Array<{ ... }>;
  };
}
```

**新增功能**：
- 🆕 Gate 预检查失败时返回警告消息
- 🆕 提供替代方案选择
- ⚠️ 需要前端实现 Gate 警告 UI

---

## 现有实现分析

### 1. 类型定义位置

**文件**：`src/types/trip.ts`

**现有类型**：
- `NLClarificationQuestion`（第 563-574 行）
- `PlannerResponseBlock`（第 608-662 行）
- `CreateTripFromNLRequest`（第 371-407 行）
- `CreateTripFromNLResponse`（第 680-769 行）

**需要更新**：
1. `NLClarificationQuestion` 字段名映射（`text` → `question`，`inputType` → `type`）
2. 新增 `metadata.isCritical` 和 `metadata.fieldName`
3. 新增 `generatingItems` 字段

### 2. API 调用位置

**文件**：`src/api/trips.ts`

**现有实现**：
- `createFromNL()`（第 235-244 行）
- `getNLConversation()`（第 250-255 行）
- `updateNLConversation()`（第 272-287 行）
- `deleteNLConversation()`（第 293-295 行）

**需要更新**：
- ✅ API 路径已匹配
- ✅ 响应处理已支持 `ApiResponseWrapper<T>`
- ⚠️ 需要确认请求参数是否完全匹配

### 3. 组件实现位置

**文件**：`src/components/trips/NLChatInterface.tsx`

**现有实现**：
- 消息发送逻辑（第 942-1318 行）
- 澄清问题渲染（第 376-500 行）
- 结构化内容渲染（第 316-375 行）

**需要更新**：
1. 字段名映射处理（`question` → `text`，`type` → `inputType`）
2. Gate 警告 UI 实现
3. Critical 字段验证逻辑
4. `generatingItems` 状态展示

---

## 多角色评估

### 待评估角色

1. **产品经理（Danny）**：评估产品需求、用户故事、成功指标
2. **人机交互设计专家（Dr. Sarah Chen）**：评估交互设计、认知负荷
3. **体验设计专家（Alex）**：评估用户体验流程、信息架构
4. **前端架构师**：评估技术实现方案、类型安全、架构设计
5. **前端工程师**：评估具体实现细节、代码质量、向后兼容

---

## 待评估问题

### 产品层面

1. **Critical 字段处理**：
   - Critical 字段未回答时，是否阻止用户创建行程？
   - 如何向用户传达 Critical 字段的重要性？

2. **Gate 预检查交互**：
   - Gate 警告时，用户如何选择替代方案？
   - 是否需要明确的"确认继续"或"选择替代方案"按钮？

3. **会话管理**：
   - 会话过期时间是多少？
   - 用户如何恢复之前的对话？

### 交互设计层面

1. **字段名映射**：
   - 前端是否需要兼容新旧两种字段名？
   - 映射逻辑放在哪里（API 层还是组件层）？

2. **Gate 警告 UI**：
   - 警告消息如何展示（Toast、Modal、Inline）？
   - 替代方案如何呈现（列表、卡片、按钮）？

3. **Critical 字段标识**：
   - 如何视觉化 Critical 字段的重要性？
   - 是否需要在 UI 中明确区分 Critical 和非 Critical 字段？

### 技术实现层面

1. **类型定义更新**：
   - 是否需要创建新的类型定义，还是更新现有类型？
   - 如何保持向后兼容？

2. **字段名映射**：
   - 映射逻辑放在哪里（API 层、类型层、组件层）？
   - 是否需要创建适配器函数？

3. **错误处理**：
   - Gate 预检查失败时，如何区分"需要澄清"和"Gate 阻止"？
   - 错误响应格式是否统一？

---

## 实施建议（初步）

### 阶段 1：类型定义更新

1. **更新 `NLClarificationQuestion` 类型**：
   ```typescript
   export interface NLClarificationQuestion {
     id: string;
     question: string;  // 更新：支持 question 和 text（向后兼容）
     text?: string;    // 向后兼容
     type: 'text' | 'single_choice' | 'multi_choice' | 'date' | 'number' | 'boolean';
     inputType?: string;  // 向后兼容
     // ...
     metadata?: {
       // ...
       isCritical?: boolean;  // 新增
       fieldName?: string;    // 新增
     };
   }
   ```

2. **创建适配器函数**：
   ```typescript
   function normalizeClarificationQuestion(q: any): NLClarificationQuestion {
     return {
       id: q.id,
       question: q.question || q.text,  // 兼容两种字段名
       text: q.question || q.text,      // 向后兼容
       type: q.type || q.inputType,     // 兼容两种字段名
       inputType: q.type || q.inputType, // 向后兼容
       // ...
     };
   }
   ```

### 阶段 2：API 层更新

1. **确认请求参数**：
   - 确认 `contextPackageId` 和 `context` 是否保留
   - 确认 `clarificationAnswers` 是否保留

2. **响应处理**：
   - 响应格式已支持（`ApiResponseWrapper<T>`）
   - 需要添加字段名映射逻辑

### 阶段 3：组件层更新

1. **Gate 警告 UI**：
   - 实现 `GateWarningCard` 组件
   - 集成到 `NLChatInterface`

2. **Critical 字段标识**：
   - 在 `NLClarificationQuestionCard` 中添加 Critical 标识
   - 添加验证逻辑（Critical 字段未回答时禁用提交）

3. **后台生成状态**：
   - 显示 `generatingItems` 状态
   - 提供刷新按钮

---

## 风险评估

### 高风险项

1. **字段名变更**：
   - 风险：前后端字段名不一致导致数据丢失
   - 缓解：创建适配器函数，兼容新旧两种格式

2. **向后兼容**：
   - 风险：通用流程可能受影响
   - 缓解：保持现有类型定义，添加新字段作为可选

3. **Gate 预检查交互**：
   - 风险：用户不理解 Gate 警告，无法继续
   - 缓解：清晰的 UI 提示和替代方案展示

### 中风险项

1. **会话管理**：
   - 风险：会话过期或丢失导致用户体验下降
   - 缓解：实现会话恢复机制和过期提示

2. **Critical 字段验证**：
   - 风险：用户不理解 Critical 字段的重要性
   - 缓解：清晰的视觉标识和提示文案

---

## 下一步行动

1. **等待多角色评估**：邀请产品经理、交互设计专家、体验设计专家、前端架构师、前端工程师提供评估意见
2. **确认 API 细节**：与后端确认请求参数和响应格式的完整定义
3. **制定实施计划**：根据评估结果制定详细的实施计划
4. **开始实施**：按照阶段逐步实施

---

**文档状态**：待评估  
**最后更新**：2026-01-30
