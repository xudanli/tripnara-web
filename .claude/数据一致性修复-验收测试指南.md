# 数据一致性修复 - 验收测试指南

## 🎯 测试目标

验证优化操作后，健康度面板与行程项显示的冲突数据保持一致。

---

## 📋 测试前准备

### 1. 测试环境
- ✅ 确保后端服务正常运行
- ✅ 确保前端应用已部署最新代码
- ✅ 准备一个存在时间冲突的测试行程

### 2. 测试数据要求
- 行程中至少包含 2-3 个存在时间冲突的行程项
- 健康度面板显示可执行度 < 80%（确保有优化空间）
- 助手中心有可用的优化建议

### 3. 浏览器工具准备
- 打开浏览器开发者工具（F12）
- 切换到 **Console** 标签页（观察日志）
- 切换到 **Network** 标签页（观察 API 请求）

---

## 🧪 测试场景

### 场景 1：应用建议后数据同步 ✅

#### 操作步骤
1. 打开存在时间冲突的行程详情页
2. 记录当前状态：
   - 健康度面板的可执行度分数：`____`
   - 行程项中显示"时间冲突"的数量：`____`
   - 冲突详情描述：`____`
3. 滚动到助手中心区域
4. 找到一个与时间冲突相关的建议（如"调整时间"、"解决冲突"）
5. 点击建议的"应用"按钮
6. 等待操作完成（观察加载状态）

#### 验证要点
- [ ] **健康度面板更新**：可执行度分数是否更新？
- [ ] **行程项冲突状态更新**：如果冲突已解决，"时间冲突"徽章是否消失？
- [ ] **冲突详情更新**：冲突详情描述是否更新或消失？
- [ ] **数据一致性**：健康度面板显示的状态与行程项冲突状态是否一致？

#### 控制台验证
在浏览器控制台中应该看到：
```
[TripDetail] loadTripMetrics 被调用: { tripId: "...", ... }
[Trips API] 发送 getMetrics 请求: { tripId: "...", ... }
[Trip Detail API] 发送 getHealth 请求: { tripId: "...", ... }
[Trips API] getConflicts 请求: ...
```

#### Network 验证
在 Network 标签页中应该看到以下 API 请求**同时发起**（并行）：
- `GET /trips/:id/metrics` ✅
- `GET /trip-detail/:tripId/health` ✅
- `GET /trips/:id/conflicts` ✅
- `GET /trips/:id` ✅
- `GET /trips/:id/suggestions` ✅

---

### 场景 2：一键重新排程后数据同步 ✅

#### 操作步骤
1. 打开存在时间冲突的行程详情页
2. 切换到"规划"标签页
3. 点击"节奏"子标签（DrDreView）
4. 记录当前状态：
   - 健康度面板的可执行度分数：`____`
   - 行程项中显示"时间冲突"的数量：`____`
5. （可选）锁定部分行程项（点击锁定图标）
6. 点击"一键重新排程"按钮
7. 等待排程完成（观察加载状态和成功提示）

#### 验证要点
- [ ] **健康度面板更新**：可执行度、缓冲等指标是否更新？
- [ ] **行程项时间更新**：行程项的时间是否已调整？
- [ ] **冲突状态更新**：如果冲突已解决，"时间冲突"徽章是否消失？
- [ ] **数据一致性**：健康度面板显示的状态与行程项冲突状态是否一致？

#### 控制台验证
应该看到：
```
[DrDreView] 开始重新排程: { tripId: "...", ... }
[DrDreView] 重新排程API响应: { ... }
[TripDetail] loadTripMetrics 被调用: { tripId: "...", ... }
```

---

### 场景 3：应用修复方案后数据同步 ✅

#### 操作步骤
1. 打开存在时间冲突的行程详情页
2. 切换到"规划"标签页
3. 点击"修复"子标签（NeptuneView）
4. 记录当前状态：
   - 健康度面板的可执行度分数：`____`
   - 行程项中显示"时间冲突"的数量：`____`
5. 找到一个有问题的行程项
6. 点击"应用修复"或"应用替代方案"
7. 等待操作完成

#### 验证要点
- [ ] **健康度面板更新**：可执行度分数是否更新？
- [ ] **行程项冲突状态更新**：如果冲突已解决，"时间冲突"徽章是否消失？
- [ ] **数据一致性**：健康度面板显示的状态与行程项冲突状态是否一致？

---

### 场景 4：自动优化后数据同步 ✅

#### 操作步骤
1. 打开存在时间冲突的行程详情页
2. 滚动到助手中心区域
3. 记录当前状态：
   - 健康度面板的可执行度分数：`____`
   - 行程项中显示"时间冲突"的数量：`____`
4. 点击"一键优化"或"自动优化"按钮
5. 在弹窗中确认应用优化方案
6. 等待操作完成

#### 验证要点
- [ ] **健康度面板更新**：可执行度分数是否更新？
- [ ] **行程项冲突状态更新**：如果冲突已解决，"时间冲突"徽章是否消失？
- [ ] **数据一致性**：健康度面板显示的状态与行程项冲突状态是否一致？

---

## 🔍 详细验证方法

### 方法 1：视觉验证（主要方法）

#### 健康度面板检查
1. 查看顶部健康度面板
2. 记录"可执行度"分数
3. 查看整体健康度百分比
4. 查看健康度提示文字

#### 行程项检查
1. 滚动到行程项列表
2. 检查每个行程项是否显示"时间冲突"徽章
3. 展开有冲突的行程项，查看冲突详情
4. 记录冲突描述（如"活动'索斯莫克'与'米湖'时间重叠240分钟"）

#### 一致性对比
- **如果健康度面板显示"可执行度 10%"** → 行程项应该显示多个"时间冲突"徽章
- **如果健康度面板显示"可执行度 100%"** → 行程项不应该显示"时间冲突"徽章
- **如果健康度面板显示"可执行度 50%"** → 行程项应该显示部分"时间冲突"徽章

### 方法 2：控制台日志验证

打开浏览器控制台，执行优化操作后，应该看到以下日志：

```javascript
// 1. 应用建议时
[TripDetail] loadTripMetrics 被调用: { tripId: "...", ... }
[Trips API] 发送 getMetrics 请求: { tripId: "...", ... }
[Trip Detail API] 发送 getHealth 请求: { tripId: "...", ... }

// 2. 重新排程时
[DrDreView] 开始重新排程: { tripId: "...", ... }
[TripDetail] loadTripMetrics 被调用: { tripId: "...", ... }

// 3. 应用修复时
[TripDetail] loadTripMetrics 被调用: { tripId: "...", ... }
```

**验证要点：**
- ✅ `loadTripMetrics()` 是否被调用？
- ✅ `loadTripHealth()` 是否被调用？
- ✅ `loadConflicts()` 是否被调用？

### 方法 3：Network 请求验证

在 Network 标签页中：

1. **清空网络日志**（点击 🚫 图标）
2. **执行优化操作**（如应用建议）
3. **观察请求列表**

应该看到以下请求**同时发起**（不是串行）：

```
GET /trips/:id/metrics          ✅ 200 OK (用于行程项冲突显示)
GET /trip-detail/:tripId/health  ✅ 200 OK (用于健康度面板)
GET /trips/:id/conflicts         ✅ 200 OK (用于冲突列表)
GET /trips/:id                   ✅ 200 OK (用于行程数据)
GET /trips/:id/suggestions       ✅ 200 OK (用于建议列表)
```

**验证要点：**
- ✅ 所有请求是否**并行发起**（时间戳相近）？
- ✅ 请求是否都成功（状态码 200）？
- ✅ 响应时间是否合理（< 3秒）？

---

## ✅ 验收检查清单

### 功能测试
- [ ] **场景 1**：应用建议后数据同步 ✅
- [ ] **场景 2**：重新排程后数据同步 ✅
- [ ] **场景 3**：应用修复后数据同步 ✅
- [ ] **场景 4**：自动优化后数据同步 ✅

### 数据一致性测试
- [ ] 健康度面板显示的可执行度与行程项冲突状态一致
- [ ] 行程项中的冲突徽章与健康度面板的警告状态一致
- [ ] 冲突详情描述与实际冲突状态一致

### 性能测试
- [ ] 优化操作后数据刷新时间 < 3秒
- [ ] 多个 API 并行调用，不阻塞 UI
- [ ] 刷新过程中有加载状态提示

### 边界情况测试
- [ ] 优化后冲突未完全解决的情况（部分冲突仍存在）
- [ ] 优化后产生新冲突的情况（需要重新优化）
- [ ] 网络错误或 API 失败的情况（错误处理）

---

## 🐛 常见问题排查

### 问题 1：数据仍然不一致

**排查步骤：**
1. 检查控制台是否有错误日志
2. 检查 Network 标签页，确认所有 API 请求都成功
3. 检查 `loadTripMetrics()` 是否被调用
4. 检查 API 响应数据是否正确

**可能原因：**
- API 响应数据格式不正确
- 后端数据未及时更新
- 前端缓存问题（尝试强制刷新 Ctrl+F5）

### 问题 2：刷新时间过长

**排查步骤：**
1. 检查 Network 标签页，查看哪个 API 请求最慢
2. 检查是否有 API 请求失败或超时
3. 检查后端服务性能

**可能原因：**
- 后端服务响应慢
- 网络延迟
- API 请求串行执行（应该是并行）

### 问题 3：UI 阻塞

**排查步骤：**
1. 检查是否有 API 请求串行执行
2. 检查是否有未处理的 Promise
3. 检查是否有无限循环

**可能原因：**
- API 请求未使用 `Promise.all()` 并行执行
- 有阻塞的同步操作

---

## 📊 验收结果记录

### 测试环境
- **测试日期：** _______________
- **测试人员：** _______________
- **浏览器：** _______________
- **测试行程 ID：** _______________

### 测试结果

| 测试场景 | 通过/失败 | 备注 |
|---------|----------|------|
| 场景 1：应用建议 | ⬜ | |
| 场景 2：重新排程 | ⬜ | |
| 场景 3：应用修复 | ⬜ | |
| 场景 4：自动优化 | ⬜ | |
| 数据一致性 | ⬜ | |
| 性能测试 | ⬜ | |
| 边界情况 | ⬜ | |

### 发现的问题

**问题 1：**
- 描述：_______________________________________________
- 严重程度：⬜ P0（阻塞） ⬜ P1（重要） ⬜ P2（一般）
- 截图：_______________

**问题 2：**
- 描述：_______________________________________________
- 严重程度：⬜ P0（阻塞） ⬜ P1（重要） ⬜ P2（一般）
- 截图：_______________

### 验收结论

- [ ] ✅ **通过验收** - 所有测试场景通过，可以上线
- [ ] ⚠️ **有条件通过** - 存在 P1/P2 问题，但不影响核心功能
- [ ] ❌ **不通过** - 存在 P0 问题，需要修复后重新测试

**验收意见：**
_______________________________________________
_______________________________________________
_______________________________________________

**签名：** _______________  
**日期：** _______________

---

## 📎 相关文档

- [数据一致性修复-产品验收文档](./数据一致性修复-产品验收文档.md)
- [优化操作后健康度重新加载-修复总结](./优化操作后健康度重新加载-修复总结.md)
