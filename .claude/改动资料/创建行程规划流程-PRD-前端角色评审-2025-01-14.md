# 创建行程规划流程 PRD - 前端角色评审

**评审日期**：2025-01-14  
**评审角色**：
- 资深前端架构师
- 前端设计系统工程师
- Agent UI 集成工程 Agent

**评审范围**：PRD 文档中的前端相关内容，重点关注：
- 0.10 核心能力：结构化澄清问题（前端组件设计）
- 0.11 页面与交互设计（信息架构、组件、状态、文案）
- 数据模型与字段字典（涉及前端部分）

---

## 一、资深前端架构师评审

### 1.1 数据模型与类型定义

#### ✅ **优点**

1. **结构化澄清问题的类型定义清晰**
   - `ClarificationQuestionType` 枚举定义明确
   - `ClarificationQuestion` 接口字段完整（id, question, type, options, required, placeholder, hint, default, validation）
   - `ClarificationAnswer` 接口字段清晰（questionId, value）

2. **向后兼容策略合理**
   - 支持 `clarificationMessage` 和 `clarificationQuestions` 两种格式
   - 提供了向后兼容的解析逻辑

#### ⚠️ **问题与建议**

1. **类型定义位置不明确**
   - **问题**：PRD 中提到了 `src/types/clarification.ts`（新建），但没有说明是否需要在 `src/api/agent.ts` 中也定义相关类型
   - **建议**：
     - 如果 `RouteAndRunResponsePayload` 需要扩展 `clarificationQuestions` 字段，需要在 `src/api/agent.ts` 中更新类型定义
     - 建议在 PRD 中明确说明类型定义的位置和依赖关系

2. **API 接口扩展缺少类型定义**
   - **问题**：PRD 中提到了 `RouteAndRunResponsePayload` 需要新增 `clarificationQuestions?: ClarificationQuestion[]`，但没有提供完整的类型定义代码
   - **建议**：在 PRD 中提供完整的类型定义代码，包括：
     ```typescript
     // src/types/clarification.ts
     export type ClarificationQuestionType = 'text' | 'single_choice' | 'multi_choice' | 'date' | 'number';
     
     export interface ClarificationQuestion {
       id: string;
       question: string;
       type: ClarificationQuestionType;
       options?: string[];
       required: boolean;
       placeholder?: string;
       hint?: string;
       default?: string | string[];
       validation?: {
         min?: number;
         max?: number;
         pattern?: string;
       };
     }
     
     export interface ClarificationAnswer {
       questionId: string;
       value: string | string[] | number | null;
     }
     
     // src/api/agent.ts（扩展）
     export interface RouteAndRunResponsePayload {
       // ... 现有字段
       clarificationMessage?: string;
       clarificationQuestions?: ClarificationQuestion[];  // 新增
       // ... 其他字段
     }
     ```

3. **日期验证规则类型不一致**
   - **问题**：`validation.min` 和 `validation.max` 在 `date` 类型中使用时间戳（`number`），但在示例中使用 `new Date().getTime()`，类型定义中写的是 `number`
   - **建议**：明确日期验证规则的类型，建议使用 `number`（时间戳）或 `string`（ISO 8601 格式），并在文档中说明

### 1.2 API 接口设计

#### ✅ **优点**

1. **使用现有接口**
   - 使用 `POST /agent/route_and_run` 接口（`agentApi.routeAndRun()`）
   - 符合现有架构设计

2. **状态处理清晰**
   - 明确了 `NEED_MORE_INFO` 状态的处理方式
   - 提供了多轮澄清的流程设计

#### ⚠️ **问题与建议**

1. **缺少 API 响应结构的完整说明**
   - **问题**：PRD 中提到了 `RouteAndRunResponse.result.payload.clarificationQuestions`，但没有说明完整的数据结构
   - **建议**：在 PRD 中提供完整的 API 响应示例，包括：
     ```typescript
     {
       result: {
         status: 'NEED_MORE_INFO',
         payload: {
           clarificationQuestions: [
             {
               id: 'question-1',
               question: '请选择您的出行日期',
               type: 'date',
               required: true,
               // ...
             }
           ]
         }
       }
     }
     ```

2. **多轮澄清的 conversation_context 处理不明确**
   - **问题**：PRD 中提到了通过 `conversation_context.recent_messages` 传递历史，但没有说明具体的格式
   - **建议**：明确说明多轮澄清时如何构建 `conversation_context`，包括：
     - 如何格式化用户的回答
     - 如何传递历史问题
     - 如何标识澄清轮数

### 1.3 状态管理

#### ✅ **优点**

1. **UI 状态映射清晰**
   - `OrchestrationStep` → `UIStatus` 映射表完整
   - 状态指示器设计合理

#### ⚠️ **问题与建议**

1. **缺少状态管理的实现建议**
   - **问题**：PRD 中提到了状态指示器，但没有说明如何在 React 组件中管理这些状态
   - **建议**：在 PRD 中说明状态管理的实现方式，包括：
     - 使用 `useState` 管理当前状态
     - 使用 `useEffect` 监听 API 响应
     - 如何处理状态转换

2. **澄清问题的状态管理不明确**
   - **问题**：PRD 中提到了多轮澄清，但没有说明如何管理澄清问题的状态（已回答、未回答、验证错误等）
   - **建议**：说明澄清问题的状态管理，包括：
     - 如何存储用户回答
     - 如何管理验证状态
     - 如何重置状态（如果用户取消）

### 1.4 服务层设计

#### ✅ **优点**

1. **直接使用 Agent API**
   - 使用 `agentApi.routeAndRun()` 而不是 `orchestrator.ts`
   - 符合 PRD 中的设计决策（0.6.4 节）

#### ⚠️ **问题与建议**

1. **是否需要服务层封装**
   - **问题**：PRD 中提到了直接使用 `agentApi.routeAndRun()`，但没有说明是否需要服务层封装（例如：错误处理、重试逻辑、状态转换等）
   - **建议**：说明是否需要服务层封装，如果需要，说明封装的内容和理由

---

## 二、前端设计系统工程师评审

### 2.1 组件设计

#### ✅ **优点**

1. **组件结构清晰**
   - `ClarificationQuestionsPanel` 和 `ClarificationQuestionCard` 组件职责明确
   - 组件层次结构合理

2. **使用现有组件**
   - 使用 `Card`、`Textarea`、`Input`、`Select`、`RadioGroup`、`Checkbox` 等现有组件
   - 符合设计系统规范

3. **输入组件映射合理**
   - `text` → `Textarea` / `Input`
   - `single_choice` → `RadioGroup` / `Select`
   - `multi_choice` → `Checkbox` 组
   - `date` → `Input type="date"`
   - `number` → `Input type="number"`

#### ⚠️ **问题与建议**

1. **缺少组件 Props 的完整定义**
   - **问题**：PRD 中提供了 `ClarificationQuestionCard` 的 Props 接口（简化版），但没有提供完整的类型定义
   - **建议**：在 PRD 中提供完整的组件 Props 类型定义，包括：
     ```typescript
     interface ClarificationQuestionCardProps {
       question: ClarificationQuestion;
       value: string | string[] | number | null;
       onChange: (value: string | string[] | number | null) => void;
       error?: string;
       disabled?: boolean;
       className?: string;  // 支持自定义样式
     }
     ```

2. **输入组件的选择标准不明确**
   - **问题**：PRD 中提到了 `text` 类型可以使用 `Textarea` 或 `Input`，但没有说明选择标准
   - **建议**：明确选择标准，例如：
     - 如果 `question.question` 长度 > 50 字符，使用 `Textarea`
     - 否则使用 `Input`
     - 或者根据 `placeholder` 的长度判断

3. **日期选择器组件不明确**
   - **问题**：PRD 中提到了 `DatePicker` 或 `Input type="date"`，但没有说明项目是否有 `DatePicker` 组件
   - **建议**：
     - 如果项目有 `DatePicker` 组件，说明使用哪个组件
     - 如果没有，说明使用 `Input type="date"` 或需要创建 `DatePicker` 组件

4. **多选组件的布局不明确**
   - **问题**：PRD 中提到了 `multi_choice` 使用 `Checkbox` 组，但没有说明布局方式（垂直堆叠、网格布局等）
   - **建议**：说明多选组件的布局方式，例如：
     - 垂直堆叠（`space-y-2`）
     - 或者网格布局（`grid-cols-2` 或 `grid-cols-3`）

5. **错误提示的样式不明确**
   - **问题**：PRD 中提到了错误提示（红色文本），但没有说明具体的样式和位置
   - **建议**：说明错误提示的样式，例如：
     - 位置：输入框下方
     - 样式：`text-sm text-red-500 mt-1`
     - 使用 `Alert` 组件还是纯文本

### 2.2 设计系统一致性

#### ✅ **优点**

1. **使用设计系统组件**
   - 使用 `Card`、`Button`、`Badge` 等现有组件
   - 符合设计系统规范

2. **状态指示器设计合理**
   - 使用现有 `StatusIndicator` 组件
   - 状态颜色和图标符合设计系统

#### ⚠️ **问题与建议**

1. **澄清问题卡片的样式规范不明确**
   - **问题**：PRD 中提到了 `border-yellow-200 bg-yellow-50/30`，但没有说明这些颜色是否符合设计系统的 token
   - **建议**：说明使用的颜色是否来自设计系统 token，例如：
     - 使用 `bg-warning/10` 和 `border-warning/20`（如果设计系统有 warning token）
     - 或者使用自定义颜色（需要说明理由）

2. **状态指示器的实现细节不明确**
   - **问题**：PRD 中提到了 `StatusIndicator` 组件，但没有说明是否需要修改或扩展
   - **建议**：说明是否需要修改 `StatusIndicator` 组件，如果需要，说明修改的内容

3. **响应式设计的断点不明确**
   - **问题**：PRD 中提到了响应式设计（0.11.7 节），但没有说明使用的断点是否符合设计系统
   - **建议**：说明使用的断点（例如：`sm:`, `md:`, `lg:`），并确认是否符合设计系统的断点规范

### 2.3 可访问性（A11y）

#### ✅ **优点**

1. **可访问性考虑全面**
   - 键盘导航、屏幕阅读器支持、视觉反馈都有考虑

#### ⚠️ **问题与建议**

1. **缺少具体的可访问性实现细节**
   - **问题**：PRD 中提到了可访问性要求，但没有说明具体的实现方式
   - **建议**：说明具体的实现方式，例如：
     - `Label` 组件如何使用 `htmlFor` 关联输入
     - `aria-describedby` 如何关联错误提示
     - `aria-live` 如何使用（状态指示器）

---

## 三、Agent UI 集成工程 Agent 评审

### 3.1 状态机与 UI 状态映射

#### ✅ **优点**

1. **状态映射表完整**
   - `OrchestrationStep` → `UIStatus` 映射清晰
   - 状态文案详细

2. **状态指示器设计合理**
   - 使用现有 `StatusIndicator` 组件
   - 状态图标和颜色符合现有设计

#### ⚠️ **问题与建议**

1. **状态转换逻辑不明确**
   - **问题**：PRD 中提到了状态映射，但没有说明状态如何转换（例如：从 `thinking` 转换到 `browsing`）
   - **建议**：说明状态转换的逻辑，包括：
     - 如何监听 API 响应中的 `OrchestrationStep`
     - 如何更新 UI 状态
     - 如何处理状态转换错误

2. **状态指示器的实时更新不明确**
   - **问题**：PRD 中提到了"实时更新状态"，但没有说明如何实现实时更新（轮询、SSE、WebSocket 等）
   - **建议**：说明实时更新的实现方式，包括：
     - 如果使用轮询，说明轮询间隔
     - 如果使用 SSE/WebSocket，说明事件格式
     - 如果使用长轮询，说明实现方式

3. **澄清问题的状态管理不明确**
   - **问题**：PRD 中提到了多轮澄清，但没有说明如何管理澄清问题的状态（显示/隐藏、已回答/未回答等）
   - **建议**：说明澄清问题的状态管理，包括：
     - 如何判断是否需要显示澄清问题
     - 如何管理澄清问题的显示/隐藏
     - 如何重置状态（如果用户取消）

### 3.2 事件流处理

#### ✅ **优点**

1. **使用现有 API**
   - 使用 `agentApi.routeAndRun()` 接口
   - 符合现有架构设计

#### ⚠️ **问题与建议**

1. **缺少事件流处理的说明**
   - **问题**：PRD 中提到了"实时更新状态"，但没有说明是否支持事件流（SSE/WebSocket）
   - **建议**：说明事件流处理的实现方式，包括：
     - 如果支持事件流，说明事件格式和处理方式
     - 如果不支持，说明轮询或长轮询的实现方式
     - 说明如何处理连接断开和重连

2. **多轮澄清的事件流处理不明确**
   - **问题**：PRD 中提到了多轮澄清，但没有说明如何在事件流中处理澄清问题
   - **建议**：说明多轮澄清的事件流处理，包括：
     - 如何识别澄清问题的响应
     - 如何更新澄清问题的状态
     - 如何处理澄清问题的提交

### 3.3 Agent 集成

#### ✅ **优点**

1. **使用现有 Agent API**
   - 使用 `agentApi.routeAndRun()` 接口
   - 符合现有架构设计

2. **状态处理清晰**
   - `NEED_MORE_INFO` 状态处理明确
   - 多轮澄清流程清晰

#### ⚠️ **问题与建议**

1. **缺少错误处理的说明**
   - **问题**：PRD 中提到了错误状态（`FAILED`、`TIMEOUT`），但没有说明具体的错误处理方式
   - **建议**：说明错误处理的实现方式，包括：
     - 如何显示错误提示
     - 如何提供重试选项
     - 如何处理网络错误

2. **缺少加载状态的说明**
   - **问题**：PRD 中提到了加载状态（0.11.8 节），但没有说明加载状态的具体实现
   - **建议**：说明加载状态的实现方式，包括：
     - 如何使用 `Spinner` 组件
     - 如何禁用输入框和按钮
     - 如何显示加载提示

---

## 四、共同关注的问题

### 4.1 数据验证

#### ⚠️ **问题与建议**

1. **验证规则的实现细节不明确**
   - **问题**：PRD 中提到了验证规则（0.10.6 节），但没有说明具体的实现方式
   - **建议**：说明验证规则的实现方式，包括：
     - 如何使用 `validation.pattern`（正则表达式）
     - 如何使用 `validation.min` / `validation.max`（数值范围）
     - 如何显示验证错误

2. **实时验证的实现不明确**
   - **问题**：PRD 中提到了"实时验证（可选）"，但没有说明实现方式
   - **建议**：说明实时验证的实现方式，包括：
     - 是否使用 `onChange` 事件
     - 是否使用 `onBlur` 事件
     - 如何防抖（debounce）

### 4.2 向后兼容

#### ✅ **优点**

1. **向后兼容策略清晰**
   - 支持 `clarificationMessage` 和 `clarificationQuestions` 两种格式
   - 提供了向后兼容的解析逻辑

#### ⚠️ **问题与建议**

1. **向后兼容的解析逻辑不完整**
   - **问题**：PRD 中提供了向后兼容的解析逻辑（伪代码），但没有说明完整的实现
   - **建议**：说明完整的实现方式，包括：
     - 如何判断使用哪种格式
     - 如何解析 `clarificationMessage`（Markdown 格式）
     - 如何处理解析错误

### 4.3 多轮澄清

#### ⚠️ **问题与建议**

1. **轮数限制的实现不明确**
   - **问题**：PRD 中提到了"最多 5 轮"，但没有说明如何实现轮数限制
   - **建议**：说明轮数限制的实现方式，包括：
     - 如何记录澄清轮数
     - 如何显示提示（超过 5 轮后）
     - 如何处理用户继续（如果用户愿意）

2. **澄清问题的回答格式不明确**
   - **问题**：PRD 中提到了"格式化后的文本"，但没有说明具体的格式
   - **建议**：说明澄清问题的回答格式，包括：
     - 如何格式化用户的回答
     - 如何构建 `conversation_context.recent_messages`
     - 如何标识澄清轮数

---

## 五、总结与建议

### 5.1 需要补充的内容

1. **类型定义的完整代码**
   - 在 PRD 中提供完整的 TypeScript 类型定义代码
   - 明确类型定义的位置和依赖关系

2. **API 接口的完整说明**
   - 提供完整的 API 响应示例
   - 说明多轮澄清的 `conversation_context` 格式

3. **组件实现的详细说明**
   - 提供完整的组件 Props 类型定义
   - 说明组件的具体实现细节（布局、样式、验证等）

4. **状态管理的实现说明**
   - 说明状态管理的实现方式
   - 说明状态转换的逻辑

5. **事件流处理的说明**
   - 说明事件流处理的实现方式（如果支持）
   - 说明轮询或长轮询的实现方式（如果不支持）

### 5.2 需要澄清的问题

1. **日期选择器组件**
   - 项目是否有 `DatePicker` 组件？
   - 如果没有，是否需要创建？

2. **实时更新方式**
   - 是否支持事件流（SSE/WebSocket）？
   - 如果不支持，使用轮询还是长轮询？

3. **服务层封装**
   - 是否需要服务层封装？
   - 如果需要，封装的内容是什么？

4. **设计系统 Token**
   - 澄清问题卡片的颜色是否符合设计系统 token？
   - 状态指示器的实现是否需要修改？

### 5.3 建议的下一步行动

1. **补充类型定义**
   - 在 PRD 中添加完整的 TypeScript 类型定义代码
   - 明确类型定义的位置和依赖关系

2. **补充 API 接口说明**
   - 提供完整的 API 响应示例
   - 说明多轮澄清的 `conversation_context` 格式

3. **补充组件实现说明**
   - 提供完整的组件 Props 类型定义
   - 说明组件的具体实现细节

4. **补充状态管理说明**
   - 说明状态管理的实现方式
   - 说明状态转换的逻辑

5. **补充事件流处理说明**
   - 说明事件流处理的实现方式
   - 说明轮询或长轮询的实现方式

---

**评审完成日期**：2025-01-14  
**评审人员**：资深前端架构师、前端设计系统工程师、Agent UI 集成工程 Agent
