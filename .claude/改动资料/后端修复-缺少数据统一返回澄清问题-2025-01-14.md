# 修复：缺少数据统一返回澄清问题

**修复日期**: 2025-01-14  
**修复角色**: 后端工程师  
**问题**: `decision.runThreeGuardians` 缺少 `world` 或 `tripId` 时，应该统一返回澄清问题，而不是自动构建

---

## 🔴 问题描述

从日志看：
```
[DecisionRunThreeGuardiansSkill] 执行 decision.runThreeGuardians: tripId=none
[DecisionRunThreeGuardiansSkill] 执行三人格策略失败: 必须提供 world 或 tripId
Error: 必须提供 world 或 tripId
```

**问题**：
- 在创建新行程的场景下，`tripId` 为 `null`
- `decision.runThreeGuardians` 需要 `world` 或 `tripId` 参数
- 之前尝试自动构建 `world`，但用户要求：如果没有识别到的数据统一让客户澄清

---

## ✅ 修复方案

### 原则

**统一澄清原则**：如果系统无法识别到必需的数据，统一返回澄清问题，让用户明确知道缺少什么信息。

### 修复内容

1. **移除自动构建 `world` 的逻辑**
   - 之前：当缺少 `world` 和 `tripId` 时，尝试自动调用 `world.buildContext` 构建 `world`
   - 现在：不自动构建，让 skill 抛出错误，系统统一返回澄清问题

2. **错误处理流程**
   - `decision.runThreeGuardians` 抛出 "必须提供 world 或 tripId" 错误
   - `inferErrorType` 识别为 `MISSING_REQUIRED_PARAM`
   - `buildMissingParamClarificationMessage` 构建用户友好的澄清消息
   - 返回澄清问题给前端

---

## 🔧 已实施的修复

### 修改文件

**文件**: `src/agent/services/claude-orchestrator.service.ts`

**修改前**：
```typescript
// 如果还是没有 world 和 tripId，尝试自动构建 world（创建新行程场景）
if (!input.world && !input.tripId) {
  // 尝试从 request 或 input 中提取 countryCode
  const countryCode = input.countryCode || 
                     this.extractCountryCodeFromMessage(request.message);
  
  if (countryCode && this.skillsRegistry) {
    // 自动调用 world.buildContext 构建 world
    try {
      const worldBuildContextSkill = this.skillsRegistry.getSkill('world.buildContext');
      if (worldBuildContextSkill) {
        const worldResult = await worldBuildContextSkill.execute({
          countryCode,
          season: input.season,
          duration: input.duration,
          partyProfile: input.partyProfile,
        });
        
        if (worldResult && worldResult.world) {
          input.world = worldResult.world;
        }
      }
    } catch (error: any) {
      this.logger.warn(`自动构建 world 失败: ${error.message}`);
    }
  }
}
```

**修改后**：
```typescript
// 注意：如果没有 world 和 tripId，不自动构建，让 skill 抛出错误，系统会统一返回澄清问题
// 这样用户可以明确知道缺少什么信息
```

---

## ✅ 修复后的行为

### 错误处理流程

1. **Skill 执行失败**
   - `decision.runThreeGuardians` 检测到缺少 `world` 和 `tripId`
   - 抛出错误：`必须提供 world 或 tripId`

2. **错误类型识别**
   - `inferErrorType` 识别错误消息包含 "必须提供"
   - 返回 `ErrorType.MISSING_REQUIRED_PARAM`

3. **澄清消息构建**
   - `buildMissingParamClarificationMessage` 构建澄清消息
   - 提取缺失的参数（`world` 或 `tripId`）
   - 提供解决方案建议

4. **返回澄清问题**
   - 返回 `clarificationMessage` 给前端
   - 前端显示澄清问题，引导用户提供缺失信息

---

## 📋 错误处理策略

### MISSING_REQUIRED_PARAM 策略

```typescript
{
  shouldReject: false,
  shouldShowClarification: true,
  allowRetry: true,
  requiresUserConfirmation: true,
  messageTemplate: '无法完成行程规划，因为缺少必需的信息。',
  suggestedSolutions: [
    '提供完整的请求信息',
    '检查请求参数是否完整',
    '提供更多上下文信息',
  ],
}
```

### 错误识别规则

**前端错误识别**（`src/utils/agent-error-types.ts`）：

`inferErrorType` 识别以下关键词：
- `缺少` ✅（已支持）
- `必需` ✅（已支持）
- `必须提供` ⚠️（需要验证是否能匹配 "必须提供 world 或 tripId"）
- `是必需的`
- `is required`
- `必须传入`
- `missing`

**注意**：前端的 `inferErrorType` 函数当前识别 `缺少` 和 `必需`，但 "必须提供 world 或 tripId" 错误消息包含 "必须提供"，需要确认是否能被正确识别。如果不能，可能需要：
1. 后端返回的错误消息包含 "缺少" 或 "必需" 关键词，或
2. 前端扩展识别规则以包含 "必须提供"

---

## ✅ 修复状态

### 后端
- ⚠️ 待实施：移除自动构建 `world` 的逻辑
- ⚠️ 待验证：确保错误能正确识别为 `MISSING_REQUIRED_PARAM`
- ⚠️ 待验证：确保澄清消息能正确构建和返回
- ⚠️ 待测试：代码编译通过

### 前端
- ✅ 已支持：`MISSING_REQUIRED_PARAM` 错误类型识别（`src/utils/agent-error-types.ts`）
- ✅ 已修复：扩展错误识别规则，支持识别 "必须提供" 关键词
- ✅ 已支持：错误处理策略，会显示澄清消息并允许重试
- ✅ 已支持：澄清问题组件（`ClarificationQuestionsPanel`）可以显示结构化澄清问题

---

## 📋 测试验证

### 测试用例：缺少 world 和 tripId

**步骤**：
1. 发送创建新行程请求（不提供 `tripId`）
2. LLM 选择 `decision.runThreeGuardians` skill
3. Skill 检测到缺少 `world` 和 `tripId`
4. 抛出错误：`必须提供 world 或 tripId`

**预期**：
- ✅ 错误被识别为 `MISSING_REQUIRED_PARAM`
- ✅ 返回澄清消息给前端
- ✅ 前端显示澄清问题，引导用户提供缺失信息

### 测试场景

1. **创建新行程 - 缺少目的地**
   - 请求：`帮我规划行程`
   - 预期：返回澄清问题，询问目的地、日期、预算等信息

2. **创建新行程 - 缺少部分信息**
   - 请求：`帮我规划去冰岛的行程`
   - 预期：返回澄清问题，询问日期、预算、旅行者信息等

3. **已有行程 - 正常执行**
   - 请求：在已有行程详情页执行操作
   - 预期：正常执行，使用 `tripId` 获取 `world`

---

## 📝 相关文件

### 需要修改的文件（后端）

- `src/agent/services/claude-orchestrator.service.ts` - 移除自动构建 world 的逻辑

### 已修改的文件（前端）

- `src/utils/agent-error-types.ts` - 扩展错误识别规则，支持识别 "必须提供" 关键词

### 相关文件（可能需要检查）

- `src/agent/skills/decision/run-three-guardians.skill.ts` - skill 实现
- `src/agent/utils/error-handling.ts` - 错误类型识别
- `src/agent/utils/clarification-builder.ts` - 澄清消息构建

---

## 🎯 下一步行动

### 后端工程师

1. **移除自动构建逻辑**
   - 在 `claude-orchestrator.service.ts` 中找到自动构建 `world` 的代码
   - 移除该逻辑，添加注释说明原因

2. **验证错误处理流程**
   - 确保 `inferErrorType` 能正确识别 "必须提供 world 或 tripId" 错误
   - 确保错误被分类为 `MISSING_REQUIRED_PARAM`

3. **验证澄清消息构建**
   - 确保 `buildMissingParamClarificationMessage` 能正确构建澄清消息
   - 确保返回的澄清问题对用户友好

4. **测试验证**
   - 执行测试用例
   - 验证错误处理流程
   - 验证前端能正确显示澄清问题
   - **注意**：确保后端返回的错误消息能被前端正确识别
     - 如果错误消息是 "必须提供 world 或 tripId"，确保能被 `inferErrorType` 识别为 `MISSING_REQUIRED_PARAM`
     - 建议：错误消息应包含 "缺少" 或 "必需" 关键词，以确保前端能正确识别

---

**修复完成日期**: 2025-01-14  
**修复状态**: 
- 前端：✅ 已完成（扩展错误识别规则）
- 后端：⚠️ 待实施（移除自动构建 world 的逻辑）
