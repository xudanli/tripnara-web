# 创建行程规划流程设计思路

**产品经理：Danny**  
**日期：2025-01-14**  
**基于文档：规划智能体流程思路.md (1-1146行)**

---

## 📋 一、文档分析总结

### 1.1 流程思路文档核心发现

通过分析规划智能体流程思路文档，我识别出以下关键流程节点和模式：

#### **流程阶段识别**

1. **需求收集阶段**
   - 用户自然语言输入：`"用户请帮我规划26年春节去冰岛的10行程，预算100000元"`
   - 系统识别关键信息：目的地、日期、天数、预算
   - **交互模式**：直接输入 vs 结构化表单（用户选择了直接输入）

2. **需求澄清阶段（NEED_MORE_INFO）**
   - 系统主动提问（AskUserQuestion）
   - 关键澄清点：
     - 出行日期确认
     - 同行人数和特点
     - 主要兴趣（极光、冰川、文化等）
     - 舒适度偏好（住宿、餐饮）
     - 身体状况（户外经验）
   - **用户反馈**：简洁回答（"1.是的。2.与朋友。3.极光、冰川徒步。4.是的。5.没有"）

3. **Should-Exist Gate 评估阶段**
   - **风险识别矩阵**：
     - 🔴 HARD 风险：冬季极端天气、冰川徒步难度
     - 🟡 SOFT 风险：极光可见性、交通可达性
     - 🟢 OK：预算充分度
   - **Gate 结论**：`ADJUST_REQUIRED`
   - **必须调整项**：
     - ❌ 不允许：远离主干线的徒步路线
     - ⚠️ 强制：所有户外活动必须通过持证运营商
     - ⚠️ 强制：预留缓冲日
     - ✅ 允许：标准冰川徒步团

4. **行程生成阶段**
   - 生成结构化行程方案（10天详细安排）
   - 包含：日期、主题、关键活动、住宿地、预算
   - 证据标注（Evidence）：每个关键点位都有验证来源

5. **预算验证与修复阶段**
   - 初始预算：¥116,000（超出¥16,000）
   - **Repair 调整**：
     - 住宿降档（3星→2星+青旅）
     - 餐饮优化
     - 活动调整（蓝湖改地热温泉、极光改半自驾）
   - 最终预算：¥100,000 ✅

6. **详细行程输出阶段**
   - 每天详细行程（Day 1-10）
   - 包含：时间、地点、活动、交通、住宿、预算、证据
   - 风险提示和替代方案

7. **决策日志输出阶段**
   - 完整的 Decision Log（JSON格式）
   - 包含：request_id、gate_evaluation、itinerary_plan、verification_result、repair_actions、final_recommendation

---

## 🎯 二、设计思路框架

### 2.1 核心设计原则

基于 TripNARA 产品哲学和流程思路文档，设计必须遵循：

1. **决策优先（Decision-first）**
   - Should-Exist Gate 在行程生成之前执行
   - 所有决策必须有明确的证据支撑（Evidence Refs）

2. **可执行优先（Executable-first）**
   - 行程条目必须包含：时间窗 + 地点 + 证据 + 开放时间/票务
   - 不允许编造事实（No hallucinated facts）
   - 无法验证的内容必须标注 ASSUMPTION

3. **交互渐进式（Progressive Disclosure）**
   - 首次输入：最小化信息收集（自然语言输入）
   - 澄清阶段：按需提问（NEED_MORE_INFO）
   - 输出阶段：分层次展示（概览 → 详细 → 决策日志）

4. **状态透明（Transparency）**
   - 用户可以看到规划进度（Gate 评估中 → 行程生成中 → 修复中）
   - 所有决策可追溯（Decision Log）
   - 风险提示明确（HARD/SOFT 风险分类）

---

### 2.2 用户旅程设计（User Journey）

#### **主流程：自然语言创建行程**

```
用户意图产生
    ↓
[入口] 创建行程页面（/dashboard/trips/new）
    ↓
选择创建方式：自然语言 vs 结构化表单
    ↓
[自然语言输入] 用户输入："帮我规划26年春节去冰岛的10行程，预算100000元"
    ↓
[系统处理] 调用 POST /agent/route_and_run
    ├─ RouteType: SYSTEM2_REASONING（深度推理）
    ├─ 状态：thinking → researching
    └─ 结果状态：
        ├─ OK → 直接生成行程
        ├─ NEED_MORE_INFO → 进入澄清流程
        ├─ NEED_CONFIRMATION → 进入审批流程（高风险场景）
        └─ FAILED → 错误处理
    ↓
[需求澄清]（如果需要）
    系统提问（AskUserQuestion）
    用户回答（简洁/结构化）
    系统继续处理
    ↓
[Should-Exist Gate 评估]
    显示风险矩阵（HARD/SOFT/OK）
    显示 Gate 结论（ALLOW/ADJUST_REQUIRED/BLOCK）
    显示必须调整项
    ↓
[行程生成中]
    显示进度（"正在生成10天行程方案..."）
    可选：显示中间结果（部分行程）
    ↓
[预算验证与修复]
    如果预算超支 → 显示修复方案
    用户确认/调整修复方案
    ↓
[行程方案展示]
    概览视图（10天行程表）
    详细视图（每天详细行程）
    决策日志视图（可展开）
    ↓
[用户操作]
    ├─ 接受方案 → 创建行程 → 跳转到行程详情页
    ├─ 调整方案 → 重新规划（循环）
    └─ 保存为草稿 → 后续继续编辑
```

---

### 2.3 关键页面与组件设计思路

#### **2.3.1 创建行程页面（/dashboard/trips/new）**

**现状分析**：
- 已有结构化表单模式（`form` tab）
- 已有自然语言模式（`nl` tab）
- 已有澄清问题交互（`needsClarification` 状态）

**设计思路**：

1. **入口优化**
   - 默认显示自然语言输入（符合用户习惯）
   - 结构化表单作为"高级选项"（Expert Mode）

2. **自然语言输入优化**
   - 输入框：大文本域（支持多行）
   - 占位符提示：示例文案 + 关键信息提示
   - 快捷输入：支持语音输入（未来）

3. **状态反馈优化** ✅ **已更新：使用现有系统 UI 状态**
   - 使用现有系统的 UI 状态名称（`thinking` | `browsing` | `verifying` | `repairing` | `awaiting_consent` | `awaiting_confirmation` | `awaiting_user_input` | `done` | `failed`）
   - 状态映射关系：
     - `thinking` → `INTAKE`, `PLAN_GEN`（AI 正在理解需求或生成行程）
     - `browsing` → `RESEARCH`（正在收集目的地信息）
     - `verifying` → `GATE_EVAL`, `VERIFY`（正在评估可行性或验证行程）
     - `repairing` → `REPAIR`（正在优化行程方案）
   - 状态文案可以根据 `OrchestrationStep` 显示更详细的描述

4. **澄清问题交互优化** ✅ **已更新：采用结构化输入**
   - **结构化问题**：支持多种问题类型（text/single_choice/multi_choice/date/number）
   - **问题卡片化展示**：每个问题独立卡片
   - **多种输入方式**：
     - `text` → `Textarea` 或 `Input`
     - `single_choice` → `RadioGroup` 或 `Select`
     - `multi_choice` → `Checkbox` 组
     - `date` → `DatePicker` 或 `Input type="date"`
     - `number` → `Input type="number"`
   - **数据验证**：支持必填验证（required）和格式验证（validation 规则）
   - **向后兼容**：如果后端返回 `clarificationMessage`，解析为文本类型问题

#### **2.3.2 Gate 评估结果展示** ✅ **已更新：行程生成后展示**

**设计思路**：

1. **展示时机**
   - Gate 评估在后台执行（`GATE_EVAL` 阶段）
   - 在行程生成完成后，在预览页面展示结果
   - 用户可以通过决策日志查看 Gate 评估过程（`explain.decision_log`）

2. **风险矩阵可视化**
   - 使用卡片布局
   - HARD 风险：红色边框 + 警告图标
   - SOFT 风险：黄色边框 + 信息图标
   - OK：绿色边框 + 确认图标

3. **Gate 结论展示**
   - 大标题显示结论（ALLOW/ADJUST_REQUIRED/BLOCK）
   - 简要说明（1-2句话）
   - 必须调整项列表（如果有）
   - 用户操作：
     - `ALLOW` → 直接接受行程
     - `ADJUST_REQUIRED` → 显示调整建议，用户确认后接受
     - `BLOCK` → 显示阻止原因，建议替代方案或返回重新规划

4. **三人格视角**
   - Abu（安全）：显示安全相关风险
   - Dr.Dre（节奏）：显示体力/节奏相关风险
   - Neptune（修复）：显示空间/路线相关风险

#### **2.3.3 行程方案预览**

**设计思路**：

1. **概览视图（Overview）**
   - 10天行程表（表格/时间轴）
   - 关键指标：总预算、日均预算、总距离、主要活动
   - 快速操作：接受/调整/保存草稿

2. **详细视图（Detail）**
   - 按天展开（可折叠）
   - 每天包含：时间、地点、活动、交通、住宿、预算、证据
   - 风险提示（如果有）

3. **决策日志视图（Decision Log）**
   - 可展开/折叠
   - 结构化展示（JSON Tree View）
   - 关键决策高亮

#### **2.3.4 预算修复交互** ✅ **已更新：Phase 1 采用自动修复**

**设计思路**：

1. **修复方案展示**（Phase 1：自动修复）
   - 系统自动修复预算超支
   - 展示修复说明（"系统已自动调整预算，节省 ¥X"）
   - 修复前后对比可在决策日志中查看

2. **未来增强**（Phase 2：用户控制）
   - 对比视图（修复前 vs 修复后）
   - 调整项列表（带说明和节省金额）
   - 用户可选择性应用修复（全部应用/部分应用/手动调整）
   - 实时预算计算和预览

---

### 2.4 系统流程设计思路

#### **2.4.1 Agent 调用流程**

```
前端（NewTripPage）
    ↓
用户输入自然语言文本
    ↓
构建 RouteAndRunRequest
    ├─ request_id: 生成唯一ID
    ├─ user_id: 当前用户ID
    ├─ trip_id: null（新建行程）
    ├─ message: 用户输入的自然语言文本
    ├─ conversation_context: 空（首次创建）
    └─ options: { max_steps: 50 }
    ↓
调用 agentApi.routeAndRun(request)
    ↓
后端处理（LangGraph Orchestrator）
    ├─ INTAKE 阶段：解析用户意图
    ├─ RESEARCH 阶段：收集目的地信息
    ├─ GATE_EVAL 阶段：Should-Exist Gate 评估
    ├─ PLAN_GEN 阶段：生成行程方案
    ├─ VERIFY 阶段：验证可执行性
    ├─ REPAIR 阶段：修复问题（如果需要）
    └─ NARRATE 阶段：生成用户友好输出
    ↓
返回 RouteAndRunResponse
    ├─ result.status: OK/NEED_MORE_INFO/NEED_CONFIRMATION/FAILED
    ├─ result.answer_text: 用户友好的回答文本
    ├─ result.payload: 包含行程数据/澄清问题/审批信息
    ├─ explain.decision_log: 决策日志
    └─ route.route: SYSTEM1/SYSTEM2 路由类型
    ↓
前端处理响应
    ├─ OK → 显示行程方案预览
    ├─ NEED_MORE_INFO → 显示澄清问题
    ├─ NEED_CONFIRMATION → 显示审批对话框
    └─ FAILED → 显示错误信息
```

#### **2.4.2 澄清流程设计** ✅ **已更新：结构化输入**

**思路**：

1. **问题生成**
   - 由 Agent（PlannerAgent 或 LocalInsightAgent）生成
   - 通过 `RouteAndRunResponse.result.payload.clarificationQuestions` 返回（结构化数组）
   - 问题类型支持：`text` | `single_choice` | `multi_choice` | `date` | `number`
   - 向后兼容：如果后端返回 `clarificationMessage`（字符串），前端解析为文本类型问题

2. **问题展示**
   - 使用卡片布局（`ClarificationQuestionCard` 组件）
   - 每个问题独立卡片
   - 根据问题类型渲染不同的输入组件：
     - `text` → `Textarea` 或 `Input`
     - `single_choice` → `RadioGroup` 或 `Select`
     - `multi_choice` → `Checkbox` 组
     - `date` → `DatePicker` 或 `Input type="date"`
     - `number` → `Input type="number"`

3. **数据验证**
   - 必填问题验证（`required: true`）
   - 格式验证（`validation` 规则：min/max/pattern）
   - 提交前检查所有必填问题是否已回答

4. **回答提交**
   - 用户回答后，构建新的 `RouteAndRunRequest`
   - `conversation_context.recent_messages` 包含之前的对话历史
   - 回答格式：`ClarificationAnswer[]`（包含 `questionId` 和 `value`）
   - 继续调用 `routeAndRun`

5. **多轮澄清**
   - 支持多轮澄清（最多 5 轮，避免死循环）
   - 每轮澄清后更新 UI 状态
   - 超过 5 轮后，提示用户"信息不足，建议使用结构化表单创建行程"

#### **2.4.3 Gate 评估结果处理** ✅ **已更新：行程生成后展示**

**思路**：

1. **展示时机**
   - Gate 评估在后台执行（`GATE_EVAL` 阶段）
   - 在行程生成完成后，在预览页面展示结果
   - 用户可以通过决策日志查看 Gate 评估过程

2. **Gate 结论映射到用户操作**
   - `ALLOW` → 直接接受行程
   - `ADJUST_REQUIRED` → 显示调整建议，用户确认后接受
   - `BLOCK` → 显示阻止原因，建议替代方案或返回重新规划

3. **风险展示**
   - 使用风险矩阵组件（参考 `PersonaCard` 设计）
   - 三人格视角切换（Abu/Dr.Dre/Neptune）
   - 在行程预览页面展示

4. **用户决策**
   - 接受方案 → 创建行程
   - 查看详情 → 展开决策日志查看 Gate 评估过程
   - 拒绝调整/阻止 → 返回重新输入需求

#### **2.4.4 行程生成与预览**

**思路**：

1. **行程数据结构**
   - 使用 `TripDetail` 类型（参考 `src/types/trip.ts`）
   - 包含 `TripDay[]` 和 `ItineraryItem[]`

2. **预览展示**
   - 使用现有组件（如果可用）：`src/components/trips/`
   - 或创建新的预览组件：`TripPreviewCard`、`ItineraryOverview`

3. **用户操作**
   - 接受方案 → 调用 `tripsApi.create()` → 跳转到 `/dashboard/trips/${tripId}`
   - 调整方案 → 返回重新规划（可保留部分信息）
   - 保存草稿 → 保存为 `status: 'DRAFT'` 的行程

---

### 2.5 异常流程设计思路

#### **2.5.1 网络错误**

- 显示友好错误提示
- 支持重试
- 自动保存用户输入（LocalStorage）

#### **2.5.2 Agent 超时**

- 显示超时提示
- 提供"简化需求"选项
- 或提供"稍后继续"（保存为草稿）

#### **2.5.3 Gate 评估 BLOCK**

- 显示阻止原因（用户友好的说明）
- 提供替代方案建议
- 提供"强制继续"选项（标记为高风险，需要审批）

#### **2.5.4 预算严重超支**

- 显示预算对比
- 提供多个修复方案（激进/保守）
- 支持用户手动调整预算上限

---

### 2.6 与现有系统集成思路

#### **2.6.1 与 Plan Studio 集成**

- 创建完成后，自动跳转到 Plan Studio
- Plan Studio 可以继续编辑生成的行程
- 支持"重新规划"功能（调用 Agent 重新生成）

#### **2.6.2 与行程详情页集成**

- 创建完成后，跳转到行程详情页
- 详情页显示完整的决策日志（可展开）
- 支持"查看规划过程"功能

#### **2.6.3 与 Agent Chat 集成**

- 创建过程中，可以切换到 Agent Chat 继续对话
- Agent Chat 可以访问当前的规划上下文
- 支持"继续规划"功能

---

## 📝 三、已澄清问题 ✅

### 3.1 澄清问题交互方式 ✅ **已澄清**

**决策**：采用结构化输入方案（Phase 1）
- ✅ 支持多种问题类型：`text` | `single_choice` | `multi_choice` | `date` | `number`
- ✅ 使用现有表单组件（Select、RadioGroup、Checkbox、DatePicker 等）
- ✅ 向后兼容：支持 `clarificationMessage` 格式
- ✅ 数据验证：支持必填验证和格式验证

**参考**：见 `创建行程规划流程-关键问题澄清-2025-01-14.md` 第 1.1 节

### 3.2 Gate 评估结果展示时机 ✅ **已澄清**

**决策**：在行程生成后展示 Gate 评估结果
- ✅ Gate 评估在后台执行（`GATE_EVAL` 阶段）
- ✅ 在行程预览页面展示 Gate 结论、风险矩阵、调整建议
- ✅ 用户可以通过决策日志查看 Gate 评估过程

**参考**：见 `创建行程规划流程-关键问题澄清-2025-01-14.md` 第 1.2 节

### 3.3 预算修复的用户控制 ✅ **已澄清**

**决策**：Phase 1 采用自动修复，Phase 2 支持用户控制
- ✅ Phase 1（MVP）：自动修复预算，展示修复说明
- 📋 Phase 2（未来）：如果用户反馈需要手动控制，再设计交互流程

**参考**：见 `创建行程规划流程-关键问题澄清-2025-01-14.md` 第 1.3 节

### 3.4 UI 状态名称 ✅ **已澄清**

**决策**：使用现有系统的 UI 状态名称
- ✅ 状态映射关系已定义
- ✅ 使用现有的 UI 状态：`thinking` | `browsing` | `verifying` | `repairing` 等

**参考**：见 `创建行程规划流程-关键问题澄清-2025-01-14.md` 第 1.4 节

### 3.5 行程数据类型 ✅ **已澄清**

**决策**：使用 `TripDetail` 类型
- ✅ `TripDetail` 类型存在（定义在 `src/types/trip.ts`）
- ✅ Agent API 返回的数据需要转换为 `TripDetail` 格式

**参考**：见 `创建行程规划流程-关键问题澄清-2025-01-14.md` 第 1.5 节

---

## 📋 四、待确认问题（其他）

1. **行程预览的详细程度**
   - 预览阶段显示多少信息？
   - 是否需要支持"展开详细行程"？

2. **错误处理策略**
   - Agent 调用失败时，是否需要降级到结构化表单？
   - 是否需要支持"离线模式"（使用缓存数据）？

---

## 🎯 四、下一步行动

1. **详细设计文档**
   - 编写完整的 PRD 文档
   - 包含页面设计、交互流程、数据结构、API 接口

2. **原型设计**
   - 与视觉设计师协作，设计关键页面原型
   - 包含状态展示、交互反馈、错误处理

3. **技术方案设计**
   - 与后端工程师协作，确认 Agent API 调用方式
   - 与前端工程师协作，确认组件实现方案

4. **测试方案设计**
   - 设计用户测试场景
   - 设计异常场景测试用例

---

## 📝 五、更新记录

**2025-01-14 更新**：
- ✅ 更新澄清问题的交互方式（采用结构化输入）
- ✅ 更新 Gate 评估结果展示时机（行程生成后展示）
- ✅ 更新预算修复方式（Phase 1 自动修复）
- ✅ 更新 UI 状态名称（使用现有系统状态）
- ✅ 确认行程数据类型（使用 `TripDetail` 类型）

**参考文档**：
- `创建行程规划流程-关键问题澄清-2025-01-14.md`（详细澄清结果）
- `多角色-审查-创建行程规划流程设计思路-2025-01-14.md`（审查报告）

---

**文档状态**：✅ 思路文档已更新（反映澄清结果）  
**下一步**：编写详细 PRD 文档（包含结构化澄清问题的设计）
