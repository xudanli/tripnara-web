# 创建行程规划流程 - 关键问题澄清

**产品经理：Danny**  
**日期：2025-01-14**  
**基于审查报告**：`多角色-审查-创建行程规划流程设计思路-2025-01-14.md`

---

## 📋 一、问题澄清汇总

### 1.1 澄清问题的格式和交互方式 ⭐ **优先级：高**

#### **问题描述**
审查报告指出：文档描述的是结构化问题（支持多种输入方式），但现有 API 返回的是简单字符串（`clarificationMessage: string`）。

#### **现状分析**
- ✅ 现有 API：`RouteAndRunResponse.result.payload.clarificationMessage`（单个字符串，Markdown 格式）
- ✅ 现有实现：`/trips/from-natural-language` 接口返回 `clarificationQuestions: string[]`（字符串数组）
- ✅ 现有实现：Agent Chat 和 Global Command Bar 使用 `clarificationMessage` 显示澄清消息

#### **产品决策**

**决策：采用结构化输入方案（Phase 1）**

**更新说明**：根据产品需求，将结构化输入作为 Phase 1 的需求，而非未来增强。

**Phase 1（MVP，立即实施）**：
- ✅ 新增 `clarificationQuestions: ClarificationQuestion[]` 字段（结构化数组）
- ✅ 前端支持多种输入方式（文本/单选/多选/日期/数字等）
- ✅ 支持多轮澄清（通过 `conversation_context.recent_messages` 传递历史）
- ✅ 向后兼容：如果后端返回 `clarificationMessage`，前端解析为文本类型问题

**理由**：
1. **用户体验优先**：结构化输入提供更好的交互体验，减少用户输入错误
2. **数据质量**：结构化输入确保数据格式正确，便于后续处理
3. **一致性**：与现有表单组件保持一致（Select、DatePicker 等）
4. **可扩展性**：为未来的智能表单生成奠定基础

**数据结构设计（Phase 1）**：

```typescript
/**
 * 澄清问题类型
 */
export type ClarificationQuestionType = 
  | 'text'           // 文本输入
  | 'single_choice'  // 单选
  | 'multi_choice'   // 多选
  | 'date'           // 日期选择
  | 'number';        // 数字输入

/**
 * 澄清问题数据结构
 */
export interface ClarificationQuestion {
  id: string;                    // 问题 ID
  question: string;              // 问题文本
  type: ClarificationQuestionType; // 问题类型
  options?: string[];            // 选项列表（用于 single_choice 和 multi_choice）
  required: boolean;             // 是否必填
  placeholder?: string;          // 占位符（用于 text 和 number）
  hint?: string;                 // 提示文本
  default?: string | string[];   // 默认值
  validation?: {                 // 验证规则（可选）
    min?: number;                // 最小值（用于 number 和 date）
    max?: number;                // 最大值（用于 number 和 date）
    pattern?: string;            // 正则表达式（用于 text）
  };
}

/**
 * 澄清问题回答
 */
export interface ClarificationAnswer {
  questionId: string;            // 问题 ID
  value: string | string[] | number | null; // 回答值
}
```

**API 接口更新（需要后端支持）**：

```typescript
// RouteAndRunResponse.result.payload 需要支持：
export interface RouteAndRunResponsePayload {
  // ... 现有字段
  clarificationMessage?: string;              // 向后兼容：简单字符串（Markdown 格式）
  clarificationQuestions?: ClarificationQuestion[]; // 新增：结构化问题数组
  // ... 其他字段
}
```

**前端实现建议**：

1. **组件设计**：
   - `ClarificationQuestionCard`：单个问题卡片组件
   - 根据 `type` 渲染不同的输入组件：
     - `text` → `Textarea` 或 `Input`
     - `single_choice` → `RadioGroup` 或 `Select`
     - `multi_choice` → `Checkbox` 组
     - `date` → `DatePicker` 或 `Input type="date"`
     - `number` → `Input type="number"`

2. **向后兼容**：
   - 如果后端返回 `clarificationMessage`，前端将其解析为文本类型问题
   - 如果后端返回 `clarificationQuestions`，使用结构化展示

3. **参考现有组件**：
   - `src/components/ui/select.tsx`：Select 组件
   - `src/components/ui/radio-group.tsx`：RadioGroup 组件
   - `src/pages/trips/new.tsx`：现有的澄清问题实现（可参考）

#### **验收标准**
- ✅ 支持结构化问题（text/single_choice/multi_choice/date/number）
- ✅ 前端根据问题类型渲染对应的输入组件
- ✅ 支持多轮澄清（最多 5 轮，避免死循环）
- ✅ 向后兼容：支持 `clarificationMessage` 格式
- ✅ 必填问题验证（required）
- ✅ 数据格式验证（validation 规则）

---

### 1.2 Gate 评估结果展示时机 ⭐ **优先级：高**

#### **问题描述**
文档中未明确 Gate 评估结果是在行程生成前还是生成后展示。

#### **现状分析**
- ✅ 现有实现：Gate 评估在 `GATE_EVAL` 阶段执行（在 `PLAN_GEN` 之前）
- ✅ Gate 结果在 `RouteAndRunResponse.result.payload.orchestrationResult.gate_result` 中返回
- ⚠️ 现有系统：Gate 评估是后台执行的，前端通常看到的是最终结果

#### **产品决策**

**决策：在行程生成后展示 Gate 评估结果（符合"决策优先"原则的折中方案）**

**理由**：
1. **用户体验优先**：用户希望看到完整的行程方案，而不是中途打断
2. **符合现有系统模式**：Agent Chat 和现有流程都是展示最终结果
3. **决策日志透明**：用户可以通过决策日志查看 Gate 评估过程（`explain.decision_log`）
4. **风险提示展示**：在行程预览中展示风险提示和调整建议

**实现方案**：
1. **Gate 评估在后台执行**（`GATE_EVAL` 阶段）
2. **行程生成完成后**，在预览页面展示：
   - **Gate 结论**（ALLOW/ADJUST_REQUIRED/BLOCK）
   - **风险矩阵**（HARD/SOFT/OK 风险）
   - **调整建议**（如果有）
   - **决策日志**（可展开查看详细过程）
3. **用户操作**：
   - `ALLOW` → 直接接受行程
   - `ADJUST_REQUIRED` → 显示调整建议，用户确认后接受
   - `BLOCK` → 显示阻止原因，建议替代方案或返回重新规划

#### **验收标准**
- ✅ Gate 评估结果在行程预览页面展示
- ✅ 风险矩阵可视化（卡片布局，HARD/SOFT/OK 分类）
- ✅ 用户可以看到 Gate 评估的决策日志（可展开）

---

### 1.3 预算修复的用户控制 🟡 **优先级：中**

#### **问题描述**
文档描述支持用户手动控制修复方案，但现有系统是自动修复。

#### **现状分析**
- ✅ 现有实现：`REPAIR` 阶段自动修复预算超支
- ⚠️ 现有系统：修复是自动的，不支持用户手动控制

#### **产品决策**

**决策：Phase 1 采用自动修复，Phase 2 支持用户控制**

**Phase 1（MVP，立即实施）**：
- ✅ 自动修复预算超支（与现有系统一致）
- ✅ 在行程预览中展示修复说明（"系统已自动调整预算，节省 ¥X"）
- ✅ 用户可以看到修复前后的对比（在决策日志中）

**Phase 2（未来增强）**：
- 📋 如果用户反馈需要手动控制，再设计交互流程
- 📋 支持"全部应用 / 部分应用 / 手动调整"修复方案
- 📋 实时预算计算和预览

**理由**：
1. 自动修复符合用户期望（减少决策负担）
2. 先验证用户需求，再决定是否需要手动控制
3. 降低实现复杂度，快速上线

#### **验收标准**
- ✅ 系统自动修复预算超支
- ✅ 修复说明清晰展示（节省金额、调整项）
- ✅ 修复前后对比可查看（在决策日志中）

---

### 1.4 UI 状态名称对齐 🟡 **优先级：中**

#### **问题描述**
文档中的 UI 状态名称与现有系统不完全一致。

#### **现状分析**
- ✅ 现有系统 UI 状态：`thinking` | `browsing` | `verifying` | `repairing` | `awaiting_consent` | `awaiting_confirmation` | `awaiting_user_input` | `done` | `failed`
- ⚠️ 文档中使用的状态名称：`thinking` | `researching` | `gate_evaluating` | `planning` | `verifying` | `repairing`

#### **产品决策**

**决策：使用现有系统的 UI 状态名称，建立映射关系**

**状态映射关系**：
| 文档描述 | 现有系统 UI 状态 | OrchestrationStep | 说明 |
|---------|-----------------|-------------------|------|
| `thinking` | `thinking` | `INTAKE`, `PLAN_GEN` | AI 正在理解需求或生成行程 |
| `researching` | `browsing` | `RESEARCH` | 正在收集目的地信息 |
| `gate_evaluating` | `verifying` | `GATE_EVAL` | 正在评估可行性 |
| `planning` | `thinking` | `PLAN_GEN` | 正在生成行程方案 |
| `verifying` | `verifying` | `VERIFY` | 正在验证行程可执行性 |
| `repairing` | `repairing` | `REPAIR` | 正在优化行程方案 |

**实现方案**：
- ✅ 前端使用现有系统的 UI 状态名称
- ✅ 通过 `OrchestrationStep` 映射到 UI 状态
- ✅ 状态文案可以根据 `OrchestrationStep` 显示更详细的描述

#### **验收标准**
- ✅ UI 状态名称与现有系统保持一致
- ✅ 状态文案清晰易懂（根据 `OrchestrationStep` 显示详细描述）

---

### 1.5 行程数据类型 🟢 **优先级：低**

#### **问题描述**
文档提到 `TripDetail` 类型，但需要确认是否存在。

#### **现状分析**
- ✅ 现有类型：`TripDetail` 存在（定义在 `src/types/trip.ts`）
- ✅ 现有类型：`Itinerary`, `ItineraryDay`, `ItineraryItem`（在 Agent API 中使用）

#### **产品决策**

**决策：使用 `TripDetail` 类型（前端标准类型）**

**理由**：
1. `TripDetail` 是前端标准类型，包含完整的行程数据
2. Agent API 返回的行程数据需要转换为 `TripDetail` 格式
3. 与现有页面（行程详情页）保持一致

**数据转换**：
- Agent API 返回：`RouteAndRunResponse.result.payload.orchestrationResult.itinerary`
- 前端转换：`itinerary` → `TripDetail`（通过数据适配器）

#### **验收标准**
- ✅ 使用 `TripDetail` 类型存储行程数据
- ✅ 数据转换逻辑正确（`itinerary` → `TripDetail`）

---

## 📝 二、补充澄清

### 2.1 Gate 结果数据结构

#### **问题**
审查报告指出需要确认 `GateResult` 结构是否完整。

#### **现状分析**
- ✅ 现有 API：`RouteAndRunResponse.result.payload.orchestrationResult.gate_result`（类型为 `any`）
- ⚠️ 需要确认：后端返回的 `gate_result` 结构

#### **产品决策**

**决策：使用现有的 `gate_result` 结构（类型为 `any`，通过决策日志查看详情）**

**理由**：
1. Gate 评估结果主要在决策日志中展示
2. 前端主要通过 `explain.decision_log` 展示 Gate 评估过程
3. 如果需要结构化展示，再定义具体类型

**前端展示方式**：
- Gate 结论：从 `decision_log` 中提取 `GATE_EVAL` 步骤的 `outputs_summary`
- 风险矩阵：从 `decision_log` 中提取相关信息
- 调整建议：从 `decision_log` 中提取 `REPAIR` 步骤的信息

#### **验收标准**
- ✅ Gate 评估结果可以从决策日志中提取
- ✅ 风险矩阵可视化展示

---

### 2.2 澄清问题的多轮限制

#### **问题**
审查报告指出需要确认多轮澄清的轮数限制。

#### **产品决策**

**决策：最多 5 轮澄清，避免死循环**

**实现方案**：
- ✅ 前端记录澄清轮数（`clarificationRound`）
- ✅ 超过 5 轮后，提示用户"信息不足，建议使用结构化表单创建行程"
- ✅ 提供"切换到表单模式"选项

#### **验收标准**
- ✅ 最多支持 5 轮澄清
- ✅ 超过 5 轮后，提示用户切换到表单模式

---

## ✅ 三、更新后的设计原则

### 3.1 与现有系统对齐

1. **API 调用**：使用现有的 `POST /agent/route_and_run` 接口
2. **数据格式**：扩展 `RouteAndRunResponse` 结构（新增 `clarificationQuestions` 字段）
3. **UI 状态**：使用现有的 UI 状态名称
4. **数据类型**：使用现有的 `TripDetail` 类型
5. **UI 组件**：使用现有的表单组件（Select、RadioGroup、Checkbox、DatePicker 等）

### 3.2 渐进式实施

1. **Phase 1（MVP）**：
   - ✅ **结构化澄清问题**（text/single_choice/multi_choice/date/number）
   - ✅ 自动修复预算
   - ✅ 行程生成后展示 Gate 评估结果

2. **Phase 2（未来增强）**：
   - 用户控制预算修复（如果需要）
   - 更丰富的 Gate 评估结果展示
   - 智能表单生成（根据上下文自动生成问题类型和选项）

### 3.3 用户体验优先

1. **决策优先原则的折中**：Gate 评估在后台执行，结果在行程预览中展示
2. **减少用户负担**：自动修复预算，减少用户决策
3. **透明可追溯**：通过决策日志展示所有决策过程

---

## 📋 四、下一步行动

### 4.1 产品经理

1. ✅ **已完成**：澄清关键问题
2. ✅ **已更新**：澄清问题的交互方式（采用结构化输入）
3. 📋 **待完成**：更新设计思路文档，反映澄清结果
4. 📋 **待完成**：编写详细 PRD 文档（包含结构化澄清问题的设计）

### 4.2 前端工程师

1. 🔴 **待完成（重要）**：实现结构化澄清问题的前端组件
   - 创建 `ClarificationQuestionCard` 组件
   - 根据问题类型渲染不同的输入组件（Textarea/Select/RadioGroup/Checkbox/DatePicker/Input）
   - 实现数据验证（required、validation 规则）
   - 向后兼容：支持 `clarificationMessage` 格式（解析为文本类型问题）
2. 📋 **待完成**：确认现有组件是否可用（`PersonaCard`、行程预览组件等）
3. 📋 **待完成**：设计行程预览页面（Gate 评估结果展示）

### 4.3 后端工程师

1. 🔴 **待完成（重要）**：设计并实现结构化澄清问题的数据结构
   - 新增 `ClarificationQuestion` 接口（参考澄清文档）
   - 更新 `RouteAndRunResponseDto` 接口，支持 `clarificationQuestions` 字段
   - Agent 生成结构化澄清问题（而非简单字符串）
2. 📋 **待确认**：确认 `gate_result` 的具体结构（如果需要结构化展示）
3. 📋 **待确认**：确认多轮澄清的轮数限制（建议 5 轮）

### 4.4 智能体工程师

1. 🔴 **待完成（重要）**：实现结构化澄清问题的生成逻辑
   - Agent 生成结构化问题（`ClarificationQuestion[]`）
   - 支持不同类型的问题（text/single_choice/multi_choice/date/number）
   - 根据用户输入和上下文生成合适的选项（options）
2. 📋 **待确认**：确认预算修复的自动执行逻辑

---

## 📝 五、文档更新建议

### 5.1 需要更新的文档

1. **设计思路文档**（`.claude/改动资料/创建行程规划流程设计思路.md`）
   - 更新澄清问题的交互方式（使用现有格式）
   - 更新 Gate 评估结果展示时机（行程生成后展示）
   - 更新预算修复方式（自动修复）
   - 更新 UI 状态名称（使用现有系统状态）

2. **审查报告**（`.claude/改动资料/多角色-审查-创建行程规划流程设计思路-2025-01-14.md`）
   - 标记问题已澄清
   - 更新建议的下一步行动

---

**文档状态**：✅ 问题已澄清  
**下一步**：更新设计思路文档，然后编写详细 PRD 文档
