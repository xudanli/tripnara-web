# 创建行程规划流程 PRD 文档

**产品经理：Danny**  
**日期：2025-01-14**  
**版本：1.0**

---

## 0.1 项目背景与问题定义（Why Now）

### 0.1.1 背景

TripNARA 是一个**决策型旅行应用**（Decision-first Travel），遵循 **TripNARA 产品哲学**：**决策优先、可执行优先、安全与可达性门控优先、解释与责任优先**。

当前系统已具备完整的行程管理能力，包括：
- 行程列表与详情（`src/pages/trips/`）
- 规划工作台（Plan Studio，`src/pages/plan-studio/`）
- 智能体协作系统（Agent Chat，`src/components/agent/AgentChat.tsx`）
- 多智能体决策流程（`POST /agent/route_and_run`，参考 `src/api/agent.ts`）

**但是**，用户在创建新行程时仍需要：
1. **填写复杂的结构化表单**（目的地、日期、预算、旅行者信息等）
2. **手动选择多个配置项**（节奏偏好、兴趣标签、约束条件等）
3. **在 Plan Studio 中逐步添加地点和安排行程**

这个过程对用户来说**认知负担重、操作步骤多、时间成本高**，不符合"决策优先、可执行优先"的产品哲学。

### 0.1.2 问题定义

#### **核心问题**

用户希望**用自然语言描述需求，系统自动生成可执行的行程方案**，而不是手动填写表单和逐步配置。

**用户典型场景**：
- 用户说："帮我规划26年春节去冰岛的10天行程，预算100000元"
- 系统应该：
  1. 理解用户意图（目的地、日期、天数、预算）
  2. 如有必要，通过结构化问题澄清细节（同行人数、兴趣、舒适度偏好等）
  3. 执行 Should-Exist Gate 评估（安全性、可达性、预算合理性等）
  4. 生成可执行的行程方案（包含具体地点、时间、交通、住宿、证据）
  5. 展示 Gate 评估结果和决策日志

#### **痛点分析**

1. **认知负担高**
   - 用户需要理解所有表单字段的含义
   - 需要提前思考所有配置项（节奏、兴趣、约束等）
   - 不知道哪些字段是必填的，哪些是可选的

2. **操作步骤多**
   - 创建行程 → 填写表单 → 进入 Plan Studio → 添加地点 → 安排行程
   - 每个步骤都需要用户主动操作
   - 无法一次性完成行程创建

3. **缺乏智能决策支持**
   - 用户不知道自己的需求是否可行（安全性、可达性等）
   - 无法看到系统的决策过程（为什么选择这个地点、为什么调整这个时间）
   - 缺乏风险提示和替代方案

4. **不符合产品哲学**
   - 当前流程是"执行优先"（用户先执行操作，系统后验证）
   - 不符合"决策优先"（系统先评估可行性，再生成方案）
   - 不符合"可执行优先"（生成的行程应该有明确的证据支撑）

### 0.1.3 Why Now

#### **技术成熟度**

1. **多智能体系统已就绪**
   - `POST /agent/route_and_run` 接口已实现（参考 `src/api/agent.ts`）
   - LangGraph Orchestrator 已支持完整的状态机流程（INTAKE → RESEARCH → GATE_EVAL → PLAN_GEN → VERIFY → REPAIR → NARRATE）
   - 决策日志系统已实现（`DecisionLogEntry`，参考 `src/api/agent.ts`）

2. **Should-Exist Gate 已实现**
   - GatekeeperAgent（Abu）已实现 Gate 评估逻辑
   - 支持 HARD/SOFT 风险识别
   - 支持三人格评审流程（Abu/Dr.Dre/Neptune）

3. **结构化澄清问题已设计**
   - 数据结构已定义（`ClarificationQuestion`，参考澄清文档）
   - 前端组件基础已具备（Select、RadioGroup、Checkbox、DatePicker 等）

#### **用户需求**

1. **用户期望提升**
   - 用户已经习惯了 ChatGPT、Claude 等 AI 助手
   - 期望能够用自然语言与系统交互
   - 期望系统能够理解上下文，主动澄清需求

2. **市场竞争**
   - 竞品（如 Google Trips、TripAdvisor）已提供基础的 AI 规划功能
   - 我们需要提供**差异化优势**：决策优先、可执行优先、可解释

#### **业务价值**

1. **降低用户流失**
   - 减少用户创建行程的放弃率
   - 提高用户完成行程创建的比例

2. **提升用户满意度**
   - 减少用户操作步骤
   - 提供更智能的决策支持
   - 增强用户对系统的信任（通过决策日志）

3. **产品差异化**
   - 体现 TripNARA 的"决策优先"产品哲学
   - 展示系统的智能决策能力
   - 建立用户对系统的信任

### 0.1.4 目标用户

#### **主要用户群体**

1. **新手用户**（首次使用 TripNARA）
   - 痛点：不知道如何开始，不知道填写哪些信息
   - 需求：用自然语言描述需求，系统自动生成方案
   - 频次：低频（首次创建行程）

2. **熟练用户**（多次使用 TripNARA）
   - 痛点：重复填写表单，操作步骤多
   - 需求：快速创建行程，减少操作步骤
   - 频次：中频（每月 1-2 次）

3. **专业用户**（旅行规划师、重度用户）
   - 痛点：需要快速生成多个方案，需要看到决策过程
   - 需求：批量创建、决策日志、替代方案
   - 频次：高频（每周多次）

#### **用户场景**

1. **场景 1：首次规划旅行**
   - 用户：新手用户
   - 场景：计划春节去冰岛，不知道如何开始
   - 期望：用自然语言描述需求，系统自动生成可执行的行程方案

2. **场景 2：快速创建行程**
   - 用户：熟练用户
   - 场景：临时决定周末去周边城市，需要快速创建行程
   - 期望：快速输入需求，系统自动生成方案

3. **场景 3：复杂行程规划**
   - 用户：专业用户
   - 场景：规划多国行程，需要系统评估可行性和风险
   - 期望：看到 Gate 评估结果、决策日志、替代方案

### 0.1.5 成功标准

#### **北极星指标**

**行程创建完成率**：从创建意图到行程创建成功的转化率
- 基线：当前结构化表单创建完成率（待统计）
- 目标：提升 30%（相对基线）

#### **过程指标**

1. **用户采用率**
   - 自然语言创建 vs 结构化表单创建的比例
   - 目标：自然语言创建占比 > 60%

2. **澄清问题回答率**
   - 用户回答澄清问题的比例
   - 目标：> 80%

3. **行程接受率**
   - 用户接受系统生成的行程方案的比例
   - 目标：> 70%

#### **质量指标**

1. **行程可执行性**
   - 生成的行程中，可执行项（有证据支撑）的比例
   - 目标：> 90%

2. **Gate 评估准确率**
   - Gate 评估结果（ALLOW/ADJUST_REQUIRED/BLOCK）的准确性
   - 目标：用户反馈准确率 > 85%

3. **用户满意度**
   - 用户对生成行程的满意度评分
   - 目标：> 4.0/5.0

---

**验收标准**：
- ✅ 文档清晰描述了项目背景、问题定义、Why Now
- ✅ 明确了目标用户和用户场景
- ✅ 定义了成功标准（北极星指标、过程指标、质量指标）

---
## 0.2 目标与成功指标（North Star & Metrics）

### 0.2.1 产品目标

#### **核心目标**

**让用户能够用自然语言创建可执行的行程方案，降低创建行程的认知负担和操作步骤，同时体现 TripNARA "决策优先、可执行优先"的产品哲学。**

#### **具体目标**

1. **用户体验目标**
   - 减少用户创建行程的操作步骤（从 5+ 步减少到 2-3 步）
   - 降低用户认知负担（用自然语言替代结构化表单）
   - 提升用户对系统决策的信任（通过决策日志和 Gate 评估结果）

2. **功能目标**
   - 支持自然语言输入（理解用户意图）
   - 支持结构化澄清问题（多种问题类型）
   - 支持 Should-Exist Gate 评估（安全性、可达性、预算合理性）
   - 支持可执行行程生成（包含证据和验证）

3. **质量目标**
   - 生成的行程可执行性 > 90%（有证据支撑）
   - Gate 评估准确率 > 85%（用户反馈）
   - 用户满意度 > 4.0/5.0

### 0.2.2 北极星指标（North Star Metric）

#### **定义**

**行程创建完成率**：从用户进入创建行程页面到成功创建行程的转化率

**计算公式**：
```
行程创建完成率 = (成功创建的行程数) / (进入创建页面的用户数) × 100%
```

**成功创建的定义**：
- 用户接受了系统生成的行程方案
- 行程状态为 `PLANNING` 或 `CONFIRMED`（参考 `TripDetail.status`，`src/types/trip.ts`）
- 行程至少包含 1 个 `TripDay` 和 1 个 `ItineraryItem`

#### **基线数据**

- **当前基线**：结构化表单创建完成率（待统计）
- **目标**：提升 30%（相对基线）

#### **为什么选择这个指标**

1. **直接反映核心价值**：用户能否成功创建行程是最直接的业务指标
2. **综合反映用户体验**：包含了自然语言理解、澄清问题、Gate 评估、行程生成等所有环节
3. **可行动**：可以通过优化各个环节来提升转化率

### 0.2.3 过程指标（Process Metrics）

#### **1. 用户采用率**

**定义**：自然语言创建 vs 结构化表单创建的比例

**计算公式**：
```
自然语言创建占比 = (使用自然语言创建的用户数) / (总创建用户数) × 100%
```

**目标**：自然语言创建占比 > 60%

**测量方法**：
- 统计 `/dashboard/trips/new` 页面中，`nl` tab 和 `form` tab 的使用比例
- 埋点事件：`trip_creation_method_selected`（`method: 'nl' | 'form'`）

#### **2. 澄清问题回答率**

**定义**：用户回答澄清问题的比例

**计算公式**：
```
澄清问题回答率 = (回答澄清问题的用户数) / (需要澄清的用户数) × 100%
```

**目标**：> 80%

**测量方法**：
- 统计 `NEED_MORE_INFO` 状态下的用户行为
- 埋点事件：
  - `clarification_questions_shown`（`question_count: number`）
  - `clarification_answers_submitted`（`answered_count: number`, `total_count: number`）
  - `clarification_skipped`（`round: number`）

#### **3. 行程接受率**

**定义**：用户接受系统生成的行程方案的比例

**计算公式**：
```
行程接受率 = (接受行程的用户数) / (看到行程预览的用户数) × 100%
```

**目标**：> 70%

**测量方法**：
- 统计用户在行程预览页面的操作
- 埋点事件：
  - `trip_preview_shown`（`trip_id: string`, `gate_result: 'ALLOW' | 'ADJUST_REQUIRED' | 'BLOCK'`）
  - `trip_accepted`（`trip_id: string`）
  - `trip_rejected`（`trip_id: string`, `reason: string`）
  - `trip_saved_as_draft`（`trip_id: string`）

#### **4. 多轮澄清轮数**

**定义**：平均每用户需要的澄清轮数

**计算公式**：
```
平均澄清轮数 = (总澄清轮数) / (需要澄清的用户数)
```

**目标**：< 2 轮（平均）

**测量方法**：
- 统计 `NEED_MORE_INFO` 状态的次数
- 埋点事件：`clarification_round_completed`（`round: number`, `question_count: number`）

### 0.2.4 质量指标（Quality Metrics）

#### **1. 行程可执行性**

**定义**：生成的行程中，可执行项（有证据支撑）的比例

**计算公式**：
```
行程可执行性 = (有证据支撑的 ItineraryItem 数) / (总 ItineraryItem 数) × 100%
```

**目标**：> 90%

**测量方法**：
- 检查 `ItineraryItem` 是否有 `evidence_refs`（参考 `src/types/trip.ts`）
- 检查 `DecisionLogEntry` 中的证据引用（参考 `src/api/agent.ts`）

**数据来源**：
- `RouteAndRunResponse.explain.decision_log`（参考 `src/api/agent.ts`）
- `TripDetail.TripDay[].ItineraryItem[]`（参考 `src/types/trip.ts`）

#### **2. Gate 评估准确率**

**定义**：Gate 评估结果（ALLOW/ADJUST_REQUIRED/BLOCK）的准确性（用户反馈）

**计算公式**：
```
Gate 评估准确率 = (用户反馈"准确"的次数) / (总反馈次数) × 100%
```

**目标**：用户反馈准确率 > 85%

**测量方法**：
- 在行程预览页面添加 Gate 评估反馈功能（未来）
- 埋点事件：`gate_evaluation_feedback`（`gate_result: string`, `accurate: boolean`, `feedback: string`）

**当前阶段**：
- 先通过用户访谈和 A/B 测试验证 Gate 评估的准确性
- 收集用户对 Gate 评估结果的反馈

#### **3. 用户满意度**

**定义**：用户对生成行程的满意度评分

**计算公式**：
```
平均满意度 = (所有用户满意度评分之和) / (评分用户数)
```

**目标**：> 4.0/5.0

**测量方法**：
- 在行程预览页面添加满意度评分（1-5 星）
- 埋点事件：`trip_satisfaction_rated`（`trip_id: string`, `rating: number`, `comment?: string`）

**当前阶段**：
- 先通过用户访谈收集反馈
- 后续通过应用内评分功能收集数据

### 0.2.5 技术指标（Technical Metrics）

#### **1. API 响应时间**

**定义**：`POST /agent/route_and_run` 接口的平均响应时间

**目标**：
- P50（中位数）< 10 秒
- P95 < 30 秒
- P99 < 60 秒

**测量方法**：
- 监控 `RouteAndRunResponse.observability.latency_ms`（参考 `src/api/agent.ts`）
- 埋点事件：`agent_api_latency`（`latency_ms: number`, `route_type: RouteType`, `status: ResultStatus`）

#### **2. API 成功率**

**定义**：`POST /agent/route_and_run` 接口的成功率

**计算公式**：
```
API 成功率 = (返回 OK 状态的请求数) / (总请求数) × 100%
```

**目标**：> 95%（排除用户取消的情况）

**测量方法**：
- 监控 `RouteAndRunResponse.result.status`（参考 `src/api/agent.ts`）
- 埋点事件：`agent_api_status`（`status: ResultStatus`, `route_type: RouteType`）

#### **3. 错误率**

**定义**：API 返回 `FAILED` 或 `TIMEOUT` 状态的比例

**目标**：< 5%

**测量方法**：
- 监控 `RouteAndRunResponse.result.status`（参考 `src/api/agent.ts`）
- 埋点事件：`agent_api_error`（`status: 'FAILED' | 'TIMEOUT'`, `error_type: ErrorType`, `error_message: string`）

### 0.2.6 监控与追踪

#### **埋点事件清单**

**关键事件**（必须埋点）：
1. `trip_creation_method_selected` - 用户选择创建方式（自然语言 vs 表单）
2. `trip_creation_started` - 用户开始创建行程
3. `clarification_questions_shown` - 显示澄清问题
4. `clarification_answers_submitted` - 提交澄清答案
5. `trip_preview_shown` - 显示行程预览
6. `trip_accepted` - 接受行程
7. `trip_rejected` - 拒绝行程
8. `trip_saved_as_draft` - 保存为草稿
9. `agent_api_latency` - Agent API 响应时间
10. `agent_api_status` - Agent API 状态

**详细埋点定义**：见 0.15 章节

#### **数据看板**

**关键看板**：
1. **创建流程漏斗**：进入页面 → 选择方式 → 输入需求 → 回答澄清 → 查看预览 → 接受行程
2. **质量监控**：行程可执行性、Gate 评估准确率、用户满意度
3. **技术监控**：API 响应时间、成功率、错误率

**数据来源**：
- 前端埋点数据（用户行为）
- 后端日志（API 性能、错误）
- 数据库查询（行程数据、用户数据）

---

**验收标准**：
- ✅ 定义了明确的北极星指标（行程创建完成率）
- ✅ 定义了过程指标（用户采用率、澄清问题回答率、行程接受率）
- ✅ 定义了质量指标（行程可执行性、Gate 评估准确率、用户满意度）
- ✅ 定义了技术指标（API 响应时间、成功率、错误率）
- ✅ 明确了指标的计算方法、目标和测量方法
- ✅ 列出了关键埋点事件

---
## 0.3 用户与场景（Persona / JTBD / User Journey）

### 0.3.1 用户画像（Persona）

#### **Persona 1：新手用户（First-Time User）**

**基本信息**：
- **姓名**：小李（化名）
- **年龄**：28 岁
- **职业**：互联网产品经理
- **旅行经验**：偶尔旅行，主要依赖攻略和OTA平台

**痛点与需求**：
- **痛点**：
  - 不知道如何开始规划行程
  - 对目的地不熟悉，不知道有哪些景点值得去
  - 不知道如何安排行程顺序和时间
  - 担心规划不合理（时间、预算、安全性）
- **需求**：
  - 用简单的语言描述需求，系统自动生成方案
  - 希望系统提供决策依据（为什么这样安排）
  - 希望看到风险提示和安全建议

**使用场景**：
- 计划春节去冰岛 10 天，预算 10 万元
- 不知道如何安排行程，希望系统帮助规划
- 希望了解极光、冰川等活动的可行性和安全要求

**行为特征**：
- 倾向于使用自然语言输入（符合日常习惯）
- 对澄清问题比较耐心，愿意回答
- 重视系统的解释和决策依据
- 可能会多次调整需求

#### **Persona 2：熟练用户（Experienced User）**

**基本信息**：
- **姓名**：张总（化名）
- **年龄**：35 岁
- **职业**：企业高管
- **旅行经验**：经常旅行，有丰富的规划经验

**痛点与需求**：
- **痛点**：
  - 重复填写表单，操作步骤多
  - 时间成本高（每次都要从头开始）
  - 希望快速生成方案，然后微调
- **需求**：
  - 快速创建行程（减少操作步骤）
  - 系统生成方案后，可以快速调整
  - 希望系统记住偏好（未来）

**使用场景**：
- 临时决定周末去周边城市，需要快速创建行程
- 希望快速看到行程方案，然后根据实际情况调整
- 可能同时规划多个行程

**行为特征**：
- 倾向于使用自然语言输入（快速）
- 对澄清问题比较直接，希望问题少而精准
- 重视效率和速度
- 可能会跳过某些澄清问题（如果觉得不重要）

#### **Persona 3：专业用户（Power User）**

**基本信息**：
- **姓名**：王导（化名）
- **年龄**：40 岁
- **职业**：旅行规划师 / 重度旅行爱好者
- **旅行经验**：专业规划经验，熟悉多个目的地

**痛点与需求**：
- **痛点**：
  - 需要快速生成多个方案供客户选择
  - 需要看到系统的决策过程（向客户解释）
  - 需要评估方案的可行性和风险
- **需求**：
  - 批量创建、决策日志、替代方案
  - 希望系统提供详细的决策依据
  - 希望看到 Gate 评估结果和风险矩阵

**使用场景**：
- 为客户规划多国行程，需要系统评估可行性和风险
- 需要生成多个方案（不同预算、不同偏好）
- 需要向客户解释为什么这样安排

**行为特征**：
- 倾向于使用结构化输入（如果有模板）
- 对澄清问题很重视，希望问题详细
- 重视决策过程和可解释性
- 可能会查看决策日志和 Gate 评估结果

### 0.3.2 用户任务（Jobs to Be Done, JTBD）

#### **JTBD 1：快速创建行程**

**用户任务**：我想快速创建一个可执行的行程方案，不需要花太多时间填写表单。

**成功标准**：
- 用自然语言描述需求
- 系统自动生成可执行的行程方案
- 整个过程在 5 分钟内完成

**用户故事**：
- 作为新手用户，我希望用自然语言描述需求，这样我就不需要理解所有表单字段
- 作为熟练用户，我希望快速创建行程，这样我就能节省时间

#### **JTBD 2：获得智能决策支持**

**用户任务**：我想知道我的需求是否可行，系统能帮我评估风险和提供建议。

**成功标准**：
- 系统执行 Gate 评估，识别风险和约束
- 系统提供调整建议和替代方案
- 用户能看到决策过程和依据

**用户故事**：
- 作为新手用户，我希望系统评估我的需求是否可行，这样我就能提前了解风险
- 作为专业用户，我希望看到 Gate 评估结果和决策日志，这样我就能向客户解释

#### **JTBD 3：理解系统决策**

**用户任务**：我想知道系统为什么这样安排行程，为什么选择这些地点。

**成功标准**：
- 系统提供决策日志（可展开查看）
- 每个行程项都有证据支撑
- 用户能看到 Gate 评估过程和结果

**用户故事**：
- 作为新手用户，我希望看到系统为什么这样安排，这样我就能学习如何规划行程
- 作为专业用户，我希望看到详细的决策过程，这样我就能向客户解释

### 0.3.3 用户旅程（User Journey）

#### **完整用户旅程**

```
阶段 1：意图产生
├─ 触发点：用户想要规划一次旅行
├─ 用户行为：思考目的地、日期、预算
└─ 情绪：期待、不确定

阶段 2：进入创建页面
├─ 触发点：用户点击"创建行程"按钮
├─ 用户行为：
│   ├─ 进入 /dashboard/trips/new 页面
│   ├─ 看到两个选项：自然语言创建 vs 结构化表单
│   └─ 选择自然语言创建（nl tab）
└─ 情绪：好奇、犹豫（不知道选哪个）

阶段 3：输入需求
├─ 触发点：用户选择自然语言创建
├─ 用户行为：
│   ├─ 在文本框中输入需求（例如："帮我规划26年春节去冰岛的10天行程，预算100000元"）
│   ├─ 点击"开始规划"按钮
│   └─ 看到加载状态（thinking / browsing / verifying 等）
└─ 情绪：期待、紧张（不知道系统能否理解）

阶段 4：澄清问题（如果需要）
├─ 触发点：系统返回 NEED_MORE_INFO 状态
├─ 用户行为：
│   ├─ 看到结构化澄清问题（卡片形式）
│   ├─ 回答问题（文本/选择/日期等）
│   ├─ 点击"提交"按钮
│   └─ 可能多轮澄清（最多 5 轮）
└─ 情绪：耐心、稍微不耐烦（如果问题太多）

阶段 5：等待行程生成
├─ 触发点：用户提交澄清答案（或不需要澄清）
├─ 用户行为：
│   ├─ 看到加载状态（planning / verifying / repairing）
│   ├─ 等待系统生成行程（10-30 秒）
│   └─ 可能看到进度提示
└─ 情绪：期待、焦虑（等待时间）

阶段 6：查看行程预览
├─ 触发点：系统返回行程方案
├─ 用户行为：
│   ├─ 查看行程概览（10天行程表）
│   ├─ 查看 Gate 评估结果（风险矩阵、调整建议）
│   ├─ 查看详细行程（每天的具体安排）
│   ├─ 查看决策日志（可展开）
│   └─ 评估方案是否符合需求
└─ 情绪：惊喜、满意（如果方案好）或失望（如果方案不符合预期）

阶段 7：接受或调整
├─ 触发点：用户查看完行程预览
├─ 用户行为：
│   ├─ 接受方案 → 创建行程 → 跳转到行程详情页
│   ├─ 调整方案 → 返回重新规划（循环到阶段 3）
│   └─ 保存为草稿 → 后续继续编辑
└─ 情绪：满意、完成感（如果接受）或挫败（如果不符合预期）

阶段 8：后续使用（接受方案后）
├─ 触发点：用户接受了行程方案
├─ 用户行为：
│   ├─ 在行程详情页查看完整行程
│   ├─ 在 Plan Studio 中继续编辑（如果需要）
│   └─ 执行行程（实际旅行）
└─ 情绪：满足、期待（实际旅行）
```

#### **关键接触点（Touchpoints）**

1. **创建页面入口**（`/dashboard/trips/new`）
   - 用户选择创建方式（自然语言 vs 表单）
   - 关键决策点：用户是否选择自然语言创建

2. **自然语言输入框**
   - 用户输入需求
   - 关键决策点：用户是否输入足够的信息

3. **澄清问题界面**
   - 系统显示结构化问题
   - 关键决策点：用户是否回答所有必填问题

4. **行程预览页面**
   - 系统展示行程方案和 Gate 评估结果
   - 关键决策点：用户是否接受方案

5. **决策日志查看**
   - 用户查看系统决策过程
   - 关键决策点：用户是否信任系统决策

### 0.3.4 用户故事（User Stories）

#### **用户故事 1：新手用户首次规划旅行**

**作为** 一个首次使用 TripNARA 的新手用户  
**我希望** 用自然语言描述我的旅行需求  
**以便** 我不需要理解复杂的表单字段就能创建行程

**验收标准**：
- ✅ 用户可以用自然语言输入需求
- ✅ 系统能够理解用户意图（目的地、日期、预算等）
- ✅ 如果信息不足，系统会通过结构化问题澄清
- ✅ 系统生成的行程方案符合用户需求

**优先级**：P0（核心功能）

#### **用户故事 2：熟练用户快速创建行程**

**作为** 一个经常使用 TripNARA 的熟练用户  
**我希望** 快速创建行程，减少操作步骤  
**以便** 我能节省时间，快速看到行程方案

**验收标准**：
- ✅ 用户可以用自然语言快速输入需求
- ✅ 系统能够快速生成行程方案（< 30 秒）
- ✅ 如果不需要澄清，系统直接生成方案
- ✅ 用户可以在预览页面快速接受或调整

**优先级**：P0（核心功能）

#### **用户故事 3：专业用户查看决策过程**

**作为** 一个旅行规划师  
**我希望** 看到系统决策过程和 Gate 评估结果  
**以便** 我能够向客户解释为什么这样安排，并评估方案的可行性

**验收标准**：
- ✅ 用户可以在行程预览页面查看 Gate 评估结果
- ✅ 用户可以看到风险矩阵（HARD/SOFT/OK 风险）
- ✅ 用户可以通过决策日志查看详细的决策过程
- ✅ 用户可以看到每个行程项的证据支撑

**优先级**：P1（重要功能）

#### **用户故事 4：用户回答澄清问题**

**作为** 一个用户  
**我希望** 通过结构化问题回答系统的澄清需求  
**以便** 系统能够生成更符合我需求的行程方案

**验收标准**：
- ✅ 系统显示结构化的澄清问题（text/single_choice/multi_choice/date/number）
- ✅ 用户可以通过不同的输入方式回答问题
- ✅ 系统验证必填问题和数据格式
- ✅ 用户提交答案后，系统继续生成行程

**优先级**：P0（核心功能）

#### **用户故事 5：用户查看 Gate 评估结果**

**作为** 一个用户  
**我希望** 看到系统对行程可行性的评估结果  
**以便** 我能够了解风险和调整建议，决定是否接受方案

**验收标准**：
- ✅ 用户可以在行程预览页面查看 Gate 评估结果（ALLOW/ADJUST_REQUIRED/BLOCK）
- ✅ 用户可以看到风险矩阵（HARD/SOFT/OK 风险分类）
- ✅ 用户可以看到调整建议（如果有）
- ✅ 用户可以根据 Gate 结果决定是否接受方案

**优先级**：P1（重要功能）

#### **用户故事 6：用户接受或拒绝行程方案**

**作为** 一个用户  
**我希望** 在接受行程前查看完整的方案和评估结果  
**以便** 我能够做出明智的决策

**验收标准**：
- ✅ 用户可以在预览页面查看完整的行程方案
- ✅ 用户可以看到 Gate 评估结果和决策日志
- ✅ 用户可以选择接受、调整或保存为草稿
- ✅ 用户接受后，行程创建成功，跳转到行程详情页

**优先级**：P0（核心功能）

### 0.3.5 极端场景（Edge Cases）

#### **场景 1：用户输入信息不足**

**场景描述**：用户输入的需求信息非常少（例如："去日本"）

**系统行为**：
- 系统返回 `NEED_MORE_INFO` 状态
- 系统生成结构化澄清问题（日期、天数、预算、同行人数等）
- 用户回答后，系统继续生成行程

**用户情绪**：理解（系统需要更多信息）

#### **场景 2：Gate 评估 BLOCK**

**场景描述**：系统评估后，Gate 结果为 `BLOCK`（例如：安全风险过高）

**系统行为**：
- 系统在行程预览页面显示 `BLOCK` 结果
- 系统显示阻止原因和风险详情
- 系统提供替代方案建议
- 用户可以选择"强制继续"（需要审批）或返回重新规划

**用户情绪**：失望、但理解（系统保护用户安全）

#### **场景 3：多轮澄清（超过 5 轮）**

**场景描述**：用户已经回答了 5 轮澄清问题，但系统仍需要更多信息

**系统行为**：
- 系统提示用户"信息不足，建议使用结构化表单创建行程"
- 系统提供"切换到表单模式"选项
- 用户可以选择继续（如果愿意）或切换到表单

**用户情绪**：不耐烦、但可以选择其他方式

#### **场景 4：API 超时**

**场景描述**：系统生成行程时，API 调用超时（> 60 秒）

**系统行为**：
- 系统显示超时提示
- 系统提供"简化需求"选项（重新生成）
- 系统提供"稍后继续"选项（保存为草稿）
- 用户可以选择重试或稍后继续

**用户情绪**：失望、但可以选择重试

#### **场景 5：预算严重超支**

**场景描述**：系统生成的行程预算超出用户预算 50% 以上

**系统行为**：
- 系统自动修复预算（Phase 1）
- 系统显示修复说明（节省金额、调整项）
- 系统在决策日志中记录修复过程
- 用户可以在预览页面查看修复后的方案

**用户情绪**：理解（系统自动优化）

### 0.3.6 用户情绪地图（Emotional Journey）

```
期待 → 好奇 → 期待 → 耐心 → 期待 → 惊喜/失望 → 满意/挫败 → 满足

阶段 1  阶段 2  阶段 3  阶段 4  阶段 5   阶段 6        阶段 7      阶段 8
```

**情绪波动点**：
- **峰值**（阶段 6）：用户看到行程预览时，如果方案好 → 惊喜，如果方案不好 → 失望
- **低谷**（阶段 5）：用户等待行程生成时，可能会焦虑
- **恢复点**（阶段 7）：用户接受方案后，获得完成感

**设计目标**：
- 减少等待时间（阶段 5）的焦虑
- 提升方案质量（阶段 6）的惊喜
- 提供清晰的反馈（所有阶段）

---

**验收标准**：
- ✅ 定义了 3 个用户画像（新手、熟练、专业用户）
- ✅ 定义了用户任务（Jobs to Be Done）
- ✅ 定义了完整的用户旅程（8 个阶段）
- ✅ 定义了关键接触点
- ✅ 定义了至少 3 个用户故事
- ✅ 定义了极端场景和用户情绪地图

---
## 0.4 需求范围（In/Out）与约束（数据、合规、设备、地区）

### 0.4.1 功能范围（In Scope）

#### **核心功能（Phase 1 MVP）**

1. **自然语言输入**
   - ✅ 支持用户用自然语言描述行程需求
   - ✅ 系统理解用户意图（目的地、日期、天数、预算等）
   - ✅ 参考实现：`src/pages/trips/new.tsx`（`nl` tab）

2. **结构化澄清问题**
   - ✅ 支持多种问题类型（text/single_choice/multi_choice/date/number）
   - ✅ 支持多轮澄清（最多 5 轮）
   - ✅ 数据验证（必填验证、格式验证）
   - ✅ 参考数据结构：`ClarificationQuestion`（见澄清文档）

3. **Should-Exist Gate 评估**
   - ✅ 系统执行 Gate 评估（安全性、可达性、预算合理性等）
   - ✅ 支持 HARD/SOFT 风险识别
   - ✅ Gate 结论：ALLOW/ADJUST_REQUIRED/BLOCK
   - ✅ 参考实现：GatekeeperAgent（Abu），参考 `src/api/agent.ts`

4. **可执行行程生成**
   - ✅ 系统生成结构化行程方案（`TripDetail` 类型）
   - ✅ 包含 `TripDay[]` 和 `ItineraryItem[]`
   - ✅ 每个行程项包含证据支撑（evidence_refs）
   - ✅ 参考数据结构：`src/types/trip.ts`

5. **行程预览与展示**
   - ✅ 行程概览视图（10天行程表）
   - ✅ Gate 评估结果展示（风险矩阵、调整建议）
   - ✅ 详细行程视图（每天的具体安排）
   - ✅ 决策日志视图（可展开查看）

6. **预算自动修复**
   - ✅ 系统自动修复预算超支
   - ✅ 展示修复说明（节省金额、调整项）
   - ✅ 修复前后对比（在决策日志中）

7. **用户操作**
   - ✅ 接受方案 → 创建行程 → 跳转到行程详情页
   - ✅ 调整方案 → 返回重新规划
   - ✅ 保存为草稿 → 后续继续编辑

#### **集成功能**

1. **与现有系统集成**
   - ✅ 使用 `POST /agent/route_and_run` 接口（参考 `src/api/agent.ts`）
   - ✅ 使用现有的行程数据结构（`TripDetail`，参考 `src/types/trip.ts`）
   - ✅ 创建成功后跳转到行程详情页（`/dashboard/trips/${tripId}`）
   - ✅ 支持在 Plan Studio 中继续编辑生成的行程

2. **与 Agent Chat 集成**
   - ✅ 创建过程中可以切换到 Agent Chat 继续对话（未来）
   - ✅ Agent Chat 可以访问当前的规划上下文（未来）

### 0.4.2 功能边界（Out of Scope）

#### **Phase 1 不包含的功能**

1. **用户手动控制预算修复**
   - ❌ 不支持用户手动调整修复方案
   - ❌ 不支持"部分应用修复"
   - 📋 **未来**：Phase 2 支持用户手动控制

2. **批量创建行程**
   - ❌ 不支持同时创建多个行程
   - ❌ 不支持批量处理多个需求
   - 📋 **未来**：Phase 2 支持批量创建

3. **用户偏好记忆**
   - ❌ 不支持记住用户的偏好设置
   - ❌ 不支持基于历史行程推荐
   - 📋 **未来**：Phase 2 支持偏好记忆

4. **实时协作**
   - ❌ 不支持多人同时编辑行程
   - ❌ 不支持实时同步
   - 📋 **未来**：Phase 2 支持协作功能

5. **离线模式**
   - ❌ 不支持离线创建行程
   - ❌ 不支持离线查看行程预览
   - 📋 **未来**：Phase 2 支持离线模式

6. **语音输入**
   - ❌ 不支持语音输入需求
   - 📋 **未来**：Phase 2 支持语音输入

7. **图片输入**
   - ❌ 不支持上传图片作为输入（例如：上传攻略图片）
   - 📋 **未来**：Phase 2 支持图片输入

### 0.4.3 数据约束

#### **输入数据要求**

1. **自然语言输入**
   - **最小信息**：目的地（必需）
   - **推荐信息**：日期、天数、预算、同行人数、兴趣
   - **格式要求**：UTF-8 编码，最大长度 2000 字符
   - **语言支持**：中文、英文（Phase 1）

2. **澄清问题回答**
   - **数据类型**：string | string[] | number | null
   - **验证规则**：
     - 必填问题（`required: true`）必须回答
     - 格式验证（`validation` 规则）：min/max/pattern
   - **参考数据结构**：`ClarificationAnswer`（见澄清文档）

3. **用户身份**
   - **要求**：用户必须已登录（通过 `useAuth` Hook，参考 `src/hooks/useAuth.ts`）
   - **用户 ID**：从 `user.id` 获取（参考 `src/api/agent.ts`）

#### **输出数据要求**

1. **行程数据**
   - **数据类型**：`TripDetail`（参考 `src/types/trip.ts`）
   - **必需字段**：
     - `id`: string（行程 ID）
     - `destination`: string（目的地）
     - `startDate`: string（开始日期，ISO 8601 格式）
     - `endDate`: string（结束日期，ISO 8601 格式）
     - `totalBudget`: number（总预算）
     - `status`: TripStatus（行程状态，`PLANNING` 或 `CONFIRMED`）
     - `TripDay[]`: 至少包含 1 个 `TripDay`
     - `TripDay[].ItineraryItem[]`: 至少包含 1 个 `ItineraryItem`

2. **Gate 评估结果**
   - **数据类型**：`GateResult`（通过 `RouteAndRunResponse.result.payload.orchestrationResult.gate_result` 返回）
   - **必需信息**：
     - Gate 结论（ALLOW/ADJUST_REQUIRED/BLOCK）
     - 风险矩阵（HARD/SOFT/OK 风险分类）
     - 调整建议（如果有）

3. **决策日志**
   - **数据类型**：`DecisionLogEntry[]`（参考 `src/api/agent.ts`）
   - **必需信息**：
     - 每个步骤的决策记录
     - 证据引用（evidence_refs）
     - 时间戳和元数据

#### **数据验证规则**

1. **目的地验证**
   - 必须是有效的国家代码或城市名称
   - 参考：`src/api/countries.ts`、`src/api/cities.ts`

2. **日期验证**
   - 开始日期必须 <= 结束日期
   - 日期格式：ISO 8601（YYYY-MM-DD）
   - 日期范围：当前日期 + 1 天 至 当前日期 + 2 年

3. **预算验证**
   - 预算必须 > 0
   - 预算单位：CNY（人民币）
   - 预算范围：100 - 1,000,000 CNY

4. **行程天数验证**
   - 行程天数 = (结束日期 - 开始日期) + 1
   - 天数范围：1 - 365 天

### 0.4.4 合规与约束

#### **安全与合规**

1. **数据隐私**
   - ✅ 用户输入的行程需求数据仅用于生成行程方案
   - ✅ 不向第三方分享用户数据
   - ✅ 遵守 GDPR 和当地数据保护法规

2. **责任边界**
   - ✅ 系统生成的行程方案仅供参考，用户需要自行验证
   - ✅ 系统不承担因执行行程方案而产生的任何责任
   - ✅ 风险提示必须明确（Gate 评估结果、风险矩阵）

3. **安全提示**
   - ✅ 高风险活动（如冰川徒步、极光观测）必须有明确的危险提示
   - ✅ Gate 评估 BLOCK 时，必须说明阻止原因
   - ✅ 参考实现：ComplianceAgent（参考 `src/api/agent.ts`）

#### **技术约束**

1. **API 约束**
   - **接口**：`POST /agent/route_and_run`（参考 `src/api/agent.ts`）
   - **超时时间**：30 秒（参考 `src/api/agent.ts`）
   - **重试策略**：不支持自动重试（用户手动重试）
   - **并发限制**：每个用户同时只能有一个创建请求（前端控制）

2. **性能约束**
   - **响应时间目标**：P50 < 10 秒，P95 < 30 秒，P99 < 60 秒
   - **成功率目标**：> 95%
   - **错误率目标**：< 5%

3. **浏览器兼容性**
   - **支持浏览器**：Chrome 90+, Firefox 88+, Safari 14+, Edge 90+
   - **移动端支持**：iOS Safari 14+, Chrome Mobile 90+
   - **功能要求**：支持 ES2020、LocalStorage、Fetch API

#### **设备约束**

1. **设备类型**
   - ✅ 支持桌面端（Windows、macOS、Linux）
   - ✅ 支持移动端（iOS、Android）
   - ✅ 支持平板（iPad、Android 平板）

2. **屏幕尺寸**
   - **最小屏幕宽度**：320px（移动端）
   - **推荐屏幕宽度**：≥ 1024px（桌面端）
   - **响应式设计**：支持自适应布局

3. **网络要求**
   - **在线要求**：必须在线（不支持离线模式）
   - **网络速度**：建议 ≥ 1 Mbps
   - **数据消耗**：每次创建请求约 100-500 KB（取决于响应大小）

### 0.4.5 地区与语言约束

#### **地区支持（Phase 1）**

1. **目的地支持**
   - ✅ 支持所有国家/地区（通过 `src/api/countries.ts`）
   - ✅ 支持主要城市（通过 `src/api/cities.ts`）
   - ⚠️ **限制**：Gate 评估的准确性可能因目的地而异（数据完整性）

2. **用户地区**
   - ✅ 支持全球用户（无地区限制）
   - ⚠️ **限制**：界面语言可能影响用户体验（见语言支持）

#### **语言支持（Phase 1）**

1. **界面语言**
   - ✅ 支持中文（简体）
   - ✅ 支持英文
   - 📋 **未来**：支持更多语言（日语、韩语等）

2. **自然语言输入**
   - ✅ 支持中文输入（简体）
   - ✅ 支持英文输入
   - ⚠️ **限制**：混合语言输入可能影响理解准确性

3. **澄清问题**
   - ✅ 支持中文问题（简体）
   - ✅ 支持英文问题
   - ✅ 问题类型和选项根据界面语言显示

### 0.4.6 业务约束

#### **业务规则**

1. **用户权限**
   - ✅ 所有已登录用户都可以使用自然语言创建行程
   - ❌ 未登录用户无法使用（需要先登录）
   - 📋 **未来**：支持游客模式（功能受限）

2. **行程数量限制**
   - ✅ 用户可以创建多个行程（无数量限制）
   - ⚠️ **限制**：同时只能有一个创建请求（前端控制）

3. **预算限制**
   - ✅ 预算范围：100 - 1,000,000 CNY
   - ⚠️ **限制**：超出范围的预算可能导致 Gate 评估失败

#### **运营约束**

1. **API 成本**
   - ⚠️ **限制**：每次创建请求都会产生 LLM API 成本
   - **成本估算**：每次请求约 $0.1-0.5（取决于复杂度）
   - **优化策略**：缓存常见查询、优化提示词

2. **数据质量**
   - ⚠️ **限制**：Gate 评估和行程生成的准确性依赖数据质量
   - **数据来源**：POI 数据、交通数据、天气数据等
   - **数据更新频率**：实时/准实时（取决于数据源）

### 0.4.7 边界情况处理

#### **数据边界**

1. **缺失数据**
   - **场景**：目的地数据不完整（POI 数据缺失）
   - **处理**：系统标记为 `UNVERIFIED`，在决策日志中说明
   - **用户提示**：提示用户数据可能不完整

2. **数据冲突**
   - **场景**：用户输入的信息与系统数据冲突（例如：日期与开放时间冲突）
   - **处理**：Gate 评估识别冲突，返回 `ADJUST_REQUIRED`
   - **用户提示**：显示冲突详情和调整建议

#### **系统边界**

1. **API 失败**
   - **场景**：`POST /agent/route_and_run` 接口返回 `FAILED` 或 `TIMEOUT`
   - **处理**：显示错误提示，提供重试选项
   - **用户提示**：友好错误消息，建议检查网络或稍后重试

2. **网络中断**
   - **场景**：用户在网络中断时提交请求
   - **处理**：前端检测网络错误，显示提示
   - **用户提示**：检查网络连接，自动保存输入（LocalStorage）

3. **浏览器兼容性**
   - **场景**：用户在旧版浏览器中使用功能
   - **处理**：检测浏览器版本，显示不兼容提示
   - **用户提示**：建议升级浏览器

---

**验收标准**：
- ✅ 明确了功能范围（In Scope）和功能边界（Out of Scope）
- ✅ 定义了数据约束（输入、输出、验证规则）
- ✅ 定义了合规与约束（安全、责任、技术约束）
- ✅ 定义了设备约束（设备类型、屏幕尺寸、网络要求）
- ✅ 定义了地区与语言约束
- ✅ 定义了业务约束和边界情况处理

---
## 0.6 总体方案概览（端到端闭环图：输入→门控→生成→执行→反馈）

### 0.6.1 总体架构

#### **系统架构图**

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户界面层                                │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  创建行程页面 (/dashboard/trips/new)                     │  │
│  │  - 自然语言输入框                                        │  │
│  │  - 结构化澄清问题界面                                    │  │
│  │  - 行程预览页面                                          │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      前端服务层                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  agentApi.routeAndRun()                                  │  │
│  │  (src/api/agent.ts)                                      │  │
│  │  - 构建 RouteAndRunRequest                               │  │
│  │  - 调用 POST /agent/route_and_run                        │  │
│  │  - 处理 RouteAndRunResponse                              │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    后端 API 层                                   │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  POST /agent/route_and_run                               │  │
│  │  - 路由决策（SYSTEM1 vs SYSTEM2）                        │  │
│  │  - 调用 LangGraph Orchestrator                           │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              LangGraph Orchestrator（状态机）                    │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐      │
│  │ INTAKE   │→ │ RESEARCH │→ │GATE_EVAL │→ │ PLAN_GEN │      │
│  │ (解析)   │  │ (研究)   │  │ (门控)   │  │ (生成)   │      │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘      │
│       │              │              │              │            │
│       │              │              │              ▼            │
│       │              │              │      ┌──────────┐        │
│       │              │              │      │ VERIFY   │        │
│       │              │              │      │ (验证)   │        │
│       │              │              │      └──────────┘        │
│       │              │              │              │            │
│       │              │              │              ▼            │
│       │              │              │      ┌──────────┐        │
│       │              │              │      │ REPAIR   │        │
│       │              │              │      │ (修复)   │        │
│       │              │              │      └──────────┘        │
│       │              │              │              │            │
│       │              │              │              ▼            │
│       │              │              │      ┌──────────┐        │
│       │              │              │      │ NARRATE  │        │
│       │              │              │      │ (叙述)   │        │
│       │              │              │      └──────────┘        │
│       │              │              │              │            │
│       │              │              │              ▼            │
│       │              │              │         DONE             │
│       └──────────────┴──────────────┴──────────────────────────┘
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Sub-Agents 层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ PlannerAgent │  │Gatekeeper    │  │LocalInsight  │         │
│  │ (规划)       │  │Agent (Abu)   │  │Agent         │         │
│  │              │  │(门控/安全)   │  │(本地洞察)    │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │Compliance    │  │CoreDecision  │  │Narrator      │         │
│  │Agent         │  │Agent         │  │Agent         │         │
│  │(合规)        │  │(核心决策)    │  │(叙述)        │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└─────────────────────────────────────────────────────────────────┘
```

### 0.6.2 端到端流程概览

#### **完整流程（端到端闭环）**

```
[用户输入] 
  自然语言描述需求（例如："帮我规划26年春节去冰岛的10天行程，预算100000元"）
    ↓
[前端处理]
  构建 RouteAndRunRequest
  - request_id: 生成唯一ID
  - user_id: 当前用户ID
  - trip_id: null（新建行程）
  - message: 用户输入的自然语言文本
  - conversation_context: 空（首次创建）
  - options: { max_steps: 50, routeType: 'SYSTEM2_REASONING' }
    ↓
[API 调用]
  POST /agent/route_and_run
  (src/api/agent.ts - agentApi.routeAndRun())
    ↓
[路由决策]
  系统判断路由类型：SYSTEM2_REASONING（深度推理）
  - 原因：自然语言理解、多步骤规划、需要 Gate 评估
    ↓
[Orchestrator 执行] (LangGraph 状态机)
  
  [1. INTAKE 阶段]
    PlannerAgent 解析用户意图
    - 提取：目的地、日期、天数、预算、兴趣等
    - 输出：结构化的需求信息
    - 如果信息不足 → 返回 NEED_MORE_INFO + 澄清问题
    ↓
  [2. RESEARCH 阶段]
    LocalInsightAgent 收集目的地信息
    - POI 数据（景点、餐厅、住宿）
    - 交通数据（路线、时刻表）
    - 天气数据（季节性、风险）
    - DEM 数据（地形、海拔）
    ↓
  [3. GATE_EVAL 阶段] ⭐ **决策优先**
    GatekeeperAgent (Abu) 执行 Should-Exist Gate 评估
    - 安全风险评估（HARD/SOFT）
    - 可达性评估（交通、路线）
    - 预算合理性评估
    - 输出：Gate 结论（ALLOW/ADJUST_REQUIRED/BLOCK）
    - 输出：风险矩阵、调整建议
    ↓
  [4. PLAN_GEN 阶段]
    PlannerAgent 生成行程方案
    - 基于 RESEARCH 阶段的数据
    - 考虑 Gate 评估的调整建议
    - 生成：TripDetail（包含 TripDay[] 和 ItineraryItem[]）
    - 每个行程项包含：时间、地点、证据、开放时间
    ↓
  [5. VERIFY 阶段]
    ComplianceAgent 验证行程可执行性
    - 验证时间窗合理性
    - 验证地点可达性
    - 验证疲劳阈值
    - 验证预算合理性
    ↓
  [6. REPAIR 阶段]（如果需要）
    LocalInsightAgent + CoreDecisionAgent 修复问题
    - 预算超支 → 自动修复（调整住宿、活动等）
    - 时间冲突 → 调整时间安排
    - 可达性问题 → 替换地点
    ↓
  [7. NARRATE 阶段]
    NarratorAgent 生成用户友好输出
    - 生成行程预览文案
    - 生成 Gate 评估说明
    - 生成决策日志摘要
    ↓
  [8. DONE 阶段]
    返回 RouteAndRunResponse
    - result.status: OK
    - result.payload.orchestrationResult.itinerary: TripDetail
    - result.payload.orchestrationResult.gate_result: GateResult
    - explain.decision_log: DecisionLogEntry[]
    ↓
[前端处理响应]
  解析 RouteAndRunResponse
    ↓
[行程预览展示]
  - 行程概览视图（10天行程表）
  - Gate 评估结果（风险矩阵、调整建议）
  - 详细行程视图
  - 决策日志视图（可展开）
    ↓
[用户操作]
  ├─ 接受方案 → 调用 tripsApi.create() → 创建行程 → 跳转到 /dashboard/trips/${tripId}
  ├─ 调整方案 → 返回重新规划（循环到用户输入）
  └─ 保存为草稿 → 保存为 status: 'DRAFT' 的行程
    ↓
[执行反馈]（后续）
  用户在 Plan Studio 中继续编辑行程
  用户执行行程（实际旅行）
  用户反馈行程质量（未来）
```

### 0.6.3 接口与数据流

#### **核心接口**

**接口 1：Agent 路由与执行**
- **接口**：`POST /agent/route_and_run`
- **实现**：`agentApi.routeAndRun()`（参考 `src/api/agent.ts`）
- **请求类型**：`RouteAndRunRequest`（参考 `src/api/agent.ts`）
- **响应类型**：`RouteAndRunResponse`（参考 `src/api/agent.ts`）

**接口 2：创建行程**
- **接口**：`POST /trips`
- **实现**：`tripsApi.create()`（参考 `src/api/trips.ts`）
- **请求类型**：`CreateTripRequest`（参考 `src/types/trip.ts`）
- **响应类型**：`CreateTripResponse`（参考 `src/types/trip.ts`）

#### **数据流转**

1. **用户输入 → RouteAndRunRequest**
   ```
   用户自然语言输入
   → 前端构建 RouteAndRunRequest
   → message: "帮我规划26年春节去冰岛的10天行程，预算100000元"
   → conversation_context: { recent_messages: [] }
   → options: { max_steps: 50 }
   ```

2. **RouteAndRunResponse → 行程预览**
   ```
   RouteAndRunResponse
   → result.payload.orchestrationResult.itinerary (TripDetail)
   → result.payload.orchestrationResult.gate_result (GateResult)
   → explain.decision_log (DecisionLogEntry[])
   → 前端解析并展示
   ```

3. **行程预览 → CreateTripRequest**
   ```
   用户接受方案
   → 前端转换 TripDetail → CreateTripRequest
   → 调用 tripsApi.create()
   → 创建行程
   → 跳转到 /dashboard/trips/${tripId}
   ```

### 0.6.4 关键技术组件

#### **1. Agent API（前端调用）**

**文件位置**：`src/api/agent.ts`

**核心方法**：
```typescript
agentApi.routeAndRun(data: RouteAndRunRequest): Promise<RouteAndRunResponse>
```

**使用场景**：
- 自然语言输入后调用
- 澄清问题回答后调用（继续规划）
- 重新规划时调用

**参考**：`src/api/agent.ts` 第 337 行

#### **2. Orchestrator 服务层（如需要）**

**文件位置**：`src/services/orchestrator.ts`

**说明**：
- **当前阶段**：自然语言创建行程**不直接使用** `orchestrator.ts`
- **原因**：`orchestrator.ts` 主要用于 Plan Studio 中的用户操作（添加地点、修改日程等）
- **使用方式**：直接调用 `agentApi.routeAndRun()`，由后端 LangGraph Orchestrator 处理

**未来集成**：
- 如果需要在创建过程中执行用户操作（例如：用户手动添加地点），可以使用 `orchestrator.executeUserAction()`

#### **3. 行程数据结构**

**核心类型**：
- `TripDetail`（参考 `src/types/trip.ts` 第 113 行）
- `TripDay`（参考 `src/types/trip.ts` 第 94 行）
- `ItineraryItem`（参考 `src/types/trip.ts` 第 58 行）

**使用场景**：
- Agent API 返回的行程数据（`RouteAndRunResponse.result.payload.orchestrationResult.itinerary`）
- 前端预览展示
- 创建行程时转换为 `CreateTripRequest`

### 0.6.5 决策优先流程

#### **Should-Exist Gate 在流程中的位置**

```
用户输入
  ↓
INTAKE（解析意图）
  ↓
RESEARCH（收集数据）
  ↓
GATE_EVAL ⭐ **决策优先：先评估可行性**
  ├─ Gate 结论：ALLOW → 继续生成行程
  ├─ Gate 结论：ADJUST_REQUIRED → 生成行程（应用调整建议）
  └─ Gate 结论：BLOCK → 返回阻止原因，不生成行程
  ↓
PLAN_GEN（生成行程）
  ↓
VERIFY（验证行程）
  ↓
REPAIR（修复问题）
  ↓
NARRATE（生成输出）
  ↓
返回结果
```

**关键点**：
- **Gate 评估在行程生成之前**（符合"决策优先"原则）
- **Gate 评估结果影响行程生成**（ADJUST_REQUIRED 时应用调整建议）
- **Gate 评估结果在预览页面展示**（用户可以看到评估过程和结果）

### 0.6.6 可执行优先流程

#### **证据收集与验证流程**

```
RESEARCH 阶段
  ├─ 收集 POI 数据（景点、餐厅、住宿）
  ├─ 收集交通数据（路线、时刻表）
  ├─ 收集开放时间数据
  ├─ 收集天气数据
  └─ 收集 DEM 数据（地形、海拔）
    ↓
PLAN_GEN 阶段
  ├─ 生成行程项（ItineraryItem）
  ├─ 每个行程项包含：
  │   ├─ 时间窗（startTime, endTime）
  │   ├─ 地点（placeId）
  │   ├─ 证据引用（evidence_refs）
  │   └─ 开放时间/票务信息
  └─ 标记 UNVERIFIED 项（如果无法验证）
    ↓
VERIFY 阶段
  ├─ 验证时间窗合理性
  ├─ 验证地点可达性
  ├─ 验证开放时间
  └─ 标记无法验证的项
    ↓
输出结果
  ├─ 可执行项（有证据支撑）
  └─ UNVERIFIED 项（在决策日志中说明）
```

**关键点**：
- **所有行程项必须有证据支撑**（或标记为 UNVERIFIED）
- **不允许编造事实**（如：交通班次、开放时间、票价）
- **无法验证的内容必须标注**（在决策日志中说明）

### 0.6.7 与现有系统的集成

#### **1. 与 Plan Studio 集成**

```
创建行程成功
  ↓
跳转到 /dashboard/trips/${tripId}
  ↓
用户可以在 Plan Studio 中继续编辑
  - 添加/删除地点
  - 调整时间安排
  - 优化路线
  - 调用 orchestrator.executeUserAction()（如果需要）
```

**集成点**：
- 创建成功后，行程数据保存到数据库
- Plan Studio 可以加载并编辑该行程
- 支持"重新规划"功能（调用 Agent 重新生成）

#### **2. 与行程详情页集成**

```
创建行程成功
  ↓
跳转到 /dashboard/trips/${tripId}
  ↓
行程详情页显示
  - 完整行程数据（TripDetail）
  - 决策日志（可展开查看）
  - Gate 评估结果（如果有）
```

**集成点**：
- 行程详情页可以展示完整的决策日志
- 支持"查看规划过程"功能（展示规划历史）

#### **3. 与 Agent Chat 集成（未来）**

```
创建过程中
  ↓
用户可以切换到 Agent Chat
  ↓
Agent Chat 可以访问规划上下文
  - 当前规划状态
  - 已收集的信息
  - 用户需求
  ↓
支持"继续规划"功能
```

**集成点**：
- Agent Chat 可以访问当前的 `conversation_context`
- 支持从 Agent Chat 继续规划流程

### 0.6.8 关键设计决策

#### **决策 1：使用 `POST /agent/route_and_run` 接口**

**理由**：
- ✅ 统一的 Agent API 入口
- ✅ 支持路由决策（SYSTEM1 vs SYSTEM2）
- ✅ 支持完整的 Orchestrator 状态机流程
- ✅ 返回决策日志和可观测性指标

**参考**：`src/api/agent.ts` 第 337 行

#### **决策 2：Gate 评估在后台执行，结果在预览中展示**

**理由**：
- ✅ 符合"决策优先"原则（Gate 评估在行程生成前执行）
- ✅ 用户体验优先（用户希望看到完整的行程方案）
- ✅ 决策日志透明（用户可以通过决策日志查看 Gate 评估过程）

**参考**：澄清文档 0.1.2 节

#### **决策 3：结构化澄清问题（Phase 1）**

**理由**：
- ✅ 用户体验更好（多种输入方式）
- ✅ 数据质量更高（格式验证）
- ✅ 与现有表单组件一致

**参考**：澄清文档 0.1.1 节

#### **决策 4：预算自动修复（Phase 1）**

**理由**：
- ✅ 减少用户决策负担
- ✅ 快速上线验证用户需求
- ✅ Phase 2 支持用户手动控制（如果需要）

**参考**：澄清文档 0.1.3 节

---

**验收标准**：
- ✅ 清晰描述了端到端流程（输入→门控→生成→执行→反馈）
- ✅ 说明了使用 `POST /agent/route_and_run` 接口
- ✅ 说明了不使用 `src/services/orchestrator.ts`（直接调用 Agent API）
- ✅ 说明了决策优先流程（Gate 评估在行程生成前）
- ✅ 说明了可执行优先流程（证据收集与验证）
- ✅ 说明了与现有系统的集成方式

---
## 0.7 关键流程（用户流 + 系统流 + 异常流）

### 0.7.1 用户流程（User Flow）

#### **主流程：自然语言创建行程**

```
[入口] 用户进入创建行程页面 (/dashboard/trips/new)
  ↓
[选择方式] 用户选择创建方式
  ├─ 自然语言创建（nl tab）→ 继续
  └─ 结构化表单（form tab）→ 使用现有表单流程（不在本 PRD 范围）
  ↓
[输入需求] 用户在文本框中输入自然语言需求
  示例："帮我规划26年春节去冰岛的10天行程，预算100000元"
  ↓
[提交请求] 用户点击"开始规划"按钮
  ↓
[等待处理] 用户看到加载状态
  - UI 状态：thinking → browsing → verifying → repairing
  - 状态文案：根据 OrchestrationStep 显示详细描述
  ↓
[澄清问题]（如果需要）
  ├─ 系统返回 NEED_MORE_INFO 状态
  ├─ 用户看到结构化澄清问题（卡片形式）
  ├─ 用户回答问题（文本/选择/日期等）
  ├─ 用户点击"提交"按钮
  └─ 可能多轮澄清（最多 5 轮）
  ↓
[查看预览] 用户看到行程预览页面
  ├─ 行程概览（10天行程表）
  ├─ Gate 评估结果（风险矩阵、调整建议）
  ├─ 详细行程（每天的具体安排）
  └─ 决策日志（可展开查看）
  ↓
[用户操作] 用户选择操作
  ├─ 接受方案 → 创建行程 → 跳转到 /dashboard/trips/${tripId}
  ├─ 调整方案 → 返回重新规划（循环到输入需求）
  └─ 保存为草稿 → 保存为 status: 'DRAFT' 的行程
```

#### **关键决策点（Decision Points）**

1. **选择创建方式**
   - 决策点：用户是否选择自然语言创建
   - 影响：进入不同的创建流程

2. **澄清问题回答**
   - 决策点：用户是否回答所有必填问题
   - 影响：系统是否继续生成行程

3. **行程预览评估**
   - 决策点：用户是否接受方案
   - 影响：是否创建行程或重新规划

### 0.7.2 系统流程（System Flow）

#### **系统处理流程**

```
[接收请求]
  前端调用 agentApi.routeAndRun(request)
  - request: RouteAndRunRequest
  - trip_id: null（新建行程）
  ↓
[路由决策]
  系统判断路由类型：SYSTEM2_REASONING
  - 原因：自然语言理解、多步骤规划、需要 Gate 评估
  - 路由类型：RouteType = 'SYSTEM2_REASONING'（参考 `src/api/agent.ts` 第 13 行）
  ↓
[Orchestrator 执行] (LangGraph 状态机)
  
  [1. INTAKE 阶段]
    - Actor: PlannerAgent
    - 输入：用户自然语言文本
    - 处理：解析用户意图（目的地、日期、天数、预算等）
    - 输出：
      ├─ 如果信息充足 → 继续 RESEARCH
      └─ 如果信息不足 → 返回 NEED_MORE_INFO + clarificationQuestions
    ↓
  [2. RESEARCH 阶段]（如果信息充足）
    - Actor: LocalInsightAgent
    - 输入：结构化的需求信息
    - 处理：
      ├─ 收集 POI 数据（景点、餐厅、住宿）
      ├─ 收集交通数据（路线、时刻表）
      ├─ 收集天气数据（季节性、风险）
      └─ 收集 DEM 数据（地形、海拔）
    - 输出：目的地数据集合
    ↓
  [3. GATE_EVAL 阶段] ⭐ **决策优先**
    - Actor: GatekeeperAgent (Abu)
    - 输入：需求信息 + 目的地数据
    - 处理：
      ├─ 安全风险评估（HARD/SOFT）
      ├─ 可达性评估（交通、路线）
      └─ 预算合理性评估
    - 输出：
      ├─ Gate 结论：ALLOW / ADJUST_REQUIRED / BLOCK
      ├─ 风险矩阵：HARD/SOFT/OK 风险分类
      └─ 调整建议（如果有）
    ↓
  [4. PLAN_GEN 阶段]（如果 Gate 结论不是 BLOCK）
    - Actor: PlannerAgent
    - 输入：需求信息 + 目的地数据 + Gate 评估结果
    - 处理：
      ├─ 生成行程骨架（TripDay[]）
      ├─ 生成行程项（ItineraryItem[]）
      ├─ 应用 Gate 评估的调整建议
      └─ 为每个行程项添加证据引用
    - 输出：TripDetail（包含 TripDay[] 和 ItineraryItem[]）
    ↓
  [5. VERIFY 阶段]
    - Actor: ComplianceAgent
    - 输入：生成的行程方案
    - 处理：
      ├─ 验证时间窗合理性
      ├─ 验证地点可达性
      ├─ 验证开放时间
      └─ 验证疲劳阈值
    - 输出：验证结果（通过/需要修复）
    ↓
  [6. REPAIR 阶段]（如果需要）
    - Actor: LocalInsightAgent + CoreDecisionAgent
    - 输入：验证失败的行程方案
    - 处理：
      ├─ 预算超支 → 自动修复（调整住宿、活动等）
      ├─ 时间冲突 → 调整时间安排
      └─ 可达性问题 → 替换地点
    - 输出：修复后的行程方案
    ↓
  [7. NARRATE 阶段]
    - Actor: NarratorAgent
    - 输入：最终的行程方案
    - 处理：
      ├─ 生成用户友好的行程预览文案
      ├─ 生成 Gate 评估说明
      └─ 生成决策日志摘要
    - 输出：用户友好的输出文本
    ↓
  [8. DONE 阶段]
    - 构建 RouteAndRunResponse
    - 返回给前端
  ↓
[返回响应]
  RouteAndRunResponse
  - result.status: OK / NEED_MORE_INFO / NEED_CONFIRMATION / FAILED / TIMEOUT
  - result.payload.orchestrationResult.itinerary: TripDetail
  - result.payload.orchestrationResult.gate_result: GateResult
  - explain.decision_log: DecisionLogEntry[]
```

#### **路由类型说明**

**路由类型**：`RouteType`（参考 `src/api/agent.ts` 第 13 行）

**自然语言创建行程使用的路由类型**：
- **SYSTEM2_REASONING**：深度推理
  - **原因**：需要自然语言理解、多步骤规划、Gate 评估
  - **特点**：耗时较长（10-30 秒），但结果更准确

**其他路由类型**（本功能不使用）：
- SYSTEM1_API：快速 API 调用（简单查询）
- SYSTEM1_RAG：RAG 检索增强（知识检索）
- SYSTEM2_WEBBROWSE：网页浏览（需要用户授权）

#### **结果状态处理**

**结果状态**：`ResultStatus`（参考 `src/api/agent.ts` 第 18 行）

**状态处理流程**：

1. **OK**
   - **含义**：成功生成行程方案
   - **前端处理**：
     - 解析 `result.payload.orchestrationResult.itinerary`
     - 展示行程预览页面
     - 展示 Gate 评估结果（如果有）

2. **NEED_MORE_INFO**
   - **含义**：需要用户澄清更多信息
   - **前端处理**：
     - 解析 `result.payload.clarificationQuestions`（结构化问题数组）
     - 显示澄清问题界面
     - 用户回答后，继续调用 `routeAndRun`（包含 `conversation_context.recent_messages`）

3. **NEED_CONSENT**
   - **含义**：需要用户授权（例如：webbrowse）
   - **前端处理**：
     - 显示授权提示
     - 用户授权后，继续执行

4. **NEED_CONFIRMATION**
   - **含义**：需要用户审批（高风险操作）
   - **前端处理**：
     - 显示审批对话框（参考 `SuspensionInfo`，`src/api/agent.ts` 第 170 行）
     - 用户审批后，继续执行

5. **FAILED**
   - **含义**：处理失败
   - **前端处理**：
     - 显示错误提示
     - 提供重试选项

6. **TIMEOUT**
   - **含义**：请求超时
   - **前端处理**：
     - 显示超时提示
     - 提供重试选项或"简化需求"选项

7. **REDIRECT_REQUIRED**
   - **含义**：需要重定向到其他页面
   - **前端处理**：
     - 解析 `result.payload.redirectInfo`
     - 重定向到指定页面（例如：Planning Workbench）

### 0.7.3 异常流程（Error Flow）

#### **异常场景 1：用户输入信息不足**

**场景**：用户输入的需求信息非常少（例如："去日本"）

**系统流程**：
```
INTAKE 阶段
  → PlannerAgent 解析用户意图
  → 识别信息不足（缺少日期、天数、预算等）
  → 返回 NEED_MORE_INFO 状态
  → 生成结构化澄清问题（clarificationQuestions）
  ↓
前端处理
  → 显示澄清问题界面
  → 用户回答问题
  → 继续调用 routeAndRun（包含 conversation_context.recent_messages）
  ↓
继续处理
  → 重新进入 INTAKE 阶段（或直接进入 RESEARCH）
```

**用户提示**：
- 显示友好的提示："为了更好地规划您的行程，请回答以下问题"

#### **异常场景 2：Gate 评估 BLOCK**

**场景**：Gate 评估结果为 `BLOCK`（例如：安全风险过高）

**系统流程**：
```
GATE_EVAL 阶段
  → GatekeeperAgent 评估
  → 识别 HARD 风险（例如：无户外经验 + 冬季极端天气 + 高风险活动）
  → 返回 Gate 结论：BLOCK
  → 生成阻止原因和风险详情
  ↓
PLAN_GEN 阶段
  → 不生成行程（因为 BLOCK）
  ↓
NARRATE 阶段
  → 生成用户友好的阻止说明
  → 提供替代方案建议
  ↓
返回响应
  → result.status: OK（虽然 BLOCK，但处理成功）
  → result.payload.orchestrationResult.gate_result.result: BLOCK
  ↓
前端处理
  → 显示 BLOCK 结果和阻止原因
  → 显示替代方案建议
  → 提供"强制继续"选项（需要审批）或"返回重新规划"
```

**用户提示**：
- 显示明确的阻止原因："您的需求存在安全风险，系统不建议执行"
- 提供替代方案："建议改为...（替代方案）"

#### **异常场景 3：多轮澄清超过 5 轮**

**场景**：用户已经回答了 5 轮澄清问题，但系统仍需要更多信息

**系统流程**：
```
第 5 轮澄清后
  → 系统再次返回 NEED_MORE_INFO
  ↓
前端处理
  → 检测澄清轮数 >= 5
  → 显示提示："信息不足，建议使用结构化表单创建行程"
  → 提供"切换到表单模式"选项
  → 提供"继续"选项（如果用户愿意）
```

**用户提示**：
- 显示友好提示："为了节省您的时间，建议使用结构化表单创建行程"
- 提供切换选项

#### **异常场景 4：API 超时**

**场景**：`POST /agent/route_and_run` 接口超时（> 60 秒）

**系统流程**：
```
API 调用
  → 请求发送到后端
  → 后端处理时间超过 60 秒
  → 前端收到超时错误（ECONNABORTED）
  ↓
前端处理
  → 检测超时错误
  → 显示超时提示
  → 提供选项：
     ├─ "重试"（重新发送请求）
     ├─ "简化需求"（提示用户简化需求后重试）
     └─ "保存为草稿"（保存当前输入，稍后继续）
```

**用户提示**：
- 显示友好提示："请求超时，可能是网络问题或需求过于复杂"
- 提供重试选项和简化建议

#### **异常场景 5：API 失败**

**场景**：`POST /agent/route_and_run` 接口返回 `FAILED` 状态

**系统流程**：
```
Orchestrator 执行
  → 某个阶段处理失败（例如：数据源不可用）
  → 返回 FAILED 状态
  ↓
前端处理
  → 检测 FAILED 状态
  → 显示错误提示
  → 提供"重试"选项
  → 记录错误日志（用于排查）
```

**用户提示**：
- 显示友好提示："处理失败，请稍后重试"
- 提供重试选项

#### **异常场景 6：网络中断**

**场景**：用户在网络中断时提交请求

**系统流程**：
```
前端发送请求
  → 网络中断
  → 检测网络错误（ERR_NETWORK）
  ↓
前端处理
  → 检测网络错误
  → 自动保存用户输入（LocalStorage）
  → 显示网络错误提示
  → 提供"重试"选项（网络恢复后）
```

**用户提示**：
- 显示友好提示："网络连接中断，请检查网络后重试"
- 自动保存输入，避免用户重新输入

#### **异常场景 7：预算严重超支**

**场景**：系统生成的行程预算超出用户预算 50% 以上

**系统流程**：
```
PLAN_GEN 阶段
  → 生成初始行程方案
  → 计算总预算：¥116,000（用户预算：¥100,000）
  ↓
VERIFY 阶段
  → 验证预算：超出 ¥16,000（超出 16%）
  → 标记为需要修复
  ↓
REPAIR 阶段
  → 自动修复预算超支
  → 调整住宿等级、餐饮、活动等
  → 最终预算：¥100,000
  ↓
NARRATE 阶段
  → 生成修复说明："系统已自动调整预算，节省 ¥16,000"
  ↓
返回响应
  → 返回修复后的行程方案
  → 在决策日志中记录修复过程
  ↓
前端处理
  → 显示修复说明
  → 展示修复前后的对比（在决策日志中）
```

**用户提示**：
- 显示修复说明："系统已自动调整预算，节省 ¥X"
- 在决策日志中展示修复详情

### 0.7.4 状态机映射

#### **OrchestrationStep → UI 状态映射**

**OrchestrationStep**（参考 `src/api/agent.ts` 第 91 行）：
- `INTAKE` | `RESEARCH` | `GATE_EVAL` | `PLAN_GEN` | `VERIFY` | `REPAIR` | `NARRATE` | `DONE` | `FAILED`

**UI 状态**（参考 `src/api/agent.ts` 第 23 行）：
- `thinking` | `browsing` | `verifying` | `repairing` | `awaiting_consent` | `awaiting_confirmation` | `awaiting_user_input` | `done` | `failed`

**映射关系**：

| OrchestrationStep | UI 状态 | 说明 |
|------------------|---------|------|
| `INTAKE` | `thinking` | AI 正在理解用户需求 |
| `RESEARCH` | `browsing` | 正在收集目的地信息 |
| `GATE_EVAL` | `verifying` | 正在评估可行性 |
| `PLAN_GEN` | `thinking` | 正在生成行程方案 |
| `VERIFY` | `verifying` | 正在验证行程可执行性 |
| `REPAIR` | `repairing` | 正在优化行程方案 |
| `NARRATE` | `thinking` | 正在生成用户友好输出 |
| `DONE` | `done` | 处理完成 |
| `FAILED` | `failed` | 处理失败 |

**特殊状态**：
- `NEED_MORE_INFO` → `awaiting_user_input`（等待用户输入澄清问题答案）
- `NEED_CONSENT` → `awaiting_consent`（等待用户授权）
- `NEED_CONFIRMATION` → `awaiting_confirmation`（等待用户审批）

#### **状态文案**

**根据 OrchestrationStep 显示详细描述**：

- `INTAKE` → "AI 正在理解您的需求..."
- `RESEARCH` → "正在收集目的地信息..."
- `GATE_EVAL` → "正在评估行程可行性..."
- `PLAN_GEN` → "正在生成行程方案..."
- `VERIFY` → "正在验证行程可执行性..."
- `REPAIR` → "正在优化行程方案..."
- `NARRATE` → "正在生成最终方案..."

### 0.7.5 数据流

#### **请求数据流**

```
用户输入
  → 前端构建 RouteAndRunRequest
  → {
      request_id: "req-${Date.now()}-${random}",
      user_id: user.id,
      trip_id: null,
      message: "帮我规划26年春节去冰岛的10天行程，预算100000元",
      conversation_context: {
        recent_messages: []
      },
      options: {
        max_steps: 50
      }
    }
  → POST /agent/route_and_run
```

#### **响应数据流**

```
RouteAndRunResponse
  → {
      request_id: "...",
      route: {
        route: "SYSTEM2_REASONING",
        ...
      },
      result: {
        status: "OK",
        answer_text: "已为您生成10天冰岛行程方案",
        payload: {
          orchestrationResult: {
            itinerary: TripDetail,
            gate_result: GateResult,
            decision_log: DecisionLogEntry[]
          }
        }
      },
      explain: {
        decision_log: DecisionLogEntry[]
      },
      observability: {
        latency_ms: 12000,
        ...
      }
    }
  → 前端解析并展示
```

#### **澄清问题数据流**

```
第一轮请求
  → RouteAndRunRequest (message: "帮我规划...")
  → 返回 NEED_MORE_INFO + clarificationQuestions
  ↓
用户回答
  → 前端构建新的 RouteAndRunRequest
  → {
      message: "回答澄清问题的答案",
      conversation_context: {
        recent_messages: [
          "帮我规划...",
          "回答澄清问题的答案"
        ]
      }
    }
  → POST /agent/route_and_run
  → 继续处理
```

---

**验收标准**：
- ✅ 清晰描述了用户流程（主流程和关键决策点）
- ✅ 清晰描述了系统流程（Orchestrator 状态机和 Sub-Agents 协作）
- ✅ 清晰描述了异常流程（7 个异常场景的处理方式）
- ✅ 说明了路由类型（SYSTEM2_REASONING）
- ✅ 说明了结果状态处理（7 种状态的处理方式）
- ✅ 说明了状态机映射（OrchestrationStep → UI 状态）
- ✅ 说明了数据流（请求、响应、澄清问题）

---
## 0.10 核心能力：结构化澄清问题（Structured Clarification Questions）

### 0.10.1 功能概述

#### **核心价值**

结构化澄清问题是自然语言创建行程流程中的关键能力，用于在用户输入信息不足时，通过**结构化问题**收集必要信息，确保系统能够生成准确、可执行的行程方案。

**与传统文本澄清的区别**：
- ✅ **多种输入方式**：支持文本、单选、多选、日期、数字等
- ✅ **数据验证**：支持必填验证和格式验证
- ✅ **用户体验**：降低输入错误，提升数据质量
- ✅ **一致性**：与现有表单组件保持一致

### 0.10.2 问题类型定义

#### **问题类型枚举**

**类型定义**：`ClarificationQuestionType`（参考澄清文档）

```typescript
export type ClarificationQuestionType = 
  | 'text'           // 文本输入
  | 'single_choice'  // 单选
  | 'multi_choice'   // 多选
  | 'date'           // 日期选择
  | 'number';        // 数字输入
```

#### **各类型说明**

1. **text（文本输入）**
   - **用途**：收集开放文本信息（例如：同行人数、兴趣描述）
   - **前端组件**：`Textarea` 或 `Input`（参考 `src/components/ui/textarea.tsx`、`src/components/ui/input.tsx`）
   - **验证规则**：可选 `validation.pattern`（正则表达式）

2. **single_choice（单选）**
   - **用途**：从多个选项中选择一个（例如：出行日期、节奏偏好）
   - **前端组件**：`RadioGroup` 或 `Select`（参考 `src/components/ui/radio-group.tsx`、`src/components/ui/select.tsx`）
   - **必需字段**：`options: string[]`（选项列表）

3. **multi_choice（多选）**
   - **用途**：从多个选项中选择多个（例如：兴趣标签、必去景点）
   - **前端组件**：`Checkbox` 组（参考 `src/components/ui/checkbox.tsx`）
   - **必需字段**：`options: string[]`（选项列表）

4. **date（日期选择）**
   - **用途**：选择日期（例如：出发日期、返回日期）
   - **前端组件**：`Input type="date"` 或 `DatePicker`（如果项目有 DatePicker 组件）
   - **验证规则**：可选 `validation.min` / `validation.max`（日期范围）

5. **number（数字输入）**
   - **用途**：输入数字（例如：预算、天数、同行人数）
   - **前端组件**：`Input type="number"`（参考 `src/components/ui/input.tsx`）
   - **验证规则**：可选 `validation.min` / `validation.max`（数值范围）

### 0.10.3 数据结构定义

#### **类型定义文件位置**

**文件路径**：`src/types/clarification.ts`（新建）

#### **完整类型定义代码**

```typescript
/**
 * 澄清问题类型枚举
 */
export type ClarificationQuestionType = 
  | 'text'           // 文本输入
  | 'single_choice'  // 单选
  | 'multi_choice'   // 多选
  | 'date'           // 日期选择
  | 'number';        // 数字输入

/**
 * 验证规则接口
 */
export interface ClarificationQuestionValidation {
  min?: number;        // 最小值（用于 number 和 date，date 使用时间戳）
  max?: number;        // 最大值（用于 number 和 date，date 使用时间戳）
  pattern?: string;    // 正则表达式（用于 text）
}

/**
 * 澄清问题数据结构
 */
export interface ClarificationQuestion {
  id: string;                                    // 问题 ID（唯一标识）
  question: string;                              // 问题文本（用户看到的问题）
  type: ClarificationQuestionType;               // 问题类型
  options?: string[];                            // 选项列表（用于 single_choice 和 multi_choice）
  required: boolean;                             // 是否必填
  placeholder?: string;                          // 占位符（用于 text 和 number）
  hint?: string;                                 // 提示文本（帮助用户理解问题）
  default?: string | string[];                   // 默认值
  validation?: ClarificationQuestionValidation;  // 验证规则（可选）
}

/**
 * 澄清问题回答
 */
export interface ClarificationAnswer {
  questionId: string;                            // 问题 ID（关联 ClarificationQuestion.id）
  value: string | string[] | number | null;      // 回答值
}
```

**字段说明**：

| 字段 | 类型 | 必需 | 说明 |
|------|------|------|------|
| `id` | `string` | ✅ | 问题 ID，用于标识问题和关联答案 |
| `question` | `string` | ✅ | 问题文本，用户看到的问题描述 |
| `type` | `ClarificationQuestionType` | ✅ | 问题类型（text/single_choice/multi_choice/date/number） |
| `options` | `string[]` | ❌ | 选项列表（single_choice 和 multi_choice 必需） |
| `required` | `boolean` | ✅ | 是否必填 |
| `placeholder` | `string` | ❌ | 占位符（text 和 number 推荐使用） |
| `hint` | `string` | ❌ | 提示文本（帮助用户理解问题） |
| `default` | `string \| string[]` | ❌ | 默认值（可选） |
| `validation` | `object` | ❌ | 验证规则（可选） |

#### **ClarificationAnswer 接口**

```typescript
/**
 * 澄清问题回答
 */
export interface ClarificationAnswer {
  questionId: string;            // 问题 ID（关联 ClarificationQuestion.id）
  value: string | string[] | number | null; // 回答值
}
```

**字段说明**：

| 字段 | 类型 | 说明 |
|------|------|------|
| `questionId` | `string` | 问题 ID，关联 `ClarificationQuestion.id` |
| `value` | `string \| string[] \| number \| null` | 回答值 |
| | | - `text` → `string` |
| | | - `single_choice` → `string`（选项值） |
| | | - `multi_choice` → `string[]`（选项值数组） |
| | | - `date` → `string`（ISO 8601 格式：YYYY-MM-DD） |
| | | - `number` → `number` |

### 0.10.4 API 接口定义

#### **RouteAndRunResponse 扩展**

**需要后端支持**：在 `RouteAndRunResponse.result.payload` 中新增字段

```typescript
export interface RouteAndRunResponsePayload {
  // ... 现有字段
  
  // 向后兼容：简单字符串（Markdown 格式）
  clarificationMessage?: string;
  
  // 新增：结构化问题数组（Phase 1）
  clarificationQuestions?: ClarificationQuestion[];
  
  // ... 其他字段
}
```

**使用场景**：
- 当 `result.status === 'NEED_MORE_INFO'` 时，返回 `clarificationQuestions`
- 如果后端不支持结构化问题，可以返回 `clarificationMessage`（向后兼容）

### 0.10.5 前端组件设计

#### **组件结构**

```
ClarificationQuestionsPanel（澄清问题面板）
  ├─ ClarificationQuestionCard（单个问题卡片）
  │   ├─ 问题标题（question）
  │   ├─ 提示文本（hint，如果有）
  │   ├─ 输入组件（根据 type 渲染）
  │   │   ├─ text → Textarea / Input
  │   │   ├─ single_choice → RadioGroup / Select
  │   │   ├─ multi_choice → Checkbox 组
  │   │   ├─ date → Input type="date"
  │   │   └─ number → Input type="number"
  │   └─ 错误提示（如果验证失败）
  ├─ 提交按钮（"提交" / "继续规划"）
  └─ 跳过按钮（如果所有问题都不是必填）
```

#### **ClarificationQuestionCard 组件设计**

**Props 接口**：

```typescript
interface ClarificationQuestionCardProps {
  question: ClarificationQuestion;
  value: string | string[] | number | null;
  onChange: (value: string | string[] | number | null) => void;
  error?: string;  // 验证错误信息
  disabled?: boolean;
}
```

**渲染逻辑**：

```typescript
// 伪代码
function ClarificationQuestionCard({ question, value, onChange, error, disabled }) {
  return (
    <Card>
      <CardHeader>
        <CardTitle>
          {question.question}
          {question.required && <span className="text-red-500">*</span>}
        </CardTitle>
        {question.hint && (
          <CardDescription>{question.hint}</CardDescription>
        )}
      </CardHeader>
      <CardContent>
        {question.type === 'text' && (
          <Textarea
            value={value as string || ''}
            onChange={(e) => onChange(e.target.value)}
            placeholder={question.placeholder}
            disabled={disabled}
          />
        )}
        {question.type === 'single_choice' && (
          <RadioGroup
            value={value as string || ''}
            onValueChange={onChange}
            disabled={disabled}
          >
            {question.options?.map(option => (
              <RadioGroupItem key={option} value={option}>
                {option}
              </RadioGroupItem>
            ))}
          </RadioGroup>
        )}
        {question.type === 'multi_choice' && (
          <div className="space-y-2">
            {question.options?.map(option => (
              <div key={option} className="flex items-center space-x-2">
                <Checkbox
                  checked={(value as string[] || []).includes(option)}
                  onCheckedChange={(checked) => {
                    const current = value as string[] || [];
                    onChange(
                      checked
                        ? [...current, option]
                        : current.filter(v => v !== option)
                    );
                  }}
                  disabled={disabled}
                />
                <Label>{option}</Label>
              </div>
            ))}
          </div>
        )}
        {question.type === 'date' && (
          <Input
            type="date"
            value={value as string || ''}
            onChange={(e) => onChange(e.target.value)}
            min={question.validation?.min?.toString()}
            max={question.validation?.max?.toString()}
            disabled={disabled}
          />
        )}
        {question.type === 'number' && (
          <Input
            type="number"
            value={value as number || ''}
            onChange={(e) => onChange(Number(e.target.value))}
            placeholder={question.placeholder}
            min={question.validation?.min}
            max={question.validation?.max}
            disabled={disabled}
          />
        )}
        {error && (
          <p className="text-sm text-red-500 mt-1">{error}</p>
        )}
      </CardContent>
    </Card>
  );
}
```

**参考现有组件**：
- `src/components/ui/card.tsx`：Card 组件
- `src/components/ui/textarea.tsx`：Textarea 组件
- `src/components/ui/input.tsx`：Input 组件
- `src/components/ui/select.tsx`：Select 组件
- `src/components/ui/radio-group.tsx`：RadioGroup 组件
- `src/components/ui/checkbox.tsx`：Checkbox 组件

### 0.10.6 数据验证

#### **验证规则**

1. **必填验证（required）**
   - **规则**：如果 `required: true`，用户必须回答该问题
   - **前端处理**：提交前检查所有必填问题是否已回答
   - **错误提示**："此问题为必填项"

2. **格式验证（validation）**
   - **text 类型**：
     - `validation.pattern`：正则表达式验证
     - 示例：邮箱格式、手机号格式
   - **number 类型**：
     - `validation.min`：最小值
     - `validation.max`：最大值
     - 示例：预算范围 100-1000000
   - **date 类型**：
     - `validation.min`：最早日期（时间戳或日期字符串）
     - `validation.max`：最晚日期（时间戳或日期字符串）
     - 示例：日期范围限制

3. **选项验证（single_choice / multi_choice）**
   - **规则**：用户选择的选项必须在 `options` 列表中
   - **前端处理**：组件限制用户只能选择 `options` 中的选项

#### **验证时机**

1. **实时验证**（可选）
   - 用户输入时实时验证
   - 显示验证错误提示
   - 提升用户体验

2. **提交验证**（必需）
   - 用户点击"提交"按钮时验证
   - 检查所有必填问题和格式
   - 如果有错误，阻止提交并显示错误提示

### 0.10.7 向后兼容

#### **兼容策略**

**场景 1：后端返回 `clarificationQuestions`（结构化数组）**
- ✅ 使用结构化展示
- ✅ 根据问题类型渲染不同的输入组件
- ✅ 支持数据验证

**场景 2：后端返回 `clarificationMessage`（简单字符串）**
- ✅ 向后兼容：解析为文本类型问题
- ✅ 将 `clarificationMessage` 解析为单个 `text` 类型问题
- ✅ 用户通过 `Textarea` 输入回答

**解析逻辑**（伪代码）：

```typescript
// 如果后端返回 clarificationMessage，解析为文本类型问题
if (response.result.payload.clarificationMessage && 
    !response.result.payload.clarificationQuestions) {
  const fallbackQuestion: ClarificationQuestion = {
    id: 'fallback-1',
    question: response.result.payload.clarificationMessage,
    type: 'text',
    required: true,
    placeholder: '请输入您的回答...',
  };
  clarificationQuestions = [fallbackQuestion];
}
```

### 0.10.8 多轮澄清流程

#### **流程设计**

```
第一轮请求
  → RouteAndRunRequest (message: "帮我规划...")
  → 返回 NEED_MORE_INFO + clarificationQuestions: Question[]
  ↓
前端显示
  → 显示澄清问题界面
  → 用户回答问题
  → 构建 ClarificationAnswer[]
  ↓
用户提交
  → 构建新的 RouteAndRunRequest
  → {
      message: "回答澄清问题的答案（格式化后的文本）",
      conversation_context: {
        recent_messages: [
          "帮我规划...",
          "回答澄清问题的答案"
        ]
      }
    }
  → 继续调用 routeAndRun
  ↓
可能多轮澄清
  → 最多 5 轮
  → 每轮澄清后更新 UI 状态
  → 超过 5 轮后，提示用户"信息不足，建议使用结构化表单"
```

#### **轮数限制**

- **最大轮数**：5 轮
- **原因**：避免死循环，提升用户体验
- **处理方式**：
  - 前端记录澄清轮数（`clarificationRound`）
  - 超过 5 轮后，显示提示："信息不足，建议使用结构化表单创建行程"
  - 提供"切换到表单模式"选项

### 0.10.9 典型问题示例

#### **示例 1：出行日期（date 类型）**

```typescript
{
  id: "question-1",
  question: "请选择您的出行日期",
  type: "date",
  required: true,
  hint: "建议选择 1 个月后的日期，以便提前预订",
  validation: {
    min: new Date().getTime() + 24 * 60 * 60 * 1000, // 明天
    max: new Date().getTime() + 365 * 24 * 60 * 60 * 1000 * 2, // 2年后
  }
}
```

#### **示例 2：同行人数（single_choice 类型）**

```typescript
{
  id: "question-2",
  question: "同行人数",
  type: "single_choice",
  required: true,
  options: ["1人", "2人", "3-4人", "5人以上"],
  hint: "这将影响住宿和交通安排"
}
```

#### **示例 3：主要兴趣（multi_choice 类型）**

```typescript
{
  id: "question-3",
  question: "您的主要兴趣（可多选）",
  type: "multi_choice",
  required: false,
  options: ["极光", "冰川", "温泉", "文化", "美食", "户外运动"],
  hint: "帮助我们为您推荐合适的景点和活动"
}
```

#### **示例 4：预算（number 类型）**

```typescript
{
  id: "question-4",
  question: "总预算（人民币）",
  type: "number",
  required: true,
  placeholder: "例如：100000",
  hint: "包含机票、住宿、餐饮、活动等所有费用",
  validation: {
    min: 100,
    max: 1000000,
  }
}
```

#### **示例 5：其他需求（text 类型）**

```typescript
{
  id: "question-5",
  question: "其他需求或偏好（可选）",
  type: "text",
  required: false,
  placeholder: "例如：希望体验当地文化、偏好安静的住宿环境等",
  hint: "任何其他需要特别说明的需求"
}
```

### 0.10.10 实现建议

#### **前端实现步骤**

1. **创建类型定义文件**
   - 文件：`src/types/clarification.ts`（新建）
   - 内容：`ClarificationQuestion`、`ClarificationAnswer`、`ClarificationQuestionType`

2. **创建组件**
   - `src/components/trips/ClarificationQuestionCard.tsx`：单个问题卡片组件
   - `src/components/trips/ClarificationQuestionsPanel.tsx`：澄清问题面板组件

3. **集成到创建页面**
   - 在 `src/pages/trips/new.tsx` 中集成
   - 替换现有的简单文本澄清问题实现

4. **数据验证**
   - 实现验证逻辑
   - 实现错误提示

5. **向后兼容**
   - 实现 `clarificationMessage` 解析逻辑
   - 测试向后兼容性

#### **后端实现步骤**（需要后端支持）

1. **数据结构定义**
   - 定义 `ClarificationQuestion` 接口
   - 更新 `RouteAndRunResponseDto` 接口

2. **Agent 生成逻辑**
   - PlannerAgent 生成结构化澄清问题
   - 支持不同类型的问题（text/single_choice/multi_choice/date/number）
   - 根据上下文生成合适的选项（options）

3. **测试**
   - 测试问题生成逻辑
   - 测试数据验证

---

**验收标准**：
- ✅ 定义了问题类型（5 种类型）
- ✅ 定义了数据结构（ClarificationQuestion、ClarificationAnswer）
- ✅ 定义了 API 接口扩展
- ✅ 设计了前端组件结构
- ✅ 定义了数据验证规则
- ✅ 说明了向后兼容策略
- ✅ 说明了多轮澄清流程
- ✅ 提供了典型问题示例

---
## 0.11 页面与交互设计（信息架构、组件、状态、文案）

### 0.11.1 信息架构

#### **页面层级**

```
创建行程页面 (/dashboard/trips/new)
  ├─ Tab 切换（表单模式 / 自然语言模式）
  └─ 自然语言模式（nl tab）
      ├─ 输入阶段
      │   ├─ 自然语言输入框
      │   └─ 状态指示器
      ├─ 澄清问题阶段（如果需要）
      │   └─ 澄清问题面板（ClarificationQuestionsPanel）
      └─ 预览阶段
          └─ 行程预览页面（TripPreviewPage）
              ├─ Gate 评估结果展示
              ├─ 行程概览
              ├─ 详细行程视图
              └─ 决策日志视图
```

### 0.11.2 创建行程页面（/dashboard/trips/new）

#### **页面结构**

**位置**：`src/pages/trips/new.tsx`

**现有结构**：
- Tabs 切换：`form`（表单模式）| `nl`（自然语言模式）
- 自然语言模式：自然语言输入框 + 澄清问题交互（当前实现）

**设计要点**：

1. **Tab 切换**
   - 保持现有 Tabs 结构
   - 默认显示 `nl` tab（自然语言模式）
   - `form` tab 作为"高级选项"（Expert Mode）

2. **自然语言输入区域**
   - **输入框**：大文本域（`Textarea`，`rows={6}`）
   - **占位符**："例如: 帮我规划带娃去东京5天的行程，预算2万"
   - **提示文本**："提示：请包含目的地、日期、预算、旅行者信息等"
   - **提交按钮**："开始规划" / "继续规划"（澄清问题回答后）

3. **状态反馈区域**（新增）
   - 在输入框下方显示状态指示器
   - 参考 `StatusIndicator` 组件（`src/components/agent/AgentChat.tsx`）
   - 显示当前处理状态和进度提示

#### **状态指示器设计**

**组件参考**：`src/components/agent/AgentChat.tsx` 第 66 行（`StatusIndicator` 组件）

**状态映射**（`OrchestrationStep` → `UIStatus`）：

| OrchestrationStep | UIStatus | 图标 | 文案 | 颜色 |
|------------------|----------|------|------|------|
| `INTAKE` | `thinking` | 蓝色脉冲圆点 | "AI 正在理解您的需求..." | `text-blue-600` |
| `RESEARCH` | `browsing` | 橙色旋转加载器 | "正在收集目的地信息..." | `text-orange-600` |
| `GATE_EVAL` | `verifying` | 黄色脉冲圆点 | "正在评估行程可行性..." | `text-yellow-600` |
| `PLAN_GEN` | `thinking` | 蓝色脉冲圆点 | "正在生成行程方案..." | `text-blue-600` |
| `VERIFY` | `verifying` | 黄色脉冲圆点 | "正在验证行程可执行性..." | `text-yellow-600` |
| `REPAIR` | `repairing` | 橙色旋转加载器 | "正在优化行程方案..." | `text-orange-600` |
| `NARRATE` | `thinking` | 蓝色脉冲圆点 | "正在生成最终方案..." | `text-blue-600` |
| `DONE` | `done` | 绿色确认图标 | "行程方案已生成！" | `text-green-600` |
| `FAILED` | `failed` | 红色错误图标 | "处理失败，请重试" | `text-red-600` |

**实现建议**：

```typescript
// 状态指示器组件（简化版）
function StatusIndicator({ status, step }: { status: UIStatus, step?: OrchestrationStep }) {
  const config = getStatusConfig(status);
  return (
    <div className="flex items-center gap-2 text-sm">
      {config.icon}
      <span className={config.color}>{config.text}</span>
    </div>
  );
}
```

**使用场景**：
- 用户提交自然语言请求后显示
- 在澄清问题回答后继续处理时显示
- 在行程生成过程中实时更新状态

### 0.11.3 澄清问题交互界面

#### **界面设计**

**组件位置**：`src/components/trips/ClarificationQuestionsPanel.tsx`（新建）

**设计要点**：

1. **整体布局**
   - 卡片式布局（`Card` 组件）
   - 黄色边框 + 浅黄色背景（`border-yellow-200 bg-yellow-50/30`）
   - 警告图标（`AlertCircle`）+ 标题："需要澄清的问题"

2. **问题列表**
   - 每个问题独立卡片（`ClarificationQuestionCard`）
   - 垂直排列（`space-y-4`）
   - 必填问题标记（红色星号 `*`）

3. **操作按钮**
   - 底部操作栏（`flex justify-end gap-3`）
   - "取消"按钮（`variant="outline"`）
   - "提交"按钮（`variant="default"`，禁用条件：必填问题未回答）

#### **ClarificationQuestionCard 组件**

**组件位置**：`src/components/trips/ClarificationQuestionCard.tsx`（新建）

**设计要点**（参考 0.10.5 节）：

1. **卡片结构**
   ```
   Card
     CardHeader
       CardTitle（问题文本 + 必填标记）
       CardDescription（hint 提示文本，如果有）
     CardContent
       输入组件（根据 type 渲染）
       错误提示（如果验证失败）
   ```

2. **输入组件映射**（参考 0.10.2 节）：
   - `text` → `Textarea`
   - `single_choice` → `RadioGroup`
   - `multi_choice` → `Checkbox` 组
   - `date` → `Input type="date"`
   - `number` → `Input type="number"`

3. **验证提示**
   - 实时验证（可选）：用户输入时显示错误
   - 提交验证（必需）：提交时检查所有必填问题

**参考现有实现**：
- `src/pages/trips/new.tsx` 第 1303-1355 行（当前简单文本澄清问题实现）
- `src/components/ui/card.tsx`（Card 组件）
- `src/components/ui/textarea.tsx`、`src/components/ui/input.tsx`（输入组件）

### 0.11.4 行程预览页面（TripPreviewPage）

#### **页面结构**

**位置**：`src/pages/trips/preview.tsx`（新建）或在 `new.tsx` 中作为预览状态

**设计要点**：

1. **页面布局**
   ```
   行程预览页面
     ├─ 顶部操作栏
     │   ├─ "接受方案" 按钮（主要操作）
     │   ├─ "调整方案" 按钮（次要操作）
     │   └─ "保存为草稿" 按钮（次要操作）
     ├─ Gate 评估结果区域（如果存在）
     │   └─ Gate 结论卡片 + 风险矩阵
     ├─ 行程概览区域
     │   ├─ 关键指标卡片（预算、天数、主要活动）
     │   └─ 10天行程表（表格/时间轴）
     ├─ 详细行程视图（可折叠）
     │   └─ 按天展开的行程项列表
     └─ 决策日志视图（可折叠）
         └─ 结构化决策日志展示
   ```

2. **顶部操作栏**
   - **"接受方案"按钮**（主要，`variant="default"`）
     - 点击后：调用 `tripsApi.create()` → 创建行程 → 跳转到 `/dashboard/trips/${tripId}`
   - **"调整方案"按钮**（次要，`variant="outline"`）
     - 点击后：返回输入阶段，允许用户修改需求
   - **"保存为草稿"按钮**（次要，`variant="ghost"`）
     - 点击后：创建 `status: 'DRAFT'` 的行程，不跳转

#### **Gate 评估结果展示**

**设计要点**：

1. **Gate 结论卡片**
   - 大标题显示结论（`ALLOW` / `ADJUST_REQUIRED` / `BLOCK`）
   - 状态图标 + 颜色编码：
     - `ALLOW`：绿色（`CheckCircle` 图标）
     - `ADJUST_REQUIRED`：黄色（`AlertTriangle` 图标）
     - `BLOCK`：红色（`XCircle` 图标）
   - 简要说明（1-2 句话）

2. **风险矩阵可视化**（如果 `ADJUST_REQUIRED` 或 `BLOCK`）
   - 使用卡片布局
   - 风险分类：
     - HARD 风险：红色边框 + 警告图标
     - SOFT 风险：黄色边框 + 信息图标
     - OK：绿色边框 + 确认图标
   - 每个风险项包含：
     - 风险类型
     - 风险描述
     - 调整建议（如果有）

3. **三人格视角展示**（可选）
   - 如果 Gate 评估结果包含三人格视角，显示三人格卡片
   - 参考 `PersonaCard` 组件（`src/components/planning-workbench/PersonaCard.tsx`）

**数据结构参考**：
- `RouteAndRunResponse.result.payload.orchestrationResult.gate_result`（参考 `src/api/agent.ts`）

#### **行程概览区域**

**设计要点**：

1. **关键指标卡片**
   - 总预算（¥）
   - 日均预算（¥）
   - 总天数
   - 主要活动类型（标签）

2. **10天行程表**
   - **表格形式**（推荐）：
     - 列：日期 | 主要活动 | 住宿 | 预算
     - 行：每天一行
   - **时间轴形式**（可选）：
     - 垂直时间轴
     - 每天一个卡片

**参考现有组件**：
- `src/components/trips/DayItineraryCard.tsx`（Day 行程卡片）
- `src/pages/trips/[id].tsx`（行程详情页，可参考布局）

#### **详细行程视图**

**设计要点**：

1. **按天展开**
   - 每天一个卡片（`Card` 组件）
   - 可折叠/展开（`Collapsible` 或自定义折叠）
   - 卡片标题：Day 1、Day 2... + 日期

2. **行程项列表**
   - 每个 `ItineraryItem` 显示：
     - 时间（`startTime` - `endTime`）
     - 地点（`Place.nameCN`）
     - 活动类型（`type`）
     - 备注（`note`）
     - 预算（如果有）
     - 风险提示（如果有）

**参考现有组件**：
- `src/components/trips/DayItineraryCard.tsx`（Day 行程卡片）
- `src/components/trips/views/AbuView.tsx`、`DrDreView.tsx`、`NeptuneView.tsx`（行程项展示）

### 0.11.5 三人格卡片展示（PersonaCard）

#### **组件参考**

**位置**：`src/components/planning-workbench/PersonaCard.tsx`

**设计要点**（参考现有实现）：

1. **卡片结构**
   ```
   Card (border-2)
     CardHeader (border-b)
       左侧：图标（emoji）+ 标题（Abu/Dr.Dre/Neptune）+ 口号（slogan）
       右侧：状态 Badge（ALLOW/ADJUST_REQUIRED/BLOCK）
     CardContent
       解释说明（explanation）
       证据列表（evidence，如果有）
       推荐建议（recommendations，如果有）
       Abu 特有的确认项（confirmations，如果有）
   ```

2. **状态展示**
   - 使用 `getGateStatusIcon`、`getGateStatusLabel`、`getGateStatusClasses`（参考 `src/lib/gate-status.ts`）
   - 状态颜色编码：
     - `ALLOW`：绿色
     - `ADJUST_REQUIRED`：黄色
     - `BLOCK`：红色

3. **使用场景**
   - **Gate 评估结果展示**（如果包含三人格视角）
   - **决策日志展示**（如果决策日志包含三人格输出）

**在行程预览页面中的使用**：
- 如果 `gate_result` 包含三人格输出，在 Gate 评估结果区域下方显示三人格卡片
- 如果 `decision_log` 包含三人格相关的决策，在决策日志视图中展示

### 0.11.6 决策日志展示

#### **数据结构**

**参考**：`DecisionLogEntry`（`src/api/agent.ts` 第 170 行）

**关键字段**：
- `step`：`OrchestrationStep`
- `persona`：`PersonaType`（`ABU` | `DR_DRE` | `NEPTUNE`）
- `action`：`Action`（`ALLOW` | `REJECT` | `ADJUST` | `REPLACE`）
- `explanation`：`string`
- `evidence_refs`：`string[]`
- `timestamp`：`string`

#### **展示设计**

**设计要点**：

1. **整体布局**
   - 可折叠/展开区域（`Collapsible` 组件）
   - 默认折叠（用户可展开查看）
   - 标题："决策日志" + 展开/折叠图标

2. **日志项展示**
   - 每个 `DecisionLogEntry` 一个卡片
   - 卡片结构：
     ```
     Card
       CardHeader
         左侧：Step Badge + Persona Badge + Action Badge
         右侧：时间戳
       CardContent
         解释说明（explanation）
         证据引用（evidence_refs，如果有）
     ```

3. **Badge 样式**
   - **Step Badge**：`variant="outline"`，显示 `OrchestrationStep`（如：`GATE_EVAL`）
   - **Persona Badge**：`variant="outline"`，显示 `PersonaType`（如：`ABU`），使用三人格颜色
   - **Action Badge**：
     - `ALLOW`：`variant="default"`（绿色）
     - `REJECT`：`variant="destructive"`（红色）
     - `ADJUST`：`variant="outline"`（黄色）
     - `REPLACE`：`variant="outline"`（橙色）

4. **时间线视图**（可选）
   - 垂直时间线
   - 每个日志项一个节点
   - 显示步骤流转

**参考现有实现**：
- `src/pages/trips/decision.tsx` 第 576-605 行（决策日志展示）
- `src/components/agent/AgentChat.tsx`（决策日志在消息中的展示）

### 0.11.7 响应式设计

#### **断点策略**

- **桌面端**（≥ 1024px）：
  - 行程预览页面：Gate 评估结果 + 行程概览并排显示（`grid-cols-2`）
  - 三人格卡片：横向排列（`grid-cols-3`）
  
- **平板端**（768px - 1023px）：
  - 行程预览页面：垂直堆叠
  - 三人格卡片：垂直堆叠或 2 列布局
  
- **移动端**（< 768px）：
  - 所有内容垂直堆叠
  - 卡片全宽显示
  - 操作按钮全宽（`w-full`）

#### **移动端优化**

1. **澄清问题面板**
   - 问题卡片全宽
   - 输入组件全宽
   - 操作按钮全宽堆叠

2. **行程预览页面**
   - 关键指标卡片：2 列网格（`grid-cols-2`）
   - 行程表：水平滚动（`overflow-x-auto`）
   - 详细行程视图：垂直堆叠

### 0.11.8 交互状态与反馈

#### **加载状态**

1. **请求发送后**
   - 输入框禁用（`disabled`）
   - 显示状态指示器
   - 提交按钮显示加载图标（`Spinner`）

2. **澄清问题回答提交**
   - 问题卡片禁用（`disabled`）
   - 提交按钮显示加载图标
   - 显示"正在处理..."提示

3. **行程生成中**
   - 状态指示器实时更新
   - 显示当前处理步骤

#### **错误状态**

1. **API 错误**
   - 显示错误提示（`Alert` 组件，`variant="destructive"`）
   - 提供重试按钮
   - 错误信息友好提示

2. **验证错误**（澄清问题）
   - 问题卡片显示错误提示（红色文本）
   - 提交按钮禁用（直到所有错误修复）

3. **超时错误**
   - 显示超时提示
   - 提供"重试"和"简化需求"选项

#### **成功状态**

1. **行程生成成功**
   - 显示成功提示（绿色 `Alert`）
   - 自动跳转到预览页面（或显示预览）

2. **行程创建成功**
   - 显示成功提示
   - 自动跳转到 `/dashboard/trips/${tripId}`

### 0.11.9 文案规范

#### **按钮文案**

- **提交按钮**：
  - 初始状态："开始规划"
  - 澄清问题回答后："继续规划"
  - 加载状态："正在处理..."
  
- **预览页面操作按钮**：
  - "接受方案"（主要操作）
  - "调整方案"（次要操作）
  - "保存为草稿"（次要操作）

#### **状态文案**

参考 0.11.2 节（状态指示器设计）中的状态文案。

#### **提示文案**

- **输入提示**："提示：请包含目的地、日期、预算、旅行者信息等"
- **澄清问题提示**："为了更好地创建您的行程，请回答以下问题："
- **Gate 评估提示**：
  - `ALLOW`："行程方案已通过可行性评估"
  - `ADJUST_REQUIRED`："行程方案需要调整，请查看调整建议"
  - `BLOCK`："行程方案存在风险，建议修改需求或查看替代方案"

### 0.11.10 可访问性（A11y）

#### **键盘导航**

- Tab 键顺序：输入框 → 问题输入 → 提交按钮 → 预览操作按钮
- Enter 键：提交表单（澄清问题）
- Esc 键：关闭错误提示、取消操作

#### **屏幕阅读器支持**

- 状态指示器：使用 `aria-live="polite"` 和 `aria-label`
- 澄清问题：使用 `Label` 组件关联输入
- 错误提示：使用 `aria-describedby` 关联错误信息
- 按钮：使用 `aria-label` 描述操作

#### **视觉反馈**

- 焦点状态：所有可交互元素显示焦点轮廓
- 悬停状态：按钮和卡片显示悬停效果
- 禁用状态：禁用元素显示灰色和禁用光标

---

**验收标准**：
- ✅ 清晰描述了创建行程页面的结构和设计要点
- ✅ 清晰描述了状态指示器的设计和状态映射
- ✅ 清晰描述了澄清问题交互界面的设计
- ✅ 清晰描述了行程预览页面的结构和各区域设计
- ✅ 清晰描述了 Gate 评估结果展示设计
- ✅ 清晰描述了三人格卡片展示（参考 PersonaCard）
- ✅ 清晰描述了决策日志展示设计
- ✅ 说明了响应式设计和移动端优化
- ✅ 说明了交互状态与反馈
- ✅ 说明了文案规范和可访问性要求

---
