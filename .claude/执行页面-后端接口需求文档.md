# æ‰§è¡Œé¡µé¢ - åç«¯æ¥å£éœ€æ±‚æ–‡æ¡£

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¥æœŸ**: 2026-02-05  
**é¡µé¢è·¯å¾„**: `/dashboard/execute`  
**å‰ç«¯æ–‡ä»¶**: `src/pages/execute/index.tsx`

---

## ğŸ“‹ ä¸€ã€æ¥å£æ¦‚è§ˆ

æ‰§è¡Œé¡µé¢éœ€è¦ä»¥ä¸‹åç«¯æ¥å£æ”¯æŒï¼š

| ä¼˜å…ˆçº§ | æ¥å£åç§° | æ–¹æ³• | è·¯å¾„ | çŠ¶æ€ |
|--------|---------|------|------|------|
| **P0** | è·å–è¡Œç¨‹è¯¦æƒ… | GET | `/trips/:id` | âœ… å·²å¯¹æ¥ |
| **P0** | è·å–è¡Œç¨‹çŠ¶æ€ | GET | `/trips/:id/state` | âœ… å·²å¯¹æ¥ |
| **P0** | è·å–ä»Šæ—¥æ—¶é—´çº¿ | GET | `/trips/:id/schedule` | âœ… å·²å¯¹æ¥ |
| **P0** | è·å–æé†’åˆ—è¡¨ | POST | `/execution/execute` | âœ… å·²å¯¹æ¥ |
| **P0** | å¤„ç†å˜æ›´ï¼ˆå»¶è¿Ÿ/è·³è¿‡ï¼‰ | POST | `/execution/execute` | âœ… å·²å¯¹æ¥ |
| **P0** | è§¦å‘ä¿®å¤ï¼ˆæ›¿æ¢ï¼‰ | POST | `/execution/execute` | âœ… å·²å¯¹æ¥ |
| **P1** | é‡æ–°æ’åºè¡Œç¨‹ | POST | `/execution/execute` | âŒ **éœ€è¦æ–°å¢** |
| **P1** | è·å–å…³é”®è¯æ® | GET | `/places/:placeId/evidence` | âŒ **éœ€è¦æ–°å¢** |
| **P2** | è·å–ä¿®å¤æ–¹æ¡ˆè¯¦æƒ… | POST | `/execution/execute` | âš ï¸ **éœ€è¦å¢å¼º** |
| **P2** | åº”ç”¨ä¿®å¤æ–¹æ¡ˆ | POST | `/execution/apply-fallback` | âŒ **éœ€è¦æ–°å¢** |

---

## âœ… äºŒã€å·²å¯¹æ¥æ¥å£ï¼ˆéœ€è¦ç¡®è®¤ï¼‰

### 2.1 è·å–è¡Œç¨‹è¯¦æƒ…

**æ¥å£**: `GET /trips/:id`

**è¯·æ±‚å‚æ•°**:
```typescript
{
  id: string;  // è¡Œç¨‹IDï¼ˆè·¯å¾„å‚æ•°ï¼‰
}
```

**å“åº”æ ¼å¼**:
```typescript
{
  success: true,
  data: {
    id: string;
    destination: string;
    TripDay: Array<{
      id: string;
      date: string;
      ItineraryItem: Array<{
        id: string;
        Place: {
          id: number;
          nameEN: string;
          nameCN?: string;
          latitude: number;
          longitude: number;
          // ... å…¶ä»–Placeå­—æ®µ
        };
        startTime: string;
        endTime: string;
        // ... å…¶ä»–å­—æ®µ
      }>;
    }>;
    // ... å…¶ä»–è¡Œç¨‹å­—æ®µ
  }
}
```

**å‰ç«¯ä½¿ç”¨ä½ç½®**: `src/pages/execute/index.tsx` ç¬¬180è¡Œ

---

### 2.2 è·å–è¡Œç¨‹çŠ¶æ€

**æ¥å£**: `GET /trips/:id/state`

**è¯·æ±‚å‚æ•°**:
```typescript
{
  id: string;        // è¡Œç¨‹IDï¼ˆè·¯å¾„å‚æ•°ï¼‰
  now?: string;      // å¯é€‰ï¼šæŒ‡å®šå½“å‰æ—¶é—´ï¼ˆISOæ ¼å¼ï¼‰ï¼Œç”¨äºæµ‹è¯•
}
```

**å“åº”æ ¼å¼**:
```typescript
{
  success: true,
  data: {
    currentDayId: string | null;      // å½“å‰æ—¥æœŸID
    currentItemId: string | null;     // å½“å‰è¡Œç¨‹é¡¹ID
    nextStop: {                       // ä¸‹ä¸€æ­¥ç›®çš„åœ°ï¼ˆæ ¸å¿ƒå­—æ®µï¼‰
      itemId: string;                 // è¡Œç¨‹é¡¹ID
      placeId: number;                // åœ°ç‚¹ID
      placeName: string;              // åœ°ç‚¹åç§°
      startTime: string;              // å¼€å§‹æ—¶é—´ï¼ˆISOæ ¼å¼ï¼‰
      estimatedArrivalTime?: string;  // é¢„è®¡åˆ°è¾¾æ—¶é—´ï¼ˆISOæ ¼å¼ï¼‰
      Place?: {                       // åœ°ç‚¹è¯¦ç»†ä¿¡æ¯ï¼ˆå¯é€‰ï¼Œå»ºè®®åŒ…å«ï¼‰
        id: number;
        nameEN: string;
        nameCN?: string;
        latitude: number;
        longitude: number;
        businessHours?: {             // âš ï¸ å»ºè®®æ·»åŠ ï¼šè¥ä¸šæ—¶é—´
          open: string;                // "09:00"
          close: string;               // "18:00"
          timezone?: string;
        };
        address?: string;
        // ... å…¶ä»–Placeå­—æ®µ
      };
    } | null;
    eta?: string;                     // é¢„è®¡åˆ°è¾¾æ—¶é—´
    timezone: string;                 // æ—¶åŒº
    now: string;                      // å½“å‰æ—¶é—´ï¼ˆISOæ ¼å¼ï¼‰
  }
}
```

**å‰ç«¯ä½¿ç”¨ä½ç½®**: `src/pages/execute/index.tsx` ç¬¬182è¡Œã€ç¬¬207è¡Œ

**é‡è¦è¯´æ˜**:
- âš ï¸ `nextStop.Place` å­—æ®µå»ºè®®åŒ…å«å®Œæ•´çš„åœ°ç‚¹ä¿¡æ¯ï¼ˆç‰¹åˆ«æ˜¯åæ ‡ã€è¥ä¸šæ—¶é—´ï¼‰
- âš ï¸ `estimatedArrivalTime` å­—æ®µç”¨äºæ˜¾ç¤º"é¢„è®¡åˆ°è¾¾æ—¶é—´"

---

### 2.3 è·å–ä»Šæ—¥æ—¶é—´çº¿

**æ¥å£**: `GET /trips/:id/schedule`

**è¯·æ±‚å‚æ•°**:
```typescript
{
  id: string;        // è¡Œç¨‹IDï¼ˆè·¯å¾„å‚æ•°ï¼‰
  date: string;      // æ—¥æœŸï¼ˆYYYY-MM-DDæ ¼å¼ï¼‰
}
```

**å“åº”æ ¼å¼**:
```typescript
{
  success: true,
  data: {
    date: string;                    // æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰
    schedule: {
      items: Array<{
        placeId: number;            // åœ°ç‚¹ID
        placeName: string;          // åœ°ç‚¹åç§°
        startTime: string;          // å¼€å§‹æ—¶é—´ï¼ˆHH:mm æˆ– ISOæ ¼å¼ï¼‰
        endTime: string;            // ç»“æŸæ—¶é—´ï¼ˆHH:mm æˆ– ISOæ ¼å¼ï¼‰
        status?: 'upcoming' | 'in_progress' | 'completed' | 'cancelled';
        // ... å…¶ä»–å­—æ®µ
      }>;
    };
  }
}
```

**å‰ç«¯ä½¿ç”¨ä½ç½®**: `src/pages/execute/index.tsx` ç¬¬191è¡Œ

---

### 2.4 è·å–æé†’åˆ—è¡¨

**æ¥å£**: `POST /execution/execute`

**è¯·æ±‚æ ¼å¼**:
```typescript
{
  tripId: string;
  action: 'remind';
  remindParams: {
    reminderTypes?: string[];      // æé†’ç±»å‹åˆ—è¡¨ï¼Œå¦‚ï¼š['departure', 'transport', 'weather', 'check_in', 'check_out']
    advanceHours?: number;          // æå‰æ—¶é—´ï¼ˆå°æ—¶ï¼Œé»˜è®¤24ï¼‰
  };
}
```

**å“åº”æ ¼å¼**:
```typescript
{
  success: true,
  data: {
    executionState: {
      tripId: string;
      phase: 'ON_TRIP' | 'CHANGE_HANDLING' | 'FALLBACK';
      currentDay: number;
      currentDate: string;
      reminders: Array<{
        id: string;
        type: string;               // æé†’ç±»å‹
        title: string;               // æé†’æ ‡é¢˜
        message: string;             // æé†’å†…å®¹
        triggerTime: string;        // è§¦å‘æ—¶é—´ï¼ˆISOæ ¼å¼ï¼‰
        priority: 'low' | 'medium' | 'high' | 'urgent';
      }>;
      pendingChanges: any[];
      activeFallbacks: any[];
      lastUpdated: string;
    };
    uiOutput: {
      reminders?: Array<Reminder>;  // æé†’åˆ—è¡¨ï¼ˆä¸executionState.remindersç›¸åŒï¼‰
      // ... å…¶ä»–å­—æ®µ
    };
  }
}
```

**å‰ç«¯ä½¿ç”¨ä½ç½®**: `src/pages/execute/index.tsx` ç¬¬217è¡Œ

---

### 2.5 å¤„ç†å˜æ›´ï¼ˆå»¶è¿Ÿ/è·³è¿‡ï¼‰

**æ¥å£**: `POST /execution/execute`

**è¯·æ±‚æ ¼å¼**:
```typescript
// å»¶è¿Ÿæ“ä½œ
{
  tripId: string;
  action: 'handle_change';
  changeParams: {
    changeType: 'schedule_change';
    changeDetails: {
      reason: string;               // å˜æ›´åŸå› ï¼Œå¦‚ï¼š"ç”¨æˆ·è¯·æ±‚å»¶è¿Ÿ15åˆ†é’Ÿ"
      delayMinutes?: number;       // âš ï¸ å»ºè®®æ·»åŠ ï¼šå»¶è¿Ÿåˆ†é’Ÿæ•°
      itemId?: string;             // å¯é€‰ï¼šæŒ‡å®šè¡Œç¨‹é¡¹ID
    };
  };
}

// è·³è¿‡æ“ä½œ
{
  tripId: string;
  action: 'handle_change';
  changeParams: {
    changeType: 'activity_cancelled';
    changeDetails: {
      reason: string;               // å˜æ›´åŸå› ï¼Œå¦‚ï¼š"ç”¨æˆ·è¯·æ±‚è·³è¿‡å½“å‰æ´»åŠ¨"
      itemId?: string;             // å¯é€‰ï¼šæŒ‡å®šè¡Œç¨‹é¡¹ID
    };
  };
}
```

**å“åº”æ ¼å¼**:
```typescript
{
  success: true,
  data: {
    executionState: {
      // ... æ›´æ–°åçš„æ‰§è¡ŒçŠ¶æ€
      phase: 'CHANGE_HANDLING';    // å˜æ›´å¤„ç†ä¸­
      pendingChanges: Array<{
        id: string;
        changeType: string;
        changeDetails: any;
        status: 'pending' | 'applied' | 'rejected';
      }>;
    };
    uiOutput: {
      changeResult?: {
        success: boolean;
        message?: string;
        updatedSchedule?: any;      // âš ï¸ å»ºè®®æ·»åŠ ï¼šæ›´æ–°åçš„æ—¶é—´çº¿
      };
      // ... å…¶ä»–å­—æ®µ
    };
  }
}
```

**å‰ç«¯ä½¿ç”¨ä½ç½®**: `src/pages/execute/index.tsx` ç¬¬239è¡Œï¼ˆå»¶è¿Ÿï¼‰ã€ç¬¬255è¡Œï¼ˆè·³è¿‡ï¼‰

**é‡è¦è¯´æ˜**:
- âš ï¸ å»ºè®®åœ¨ `changeDetails` ä¸­æ·»åŠ  `delayMinutes` å­—æ®µï¼Œæ˜ç¡®å»¶è¿Ÿæ—¶é•¿
- âš ï¸ å»ºè®®åœ¨å“åº”ä¸­è¿”å›æ›´æ–°åçš„æ—¶é—´çº¿ï¼Œä¾¿äºå‰ç«¯ç«‹å³æ›´æ–°UI

---

### 2.6 è§¦å‘ä¿®å¤ï¼ˆæ›¿æ¢ï¼‰

**æ¥å£**: `POST /execution/execute`

**è¯·æ±‚æ ¼å¼**:
```typescript
{
  tripId: string;
  action: 'fallback';
  fallbackParams: {
    triggerReason: string;          // è§¦å‘åŸå› ï¼Œå¦‚ï¼š"ç”¨æˆ·è¯·æ±‚æ›¿æ¢å½“å‰æ´»åŠ¨"
    originalPlan: any;              // åŸè®¡åˆ’ï¼ˆå¯é€‰ï¼‰
    itemId?: string;                // âš ï¸ å»ºè®®æ·»åŠ ï¼šæŒ‡å®šè¦æ›¿æ¢çš„è¡Œç¨‹é¡¹ID
  };
}
```

**å“åº”æ ¼å¼**:
```typescript
{
  success: true,
  data: {
    executionState: {
      phase: 'FALLBACK';            // ä¿®å¤é˜¶æ®µ
      activeFallbacks: Array<{
        id: string;
        triggerReason: string;
        status: 'pending' | 'applied' | 'rejected';
      }>;
    };
    uiOutput: {
      fallbackPlan?: {
        id: string;
        solutions: Array<{          // âš ï¸ å»ºè®®å¢å¼ºï¼šä¿®å¤æ–¹æ¡ˆåˆ—è¡¨
          id: string;
          type: 'minimal' | 'experience' | 'safety';  // æ–¹æ¡ˆç±»å‹
          title: string;             // æ–¹æ¡ˆæ ‡é¢˜ï¼Œå¦‚ï¼š"æœ€å°æ”¹åŠ¨"
          description: string;       // æ–¹æ¡ˆæè¿°
          changes: Array<{           // å˜æ›´è¯¦æƒ…
            itemId: string;
            action: 'modify' | 'remove' | 'add';
            newTime?: string;
            newPlace?: any;
          }>;
          impact: {                  // å½±å“è¯„ä¼°
            arrivalTime: string;     // åˆ°è¾¾æ—¶é—´ï¼Œå¦‚ï¼š"10:15 (+15åˆ†é’Ÿ)"
            missingPlaces: number;   // ç¼ºå¤±åœ°ç‚¹æ•°
            riskChange: 'low' | 'medium' | 'high';  // é£é™©å˜åŒ–
          };
          recommended?: boolean;     // æ˜¯å¦æ¨è
        }>;
      };
      // ... å…¶ä»–å­—æ®µ
    };
  }
}
```

**å‰ç«¯ä½¿ç”¨ä½ç½®**: `src/pages/execute/index.tsx` ç¬¬269è¡Œ

**é‡è¦è¯´æ˜**:
- âš ï¸ **å½“å‰é—®é¢˜**ï¼šå‰ç«¯ç¡¬ç¼–ç äº†3ä¸ªä¿®å¤æ–¹æ¡ˆï¼Œéœ€è¦åç«¯è¿”å›å®é™…çš„ä¿®å¤æ–¹æ¡ˆæ•°æ®
- âš ï¸ å»ºè®®åœ¨ `fallbackParams` ä¸­æ·»åŠ  `itemId` å­—æ®µï¼Œæ˜ç¡®è¦æ›¿æ¢çš„è¡Œç¨‹é¡¹
- âš ï¸ å»ºè®®è¿”å›å¤šä¸ªä¿®å¤æ–¹æ¡ˆï¼ˆè‡³å°‘3ä¸ªï¼‰ï¼ŒåŒ…å«æ–¹æ¡ˆç±»å‹ã€å˜æ›´è¯¦æƒ…ã€å½±å“è¯„ä¼°

---

## âŒ ä¸‰ã€éœ€è¦æ–°å¢çš„æ¥å£

### 3.1 é‡æ–°æ’åºè¡Œç¨‹ï¼ˆP1ï¼‰

**æ¥å£**: `POST /execution/reorder`

**åŠŸèƒ½è¯´æ˜**: é‡æ–°æ’åºæŒ‡å®šæ—¥æœŸçš„è¡Œç¨‹é¡¹é¡ºåº

**è¯·æ±‚æ ¼å¼**:
```typescript
{
  tripId: string;
  dayId: string;                    // æ—¥æœŸIDï¼ˆé€šå¸¸æ˜¯currentDayIdï¼‰
  newOrder: string[];               // é‡æ–°æ’åºåçš„è¡Œç¨‹é¡¹IDæ•°ç»„
  reason?: string;                  // å¯é€‰ï¼šé‡æ–°æ’åºåŸå› 
}
```

**å“åº”æ ¼å¼**:
```typescript
{
  success: true,
  data: {
    success: boolean;
    message?: string;
    updatedSchedule: {               // æ›´æ–°åçš„æ—¶é—´çº¿
      date: string;
      schedule: {
        items: Array<{
          placeId: number;
          placeName: string;
          startTime: string;
          endTime: string;
          // ... å…¶ä»–å­—æ®µ
        }>;
      };
    };
    impact?: {                       // å½±å“è¯„ä¼°
      timeAdjustments: Array<{
        itemId: string;
        originalTime: string;
        newTime: string;
      }>;
      conflicts?: Array<{             // å†²çªæ£€æµ‹
        type: string;
        message: string;
      }>;
    };
  }
}
```

**å‰ç«¯éœ€æ±‚**:
- ä½ç½®ï¼š`src/pages/execute/index.tsx` ç¬¬633è¡Œ
- å½“å‰çŠ¶æ€ï¼šæŒ‰é’®å­˜åœ¨ä½†æœªå®ç°
- ä¼˜å…ˆçº§ï¼šP1ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

**æ›¿ä»£æ–¹æ¡ˆ**:
å¦‚æœä¸æƒ³æ–°å¢æ¥å£ï¼Œå¯ä»¥åœ¨ç°æœ‰çš„ `POST /execution/execute` ä¸­æ·»åŠ  `action: 'reorder'`ï¼š
```typescript
{
  tripId: string;
  action: 'reorder';
  reorderParams: {
    dayId: string;
    newOrder: string[];
    reason?: string;
  };
}
```

---

### 3.2 è·å–å…³é”®è¯æ®ï¼ˆP1ï¼‰

**æ¥å£**: `GET /places/:placeId/evidence`

**åŠŸèƒ½è¯´æ˜**: è·å–åœ°ç‚¹çš„å…³é”®è¯æ®ä¿¡æ¯ï¼ˆè¥ä¸šæ—¶é—´ã€å°è·¯ä¿¡æ¯ã€å¤©æ°”çª—å£ç­‰ï¼‰

**è¯·æ±‚å‚æ•°**:
```typescript
{
  placeId: number;                  // åœ°ç‚¹IDï¼ˆè·¯å¾„å‚æ•°ï¼‰
  date?: string;                    // å¯é€‰ï¼šæŒ‡å®šæ—¥æœŸï¼ˆYYYY-MM-DDï¼‰ï¼Œç”¨äºè·å–ç‰¹å®šæ—¥æœŸçš„ä¿¡æ¯
  includeWeather?: boolean;         // å¯é€‰ï¼šæ˜¯å¦åŒ…å«å¤©æ°”ä¿¡æ¯ï¼ˆé»˜è®¤trueï¼‰
  includeTraffic?: boolean;         // å¯é€‰ï¼šæ˜¯å¦åŒ…å«äº¤é€šä¿¡æ¯ï¼ˆé»˜è®¤trueï¼‰
}
```

**å“åº”æ ¼å¼**:
```typescript
{
  success: true,
  data: {
    placeId: number;
    placeName: string;
    evidence: {
      businessHours: {              // è¥ä¸šæ—¶é—´
        open: string;                // "09:00"
        close: string;               // "18:00"
        timezone: string;            // "Asia/Tokyo"
        exceptions?: Array<{         // ä¾‹å¤–æƒ…å†µï¼ˆèŠ‚å‡æ—¥ç­‰ï¼‰
          date: string;              // "2026-02-10"
          open?: string;
          close?: string;
          closed?: boolean;           // æ˜¯å¦å…³é—­
          note?: string;
        }>;
      };
      roadClosure: {                // å°è·¯ä¿¡æ¯
        hasClosure: boolean;
        closures?: Array<{
          date: string;
          reason: string;             // å°è·¯åŸå› 
          affectedRoutes?: string[];  // å—å½±å“è·¯çº¿
          alternativeRoutes?: string[]; // æ›¿ä»£è·¯çº¿
        }>;
      };
      weatherWindow: {               // å¤©æ°”çª—å£
        date: string;
        condition: string;            // "æ™´æœ—"ã€"å¤šäº‘"ã€"é›¨å¤©"ç­‰
        description: string;          // "æ™´æœ—ï¼Œé€‚åˆæˆ·å¤–æ´»åŠ¨"
        temperature: {
          min: number;
          max: number;
          unit: 'celsius' | 'fahrenheit';
        };
        precipitation?: {
          probability: number;        // 0-100
          amount?: number;            // mm
        };
        wind?: {
          speed: number;              // km/h
          direction: string;          // "N"ã€"NE"ç­‰
        };
        suitableForOutdoor?: boolean; // æ˜¯å¦é€‚åˆæˆ·å¤–æ´»åŠ¨
      };
      otherInfo?: {                  // å…¶ä»–ä¿¡æ¯
        crowdLevel?: 'low' | 'medium' | 'high';
        specialEvents?: Array<{
          date: string;
          name: string;
          impact?: string;
        }>;
      };
    };
  }
}
```

**å‰ç«¯éœ€æ±‚**:
- ä½ç½®ï¼š`src/pages/execute/index.tsx` ç¬¬464-479è¡Œ
- å½“å‰çŠ¶æ€ï¼šç¡¬ç¼–ç æ•°æ®
- ä¼˜å…ˆçº§ï¼šP1ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

**æ›¿ä»£æ–¹æ¡ˆ**:
å¦‚æœåœ°ç‚¹æ•°æ®å·²åŒ…å«è¿™äº›ä¿¡æ¯ï¼Œå¯ä»¥åœ¨ `GET /trips/:id/state` çš„ `nextStop.Place` ä¸­è¿”å›ï¼š
```typescript
nextStop: {
  Place: {
    businessHours: { ... };
    roadClosure: { ... };
    weatherWindow: { ... };
  };
}
```

---

### 3.3 åº”ç”¨ä¿®å¤æ–¹æ¡ˆï¼ˆP2ï¼‰

**æ¥å£**: `POST /execution/apply-fallback`

**åŠŸèƒ½è¯´æ˜**: åº”ç”¨Neptuneæä¾›çš„ä¿®å¤æ–¹æ¡ˆ

**è¯·æ±‚æ ¼å¼**:
```typescript
{
  tripId: string;
  solutionId: string;               // ä¿®å¤æ–¹æ¡ˆIDï¼ˆä»fallbackå“åº”ä¸­è·å–ï¼‰
  confirm?: boolean;                 // æ˜¯å¦ç¡®è®¤åº”ç”¨ï¼ˆé»˜è®¤trueï¼‰
}
```

**å“åº”æ ¼å¼**:
```typescript
{
  success: true,
  data: {
    success: boolean;
    message?: string;
    appliedChanges: Array<{
      itemId: string;
      action: 'modified' | 'removed' | 'added';
      details: any;
    }>;
    updatedSchedule: {               // æ›´æ–°åçš„æ—¶é—´çº¿
      date: string;
      schedule: {
        items: Array<{
          placeId: number;
          placeName: string;
          startTime: string;
          endTime: string;
          // ... å…¶ä»–å­—æ®µ
        }>;
      };
    };
    impact: {
      arrivalTime: string;
      missingPlaces: number;
      riskChange: 'low' | 'medium' | 'high';
    };
  }
}
```

**å‰ç«¯éœ€æ±‚**:
- ä½ç½®ï¼š`src/pages/execute/index.tsx` ç¬¬733è¡Œ
- å½“å‰çŠ¶æ€ï¼šTODOæ³¨é‡Šï¼Œæœªå®ç°
- ä¼˜å…ˆçº§ï¼šP2ï¼ˆä½ä¼˜å…ˆçº§ï¼‰

**æ›¿ä»£æ–¹æ¡ˆ**:
å¦‚æœä¸æƒ³æ–°å¢æ¥å£ï¼Œå¯ä»¥åœ¨ç°æœ‰çš„ `POST /execution/execute` ä¸­æ·»åŠ  `action: 'apply_fallback'`ï¼š
```typescript
{
  tripId: string;
  action: 'apply_fallback';
  applyFallbackParams: {
    solutionId: string;
    confirm?: boolean;
  };
}
```

---

### 3.4 é¢„è§ˆä¿®å¤æ–¹æ¡ˆï¼ˆP2ï¼‰

**æ¥å£**: `GET /execution/fallback/:solutionId/preview`

**åŠŸèƒ½è¯´æ˜**: é¢„è§ˆä¿®å¤æ–¹æ¡ˆçš„è¯¦ç»†å˜æ›´å†…å®¹

**è¯·æ±‚å‚æ•°**:
```typescript
{
  solutionId: string;               // ä¿®å¤æ–¹æ¡ˆIDï¼ˆè·¯å¾„å‚æ•°ï¼‰
}
```

**å“åº”æ ¼å¼**:
```typescript
{
  success: true,
  data: {
    solutionId: string;
    type: 'minimal' | 'experience' | 'safety';
    title: string;
    description: string;
    changes: Array<{
      itemId: string;
      action: 'modify' | 'remove' | 'add';
      original?: {
        placeName: string;
        startTime: string;
        endTime: string;
      };
      modified?: {
        placeName: string;
        startTime: string;
        endTime: string;
      };
      reason?: string;
    }>;
    impact: {
      arrivalTime: string;
      missingPlaces: number;
      riskChange: 'low' | 'medium' | 'high';
      costChange?: number;           // æˆæœ¬å˜åŒ–ï¼ˆå¯é€‰ï¼‰
    };
    timeline: {                      // é¢„è§ˆæ—¶é—´çº¿
      date: string;
      schedule: {
        items: Array<{
          placeId: number;
          placeName: string;
          startTime: string;
          endTime: string;
          status: 'unchanged' | 'modified' | 'new' | 'removed';
        }>;
      };
    };
  }
}
```

**å‰ç«¯éœ€æ±‚**:
- ä½ç½®ï¼š`src/pages/execute/index.tsx` ç¬¬687è¡Œã€705è¡Œã€723è¡Œ
- å½“å‰çŠ¶æ€ï¼šæŒ‰é’®å­˜åœ¨ä½†æœªå®ç°
- ä¼˜å…ˆçº§ï¼šP2ï¼ˆä½ä¼˜å…ˆçº§ï¼‰

---

## ğŸ“Š å››ã€æ¥å£ä¼˜å…ˆçº§æ€»ç»“

### P0ï¼ˆå¿…é¡»å®ç°ï¼‰- å·²å¯¹æ¥ âœ…

1. âœ… `GET /trips/:id` - è·å–è¡Œç¨‹è¯¦æƒ…
2. âœ… `GET /trips/:id/state` - è·å–è¡Œç¨‹çŠ¶æ€ï¼ˆéœ€è¦å¢å¼ºï¼šåŒ…å«Placeå®Œæ•´ä¿¡æ¯ï¼‰
3. âœ… `GET /trips/:id/schedule` - è·å–ä»Šæ—¥æ—¶é—´çº¿
4. âœ… `POST /execution/execute` - è·å–æé†’åˆ—è¡¨
5. âœ… `POST /execution/execute` - å¤„ç†å˜æ›´ï¼ˆå»¶è¿Ÿ/è·³è¿‡ï¼‰
6. âœ… `POST /execution/execute` - è§¦å‘ä¿®å¤ï¼ˆéœ€è¦å¢å¼ºï¼šè¿”å›ä¿®å¤æ–¹æ¡ˆæ•°æ®ï¼‰

### P1ï¼ˆå»ºè®®å®ç°ï¼‰- éœ€è¦æ–°å¢ âš ï¸

7. âš ï¸ `POST /execution/reorder` - é‡æ–°æ’åºè¡Œç¨‹ï¼ˆæˆ–æ‰©å±•ç°æœ‰æ¥å£ï¼‰
8. âš ï¸ `GET /places/:placeId/evidence` - è·å–å…³é”®è¯æ®ï¼ˆæˆ–å¢å¼ºstateæ¥å£ï¼‰

### P2ï¼ˆå¯é€‰å®ç°ï¼‰- éœ€è¦æ–°å¢ âŒ

9. âŒ `POST /execution/apply-fallback` - åº”ç”¨ä¿®å¤æ–¹æ¡ˆï¼ˆæˆ–æ‰©å±•ç°æœ‰æ¥å£ï¼‰
10. âŒ `GET /execution/fallback/:solutionId/preview` - é¢„è§ˆä¿®å¤æ–¹æ¡ˆ

---

## ğŸ”§ äº”ã€æ¥å£å¢å¼ºå»ºè®®

### 5.1 å¢å¼º `GET /trips/:id/state` æ¥å£

**å½“å‰é—®é¢˜**: `nextStop.Place` å­—æ®µå¯èƒ½ä¸å®Œæ•´ï¼Œç¼ºå°‘è¥ä¸šæ—¶é—´ã€åæ ‡ç­‰ä¿¡æ¯

**å»ºè®®å¢å¼º**:
```typescript
nextStop: {
  itemId: string;
  placeId: number;
  placeName: string;
  startTime: string;
  estimatedArrivalTime?: string;
  Place: {                           // âš ï¸ å»ºè®®åŒ…å«å®Œæ•´ä¿¡æ¯
    id: number;
    nameEN: string;
    nameCN?: string;
    latitude: number;                // âš ï¸ å¿…é¡»ï¼šç”¨äºå¯¼èˆª
    longitude: number;               // âš ï¸ å¿…é¡»ï¼šç”¨äºå¯¼èˆª
    address?: string;
    businessHours?: {                // âš ï¸ å»ºè®®æ·»åŠ 
      open: string;
      close: string;
      timezone?: string;
    };
    // ... å…¶ä»–Placeå­—æ®µ
  };
}
```

### 5.2 å¢å¼º `POST /execution/execute` æ¥å£ï¼ˆfallbackå“åº”ï¼‰

**å½“å‰é—®é¢˜**: `fallbackPlan` å­—æ®µå¯èƒ½ä¸å®Œæ•´ï¼Œå‰ç«¯ç¡¬ç¼–ç äº†ä¿®å¤æ–¹æ¡ˆ

**å»ºè®®å¢å¼º**:
```typescript
uiOutput: {
  fallbackPlan: {
    id: string;
    solutions: Array<{               // âš ï¸ å¿…é¡»ï¼šè¿”å›å¤šä¸ªä¿®å¤æ–¹æ¡ˆ
      id: string;
      type: 'minimal' | 'experience' | 'safety';
      title: string;
      description: string;
      changes: Array<{ ... }>;
      impact: {
        arrivalTime: string;
        missingPlaces: number;
        riskChange: 'low' | 'medium' | 'high';
      };
      recommended?: boolean;
    }>;
  };
}
```

### 5.3 å¢å¼º `POST /execution/execute` æ¥å£ï¼ˆchangeå“åº”ï¼‰

**å½“å‰é—®é¢˜**: å˜æ›´åæ²¡æœ‰è¿”å›æ›´æ–°åçš„æ—¶é—´çº¿

**å»ºè®®å¢å¼º**:
```typescript
uiOutput: {
  changeResult: {
    success: boolean;
    message?: string;
    updatedSchedule?: {              // âš ï¸ å»ºè®®æ·»åŠ ï¼šæ›´æ–°åçš„æ—¶é—´çº¿
      date: string;
      schedule: {
        items: Array<{ ... }>;
      };
    };
  };
}
```

---

## ğŸ“ å…­ã€æ¥å£è§„èŒƒè¦æ±‚

### 6.1 ç»Ÿä¸€å“åº”æ ¼å¼

æ‰€æœ‰æ¥å£åº”éµå¾ªç»Ÿä¸€çš„å“åº”æ ¼å¼ï¼š

**æˆåŠŸå“åº”**:
```typescript
{
  success: true,
  data: T,                          // å…·ä½“æ•°æ®ç±»å‹
  message?: string;                 // å¯é€‰ï¼šæˆåŠŸæ¶ˆæ¯
}
```

**é”™è¯¯å“åº”**:
```typescript
{
  success: false,
  error: {
    code: string;                   // é”™è¯¯ä»£ç ï¼Œå¦‚ï¼š"INVALID_PARAMETER"
    message: string;                // é”™è¯¯æ¶ˆæ¯ï¼ˆç”¨æˆ·å‹å¥½ï¼‰
    details?: any;                  // å¯é€‰ï¼šé”™è¯¯è¯¦æƒ…ï¼ˆç”¨äºè°ƒè¯•ï¼‰
  }
}
```

### 6.2 æ—¶é—´æ ¼å¼

- **ISO 8601æ ¼å¼**: ç”¨äºå®Œæ•´æ—¶é—´æˆ³ï¼Œå¦‚ï¼š`"2026-02-05T21:29:00Z"`
- **HH:mmæ ¼å¼**: ç”¨äºæ—¶é—´æ˜¾ç¤ºï¼Œå¦‚ï¼š`"21:29"`
- **YYYY-MM-DDæ ¼å¼**: ç”¨äºæ—¥æœŸï¼Œå¦‚ï¼š`"2026-02-05"`

### 6.3 æ—¶åŒºå¤„ç†

- æ‰€æœ‰æ—¶é—´å­—æ®µåº”åŒ…å«æ—¶åŒºä¿¡æ¯
- å»ºè®®ä½¿ç”¨ISO 8601æ ¼å¼ï¼Œè‡ªåŠ¨åŒ…å«æ—¶åŒº
- æˆ–è€…åœ¨å“åº”ä¸­åŒ…å« `timezone` å­—æ®µ

### 6.4 é”™è¯¯å¤„ç†

- æ‰€æœ‰æ¥å£åº”è¿”å›æ˜ç¡®çš„é”™è¯¯ä»£ç å’Œæ¶ˆæ¯
- å»ºè®®ä½¿ç”¨HTTPçŠ¶æ€ç ï¼š
  - `200`: æˆåŠŸ
  - `400`: è¯·æ±‚å‚æ•°é”™è¯¯
  - `401`: æœªæˆæƒ
  - `404`: èµ„æºä¸å­˜åœ¨
  - `500`: æœåŠ¡å™¨é”™è¯¯

---

## ğŸ¯ ä¸ƒã€å®æ–½å»ºè®®

### 7.1 ç¬¬ä¸€é˜¶æ®µï¼ˆP0å¢å¼ºï¼‰

1. **å¢å¼º `GET /trips/:id/state`**:
   - ç¡®ä¿ `nextStop.Place` åŒ…å«å®Œæ•´ä¿¡æ¯ï¼ˆåæ ‡ã€è¥ä¸šæ—¶é—´ç­‰ï¼‰
   - ç¡®ä¿ `estimatedArrivalTime` å­—æ®µæ­£ç¡®è®¡ç®—

2. **å¢å¼º `POST /execution/execute` (fallback)**:
   - è¿”å›å®Œæ•´çš„ä¿®å¤æ–¹æ¡ˆæ•°æ®ï¼ˆè‡³å°‘3ä¸ªæ–¹æ¡ˆï¼‰
   - åŒ…å«æ–¹æ¡ˆç±»å‹ã€å˜æ›´è¯¦æƒ…ã€å½±å“è¯„ä¼°

3. **å¢å¼º `POST /execution/execute` (change)**:
   - è¿”å›æ›´æ–°åçš„æ—¶é—´çº¿
   - åŒ…å«å˜æ›´å½±å“è¯„ä¼°

### 7.2 ç¬¬äºŒé˜¶æ®µï¼ˆP1æ–°å¢ï¼‰

4. **æ–°å¢ `POST /execution/reorder`**:
   - å®ç°é‡æ–°æ’åºåŠŸèƒ½
   - è¿”å›æ›´æ–°åçš„æ—¶é—´çº¿å’Œå½±å“è¯„ä¼°

5. **æ–°å¢ `GET /places/:placeId/evidence`**:
   - æˆ–å¢å¼º `GET /trips/:id/state` è¿”å›å…³é”®è¯æ®
   - åŒ…å«è¥ä¸šæ—¶é—´ã€å°è·¯ä¿¡æ¯ã€å¤©æ°”çª—å£

### 7.3 ç¬¬ä¸‰é˜¶æ®µï¼ˆP2æ–°å¢ï¼‰

6. **æ–°å¢ `POST /execution/apply-fallback`**:
   - å®ç°åº”ç”¨ä¿®å¤æ–¹æ¡ˆåŠŸèƒ½
   - è¿”å›åº”ç”¨ç»“æœå’Œæ›´æ–°åçš„æ—¶é—´çº¿

7. **æ–°å¢ `GET /execution/fallback/:solutionId/preview`**:
   - å®ç°é¢„è§ˆä¿®å¤æ–¹æ¡ˆåŠŸèƒ½
   - è¿”å›è¯¦ç»†çš„å˜æ›´å†…å®¹å’Œæ—¶é—´çº¿é¢„è§ˆ

---

## ğŸ“ å…«ã€è”ç³»æ–¹å¼

å¦‚æœ‰ç–‘é—®æˆ–éœ€è¦æ¾„æ¸…ï¼Œè¯·è”ç³»ï¼š
- **å‰ç«¯è´Ÿè´£äºº**: [å¾…å¡«å†™]
- **åç«¯è´Ÿè´£äºº**: [å¾…å¡«å†™]
- **äº§å“è´Ÿè´£äºº**: [å¾…å¡«å†™]

---

**æ–‡æ¡£çŠ¶æ€**: âœ… å·²å®Œæˆ  
**æœ€åæ›´æ–°**: 2026-02-05  
**ä¸‹ä¸€æ­¥**: åç«¯å›¢é˜Ÿè¯„å®¡å’Œå®æ–½
