# 设置页面接口对接情况

> 文档生成时间：2026-02-05  
> 页面路径：`src/pages/settings/index.tsx`

## 概述

设置页面包含4个标签页：**账户**、**偏好**、**数据**、**集成**。本文档详细说明每个标签页的接口对接情况。

---

## 1. 账户标签页 ✅ 已完全对接

### 1.1 获取用户信息
- **接口**：`GET /users/me`
- **API方法**：`userApi.getMe()`
- **状态**：✅ 已对接
- **位置**：`src/api/user.ts:155`
- **功能**：获取当前登录用户的基本信息（邮箱、显示名称、头像等）
- **调用时机**：切换到账户标签页时自动加载
- **代码位置**：`src/pages/settings/index.tsx:151-178`

### 1.2 更新用户信息
- **接口**：`PUT /users/me`
- **API方法**：`userApi.updateMe()`
- **状态**：✅ 已对接
- **位置**：`src/api/user.ts:216`
- **功能**：更新用户的显示名称和头像URL
- **请求参数**：
  ```typescript
  {
    displayName?: string;
    avatarUrl?: string;
  }
  ```
- **代码位置**：`src/pages/settings/index.tsx:249-274`

### 1.3 删除账户
- **接口**：`DELETE /users/me`
- **API方法**：`userApi.deleteMe(confirmText: string)`
- **状态**：✅ 已对接
- **位置**：`src/api/user.ts:290`
- **功能**：永久删除用户账户及其所有关联数据
- **安全措施**：需要输入"确认删除"才能执行
- **代码位置**：`src/pages/settings/index.tsx:276-301`

---

## 2. 偏好标签页 ✅ 已完全对接

### 2.1 获取用户偏好
- **接口**：`GET /users/profile`
- **API方法**：`userApi.getProfile()`（通过 `useUserPreferences` hook）
- **状态**：✅ 已对接
- **位置**：`src/api/user.ts:367`、`src/hooks/useUserPreferences.ts:30`
- **功能**：获取用户的偏好设置（国籍、居住国、标签、景点类型、饮食禁忌、出行偏好等）
- **调用时机**：组件加载时自动获取
- **代码位置**：`src/pages/settings/index.tsx:91-98`、`src/pages/settings/index.tsx:198-214`

### 2.2 更新用户偏好
- **接口**：`PUT /users/profile`
- **API方法**：`userApi.updateProfile(preferences)`（通过 `useUserPreferences` hook）
- **状态**：✅ 已对接
- **位置**：`src/api/user.ts:420`、`src/hooks/useUserPreferences.ts:51`
- **功能**：更新用户的偏好设置
- **请求参数**：
  ```typescript
  {
    preferences: {
      nationality?: string;
      residencyCountry?: string;
      tags?: string[];
      preferredAttractionTypes?: string[];
      dietaryRestrictions?: string[];
      preferOffbeatAttractions?: boolean;
      travelPreferences?: {
        pace?: 'LEISURE' | 'MODERATE' | 'FAST';
        budget?: 'LOW' | 'MEDIUM' | 'HIGH';
        accommodation?: 'BUDGET' | 'COMFORTABLE' | 'LUXURY';
      };
    }
  }
  ```
- **代码位置**：`src/pages/settings/index.tsx:303-316`

### 2.3 获取国家列表
- **接口**：`GET /countries`
- **API方法**：`countriesApi.getAll()`
- **状态**：✅ 已对接
- **位置**：`src/api/countries.ts:74`
- **功能**：获取所有国家列表（用于选择国籍和居住国）
- **调用时机**：组件加载时自动获取
- **代码位置**：`src/pages/settings/index.tsx:180-195`

---

## 3. 数据标签页 ⚠️ 部分对接

### 3.1 导出数据
- **接口**：❌ 未对接
- **状态**：❌ 仅UI，无接口对接
- **功能**：导出所有行程和偏好数据
- **代码位置**：`src/pages/settings/index.tsx:744-750`
- **备注**：
  - 目前只有UI按钮，点击后无实际功能
  - 项目中存在其他导出功能（如行程复盘导出），但用户数据导出接口尚未实现

### 3.2 删除账户
- **接口**：`DELETE /users/me`
- **API方法**：`userApi.deleteMe(confirmText: string)`
- **状态**：✅ 已对接（与账户标签页共用）
- **位置**：`src/api/user.ts:290`
- **功能**：永久删除用户账户及其所有关联数据
- **代码位置**：`src/pages/settings/index.tsx:751-823`

---

## 4. 集成标签页 ❌ 未对接

### 4.1 日历同步
- **接口**：❌ 未对接
- **状态**：❌ 仅UI，无接口对接
- **功能**：同步行程到Google Calendar
- **代码位置**：`src/pages/settings/index.tsx:838-844`
- **备注**：目前只有UI按钮，点击后无实际功能

### 4.2 地图应用
- **接口**：❌ 未对接
- **状态**：❌ 仅UI，无接口对接
- **功能**：导出到Google Maps / Apple Maps
- **代码位置**：`src/pages/settings/index.tsx:845-851`
- **备注**：目前只有UI按钮，点击后无实际功能

---

## 接口对接统计

| 标签页 | 功能 | 接口状态 | 完成度 |
|--------|------|----------|--------|
| **账户** | 获取用户信息 | ✅ 已对接 | 100% |
| | 更新用户信息 | ✅ 已对接 | |
| | 删除账户 | ✅ 已对接 | |
| **偏好** | 获取用户偏好 | ✅ 已对接 | 100% |
| | 更新用户偏好 | ✅ 已对接 | |
| | 获取国家列表 | ✅ 已对接 | |
| **数据** | 导出数据 | ❌ 未对接 | 50% |
| | 删除账户 | ✅ 已对接 | |
| **集成** | 日历同步 | ❌ 未对接 | 0% |
| | 地图应用 | ❌ 未对接 | |

---

## 待实现功能

### 高优先级
1. **数据导出功能**
   - 需要后端提供 `GET /users/me/export` 或 `POST /users/me/export` 接口
   - 支持导出格式：JSON、CSV、PDF等
   - 导出内容：用户信息、偏好设置、所有行程数据

### 中优先级
2. **日历同步功能**
   - 需要后端提供 Google Calendar OAuth 集成接口
   - 接口示例：
     - `GET /integrations/calendar/auth-url` - 获取授权URL
     - `POST /integrations/calendar/connect` - 连接日历
     - `POST /integrations/calendar/sync/:tripId` - 同步行程到日历
     - `DELETE /integrations/calendar/disconnect` - 断开连接

3. **地图应用导出功能**
   - 需要后端提供地图应用导出接口
   - 接口示例：
     - `GET /trips/:id/export/google-maps` - 导出到Google Maps
     - `GET /trips/:id/export/apple-maps` - 导出到Apple Maps
   - 或者前端直接生成标准格式文件（KML、GPX等）

---

## 相关文件

### API文件
- `src/api/user.ts` - 用户和偏好相关API
- `src/api/countries.ts` - 国家列表API
- `src/api/assistant.ts` - 规划助手偏好API（`getUserPreferences`, `clearUserPreferences`）
- `src/api/assistant.ts` - 决策风格偏好API（`decisionStyleApi.getPreferences`）

### Hook文件
- `src/hooks/useUserPreferences.ts` - 用户偏好Hook

### 页面文件
- `src/pages/settings/index.tsx` - 设置页面主文件

### 文档文件
- `docs/api/user-preferences.md` - 用户偏好接口完整文档

---

## 注意事项

1. **错误处理**：所有已对接的接口都包含完整的错误处理逻辑
2. **加载状态**：所有接口调用都有loading状态显示
3. **成功提示**：更新操作成功后都有成功提示（3秒后自动消失）
4. **表单验证**：删除账户需要输入"确认删除"才能执行
5. **权限控制**：所有接口都需要用户认证（通过 `apiClient` 自动处理）

---

## 更新日志

- 2026-02-05：初始文档创建，记录当前接口对接情况
- 2026-02-05：修复用户信息加载错误 - 添加防御性检查，处理 `errorData.error` 为 `undefined` 的情况
  - 修复了 `userApi.getMe()` 的错误处理
  - 修复了 `userApi.updateMe()` 的错误处理
  - 修复了 `userApi.deleteMe()` 的错误处理
  - 修复了 `userApi.getProfile()` 的错误处理
  - 修复了 `userApi.updateProfile()` 的错误处理
  - 改进了 `client.ts` 中的错误处理逻辑
  - 所有方法现在都包含完整的防御性检查，确保在错误对象不存在时也能正常处理
