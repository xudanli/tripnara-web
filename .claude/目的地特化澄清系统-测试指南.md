# 目的地特化澄清系统 - 测试指南

**创建日期**：2026-01-30  
**状态**：✅ 代码已完成，待测试验证

---

## 📋 测试前准备

### 1. 环境检查

- [ ] 前端开发服务器运行正常
- [ ] 后端 API 服务运行正常
- [ ] 数据库连接正常
- [ ] 用户已登录

### 2. 测试数据准备

- [ ] 准备高风险目的地（如：格陵兰）
- [ ] 准备普通目的地（如：冰岛）
- [ ] 准备测试用户（有/无极地经验）

---

## 🧪 功能测试清单

### 测试 1：字段名映射功能

**目标**：验证新旧字段名格式的兼容性

**步骤**：
1. 打开浏览器开发者工具（Network 标签）
2. 发送一条自然语言消息创建行程
3. 检查后端返回的 `clarificationQuestions` 格式
4. 验证前端是否正确显示澄清问题

**预期结果**：
- ✅ 无论后端返回 `question` 还是 `text` 字段，前端都能正确显示
- ✅ 无论后端返回 `type` 还是 `inputType` 字段，前端都能正确识别输入类型
- ✅ `multi_choice` 类型正确转换为 `multiple_choice`

**测试用例**：
- [ ] 后端返回 `question` 字段（新格式）
- [ ] 后端返回 `text` 字段（旧格式，向后兼容）
- [ ] 后端返回 `type` 字段（新格式）
- [ ] 后端返回 `inputType` 字段（旧格式，向后兼容）
- [ ] 后端返回 `multi_choice` 类型

---

### 测试 2：Critical 字段验证

**目标**：验证 Critical 字段的显示、验证和阻止逻辑

**步骤**：
1. 发送一条高风险目的地的行程请求（如：格陵兰）
2. 观察 Critical 字段的显示（红色边框、警告图标）
3. 观察进度指示器（X/Y）
4. 尝试不回答 Critical 字段直接创建行程
5. 回答所有 Critical 字段后再次尝试创建行程

**预期结果**：
- ✅ Critical 字段显示红色边框和警告图标
- ✅ 进度指示器显示"已完成 X/Y 个关键问题"
- ✅ Critical 字段未回答时，不显示确认卡片
- ✅ Critical 字段未回答时，`handleConfirmCreate` 返回错误
- ✅ 所有 Critical 字段回答后，可以正常创建行程

**测试用例**：
- [ ] Critical 字段显示红色边框
- [ ] Critical 字段显示警告图标
- [ ] 进度指示器正确显示（0/2, 1/2, 2/2）
- [ ] Critical 字段未回答时，确认卡片不显示
- [ ] Critical 字段未回答时，创建按钮禁用或显示错误
- [ ] 所有 Critical 字段回答后，可以创建行程

---

### 测试 3：Gate 预检查警告 UI

**目标**：验证 Gate 警告的显示和替代方案选择功能

**步骤**：
1. 发送一条高风险目的地的行程请求（如：格陵兰，无极地经验）
2. 观察 Gate 警告消息的显示
3. 观察替代方案列表的显示
4. 点击"选择此方案"按钮
5. 观察流程是否继续

**预期结果**：
- ✅ Gate 警告消息清晰显示
- ✅ 替代方案列表正确显示
- ✅ 每个替代方案有"选择此方案"按钮
- ✅ 用户点击后，自动发送消息并继续流程
- ✅ 警告消息和替代方案样式正确

**测试用例**：
- [ ] Gate 警告消息正确显示
- [ ] 替代方案列表正确显示（至少 2 个方案）
- [ ] 每个替代方案有"选择此方案"按钮
- [ ] 点击替代方案后，自动发送消息
- [ ] 点击替代方案后，流程继续（显示新的澄清问题或确认卡片）

---

### 测试 4：会话恢复功能

**目标**：验证会话恢复和过期处理

**步骤**：
1. 发送一条消息开始对话
2. 刷新页面
3. 观察是否自动恢复对话
4. 观察恢复提示消息
5. 等待 24 小时后（或手动修改 localStorage），再次刷新页面
6. 观察会话过期提示

**预期结果**：
- ✅ 页面加载时自动恢复会话
- ✅ 显示恢复提示："已恢复对话（X 条消息）"
- ✅ 会话过期时显示提示："之前的对话已过期（24小时）"
- ✅ 会话过期后，清除本地存储并创建新会话

**测试用例**：
- [ ] 页面加载时自动恢复会话
- [ ] 恢复提示正确显示（消息数量）
- [ ] 会话过期时显示过期提示
- [ ] 会话过期后，清除本地存储

---

### 测试 5：后台生成状态展示

**目标**：验证后台生成状态的显示

**步骤**：
1. 创建一条行程
2. 观察是否显示后台生成状态消息
3. 观察刷新按钮是否显示
4. 点击刷新按钮，验证页面刷新

**预期结果**：
- ✅ 如果后端返回 `generatingItems`，显示生成状态消息
- ✅ 显示刷新按钮
- ✅ 点击刷新按钮后，页面刷新

**测试用例**：
- [ ] 创建行程后，显示后台生成状态消息
- [ ] 显示刷新按钮
- [ ] 点击刷新按钮后，页面刷新

---

### 测试 6：向后兼容性

**目标**：验证通用流程不受影响

**步骤**：
1. 发送一条普通目的地的行程请求（如：冰岛）
2. 观察澄清问题的显示
3. 观察确认卡片的显示
4. 创建行程，验证流程正常

**预期结果**：
- ✅ 普通目的地使用通用流程
- ✅ 澄清问题正确显示（旧格式）
- ✅ 确认卡片正常显示
- ✅ 创建行程流程正常

**测试用例**：
- [ ] 普通目的地（无特化配置）使用通用流程
- [ ] 旧格式的澄清问题正确显示
- [ ] 字符串数组格式的澄清问题（向后兼容）
- [ ] 创建行程流程正常

---

## 🔍 集成测试

### 测试场景 1：高风险目的地完整流程

**场景**：新手用户（无极地经验）想去格陵兰

**步骤**：
1. 发送消息："我想去格陵兰旅行"
2. 观察 Gate 警告和替代方案
3. 选择替代方案（如：选择中等风险活动）
4. 回答 Critical 字段（如：是否有极地经验）
5. 回答其他澄清问题
6. 确认创建行程

**预期结果**：
- ✅ Gate 警告正确显示
- ✅ 替代方案选择后，流程继续
- ✅ Critical 字段验证正确
- ✅ 所有问题回答后，可以创建行程

---

### 测试场景 2：熟练用户流程

**场景**：熟练用户（有极地经验）想去格陵兰

**步骤**：
1. 发送消息："我想去格陵兰旅行，我有极地经验"
2. 观察是否显示 Gate 警告（可能不显示）
3. 回答澄清问题
4. 确认创建行程

**预期结果**：
- ✅ 有经验时，可能不显示 Gate 警告
- ✅ 澄清问题正确显示
- ✅ 可以正常创建行程

---

## 🐛 错误场景测试

### 测试 1：会话过期

**步骤**：
1. 手动修改 localStorage 中的 `nl_conversation_session` 为一个不存在的 sessionId
2. 刷新页面
3. 观察错误处理

**预期结果**：
- ✅ 显示会话过期提示
- ✅ 清除本地存储
- ✅ 创建新会话

---

### 测试 2：网络错误

**步骤**：
1. 断开网络连接
2. 发送消息
3. 观察错误处理

**预期结果**：
- ✅ 显示网络错误提示
- ✅ 用户可以重试

---

### 测试 3：后端返回错误格式

**步骤**：
1. 模拟后端返回错误格式的 `clarificationQuestions`
2. 观察前端降级处理

**预期结果**：
- ✅ 前端能够降级处理
- ✅ 不崩溃，显示友好的错误提示

---

## 📊 性能测试

### 测试 1：字段名映射性能

**步骤**：
1. 发送包含大量澄清问题的消息
2. 测量字段名映射的耗时

**预期结果**：
- ✅ 字段名映射耗时 < 10ms（100 个问题）

---

### 测试 2：Critical 字段验证性能

**步骤**：
1. 发送包含大量 Critical 字段的消息
2. 测量验证逻辑的耗时

**预期结果**：
- ✅ Critical 字段验证耗时 < 5ms（50 个 Critical 字段）

---

## ✅ 验收标准

### Critical 字段功能

- [x] Critical 字段显示红色边框和警告图标
- [x] Critical 字段进度指示器显示（X/Y）
- [x] Critical 字段未回答时，不显示确认卡片
- [x] Critical 字段未回答时，`handleConfirmCreate` 返回错误
- [x] 所有 Critical 字段回答后，可以正常创建行程

### Gate 预检查功能

- [x] Gate 警告正确显示
- [x] 替代方案列表正确显示
- [x] 每个替代方案有"选择此方案"按钮
- [x] 用户点击后，自动发送消息
- [x] 替代方案选择后，流程继续

### 字段名映射功能

- [x] 支持 `question` 字段（新格式）
- [x] 支持 `text` 字段（旧格式，向后兼容）
- [x] 支持 `type` 字段（新格式）
- [x] 支持 `inputType` 字段（旧格式，向后兼容）
- [x] 支持 `multi_choice` → `multiple_choice` 转换

### 会话恢复功能

- [x] 页面加载时自动恢复会话
- [x] 显示恢复提示（对话摘要）
- [x] 会话过期时显示提示

### 后台生成状态功能

- [x] 显示 `generatingItems` 状态
- [x] 提供刷新按钮

---

## 📝 测试报告模板

### 测试结果记录

**测试日期**：________  
**测试人员**：________  
**测试环境**：________

#### 功能测试结果

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 字段名映射功能 | ⬜ 通过 ⬜ 失败 | |
| Critical 字段验证 | ⬜ 通过 ⬜ 失败 | |
| Gate 预检查警告 UI | ⬜ 通过 ⬜ 失败 | |
| 会话恢复功能 | ⬜ 通过 ⬜ 失败 | |
| 后台生成状态展示 | ⬜ 通过 ⬜ 失败 | |
| 向后兼容性 | ⬜ 通过 ⬜ 失败 | |

#### 集成测试结果

| 测试场景 | 状态 | 备注 |
|----------|------|------|
| 高风险目的地完整流程 | ⬜ 通过 ⬜ 失败 | |
| 熟练用户流程 | ⬜ 通过 ⬜ 失败 | |

#### 错误场景测试结果

| 测试场景 | 状态 | 备注 |
|----------|------|------|
| 会话过期 | ⬜ 通过 ⬜ 失败 | |
| 网络错误 | ⬜ 通过 ⬜ 失败 | |
| 后端返回错误格式 | ⬜ 通过 ⬜ 失败 | |

#### 发现的问题

1. **问题描述**：________  
   **严重程度**：⬜ 高 ⬜ 中 ⬜ 低  
   **复现步骤**：________  
   **预期行为**：________  
   **实际行为**：________

2. **问题描述**：________  
   **严重程度**：⬜ 高 ⬜ 中 ⬜ 低  
   **复现步骤**：________  
   **预期行为**：________  
   **实际行为**：________

---

## 🎯 下一步行动

1. **与后端联调**：
   - [ ] 确认后端返回的 `alternatives` 格式
   - [ ] 确认后端返回的 `gateBlocked` 和 `blockedByCriticalFields` 标记
   - [ ] 测试完整的澄清流程

2. **功能测试**：
   - [ ] 按照本指南进行全面的功能测试
   - [ ] 记录测试结果和发现的问题
   - [ ] 修复发现的问题

3. **性能测试**：
   - [ ] 测试字段名映射和验证逻辑的性能
   - [ ] 优化性能瓶颈（如有）

4. **用户体验测试**：
   - [ ] 测试 Critical 字段和 Gate 警告的用户体验
   - [ ] 收集用户反馈
   - [ ] 优化用户体验（如有）

---

**文档状态**：✅ 测试指南已创建  
**最后更新**：2026-01-30
