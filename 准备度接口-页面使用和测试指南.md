# 准备度接口 - 页面使用和测试指南

## 📋 概述

本文档详细说明准备度相关接口在哪些页面使用，以及如何进行测试。

---

## 🌐 页面位置

### 主页面：准备度页面

- **路由路径**: `/dashboard/readiness?tripId={tripId}`
- **文件路径**: `src/pages/readiness/index.tsx`
- **访问方式**:
  1. 直接访问: `http://localhost:5173/dashboard/readiness?tripId={tripId}`
  2. 从 Dashboard 页面点击 "完成准备度" 按钮
  3. 从行程详情页面跳转（如果有入口）
  4. 从侧边栏导航菜单进入

---

## 📍 接口使用位置详情

### 页面：准备度页面 (`/dashboard/readiness`)

所有准备度接口都在这个页面使用。以下是各接口的具体使用位置和测试方法：

---

## 🔍 接口测试详细指南

### 1. 主接口测试

#### 1.1 GET /readiness/trip/:tripId（主接口）⭐

**使用位置**:
- 页面加载时自动调用
- `loadData()` 函数（第154行）

**测试步骤**:

1. **打开准备度页面**
   ```
   http://localhost:5173/dashboard/readiness?tripId=d125c30f-44ab-4a9e-9970-b899fccdc3d8
   ```
   （替换为你的实际 tripId）

2. **打开浏览器开发者工具（F12）**

3. **切换到 Network（网络）标签页**

4. **刷新页面或重新加载**

5. **查找请求**
   - 在 Network 标签页中查找: `GET /readiness/trip/{tripId}`
   - 或使用过滤器: 输入 `readiness/trip`

6. **检查请求**
   - **状态码**: 应为 `200 OK`（成功）或 `404 Not Found`（未实现）
   - **请求方法**: GET
   - **URL**: `/api/readiness/trip/{tripId}`

7. **查看响应**
   - 点击请求，查看 "Preview" 或 "Response" 标签页
   - 确认返回的数据格式是否符合 `ReadinessCheckResult` 格式
   - 检查是否包含 `findings`, `summary`, `risks`, `constraints` 字段

8. **查看控制台日志**
   - 切换到 Console 标签页
   - 查找日志: `"Using getTripReadiness data for trip: ..."`
   - 查找日志: `"Raw readiness data from API: ..."`（显示原始数据）
   - 查找日志: `"Converted readiness data: ..."`（显示转换后的数据）

**预期结果**:
- ✅ 状态码 200: 接口正常，数据正确显示
- ⚠️ 状态码 404: 接口未实现，会使用备用方案
- ❌ 状态码 500: 服务器错误，需要检查后端

---

### 2. 备用接口测试

#### 2.1 POST /readiness/check（备用方案1）

**使用位置**:
- 当主接口失败时自动调用
- `loadData()` 函数（第187行）

**触发条件**:
- `getTripReadiness` 返回 404 或失败

**测试步骤**:

1. **方法1：模拟主接口失败**
   - 在 Network 标签页中，右键点击 `GET /readiness/trip/{tripId}` 请求
   - 选择 "Block request URL"（如果浏览器支持）
   - 或修改后端，临时让主接口返回 404

2. **方法2：查看正常流程**
   - 如果主接口正常，备用接口不会触发
   - 可以在控制台查看日志，确认使用的是主接口还是备用接口

3. **检查请求**
   - 在 Network 标签页中查找: `POST /readiness/check`
   - **请求方法**: POST
   - **请求体（Payload）**: 应包含 `destinationId`, `trip`, `itinerary` 等字段

4. **查看响应**
   - 点击请求，查看响应内容
   - 确认返回的数据格式

5. **查看控制台日志**
   - 查找日志: `"Trying check API with DTO: ..."`
   - 查找日志: `"✅ Using check API result for trip: ..."`

**预期结果**:
- ✅ 如果主接口失败，自动切换到 check 接口
- ✅ 数据正确显示

---

#### 2.2 GET /readiness/personalized-checklist（备用方案2-1）

#### 2.3 GET /readiness/risk-warnings（备用方案2-2）

**使用位置**:
- 当主接口和 check 接口都失败时调用
- `loadData()` 函数（第200、204行）
- 并行调用这两个接口

**触发条件**:
- `getTripReadiness` 失败
- `check` 接口也失败

**测试步骤**:

1. **模拟前两个接口都失败**（需要后端支持或网络拦截）

2. **检查请求**
   - 查找: `GET /readiness/personalized-checklist?tripId=...`
   - 查找: `GET /readiness/risk-warnings?tripId=...`
   - 这两个请求应该并行发送

3. **查看响应**
   - 确认返回的数据格式
   - `personalized-checklist` 应包含 `checklist` 和 `summary`
   - `risk-warnings` 应包含 `risks` 和 `summary`

4. **查看控制台日志**
   - 查找日志: `"Using checklist/riskWarnings data for trip: ..."`

**预期结果**:
- ✅ 如果前两个接口都失败，使用这两个接口的组合数据
- ✅ 数据正确显示

---

### 3. 能力包接口测试

#### 3.1 GET /readiness/capability-packs

#### 3.2 POST /readiness/capability-packs/evaluate

**使用位置**:
- 页面加载时自动调用（不阻塞主流程）
- `loadCapabilityPacks()` 函数（第129、130行）

**测试步骤**:

1. **打开准备度页面**

2. **检查请求**
   - 查找: `GET /readiness/capability-packs`
   - 查找: `POST /readiness/capability-packs/evaluate`
   - 这两个请求应该并行发送

3. **查看响应**
   - `capability-packs`: 应返回能力包列表
   - `evaluate`: 应返回评估结果（哪些能力包被触发）

4. **查看页面显示**
   - 切换到 "Capability Packs" 标签页
   - 确认能力包列表和评估结果正确显示

**预期结果**:
- ✅ 能力包列表正确显示
- ✅ 评估结果正确显示（哪些能力包被触发）
- ⚠️ 即使失败也不影响主流程（页面仍然正常显示）

---

### 4. 修复相关接口测试

#### 4.1 POST /readiness/repair-options（获取修复方案）

**使用位置**:
- 用户点击 blocker 的 "Fix" 按钮时调用
- `handleFixBlocker()` 函数（第437行）

**测试步骤**:

1. **打开准备度页面**

2. **确保页面有 blocker 显示**
   - 如果状态为 "Not Ready" 或 "Nearly"，应该有 blockers 列表
   - 如果没有 blocker，可以等待接口返回数据，或查看是否有测试数据

3. **点击 blocker 的 "Fix" 按钮**
   - 找到 blocker 卡片
   - 点击 "Fix" 按钮

4. **检查请求**
   - 查找: `POST /readiness/repair-options`
   - **请求体**: 应包含 `tripId` 和 `blockerId`

5. **查看响应**
   - 确认返回修复方案列表
   - 格式应为: `{ options: RepairOption[] }`

6. **查看页面显示**
   - 应该显示修复方案列表
   - 每个方案应该有标题、描述、变更信息等

**预期结果**:
- ✅ 点击 Fix 按钮后，显示修复方案列表
- ✅ 修复方案信息正确显示
- ⚠️ 如果接口失败，使用模拟数据

---

#### 4.2 POST /readiness/apply-repair（应用修复方案）

**使用位置**:
- 用户选择并确认应用修复方案时调用
- `handleApplyFix()` 函数（第515行）

**测试步骤**:

1. **先完成步骤 4.1（获取修复方案）**

2. **选择一个修复方案**
   - 在修复方案列表中选择一个方案
   - 点击 "Apply" 或 "应用" 按钮

3. **检查请求**
   - 查找: `POST /readiness/apply-repair`
   - **请求体**: 应包含 `tripId`, `blockerId`, `optionId`

4. **查看响应**
   - 确认返回成功信息
   - 格式应为: `{ success: boolean; message?: string }`

5. **查看页面变化**
   - 页面应该重新加载数据
   - blocker 应该被修复或状态更新

**预期结果**:
- ✅ 修复方案成功应用
- ✅ 页面数据刷新
- ✅ blocker 状态更新

---

#### 4.3 POST /readiness/auto-repair（自动修复）

**使用位置**:
- 用户点击 "Run Repair" 按钮时调用
- `handleRunRepair()` 函数（第542行）

**测试步骤**:

1. **打开准备度页面**

2. **确保状态为 "Not Ready"**
   - 如果状态不是 "Not Ready"，"Run Repair" 按钮可能不显示

3. **点击 "Run Repair" 按钮**
   - 找到页面上的 "Run Repair" 按钮
   - 点击按钮

4. **检查请求**
   - 查找: `POST /readiness/auto-repair`
   - **请求体**: 应包含 `tripId`

5. **查看响应**
   - 确认返回成功信息

6. **查看页面变化**
   - 页面应该重新加载数据
   - blocker 应该被自动修复

**预期结果**:
- ✅ 自动修复成功执行
- ✅ 页面数据刷新
- ✅ blocker 被修复

---

### 5. 证据刷新接口测试

#### 5.1 POST /readiness/refresh-evidence（刷新所有证据）

**使用位置**:
- 用户点击刷新按钮时调用
- `handleRefreshAllEvidence()` 函数（第556行）

**测试步骤**:

1. **打开准备度页面**

2. **找到刷新按钮**
   - 通常在页面顶部或操作菜单中
   - 可能是一个刷新图标按钮

3. **点击刷新按钮**

4. **检查请求**
   - 查找: `POST /readiness/refresh-evidence`
   - **请求体**: 应包含 `tripId`

5. **查看响应**
   - 确认返回成功信息
   - 格式应为: `{ success: boolean }`

6. **查看页面变化**
   - 页面应该重新加载数据
   - 证据数据应该更新

**预期结果**:
- ✅ 证据数据刷新成功
- ✅ 页面数据更新

---

#### 5.2 POST /readiness/refresh-evidence（刷新单个证据）

**使用位置**:
- 用户点击单个证据项的刷新按钮时调用
- `handleRefreshSingleEvidence()` 函数（第571行）

**测试步骤**:

1. **打开准备度页面**

2. **找到证据列表**
   - 通常在 "Evidence Chain" 标签页
   - 或 blocker 详情中

3. **找到单个证据项的刷新按钮**
   - 每个证据项可能有独立的刷新按钮

4. **点击刷新按钮**

5. **检查请求**
   - 查找: `POST /readiness/refresh-evidence`
   - **请求体**: 应包含 `tripId` 和 `evidenceId`

6. **查看响应**
   - 确认返回成功信息

7. **查看页面变化**
   - 该证据项的数据应该更新

**预期结果**:
- ✅ 单个证据数据刷新成功
- ✅ 该证据项数据更新

---

## 🔄 完整测试流程

### 场景1：主接口正常（推荐场景）

1. **打开准备度页面**
   ```
   http://localhost:5173/dashboard/readiness?tripId={tripId}
   ```

2. **检查网络请求**
   - ✅ `GET /readiness/trip/{tripId}` - 200 OK
   - ✅ `GET /readiness/capability-packs` - 200 OK
   - ✅ `POST /readiness/capability-packs/evaluate` - 200 OK

3. **检查控制台日志**
   - ✅ `"Using getTripReadiness data for trip: ..."`
   - ✅ `"Raw readiness data from API: ..."`
   - ✅ `"Converted readiness data: ..."`

4. **检查页面显示**
   - ✅ 准备度状态正确显示
   - ✅ 分数正确显示
   - ✅ Blockers 列表正确显示（如果有）
   - ✅ 能力包正确显示

5. **测试修复功能**
   - ✅ 点击 Fix 按钮，查看修复方案
   - ✅ 应用修复方案
   - ✅ 或使用自动修复

6. **测试刷新功能**
   - ✅ 刷新所有证据
   - ✅ 刷新单个证据

---

### 场景2：主接口失败，使用备用方案

1. **模拟主接口失败**（需要后端支持）

2. **检查网络请求**
   - ❌ `GET /readiness/trip/{tripId}` - 404 或错误
   - ✅ `POST /readiness/check` - 200 OK（备用方案1）

3. **检查控制台日志**
   - ⚠️ `"getTripReadiness failed, trying fallback: ..."`
   - ✅ `"Trying check API with DTO: ..."`
   - ✅ `"✅ Using check API result for trip: ..."`

4. **检查页面显示**
   - ✅ 页面仍然正常显示
   - ✅ 数据来自备用接口

---

### 场景3：所有接口失败，使用模拟数据

1. **模拟所有接口失败**（需要网络拦截或后端支持）

2. **检查网络请求**
   - ❌ 所有接口都失败

3. **检查控制台日志**
   - ⚠️ `"All APIs failed, using mock data for trip: ..."`

4. **检查页面显示**
   - ⚠️ 页面显示模拟数据
   - ⚠️ 数据不是真实的目的地数据

---

## 📊 测试检查清单

### 基础功能测试

- [ ] 页面可以正常打开
- [ ] 主接口正常调用（或使用备用方案）
- [ ] 准备度状态正确显示
- [ ] 分数正确显示
- [ ] Blockers 列表正确显示
- [ ] 能力包正确显示

### 功能测试

- [ ] 点击 Fix 按钮，显示修复方案
- [ ] 应用修复方案成功
- [ ] 自动修复功能正常
- [ ] 刷新所有证据功能正常
- [ ] 刷新单个证据功能正常

### 异常情况测试

- [ ] 主接口失败时，备用方案正常工作
- [ ] 所有接口失败时，页面仍然可以显示（使用模拟数据）
- [ ] 网络错误时，有适当的错误处理
- [ ] 数据格式错误时，有适当的验证和错误提示

### 数据验证

- [ ] 后端返回的数据格式正确
- [ ] 数据转换正确（ReadinessCheckResult → ReadinessData）
- [ ] 分数计算正确（如果有计算逻辑）
- [ ] 目的地信息正确（显示真实的目的地，不是模拟数据）

---

## 🐛 常见问题排查

### 问题1：页面显示模拟数据

**可能原因**:
- 所有接口都失败了
- 后端接口未实现

**排查步骤**:
1. 查看 Network 标签页，检查接口状态码
2. 查看 Console 标签页，查找错误日志
3. 检查是否有 `"All APIs failed, using mock data"` 日志

### 问题2：分数维度是硬编码的

**问题**:
- `evidenceCoverage: 85`
- `scheduleFeasibility: 70`
- `transportCertainty: 65`
- `buffers: 60`

**原因**:
- 后端接口没有返回这些详细的分数维度
- 前端转换函数中使用硬编码值

**解决方案**:
- 需要后端接口返回这些分数维度
- 或基于后端数据计算这些值

### 问题3：接口返回 404

**原因**:
- 后端接口未实现
- URL 路径不正确

**解决方案**:
- 检查后端是否实现了该接口
- 确认接口路径是否正确
- 代码会自动使用备用方案

---

## 📝 测试记录模板

```
测试日期: ___________
测试人员: ___________
测试环境: ___________

接口测试结果:
- GET /readiness/trip/:tripId: [ ] 通过 [ ] 失败
- POST /readiness/check: [ ] 通过 [ ] 失败
- GET /readiness/personalized-checklist: [ ] 通过 [ ] 失败
- GET /readiness/risk-warnings: [ ] 通过 [ ] 失败
- GET /readiness/capability-packs: [ ] 通过 [ ] 失败
- POST /readiness/capability-packs/evaluate: [ ] 通过 [ ] 失败
- POST /readiness/repair-options: [ ] 通过 [ ] 失败
- POST /readiness/apply-repair: [ ] 通过 [ ] 失败
- POST /readiness/auto-repair: [ ] 通过 [ ] 失败
- POST /readiness/refresh-evidence: [ ] 通过 [ ] 失败

功能测试结果:
- 页面显示: [ ] 正常 [ ] 异常
- 数据来源: [ ] 主接口 [ ] 备用接口 [ ] 模拟数据
- 修复功能: [ ] 正常 [ ] 异常
- 刷新功能: [ ] 正常 [ ] 异常

问题记录:
________________________________________________
________________________________________________
```

---

## 📚 相关文档

- [准备度接口 API 文档](./准备度检查API接口文档.md)
- [准备度页面接口对接清单](./准备度页面-接口对接清单.md)
- [准备度接口更新测试说明](./准备度接口更新-测试说明.md)

