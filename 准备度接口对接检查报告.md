# å‡†å¤‡åº¦æ¥å£å¯¹æ¥æ£€æŸ¥æŠ¥å‘Š

## âœ… å·²æ­£ç¡®å®ç°çš„éƒ¨åˆ†

### 1. æ¥å£è°ƒç”¨æ–¹å¼
- âœ… ä½¿ç”¨ `GET /api/readiness/trip/:id` æ¥å£ï¼ˆæ¨èæ¥å£ï¼‰
- âœ… æ­£ç¡®çš„è·¯å¾„å‚æ•°ä¼ é€’
- âœ… é”™è¯¯å¤„ç†æœºåˆ¶å®Œå–„
- âœ… æœ‰å¤‡ç”¨æ¥å£è°ƒç”¨é€»è¾‘ï¼ˆcheck APIï¼‰

### 2. æ•°æ®ç»“æ„åŒ¹é…
- âœ… `ReadinessCheckResult` æ¥å£å®šä¹‰æ­£ç¡®
- âœ… `findings` æ•°ç»„ç»“æ„æ­£ç¡®
- âœ… `summary` å¯¹è±¡åŒ…å«æ­£ç¡®çš„å­—æ®µ
- âœ… `risks` æ•°ç»„ç»“æ„æ­£ç¡®
- âœ… `must/should/optional` æ•°ç»„ç»“æ„æ­£ç¡®

### 3. æ•°æ®å±•ç¤º
- âœ… Risks Section æ­£ç¡®å±•ç¤ºé£é™©ä¿¡æ¯
- âœ… Checklists Section æ­£ç¡®å±•ç¤º must/should/optional
- âœ… Blockers æ­£ç¡®å±•ç¤ºé˜»å¡é¡¹
- âœ… ä½¿ç”¨åŸå§‹æ•°æ®ï¼ˆrawReadinessResultï¼‰å±•ç¤ºè¯¦ç»†ä¿¡æ¯

### 4. é”™è¯¯å¤„ç†
- âœ… 404 é”™è¯¯å¤„ç†
- âœ… ç½‘ç»œé”™è¯¯å¤„ç†
- âœ… æ•°æ®éªŒè¯ï¼ˆvalidateReadinessDataï¼‰
- âœ… å¤šå±‚çº§çš„ fallback æœºåˆ¶

---

## âš ï¸ éœ€è¦è°ƒæ•´çš„éƒ¨åˆ†

### 1. æ•°æ®ç»“æ„å·®å¼‚

#### é—®é¢˜ï¼šAPI è¿”å›çš„ `findings` ç»“æ„

**æ–‡æ¡£ä¸­çš„ç»“æ„ï¼š**
```typescript
interface ReadinessFinding {
  destinationId: string;
  packId: string;
  packVersion: string;
  blockers: ReadinessFindingItem[];
  must: ReadinessFindingItem[];
  should: ReadinessFindingItem[];
  optional: ReadinessFindingItem[];
  risks: Risk[];
}
```

**å½“å‰å®ç°ä¸­çš„ç»“æ„ï¼š**
```typescript
interface ReadinessFinding {
  category?: string;  // å½“å‰ä»£ç ä¸­æœ‰è¿™ä¸ªå­—æ®µ
  must?: ReadinessFindingItem[];
  should?: ReadinessFindingItem[];
  optional?: ReadinessFindingItem[];
  // ç¼ºå°‘ destinationId, packId, packVersion, blockers, risks
}
```

**å½±å“ï¼š**
- å½“å‰ä»£ç ä¸­ `findings[].category` å­—æ®µå¯èƒ½ä¸å­˜åœ¨äºå®é™… API è¿”å›ä¸­
- `risks` åœ¨ `ReadinessCheckResult` çš„é¡¶å±‚ï¼Œè€Œä¸æ˜¯åœ¨ `findings` ä¸­

#### é—®é¢˜ï¼š`ReadinessFindingItem` å­—æ®µå·®å¼‚

**æ–‡æ¡£ä¸­çš„å­—æ®µï¼š**
```typescript
interface ReadinessFindingItem {
  id: string;
  category: string;
  severity: string;
  level: 'blocker' | 'must' | 'should' | 'optional';
  message: string;
  tasks?: Array<{
    title: string;
    dueOffsetDays: number;  // âš ï¸ æ³¨æ„ï¼šæ˜¯ dueOffsetDaysï¼Œä¸æ˜¯ deadline
    tags?: string[];
  }>;
  askUser?: string[];
  evidence?: Array<{
    sourceId: string;
    sectionId?: string;
    quote?: string;
  }>;
}
```

**å½“å‰å®ç°ä¸­ä½¿ç”¨çš„å­—æ®µï¼š**
- âœ… `message` - æ­£ç¡®ä½¿ç”¨
- âœ… `tasks` - æ­£ç¡®ä½¿ç”¨
- âŒ `deadline` - æ–‡æ¡£ä¸­æ˜¯ `dueOffsetDays`ï¼Œéœ€è¦è®¡ç®—
- âŒ `evidence` - å½“å‰ä»£ç ä¸­ä½¿ç”¨äº† `evidence` å­—ç¬¦ä¸²ï¼Œä½†æ–‡æ¡£ä¸­æ˜¯å¯¹è±¡æ•°ç»„
- âŒ `channel` - æ–‡æ¡£ä¸­æ²¡æœ‰è¿™ä¸ªå­—æ®µ

---

### 2. ChecklistSection ç»„ä»¶é—®é¢˜

**å½“å‰ä»£ç ï¼ˆChecklistSection.tsxï¼‰ï¼š**
```typescript
{item.deadline && (
  <span>æˆªæ­¢: {item.deadline}</span>
)}
{item.evidence && (
  <span>è¯æ®: {item.evidence}</span>
)}
{item.channel && (
  <span>æ¸ é“: {item.channel}</span>
)}
```

**é—®é¢˜ï¼š**
1. âŒ `deadline` å­—æ®µä¸å­˜åœ¨ï¼Œåº”è¯¥ä½¿ç”¨ `tasks[].dueOffsetDays` è®¡ç®—
2. âŒ `evidence` åº”è¯¥æ˜¯æ•°ç»„ï¼Œä¸æ˜¯å­—ç¬¦ä¸²
3. âŒ `channel` å­—æ®µä¸å­˜åœ¨äºæ–‡æ¡£ä¸­

---

### 3. æ•°æ®å±•ç¤ºé€»è¾‘é—®é¢˜

**å½“å‰ä»£ç ï¼š**
```typescript
{rawReadinessResult.findings.map((finding, findingIndex) => {
  // æ”¶é›†æ‰€æœ‰ must/should/optional é¡¹ç›®
  const allMust: any[] = [];
  const allShould: any[] = [];
  const allOptional: any[] = [];
  
  finding.must?.forEach(item => allMust.push(item));
  finding.should?.forEach(item => allShould.push(item));
  finding.optional?.forEach(item => allOptional.push(item));
  
  if (allMust.length === 0 && allShould.length === 0 && allOptional.length === 0) {
    return null;
  }

  return (
    <div key={findingIndex} className="space-y-3">
      {finding.category && (  // âš ï¸ category å¯èƒ½ä¸å­˜åœ¨
        <h4 className="text-xs font-medium text-muted-foreground uppercase">{finding.category}</h4>
      )}
      ...
    </div>
  );
})}
```

**é—®é¢˜ï¼š**
- `finding.category` åœ¨æ–‡æ¡£ä¸­æ²¡æœ‰ï¼Œåº”è¯¥ä½¿ç”¨ `finding.destinationId` æˆ– `finding.packId`

---

### 4. Risks æ•°æ®ä½ç½®

**æ–‡æ¡£è¯´æ˜ï¼š**
- `risks` åœ¨ `ReadinessCheckResult` çš„é¡¶å±‚ï¼š`result.risks`
- ä¸åœ¨ `findings` ä¸­

**å½“å‰å®ç°ï¼š**
- âœ… æ­£ç¡®ï¼š`rawReadinessResult.risks`

---

### 5. Blockers æ•°æ®ä½ç½®

**æ–‡æ¡£è¯´æ˜ï¼š**
- `blockers` åœ¨ `findings` ä¸­ï¼š`finding.blockers`
- ä¸åœ¨ `ReadinessCheckResult` çš„é¡¶å±‚

**å½“å‰å®ç°ï¼š**
- éœ€è¦æ£€æŸ¥æ˜¯å¦æ­£ç¡®ä» `findings[].blockers` ä¸­æå–

---

## ğŸ”§ å»ºè®®çš„è°ƒæ•´

### 1. æ›´æ–° ChecklistSection ç»„ä»¶

```typescript
// ç§»é™¤ä¸å­˜åœ¨çš„å­—æ®µ
{item.tasks && item.tasks.length > 0 && (
  <div className="space-y-1">
    <h5 className="text-xs font-medium text-muted-foreground">ä»»åŠ¡:</h5>
    <ul className="space-y-1">
      {item.tasks.map((task, taskIndex) => (
        <li key={taskIndex} className="text-xs text-muted-foreground flex items-start gap-2">
          <span className="text-muted-foreground/50 mt-1">â€¢</span>
          <span>
            {task.title}
            {tripStartDate && task.dueOffsetDays !== undefined && (
              <span className="text-muted-foreground/70 ml-2">
                (æˆªæ­¢: {calculateDeadline(task.dueOffsetDays, tripStartDate)})
              </span>
            )}
          </span>
        </li>
      ))}
    </ul>
  </div>
)}

// æ˜¾ç¤º evidence æ•°ç»„
{item.evidence && item.evidence.length > 0 && (
  <div className="space-y-1">
    <h5 className="text-xs font-medium text-muted-foreground">è¯æ®:</h5>
    <ul className="space-y-1">
      {item.evidence.map((ev, evIndex) => (
        <li key={evIndex} className="text-xs text-muted-foreground">
          {ev.sourceId}{ev.sectionId ? ` > ${ev.sectionId}` : ''}
          {ev.quote && `: "${ev.quote}"`}
        </li>
      ))}
    </ul>
  </div>
)}

// ç§»é™¤ deadline, channel å­—æ®µçš„æ˜¾ç¤º
```

### 2. æ›´æ–° Findings å±•ç¤ºé€»è¾‘

```typescript
{rawReadinessResult.findings.map((finding, findingIndex) => {
  const allMust: any[] = finding.must || [];
  const allShould: any[] = finding.should || [];
  const allOptional: any[] = finding.optional || [];
  const allBlockers: any[] = finding.blockers || [];

  if (allMust.length === 0 && allShould.length === 0 && allOptional.length === 0 && allBlockers.length === 0) {
    return null;
  }

  return (
    <div key={findingIndex} className="space-y-3">
      {/* ä½¿ç”¨ destinationId æˆ– packId æ›¿ä»£ category */}
      {(finding.destinationId || finding.packId) && (
        <h4 className="text-xs font-medium text-muted-foreground uppercase">
          {finding.destinationId || finding.packId}
        </h4>
      )}
      
      {/* æ˜¾ç¤º blockers */}
      {allBlockers.length > 0 && (
        <ChecklistSection
          title={t('dashboard.readiness.page.blockers')}
          items={allBlockers}
          level="must" // blockers ä½¿ç”¨ must æ ·å¼
        />
      )}
      
      {/* æ˜¾ç¤º must/should/optional */}
      ...
    </div>
  );
})}
```

### 3. æ·»åŠ æˆªæ­¢æ—¥æœŸè®¡ç®—å‡½æ•°

```typescript
function calculateDeadline(offsetDays: number, tripStartDate: string | Date): string {
  const startDate = typeof tripStartDate === 'string' ? new Date(tripStartDate) : tripStartDate;
  const deadline = new Date(startDate);
  deadline.setDate(deadline.getDate() + offsetDays);
  return deadline.toLocaleDateString('zh-CN');
}
```

### 4. æ›´æ–°ç±»å‹å®šä¹‰

éœ€è¦ç¡®ä¿ `ReadinessFindingItem` æ¥å£åŒ…å«æ‰€æœ‰æ–‡æ¡£ä¸­çš„å­—æ®µï¼š
- `id`, `category`, `severity`, `level`
- `tasks` ä¸­çš„ `dueOffsetDays`ï¼ˆä¸æ˜¯ `deadline`ï¼‰
- `evidence` æ•°ç»„ï¼ˆä¸æ˜¯å­—ç¬¦ä¸²ï¼‰
- ç§»é™¤ä¸å­˜åœ¨çš„ `channel` å­—æ®µ

---

## ğŸ“ æ€»ç»“

### å½“å‰çŠ¶æ€
- âœ… æ¥å£è°ƒç”¨æ­£ç¡®
- âœ… ä¸»è¦æ•°æ®ç»“æ„åŒ¹é…
- âš ï¸ éƒ¨åˆ†å­—æ®µä½¿ç”¨ä¸æ­£ç¡®ï¼ˆdeadline, evidence, channelï¼‰
- âš ï¸ findings å±•ç¤ºé€»è¾‘éœ€è¦è°ƒæ•´

### ä¼˜å…ˆçº§
1. **é«˜ä¼˜å…ˆçº§**ï¼šä¿®å¤ ChecklistSection ä¸­çš„å­—æ®µä½¿ç”¨ï¼ˆdeadline â†’ dueOffsetDaysï¼Œevidence æ•°ç»„å¤„ç†ï¼‰
2. **ä¸­ä¼˜å…ˆçº§**ï¼šæ›´æ–° findings å±•ç¤ºé€»è¾‘ï¼ˆä½¿ç”¨ destinationId/packId æ›¿ä»£ categoryï¼‰
3. **ä½ä¼˜å…ˆçº§**ï¼šå®Œå–„ç±»å‹å®šä¹‰ï¼Œç§»é™¤ä¸å­˜åœ¨çš„å­—æ®µ

### å»ºè®®
1. å…ˆæµ‹è¯•å®é™… API è¿”å›çš„æ•°æ®ç»“æ„
2. æ ¹æ®å®é™…è¿”å›è°ƒæ•´ä»£ç 
3. æ›´æ–°ç±»å‹å®šä¹‰ä»¥åŒ¹é…å®é™… API
4. æ·»åŠ æˆªæ­¢æ—¥æœŸè®¡ç®—åŠŸèƒ½

